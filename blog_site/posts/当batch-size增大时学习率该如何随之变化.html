<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å½“Batch Sizeå¢å¤§æ—¶ï¼Œå­¦ä¹ ç‡è¯¥å¦‚ä½•éšä¹‹å˜åŒ–ï¼Ÿ</title>
    <style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    line-height: 1.6; color: #333; max-width: 900px; margin: 0 auto; padding: 20px; background: #f5f5f5;
}
.container { background: white; padding: 40px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
header { border-bottom: 2px solid #e0e0e0; padding-bottom: 20px; margin-bottom: 30px; }
h1 { color: #2c3e50; margin-bottom: 10px; font-size: 2em; }
.meta { color: #666; font-size: 0.9em; margin-bottom: 20px; }
.content { margin-top: 30px; overflow-wrap: break-word; }
.content h2 { color: #34495e; margin-top: 30px; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
.content p { margin-bottom: 15px; }
.content pre { background: #f8f8f8; padding: 15px; border-radius: 5px; overflow-x: auto; border-left: 3px solid #3498db; margin: 15px 0; }
.content code { background: #f8f8f8; padding: 2px 5px; border-radius: 3px; font-family: monospace; font-size: 0.9em; }
.content blockquote { border-left: 4px solid #3498db; padding-left: 20px; margin: 20px 0; color: #555; font-style: italic; }
.content table { border-collapse: collapse; width: 100%; margin: 20px 0; }
.content th, .content td { border: 1px solid #ddd; padding: 10px; text-align: left; }
.back-link { display: inline-block; margin-bottom: 20px; color: #3498db; text-decoration: none; font-weight: 500; }
</style>
    
<script>
    window.MathJax = {
        tex: {
            inlineMath: [['$', '$'], ['\(', '\)']],
            displayMath: [['$$', '$$'], ['\[', '\]']],
            processEscapes: true
        }
    };
</script>
<script id="MathJax-script" async src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>

</head>
<body>
    <div class="container">
        <a href="../index.html" class="back-link">â† è¿”å›é¦–é¡µ</a>
        <header>
            <h1>å½“Batch Sizeå¢å¤§æ—¶ï¼Œå­¦ä¹ ç‡è¯¥å¦‚ä½•éšä¹‹å˜åŒ–ï¼Ÿ</h1>
            <div class="meta">ğŸ“… æœ€åæ›´æ–°: 2025-11-26 | ğŸ“„ å¤§å°: 52.6 KB</div>
        </header>
        <div class="content">
            <p><strong>åŸæ–‡é“¾æ¥</strong>: <a href="https://spaces.ac.cn/archives/10542">https://spaces.ac.cn/archives/10542</a></p>
<p><strong>å‘å¸ƒæ—¥æœŸ</strong>: </p>
<hr />
<p>éšç€ç®—åŠ›çš„é£é€Ÿè¿›æ­¥ï¼Œæœ‰è¶Šå¤šè¶Šå¤šçš„åœºæ™¯å¸Œæœ›èƒ½å¤Ÿå®ç°â€œç®—åŠ›æ¢æ—¶é—´â€ï¼Œå³é€šè¿‡å †ç Œç®—åŠ›æ¥ç¼©çŸ­æ¨¡å‹è®­ç»ƒæ—¶é—´ã€‚ç†æƒ³æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¸Œæœ›æŠ•å…¥$n$å€çš„ç®—åŠ›ï¼Œé‚£ä¹ˆè¾¾åˆ°åŒæ ·æ•ˆæœçš„æ—¶é—´åˆ™ç¼©çŸ­ä¸º$1/n$ï¼Œæ­¤æ—¶æ€»çš„ç®—åŠ›æˆæœ¬æ˜¯ä¸€è‡´çš„ã€‚è¿™ä¸ªâ€œå¸Œæœ›â€çœ‹ä¸Šå»å¾ˆåˆç†å’Œè‡ªç„¶ï¼Œä½†å®é™…ä¸Šå¹¶ä¸å¹³å‡¡ï¼Œå³ä¾¿æˆ‘ä»¬ä¸è€ƒè™‘é€šä¿¡ä¹‹ç±»çš„ç“¶é¢ˆï¼Œå½“ç®—åŠ›è¶…è¿‡ä¸€å®šè§„æ¨¡æˆ–è€…æ¨¡å‹å°äºä¸€å®šè§„æ¨¡æ—¶ï¼Œå¢åŠ ç®—åŠ›å¾€å¾€åªèƒ½å¢å¤§Batch Sizeã€‚ç„¶è€Œï¼Œå¢å¤§Batch Sizeä¸€å®šå¯ä»¥ç¼©çŸ­è®­ç»ƒæ—¶é—´å¹¶ä¿æŒæ•ˆæœä¸å˜å—ï¼Ÿ</p>
<p>è¿™å°±æ˜¯æ¥ä¸‹æ¥æˆ‘ä»¬è¦è®¨è®ºçš„è¯é¢˜ï¼šå½“Batch Sizeå¢å¤§æ—¶ï¼Œå„ç§è¶…å‚æ•°å°¤å…¶æ˜¯å­¦ä¹ ç‡è¯¥å¦‚ä½•è°ƒæ•´ï¼Œæ‰èƒ½ä¿æŒåŸæœ¬çš„è®­ç»ƒæ•ˆæœå¹¶æœ€å¤§åŒ–è®­ç»ƒæ•ˆç‡ï¼Ÿæˆ‘ä»¬ä¹Ÿå¯ä»¥ç§°ä¹‹ä¸ºBatch Sizeä¸å­¦ä¹ ç‡ä¹‹é—´çš„Scaling Lawã€‚</p>
<h2 id="_1">æ–¹å·®è§†è§’</h2>
<p>ç›´è§‰ä¸Šï¼Œå½“Batch Sizeå¢å¤§æ—¶ï¼Œæ¯ä¸ªBatchçš„æ¢¯åº¦å°†ä¼šæ›´å‡†ï¼Œæ‰€ä»¥æ­¥å­å°±å¯ä»¥è¿ˆå¤§ä¸€ç‚¹ï¼Œä¹Ÿå°±æ˜¯å¢å¤§å­¦ä¹ ç‡ï¼Œä»¥æ±‚æ›´å¿«è¾¾åˆ°ç»ˆç‚¹ï¼Œç¼©çŸ­è®­ç»ƒæ—¶é—´ï¼Œè¿™ä¸€ç‚¹å¤§ä½“ä¸Šéƒ½èƒ½æƒ³åˆ°ã€‚é—®é¢˜å°±æ˜¯ï¼Œå¢å¤§å¤šå°‘æ‰æ˜¯æœ€åˆé€‚çš„å‘¢ï¼Ÿ</p>
<h3 id="_2">äºŒæ¬¡æ–¹æ ¹</h3>
<p>è¿™ä¸ªé—®é¢˜æœ€æ—©çš„ç­”æ¡ˆå¯èƒ½æ˜¯å¹³æ–¹æ ¹ç¼©æ”¾ï¼Œå³Batch Sizeæ‰©å¤§åˆ°$n$å€ï¼Œåˆ™å­¦ä¹ ç‡æ‰©å¤§åˆ°$\sqrt{n}$å€ï¼Œå‡ºè‡ª2014å¹´çš„<a href="https://papers.cool/arxiv/1404.5997">ã€ŠOne weird trick for parallelizing convolutional neural networksã€‹</a>ï¼Œæ¨å¯¼åŸç†æ˜¯è®©SGDå¢é‡çš„æ–¹å·®ä¿æŒä¸å˜ã€‚å…·ä½“æ¥è¯´ï¼Œæˆ‘ä»¬å°†éšæœºé‡‡æ ·ä¸€ä¸ªæ ·æœ¬çš„æ¢¯åº¦è®°ä¸º$\tilde{\boldsymbol{g}}$ï¼Œå…¶å‡å€¼å’Œåæ–¹å·®åˆ†åˆ«è®°ä¸º$\boldsymbol{g}$å’Œ$\boldsymbol{\Sigma}$ï¼Œè¿™é‡Œçš„$\boldsymbol{g}$å°±æ˜¯å…¨ä½“æ ·æœ¬çš„æ¢¯åº¦ã€‚å½“æˆ‘ä»¬å°†é‡‡æ ·æ•°ç›®å¢åŠ åˆ°$B$ä¸ªæ—¶ï¼Œæœ‰<br />
\begin{equation}\tilde{\boldsymbol{g}}<em i="1">B \triangleq \frac{1}{B}\sum</em>}^B \tilde{\boldsymbol{g}}^{(i)},\quad \mathbb{E}[\tilde{\boldsymbol{g}}_B] = \boldsymbol{g},\quad \mathbb{E}[(\tilde{\boldsymbol{g}}_B-\boldsymbol{g})(\tilde{\boldsymbol{g}}_B-\boldsymbol{g})^{\top}]=\frac{\boldsymbol{\Sigma}}{B}\end{equation<br />
å³å¢åŠ é‡‡æ ·æ•°ç›®ä¸æ”¹å˜å‡å€¼ï¼Œè€Œåæ–¹å·®åˆ™ç¼©å°åˆ°$1/B$ã€‚å¯¹äºSGDä¼˜åŒ–å™¨æ¥è¯´ï¼Œå¢é‡ä¸º$-\eta \tilde{\boldsymbol{g}}_B$ï¼Œå…¶åæ–¹å·®æ­£æ¯”äº$\eta^2/B$ï¼Œè€Œæˆ‘ä»¬è®¤ä¸ºä¼˜åŒ–è¿‡ç¨‹ä¸­é€‚é‡çš„ï¼ˆä¸å¤šä¸å°‘çš„ï¼‰å™ªå£°æ˜¯æœ‰å¿…è¦çš„ï¼Œæ‰€ä»¥å½“Batch Size $B$å˜åŒ–æ—¶ï¼Œæˆ‘ä»¬é€šè¿‡è°ƒæ•´å­¦ä¹ ç‡$\eta$è®©å¢é‡çš„å™ªå£°å¼ºåº¦å³åæ–¹å·®çŸ©é˜µä¿æŒä¸å˜ï¼Œä»å¾—å‡º<br />
\begin{equation}\frac{\eta^2}{B} = \text{å¸¸æ•°}\quad\Rightarrow\quad \eta\propto \sqrt{B}\end{equation}<br />
è¿™å°±å¾—åˆ°äº†å­¦ä¹ ç‡ä¸Batch Sizeçš„å¹³æ–¹æ ¹ç¼©æ”¾å®šå¾‹ï¼Œåæ¥çš„<a href="https://papers.cool/arxiv/1705.08741">ã€ŠTrain longer, generalize better: closing the generalization gap in large batch training of neural networksã€‹</a>ä¹Ÿè®¤åŒè¿™ä¸ªé€‰æ‹©ã€‚</p>
<h3 id="_3">çº¿æ€§ç¼©æ”¾</h3>
<p>æœ‰æ„æ€çš„æ˜¯ï¼Œçº¿æ€§ç¼©æ”¾å³$\eta\propto B$åœ¨å®è·µä¸­çš„è¡¨ç°å¾€å¾€æ›´å¥½ï¼Œç”šè‡³åˆšæ‰è¯´çš„æœ€æ—©æå‡ºå¹³æ–¹æ ¹ç¼©æ”¾çš„<a href="https://papers.cool/arxiv/1404.5997">ã€ŠOne weird trick for parallelizing convolutional neural networksã€‹</a>ä½œè€…ä¹Ÿåœ¨è®ºæ–‡ä¸­æŒ‡å‡ºäº†è¿™ä¸€ç‚¹ï¼Œå¹¶è¡¨ç¤ºä»–ä¹Ÿæ— æ³•ç»™å‡ºåˆç†çš„è§£é‡Šã€‚</p>
<p>æŸç§ç¨‹åº¦ä¸Šæ¥è¯´ï¼Œçº¿æ€§ç¼©æ”¾æ›´ç¬¦åˆæˆ‘ä»¬çš„ç›´è§‚è®¤çŸ¥ï¼Œå°¤å…¶æ˜¯åƒ<a href="https://papers.cool/arxiv/1706.02677">ã€ŠAccurate, Large Minibatch SGD: Training ImageNet in 1 Hourã€‹</a>é‚£æ ·ï¼Œå‡è®¾è¿ç»­çš„$n$ä¸ªBatchçš„æ¢¯åº¦æ–¹å‘å˜åŒ–ä¸å¤§çš„è¯ï¼Œé‚£ä¹ˆçº¿æ€§ç¼©æ”¾å‡ ä¹æ˜¯æ˜¾ç„¶æˆç«‹çš„ã€‚ä¸è¿‡ï¼Œè¿™ä¸ªå‡è®¾æ˜¾ç„¶è¿‡å¼ºï¼Œæ”¾å®½è¿™ä¸ªå‡è®¾åˆ™éœ€è¦å°†SGDè·ŸSDEï¼ˆéšæœºå¾®åˆ†æ–¹ç¨‹ï¼‰è”ç³»èµ·æ¥ï¼Œè¿™ç”±<a href="https://papers.cool/arxiv/1811.01558">ã€ŠStochastic Modified Equations and Dynamics of Stochastic Gradient Algorithms I: Mathematical Foundationsã€‹</a>å®Œæˆï¼Œä½†é¦–å…ˆç”¨äºæŒ‡å‡ºå­¦ä¹ ç‡ä¸Batch Sizeçš„ç¼©æ”¾å…³ç³»çš„è®ºæ–‡åº”è¯¥æ˜¯<a href="https://papers.cool/arxiv/2006.15081">ã€ŠOn the Generalization Benefit of Noise in Stochastic Gradient Descentã€‹</a>ã€‚</p>
<p>äº‹åæ¥çœ‹ï¼Œè¿™ä¸ªè”ç³»çš„å»ºç«‹å…¶å®å¹¶ä¸éš¾ç†è§£ï¼Œè®¾æ¨¡å‹å‚æ•°ä¸º$\boldsymbol{w}$ï¼Œé‚£ä¹ˆSGDçš„æ›´æ–°è§„åˆ™å¯ä»¥æ”¹å†™æˆ<br />
\begin{equation}\boldsymbol{w}<em B_t="B,t">{t+1} =\boldsymbol{w}_t - \eta \tilde{\boldsymbol{g}}</em>} =\boldsymbol{w<em B_t="B,t">t - \eta \boldsymbol{g}_t - \eta (\tilde{\boldsymbol{g}}</em>} - \boldsymbol{g<em B_t="B,t">t)\end{equation}<br />
å…¶ä¸­$\tilde{\boldsymbol{g}}</em>} - \boldsymbol{g<em t_1="t+1">t$å³ä¸ºæ¢¯åº¦çš„å™ªå£°ï¼Œåˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬è¿˜æ²¡æœ‰å¯¹è¿™ä¸ªå™ªå£°çš„åˆ†å¸ƒåšä»»ä½•å‡è®¾ï¼ŒåªçŸ¥é“å®ƒçš„å‡å€¼ä¸º$\boldsymbol{0}$ï¼Œåæ–¹å·®ä¸º$\boldsymbol{\Sigma}_t/B$ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å‡è®¾è¿™ä¸ªå™ªå£°çš„åˆ†å¸ƒæ˜¯æ­£æ€åˆ†å¸ƒ$\mathcal{N}(\boldsymbol{0},\boldsymbol{\Sigma}_t/B)$ï¼Œé‚£ä¹ˆä¸Šè¿°è¿­ä»£å¯ä»¥è¿›ä¸€æ­¥æ”¹å†™æˆ<br />
\begin{equation}\begin{aligned}<br />
\boldsymbol{w}</em>} =&amp;\, \boldsymbol{w<em B_t="B,t">t - \eta \boldsymbol{g}_t - \eta (\tilde{\boldsymbol{g}}</em>} - \boldsymbol{g<em t_1="t+1">t) \\\[5pt]<br />
=&amp;\, \boldsymbol{w}_t - \eta \boldsymbol{g}_t - \eta \sqrt{\frac{\boldsymbol{\Sigma}_t}{B}}\boldsymbol{z},\quad \boldsymbol{z}\sim \mathcal{N}(\boldsymbol{0},\boldsymbol{I}) \\\[5pt]<br />
=&amp;\, \boldsymbol{w}_t - \eta \boldsymbol{g}_t - \sqrt{\eta} \sqrt{\frac{\eta\boldsymbol{\Sigma}_t}{B}}\boldsymbol{z},\quad \boldsymbol{z}\sim \mathcal{N}(\boldsymbol{0},\boldsymbol{I}) \end{aligned}\end{equation}<br />
è¿™å°±æ„å‘³ç€SGDçš„è¿­ä»£æ ¼å¼$\boldsymbol{w}</em>} =\boldsymbol{w<em B_t="B,t">t - \eta \tilde{\boldsymbol{g}}</em>$å®é™…ä¸Šåœ¨è¿‘ä¼¼åœ°æ±‚è§£SDEï¼š<br />
\begin{equation}d\boldsymbol{w} = - \boldsymbol{g}<em>t dt - \sqrt{\frac{\eta\boldsymbol{\Sigma}_t}{B}}d\boldsymbol{z},\quad d\boldsymbol{z}\sim \mathcal{N}(\boldsymbol{0},dt\boldsymbol{I}) \end{equation}<br />
å› æ­¤ï¼Œè¦æƒ³åœ¨$B$å‘ç”Ÿå˜åŒ–æ—¶ï¼Œè¿è¡Œç»“æœä¸äº§ç”Ÿæ˜æ˜¾å˜åŒ–ï¼Œä¸Šè¿°SDEçš„å½¢å¼åº”è¯¥ä¸å˜ï¼Œè¿™å°±å¾—åˆ°äº†çº¿æ€§ç¼©æ”¾$\eta\propto B$ã€‚è¿™ä¸ªè¿‡ç¨‹ä¸­æœ€å…³é”®çš„ä¸€æ­¥æ˜¯ï¼Œ _SDEçš„å™ªå£°é¡¹æ­¥é•¿æ˜¯éå™ªå£°é¡¹çš„å¹³æ–¹æ ¹</em> ï¼Œä»è€Œåˆ†ç¦»å‡ºä¸€é¡¹$\sqrt{\eta}$æ¥ã€‚è¿™ä¸€ç‚¹æˆ‘ä»¬åœ¨<a href="/archives/9209">ã€Šç”Ÿæˆæ‰©æ•£æ¨¡å‹æ¼«è°ˆï¼ˆäº”ï¼‰ï¼šä¸€èˆ¬æ¡†æ¶ä¹‹SDEç¯‡ã€‹</a>ä¹Ÿæœ‰è¿‡è¯„æï¼Œç®€å•æ¥è¯´å°±æ˜¯é›¶å‡å€¼çš„é«˜æ–¯å™ªå£°é•¿æœŸä¼šæœ‰ä¸€å®šçš„æŠµæ¶ˆä½œç”¨ï¼Œæ‰€ä»¥å¿…é¡»å¢å¤§æ­¥é•¿æ‰èƒ½å°†å™ªå£°æ•ˆåº”ä½“ç°å‡ºæ¥ã€‚</p>
<p>ä»¥ä¸Šç»“è®ºéƒ½æ˜¯åŸºäºSGDä¼˜åŒ–å™¨å¾—å‡ºçš„ï¼Œè®ºæ–‡<a href="https://papers.cool/arxiv/2205.10287">ã€ŠOn the SDEs and Scaling Rules for Adaptive Gradient Algorithmsã€‹</a>å°†å®ƒæ¨å¹¿åˆ°äº†RMSPropã€Adamç­‰ä¼˜åŒ–å™¨ä¸Šï¼Œç»“æœæ˜¯ <em>å¹³æ–¹æ ¹ç¼©æ”¾</em> ã€‚æ— ç‹¬æœ‰å¶ï¼Œç¨æ—©ä¸€ç‚¹çš„<a href="https://papers.cool/arxiv/1904.00962">ã€ŠLarge Batch Optimization for Deep Learning: Training BERT in 76 minutesã€‹</a>åœ¨æµ‹è¯•AdamåŠå…¶å˜ä½“LAMBæ—¶ï¼Œä¹Ÿåº”ç”¨äº†å¹³æ–¹æ ¹ç¼©æ”¾ã€‚æ›´å¤šå†…å®¹è¿˜å¯ä»¥å‚è€ƒåšå®¢<a href="https://www.cs.princeton.edu/~smalladi/blog/2024/01/22/SDEs-ScalingRules/">ã€ŠHow to Scale Hyperparameters as Batch Size Increasesã€‹</a>ã€‚</p>
<h2 id="_4">ç›´é¢æŸå¤±</h2>
<p>å¯ä»¥è‚¯å®šçš„æ˜¯ï¼Œä¸ç®¡æ˜¯å¹³æ–¹æ ¹ç¼©æ”¾è¿˜æ˜¯çº¿æ€§ç¼©æ”¾ï¼Œå®ƒä»¬éƒ½åªèƒ½åœ¨å±€éƒ¨èŒƒå›´å†…è¿‘ä¼¼æˆç«‹ï¼Œå› ä¸ºå®ƒä»¬éƒ½åŒ…å«äº†â€œåªè¦Batch Sizeè¶³å¤Ÿå¤§ï¼Œé‚£ä¹ˆå­¦ä¹ ç‡å°±å¯ä»¥ä»»æ„å¤§â€çš„ç»“è®ºï¼Œè¿™æ˜¾ç„¶æ˜¯ä¸å¯èƒ½çš„ã€‚æ­¤å¤–ï¼Œå‰é¢ä¸¤èŠ‚çš„å·¥ä½œéƒ½å›´ç»•ç€æ–¹å·®åšæ–‡ç« ï¼Œä½†æˆ‘ä»¬çš„æ ¹æœ¬ä»»åŠ¡æ˜¯é™ä½æŸå¤±å‡½æ•°ï¼Œå› æ­¤ä»¥æŸå¤±å‡½æ•°ä¸ºå¯¼å‘æˆ–è®¸æ›´ä¸ºæœ¬è´¨ã€‚</p>
<h3 id="_5">å•è°ƒæœ‰ç•Œ</h3>
<p>è¿™ä¸ªè§†è§’ä¸‹çš„ç»å…¸å·¥ä½œæ˜¯OpenAIçš„<a href="https://papers.cool/arxiv/1812.06162">ã€ŠAn Empirical Model of Large-Batch Trainingã€‹</a>ï¼Œå®ƒé€šè¿‡æŸå¤±å‡½æ•°çš„äºŒé˜¶è¿‘ä¼¼æ¥åˆ†æSGDçš„æœ€ä¼˜å­¦ä¹ ç‡ï¼Œå¾—å‡ºâ€œå­¦ä¹ ç‡éšç€Batch Sizeçš„å¢åŠ è€Œå•è°ƒé€’å¢ä½†æœ‰ä¸Šç•Œâ€çš„ç»“è®ºã€‚åŒæ ·çš„æ€è·¯åœ¨ç¨æ—©çš„<a href="https://papers.cool/arxiv/1705.07774">ã€ŠDissecting Adam: The Sign, Magnitude and Variance of Stochastic Gradientsã€‹</a>ä¹Ÿå‡ºç°äº†ï¼Œä¸è¿‡é‚£ç¯‡è®ºæ–‡å¹¶ä¸æ˜¯ç”¨æ¥åˆ†æBatch Sizeçš„ä½œç”¨ã€‚</p>
<p>æ•´ä¸ªæ¨å¯¼è¿‡ç¨‹æœ€å…³é”®çš„æ€æƒ³æ˜¯å°†å­¦ä¹ ç‡ä¹Ÿè§†ä½œä¼˜åŒ–å‚æ•°ï¼šè®¾æŸå¤±å‡½æ•°æ˜¯$\mathcal{L}(\boldsymbol{w})$ï¼Œå½“å‰Batchçš„æ¢¯åº¦æ˜¯$\tilde{\boldsymbol{g}}<em _max="\max">B$ï¼Œé‚£ä¹ˆSGDåçš„æŸå¤±å‡½æ•°åˆ™æ˜¯$\mathcal{L}(\boldsymbol{w} - \eta\tilde{\boldsymbol{g}}_B)$ï¼Œæˆ‘ä»¬å°†æœ€ä¼˜å­¦ä¹ ç‡çš„æ±‚è§£è§†ä¸ºä¼˜åŒ–é—®é¢˜<br />
\begin{equation}\eta^<em> = \mathop{\text{argmin}}<em>{\eta} \mathbb{E}[\mathcal{L}(\boldsymbol{w} - \eta\tilde{\boldsymbol{g}}_B)]\end{equation}<br />
è¿™ä¸ªç›®æ ‡æ˜¾ç„¶å¾ˆç›´è§‚ï¼Œå°±æ˜¯é€‰æ‹©å­¦ä¹ ç‡ä½¿å¾— _å¹³å‡è€Œè¨€</em> è®­ç»ƒæ•ˆç‡æœ€é«˜ï¼ˆæŸå¤±å‡½æ•°ä¸‹é™å¾—æœ€å¿«ï¼‰ã€‚ä¸ºäº†æ±‚è§£è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å°†æŸå¤±å‡½æ•°è¿‘ä¼¼åœ°å±•å¼€åˆ°äºŒé˜¶ï¼š<br />
\begin{equation}\mathcal{L}(\boldsymbol{w} - \eta\tilde{\boldsymbol{g}}<em _text_å°±æ˜¯="\text{å°±æ˜¯">B) \approx \mathcal{L}(\boldsymbol{w}) - \eta\tilde{\boldsymbol{g}}_B^{\top}\underbrace{\frac{\partial \mathcal{L}(\boldsymbol{w})}{\partial\boldsymbol{w}}}</em>}\boldsymbol{g}} + \frac{1}{2}\eta^2 \tilde{\boldsymbol{g}<em _text_è®°ä¸º="\text{è®°ä¸º">B^{\top}\underbrace{\frac{\partial^2 \mathcal{L}(\boldsymbol{w})}{\partial\boldsymbol{w}^2}}</em>}\boldsymbol{H}}\tilde{\boldsymbol{g}}_B = \mathcal{L}(\boldsymbol{w}) - \eta\tilde{\boldsymbol{g}}_B^{\top}\boldsymbol{g} + \frac{1}{2}\eta^2 \tilde{\boldsymbol{g}}_B^{\top}\boldsymbol{H}\tilde{\boldsymbol{g}}_B\end{equation<br />
è¿™é‡Œçš„$\boldsymbol{H}$å°±æ˜¯HessiançŸ©é˜µï¼Œè€Œ$\frac{\partial \mathcal{L}(\boldsymbol{w})}{\partial\boldsymbol{w}}$æ˜¯æŸå¤±å‡½æ•°çš„æ¢¯åº¦ï¼Œç†æƒ³çš„ç›®æ ‡å‡½æ•°æ˜¯åŸºäºå…¨é‡æ ·æœ¬æ¥æ±‚çš„ï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆå®ƒçš„æ¢¯åº¦å°±æ˜¯$\tilde{\boldsymbol{g}}_B$çš„å‡å€¼$\boldsymbol{g}$ã€‚æ¥ç€æ±‚æœŸæœ›ï¼Œæˆ‘ä»¬å¾—åˆ°<br />
\begin{equation}\mathbb{E}[\mathcal{L}(\boldsymbol{w} - \eta\tilde{\boldsymbol{g}}_B)] \approx \mathbb{E}[\mathcal{L}(\boldsymbol{w}) - \eta\tilde{\boldsymbol{g}}_B^{\top}\boldsymbol{g} + \frac{1}{2}\eta^2 \tilde{\boldsymbol{g}}_B^{\top}\boldsymbol{H}\tilde{\boldsymbol{g}}_B] = \mathcal{L}(\boldsymbol{w}) - \eta\boldsymbol{g}^{\top}\boldsymbol{g} + \frac{1}{2}\eta^2 \mathbb{E}[\tilde{\boldsymbol{g}}_B^{\top}\boldsymbol{H}\tilde{\boldsymbol{g}}_B]\end{equation}<br />
æœ€åä¸€é¡¹æœ‰å°‘è®¸æŠ€å·§ï¼š<br />
\begin{equation}\newcommand{tr}{\mathop{\text{tr}}}\begin{aligned}<br />
\mathbb{E}[\tilde{\boldsymbol{g}}_B^{\top}\boldsymbol{H}\tilde{\boldsymbol{g}}_B] =&amp;\, \mathbb{E}[\tr(\tilde{\boldsymbol{g}}_B^{\top}\boldsymbol{H}\tilde{\boldsymbol{g}}_B)]= \mathbb{E}[\tr(\tilde{\boldsymbol{g}}_B\tilde{\boldsymbol{g}}_B^{\top}\boldsymbol{H})] = \tr(\mathbb{E}[\tilde{\boldsymbol{g}}_B\tilde{\boldsymbol{g}}_B^{\top}]\boldsymbol{H})\\\[5pt]<br />
=&amp;\, \tr((\boldsymbol{g}\boldsymbol{g}^{\top} + \boldsymbol{\Sigma}/B)\boldsymbol{H}) = \boldsymbol{g}^{\top}\boldsymbol{H}\boldsymbol{g} + \tr(\boldsymbol{\Sigma}\boldsymbol{H})/B<br />
\end{aligned}\end{equation}<br />
å˜æ¢è¿‡ç¨‹ä¸»è¦åˆ©ç”¨åˆ°äº†$\tr(\boldsymbol{A}\boldsymbol{B}) = \tr(\boldsymbol{B}\boldsymbol{A})$ã€‚ç°åœ¨åªè¦å‡å®š$\boldsymbol{H}$çš„æ­£å®šæ€§ï¼Œé‚£ä¹ˆé—®é¢˜å°±å˜æˆäº†äºŒæ¬¡å‡½æ•°çš„æœ€å°å€¼ï¼Œå®¹æ˜“è§£å¾—<br />
\begin{equation}\eta^</em> \approx \frac{\boldsymbol{g}^{\top}\boldsymbol{g}}{\boldsymbol{g}^{\top}\boldsymbol{H}\boldsymbol{g} + \tr(\boldsymbol{\Sigma}\boldsymbol{H})/B} = \frac{\eta</em>}}{1 + \mathcal{B<em _max="\max">{\text{noise}}/B}\label{eq:eta-opt}\end{equation}<br />
è¿™å°±å¾—å‡ºäº†â€œéšç€$B$å•è°ƒé€’å¢æœ‰ä¸Šç•Œâ€œçš„ç»“æœï¼Œå…¶ä¸­<br />
\begin{equation}\eta</em>} = \frac{\boldsymbol{g}^{\top}\boldsymbol{g}}{\boldsymbol{g}^{\top}\boldsymbol{H}\boldsymbol{g}},\qquad\mathcal{B}_{\text{noise}} = \frac{\tr(\boldsymbol{\Sigma}\boldsymbol{H})}{\boldsymbol{g}^{\top}\boldsymbol{H}\boldsymbol{g}}\end{equation</p>
<h3 id="_6">å®è·µåˆ†æ</h3>
<p>å½“$B \ll \mathcal{B}<em _text_noise="\text{noise">{\text{noise}}$æ—¶ï¼Œ$1 + \mathcal{B}</em>}}/B\approx \mathcal{B<em _max="\max">{\text{noise}}/B$ï¼Œæ‰€ä»¥$\eta^<em> \approx \eta_{\max}B/\mathcal{B}<em _text_noise="\text{noise">{\text{noise}}\propto B$ï¼Œå³çº¿æ€§ç¼©æ”¾ï¼Œè¿™å†æ¬¡ä½“ç°äº†çº¿æ€§ç¼©æ”¾åªæ˜¯å°Batch Sizeæ—¶çš„å±€éƒ¨è¿‘ä¼¼ï¼›å½“$B &gt; \mathcal{B}</em>$æ—¶ï¼Œ$\eta^}</em>$é€æ¸è¶‹äºé¥±å’Œå€¼$\eta</em>$ç›¸å½“äºä¸€ä¸ªåˆ†æ°´å²­ï¼Œå½“Batch Sizeè¶…è¿‡è¿™ä¸ªæ•°å€¼æ—¶ï¼Œå°±æ²¡å¿…è¦ç»§ç»­æŠ•å…¥ç®—åŠ›å»å¢å¤§Batch Sizeäº†ã€‚}$ï¼Œè¿™æ„å‘³ç€è®­ç»ƒæˆæœ¬çš„å¢åŠ è¿œå¤§äºè®­ç»ƒæ•ˆç‡çš„æå‡ã€‚æ‰€ä»¥ï¼Œ$\mathcal{B}_{\text{noise}</p>
<p>å¯¹äºå®è·µæ¥è¯´ï¼Œæœ€å…³é”®çš„é—®é¢˜æ— ç–‘å°±æ˜¯å¦‚ä½•ä¼°è®¡$\eta_{\max}$å’Œ$\mathcal{B}<em _text_noise="\text{noise">{\text{noise}}$äº†ï¼Œå°¤å…¶æ˜¯$\mathcal{B}</em>$ï¼Œå…¶è®¡ç®—é‡æ­£æ¯”äºå‚æ•°é‡çš„å¹³æ–¹ï¼Œåœ¨æ•°äº¿å‚æ•°é‡éƒ½ç®—å°æ¨¡å‹çš„ä»Šå¤©ï¼Œè®¡ç®—HessiançŸ©é˜µæ˜¾ç„¶æ˜¯ä¸ç°å®çš„äº‹æƒ…ï¼Œæ‰€ä»¥å¿…é¡»å¯»æ‰¾æ›´æœ‰æ•ˆçš„è®¡ç®—æ–¹å¼ã€‚}}$ç›´æ¥å…³ç³»åˆ°å­¦ä¹ ç‡çš„ç¼©æ”¾è§„å¾‹å’Œè®­ç»ƒæ•ˆç‡çš„é¥±å’Œé—®é¢˜ï¼ŒäºŒè€…çš„ç›´æ¥è®¡ç®—æ¶‰åŠåˆ°HessiançŸ©é˜µ$\boldsymbol{H</p>
<p>æˆ‘ä»¬å…ˆæ¥çœ‹$\mathcal{B}<em _text_noise="\text{noise">{\text{noise}}$ï¼Œå®ƒçš„å¼å­æ˜¯$\frac{\tr(\boldsymbol{\Sigma}\boldsymbol{H})}{\boldsymbol{g}^{\top}\boldsymbol{H}\boldsymbol{g}}$ï¼Œåˆ†å­åˆ†æ¯éƒ½æœ‰ä¸€ä¸ª$\boldsymbol{H}$ï¼Œè¿™æ— ç–‘æœ‰ä¸€ç§è®©æˆ‘ä»¬å°†å®ƒä»¬â€œçº¦æ‰â€çš„å†²åŠ¨ã€‚äº‹å®ä¸Šç®€åŒ–çš„æ€è·¯ä¹Ÿæ˜¯å¦‚æ­¤ï¼Œå‡è®¾$\boldsymbol{H}$è¿‘ä¼¼äºå•ä½é˜µçš„è‹¥å¹²å€ï¼Œé‚£ä¹ˆå¾—åˆ°<br />
\begin{equation}\mathcal{B}</em>}} = \frac{\tr(\boldsymbol{\Sigma}\boldsymbol{H})}{\boldsymbol{g}^{\top}\boldsymbol{H}\boldsymbol{g}}\approx \frac{\tr(\boldsymbol{\Sigma})}{\boldsymbol{g}^{\top}\boldsymbol{g}}\triangleq \mathcal{B<em _text_simple="\text{simple">{\text{simple}}\end{equation}<br />
$\mathcal{B}</em>}}$åœ¨è®¡ç®—ä¸Šæ›´ä¸ºå¯è¡Œï¼Œå¹¶ä¸”å®éªŒå‘ç°å®ƒé€šå¸¸æ˜¯$\mathcal{B<em _text_simple="\text{simple">{\text{noise}}$çš„ä¸€ä¸ªè‰¯å¥½è¿‘ä¼¼ï¼Œå› æ­¤æˆ‘ä»¬é€‰æ‹©ä¼°è®¡$\mathcal{B}</em>)$åªéœ€è¦å¯¹è§’çº¿ä¸Šçš„å…ƒç´ ï¼Œå› æ­¤ä¸ç”¨ç®—å‡ºå®Œæ•´çš„åæ–¹å·®çŸ©é˜µï¼Œåªéœ€è¦å°†æ¯ä¸ªæ¢¯åº¦åˆ†é‡å•ç‹¬ç®—æ–¹å·®ç„¶åæ±‚å’Œã€‚åœ¨æ•°æ®å¹¶è¡Œåœºæ™¯ï¼Œå¯ä»¥ç›´æ¥åˆ©ç”¨æ¯ä¸ªè®¾å¤‡ä¸Šç®—å‡ºæ¥æ¢¯åº¦æ¥ä¼°è®¡æ¢¯åº¦æ–¹å·®ã€‚}}$è€Œä¸æ˜¯$\mathcal{B}_{\text{noise}}$ã€‚æ³¨æ„$\tr(\boldsymbol{\Sigma</p>
<p>éœ€è¦æŒ‡å‡ºçš„æ˜¯ï¼Œå¼$\eqref{eq:eta-opt}$ç­‰ç»“æœå®é™…ä¸Šæ˜¯åŠ¨æ€çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ç†è®ºä¸Šæ¯ä¸€æ­¥è®­ç»ƒçš„$\eta_{\max}$ã€$\mathcal{B}<em _text_simple="\text{simple">{\text{noise}}$ã€$\mathcal{B}</em>}}$éƒ½æ˜¯ä¸åŒçš„ï¼Œæ‰€ä»¥å¦‚æœæˆ‘ä»¬å¸Œæœ›å¾—åˆ°ä¸€ä¸ªé™æ€çš„è§„å¾‹ï¼Œéœ€è¦æŒç»­è®­ç»ƒä¸€æ®µæ—¶é—´ï¼Œç­‰åˆ°æ¨¡å‹çš„è®­ç»ƒè¿›å…¥â€œæ­£è½¨â€åè®¡ç®—çš„$\mathcal{B<em _text_simple="\text{simple">{\text{simple}}$æ‰å¯é çš„ï¼Œæˆ–è€…ä¹Ÿå¯ä»¥åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­æŒç»­ç›‘æ§$\mathcal{B}</em>$ï¼Œä»¥ä¾¿åˆ¤æ–­å½“å‰è®¾ç½®ä¸æœ€ä¼˜çš„å·®è·ã€‚}</p>
<p>è‡³äº$\eta_{\max}$ï¼Œå…¶å®å°±æ²¡å¿…è¦æ ¹æ®å…¬å¼æ¥ä¼°è®¡äº†ï¼Œç›´æ¥åœ¨æŸä¸ªå°Batch Sizeä¸‹å¯¹å­¦ä¹ ç‡è¿›è¡Œç½‘æ ¼æœç´¢ï¼Œæœå‡ºä¸€ä¸ªè¿‘ä¼¼çš„$\eta^*$ï¼Œç„¶åç»“åˆä¼°è®¡çš„$\mathcal{B}<em _max="\max">{\text{simple}}$å°±å¯ä»¥åæ¨å‡º$\eta</em>$äº†ã€‚</p>
<h3 id="_7">æ•°æ®æ•ˆç‡</h3>
<p>ä»ä¸Šè¿°ç»“æœå‡ºå‘ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥æ¨å¯¼å…³äºè®­ç»ƒæ•°æ®é‡å’Œè®­ç»ƒæ­¥æ•°çš„ä¸€ä¸ªæ¸è¿‘å…³ç³»ã€‚æ¨å¯¼è¿‡ç¨‹ä¹Ÿå¾ˆç®€å•ï¼Œå°†$\eqref{eq:eta-opt}$ä»£å…¥åˆ°æŸå¤±å‡½æ•°ä¸­å¯ä»¥ç®—å¾—ï¼Œåœ¨æœ€ä¼˜å­¦ä¹ ç‡ä¸‹æ¯ä¸€æ­¥è¿­ä»£å¸¦æ¥çš„æŸå¤±å‡½æ•°å‡å°‘é‡æ˜¯ï¼š<br />
\begin{equation}\overline{\Delta\mathcal{L}} = \mathcal{L}(\boldsymbol{w}) - \mathbb{E}[\mathcal{L}(\boldsymbol{w} - \eta^*\tilde{\boldsymbol{g}}<em _max="\max">B)] \approx \frac{\Delta\mathcal{L}</em>}}{1 + \mathcal{B<em _max="\max">{\text{noise}}/B}\label{eq:Delta-L-sgd}\end{equation}<br />
å…¶ä¸­$\Delta\mathcal{L}</em>$ã€‚æ¥ä¸‹æ¥çš„é‡ç‚¹æ˜¯å¯¹è¿™ä¸ªç»“æœçš„è§£è¯»ã€‚} = \frac{(\boldsymbol{g}^{\top}\boldsymbol{g})^2}{2\boldsymbol{g}^{\top}\boldsymbol{H}\boldsymbol{g}</p>
<p>å½“$B\to\infty$ä¹Ÿå°±æ˜¯å…¨é‡SGDæ—¶ï¼Œæ¯ä¸€æ­¥æŸå¤±å‡½æ•°å‡å°‘é‡è¾¾åˆ°äº†æœ€å¤§çš„$\Delta\mathcal{L}<em _min="\min">{\max}$ï¼Œè¿™æ—¶å€™å¯ä»¥ç”¨æœ€å°‘çš„è®­ç»ƒæ­¥æ•°ï¼ˆè®°ä¸º$S</em>}$ï¼‰è¾¾åˆ°ç›®æ ‡ç‚¹ã€‚å½“$B$æœ‰é™æ—¶ï¼Œæ¯ä¸€æ­¥çš„æŸå¤±ä¸‹é™é‡å¹³å‡åªæœ‰$\overline{\Delta\mathcal{L}}$ï¼Œè¿™æ„å‘³æˆ‘ä»¬éœ€è¦$1 + \mathcal{B<em _text_noise="\text{noise">{\text{noise}}/B$æ­¥æ‰èƒ½è¾¾åˆ°å…¨é‡SGDå•æ­¥çš„ä¸‹é™é‡ï¼Œæ‰€ä»¥è®­ç»ƒæ€»æ­¥æ•°å¤§è‡´ä¸Šæ˜¯$S = (1 + \mathcal{B}</em>$ã€‚}}/B)S_{\min</p>
<p>ç”±äºBatch Sizeä¸º$B$ï¼Œæ‰€ä»¥è®­ç»ƒè¿‡ç¨‹æ¶ˆè€—çš„æ ·æœ¬æ€»æ•°åˆ™æ˜¯$E = BS = (B + \mathcal{B}<em _min="\min">{\text{noise}})S</em>}$ï¼Œè¿™æ˜¯$B$çš„å¢å‡½æ•°ï¼Œä¸”å½“$B\to 0$æ—¶ï¼Œ$E_{\min} = \mathcal{B<em _min="\min">{\text{noise}}S</em>$ï¼Œè¿™è¡¨æ˜åªè¦æˆ‘ä»¬ä½¿ç”¨è¶³å¤Ÿå°çš„Batch Sizeå»è®­ç»ƒæ¨¡å‹ï¼Œé‚£ä¹ˆæ‰€éœ€è¦çš„æ€»è®­ç»ƒæ ·æœ¬æ•°$E$ä¹Ÿä¼šç›¸åº”åœ°å‡å°‘ï¼Œä»£ä»·æ˜¯è®­ç»ƒæ­¥æ•°$S$éå¸¸å¤šã€‚è¿›ä¸€æ­¥åœ°ï¼Œåˆ©ç”¨è¿™äº›è®°å·æˆ‘ä»¬å¯ä»¥å†™å‡ºå®ƒä»¬ä¹‹é—´çš„å…³ç³»æ˜¯ï¼š<br />
\begin{equation}\left(\frac{S}{S_{\min}} - 1\right)\left(\frac{E}{E_{\min}} - 1\right) = 1\label{eq:E-S}\end{equation}<br />
è¿™å°±æ˜¯è®­ç»ƒæ•°æ®é‡å’Œè®­ç»ƒæ­¥æ•°ä¹‹é—´çš„ç¼©æ”¾è§„å¾‹ï¼Œè¡¨æ˜æ•°æ®é‡è¶Šå°ï¼Œé‚£ä¹ˆåº”è¯¥ç¼©å°Batch Sizeï¼Œè®©è®­ç»ƒæ­¥æ•°æ›´å¤šï¼Œæ‰èƒ½æ›´æœ‰æœºä¼šè¾¾åˆ°æ›´ä¼˜çš„è§£ã€‚è¿™é‡Œçš„æ¨å¯¼æ˜¯ç»è¿‡ç¬”è€…ç®€åŒ–çš„ï¼Œå‡è®¾äº†$\mathcal{B}<em _max="\max">{\text{noise}}$å’Œ$\Delta\mathcal{L}</em>$ï¼‰ï¼Œè¿™é‡Œå°±ä¸å±•å¼€äº†ã€‚}$åœ¨æ•´ä¸ªè®­ç»ƒè¿‡ç¨‹çš„ä¸å˜æ€§ï¼Œå¦‚æœæœ‰å¿…è¦ä¹Ÿå¯ä»¥æŒ‰ç…§åŸè®ºæ–‡é™„å½•ç”¨ç§¯åˆ†æ›´ç²¾ç»†åœ°å¤„ç†åŠ¨æ€å˜åŒ–çš„æƒ…å½¢ï¼ˆä½†éœ€è¦å¼•å…¥å‡è®¾$B = \sqrt{r\mathcal{B}_{\text{noise}}</p>
<p>æ­¤å¤–ï¼Œç”±äº$\mathcal{B}<em _min="\min">{\text{noise}} = E</em>}/S_{\min}$ï¼Œæ‰€ä»¥ä¸Šå¼ä¹Ÿæä¾›äº†ä¼°è®¡$\mathcal{B<em _min="\min">{\text{noise}}$çš„å¦ä¸€ä¸ªæ–¹æ¡ˆï¼šé€šè¿‡å¤šæ¬¡å®éªŒåŠ ç½‘æ ¼æœç´¢å¾—åˆ°å¤šä¸ª$(S,E)$å¯¹ï¼Œç„¶åæ‹Ÿåˆä¸Šå¼å°±å¯ä»¥ä¼°è®¡å‡º$E</em>$ã€‚},S_{\min}$ï¼Œç»§è€Œè®¡ç®—$\mathcal{B}_{\text{noise}</p>
<h2 id="_8">è‡ªé€‚åº”ç‰ˆ</h2>
<p>ä¸å¾—ä¸è¯´ï¼ŒOpenAIä¸æ„§ä¸ºå„ç§Scaling Lawçš„å…ˆé©±ä¹‹ä¸€ï¼Œå‰è¿°åˆ†æå¯è°“ç›¸å½“ç²¾å½©ï¼Œå¹¶ä¸”ç»“æœä¹Ÿç›¸å½“ä¸°å¯Œï¼Œæ›´éš¾å¾—çš„æ˜¯ï¼Œæ•´ä¸ªæ¨å¯¼è¿‡ç¨‹å¹¶ä¸å¤æ‚ï¼Œç»™äººä¸€ç§å¤§é“è‡³ç®€çš„æœ¬è´¨æ„Ÿã€‚ä¸è¿‡ï¼Œç›®å‰çš„ç»“è®ºéƒ½æ˜¯åŸºäºSGDæ¥æ¨çš„ï¼Œå¯¹äºAdamç­‰è‡ªé€‚åº”å­¦ä¹ ç‡ä¼˜åŒ–å™¨çš„é€‚ç”¨æ€§è¿˜ä¸æ˜æœ—ï¼Œè¿™éƒ¨åˆ†å†…å®¹ç”±<a href="https://papers.cool/arxiv/2405.14578">ã€ŠSurge Phenomenon in Optimal Learning Rate and Batch Size Scalingã€‹</a>å®Œæˆã€‚</p>
<h3 id="_9">ç¬¦å·è¿‘ä¼¼</h3>
<p>åˆ†æAdamçš„æ€è·¯è·ŸSGDä¸€æ ·ï¼Œéƒ½æ˜¯åŸºäºäºŒé˜¶å±•å¼€ï¼Œä¸åŒçš„æ˜¯æ–¹å‘å‘é‡ç”±$\tilde{\boldsymbol{g}}_B$æ¢æˆäº†ä¸€èˆ¬çš„å‘é‡$\tilde{\boldsymbol{\varphi}}_B$ï¼Œæ­¤æ—¶æˆ‘ä»¬æœ‰<br />
\begin{equation}\mathbb{E}[\mathcal{L}(\boldsymbol{w} - \eta\tilde{\boldsymbol{\varphi}}_B)] \approx \mathcal{L}(\boldsymbol{w}) - \eta\mathbb{E}[\tilde{\boldsymbol{\varphi}}_B]^{\top}\boldsymbol{g} + \frac{1}{2}\eta^2 \tr(\mathbb{E}[\tilde{\boldsymbol{\varphi}}_B\tilde{\boldsymbol{\varphi}}_B^{\top}]\boldsymbol{H})\end{equation}<br />
ç°åœ¨éœ€è¦ç¡®å®š$\tilde{\boldsymbol{\varphi}}_B$ä»¥åŠè®¡ç®—ç›¸åº”çš„$\mathbb{E}[\tilde{\boldsymbol{\varphi}}_B]$å’Œ$\mathbb{E}[\tilde{\boldsymbol{\varphi}}_B\tilde{\boldsymbol{\varphi}}_B^{\top}]$ã€‚ç”±äºåªéœ€è¦ä¸€ä¸ªæ¸è¿‘å…³ç³»ï¼Œæ‰€ä»¥è·Ÿ<a href="/archives/10001">ã€Šé…ç½®ä¸åŒçš„å­¦ä¹ ç‡ï¼ŒLoRAè¿˜èƒ½å†æ¶¨ä¸€ç‚¹ï¼Ÿã€‹</a>ä¸€æ ·ï¼Œæˆ‘ä»¬é€‰æ‹©SignSGDå³$\newcommand{sign}{\mathop{\text{sign}}}\tilde{\boldsymbol{\varphi}}_B = \sign(\tilde{\boldsymbol{g}}_B)$ä½œä¸ºAdamçš„è¿‘ä¼¼ï¼Œè¿™ä¸ªåšæ³•æœ€æ—©çš„å‡ºå¤„å¯èƒ½æ˜¯<a href="https://papers.cool/arxiv/1705.07774">ã€ŠDissecting Adam: The Sign, Magnitude and Variance of Stochastic Gradientsã€‹</a>ã€‚è¿™ä¸ªè¿‘ä¼¼çš„åˆç†æ€§ä½“ç°åœ¨ä¸¤ç‚¹ï¼š</p>
<blockquote>
<p>1ã€æ— è®º$\beta_1,\beta_2$å–ä½•å€¼ï¼ŒAdamç¬¬ä¸€æ­¥çš„æ›´æ–°å‘é‡éƒ½æ˜¯$\sign(\tilde{\boldsymbol{g}}_B)$ï¼›</p>
<p>2ã€å½“$\beta_1=\beta_2=0$æ—¶ï¼ŒAdamçš„æ›´æ–°å‘é‡å§‹ç»ˆä¸º$\sign(\tilde{\boldsymbol{g}}_B)$ã€‚</p>
</blockquote>
<p>ä¸ºäº†è®¡ç®—$\mathbb{E}[\tilde{\boldsymbol{\varphi}}<em -_infty="-\infty">B]$å’Œ$\mathbb{E}[\tilde{\boldsymbol{\varphi}}_B\tilde{\boldsymbol{\varphi}}_B^{\top}]$ï¼Œæˆ‘ä»¬è¿˜éœ€è¦è·Ÿâ€œçº¿æ€§ç¼©æ”¾â€ä¸€èŠ‚ä¸€æ ·ï¼Œå‡è®¾$\tilde{\boldsymbol{g}}_B$æœä»åˆ†å¸ƒ$\mathcal{N}(\boldsymbol{g},\boldsymbol{\Sigma}/B)$ï¼Œè€Œä¸ºäº†ç®€åŒ–è®¡ç®—ï¼Œæˆ‘ä»¬è¿˜è¦è¿›ä¸€æ­¥å‡è®¾$\boldsymbol{\Sigma}$æ˜¯å¯¹è§’é˜µ$\text{diag}(\sigma_1^2,\sigma_2^2,\sigma_3^2,\cdots)$ï¼Œå³å‡è®¾åˆ†é‡ä¹‹é—´æ˜¯ç›¸äº’ç‹¬ç«‹çš„ï¼Œè¿™æ ·ä¸€æ¥æˆ‘ä»¬å¯ä»¥ç‹¬ç«‹åœ°å¤„ç†æ¯ä¸€ä¸ªåˆ†é‡ã€‚æ ¹æ®é‡å‚æ•°æŠ€å·§ï¼Œæˆ‘ä»¬çŸ¥é“$\tilde{g}_B\sim \mathcal{N}(g, \sigma^2/B)$ç­‰ä»·äº$\tilde{g}_B=g + \sigma z/\sqrt{B},z\sim\mathcal{N}(0,1)$ï¼Œå› æ­¤<br />
\begin{equation}\begin{aligned}<br />
\mathbb{E}[\tilde{\varphi}_B] =&amp;\, \mathbb{E}[\sign(g + \sigma z/\sqrt{B})] = \mathbb{E}[\sign(g\sqrt{B}/\sigma + z)] \\\[5pt]<br />
=&amp;\,\frac{1}{\sqrt{2\pi}}\int</em>dz \\\[5pt]}^{\infty} \sign(g\sqrt{B}/\sigma + z) e^{-z^2/2<br />
=&amp;\,\frac{1}{\sqrt{2\pi}}\int_{-\infty}^{-g\sqrt{B}/\sigma} (-1)\times e^{-z^2/2}dz + \frac{1}{\sqrt{2\pi}}\int_{-g\sqrt{B}/\sigma}^{\infty} 1\times e^{-z^2/2}dz \\\[5pt]<br />
=&amp;\,\text{erf}\left(\frac{g}{\sigma}\sqrt{\frac{B}{2}}\right)<br />
\end{aligned}\end{equation}<br />
è¿™é‡Œçš„$\text{erf}$æ˜¯<a href="https://en.wikipedia.org/wiki/Error_function">è¯¯å·®å‡½æ•°</a>ï¼Œå®ƒæ˜¯è·Ÿ$\tanh$ç±»ä¼¼çš„å€¼åŸŸä¸º$(-1,1)$çš„Så‹å‡½æ•°ï¼Œå¯ä»¥ä½œä¸º$\sign$çš„å…‰æ»‘è¿‘ä¼¼ã€‚ä½†$\text{erf}$æœ¬èº«æ²¡æœ‰åˆç­‰å‡½æ•°è¡¨è¾¾å¼ï¼Œæ‰€ä»¥æˆ‘ä»¬æœ€å¥½æ‰¾ä¸€ä¸ªåˆç­‰å‡½æ•°è¿‘ä¼¼ï¼Œæ‰èƒ½æ›´ç›´è§‚åœ°è§‚å¯Ÿå˜åŒ–è§„å¾‹ï¼Œä¹‹å‰æˆ‘ä»¬åœ¨<a href="/archives/7309">ã€ŠGELUçš„ä¸¤ä¸ªåˆç­‰å‡½æ•°è¿‘ä¼¼æ˜¯æ€ä¹ˆæ¥çš„ã€‹</a>å°±è®¨è®ºè¿‡è¿™ä¸ªè¯é¢˜ï¼Œä¸è¿‡é‚£é‡Œçš„è¿‘ä¼¼è¿˜æ˜¯å¤ªå¤æ‚äº†ï¼ˆéƒ½æ¶‰åŠåˆ°æŒ‡æ•°è¿ç®—ï¼‰ï¼Œè¿™é‡Œæˆ‘ä»¬æ•´ä¸ªç®€å•ç‚¹çš„ï¼š<br />
\begin{equation}\text{erf}(x)\approx \sign(x) = \frac{x}{|x|} = \frac{x}{\sqrt{x^2}}\approx \frac{x}{\sqrt{x^2+c}}\end{equation}<br />
æˆ‘ä»¬é€‰æ‹©$c=\pi/4$ï¼Œä½¿å¾—è¿™ä¸ªè¿‘ä¼¼åœ¨$x=0$å¤„çš„ä¸€é˜¶è¿‘ä¼¼è·Ÿ$\text{erf}$çš„ä¸€é˜¶è¿‘ä¼¼ç›¸ç­‰ã€‚å½“ç„¶ï¼Œéƒ½åšäº†è¿™ä¹ˆå¤šé‡è¿‘ä¼¼äº†ï¼Œè¿™ä¸ª$c$çš„å€¼å…¶å®å·²ç»ä¸å¤§é‡è¦ï¼Œæˆ‘ä»¬åªéœ€è¦çŸ¥é“å­˜åœ¨è¿™ä¹ˆä¸ª$c &gt; 0$å°±è¡Œäº†ã€‚åŸºäºè¿™ä¸ªè¿‘ä¼¼ï¼Œæˆ‘ä»¬å¾—åˆ°<br />
\begin{equation}\mathbb{E}[\tilde{\varphi}<em i_j="i,j">B] \approx \frac{g/\sigma}{\sqrt{\pi/2B+(g/\sigma)^2}}\quad\Rightarrow\quad\mathbb{E}[\tilde{\boldsymbol{\varphi}}_B]_i \approx \frac{g_i/\sigma_i}{\sqrt{\pi/2B+(g_i/\sigma_i)^2}}\triangleq \mu_i\end{equation}<br />
å¯ä»¥å‘ç°ï¼ŒAdamè·ŸSGDçš„ä¸€ä¸ªæ˜æ˜¾åŒºåˆ«æ˜¯$\mathbb{E}[\tilde{\boldsymbol{\varphi}}_B]$è¿™ä¸€æ­¥å°±å·²ç»è·Ÿ$B$ç›¸å…³äº†ã€‚ä¸è¿‡å¥½åœ¨ï¼Œæ­¤æ—¶çš„äºŒé˜¶çŸ©æ›´ç®€å•äº†ï¼Œå› ä¸º$\sign(x)$çš„å¹³æ–¹å¿…ç„¶æ˜¯1ï¼Œæ‰€ä»¥<br />
\begin{equation}\mathbb{E}[\tilde{\varphi}_B^2] = 1\quad\Rightarrow\quad\mathbb{E}[\tilde{\boldsymbol{\varphi}}_B\tilde{\boldsymbol{\varphi}}_B^{\top}]</em>&amp;=1, &amp; i = j \\\} \to\left\{\begin{aligned<br />
&amp;\approx\mu_i \mu_j,&amp;\,i\neq j\end{aligned}\right.\end{equation}<br />
åˆ©ç”¨è¿™äº›ç»“æœï¼Œæˆ‘ä»¬å°±å¯ä»¥æ±‚å¾—<br />
\begin{gather}\eta^<em> \approx \frac{\mathbb{E}[\tilde{\boldsymbol{\varphi}}<em i_i="i,i">B]^{\top}\boldsymbol{g}}{\tr(\mathbb{E}[\tilde{\boldsymbol{\varphi}}_B\tilde{\boldsymbol{\varphi}}_B^{\top}]\boldsymbol{H})} \approx \frac{\sum_i \mu_i g_i}{\sum_i H</em> \\\[5pt]} + \sum_{i\neq j} \mu_i \mu_j H_{i,j}}\label{eq:eta-opt-sign<br />
\overline{\Delta\mathcal{L}} = \mathcal{L}(\boldsymbol{w}) - \mathbb{E}[\mathcal{L}(\boldsymbol{w} - \eta^</em>\tilde{\boldsymbol{\varphi}}<em i_i="i,i">B)] \approx \frac{1}{2}\frac{(\sum_i \mu_i g_i)^2}{\sum_i H</em>} + \sum_{i\neq j} \mu_i \mu_j H_{i,j}}\label{eq:Delta-L-sign}\end{gather</p>
<h3 id="_10">ä¸¤ä¸ªç‰¹ä¾‹</h3>
<p>ç›¸æ¯”SGDçš„å¼$\eqref{eq:eta-opt}$ ï¼ŒAdamçš„å¼$\eqref{eq:eta-opt-sign}$æ›´ä¸ºå¤æ‚ï¼Œä»¥è‡³äºæ— æ³•ç›´è§‚çœ‹å‡ºå®ƒå¯¹$B$çš„ä¾èµ–è§„å¾‹ï¼Œæ‰€ä»¥æˆ‘ä»¬ä»å‡ ä¸ªç‰¹æ®Šä¾‹å­å…¥æ‰‹ã€‚</p>
<p>é¦–å…ˆè€ƒè™‘$B\to\infty$ï¼Œæ­¤æ—¶$\mu_i = \sign(g_i)$ï¼Œæ‰€ä»¥<br />
\begin{equation}\eta^* \approx \frac{\sum_i |g_i|}{\sum_i H_{i,i} + \sum_{i\neq j} \sign(g_i g_j) H_{i,j}}\end{equation}<br />
å®ƒè·ŸSGDçš„$\eta_{\max}$çš„åŒºåˆ«æ˜¯å®ƒå…³äºæ¢¯åº¦å¹¶ä¸æ˜¯é½æ¬¡çš„ï¼Œè€Œæ˜¯æ­£æ¯”äºæ¢¯åº¦çš„scaleã€‚</p>
<p>æ¥ç€æˆ‘ä»¬è€ƒè™‘$\boldsymbol{H}$æ˜¯å¯¹è§’é˜µçš„ä¾‹å­ï¼Œå³$i\neq j$æ—¶$H_{i,j}=0$ï¼Œæ­¤æ—¶<br />
\begin{equation}\eta^<em> \approx \frac{\sum_i \mu_i g_i}{\sum_i H_{i,i}}=\frac{1}{\sum_i H_{i,i}}\sum_i \frac{g_i^2/\sigma_i}{\sqrt{\pi/2B+(g_i/\sigma_i)^2}}\end{equation}<br />
è¿™é‡Œæ±‚å’Œçš„æ¯ä¸€é¡¹å…³äº$B$éƒ½æ˜¯å•è°ƒé€’å¢æœ‰ä¸Šç•Œçš„ï¼Œæ‰€ä»¥æ€»çš„ç»“æœä¹Ÿæ˜¯å¦‚æ­¤ã€‚ä¸ºäº†æ•æ‰æœ€æœ¬è´¨çš„è§„å¾‹ï¼Œæˆ‘ä»¬å¯ä»¥è€ƒè™‘è¿›ä¸€æ­¥ç®€åŒ–$\mu_i$ï¼ˆè¿™é‡Œå¼€å§‹è·ŸåŸè®ºæ–‡ä¸ä¸€æ ·ï¼‰ï¼š<br />
\begin{equation}\mu_i = \frac{g_i/\sigma_i}{\sqrt{\pi/2B+(g_i/\sigma_i)^2}} = \frac{\sign(g_i)}{\sqrt{1 + \pi(\sigma_i/g_i)^2/2B}} \approx \frac{\sign(g_i)}{\sqrt{1 + \pi\kappa^2/2B}}\label{eq:mu-approx}\end{equation}<br />
è¿™é‡Œçš„å‡è®¾æ˜¯å­˜åœ¨æŸä¸ªè·Ÿ$i$æ— å…³çš„å¸¸æ•°$\kappa^2$ã€æ¯”å¦‚å¯ä»¥è€ƒè™‘å–å…¨ä½“$(\sigma_i/g_i)^2$çš„æŸç§å‡å€¼ï¼Œå…¶å®è¿™é‡Œçš„$\kappa^2$ç±»ä¼¼å‰é¢çš„$\mathcal{B}<em _text_simple="\text{simple">{\text{simple}}$ï¼ŒæŒ‰ç…§$\mathcal{B}</em>$çš„å®šä¹‰æ¥ä¼°è®¡ä¹Ÿå¯ä»¥ã€‘ï¼Œä½¿å¾—å¯¹ä»»æ„$i$æ¥è¯´æŠŠ$(\sigma_i/g_i)^2$æ¢æˆ$\kappa^2$éƒ½æ˜¯ä¸€ä¸ªè‰¯å¥½è¿‘ä¼¼ï¼Œäºæ˜¯}<br />
\begin{equation}\eta^</em> \approx \frac{\sum_i \mu_i g_i}{\sum_i H_{i,i}}\approx \frac{\sum_i |g_i|}{\sum_i H_{i,i}}\frac{1}{\sqrt{1 + \pi\kappa^2/2B}}\label{eq:eta-opt-sign-diag}\end{equation}<br />
å½“$\pi\kappa^2\gg 2B$å³$B \ll \pi\kappa^2/2$æ—¶ï¼Œå¯ä»¥è¿›ä¸€æ­¥å†™å‡ºè¿‘ä¼¼<br />
\begin{equation}\eta^* \approx \frac{\sum_i |g_i|}{\kappa\sum_i H_{i,i}}\sqrt{\frac{2B}{\pi}} \propto \sqrt{B}\end{equation}<br />
è¿™è¡¨æ˜åœ¨Batch Sizeæœ¬èº«è¾ƒå°æ—¶ï¼ŒAdamç¡®å®é€‚ç”¨äºå¹³æ–¹æ ¹ç¼©æ”¾å®šå¾‹ã€‚</p>
<h3 id="_11">æ¶Œç°è¡Œä¸º</h3>
<p>å¦‚æœæˆ‘ä»¬å°†è¿‘ä¼¼$\eqref{eq:mu-approx}$åº”ç”¨åˆ°åŸå§‹çš„å¼$\eqref{eq:eta-opt-sign}$ï¼Œä¼šå‘ç°å®ƒå­˜åœ¨ä¸€äº›å…¨æ–°çš„ç‰¹æ€§ï¼Œå…·ä½“æ¥è¯´æˆ‘ä»¬æœ‰<br />
\begin{equation}\eta^* \approx \frac{\sum_i \mu_i g_i}{\sum_i H_{i,i} + \sum_{i\neq j} \mu_i \mu_j H_{i,j}} \approx \frac{\eta_{\max}}{\frac{1}{2}\left(\frac{\beta_{\text{noise}}}{\beta} + \frac{\beta}{\beta_{\text{noise}}}\right)}\label{eq:eta-opt-beta}\end{equation}<br />
å…¶ä¸­$\beta = (1 + \pi\kappa^2/2B)^{-1/2}$ï¼Œä»¥åŠ<br />
\begin{equation}\beta_{\text{noise}} = \sqrt{\frac{\sum_i H_{i,i}}{\sum_{i\neq j}\sign(g_i g_j) H_{i,j}}},\quad \eta_{\max} = \frac{\sum_i |g_i|}{2\sqrt{\left(\sum_i H_{i,i}\right)\left(\sum_{i\neq j} \sign(g_i g_j) H_{i,j}\right)}}\end{equation}<br />
æ³¨æ„$\beta$æ˜¯$B$çš„å•è°ƒé€’å¢å‡½æ•°ï¼Œä½†å¼$\eqref{eq:eta-opt-beta}$æœ€åçš„è¿‘ä¼¼å¹¶ä¸æ˜¯$\beta$çš„å•è°ƒé€’å¢å‡½æ•°ï¼Œå®ƒæ˜¯å…ˆå¢åå‡çš„ï¼Œæœ€å¤§å€¼åœ¨$\beta=\beta_{\text{noise}}$å–åˆ°ã€‚è¿™æ„å‘³ç€å­˜åœ¨ä¸€ä¸ªç›¸åº”çš„$\mathcal{B}<em _text_noise="\text{noise">{\text{noise}}$ï¼Œå½“Batch Sizeè¶…è¿‡è¿™ä¸ª$\mathcal{B}</em> \geq 1$ï¼Œé‚£ä¹ˆæœ€ä¼˜å­¦ä¹ ç‡ä¸Batch Sizeçš„å…³ç³»ä¾æ—§æ˜¯å•è°ƒé€’å¢çš„ã€‚ï¼‰}}$åï¼Œæœ€ä½³å­¦ä¹ ç‡ä¸åº”è¯¥å¢å¤§åè€Œè¦å‡å°ï¼è¿™ä¾¿æ˜¯åŸè®ºæ–‡æ ‡é¢˜æ‰€è¯´çš„â€œSurgeç°è±¡â€ã€‚ï¼ˆå½“ç„¶è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªé™åˆ¶ï¼Œ$\beta$æ˜¯å§‹ç»ˆå°äº$1$çš„ï¼Œå¦‚æœ$\beta_{\text{noise}</p>
<p>å…³äºAdamçš„$\eta^<em>$ï¼Œå…¶å®OpenAIåœ¨è®ºæ–‡é™„å½•ä¸­æ›¾ä¸åŠ è¯æ˜åœ°â€œçŒœæµ‹â€Adamçš„æœ€ä¼˜å­¦ä¹ ç‡åº”è¯¥æ˜¯<br />
\begin{equation}\eta^</em> \approx \frac{\eta_{\max}}{(1 + \mathcal{B}_{\text{noise}}/B)^{\alpha}}\label{eq:openai-adam}\end{equation}<br />
å…¶ä¸­$0.5 &lt; \alpha &lt; 1$ã€‚ç°åœ¨çœ‹æ¥ï¼Œè¿™ä¸ªå½¢å¼åªæ˜¯HessiançŸ©é˜µå¯¹è§’çº¿å…ƒç´ å ä¸»å¯¼æ—¶çš„è¿‘ä¼¼ç»“æœï¼Œå½“éå¯¹è§’çº¿å…ƒç´ çš„ä½œç”¨ä¸å¯å¿½ç•¥æ—¶ï¼Œåˆ™æœ‰å¯èƒ½æ¶Œç°å‡ºâ€œBatch Sizeè¶³å¤Ÿå¤§æ—¶å­¦ä¹ ç‡åè€Œåº”è¯¥å‡å°â€çš„Surgeç°è±¡ã€‚</p>
<p>å¦‚ä½•ç›´è§‚åœ°ç†è§£Surgeç°è±¡å‘¢ï¼Ÿç¬”è€…è®¤ä¸ºï¼Œè¿™æœ¬è´¨ä¸Šæ˜¯è‡ªé€‚åº”å­¦ä¹ ç‡ç­–ç•¥çš„<strong>æ¬¡ä¼˜æ€§</strong> çš„ä½“ç°ã€‚ä»ä»¥è¿‘ä¼¼$\tilde{\boldsymbol{\varphi}}_B = \sign(\tilde{\boldsymbol{g}}_B)$ä¸ºä¾‹ï¼Œ$B$è¶Šå¤§$\tilde{\boldsymbol{g}}_B$å°±è¶Šå‡†ï¼Œ$B\to \infty$åˆ™æ˜¯$\sign(\boldsymbol{g})$ï¼Œç„¶è€Œ$\sign(\boldsymbol{g})$æ˜¯æœ€ç§‘å­¦çš„æ›´æ–°æ–¹å‘å—ï¼Ÿä¸ä¸€å®šï¼Œå°¤å…¶æ˜¯è®­ç»ƒåæœŸè¿™ç§è‡ªé€‚åº”ç­–ç•¥å¯èƒ½è¿˜æœ‰è´Ÿé¢ä½œç”¨ã€‚å› æ­¤ï¼Œå½“$B$å–é€‚å½“å€¼æ—¶ï¼Œ$\sign(\tilde{\boldsymbol{g}}_B)$çš„å™ªå£°åè€Œå¯èƒ½ä¿®æ­£è¿™ç§æ¬¡ä¼˜æ€§ï¼Œè€Œ$B$ç»§ç»­å¢å¤§æ—¶å™ªå£°å‡å°‘ï¼Œåè€Œå‡å°‘äº†ä¿®æ­£çš„æœºä¼šï¼Œä»è€Œéœ€è¦æ›´è°¨æ…åœ°é™ä½å­¦ä¹ ç‡ã€‚</p>
<h3 id="_12">æ•ˆç‡å…³ç³»</h3>
<p>åŒSGDçš„åˆ†æä¸€æ ·ï¼Œæœ€åæˆ‘ä»¬è¿˜å¯ä»¥è€ƒè™‘$\overline{\Delta\mathcal{L}}$ï¼Œå°†å¼$\eqref{eq:eta-opt-beta}$ä»£å…¥å¼$\eqref{eq:Delta-L-sign}$ï¼Œæ¢å¤è®°å·$B$ç„¶ååŒ–ç®€ï¼ˆåŒ–ç®€è¿‡ç¨‹ä¸éœ€è¦ä»»ä½•è¿‘ä¼¼ï¼‰å¾—åˆ°<br />
\begin{equation}\overline{\Delta\mathcal{L}} \approx \frac{\Delta\mathcal{L}<em _text_noise-2="\text{noise-2">{\max}}{1 + \mathcal{B}</em>}}/B}\label{eq:Delta-L-sign-2}\end{equation<br />
å…¶ä¸­<br />
\begin{equation}\Delta\mathcal{L}<em _text_noise="\text{noise">{\max} = \frac{\beta</em>}}\eta_{\max}\sum_i|g_i|}{1 + \beta_{\text{noise}}^2},\quad \mathcal{B<em _text_noise="\text{noise">{\text{noise-2}} = \frac{\pi\kappa^2\beta</em>}}^2}{2(1 + \beta_{\text{noise}}^2)}\label{eq:beta-B-noise}\end{equation<br />
æ³¨æ„è¿™é‡Œ$\mathcal{B}<em _text_noise="\text{noise">{\text{noise-2}}$æ˜¯ä¸€ä¸ªæ–°çš„è®°å·ï¼Œå®ƒä¸æ˜¯$\mathcal{B}</em>$åè§£å‡ºæ¥çš„ç†è®ºæœ€ä¼˜Batch Sizeï¼Œç»“æœæ˜¯}}$ï¼Œåè€…æ˜¯ç”±$\beta=\beta_{\text{noise}<br />
\begin{equation}\mathcal{B}<em _text_noise="\text{noise">{\text{noise}} = \frac{\pi\kappa^2\beta</em>}}^2}{2(1 - \beta_{\text{noise}}^2)}\end{equation<br />
å®ƒä»¬ä¹‹é—´çš„å…³ç³»æ˜¯<br />
\begin{equation}\frac{1}{\mathcal{B}<em _text_noise="\text{noise">{\text{noise-2}}} - \frac{1}{\mathcal{B}</em>}}} = \frac{4}{\pi\kappa^2}\quad\Rightarrow\quad \mathcal{B<em _text_noise-2="\text{noise-2">{\text{noise}} = \left(\frac{1}{\mathcal{B}</em>}}} - \frac{4}{\pi\kappa^2}\right)^{-1}\label{eq:B-1-2}\end{equation<br />
ç”±äºå¼$\eqref{eq:Delta-L-sign-2}$å½¢å¼ä¸Šè·ŸSGDçš„å¼$\eqref{eq:Delta-L-sgd}$æ˜¯ä¸€æ ·çš„ï¼Œæ‰€ä»¥é‚£ä¸€èŠ‚çš„åˆ†æåŒæ ·é€‚ç”¨ï¼Œå› æ­¤åŒæ ·å¯ä»¥å¯¼å‡ºå¼$\eqref{eq:E-S}$ï¼š<br />
\begin{equation}\left(\frac{S}{S_{\min}} - 1\right)\left(\frac{E}{E_{\min}} - 1\right) = 1\end{equation}<br />
åªä¸è¿‡ç°åœ¨$E_{\min}/S_{\min} = \mathcal{B}<em _text_noise="\text{noise">{\text{noise-2}}$ã€‚è¿™æ ·ä¸€æ¥ï¼Œæˆ‘ä»¬å°±æœ‰å¾—åˆ°ä¸€ç§ä¼°è®¡$\beta</em>}}$å’Œ$\mathcal{B<em _min="\min">{\text{noise}}$çš„æ–¹æ¡ˆï¼šé€šè¿‡å¤šæ¬¡å®éªŒå¾—åˆ°å¤šä¸ª$(S,E)$å¯¹ï¼Œå®éªŒè¿‡ç¨‹ä¸­è¿˜å¯ä»¥é¡ºä¾¿ä¼°è®¡$\kappa^2$ï¼Œç„¶åæ‹Ÿåˆä¸Šå¼å¾—åˆ°$E</em>},S_{\min}$ï¼Œç»§è€Œä¼°è®¡$\mathcal{B<em _text_noise="\text{noise">{\text{noise-2}}$ï¼Œæœ€åç”±$\eqref{eq:beta-B-noise}$å¼è§£å‡º$\beta</em>$ã€‚}</p>
<p>å¦‚æœ$\beta_{\text{noise}} \geq 1$ï¼Œé‚£ä¹ˆä¸å­˜åœ¨æœ€ä¼˜çš„$\mathcal{B}<em _text_noise="\text{noise">{\text{noise}}$ï¼Œå¦‚æœ$\beta</em>$ï¼ŒBatch Sizeè¶…å‡ºè¿™ä¸ªå€¼å­¦ä¹ ç‡åè€Œåº”è¯¥ä¸‹é™ã€‚}} \gg 1$åˆ™è¯´æ˜HessiançŸ©é˜µå¯¹è§’çº¿å…ƒç´ å ä¸»å¯¼ï¼Œæ­¤æ—¶é€‚ç”¨äºç¼©æ”¾è§„å¾‹$\eqref{eq:eta-opt-sign-diag}$ï¼Œå¢å¤§Batch Sizeæ€»å¯ä»¥é€‚å½“å¢å¤§å­¦ä¹ ç‡ï¼›å½“$\beta_{\text{noise}} &lt; 1$æ—¶ï¼Œå¯ä»¥ç”±$\eqref{eq:B-1-2}$è§£å‡ºæœ€ä¼˜çš„$\mathcal{B}_{\text{noise}</p>
<h3 id="_13">è¡¥å……è¯´æ˜</h3>
<p>éœ€è¦æŒ‡å‡ºçš„æ˜¯ï¼Œä¸Šé¢å‡ èŠ‚åˆ†æçš„å‡ºå‘ç‚¹å’Œæœ€ç»ˆç»“è®ºï¼Œå…¶å®è·ŸåŸè®ºæ–‡<a href="https://papers.cool/arxiv/2405.14578">ã€ŠSurge Phenomenon in Optimal Learning Rate and Batch Size Scalingã€‹</a>å¤§åŒå°å¼‚ï¼Œä½†ä¸­é—´è¿‡ç¨‹çš„è¿‘ä¼¼å¤„ç†æœ‰æ‰€ä¸åŒã€‚</p>
<p>åŸè®ºæ–‡å¾—åˆ°çš„å¤§éƒ¨åˆ†ç»“è®ºï¼Œéƒ½æ˜¯åœ¨$B \ll \pi(\sigma_i/g_i)^2/2$å‡è®¾ä¸‹çš„è¿‘ä¼¼ç»“æœï¼Œæ‰€ä»¥å¾—åˆ°Surgeç°è±¡å‡ ä¹æ€»ä¼šå‡ºç°çš„ç»“è®ºï¼Œè¿™å…¶å®æ˜¯ä¸å¤§ç§‘å­¦çš„ã€‚æœ€æ˜æ˜¾çš„æ˜¯$B \ll \pi(\sigma_i/g_i)^2/2$è¿™ä¸ªå‡è®¾çš„å½¢å¼æœ¬èº«å°±æœ‰ç‚¹é—®é¢˜ï¼Œå®ƒå³ç«¯æ˜¯è·Ÿ$i$ç›¸å…³çš„ï¼Œæˆ‘ä»¬æ€»ä¸èƒ½ç»™æ¯ä¸ªåˆ†é‡éƒ½é…ä¸€ä¸ªå•ç‹¬çš„Batch Sizeï¼Œæ‰€ä»¥ä¸ºäº†å¾—åˆ°ä¸€ä¸ªå…¨å±€çš„ç»“æœå°±åªèƒ½æ˜¯$B \ll \min_i \pi(\sigma_i/g_i)^2/2$ï¼Œä½†è¿™æœªå…æœ‰ç‚¹è‹›åˆ»äº†ã€‚</p>
<p>æœ¬æ–‡çš„åšæ³•åˆ™æ˜¯å¼•å…¥è¿‘ä¼¼$\eqref{eq:mu-approx}$ï¼Œè¿™å¯ä»¥çœ‹æˆæ˜¯å¹³å‡åœºè¿‘ä¼¼ï¼Œç›´è§‰ä¸Šæ¯”é€ç‚¹çš„å‡è®¾$B \ll \pi(\sigma_i/g_i)^2/2$æ›´ä¸ºåˆç†ä¸€äº›ï¼Œæ‰€ä»¥åŸåˆ™ä¸Šç»“è®ºä¼šæ›´ä¸ºç²¾å‡†ï¼Œæ¯”å¦‚å¯ä»¥å¾—åˆ°â€œå³ä½¿HessiançŸ©é˜µçš„éå¯¹è§’çº¿å…ƒç´ ä¸å¯å¿½ç•¥ï¼ŒSurgeç°è±¡ä¹Ÿä¸ä¸€å®šä¼šå‡ºç°â€çš„ç»“è®ºï¼ˆå–å†³äº$\beta_{\text{noise}}$ï¼‰ã€‚ç‰¹åˆ«åœ°ï¼Œè¿™ç§ç²¾å‡†æ€§å¹¶æ²¡æœ‰ç‰ºç‰²ç®€æ´æ€§ï¼Œæ¯”å¦‚å¼$\eqref{eq:eta-opt-beta}$åŒæ ·å¾ˆç®€æ˜æ¸…æ™°ï¼Œå¼$\eqref{eq:Delta-L-sign-2}$å½¢å¼ä¹Ÿè·ŸåŸè®ºæ–‡ä¸€è‡´ï¼Œå¹¶ä¸”ä¸éœ€è¦é¢å¤–çš„è¿‘ä¼¼å‡è®¾ï¼Œç­‰ç­‰ã€‚</p>
<p>æœ€åï¼Œç¨å¾®æ„Ÿæ…¨ä¸€ä¸‹ï¼ŒOpenAIå¯¹SGDçš„åˆ†æå…¶å®å·²ç»æ˜¯2018å¹´çš„å·¥ä½œäº†ï¼Œè€ŒSurgeç°è±¡è¿™ç¯‡è®ºæ–‡åˆ™æ˜¯ä»Šå¹´ä¸­æ‰å‘å¸ƒçš„ï¼Œä»SGDåˆ°Adamå±…ç„¶èŠ±äº†6å¹´æ—¶é—´ï¼Œè¿™æ˜¯è®©äººæ¯”è¾ƒæ„å¤–çš„ï¼Œå¤§ä½“æ˜¯OpenAIçš„â€œå¨æœ›â€ä»¥åŠçŒœæµ‹$\eqref{eq:openai-adam}$ï¼Œè®©å¤§å®¶è§‰å¾—Adamå·²ç»æ²¡ä»€ä¹ˆå¥½åšäº†ï¼Œæ²¡æƒ³åˆ°Adamå¯èƒ½ä¼šæœ‰ä¸€äº›æ–°çš„ç‰¹æ€§ã€‚å½“ç„¶ï¼Œ$\tilde{\boldsymbol{\varphi}}_B = \sign(\tilde{\boldsymbol{g}}_B)$ä½œä¸ºAdamçš„è¿‘ä¼¼ç©¶ç«Ÿæœ‰å¤šåˆç†ã€èƒ½å¤šå¤§ç¨‹åº¦ä¸Šä»£è¡¨å®é™…æƒ…å†µç­‰é—®é¢˜ï¼Œç¬”è€…è®¤ä¸ºè¿˜å€¼å¾—è¿›ä¸€æ­¥æ€è€ƒã€‚</p>
<h2 id="_14">æ–‡ç« å°ç»“</h2>
<p>æœ¬æ–‡ä»å¤šä¸ªè§†è§’è®¨è®ºäº†â€œBatch Sizeä¸å­¦ä¹ ç‡ä¹‹é—´çš„Scaling Lawâ€è¿™ä¸€ç»å…¸ç‚¼ä¸¹é—®é¢˜ï¼Œå…¶ä¸­ç€é‡ä»‹ç»äº†OpenAIåŸºäºæŸå¤±å‡½æ•°çš„äºŒé˜¶è¿‘ä¼¼çš„æ¨å¯¼å’Œç»“è®ºï¼Œä»¥åŠåç»­åˆ©ç”¨åŒæ ·çš„æ€æƒ³æ¥åˆ†æAdamä¼˜åŒ–å™¨çš„å·¥ä½œã€‚</p>
<p><em><strong>è½¬è½½åˆ°è¯·åŒ…æ‹¬æœ¬æ–‡åœ°å€ï¼š</strong><a href="https://spaces.ac.cn/archives/10542">https://spaces.ac.cn/archives/10542</a></em></p>
<p><em><strong>æ›´è¯¦ç»†çš„è½¬è½½äº‹å®œè¯·å‚è€ƒï¼š</strong></em><a href="https://spaces.ac.cn/archives/6508#%E6%96%87%E7%AB%A0%E5%A6%82%E4%BD%95%E8%BD%AC%E8%BD%BD/%E5%BC%95%E7%94%A8" title="ã€Šç§‘å­¦ç©ºé—´FAQã€‹">ã€Šç§‘å­¦ç©ºé—´FAQã€‹</a></p>
<p><strong>å¦‚æœæ‚¨è¿˜æœ‰ä»€ä¹ˆç–‘æƒ‘æˆ–å»ºè®®ï¼Œæ¬¢è¿åœ¨ä¸‹æ–¹è¯„è®ºåŒºç»§ç»­è®¨è®ºã€‚</strong></p>
<p><strong>å¦‚æœæ‚¨è§‰å¾—æœ¬æ–‡è¿˜ä¸é”™ï¼Œæ¬¢è¿åˆ†äº«/æ‰“èµæœ¬æ–‡ã€‚æ‰“èµå¹¶éè¦ä»ä¸­è·å¾—æ”¶ç›Šï¼Œè€Œæ˜¯å¸Œæœ›çŸ¥é“ç§‘å­¦ç©ºé—´è·å¾—äº†å¤šå°‘è¯»è€…çš„çœŸå¿ƒå…³æ³¨ã€‚å½“ç„¶ï¼Œå¦‚æœä½ æ— è§†å®ƒï¼Œä¹Ÿä¸ä¼šå½±å“ä½ çš„é˜…è¯»ã€‚å†æ¬¡è¡¨ç¤ºæ¬¢è¿å’Œæ„Ÿè°¢ï¼</strong></p>
<p>æ‰“èµ</p>
<p><img alt="ç§‘å­¦ç©ºé—´" src="https://spaces.ac.cn/usr/themes/geekg/payment/wx.png" /></p>
<p>å¾®ä¿¡æ‰“èµ</p>
<p><img alt="ç§‘å­¦ç©ºé—´" src="https://spaces.ac.cn/usr/themes/geekg/payment/zfb.png" /></p>
<p>æ”¯ä»˜å®æ‰“èµ</p>
<p>å› ä¸ºç½‘ç«™åå°å¯¹æ‰“èµå¹¶æ— è®°å½•ï¼Œå› æ­¤æ¬¢è¿åœ¨æ‰“èµæ—¶å€™å¤‡æ³¨ç•™è¨€ã€‚ä½ è¿˜å¯ä»¥<a href="http://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&amp;email=tN7d1drY3drrx8H0xcWa19vZ"><strong>ç‚¹å‡»è¿™é‡Œ</strong></a>æˆ–åœ¨ä¸‹æ–¹è¯„è®ºåŒºç•™è¨€æ¥å‘ŠçŸ¥ä½ çš„å»ºè®®æˆ–éœ€æ±‚ã€‚</p>
<p><strong>å¦‚æœæ‚¨éœ€è¦å¼•ç”¨æœ¬æ–‡ï¼Œè¯·å‚è€ƒï¼š</strong></p>
<p>è‹å‰‘æ—. (Nov. 14, 2024). ã€Šå½“Batch Sizeå¢å¤§æ—¶ï¼Œå­¦ä¹ ç‡è¯¥å¦‚ä½•éšä¹‹å˜åŒ–ï¼Ÿ ã€‹[Blog post]. Retrieved from <a href="https://spaces.ac.cn/archives/10542">https://spaces.ac.cn/archives/10542</a></p>
<p>@online{kexuefm-10542,<br />
title={å½“Batch Sizeå¢å¤§æ—¶ï¼Œå­¦ä¹ ç‡è¯¥å¦‚ä½•éšä¹‹å˜åŒ–ï¼Ÿ},<br />
author={è‹å‰‘æ—},<br />
year={2024},<br />
month={Nov},<br />
url={\url{https://spaces.ac.cn/archives/10542}},<br />
} </p>
<hr />
<h2 id="_15">å…¬å¼æ¨å¯¼ä¸æ³¨é‡Š</h2>
<p>æœ¬èŠ‚æä¾›æå…¶è¯¦ç»†çš„æ•°å­¦æ¨å¯¼ï¼Œæ·±å…¥æ¢è®¨Batch Sizeä¸å­¦ä¹ ç‡ä¹‹é—´çš„Scaling Lawï¼Œæ¶µç›–ä»æ–¹å·®åˆ†æåˆ°å®é™…åº”ç”¨çš„å®Œæ•´ç†è®ºæ¡†æ¶ã€‚</p>
<h3 id="1">1. æ¢¯åº¦ä¼°è®¡çš„åŸºç¡€ç†è®º</h3>
<p><strong>æ¨å¯¼1ï¼šå•æ ·æœ¬æ¢¯åº¦çš„å®šä¹‰</strong></p>
<p>å‡è®¾æŸå¤±å‡½æ•°ä¸º $\mathcal{L}(\boldsymbol{w})$ï¼Œç¬¬ $i$ ä¸ªæ ·æœ¬çš„æŸå¤±ä¸º $\ell_i(\boldsymbol{w})$ï¼Œåˆ™ï¼š</p>
<p>$$
\mathcal{L}(\boldsymbol{w}) = \frac{1}{N}\sum_{i=1}^N \ell_i(\boldsymbol{w})
$$</p>
<p>å…¶ä¸­ $N$ æ˜¯æ€»æ ·æœ¬æ•°ã€‚çœŸå®æ¢¯åº¦ä¸ºï¼š</p>
<p>$$
\boldsymbol{g}(\boldsymbol{w}) = \nabla_{\boldsymbol{w}}\mathcal{L}(\boldsymbol{w}) = \frac{1}{N}\sum_{i=1}^N \nabla_{\boldsymbol{w}}\ell_i(\boldsymbol{w})
$$</p>
<p><strong>æ¨å¯¼2ï¼šéšæœºæ¢¯åº¦çš„æœŸæœ›å’Œæ–¹å·®</strong></p>
<p>å®šä¹‰å•ä¸ªæ ·æœ¬çš„éšæœºæ¢¯åº¦ $\tilde{\boldsymbol{g}}^{(i)} = \nabla_{\boldsymbol{w}}\ell_i(\boldsymbol{w})$ã€‚è‹¥æ ·æœ¬æ˜¯ä»æ€»ä½“ä¸­å‡åŒ€éšæœºæŠ½å–çš„ï¼Œåˆ™ï¼š</p>
<p>$$
\mathbb{E}[\tilde{\boldsymbol{g}}^{(i)}] = \boldsymbol{g}(\boldsymbol{w})
$$</p>
<p>å®šä¹‰æ¢¯åº¦çš„åæ–¹å·®çŸ©é˜µï¼š</p>
<p>$$
\boldsymbol{\Sigma} = \mathbb{E}[(\tilde{\boldsymbol{g}}^{(i)} - \boldsymbol{g})(\tilde{\boldsymbol{g}}^{(i)} - \boldsymbol{g})^T]
$$</p>
<p><strong>æ³¨é‡Š1</strong>ï¼šåæ–¹å·®çŸ©é˜µ $\boldsymbol{\Sigma}$ è¡¡é‡äº†å•ä¸ªæ ·æœ¬æ¢¯åº¦çš„ä¸ç¡®å®šæ€§ã€‚å¯¹è§’å…ƒç´  $\Sigma_{ii}$ è¡¨ç¤ºç¬¬ $i$ ä¸ªå‚æ•°çš„æ¢¯åº¦æ–¹å·®ã€‚</p>
<p><strong>æ¨å¯¼3ï¼šBatchæ¢¯åº¦çš„æœŸæœ›å’Œæ–¹å·®</strong></p>
<p>ä½¿ç”¨Batch Sizeä¸º $B$ çš„å°æ‰¹é‡ï¼Œæ¢¯åº¦ä¼°è®¡ä¸ºï¼š</p>
<p>$$
\tilde{\boldsymbol{g}}_B = \frac{1}{B}\sum_{i=1}^B \tilde{\boldsymbol{g}}^{(i)}
$$</p>
<p>ç”±äºæ ·æœ¬ç‹¬ç«‹åŒåˆ†å¸ƒï¼š</p>
<p>$$
\begin{aligned}
\mathbb{E}[\tilde{\boldsymbol{g}}_B] &= \mathbb{E}\left[\frac{1}{B}\sum_{i=1}^B \tilde{\boldsymbol{g}}^{(i)}\right] = \frac{1}{B}\sum_{i=1}^B \mathbb{E}[\tilde{\boldsymbol{g}}^{(i)}] = \boldsymbol{g} \\
\text{Cov}[\tilde{\boldsymbol{g}}_B] &= \text{Cov}\left[\frac{1}{B}\sum_{i=1}^B \tilde{\boldsymbol{g}}^{(i)}\right] = \frac{1}{B^2}\sum_{i=1}^B \text{Cov}[\tilde{\boldsymbol{g}}^{(i)}] = \frac{\boldsymbol{\Sigma}}{B}
\end{aligned}
$$</p>
<p><strong>æ³¨é‡Š2</strong>ï¼šè¿™ä¸ªå…³é”®ç»“æœè¡¨æ˜ï¼Œå¢å¤§Batch Sizeä½¿æ¢¯åº¦ä¼°è®¡çš„æ–¹å·®æŒ‰ $1/B$ ç¼©å°ã€‚</p>
<h3 id="2">2. å¹³æ–¹æ ¹ç¼©æ”¾è§„å¾‹çš„æ¨å¯¼</h3>
<p><strong>æ¨å¯¼4ï¼šSGDå¢é‡çš„æ–¹å·®åˆ†æ</strong></p>
<p>SGDçš„å‚æ•°æ›´æ–°ä¸ºï¼š</p>
<p>$$
\boldsymbol{w}_{t+1} = \boldsymbol{w}_t - \eta\tilde{\boldsymbol{g}}_B
$$</p>
<p>æ›´æ–°é‡çš„æœŸæœ›å’Œæ–¹å·®ä¸ºï¼š</p>
<p>$$
\begin{aligned}
\mathbb{E}[\Delta\boldsymbol{w}] &= -\eta\boldsymbol{g} \\
\text{Var}[\Delta\boldsymbol{w}] &= \eta^2\text{Var}[\tilde{\boldsymbol{g}}_B] = \frac{\eta^2\boldsymbol{\Sigma}}{B}
\end{aligned}
$$</p>
<p><strong>æ¨å¯¼5ï¼šç­‰æ–¹å·®åŸåˆ™</strong></p>
<p>å‡è®¾æˆ‘ä»¬å¸Œæœ›åœ¨æ”¹å˜Batch Sizeæ—¶ï¼Œä¿æŒæ›´æ–°é‡çš„æ–¹å·®ä¸å˜ï¼š</p>
<p>$$
\frac{\eta_1^2}{B_1} = \frac{\eta_2^2}{B_2}
$$</p>
<p>æ•´ç†å¾—ï¼š</p>
<p>$$
\frac{\eta_2}{\eta_1} = \sqrt{\frac{B_2}{B_1}}
$$</p>
<p><strong>æ³¨é‡Š3</strong>ï¼šè¿™å°±æ˜¯å¹³æ–¹æ ¹ç¼©æ”¾è§„å¾‹çš„ç†è®ºåŸºç¡€â€”â€”é€šè¿‡è°ƒæ•´å­¦ä¹ ç‡ï¼Œä¿æŒå‚æ•°æ›´æ–°çš„å™ªå£°å¼ºåº¦æ’å®šã€‚</p>
<p><strong>æ¨å¯¼6ï¼šä¿¡å™ªæ¯”åˆ†æ</strong></p>
<p>å®šä¹‰ä¿¡å™ªæ¯”ï¼ˆSNRï¼‰ï¼š</p>
<p>$$
\text{SNR} = \frac{\|\mathbb{E}[\Delta\boldsymbol{w}]\|}{\sqrt{\text{Tr}(\text{Var}[\Delta\boldsymbol{w}])}} = \frac{\eta\|\boldsymbol{g}\|}{\eta\sqrt{\text{Tr}(\boldsymbol{\Sigma})/B}} = \sqrt{B}\frac{\|\boldsymbol{g}\|}{\sqrt{\text{Tr}(\boldsymbol{\Sigma})}}
$$</p>
<p><strong>æ³¨é‡Š4</strong>ï¼šä¿¡å™ªæ¯”ä¸ $\sqrt{B}$ æˆæ­£æ¯”ã€‚å¦‚æœä¿æŒ $\eta$ ä¸å˜å¢å¤§ $B$ï¼ŒSNRä¼šå¢åŠ ï¼Œå¯èƒ½å¯¼è‡´è®­ç»ƒè¿‡äºç¡®å®šæ€§ï¼ŒæŸå¤±æ³›åŒ–èƒ½åŠ›ã€‚</p>
<h3 id="3-sde">3. çº¿æ€§ç¼©æ”¾è§„å¾‹çš„SDEæ¨å¯¼</h3>
<p><strong>æ¨å¯¼7ï¼šä»ç¦»æ•£åˆ°è¿ç»­</strong></p>
<p>å°†SGDè¿­ä»£æ”¹å†™ä¸ºï¼š</p>
<p>$$
\boldsymbol{w}_{t+1} - \boldsymbol{w}_t = -\eta\boldsymbol{g}_t - \eta(\tilde{\boldsymbol{g}}_{B,t} - \boldsymbol{g}_t)
$$</p>
<p>å‡è®¾æ¢¯åº¦å™ªå£°æœä»é«˜æ–¯åˆ†å¸ƒ $\tilde{\boldsymbol{g}}_{B,t} - \boldsymbol{g}_t \sim \mathcal{N}(\boldsymbol{0}, \boldsymbol{\Sigma}_t/B)$ã€‚</p>
<p><strong>æ¨å¯¼8ï¼šé‡å‚æ•°åŒ–æŠ€å·§</strong></p>
<p>åˆ©ç”¨é‡å‚æ•°åŒ–æŠ€å·§ï¼Œè®¾ $\boldsymbol{z}_t \sim \mathcal{N}(\boldsymbol{0}, \boldsymbol{I})$ï¼š</p>
<p>$$
\tilde{\boldsymbol{g}}_{B,t} - \boldsymbol{g}_t = \frac{1}{\sqrt{B}}\boldsymbol{\Sigma}_t^{1/2}\boldsymbol{z}_t
$$</p>
<p>å…¶ä¸­ $\boldsymbol{\Sigma}_t^{1/2}$ æ˜¯åæ–¹å·®çŸ©é˜µçš„å¹³æ–¹æ ¹ã€‚ä»£å…¥æ›´æ–°å…¬å¼ï¼š</p>
<p>$$
\boldsymbol{w}_{t+1} = \boldsymbol{w}_t - \eta\boldsymbol{g}_t - \frac{\eta}{\sqrt{B}}\boldsymbol{\Sigma}_t^{1/2}\boldsymbol{z}_t
$$</p>
<p><strong>æ¨å¯¼9ï¼šåˆ†ç¦»å­¦ä¹ ç‡çš„å¹‚æ¬¡</strong></p>
<p>å…³é”®æ­¥éª¤ï¼šå°† $\eta$ é‡å†™ä¸º $\sqrt{\eta}\cdot\sqrt{\eta}$ï¼š</p>
<p>$$
\boldsymbol{w}_{t+1} = \boldsymbol{w}_t - \eta\boldsymbol{g}_t - \sqrt{\eta}\cdot\frac{\sqrt{\eta}}{\sqrt{B}}\boldsymbol{\Sigma}_t^{1/2}\boldsymbol{z}_t
$$</p>
<p><strong>æ¨å¯¼10ï¼šè¿ç»­æé™ï¼ˆSDEï¼‰</strong></p>
<p>å½“ $\eta \to 0$ æ—¶ï¼Œç¦»æ•£è¿­ä»£è¶‹å‘äºéšæœºå¾®åˆ†æ–¹ç¨‹ï¼š</p>
<p>$$
d\boldsymbol{w}_t = -\boldsymbol{g}_t dt - \sqrt{\frac{\eta}{B}}\boldsymbol{\Sigma}_t^{1/2}d\boldsymbol{W}_t
$$</p>
<p>å…¶ä¸­ $d\boldsymbol{W}_t$ æ˜¯Wienerè¿‡ç¨‹ï¼ˆå¸ƒæœ—è¿åŠ¨ï¼‰ï¼Œæ»¡è¶³ $d\boldsymbol{W}_t \sim \mathcal{N}(\boldsymbol{0}, dt\boldsymbol{I})$ã€‚</p>
<p><strong>æ³¨é‡Š5</strong>ï¼šSDEçš„å™ªå£°é¡¹ç³»æ•°æ˜¯ $\sqrt{\eta/B}$ è€Œé $\eta/B$ï¼Œè¿™æ˜¯å› ä¸ºå¸ƒæœ—è¿åŠ¨çš„æ–¹å·®ä¸æ—¶é—´æˆæ­£æ¯”ã€‚</p>
<p><strong>æ¨å¯¼11ï¼šä¸å˜æ€§æ¡ä»¶</strong></p>
<p>è¦ä½¿SDEåœ¨æ”¹å˜ $B$ æ—¶ä¿æŒä¸å˜ï¼Œéœ€è¦ï¼š</p>
<p>$$
\frac{\eta_1}{B_1} = \frac{\eta_2}{B_2}
$$</p>
<p>å› æ­¤ï¼š</p>
<p>$$
\frac{\eta_2}{\eta_1} = \frac{B_2}{B_1}
$$</p>
<p><strong>æ³¨é‡Š6</strong>ï¼šè¿™å°±æ˜¯çº¿æ€§ç¼©æ”¾è§„å¾‹ï¼ä¸å¹³æ–¹æ ¹ç¼©æ”¾çš„åŒºåˆ«åœ¨äºï¼ŒSDEè€ƒè™‘äº†å™ªå£°ç´¯ç§¯çš„é•¿æœŸæ•ˆåº”ã€‚</p>
<h3 id="4">4. æŸå¤±å‡½æ•°çš„äºŒé˜¶è¿‘ä¼¼åˆ†æ</h3>
<p><strong>æ¨å¯¼12ï¼šæ³°å‹’å±•å¼€</strong></p>
<p>è®¾å½“å‰å‚æ•°ä¸º $\boldsymbol{w}$ï¼Œæ›´æ–°åä¸º $\boldsymbol{w}' = \boldsymbol{w} - \eta\tilde{\boldsymbol{g}}_B$ã€‚æŸå¤±å‡½æ•°çš„äºŒé˜¶æ³°å‹’å±•å¼€ï¼š</p>
<p>$$
\mathcal{L}(\boldsymbol{w}') = \mathcal{L}(\boldsymbol{w}) + \nabla\mathcal{L}(\boldsymbol{w})^T(\boldsymbol{w}'-\boldsymbol{w}) + \frac{1}{2}(\boldsymbol{w}'-\boldsymbol{w})^T\boldsymbol{H}(\boldsymbol{w}'-\boldsymbol{w}) + O(\|\boldsymbol{w}'-\boldsymbol{w}\|^3)
$$</p>
<p>å…¶ä¸­ $\boldsymbol{H} = \nabla^2\mathcal{L}(\boldsymbol{w})$ æ˜¯HessiançŸ©é˜µã€‚</p>
<p><strong>æ¨å¯¼13ï¼šä»£å…¥æ›´æ–°å…¬å¼</strong></p>
<p>$$
\begin{aligned}
\mathcal{L}(\boldsymbol{w}') &= \mathcal{L}(\boldsymbol{w}) + \boldsymbol{g}^T(-\eta\tilde{\boldsymbol{g}}_B) + \frac{1}{2}(-\eta\tilde{\boldsymbol{g}}_B)^T\boldsymbol{H}(-\eta\tilde{\boldsymbol{g}}_B) \\
&= \mathcal{L}(\boldsymbol{w}) - \eta\boldsymbol{g}^T\tilde{\boldsymbol{g}}_B + \frac{\eta^2}{2}\tilde{\boldsymbol{g}}_B^T\boldsymbol{H}\tilde{\boldsymbol{g}}_B
\end{aligned}
$$</p>
<p><strong>æ¨å¯¼14ï¼šå–æœŸæœ›</strong></p>
<p>$$
\mathbb{E}[\mathcal{L}(\boldsymbol{w}')] = \mathcal{L}(\boldsymbol{w}) - \eta\boldsymbol{g}^T\mathbb{E}[\tilde{\boldsymbol{g}}_B] + \frac{\eta^2}{2}\mathbb{E}[\tilde{\boldsymbol{g}}_B^T\boldsymbol{H}\tilde{\boldsymbol{g}}_B]
$$</p>
<p><strong>æ¨å¯¼15ï¼šäºŒé˜¶çŸ©çš„å±•å¼€</strong></p>
<p>åˆ©ç”¨ $\mathbb{E}[\tilde{\boldsymbol{g}}_B] = \boldsymbol{g}$ å’Œ $\mathbb{E}[\tilde{\boldsymbol{g}}_B\tilde{\boldsymbol{g}}_B^T] = \boldsymbol{g}\boldsymbol{g}^T + \boldsymbol{\Sigma}/B$ï¼š</p>
<p>$$
\begin{aligned}
\mathbb{E}[\tilde{\boldsymbol{g}}_B^T\boldsymbol{H}\tilde{\boldsymbol{g}}_B] &= \mathbb{E}[\text{Tr}(\tilde{\boldsymbol{g}}_B^T\boldsymbol{H}\tilde{\boldsymbol{g}}_B)] = \text{Tr}(\boldsymbol{H}\mathbb{E}[\tilde{\boldsymbol{g}}_B\tilde{\boldsymbol{g}}_B^T]) \\
&= \text{Tr}(\boldsymbol{H}(\boldsymbol{g}\boldsymbol{g}^T + \boldsymbol{\Sigma}/B)) \\
&= \boldsymbol{g}^T\boldsymbol{H}\boldsymbol{g} + \frac{1}{B}\text{Tr}(\boldsymbol{H}\boldsymbol{\Sigma})
\end{aligned}
$$</p>
<p><strong>æ¨å¯¼16ï¼šæœ€ç»ˆçš„æœŸæœ›æŸå¤±</strong></p>
<p>$$
\mathbb{E}[\mathcal{L}(\boldsymbol{w}')] = \mathcal{L}(\boldsymbol{w}) - \eta\|\boldsymbol{g}\|^2 + \frac{\eta^2}{2}\left(\boldsymbol{g}^T\boldsymbol{H}\boldsymbol{g} + \frac{1}{B}\text{Tr}(\boldsymbol{H}\boldsymbol{\Sigma})\right)
$$</p>
<p><strong>æ³¨é‡Š7</strong>ï¼šç¬¬ä¸€é¡¹æ˜¯æŸå¤±å‡å°‘ï¼ˆæˆ‘ä»¬å¸Œæœ›æœ€å¤§åŒ–ï¼‰ï¼Œç¬¬äºŒé¡¹æ˜¯äºŒé˜¶ä¿®æ­£ï¼ˆé€šå¸¸ä¸ºæ­£ï¼Œé™åˆ¶äº†å­¦ä¹ ç‡ï¼‰ã€‚</p>
<h3 id="5">5. æœ€ä¼˜å­¦ä¹ ç‡çš„ç²¾ç¡®æ¨å¯¼</h3>
<p><strong>æ¨å¯¼17ï¼šä¸€é˜¶æœ€ä¼˜æ€§æ¡ä»¶</strong></p>
<p>å¯¹ $\eta$ æ±‚å¯¼å¹¶ä»¤å…¶ä¸ºé›¶ï¼š</p>
<p>$$
\frac{d}{d\eta}\mathbb{E}[\mathcal{L}(\boldsymbol{w}')] = -\|\boldsymbol{g}\|^2 + \eta\left(\boldsymbol{g}^T\boldsymbol{H}\boldsymbol{g} + \frac{1}{B}\text{Tr}(\boldsymbol{H}\boldsymbol{\Sigma})\right) = 0
$$</p>
<p>è§£å¾—æœ€ä¼˜å­¦ä¹ ç‡ï¼š</p>
<p>$$
\eta^* = \frac{\|\boldsymbol{g}\|^2}{\boldsymbol{g}^T\boldsymbol{H}\boldsymbol{g} + \frac{1}{B}\text{Tr}(\boldsymbol{H}\boldsymbol{\Sigma})}
$$</p>
<p><strong>æ¨å¯¼18ï¼šå¼•å…¥å™ªå£°æ‰¹é‡å¤§å°</strong></p>
<p>å®šä¹‰ä¸¤ä¸ªå…³é”®é‡ï¼š</p>
<p>$$
\begin{aligned}
\eta_{\max} &= \frac{\|\boldsymbol{g}\|^2}{\boldsymbol{g}^T\boldsymbol{H}\boldsymbol{g}} \\
\mathcal{B}_{\text{noise}} &= \frac{\text{Tr}(\boldsymbol{H}\boldsymbol{\Sigma})}{\boldsymbol{g}^T\boldsymbol{H}\boldsymbol{g}}
\end{aligned}
$$</p>
<p><strong>æ³¨é‡Š8</strong>ï¼š$\eta_{\max}$ æ˜¯å…¨é‡æ¢¯åº¦ä¸‹é™ï¼ˆ$B\to\infty$ï¼‰çš„æœ€ä¼˜å­¦ä¹ ç‡ï¼›$\mathcal{B}_{\text{noise}}$ æ˜¯ä¸€ä¸ªç‰¹å¾Batch Sizeã€‚</p>
<p><strong>æ¨å¯¼19ï¼šç»Ÿä¸€å½¢å¼</strong></p>
<p>å°†æœ€ä¼˜å­¦ä¹ ç‡é‡å†™ä¸ºï¼š</p>
<p>$$
\eta^* = \frac{\eta_{\max}}{1 + \mathcal{B}_{\text{noise}}/B}
$$</p>
<p><strong>æ¨å¯¼20ï¼šå°Batchæé™</strong></p>
<p>å½“ $B \ll \mathcal{B}_{\text{noise}}$ æ—¶ï¼š</p>
<p>$$
\eta^* \approx \frac{\eta_{\max}B}{\mathcal{B}_{\text{noise}}} \propto B
$$</p>
<p>è¿™å°±æ˜¯çº¿æ€§ç¼©æ”¾è§„å¾‹çš„é€‚ç”¨èŒƒå›´ã€‚</p>
<p><strong>æ¨å¯¼21ï¼šå¤§Batchæé™</strong></p>
<p>å½“ $B \gg \mathcal{B}_{\text{noise}}$ æ—¶ï¼š</p>
<p>$$
\eta^* \approx \eta_{\max}
$$</p>
<p>æ­¤æ—¶å­¦ä¹ ç‡è¶‹äºé¥±å’Œï¼Œç»§ç»­å¢å¤§Batch Sizeä¸èƒ½å†æé«˜å­¦ä¹ ç‡ã€‚</p>
<h3 id="6">6. å™ªå£°å°ºåº¦ç†è®º</h3>
<p><strong>æ¨å¯¼22ï¼šå™ªå£°å¯¹è®­ç»ƒçš„å½±å“</strong></p>
<p>å®šä¹‰å™ªå£°å°ºåº¦ï¼ˆnoise scaleï¼‰ï¼š</p>
<p>$$
g_{\text{noise}} = \frac{\eta}{B}\text{Tr}(\boldsymbol{H}\boldsymbol{\Sigma})
$$</p>
<p>è¿™ä¸ªé‡è¡¡é‡äº†å™ªå£°å¯¹æŸå¤±å‡½æ•°æ›²ç‡çš„å½±å“ã€‚</p>
<p><strong>æ¨å¯¼23ï¼šç®€åŒ–å‡è®¾ä¸‹çš„å™ªå£°å°ºåº¦</strong></p>
<p>å‡è®¾ $\boldsymbol{H} \approx \lambda\boldsymbol{I}$ï¼ˆå„å‘åŒæ€§è¿‘ä¼¼ï¼‰ï¼Œåˆ™ï¼š</p>
<p>$$
g_{\text{noise}} = \frac{\eta\lambda}{B}\text{Tr}(\boldsymbol{\Sigma}) = \frac{\eta\lambda}{B}\sum_i \sigma_i^2
$$</p>
<p><strong>æ¨å¯¼24ï¼šç®€åŒ–çš„å™ªå£°æ‰¹é‡å¤§å°</strong></p>
<p>å®šä¹‰ç®€åŒ–ç‰ˆæœ¬ï¼š</p>
<p>$$
\mathcal{B}_{\text{simple}} = \frac{\text{Tr}(\boldsymbol{\Sigma})}{\|\boldsymbol{g}\|^2}
$$</p>
<p>ä¸å®Œæ•´ç‰ˆçš„å…³ç³»ï¼š</p>
<p>$$
\mathcal{B}_{\text{noise}} = \frac{\text{Tr}(\boldsymbol{H}\boldsymbol{\Sigma})}{\boldsymbol{g}^T\boldsymbol{H}\boldsymbol{g}} \approx \mathcal{B}_{\text{simple}}
$$</p>
<p>å½“HessiançŸ©é˜µæ¥è¿‘å„å‘åŒæ€§æ—¶æˆç«‹ã€‚</p>
<p><strong>æ³¨é‡Š9</strong>ï¼š$\mathcal{B}_{\text{simple}}$ çš„ä¼˜åŠ¿æ˜¯åªéœ€è¦è®¡ç®—æ¢¯åº¦çš„æ–¹å·®ï¼Œä¸éœ€è¦HessiançŸ©é˜µã€‚</p>
<h3 id="7">7. æœ‰æ•ˆæ‰¹é‡å¤§å°çš„æ¦‚å¿µ</h3>
<p><strong>æ¨å¯¼25ï¼šè®­ç»ƒæ­¥æ•°ä¸æ ·æœ¬æ•°çš„å…³ç³»</strong></p>
<p>è®¾å®Œæˆè®­ç»ƒéœ€è¦ $S$ æ­¥ï¼Œæ¯æ­¥ä½¿ç”¨ $B$ ä¸ªæ ·æœ¬ï¼Œåˆ™æ€»æ ·æœ¬æ•°ï¼š</p>
<p>$$
E = B \cdot S
$$</p>
<p><strong>æ¨å¯¼26ï¼šæŸå¤±ä¸‹é™é€Ÿç‡</strong></p>
<p>æ¯æ­¥çš„æœŸæœ›æŸå¤±ä¸‹é™ï¼š</p>
<p>$$
\Delta\mathcal{L} = \mathcal{L}(\boldsymbol{w}) - \mathbb{E}[\mathcal{L}(\boldsymbol{w}')] = \eta\|\boldsymbol{g}\|^2 - \frac{\eta^2}{2}\left(\boldsymbol{g}^T\boldsymbol{H}\boldsymbol{g} + \frac{1}{B}\text{Tr}(\boldsymbol{H}\boldsymbol{\Sigma})\right)
$$</p>
<p>åœ¨æœ€ä¼˜å­¦ä¹ ç‡ä¸‹ï¼š</p>
<p>$$
\Delta\mathcal{L}^* = \frac{(\|\boldsymbol{g}\|^2)^2}{2(\boldsymbol{g}^T\boldsymbol{H}\boldsymbol{g} + \frac{1}{B}\text{Tr}(\boldsymbol{H}\boldsymbol{\Sigma}))} = \frac{\Delta\mathcal{L}_{\max}}{1 + \mathcal{B}_{\text{noise}}/B}
$$</p>
<p>å…¶ä¸­ $\Delta\mathcal{L}_{\max} = \frac{(|\boldsymbol{g}|^2)^2}{2\boldsymbol{g}^T\boldsymbol{H}\boldsymbol{g}}$ã€‚</p>
<p><strong>æ¨å¯¼27ï¼šè¾¾åˆ°ç›®æ ‡çš„æœ€å°‘æ­¥æ•°</strong></p>
<p>å½“ $B\to\infty$ï¼ˆå…¨é‡æ¢¯åº¦ï¼‰æ—¶ï¼Œæ¯æ­¥ä¸‹é™æœ€å¤§ï¼Œéœ€è¦æœ€å°‘æ­¥æ•° $S_{\min}$ã€‚æœ‰é™ $B$ æ—¶éœ€è¦ $S$ æ­¥ï¼Œæ»¡è¶³ï¼š</p>
<p>$$
S \cdot \Delta\mathcal{L}^* = S_{\min} \cdot \Delta\mathcal{L}_{\max}
$$</p>
<p>å› æ­¤ï¼š</p>
<p>$$
S = S_{\min}(1 + \mathcal{B}_{\text{noise}}/B)
$$</p>
<p><strong>æ¨å¯¼28ï¼šæ€»æ ·æœ¬æ•°</strong></p>
<p>$$
E = BS = S_{\min}(B + \mathcal{B}_{\text{noise}})
$$</p>
<p>å½“ $B \to 0$ æ—¶ï¼Œ$E_{\min} = S_{\min}\mathcal{B}_{\text{noise}}$ã€‚</p>
<p><strong>æ¨å¯¼29ï¼šæ•°æ®æ•ˆç‡ä¸è®¡ç®—æ•ˆç‡çš„æƒè¡¡</strong></p>
<p>å®šä¹‰å½’ä¸€åŒ–é‡ï¼š</p>
<p>$$
\tilde{S} = \frac{S}{S_{\min}}, \quad \tilde{E} = \frac{E}{E_{\min}}
$$</p>
<p>åˆ™ï¼š</p>
<p>$$
(\tilde{S} - 1)(\tilde{E} - 1) = 1
$$</p>
<p><strong>æ³¨é‡Š10</strong>ï¼šè¿™ä¸ªåŒæ›²çº¿å…³ç³»è¡¨æ˜ï¼Œæ•°æ®æ•ˆç‡å’Œè®¡ç®—æ•ˆç‡ä¸å¯å…¼å¾—â€”â€”è¦å‡å°‘æ€»æ ·æœ¬æ•°å°±è¦å¢åŠ è®­ç»ƒæ­¥æ•°ã€‚</p>
<h3 id="8">8. æ³›åŒ–å·®è·çš„ç†è®ºåˆ†æ</h3>
<p><strong>æ¨å¯¼30ï¼šå¤§Batchçš„æ³›åŒ–é—®é¢˜</strong></p>
<p>å®šä¹‰è®­ç»ƒæŸå¤±å’Œæµ‹è¯•æŸå¤±çš„å·®è·ï¼š</p>
<p>$$
\text{Gap} = \mathcal{L}_{\text{test}} - \mathcal{L}_{\text{train}}
$$</p>
<p><strong>æ¨å¯¼31ï¼šå™ªå£°æ­£åˆ™åŒ–æ•ˆåº”</strong></p>
<p>SGDçš„å™ªå£°å¯ä»¥çœ‹ä½œéšå¼æ­£åˆ™åŒ–ã€‚å™ªå£°åæ–¹å·®çŸ©é˜µï¼š</p>
<p>$$
\boldsymbol{C}_{\text{noise}} = \frac{\eta^2\boldsymbol{\Sigma}}{B}
$$</p>
<p>å™ªå£°å¼ºåº¦ï¼š</p>
<p>$$
\|\boldsymbol{C}_{\text{noise}}\|_F = \frac{\eta^2}{B}\|\boldsymbol{\Sigma}\|_F
$$</p>
<p><strong>æ¨å¯¼32ï¼šå¹³å¦æœ€å°å€¼å‡è¯´</strong></p>
<p>å¤§å™ªå£°å€¾å‘äºæ‰¾åˆ°å¹³å¦ï¼ˆHessianç‰¹å¾å€¼å°ï¼‰çš„æœ€å°å€¼ï¼Œè€Œå¹³å¦æœ€å°å€¼é€šå¸¸æ³›åŒ–æ€§èƒ½æ›´å¥½ã€‚ç”¨Hessiançš„è¿¹è¡¡é‡"å°–é”åº¦"ï¼š</p>
<p>$$
\text{Sharpness} = \text{Tr}(\boldsymbol{H})
$$</p>
<p>å™ªå£°å¸®åŠ©é€ƒç¦»é«˜sharpnessåŒºåŸŸã€‚</p>
<p><strong>æ¨å¯¼33ï¼šSDEä¸­çš„æœ‰æ•ˆæ¸©åº¦</strong></p>
<p>åœ¨SDEæ¡†æ¶ä¸‹ï¼Œå¯ä»¥å®šä¹‰"æ¸©åº¦"ï¼š</p>
<p>$$
T_{\text{eff}} = \frac{\eta}{B}
$$</p>
<p>é«˜æ¸©ï¼ˆå¤§ $\eta/B$ï¼‰å¯¼è‡´æ›´å¹¿æ³›çš„æ¢ç´¢ï¼Œå¯èƒ½æ”¹å–„æ³›åŒ–ã€‚</p>
<h3 id="9">9. é¢„çƒ­æœºåˆ¶çš„æ•°å­¦åŸç†</h3>
<p><strong>æ¨å¯¼34ï¼šåˆå§‹é˜¶æ®µçš„ä¸ç¨³å®šæ€§</strong></p>
<p>è®­ç»ƒå¼€å§‹æ—¶ï¼Œæ¢¯åº¦é€šå¸¸å¾ˆå¤§ä¸”ä¸ç¨³å®šã€‚å¦‚æœç«‹å³ä½¿ç”¨å¤§å­¦ä¹ ç‡ï¼š</p>
<p>$$
\|\boldsymbol{w}_1 - \boldsymbol{w}_0\| = \eta\|\tilde{\boldsymbol{g}}_0\|
$$</p>
<p>å¯èƒ½éå¸¸å¤§ï¼Œè¶…å‡ºäºŒé˜¶è¿‘ä¼¼çš„æœ‰æ•ˆèŒƒå›´ã€‚</p>
<p><strong>æ¨å¯¼35ï¼šçº¿æ€§é¢„çƒ­ç­–ç•¥</strong></p>
<p>å®šä¹‰é¢„çƒ­æ­¥æ•° $T_{\text{warmup}}$ï¼Œåœ¨å‰ $T_{\text{warmup}}$ æ­¥å†…å­¦ä¹ ç‡çº¿æ€§å¢é•¿ï¼š</p>
<p>$$
\eta_t = \frac{t}{T_{\text{warmup}}}\eta_{\text{target}}, \quad t \leq T_{\text{warmup}}
$$</p>
<p><strong>æ¨å¯¼36ï¼šé¢„çƒ­çš„ç¨³å®šæ€§åˆ†æ</strong></p>
<p>å°å­¦ä¹ ç‡é˜¶æ®µçš„æ›´æ–°ï¼š</p>
<p>$$
\boldsymbol{w}_t = \boldsymbol{w}_0 - \sum_{s=0}^{t-1}\frac{s}{T_{\text{warmup}}}\eta_{\text{target}}\tilde{\boldsymbol{g}}_s
$$</p>
<p>æ€»ä½ç§»ï¼š</p>
<p>$$
\|\boldsymbol{w}_t - \boldsymbol{w}_0\| \lesssim \frac{t^2}{2T_{\text{warmup}}}\eta_{\text{target}}\mathbb{E}[\|\tilde{\boldsymbol{g}}\|]
$$</p>
<p>å¢é•¿æ˜¯äºŒæ¬¡çš„è€Œéçº¿æ€§çš„ï¼Œæ›´åŠ å¹³ç¨³ã€‚</p>
<p><strong>æ¨å¯¼37ï¼šæœ€ä¼˜é¢„çƒ­æ­¥æ•°</strong></p>
<p>ä¸€ç§å¯å‘å¼é€‰æ‹©ï¼šè®©é¢„çƒ­æœŸé—´çš„æ€»ä½ç§»ä¸ä¸€æ­¥å¤§å­¦ä¹ ç‡æ›´æ–°çš„ä½ç§»ç›¸å½“ï¼š</p>
<p>$$
\frac{T_{\text{warmup}}^2}{2T_{\text{warmup}}}\eta_{\text{target}}\|\boldsymbol{g}\| \approx \eta_{\text{target}}\|\boldsymbol{g}\|
$$</p>
<p>è§£å¾— $T_{\text{warmup}} \approx 2$ï¼Œä½†å®è·µä¸­é€šå¸¸å–å‡ ç™¾åˆ°å‡ åƒæ­¥ã€‚</p>
<h3 id="10-adambatch-size">10. Adamä¼˜åŒ–å™¨çš„Batch Sizeç¼©æ”¾</h3>
<p><strong>æ¨å¯¼38ï¼šAdamçš„æ›´æ–°æ–¹å‘</strong></p>
<p>Adamçš„æ›´æ–°å¯ä»¥å†™ä¸ºï¼š</p>
<p>$$
\boldsymbol{w}_{t+1} = \boldsymbol{w}_t - \eta\boldsymbol{\varphi}_t, \quad \boldsymbol{\varphi}_t = \frac{\hat{\boldsymbol{m}}_t}{\sqrt{\hat{\boldsymbol{v}}_t}+\epsilon}
$$</p>
<p><strong>æ¨å¯¼39ï¼šç¬¦å·æ¢¯åº¦è¿‘ä¼¼</strong></p>
<p>åœ¨ $\epsilon$ è¾ƒå°æ—¶ï¼ŒAdamè¿‘ä¼¼äºç¬¦å·æ¢¯åº¦ï¼š</p>
<p>$$
\varphi_{t,i} \approx \text{sign}(m_{t,i})
$$</p>
<p><strong>æ¨å¯¼40ï¼šç¬¦å·æ¢¯åº¦çš„æœŸæœ›ï¼ˆå›é¡¾ï¼‰</strong></p>
<p>$$
\mathbb{E}[\text{sign}(\tilde{g}_B)] = \text{erf}\left(\frac{g}{\sigma}\sqrt{\frac{B}{2}}\right)
$$</p>
<p><strong>æ¨å¯¼41ï¼šAdamçš„å¹³æ–¹æ ¹ç¼©æ”¾</strong></p>
<p>å¯¹äºAdamï¼Œæœ€ä¼˜å­¦ä¹ ç‡çš„å½¢å¼ä¸ºï¼š</p>
<p>$$
\eta^*_{\text{Adam}} \approx \frac{\eta_{\max,\text{Adam}}}{(1 + \mathcal{B}_{\text{noise}}/B)^{\alpha}}
$$</p>
<p>å…¶ä¸­ $0.5 &lt; \alpha &lt; 1$ã€‚OpenAIçš„ç»éªŒå»ºè®® $\alpha \approx 0.5$ï¼Œå³å¹³æ–¹æ ¹ç¼©æ”¾ï¼š</p>
<p>$$
\eta^*_{\text{Adam}} \propto \sqrt{B} \quad \text{when } B \ll \mathcal{B}_{\text{noise}}
$$</p>
<p><strong>æ¨å¯¼42ï¼šAdamä¸SGDçš„å¯¹æ¯”</strong></p>
<ul>
<li>SGDï¼š$\eta \propto B$ï¼ˆçº¿æ€§ï¼‰</li>
<li>Adamï¼š$\eta \propto \sqrt{B}$ï¼ˆå¹³æ–¹æ ¹ï¼‰</li>
</ul>
<p>åŸå› æ˜¯Adamçš„è‡ªé€‚åº”ç¼©æ”¾æ”¹å˜äº†å™ªå£°çš„ç´¯ç§¯æ–¹å¼ã€‚</p>
<h3 id="11">11. å®é™…è®­ç»ƒçš„å¤æ‚æ€§</h3>
<p><strong>æ¨å¯¼43ï¼šåŠ¨æ€çš„Batch Sizeè°ƒæ•´</strong></p>
<p>åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œ$\mathcal{B}_{\text{noise}}$ æ˜¯åŠ¨æ€å˜åŒ–çš„ï¼š</p>
<p>$$
\mathcal{B}_{\text{noise}}(t) = \frac{\text{Tr}(\boldsymbol{H}_t\boldsymbol{\Sigma}_t)}{\boldsymbol{g}_t^T\boldsymbol{H}_t\boldsymbol{g}_t}
$$</p>
<p>é€šå¸¸åœ¨è®­ç»ƒåæœŸï¼Œ$|\boldsymbol{g}<em _text_noise="\text{noise">t|$ å‡å°ï¼Œ$\mathcal{B}</em>(t)$ å¯èƒ½å¢å¤§ã€‚}</p>
<p><strong>æ¨å¯¼44ï¼šè‡ªé€‚åº”Batch Sizeç­–ç•¥</strong></p>
<p>ç†æƒ³æƒ…å†µä¸‹ï¼Œå¯ä»¥æ ¹æ®ä¼°è®¡çš„ $\mathcal{B}_{\text{noise}}(t)$ åŠ¨æ€è°ƒæ•´ $B(t)$ï¼š</p>
<p>$$
B(t) = \min\left(B_{\max}, \alpha \mathcal{B}_{\text{noise}}(t)\right)
$$</p>
<p>å…¶ä¸­ $\alpha$ æ˜¯ä¸€ä¸ªå¸¸æ•°ï¼ˆå¦‚0.1-1ï¼‰ã€‚</p>
<h3 id="12">12. åˆ†å¸ƒå¼è®­ç»ƒçš„é€šä¿¡å¼€é”€</h3>
<p><strong>æ¨å¯¼45ï¼šåŒæ­¥æ—¶é—´æ¨¡å‹</strong></p>
<p>åœ¨æ•°æ®å¹¶è¡Œè®­ç»ƒä¸­ï¼Œæ¯æ­¥çš„æ—¶é—´åŒ…æ‹¬ï¼š</p>
<p>$$
T_{\text{step}} = T_{\text{compute}} + T_{\text{comm}}
$$</p>
<p>è®¡ç®—æ—¶é—´ä¸Batch Sizeæ— å…³ï¼ˆå‡è®¾æ¯ä¸ªworkerçš„local batchå›ºå®šï¼‰ï¼š</p>
<p>$$
T_{\text{compute}} = c_1
$$</p>
<p>é€šä¿¡æ—¶é—´ï¼ˆAll-Reduceï¼‰ä¾èµ–äºæ¨¡å‹å¤§å° $P$ å’Œworkeræ•°é‡ $W$ï¼š</p>
<p>$$
T_{\text{comm}} = c_2 P \log W
$$</p>
<p><strong>æ¨å¯¼46ï¼šæ€»è®­ç»ƒæ—¶é—´</strong></p>
<p>æ€»æ—¶é—´ï¼š</p>
<p>$$
T_{\text{total}} = S(B) \cdot (T_{\text{compute}} + T_{\text{comm}})
$$</p>
<p>å…¶ä¸­ $S(B) = S_{\min}(1 + \mathcal{B}_{\text{noise}}/B)$ã€‚</p>
<p><strong>æ¨å¯¼47ï¼šæœ€ä¼˜Batch Sizeï¼ˆè€ƒè™‘é€šä¿¡ï¼‰</strong></p>
<p>æœ€å°åŒ–æ€»æ—¶é—´ä¸å†ç­‰ä»·äºæœ€å¤§åŒ–Batch Sizeã€‚å®šä¹‰æ•ˆç‡ï¼š</p>
<p>$$
\text{Efficiency} = \frac{T_{\text{compute}}}{T_{\text{compute}} + T_{\text{comm}}}
$$</p>
<p>å½“æ•ˆç‡ä½äºæŸä¸ªé˜ˆå€¼ï¼ˆå¦‚0.9ï¼‰æ—¶ï¼Œå¢å¤§Batch Sizeçš„æ”¶ç›Šæœ‰é™ã€‚</p>
<h3 id="13-batch-size">13. ä¸´ç•ŒBatch Sizeçš„ä¼°è®¡</h3>
<p><strong>æ¨å¯¼48ï¼šå®éªŒæ‹Ÿåˆæ–¹æ³•</strong></p>
<p>è¿›è¡Œå¤šç»„å®éªŒï¼Œè®°å½•ä¸åŒ $(B, S, E)$ çš„ç»„åˆã€‚æ ¹æ®å…³ç³»ï¼š</p>
<p>$$
S = S_{\min}\left(1 + \frac{\mathcal{B}_{\text{noise}}}{B}\right)
$$</p>
<p>æ‹Ÿåˆå¾—åˆ° $S_{\min}$ å’Œ $\mathcal{B}_{\text{noise}}$ã€‚</p>
<p><strong>æ¨å¯¼49ï¼šæ¢¯åº¦æ–¹å·®ä¼°è®¡</strong></p>
<p>åœ¨æ•°æ®å¹¶è¡Œä¸­ï¼Œæ¯ä¸ªworkerè®¡ç®—local batchçš„æ¢¯åº¦ $\boldsymbol{g}_i$ã€‚åœ¨All-Reduceå‰ï¼Œå¯ä»¥è®¡ç®—ï¼š</p>
<p>$$
\bar{\boldsymbol{g}} = \frac{1}{W}\sum_{i=1}^W \boldsymbol{g}_i, \quad \hat{\boldsymbol{\Sigma}} = \frac{1}{W-1}\sum_{i=1}^W (\boldsymbol{g}_i - \bar{\boldsymbol{g}})(\boldsymbol{g}_i - \bar{\boldsymbol{g}})^T
$$</p>
<p>ç„¶åä¼°è®¡ï¼š</p>
<p>$$
\mathcal{B}_{\text{simple}} \approx \frac{\text{Tr}(\hat{\boldsymbol{\Sigma}})}{\|\bar{\boldsymbol{g}}\|^2}
$$</p>
<p><strong>æ³¨é‡Š11</strong>ï¼šè¿™ä¸ªä¼°è®¡åªéœ€è¦é¢å¤–çš„ä¸€ç‚¹é€šä¿¡å’Œè®¡ç®—ï¼Œå¯ä»¥åœ¨çº¿ç›‘æ§ã€‚</p>
<h3 id="14">14. å­¦ä¹ ç‡è°ƒåº¦ç­–ç•¥</h3>
<p><strong>æ¨å¯¼50ï¼šä½™å¼¦é€€ç«çš„æ•°å­¦å½¢å¼</strong></p>
<p>å¸¸ç”¨çš„ä½™å¼¦é€€ç«ï¼š</p>
<p>$$
\eta_t = \eta_{\min} + \frac{\eta_{\max} - \eta_{\min}}{2}\left(1 + \cos\left(\frac{\pi t}{T}\right)\right)
$$</p>
<p><strong>æ¨å¯¼51ï¼šé€€ç«ä¸Batch Sizeçš„è€¦åˆ</strong></p>
<p>åœ¨è®­ç»ƒåæœŸï¼Œæ¢¯åº¦å˜å°ï¼Œ$\mathcal{B}_{\text{noise}}$ å¯èƒ½å¢å¤§ã€‚å¦‚æœåŒæ—¶è¿›è¡Œå­¦ä¹ ç‡é€€ç«ï¼š</p>
<p>$$
\eta_t = \frac{\eta_{\max,t}}{1 + \mathcal{B}_{\text{noise}}(t)/B}
$$</p>
<p>å…¶ä¸­ $\eta_{\max,t}$ æœ¬èº«åœ¨å‡å°ã€‚</p>
<p><strong>æ¨å¯¼52ï¼šæ¸è¿›å¼å¢å¤§Batch Size</strong></p>
<p>å¦ä¸€ç§ç­–ç•¥æ˜¯å›ºå®šå­¦ä¹ ç‡ï¼Œé€æ¸å¢å¤§Batch Sizeï¼š</p>
<p>$$
B_t = B_0 \cdot r^t, \quad r > 1
$$</p>
<p>è¿™åœ¨æŸäº›æƒ…å†µä¸‹å¯ä»¥æ›¿ä»£å­¦ä¹ ç‡é€€ç«ã€‚</p>
<h3 id="15">15. é«˜çº§ä¸»é¢˜ï¼šäºŒé˜¶ä¼˜åŒ–æ–¹æ³•</h3>
<p><strong>æ¨å¯¼53ï¼šç‰›é¡¿æ³•çš„Batch Sizeä¾èµ–</strong></p>
<p>ç‰›é¡¿æ³•çš„æ›´æ–°ï¼š</p>
<p>$$
\boldsymbol{w}_{t+1} = \boldsymbol{w}_t - \eta\boldsymbol{H}^{-1}\tilde{\boldsymbol{g}}_B
$$</p>
<p>æ›´æ–°é‡çš„æ–¹å·®ï¼š</p>
<p>$$
\text{Var}[\Delta\boldsymbol{w}] = \eta^2\boldsymbol{H}^{-1}\frac{\boldsymbol{\Sigma}}{B}\boldsymbol{H}^{-1}
$$</p>
<p><strong>æ¨å¯¼54ï¼šè‡ªç„¶æ¢¯åº¦çš„ç¼©æ”¾</strong></p>
<p>è‡ªç„¶æ¢¯åº¦ä½¿ç”¨Fisherä¿¡æ¯çŸ©é˜µ $\boldsymbol{F}$ï¼š</p>
<p>$$
\boldsymbol{w}_{t+1} = \boldsymbol{w}_t - \eta\boldsymbol{F}^{-1}\tilde{\boldsymbol{g}}_B
$$</p>
<p>FisherçŸ©é˜µæœ¬èº«ä¾èµ–äºBatch Sizeçš„ä¼°è®¡ï¼Œä½¿å¾—ç¼©æ”¾å…³ç³»æ›´åŠ å¤æ‚ã€‚</p>
<h3 id="16">16. ç†è®ºæé™ä¸å®è·µå·®è·</h3>
<p><strong>æ¨å¯¼55ï¼šç†è®ºæœ€ä¼˜ä¸å®é™…æœ€ä¼˜</strong></p>
<p>ç†è®ºåˆ†æåŸºäºï¼š
1. äºŒé˜¶è¿‘ä¼¼æœ‰æ•ˆ
2. HessiançŸ©é˜µç¨³å®š
3. æ¢¯åº¦å™ªå£°é«˜æ–¯åˆ†å¸ƒ</p>
<p>å®é™…è®­ç»ƒä¸­è¿™äº›å‡è®¾å¯èƒ½ä¸æˆç«‹ï¼Œå¯¼è‡´ï¼š</p>
<p>$$
\eta_{\text{practice}}^* \neq \eta_{\text{theory}}^*
$$</p>
<p><strong>æ¨å¯¼56ï¼šå®‰å…¨ç³»æ•°</strong></p>
<p>å®è·µä¸­é€šå¸¸ä½¿ç”¨ç†è®ºå€¼çš„ä¸€ä¸ªæ¯”ä¾‹ï¼š</p>
<p>$$
\eta_{\text{practice}} = \alpha \eta_{\text{theory}}, \quad 0.5 < \alpha < 1
$$</p>
<h3 id="_16">æ€»ç»“</h3>
<p>æœ¬èŠ‚ç³»ç»Ÿæ¨å¯¼äº†Batch Sizeä¸å­¦ä¹ ç‡ä¹‹é—´çš„ç¼©æ”¾å…³ç³»ï¼Œä¸»è¦ç»“è®ºï¼š</p>
<ol>
<li><strong>å¹³æ–¹æ ¹ç¼©æ”¾</strong>ï¼šä»æ–¹å·®ä¸å˜æ€§å¯¼å‡º $\eta \propto \sqrt{B}$</li>
<li><strong>çº¿æ€§ç¼©æ”¾</strong>ï¼šä»SDEè¿ç»­æé™å¯¼å‡º $\eta \propto B$ï¼ˆå°Batch Sizeä¸‹ï¼‰</li>
<li><strong>é¥±å’Œæ•ˆåº”</strong>ï¼šå­˜åœ¨ä¸´ç•ŒBatch Size $\mathcal{B}_{\text{noise}}$ï¼Œè¶…è¿‡åå­¦ä¹ ç‡ä¸åº”ç»§ç»­å¢å¤§</li>
<li><strong>Adamçš„ç‰¹æ®Šæ€§</strong>ï¼šéµå¾ªå¹³æ–¹æ ¹ç¼©æ”¾è€Œéçº¿æ€§ç¼©æ”¾</li>
<li><strong>æ•°æ®-è®¡ç®—æƒè¡¡</strong>ï¼š$(\tilde{S}-1)(\tilde{E}-1)=1$ æè¿°äº†æ•ˆç‡çš„åŸºæœ¬é™åˆ¶</li>
</ol>
<p>è¿™äº›ç†è®ºä¸ºå¤§è§„æ¨¡åˆ†å¸ƒå¼è®­ç»ƒæä¾›äº†é‡è¦æŒ‡å¯¼ã€‚</p>
        </div>
    </div>
</body>
</html>