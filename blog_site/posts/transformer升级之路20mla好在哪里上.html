<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transformerå‡çº§ä¹‹è·¯ï¼š20ã€MLAå¥½åœ¨å“ªé‡Œ?ï¼ˆä¸Šï¼‰</title>
    <style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    line-height: 1.6; color: #333; max-width: 900px; margin: 0 auto; padding: 20px; background: #f5f5f5;
}
.container { background: white; padding: 40px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
header { border-bottom: 2px solid #e0e0e0; padding-bottom: 20px; margin-bottom: 30px; }
h1 { color: #2c3e50; margin-bottom: 10px; font-size: 2em; }
.meta { color: #666; font-size: 0.9em; margin-bottom: 20px; }
.content { margin-top: 30px; overflow-wrap: break-word; }
.content h2 { color: #34495e; margin-top: 30px; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
.content p { margin-bottom: 15px; }
.content pre { background: #f8f8f8; padding: 15px; border-radius: 5px; overflow-x: auto; border-left: 3px solid #3498db; margin: 15px 0; }
.content code { background: #f8f8f8; padding: 2px 5px; border-radius: 3px; font-family: monospace; font-size: 0.9em; }
.content blockquote { border-left: 4px solid #3498db; padding-left: 20px; margin: 20px 0; color: #555; font-style: italic; }
.content table { border-collapse: collapse; width: 100%; margin: 20px 0; }
.content th, .content td { border: 1px solid #ddd; padding: 10px; text-align: left; }
.back-link { display: inline-block; margin-bottom: 20px; color: #3498db; text-decoration: none; font-weight: 500; }
</style>
    
<script>
    window.MathJax = {
        tex: {
            inlineMath: [['$', '$'], ['\(', '\)']],
            displayMath: [['$$', '$$'], ['\[', '\]']],
            processEscapes: true
        }
    };
</script>
<script id="MathJax-script" async src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>

</head>
<body>
    <div class="container">
        <a href="../index.html" class="back-link">â† è¿”å›é¦–é¡µ</a>
        <header>
            <h1>Transformerå‡çº§ä¹‹è·¯ï¼š20ã€MLAå¥½åœ¨å“ªé‡Œ?ï¼ˆä¸Šï¼‰</h1>
            <div class="meta">ğŸ“… æœ€åæ›´æ–°: 2025-11-26 | ğŸ“„ å¤§å°: 34.2 KB</div>
        </header>
        <div class="content">
            <p><strong>åŸæ–‡é“¾æ¥</strong>: <a href="https://spaces.ac.cn/archives/10907">https://spaces.ac.cn/archives/10907</a></p>
<p><strong>å‘å¸ƒæ—¥æœŸ</strong>: </p>
<hr />
<p>è‡ªä»DeepSeekçˆ†ç«åï¼Œå®ƒæ‰€æçš„Attentionå˜ä½“MLAï¼ˆ<strong>M</strong> ulti-head <strong>L</strong> atent <strong>A</strong> ttentionï¼‰ä¹Ÿæ„ˆå‘å—åˆ°å…³æ³¨ã€‚MLAé€šè¿‡å·§å¦™çš„è®¾è®¡å®ç°äº†MHAä¸MQAçš„è‡ªç”±åˆ‡æ¢ï¼Œä½¿å¾—æ¨¡å‹å¯ä»¥æ ¹æ®è®­ç»ƒå’Œæ¨ç†çš„ä¸åŒç‰¹æ€§ï¼ˆCompute-Bound or Memory-Boundï¼‰é€‰æ‹©æœ€ä½³çš„å½¢å¼ï¼Œå°½å¯èƒ½åœ°è¾¾åˆ°æ•ˆç‡æœ€å¤§åŒ–ã€‚</p>
<p>è¯šç„¶ï¼ŒMLAå¾ˆæœ‰æ•ˆï¼Œä½†ä¹Ÿæœ‰è§‚ç‚¹è®¤ä¸ºå®ƒä¸å¤Ÿä¼˜é›…ï¼Œæ‰€ä»¥å¯»æ‰¾MLAæ›¿ä»£å“çš„åŠªåŠ›ä¸€ç›´å­˜åœ¨ï¼ŒåŒ…æ‹¬æˆ‘ä»¬ä¹Ÿæœ‰åœ¨å°è¯•ã€‚ç„¶è€Œï¼Œç»è¿‡ä¸€æ®µæ—¶é—´çš„å®éªŒï¼Œæˆ‘ä»¬å‘ç°å¾ˆå¤šKV Cacheç›¸åŒç”šè‡³æ›´å¤§çš„Attentionå˜ä½“ï¼Œæœ€ç»ˆæ•ˆæœéƒ½ä¸å¦‚MLAã€‚è¿™ä¸å¾—ä¸è®©æˆ‘ä»¬å¼€å§‹åæ€ï¼šMLAçš„å‡ºè‰²è¡¨ç°èƒŒåçš„å…³é”®åŸå› ç©¶ç«Ÿæ˜¯ä»€ä¹ˆï¼Ÿ</p>
<p>æ¥ä¸‹æ¥ï¼Œæœ¬æ–‡å°†è¯¦ç»†ä»‹ç»ç¬”è€…å›´ç»•è¿™ä¸€é—®é¢˜çš„æ€è€ƒè¿‡ç¨‹ä»¥åŠç›¸å…³å®éªŒç»“æœã€‚</p>
<h2 id="_1">è§‚å¯Ÿ</h2>
<p>MLAæå‡ºè‡ª<a href="https://papers.cool/arxiv/2405.04434">DeepSeek-V2</a>ï¼Œæœ¬æ–‡å‡è®¾è¯»è€…å·²ç»ç†Ÿæ‚‰MLAï¼Œè‡³å°‘äº†è§£ä¹‹å‰çš„åšå®¢<a href="/archives/10091">ã€Šç¼“å­˜ä¸æ•ˆæœçš„æé™æ‹‰æ‰¯ï¼šä»MHAã€MQAã€GQAåˆ°MLAã€‹</a>æ‰€ä»‹ç»çš„å†…å®¹ï¼Œå› æ­¤MLAè‡ªèº«çš„ç»†èŠ‚å°†ä¸ä¼šè¿‡å¤šå±•å¼€ã€‚</p>
<p>MLAçš„ä¸»è¦ç‰¹ç‚¹å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>1ã€MLAåœ¨è®­ç»ƒé˜¶æ®µæ˜¯ä¸€ä¸ªqk_head_dims=(128+64)ã€v_head_dims=128çš„MHAï¼›</p>
<p>2ã€MLAåœ¨è§£ç é˜¶æ®µæ˜¯ä¸€ä¸ªqk_head_dims=(512+64)ã€v_head_dims=512ã€KV-Sharedçš„MQAï¼›</p>
<p>3ã€MLAçš„[qc, qr]ã€[kc, kr]æ‹¼æ¥ï¼Œå¯ä»¥ç†è§£ä¸ºä¸€ç§<a href="/archives/10122#%E9%83%A8%E5%88%86%E6%97%8B%E8%BD%AC">Partial RoPE</a>ã€‚</p>
</blockquote>
<h2 id="_2">çŒœæµ‹</h2>
<p>MHAã€GQAå¸¸ç”¨çš„head_dimsæ˜¯128ï¼Œè€Œå¯¹äºMLAæ¥è¯´ï¼Œä¸ç®¡æ˜¯ä»è®­ç»ƒçœ‹çš„128+64ï¼Œè¿˜æ˜¯ä»æ¨ç†çœ‹çš„512+64ï¼Œéƒ½è¦å¤§äº128ï¼Œå†ç»“åˆ<a href="/archives/7325">ã€Šçªç ´ç“¶é¢ˆï¼Œæ‰“é€ æ›´å¼ºå¤§çš„Transformerã€‹</a>çš„ç»éªŒï¼Œæˆ‘ä»¬æœ‰ï¼š</p>
<blockquote>
<p><strong>çŒœæµ‹1</strong> ï¼š å¢å¤§head_dimsæ˜¯MLAå¥½çš„å…³é”®ä¹‹ä¸€ã€‚</p>
</blockquote>
<p>å¦å¤–ï¼ŒKV-Sharedè¿™ä¸ªç‰¹æ€§ï¼Œå¯ä»¥åœ¨åŒç­‰KV Cacheå¤§å°ä¸‹ï¼Œå¢å¤§GQAçš„head_dimsæˆ–è€…num_groupsï¼Œæ‰€ä»¥æœ‰ï¼š</p>
<blockquote>
<p><strong>çŒœæµ‹2</strong> ï¼š KV-Sharedæ˜¯MLAå¥½çš„å…³é”®ä¹‹ä¸€ã€‚</p>
</blockquote>
<p>æœ€åï¼Œæ­¤å‰æœ‰ä¸€äº›ç†è®ºå’Œå®éªŒæ˜¾ç¤ºPartial RoPEå¯èƒ½ä¼šå¯¹æ•ˆæœæœ‰æ­£é¢å¸®åŠ©ï¼ˆå‚è€ƒ<a href="/archives/10122#%E9%83%A8%E5%88%86%E6%97%8B%E8%BD%AC">ã€ŠTransformerå‡çº§ä¹‹è·¯ï¼š18ã€RoPEçš„åº•æ•°é€‰æ‹©åŸåˆ™ã€‹</a>ï¼‰ï¼Œæ‰€ä»¥æœ‰</p>
<blockquote>
<p><strong>çŒœæµ‹3</strong> ï¼š Partial RoPEæ˜¯MLAå¥½çš„å…³é”®ä¹‹ä¸€ã€‚</p>
</blockquote>
<h2 id="_3">å®éªŒ</h2>
<p>ç°åœ¨æˆ‘ä»¬é€šè¿‡å®éªŒé€ä¸€æ£€éªŒä»¥ä¸ŠçŒœæµ‹ã€‚</p>
<h3 id="_4">è®¾ç½®</h3>
<p>æ‰€æœ‰å®éªŒå…¬å…±éƒ¨åˆ†çš„è¶…å‚æ•°å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>1ã€ç±»ä¼¼LLAMA3çš„Denseæ¨¡å‹ï¼›</p>
<p>2ã€hidden_size=2048ï¼Œnum_layers=12ï¼Œnum_heads=16ï¼›</p>
<p>3ã€ä¼˜åŒ–å™¨æ˜¯<a href="/archives/10592">Muon</a>ï¼ŒAttentionéƒ¨åˆ†per headæ›´æ–°ï¼›</p>
<p>4ã€è®­ç»ƒé•¿åº¦ä¸º4096ï¼Œæ€»tokensæ•°ä¸º16Bï¼Œæ€»è®­ç»ƒæ­¥æ•°ä¸º16kï¼›</p>
<p>5ã€æ‰€æœ‰å®éªŒéƒ½æ˜¯åªæ”¹å˜Attentionï¼Œæ‰€ä»¥å‚æ•°é‡ä¸ä¼šä¸¥æ ¼å¯¹é½ã€‚</p>
</blockquote>
<h3 id="part-i">Part I</h3>
<p>MLAçš„KV Cacheå¤§å°æ˜¯512+64ï¼Œçº¦ç­‰äºGQA2-128ï¼ˆç¬¬ä¸€ä¸ªæ•°å­—æ˜¯num_groupsï¼Œç¬¬äºŒä¸ªæ•°å­—æ˜¯head_dimsï¼‰ï¼Œæ‰€ä»¥å¯¹æ¯”çš„baselineä¸ºGQA2-128å’ŒGQA1-256ã€‚ä¸ºäº†éªŒè¯Partial RoPEï¼Œæˆ‘ä»¬å¢åŠ äº†GQA1-256-PRï¼Œå…·ä½“åšæ³•æ˜¯å°†Qã€Kçš„256 dimsåˆ†æˆ192+64ä¸¤éƒ¨åˆ†ï¼Œåœ¨64ä¸ŠåŠ RoPEï¼Œ192ä¸åŠ ã€‚</p>
<p>ç»“æœå¦‚ä¸‹ï¼š<br />
$$\begin{array}{c|ccc}  
\hline  
& \text{Params} & \text{Loss} & \text{Cache} \\\  
\hline  
\text{MLA} & 894M & 2.721 & 576 \\\  
\text{GQA2-128} & 842M & 2.75 & 512 \\\  
\text{GQA1-256} & 943M & 2.72 & 512 \\\  
\text{GQA1-256-PR} & 943M & 2.711 & 512 \\\  
\hline  
\end{array}$$</p>
<p>å³<br />
$$\text{GQA2-128} < \text{MLA} \lesssim \text{GQA1-256} < \text{GQA1-256-PR}$$<br />
åˆæ­¥éªŒè¯äº†å¢å¤§head_dimså’ŒPartial RoPEçš„ä½œç”¨ã€‚è¿™æ ·çœ‹æ¥ï¼ŒMLAçš„è®¾è®¡ä¸­ï¼ŒRoPEå’ŒNoPEæ‹¼æ¥è¿™éƒ¨åˆ†çœ‹ä¼¼æ— å¥ˆçš„è®¾è®¡ï¼Œææœ‰å¯èƒ½æ˜¯å®ƒæ•ˆæœä¼˜å¼‚çš„å…³é”®åŸå› ï¼åŸè®ºæ–‡å£°ç§°MLAç”šè‡³ä¼˜äºMHAï¼Œå¤§æ¦‚ç‡ä¹Ÿæ˜¯å› ä¸ºæ‰€å¯¹æ¯”çš„MHAçš„head_dimsåªæœ‰128ã€‚</p>
<h3 id="part-ii">Part II</h3>
<p>ä¸ºäº†è¿›ä¸€æ­¥éªŒè¯å¢å¤§head_dimsçš„ä½œç”¨ï¼Œæˆ‘ä»¬å¦å¤–è·‘äº†MHAã€GQA2-192ã€MLA-256ä¸‰ä¸ªå®éªŒï¼ŒMHAæ˜¯head_dims=128çš„å¸¸è§„MHAï¼ŒGQA2-192æ˜¯ç›´æ¥å¢å¤§GQA2çš„head_dimsåˆ°192ï¼ŒMLA-256æ˜¯å°†MLAçš„128+64æå‡åˆ°192+64ï¼Œå¯¹ç…§å¦‚ä¸‹</p>
<p>$$\begin{array}{c|ccc}  
\hline  
& \text{Params} & \text{Loss} & \text{Cache} \\\  
\hline  
\text{MHA} & 931M & 2.721 & 4096 \\\  
\text{MLA} & 894M & 2.721 & 576 \\\  
\text{MLA-256} & 989M & 2.705 & 576 \\\  
\text{GQA2-128} & 842M & 2.75 & 512 \\\  
\text{GQA2-192} & 899M & 2.729 & 768 \\\  
\text{GQA1-256} & 943M & 2.72 & 512 \\\  
\text{GQA1-256-PR} & 943M & 2.711 & 512 \\\  
\hline  
\end{array}$$</p>
<p>å¯ä»¥çœ‹åˆ°ï¼ŒMHAæ€»å‚æ•°é‡æ›´å¤šï¼ŒKV Cacheæ›´æ˜¯7å€äºMLAï¼Œä½†Lossæ‰å ªå ªè¿½å¹³MLAï¼Œè¿™è·ŸDeepSeek-V2é‡Œè¾¹çš„ç»“è®ºæ¥è¿‘ã€‚æ­¤å¤–ï¼ŒGQA2-192ä¼˜äºGQA2-128ï¼Œä½†ä¸å¦‚GQA1-256ï¼›MLAçš„head_dimså‡åˆ°(192+64)åï¼Œç›¸æ¯”(128+64)ä¹Ÿè¿˜èƒ½è¿›ä¸€æ­¥æå‡æ•ˆæœã€‚è¿™äº›ç°è±¡éƒ½è¡¨æ˜ï¼Œå¢åŠ head_dimsè¿œæ¯”å¢åŠ num_groupsæ›´æœ‰æ•ˆã€‚</p>
<h3 id="part-iii">Part III</h3>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬éªŒè¯KV-Sharedï¼Œå³Kã€Vå…±äº«å…¨éƒ¨æˆ–å¤§éƒ¨åˆ†dimsã€‚è¿™é‡Œæˆ‘ä»¬ä¸»è¦è€ƒè™‘çš„æ›¿ä»£å“æ˜¯head_dimsä¸è¶…è¿‡256çš„GQAï¼Œå¹¶ä¸”æ§åˆ¶KV Cacheçš„æ€»å¤§å°è·ŸMLAæ¥è¿‘ï¼Œæ‰€ä»¥å½“KV-Sharedæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥è‡³å¤šå¯ä»¥è€ƒè™‘GQA2-256ã€‚</p>
<p>ç”±äºKV-Sharedè·ŸRoPEä¸å®Œå…¨å…¼å®¹ï¼Œå‚è€ƒMLAçš„åšæ³•ï¼Œæˆ‘ä»¬å°†256åˆ†æˆ192+64ä¸¤éƒ¨åˆ†ï¼Œå…¶ä¸­</p>
<blockquote>
<p>1ã€192éƒ¨åˆ†ä¸åŠ RoPEï¼Œåœ¨Kã€Vé—´å…±äº«ï¼›</p>
<p>2ã€64éƒ¨åˆ†åŠ RoPEï¼Œåªç”¨äºKï¼›</p>
<p>3ã€Vå¦å¤–å†æŠ•å½±64 dimsï¼Œconcatåˆ°å…±äº«çš„192 dimsä¸Šå»ã€‚</p>
</blockquote>
<p>è¿™æ ·ä¸€æ¥ï¼ŒKã€Vçš„head_dimséƒ½æ˜¯256ï¼ŒKV Cacheæ€»å¤§å°æ˜¯(192+64+64)*2=640ï¼Œç•¥å¤§äºMLAçš„512+64=576ï¼Œè¿™ä¸ªç‰ˆæœ¬æˆ‘ä»¬ç®€è®°ä¸ºâ€œGQA2-(192+64)-S1â€ï¼Œå…¶å®â€œS1â€æ˜¯â€œShared-1â€çš„ç¼©å†™ã€‚</p>
<h3 id="part-iv">Part IV</h3>
<p>å¦å¤–ä¸€ç§KV-Sharedçš„æ–¹æ¡ˆæ˜¯ï¼š</p>
<blockquote>
<p>1ã€192éƒ¨åˆ†ä¸åŠ RoPEï¼Œåœ¨Kã€Vé—´å…±äº«ï¼›</p>
<p>2ã€64éƒ¨åˆ†åŠ RoPEï¼ŒåŒæ ·åœ¨Kã€Vé—´å…±äº«ï¼›</p>
<p>3ã€åšAttentionï¼Œç”±äºVå¸¦RoPEï¼Œæ­¤æ—¶æ˜¯ç»å¯¹ä½ç½®ç¼–ç æ•ˆæœï¼›</p>
<p>4ã€ä¸ºäº†ä¿è¯ç›¸å¯¹ä½ç½®ç¼–ç ï¼Œå°†è¾“å‡ºåˆ†æˆ192+64ä¸¤éƒ¨åˆ†ï¼Œ64éƒ¨åˆ†å†åŠ ä¸€æ¬¡é€†å‘RoPEã€‚</p>
</blockquote>
<p>è¿™ç§åšæ³•æ˜¯Kã€Vå®Œå…¨å…±äº«ï¼ŒKV Cacheå¤§å°æ˜¯(192+64)*2=512ï¼Œç•¥å°äºMLAã€‚è¿™ä¸ªç‰ˆæœ¬æˆ‘ä»¬ç§°ä¸ºâ€œGQA2-(192+64)-S2â€ï¼Œâ€œS2â€æ˜¯â€œShared-2â€çš„ç¼©å†™ï¼ŒèƒŒåçš„åŸç†æ˜¯ç¬”è€…æ–°æå‡ºçš„VO-RoPEï¼Œå‚è€ƒ<a href="/archives/10862">ã€ŠTransformerå‡çº§ä¹‹è·¯ï¼š19ã€ç¬¬äºŒç±»æ—‹è½¬ä½ç½®ç¼–ç ã€‹</a>ã€‚</p>
<h3 id="part-v">Part V</h3>
<p>å¦å¤–ï¼Œæ ¹æ®åŒæ ·æ€è·¯è¡¥äº†å‡ ä¸ªGQA4å’ŒGQA1çš„å®éªŒã€‚æ‰€æœ‰å®éªŒç»“æœæ±‡æ€»å¦‚ä¸‹ï¼š<br />
$$\begin{array}{c|ccc|c}  
\hline  
& \text{Params} & \text{Loss} & \text{Cache} & \text{å¤‡æ³¨} \\\  
\hline  
\text{MLA} & 894M & 2.721 & 576 & \\\  
\text{MLA-256} & 989M & 2.705 & 576 & \\\  
\text{GQA2-(192+64)-S1} & 946M & 2.714 & 640 & \\\  
\text{GQA2-(192+64)-S2} & 943M & 2.708 & 512 & \text{å¼•å…¥VO-RoPE} \\\  
\text{GQA4-(64+64)-S2} & 842M & 2.738 & 512 & \\\  
\text{GQA4-(128+64)-S2} & 899M & 2.713 & 768 & \text{KV Cacheæœ€å¤§} \\\  
\text{GQA1-(512+64)-S3} & 1171M & 2.677 & 576 & \text{head_dimsæœ€å¤§} \\\  
\hline  
\end{array}$$</p>
<p>è¿™é‡Œâ€œGQA1-(512+64)-S3â€æ˜¯æŒ‰ç…§MLAçš„æ¨ç†å½¢å¼å®ç°çš„MQAï¼Œå½¢å¼ä»‹ä¹S1ä¸S2ä¹‹é—´ï¼Œå®ƒçš„ä¸»è¦ç‰¹ç‚¹æ˜¯head_dimså¤§ã€‚</p>
<p>ç»“æœè§£è¯»ï¼š</p>
<blockquote>
<p>1ã€KV-Sharedçš„GQAè‡ªå¸¦Partial RoPEï¼›</p>
<p>2ã€KV-Sharedçš„GQA2-256ï¼Œä¹Ÿèƒ½è¶…è¿‡MLAï¼›</p>
<p>3ã€VO-RoPEçš„å¼•å…¥ï¼Œä¼¼ä¹æœ‰åˆ©äºæ•ˆæœï¼ˆS1 â‰² S2ï¼‰ï¼›</p>
<p>4ã€åŒç­‰KV Cacheä¸‹ï¼Œhead_dimsè¶Šå¤§è¶Šå¥½ï¼›</p>
<p>5ã€GQA2-(192+64)-S2 ç•¥å¾®è¶…è¿‡ GQA1-256-PRï¼›</p>
<p>6ã€GQA4-(128+64)-S2 çš„KV Cacheæœ€å¤§ï¼Œä½†æ•ˆæœä¸æ˜¯æœ€ä¼˜ï¼Œå†æ¬¡è¡¨æ˜head_dimsæ›´å…³é”®ã€‚</p>
</blockquote>
<p>å…³äºKV-Sharedï¼Œè¿˜æœ‰ä¸¤ç‚¹è§‚å¯Ÿï¼š</p>
<blockquote>
<p>1ã€è®­ç»ƒè¿‡ç¨‹ä¸­ï¼ŒGQA1-256-PRå‰æœŸæ˜¯æ˜æ˜¾é¢†å…ˆGQA2-(192+64)-S2ï¼Œä½†åæœŸè¢«è¿½å¹³ç”šè‡³ç•¥å¾®åå…ˆï¼ŒçŒœæµ‹GQA1-256-PRå¯èƒ½æœ‰ååŠ²ä¸è¶³çš„å«Œç–‘ï¼›</p>
<p>2ã€å¦‚æœæ²¡æœ‰KV-Sharedï¼ŒGQAé¡¶å¤šæ˜¯GQA1-256ï¼Œä¹Ÿå°±æ˜¯è¯´head_dimsé¡¶å¤©äº†256ï¼Œä½†æœ‰KV-Sharedçš„è¯ï¼ŒGQAå¯ä»¥åšåˆ°GQA1-512-Sï¼Œå•çº¯ä»head_dimsçœ‹ï¼ŒKV-Sharedå¤©èŠ±æ¿æ›´é«˜ã€‚</p>
</blockquote>
<h3 id="part-vi">Part VI</h3>
<p>ç”±äºæ²¡æœ‰ä¸¥æ ¼å¯¹é½å‚æ•°é‡ï¼Œå¯èƒ½è¯»è€…ä¼šæœ‰â€œåˆ°åº•æ˜¯å¢åŠ å‚æ•°é‡è¿˜æ˜¯å¢åŠ head_dimsæ›´æœ¬è´¨â€çš„ç–‘è™‘ï¼Œæ‰€ä»¥è¿™é‡Œè¡¥å……å‡ ä¸ªå¯¹é½å‚æ•°é‡çš„å®éªŒã€‚</p>
<p>è¿™é‡Œè€ƒè™‘çš„å¯¹é½å‚æ•°é‡çš„æ–¹å¼æœ‰ä¸‰ç§ï¼š</p>
<blockquote>
<p>1ã€<strong>double-heads</strong> ï¼šä»¥â€œGQA2-128 vs GQA1-256â€ä¸ºä¾‹ï¼Œå°†GQA2-128çš„num_headsç¿»å€ï¼Œå¯ä»¥è®©GQA2-128çš„å‚æ•°é‡è·ŸGQA1-256ç›¸åŒï¼›</p>
<p>2ã€<strong>ç¼©å‡MLP</strong> ï¼šç¼©å°MLPï¼ˆSwiGLUï¼‰çš„intermediate_sizeï¼Œä¹Ÿå¯ä»¥ä½¿å¾—GQA1-256çš„å‚æ•°é‡è·ŸGQA2-128å¤§è‡´ç›¸åŒï¼›</p>
<p>3ã€<strong>Q &amp;O LoRA</strong>ï¼šGQAçš„ä¸»è¦å‚æ•°é‡æ¥è‡ªQueryå’ŒOutputçš„æŠ•å½±çŸ©é˜µï¼Œå¯¹è¿™ä¸¤ä¸ªçŸ©é˜µæ”¹ç”¨LoRAï¼Œä¹Ÿå¯ä»¥é™ä½GQA1-256çš„å‚æ•°é‡ã€‚</p>
</blockquote>
<p>å®éªŒç»“æœå¦‚ä¸‹ï¼š<br />
$$\begin{array}{c|ccc|ccc}  
\hline  
& \text{Params} & \text{Loss} & \text{Cache} & \text{num_heads} & \text{intermediate_size} & \text{qo_lora} \\\  
\hline  
\text{MLA} & 894M & 2.721 & 576 & 16 & 5456 & \text{No}\\\  
\hline  
\text{GQA2-128} & 842M & 2.75 & 512 & 16 & 5456 & \text{No}\\\  
\text{GQA1-256} & 943M & 2.72 & 512 & 16 & 5456 & \text{No}\\\  
\hline  
\text{GQA2-128} & 943M & 2.723 & 512 & \color{red}{32} & 5456 & \text{No} \\\  
\text{GQA1-256} & 843M & 2.747 & 512 & 16 & \color{red}{4096} & \text{No} \\\  
\text{GQA1-256} & 842M & 2.726 & 512 & 16 & 5456 & \color{red}{\text{Yes}} \\\  
\hline  
\text{GQA4-(64+64)-S2} & 842M & 2.738 & 512 & 16 & 5456 & \text{No} \\\  
\text{GQA2-(192+64)-S2} & 943M & 2.708 & 512 & 16 & 5456 & \text{No} \\\  
\hline  
\text{GQA4-(64+64)-S2} & 943M & 2.711 & 512 & \color{red}{32} & 5456 & \text{No} \\\  
\text{GQA2-(192+64)-S2} & 843M & 2.733 & 512 & 16 & \color{red}{4096} & \text{No} \\\  
\text{GQA2-(192+64)-S2} & 842M & 2.708 & 512 & 16 & 5456 & \color{red}{\text{Yes}} \\\  
\hline  
\end{array}$$</p>
<p>ç»“æœä¸»è¦åˆ†ä¸‰å—ï¼š</p>
<blockquote>
<p>1ã€headsç¿»å€ç›¸æ¯”head_dimsç¿»å€ï¼Œlossç¨³å®šå·®0.003å·¦å³ï¼›</p>
<p>2ã€ç¼©å°MLPæ¯”head_dimså‡åŠï¼Œlossç¨³å®šä¼˜0.004å·¦å³ï¼›</p>
<p>3ã€Q&amp;O LoRAæ€§èƒ½æŸå¤±æœ€å°ï¼Œå¯ä»¥å®ç°head_dimsç¿»å€ä½†å‚æ•°é‡ä¸å¢ï¼Œä¸”lossæ˜æ˜¾é™ã€‚</p>
</blockquote>
<p>ç»“è®ºï¼šå¦‚æœä»å¢åŠ å‚æ•°é‡è§’åº¦çœ‹ï¼Œå¢å¤§head_dimså¯èƒ½æ˜¯æ•ˆæœå¢ç›Šè¾ƒå¤§çš„æ–¹å‘ï¼Œé…åˆQ&amp;O LoRAå¯ä»¥å®ç°å‚æ•°é‡å‡ ä¹ä¸å¢ï¼Œä½†æ”¶ç›Šä»ç›¸å½“ã€‚</p>
<h2 id="_5">å°ç»“</h2>
<p>åˆæ­¥ç»“è®ºæ˜¯ï¼š</p>
<blockquote>
<p>1ã€å¢å¤§head_dimsæ”¶ç›Šæœ€å¤§ï¼›</p>
<p>2ã€Partial RoPEå¯¹Lossä¹Ÿæœ‰ä¸€å®šå¸®åŠ©ï¼›</p>
<p>3ã€KV-Sharedåº”è¯¥ä¹Ÿæœ‰ä¸€å®šä½œç”¨ã€‚</p>
</blockquote>
<p>è¿™æ ·çœ‹æ¥ï¼Œæ­¤å‰æˆ‘ä»¬ä¸€ç›´åœ¨head_dims=128ä¸‹æ‰¾MLAçš„æ›¿ä»£å“ï¼Œæ„Ÿè§‰æ˜¯èµ·ç‚¹å°±å…ˆå¤©ä¸è¶³äº†ï¼Œéš¾æ€ªä¸€ç›´æ¯”ä¸ä¸ŠMLAã€‚è¦æƒ³è¿½å¹³MLAï¼Œhead_dimsåº”è¯¥è¦192èµ·æ­¥äº†ï¼Œå¹¶è¾…ä»¥Partial RoPEã€‚è‡³äºKV-Sharedï¼Œä¹Ÿå¯èƒ½æœ‰ç”¨ï¼Œä½†åº”è¯¥è¿˜éœ€è¦æ›´å¤§è§„æ¨¡çš„éªŒè¯ã€‚</p>
<h2 id="_6">æ„ä¹‰</h2>
<p>å…¶å®è¿™é‡Œè¾¹çš„æ„ä¹‰ï¼Œå°±çœ‹æˆ‘ä»¬æ¢æ‰MLAçš„å†³å¿ƒæœ‰å¤šå¼ºã€‚</p>
<p>å‡è®¾ GQA2-(192+64)-S2 å¯ä»¥æ›¿ä»£MLAï¼Œä½†MLAä¹Ÿå¯ä»¥å‡åˆ°256ï¼Œç›®å‰çœ‹æ¥ GQA2-(192+64)-S2 æ¯”ä¸ä¸Š MLA-256 ã€‚é‚£ä¹ˆæ¢æ‰MLAçš„å”¯äºŒå¥½å¤„æ˜¯ï¼š</p>
<blockquote>
<p>1ã€ç»“æ„æ›´ç®€å•ï¼Œå¯ä»¥æ–¹ä¾¿åŠ QK-Normï¼›</p>
<p>2ã€è§£ç é˜¶æ®µçš„head_dimsç”±512+64å˜æˆäº†256ï¼ŒåŒæ—¶num_groupså˜ä¸º2ï¼Œå¯ä»¥TPã€‚</p>
</blockquote>
<p><em><strong>è½¬è½½åˆ°è¯·åŒ…æ‹¬æœ¬æ–‡åœ°å€ï¼š</strong><a href="https://spaces.ac.cn/archives/10907">https://spaces.ac.cn/archives/10907</a></em></p>
<p><em><strong>æ›´è¯¦ç»†çš„è½¬è½½äº‹å®œè¯·å‚è€ƒï¼š</strong></em><a href="https://spaces.ac.cn/archives/6508#%E6%96%87%E7%AB%A0%E5%A6%82%E4%BD%95%E8%BD%AC%E8%BD%BD/%E5%BC%95%E7%94%A8" title="ã€Šç§‘å­¦ç©ºé—´FAQã€‹">ã€Šç§‘å­¦ç©ºé—´FAQã€‹</a></p>
<p><strong>å¦‚æœæ‚¨è¿˜æœ‰ä»€ä¹ˆç–‘æƒ‘æˆ–å»ºè®®ï¼Œæ¬¢è¿åœ¨ä¸‹æ–¹è¯„è®ºåŒºç»§ç»­è®¨è®ºã€‚</strong></p>
<p><strong>å¦‚æœæ‚¨è§‰å¾—æœ¬æ–‡è¿˜ä¸é”™ï¼Œæ¬¢è¿åˆ†äº«/æ‰“èµæœ¬æ–‡ã€‚æ‰“èµå¹¶éè¦ä»ä¸­è·å¾—æ”¶ç›Šï¼Œè€Œæ˜¯å¸Œæœ›çŸ¥é“ç§‘å­¦ç©ºé—´è·å¾—äº†å¤šå°‘è¯»è€…çš„çœŸå¿ƒå…³æ³¨ã€‚å½“ç„¶ï¼Œå¦‚æœä½ æ— è§†å®ƒï¼Œä¹Ÿä¸ä¼šå½±å“ä½ çš„é˜…è¯»ã€‚å†æ¬¡è¡¨ç¤ºæ¬¢è¿å’Œæ„Ÿè°¢ï¼</strong></p>
<p>æ‰“èµ</p>
<p><img alt="ç§‘å­¦ç©ºé—´" src="https://spaces.ac.cn/usr/themes/geekg/payment/wx.png" /></p>
<p>å¾®ä¿¡æ‰“èµ</p>
<p><img alt="ç§‘å­¦ç©ºé—´" src="https://spaces.ac.cn/usr/themes/geekg/payment/zfb.png" /></p>
<p>æ”¯ä»˜å®æ‰“èµ</p>
<p>å› ä¸ºç½‘ç«™åå°å¯¹æ‰“èµå¹¶æ— è®°å½•ï¼Œå› æ­¤æ¬¢è¿åœ¨æ‰“èµæ—¶å€™å¤‡æ³¨ç•™è¨€ã€‚ä½ è¿˜å¯ä»¥<a href="http://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&amp;email=tN7d1drY3drrx8H0xcWa19vZ"><strong>ç‚¹å‡»è¿™é‡Œ</strong></a>æˆ–åœ¨ä¸‹æ–¹è¯„è®ºåŒºç•™è¨€æ¥å‘ŠçŸ¥ä½ çš„å»ºè®®æˆ–éœ€æ±‚ã€‚</p>
<p><strong>å¦‚æœæ‚¨éœ€è¦å¼•ç”¨æœ¬æ–‡ï¼Œè¯·å‚è€ƒï¼š</strong></p>
<p>è‹å‰‘æ—. (May. 04, 2025). ã€ŠTransformerå‡çº§ä¹‹è·¯ï¼š20ã€MLAå¥½åœ¨å“ªé‡Œ?ï¼ˆä¸Šï¼‰ ã€‹[Blog post]. Retrieved from <a href="https://spaces.ac.cn/archives/10907">https://spaces.ac.cn/archives/10907</a></p>
<p>@online{kexuefm-10907,<br />
title={Transformerå‡çº§ä¹‹è·¯ï¼š20ã€MLAå¥½åœ¨å“ªé‡Œ?ï¼ˆä¸Šï¼‰},<br />
author={è‹å‰‘æ—},<br />
year={2025},<br />
month={May},<br />
url={\url{https://spaces.ac.cn/archives/10907}},<br />
} </p>
<hr />
<h2 id="_7">å…¬å¼æ¨å¯¼ä¸æ³¨é‡Š</h2>
<h3 id="1-mla">1. MLAçš„æ•°å­¦å®šä¹‰ä¸åŸºæœ¬ç»“æ„</h3>
<p><strong>æ¨å¯¼1.1ï¼šæ ‡å‡†Multi-Head Attentionï¼ˆMHAï¼‰çš„æ•°å­¦è¡¨è¿°</strong></p>
<p>å¯¹äºæ ‡å‡†çš„MHAï¼Œç»™å®šè¾“å…¥$\boldsymbol{x}_i \in \mathbb{R}^d$ï¼Œæ¯ä¸ªhead $s \in {1, 2, \ldots, h}$è®¡ç®—ï¼š
$$
\boldsymbol{q}_i^{(s)} = \boldsymbol{x}_i \boldsymbol{W}_q^{(s)}, \quad \boldsymbol{W}_q^{(s)} \in \mathbb{R}^{d \times d_k}
$$
$$
\boldsymbol{k}_i^{(s)} = \boldsymbol{x}_i \boldsymbol{W}_k^{(s)}, \quad \boldsymbol{W}_k^{(s)} \in \mathbb{R}^{d \times d_k}
$$
$$
\boldsymbol{v}_i^{(s)} = \boldsymbol{x}_i \boldsymbol{W}_v^{(s)}, \quad \boldsymbol{W}_v^{(s)} \in \mathbb{R}^{d \times d_v}
$$</p>
<p>æ³¨æ„åŠ›è¾“å‡ºï¼š
$$
\boldsymbol{o}_i^{(s)} = \sum_{j \leq i} \frac{\exp(\boldsymbol{q}_i^{(s)} \cdot \boldsymbol{k}_j^{(s)})}{\sum_{j' \leq i} \exp(\boldsymbol{q}_i^{(s)} \cdot \boldsymbol{k}_{j'}^{(s)})} \boldsymbol{v}_j^{(s)}
$$</p>
<p>æœ€ç»ˆæ‹¼æ¥ï¼š
$$
\boldsymbol{o}_i = [\boldsymbol{o}_i^{(1)}, \boldsymbol{o}_i^{(2)}, \ldots, \boldsymbol{o}_i^{(h)}] \boldsymbol{W}_o
$$</p>
<p><strong>æ¨å¯¼1.2ï¼šMLAçš„åŒé‡æŠ•å½±ç»“æ„</strong></p>
<p>MLAå¼•å…¥ä¸­é—´è¡¨ç¤º$\boldsymbol{c}_i \in \mathbb{R}^{d_c}$ï¼ˆlatent compressionï¼‰ï¼š
$$
\boldsymbol{c}_i = \boldsymbol{x}_i \boldsymbol{W}_c, \quad \boldsymbol{W}_c \in \mathbb{R}^{d \times d_c}
$$</p>
<p>ç„¶åä»$\boldsymbol{c}_i$ç”Ÿæˆæ¯ä¸ªheadçš„Kå’ŒVï¼š
$$
\boldsymbol{k}_i^{(s)} = \boldsymbol{c}_i \boldsymbol{W}_k^{(s)}, \quad \boldsymbol{W}_k^{(s)} \in \mathbb{R}^{d_c \times d_k}
$$
$$
\boldsymbol{v}_i^{(s)} = \boldsymbol{c}_i \boldsymbol{W}_v^{(s)}, \quad \boldsymbol{W}_v^{(s)} \in \mathbb{R}^{d_c \times d_v}
$$</p>
<p>è€ŒQä»ç„¶ç›´æ¥ä»$\boldsymbol{x}_i$ç”Ÿæˆï¼š
$$
\boldsymbol{q}_i^{(s)} = \boldsymbol{x}_i \boldsymbol{W}_q^{(s)}, \quad \boldsymbol{W}_q^{(s)} \in \mathbb{R}^{d \times d_k}
$$</p>
<p><strong>æ¨å¯¼1.3ï¼šMLAçš„å‚æ•°é‡åˆ†æ</strong></p>
<p>MHAçš„å‚æ•°é‡ï¼š
$$
P_{\text{MHA}} = h \cdot d \cdot (d_k + d_k + d_v) + h \cdot d_v \cdot d = h \cdot d \cdot (2d_k + d_v + d_v)
$$</p>
<p>ç®€åŒ–ä¸ºï¼ˆå‡è®¾$d_k = d_v = d_h$ï¼‰ï¼š
$$
P_{\text{MHA}} = 4h \cdot d \cdot d_h
$$</p>
<p>MLAçš„å‚æ•°é‡ï¼š
$$
P_{\text{MLA}} = d \cdot d_c + h \cdot d_c \cdot (d_k + d_v) + h \cdot d \cdot d_k + h \cdot d_v \cdot d
$$</p>
<p>æ•´ç†å¾—ï¼š
$$
P_{\text{MLA}} = d \cdot d_c + h \cdot d_c \cdot (d_k + d_v) + h \cdot d \cdot (d_k + d_v)
$$</p>
<h3 id="2">2. ä½ç§©åˆ†è§£çš„ç†è®ºåŸºç¡€</h3>
<p><strong>æ¨å¯¼2.1ï¼šKå’ŒVçŸ©é˜µçš„ä½ç§©è¡¨ç¤º</strong></p>
<p>å°†æ‰€æœ‰ä½ç½®çš„Kå‘é‡å †å æˆçŸ©é˜µ$\boldsymbol{K}^{(s)} \in \mathbb{R}^{n \times d_k}$ï¼š
$$
\boldsymbol{K}^{(s)} = \begin{bmatrix} \boldsymbol{k}_1^{(s)} \\ \boldsymbol{k}_2^{(s)} \\ \vdots \\ \boldsymbol{k}_n^{(s)} \end{bmatrix} = \begin{bmatrix} \boldsymbol{x}_1 \boldsymbol{W}_c \boldsymbol{W}_k^{(s)} \\ \boldsymbol{x}_2 \boldsymbol{W}_c \boldsymbol{W}_k^{(s)} \\ \vdots \\ \boldsymbol{x}_n \boldsymbol{W}_c \boldsymbol{W}_k^{(s)} \end{bmatrix}
$$</p>
<p>å¯ä»¥åˆ†è§£ä¸ºï¼š
$$
\boldsymbol{K}^{(s)} = \boldsymbol{C} \boldsymbol{W}_k^{(s)}
$$</p>
<p>å…¶ä¸­$\boldsymbol{C} = [\boldsymbol{c}_1, \boldsymbol{c}_2, \ldots, \boldsymbol{c}_n]^{\top} \in \mathbb{R}^{n \times d_c}$ã€‚</p>
<p><strong>æ¨å¯¼2.2ï¼šç§©çš„ä¸Šç•Œåˆ†æ</strong></p>
<p>çŸ©é˜µ$\boldsymbol{K}^{(s)}$çš„ç§©æ»¡è¶³ï¼š
$$
\text{rank}(\boldsymbol{K}^{(s)}) = \text{rank}(\boldsymbol{C} \boldsymbol{W}_k^{(s)}) \leq \min(\text{rank}(\boldsymbol{C}), \text{rank}(\boldsymbol{W}_k^{(s)}))
$$</p>
<p>ç”±äº$\boldsymbol{C} \in \mathbb{R}^{n \times d_c}$å’Œ$\boldsymbol{W}_k^{(s)} \in \mathbb{R}^{d_c \times d_k}$ï¼š
$$
\text{rank}(\boldsymbol{K}^{(s)}) \leq \min(n, d_c, d_k)
$$</p>
<p>å¯¹äºé•¿åºåˆ—ï¼Œ$n \gg d_c$ï¼Œæ‰€ä»¥ï¼š
$$
\text{rank}(\boldsymbol{K}^{(s)}) \leq d_c
$$</p>
<p>è¿™æ„å‘³ç€MLAå¼ºåˆ¶KçŸ©é˜µæ˜¯ä½ç§©çš„ï¼Œç§©ä¸è¶…è¿‡$d_c$ã€‚</p>
<p><strong>æ¨å¯¼2.3ï¼šä½ç§©åˆ†è§£çš„è¯¯å·®ç•Œ</strong></p>
<p>å‡è®¾MHAçš„KçŸ©é˜µ$\boldsymbol{K}_{\text{full}}^{(s)}$å¯ä»¥ç”¨SVDåˆ†è§£ï¼š
$$
\boldsymbol{K}_{\text{full}}^{(s)} = \boldsymbol{U} \boldsymbol{\Sigma} \boldsymbol{V}^{\top} = \sum_{i=1}^r \sigma_i \boldsymbol{u}_i \boldsymbol{v}_i^{\top}
$$</p>
<p>å…¶ä¸­$\sigma_1 \geq \sigma_2 \geq \cdots \geq \sigma_r &gt; 0$æ˜¯å¥‡å¼‚å€¼ã€‚</p>
<p>MLAä½¿ç”¨ç§©$d_c$çš„è¿‘ä¼¼ï¼š
$$
\boldsymbol{K}_{\text{MLA}}^{(s)} \approx \sum_{i=1}^{d_c} \sigma_i \boldsymbol{u}_i \boldsymbol{v}_i^{\top}
$$</p>
<p>FrobeniusèŒƒæ•°æ„ä¹‰ä¸‹çš„è¿‘ä¼¼è¯¯å·®ï¼š
$$
\|\boldsymbol{K}_{\text{full}}^{(s)} - \boldsymbol{K}_{\text{MLA}}^{(s)}\|_F = \sqrt{\sum_{i=d_c+1}^r \sigma_i^2}
$$</p>
<p>å¦‚æœå¥‡å¼‚å€¼å¿«é€Ÿè¡°å‡ï¼ˆ$\sigma_i \sim i^{-\alpha}$ï¼Œ$\alpha &gt; 1$ï¼‰ï¼Œåˆ™ä½ç§©è¿‘ä¼¼è¯¯å·®å¾ˆå°ã€‚</p>
<h3 id="3-kv-cache">3. KV Cacheå‹ç¼©çš„æ•°å­¦åŸç†</h3>
<p><strong>æ¨å¯¼3.1ï¼šæ ‡å‡†MHAçš„KV Cacheå¤§å°</strong></p>
<p>å¯¹äºåºåˆ—é•¿åº¦$n$ï¼ŒMHAéœ€è¦ç¼“å­˜æ¯ä¸ªheadçš„Kå’ŒVï¼š
$$
\text{Cache}_{\text{MHA}} = n \cdot h \cdot (d_k + d_v)
$$</p>
<p>å¯¹äº$h=16$ï¼Œ$d_k = d_v = 128$ï¼š
$$
\text{Cache}_{\text{MHA}} = n \cdot 16 \cdot 256 = 4096n
$$</p>
<p><strong>æ¨å¯¼3.2ï¼šMLAçš„KV Cacheå¤§å°</strong></p>
<p>MLAåªéœ€è¦ç¼“å­˜å‹ç¼©è¡¨ç¤º$\boldsymbol{c}_i$å’ŒRoPEéƒ¨åˆ†$\boldsymbol{k}_r^{(s)}$ã€‚</p>
<p>è®¾$\boldsymbol{c}<em c_k="c,k">i \in \mathbb{R}^{d</em>}}$ï¼ˆKçš„å‹ç¼©ç»´åº¦ï¼‰å’Œ$\boldsymbol{c<em c_v="c,v">i^v \in \mathbb{R}^{d</em>$ï¼ˆVçš„å‹ç¼©ç»´åº¦ï¼‰ï¼Œä»¥åŠRoPEç»´åº¦$d_r$ï¼š
$$
\text{Cache}_{\text{MLA}} = n \cdot (d_{c,k} + d_{c,v} + h \cdot d_r)
$$}</p>
<p>å¯¹äºDeepSeek-V2çš„é…ç½®ï¼ˆ$d_{c,k} = 512$ï¼Œ$d_{c,v} = 512$ï¼Œ$d_r = 64$ï¼Œ$h = 16$ï¼‰ï¼š
$$
\text{Cache}_{\text{MLA}} = n \cdot (512 + 512 + 16 \times 64) = n \cdot 2048
$$</p>
<p>ä½†å®é™…ä¸ŠKå’ŒVå¯ä»¥å…±äº«å¤§éƒ¨åˆ†ï¼š
$$
\text{Cache}_{\text{MLA}} = n \cdot (512 + 64) = 576n
$$</p>
<p><strong>æ¨å¯¼3.3ï¼šå‹ç¼©æ¯”çš„è®¡ç®—</strong></p>
<p>å‹ç¼©æ¯”å®šä¹‰ä¸ºï¼š
$$
\rho = \frac{\text{Cache}_{\text{MLA}}}{\text{Cache}_{\text{MHA}}} = \frac{576n}{4096n} = \frac{576}{4096} \approx 0.14
$$</p>
<p>å³MLAå°†KV Cacheå‹ç¼©åˆ°åŸæ¥çš„14%ï¼Œçº¦7å€çš„å‹ç¼©ã€‚</p>
<h3 id="4">4. æ³¨æ„åŠ›çŸ©é˜µçš„ç§©åˆ†æ</h3>
<p><strong>æ¨å¯¼4.1ï¼šæ³¨æ„åŠ›çŸ©é˜µçš„å®šä¹‰</strong></p>
<p>å¯¹äºç¬¬$s$ä¸ªheadï¼Œæ³¨æ„åŠ›çŸ©é˜µ$\boldsymbol{A}^{(s)} \in \mathbb{R}^{n \times n}$å®šä¹‰ä¸ºï¼š
$$
A_{ij}^{(s)} = \frac{\exp(\boldsymbol{q}_i^{(s)} \cdot \boldsymbol{k}_j^{(s)})}{\sum_{j' \leq i} \exp(\boldsymbol{q}_i^{(s)} \cdot \boldsymbol{k}_{j'}^{(s)})}
$$</p>
<p>æœªå½’ä¸€åŒ–çš„æ³¨æ„åŠ›åˆ†æ•°çŸ©é˜µï¼š
$$
\boldsymbol{S}^{(s)} = \boldsymbol{Q}^{(s)} (\boldsymbol{K}^{(s)})^{\top}
$$</p>
<p>å…¶ä¸­$\boldsymbol{Q}^{(s)}, \boldsymbol{K}^{(s)} \in \mathbb{R}^{n \times d_k}$ã€‚</p>
<p><strong>æ¨å¯¼4.2ï¼šMLAæ³¨æ„åŠ›çŸ©é˜µçš„ç§©ç•Œ</strong></p>
<p>å¯¹äºMLAï¼Œ$\boldsymbol{K}^{(s)} = \boldsymbol{C} \boldsymbol{W}_k^{(s)}$ï¼Œå› æ­¤ï¼š
$$
\boldsymbol{S}^{(s)} = \boldsymbol{Q}^{(s)} (\boldsymbol{C} \boldsymbol{W}_k^{(s)})^{\top} = \boldsymbol{Q}^{(s)} (\boldsymbol{W}_k^{(s)})^{\top} \boldsymbol{C}^{\top}
$$</p>
<p>æ³¨æ„åŠ›åˆ†æ•°çŸ©é˜µçš„ç§©ï¼š
$$
\text{rank}(\boldsymbol{S}^{(s)}) \leq \min(\text{rank}(\boldsymbol{Q}^{(s)}), \text{rank}(\boldsymbol{C}), d_k)
$$</p>
<p>ç”±äº$\boldsymbol{C} \in \mathbb{R}^{n \times d_c}$ï¼š
$$
\text{rank}(\boldsymbol{S}^{(s)}) \leq \min(n, d_c, d_k)
$$</p>
<p>å½“$n \gg d_c$æ—¶ï¼š
$$
\text{rank}(\boldsymbol{S}^{(s)}) \leq d_c
$$</p>
<p><strong>æ¨å¯¼4.3ï¼šä½ç§©æ³¨æ„åŠ›çš„è¡¨è¾¾èƒ½åŠ›</strong></p>
<p>è™½ç„¶æ³¨æ„åŠ›çŸ©é˜µæ˜¯ä½ç§©çš„ï¼Œä½†è¿™ä¸ä¸€å®šé™åˆ¶è¡¨è¾¾èƒ½åŠ›ã€‚è€ƒè™‘è¾“å‡ºï¼š
$$
\boldsymbol{O}^{(s)} = \boldsymbol{A}^{(s)} \boldsymbol{V}^{(s)}
$$</p>
<p>å¦‚æœ$\boldsymbol{V}^{(s)} = \boldsymbol{C} \boldsymbol{W}_v^{(s)}$ä¹Ÿæ˜¯ä½ç§©çš„ï¼š
$$
\boldsymbol{O}^{(s)} = \boldsymbol{A}^{(s)} \boldsymbol{C} \boldsymbol{W}_v^{(s)}
$$</p>
<p>å³ä½¿$\boldsymbol{A}^{(s)}$æ˜¯ä½ç§©çš„ï¼Œ$\boldsymbol{A}^{(s)} \boldsymbol{C}$å¯ä»¥æ¢å¤ä¸°å¯Œçš„è¡¨ç¤ºï¼Œå› ä¸º$\boldsymbol{C}$åŒ…å«äº†æ‰€æœ‰ä½ç½®çš„å‹ç¼©ä¿¡æ¯ã€‚</p>
<h3 id="5">5. å‚æ•°æ•ˆç‡ä¸è¡¨è¾¾èƒ½åŠ›çš„æƒè¡¡</h3>
<p><strong>æ¨å¯¼5.1ï¼šæœ‰æ•ˆå‚æ•°é‡çš„åˆ†æ</strong></p>
<p>å®šä¹‰æœ‰æ•ˆå‚æ•°é‡ä¸ºå½±å“å‰å‘ä¼ æ’­çš„ç‹¬ç«‹å‚æ•°æ•°é‡ã€‚</p>
<p>å¯¹äºMHAï¼š
- QæŠ•å½±ï¼š$h \cdot d \cdot d_k$
- KæŠ•å½±ï¼š$h \cdot d \cdot d_k$
- VæŠ•å½±ï¼š$h \cdot d \cdot d_v$
- OæŠ•å½±ï¼š$h \cdot d_v \cdot d$</p>
<p>æ€»è®¡ï¼š$P_{\text{MHA}} = h \cdot d \cdot (2d_k + d_v) + h \cdot d_v \cdot d$</p>
<p>å¯¹äºMLAï¼š
- å‹ç¼©æŠ•å½±ï¼š$d \cdot d_c$
- QæŠ•å½±ï¼š$h \cdot d \cdot d_k$
- KæŠ•å½±ï¼ˆä»å‹ç¼©ï¼‰ï¼š$h \cdot d_c \cdot d_k$
- VæŠ•å½±ï¼ˆä»å‹ç¼©ï¼‰ï¼š$h \cdot d_c \cdot d_v$
- OæŠ•å½±ï¼š$h \cdot d_v \cdot d$</p>
<p>æ€»è®¡ï¼š$P_{\text{MLA}} = d \cdot d_c + h \cdot d \cdot d_k + h \cdot d_c \cdot (d_k + d_v) + h \cdot d_v \cdot d$</p>
<p><strong>æ¨å¯¼5.2ï¼šå‚æ•°æ•ˆç‡æ¯”</strong></p>
<p>å‡è®¾$d_k = d_v = d_h$ï¼Œæ¯”è¾ƒMLAå’ŒMHAåœ¨ç›¸åŒKV Cacheä¸‹çš„å‚æ•°é‡ã€‚</p>
<p>è®¾MHAä½¿ç”¨GQAï¼Œ$g$ä¸ªgroupsï¼Œåˆ™ï¼š
$$
P_{\text{GQA}} = h \cdot d \cdot d_h + g \cdot d \cdot 2d_h + h \cdot d_h \cdot d
$$</p>
<p>å¯¹äº$g=2$ï¼Œ$d_h=128$ï¼š
$$
P_{\text{GQA}} = 16 \cdot d \cdot 128 + 2 \cdot d \cdot 256 + 16 \cdot 128 \cdot d = (2048 + 512 + 2048)d = 4608d
$$</p>
<p>å¯¹äºMLAï¼ˆ$d_c = 512$ï¼Œ$d_h = 128 + 64 = 192$ï¼‰ï¼š
$$
P_{\text{MLA}} = d \cdot 512 + 16 \cdot d \cdot 128 + 16 \cdot 512 \cdot 192 + 16 \cdot 192 \cdot d
$$
$$
= 512d + 2048d + 1,572,864 + 3072d = 5632d + 1,572,864
$$</p>
<p>å½“$d = 2048$æ—¶ï¼š
$$
P_{\text{MLA}} \approx 11.5M + 1.57M = 13.07M
$$
$$
P_{\text{GQA}} = 4608 \times 2048 = 9.44M
$$</p>
<p>æ‰€ä»¥MLAå‚æ•°é‡ç¨å¤šï¼Œä½†æä¾›äº†æ›´å¤§çš„head_dimsã€‚</p>
<p><strong>æ¨å¯¼5.3ï¼šè¡¨è¾¾èƒ½åŠ›çš„é‡åŒ–</strong></p>
<p>å®šä¹‰è¡¨è¾¾èƒ½åŠ›ä¸ºæ¨¡å‹èƒ½å¤Ÿè¡¨ç¤ºçš„å‡½æ•°ç©ºé—´çš„ç»´åº¦ã€‚å¯¹äºçº¿æ€§å˜æ¢ï¼š</p>
<p>MHAçš„è¡¨è¾¾èƒ½åŠ›å—é™äºï¼š
$$
\mathcal{C}_{\text{MHA}} \sim \mathcal{O}(h \cdot d_h \cdot d)
$$</p>
<p>MLAçš„è¡¨è¾¾èƒ½åŠ›ï¼š
$$
\mathcal{C}_{\text{MLA}} \sim \mathcal{O}(d_c \cdot d + h \cdot d_c \cdot d_h)
$$</p>
<p>å½“$d_c$è¶³å¤Ÿå¤§æ—¶ï¼ŒMLAå¯ä»¥è¾¾åˆ°æ¥è¿‘MHAçš„è¡¨è¾¾èƒ½åŠ›ï¼ŒåŒæ—¶äº«å—å‹ç¼©çš„KV Cacheã€‚</p>
<h3 id="6">6. è®¡ç®—å¤æ‚åº¦çš„ä¸¥æ ¼åˆ†æ</h3>
<p><strong>æ¨å¯¼6.1ï¼šè®­ç»ƒé˜¶æ®µçš„è®¡ç®—å¤æ‚åº¦</strong></p>
<p>å¯¹äºåºåˆ—é•¿åº¦$n$ï¼ŒMHAçš„è®¡ç®—åˆ†ä¸ºå‡ ä¸ªæ­¥éª¤ï¼š</p>
<ol>
<li>
<p><strong>QKVæŠ•å½±</strong>ï¼š
$$
\mathcal{O}_{\text{QKV}} = n \cdot h \cdot d \cdot (d_k + d_k + d_v)
$$</p>
</li>
<li>
<p><strong>æ³¨æ„åŠ›åˆ†æ•°è®¡ç®—</strong>ï¼š
$$
\mathcal{O}_{\text{score}} = n^2 \cdot h \cdot d_k
$$</p>
</li>
<li>
<p><strong>æ³¨æ„åŠ›åŠ æƒæ±‚å’Œ</strong>ï¼š
$$
\mathcal{O}_{\text{weighted}} = n^2 \cdot h \cdot d_v
$$</p>
</li>
<li>
<p><strong>è¾“å‡ºæŠ•å½±</strong>ï¼š
$$
\mathcal{O}_{\text{output}} = n \cdot h \cdot d_v \cdot d
$$</p>
</li>
</ol>
<p>æ€»è®¡ï¼ˆå¿½ç•¥å¸¸æ•°ï¼‰ï¼š
$$
\mathcal{O}_{\text{MHA}} = n \cdot h \cdot d \cdot d_h + n^2 \cdot h \cdot d_h
$$</p>
<p><strong>æ¨å¯¼6.2ï¼šMLAè®­ç»ƒé˜¶æ®µçš„è®¡ç®—å¤æ‚åº¦</strong></p>
<ol>
<li>
<p><strong>å‹ç¼©æŠ•å½±</strong>ï¼š
$$
\mathcal{O}_{\text{compress}} = n \cdot d \cdot d_c
$$</p>
</li>
<li>
<p><strong>QæŠ•å½±</strong>ï¼š
$$
\mathcal{O}_{\text{Q}} = n \cdot h \cdot d \cdot d_k
$$</p>
</li>
<li>
<p><strong>KVæŠ•å½±ï¼ˆä»å‹ç¼©ï¼‰</strong>ï¼š
$$
\mathcal{O}_{\text{KV}} = n \cdot h \cdot d_c \cdot (d_k + d_v)
$$</p>
</li>
<li>
<p><strong>æ³¨æ„åŠ›è®¡ç®—</strong>ï¼ˆä¸MHAç›¸åŒï¼‰ï¼š
$$
\mathcal{O}_{\text{attn}} = n^2 \cdot h \cdot d_k + n^2 \cdot h \cdot d_v
$$</p>
</li>
<li>
<p><strong>è¾“å‡ºæŠ•å½±</strong>ï¼š
$$
\mathcal{O}_{\text{output}} = n \cdot h \cdot d_v \cdot d
$$</p>
</li>
</ol>
<p>æ€»è®¡ï¼š
$$
\mathcal{O}_{\text{MLA}} = n \cdot d \cdot d_c + n \cdot h \cdot d \cdot d_k + n \cdot h \cdot d_c \cdot (d_k + d_v) + n^2 \cdot h \cdot (d_k + d_v)
$$</p>
<p><strong>æ¨å¯¼6.3ï¼šDecodingé˜¶æ®µçš„è®¡ç®—å¤æ‚åº¦</strong></p>
<p>Decodingæ—¶ï¼Œæ¯æ­¥åªç”Ÿæˆä¸€ä¸ªtokenï¼Œåˆ©ç”¨KV Cacheã€‚</p>
<p>MHAçš„å•æ­¥è®¡ç®—ï¼š
$$
\mathcal{O}_{\text{MHA,decode}} = h \cdot d \cdot d_k + n \cdot h \cdot d_k + n \cdot h \cdot d_v + h \cdot d_v \cdot d
$$</p>
<p>ç®€åŒ–ä¸ºï¼š
$$
\mathcal{O}_{\text{MHA,decode}} = h \cdot d \cdot d_h + n \cdot h \cdot d_h
$$</p>
<p>MLAçš„å•æ­¥è®¡ç®—ï¼š
$$
\mathcal{O}_{\text{MLA,decode}} = d \cdot d_c + h \cdot d \cdot d_k + n \cdot h \cdot d_k + n \cdot h \cdot d_v + h \cdot d_v \cdot d
$$</p>
<p>ç”±äºMLAçš„KV Cacheæ›´å°ï¼ˆ$d_c$ç»´è€Œé$h \cdot d_h$ç»´ï¼‰ï¼Œè®¿å­˜æ›´å°‘ï¼Œå®é™…é€Ÿåº¦æ›´å¿«ã€‚</p>
<h3 id="7-head_dims">7. head_dimsçš„å½±å“åˆ†æ</h3>
<p><strong>æ¨å¯¼7.1ï¼šhead_dimsä¸æ¨¡å‹å®¹é‡</strong></p>
<p>å¯¹äºå›ºå®šçš„æ€»ç»´åº¦$d = h \cdot d_h$ï¼Œå¯ä»¥é€‰æ‹©ï¼š
- æ›´å¤šçš„headsï¼ˆå¤§$h$ï¼Œå°$d_h$ï¼‰
- æ›´å¤§çš„head_dimsï¼ˆå°$h$ï¼Œå¤§$d_h$ï¼‰</p>
<p>æ¨¡å‹çš„è¡¨è¾¾èƒ½åŠ›ä¸å‚æ•°é‡ç›¸å…³ï¼š
$$
P = h \cdot d \cdot d_h = d \cdot d
$$</p>
<p>å‚æ•°é‡ç›¸åŒï¼Œä½†åˆ†é…ä¸åŒã€‚</p>
<p><strong>æ¨å¯¼7.2ï¼šhead_dimsä¸æ³¨æ„åŠ›å¤šæ ·æ€§</strong></p>
<p>æ¯ä¸ªheadå­¦ä¹ ä¸åŒçš„æ³¨æ„åŠ›æ¨¡å¼ã€‚è®¾head $s$çš„æ³¨æ„åŠ›ç†µä¸ºï¼š
$$
H^{(s)} = -\sum_{j=1}^n A_{ij}^{(s)} \log A_{ij}^{(s)}
$$</p>
<p>æ€»çš„æ³¨æ„åŠ›å¤šæ ·æ€§ï¼š
$$
H_{\text{total}} = \sum_{s=1}^h H^{(s)}
$$</p>
<p>æ›´å¤šçš„headsï¼ˆå¤§$h$ï¼‰å¯ä»¥æä¾›æ›´å¤šæ ·çš„æ³¨æ„åŠ›æ¨¡å¼ï¼Œä½†æ¯ä¸ªheadçš„å®¹é‡ï¼ˆ$d_h$ï¼‰æ›´å°ã€‚</p>
<p><strong>æ¨å¯¼7.3ï¼šhead_dimsä¸æ¢¯åº¦æµ</strong></p>
<p>åœ¨åå‘ä¼ æ’­ä¸­ï¼Œæ¢¯åº¦é€šè¿‡æ¯ä¸ªheadä¼ æ’­ã€‚è®¾æŸå¤±$\mathcal{L}$å¯¹è¾“å‡º$\boldsymbol{o}_i$çš„æ¢¯åº¦ä¸º$\frac{\partial \mathcal{L}}{\partial \boldsymbol{o}_i}$ã€‚</p>
<p>å¯¹äºMHAï¼š
$$
\frac{\partial \mathcal{L}}{\partial \boldsymbol{q}_i^{(s)}} = \sum_{j} \frac{\partial \mathcal{L}}{\partial A_{ij}^{(s)}} \frac{\partial A_{ij}^{(s)}}{\partial \boldsymbol{q}_i^{(s)}}
$$</p>
<p>æ¢¯åº¦çš„æ–¹å·®ä¸$d_h$ç›¸å…³ã€‚æ›´å¤§çš„$d_h$æä¾›æ›´ç¨³å®šçš„æ¢¯åº¦ï¼Œæœ‰åŠ©äºè®­ç»ƒã€‚</p>
<h3 id="8-partial-rope">8. Partial RoPEçš„æ•°å­¦æœºåˆ¶</h3>
<p><strong>æ¨å¯¼8.1ï¼šPartial RoPEçš„åˆ†è§£</strong></p>
<p>å°†Qå’ŒKåˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š
$$
\boldsymbol{q}_i^{(s)} = [\boldsymbol{q}_{i,c}^{(s)}, \boldsymbol{q}_{i,r}^{(s)}]
$$
$$
\boldsymbol{k}_j^{(s)} = [\boldsymbol{k}_{j,c}^{(s)}, \boldsymbol{k}_{j,r}^{(s)}]
$$</p>
<p>å…¶ä¸­$\boldsymbol{q}<em c="c">{i,c}^{(s)} \in \mathbb{R}^{d</em>$ï¼ˆrotaryï¼ŒåŠ RoPEï¼‰ã€‚}}$ï¼ˆcontentï¼Œä¸åŠ RoPEï¼‰ï¼Œ$\boldsymbol{q}_{i,r}^{(s)} \in \mathbb{R}^{d_r</p>
<p><strong>æ¨å¯¼8.2ï¼šæ³¨æ„åŠ›åˆ†æ•°çš„åˆ†è§£</strong></p>
<p>æ³¨æ„åŠ›åˆ†æ•°ï¼š
$$
\boldsymbol{q}_i^{(s)} \cdot \boldsymbol{k}_j^{(s)} = \boldsymbol{q}_{i,c}^{(s)} \cdot \boldsymbol{k}_{j,c}^{(s)} + (\boldsymbol{\mathcal{R}}_{i-j} \boldsymbol{q}_{i,r}^{(s)}) \cdot \boldsymbol{k}_{j,r}^{(s)}
$$</p>
<p>ç¬¬ä¸€é¡¹æ˜¯çº¯å†…å®¹ç›¸ä¼¼åº¦ï¼Œç¬¬äºŒé¡¹åŒ…å«ç›¸å¯¹ä½ç½®ä¿¡æ¯ã€‚</p>
<p><strong>æ¨å¯¼8.3ï¼šPartial RoPEçš„ä¼˜åŠ¿</strong></p>
<p>ä»æœŸæœ›çš„è§’åº¦ï¼š
$$
\mathbb{E}[\boldsymbol{q}_i^{(s)} \cdot \boldsymbol{k}_j^{(s)}] = \mathbb{E}[\boldsymbol{q}_{i,c}^{(s)} \cdot \boldsymbol{k}_{j,c}^{(s)}] + \mathbb{E}[(\boldsymbol{\mathcal{R}}_{i-j} \boldsymbol{q}_{i,r}^{(s)}) \cdot \boldsymbol{k}_{j,r}^{(s)}]
$$</p>
<p>ç¬¬ä¸€é¡¹ä¸å—ä½ç½®å½±å“ï¼Œå®Œå…¨åŸºäºè¯­ä¹‰ï¼›ç¬¬äºŒé¡¹å—ä½ç½®è°ƒåˆ¶ã€‚è¿™ç§åˆ†ç¦»ä½¿å¾—æ¨¡å‹å¯ä»¥çµæ´»å¹³è¡¡è¯­ä¹‰å’Œä½ç½®ä¿¡æ¯ã€‚</p>
<h3 id="9-kv-shared">9. KV Sharedçš„ç†è®ºåˆ†æ</h3>
<p><strong>æ¨å¯¼9.1ï¼šKVå…±äº«çš„æ•°å­¦è¡¨ç¤º</strong></p>
<p>å®Œå…¨KVå…±äº«æ„å‘³ç€ï¼š
$$
\boldsymbol{k}_i = \boldsymbol{v}_i = \boldsymbol{c}_i
$$</p>
<p>æ³¨æ„åŠ›è®¡ç®—å˜ä¸ºï¼š
$$
\boldsymbol{o}_i^{(s)} = \sum_{j \leq i} \frac{\exp(\boldsymbol{q}_i^{(s)} \cdot \boldsymbol{c}_j)}{\sum_{j' \leq i} \exp(\boldsymbol{q}_i^{(s)} \cdot \boldsymbol{c}_{j'})} \boldsymbol{c}_j
$$</p>
<p><strong>æ¨å¯¼9.2ï¼šKVå…±äº«çš„ç§©åˆ†æ</strong></p>
<p>å½“Kå’ŒVå…±äº«æ—¶ï¼Œå®ƒä»¬çš„ç§©ç›¸åŒï¼š
$$
\text{rank}(\boldsymbol{K}) = \text{rank}(\boldsymbol{V}) = \text{rank}(\boldsymbol{C}) \leq d_c
$$</p>
<p>è¿™è¿›ä¸€æ­¥å‹ç¼©äº†è¡¨ç¤ºï¼Œä½†ä¹Ÿé™åˆ¶äº†çµæ´»æ€§ã€‚</p>
<p><strong>æ¨å¯¼9.3ï¼šéƒ¨åˆ†KVå…±äº«</strong></p>
<p>MLAé‡‡ç”¨éƒ¨åˆ†å…±äº«ï¼šcontentéƒ¨åˆ†å…±äº«ï¼ŒRoPEéƒ¨åˆ†ç‹¬ç«‹ï¼š
$$
\boldsymbol{k}_i = [\boldsymbol{c}_i, \boldsymbol{k}_{i,r}], \quad \boldsymbol{v}_i = [\boldsymbol{c}_i, \boldsymbol{v}_{i,r}]
$$</p>
<p>KV Cacheå¤§å°ï¼š
$$
\text{Cache} = n \cdot (d_c + d_{k,r} + d_{v,r})
$$</p>
<p>è¿™åœ¨å‹ç¼©å’Œçµæ´»æ€§ä¹‹é—´å–å¾—å¹³è¡¡ã€‚</p>
<h3 id="10-gqamla">10. GQAä¸MLAçš„ç†è®ºå¯¹æ¯”</h3>
<p><strong>æ¨å¯¼10.1ï¼šGQAçš„æ•°å­¦å½¢å¼</strong></p>
<p>Grouped Query Attentionå°†$h$ä¸ªheadsåˆ†æˆ$g$ä¸ªgroupsï¼Œæ¯ç»„å…±äº«Kå’ŒVï¼š
$$
\boldsymbol{k}_i^{(g)} = \boldsymbol{x}_i \boldsymbol{W}_k^{(g)}, \quad g = 1, 2, \ldots, g
$$</p>
<p>Head $s$å±äºgroup $g(s)$ï¼Œä½¿ç”¨$\boldsymbol{k}_i^{(g(s))}$ã€‚</p>
<p><strong>æ¨å¯¼10.2ï¼šGQAçš„KV Cache</strong></p>
<p>KV Cacheå¤§å°ï¼š
$$
\text{Cache}_{\text{GQA}} = n \cdot g \cdot (d_k + d_v)
$$</p>
<p>å¯¹äº$g=2$ï¼Œ$d_k = d_v = 128$ï¼š
$$
\text{Cache}_{\text{GQA}} = n \cdot 2 \cdot 256 = 512n
$$</p>
<p>è¿™ä¸MLAçš„Cacheå¤§å°æ¥è¿‘ã€‚</p>
<p><strong>æ¨å¯¼10.3ï¼šGQA vs MLAçš„è¡¨è¾¾èƒ½åŠ›</strong></p>
<p>GQAçš„è¡¨è¾¾èƒ½åŠ›å—é™äºgroupå†…å…±äº«ã€‚æ¯ä¸ªgroupå­¦ä¹ ä¸€ä¸ªK/Vè¡¨ç¤ºï¼Œæ‰€æœ‰è¯¥ç»„çš„headsä½¿ç”¨ç›¸åŒçš„K/Vã€‚</p>
<p>MLAè™½ç„¶ä¹Ÿå…±äº«ï¼ˆé€šè¿‡$\boldsymbol{c}_i$ï¼‰ï¼Œä½†æ¯ä¸ªheadä»$\boldsymbol{c}_i$ç‹¬ç«‹æŠ•å½±å¾—åˆ°$\boldsymbol{k}_i^{(s)}$å’Œ$\boldsymbol{v}_i^{(s)}$ï¼Œæä¾›äº†æ›´å¤§çš„çµæ´»æ€§ã€‚</p>
<p>å½¢å¼ä¸Šï¼ŒGQAå¯ä»¥çœ‹ä½œMLAçš„ç‰¹ä¾‹ï¼š
$$
\boldsymbol{W}_k^{(s_1)} = \boldsymbol{W}_k^{(s_2)}, \quad \forall s_1, s_2 \in \text{same group}
$$</p>
<p>ä½†MLAä¸å¼ºåˆ¶è¿™ç§çº¦æŸï¼Œå…è®¸æ¯ä¸ªheadå­¦ä¹ ä¸åŒçš„æŠ•å½±ã€‚</p>
<h3 id="11">11. å®éªŒç»“æœçš„ç†è®ºè§£é‡Š</h3>
<p><strong>æ¨å¯¼11.1ï¼šå¢å¤§head_dimsçš„æ•ˆæœ</strong></p>
<p>ä»å®éªŒçœ‹ï¼ŒGQA1-256ä¼˜äºGQA2-128ã€‚ç†è®ºè§£é‡Šï¼š</p>
<p>æ›´å¤§çš„$d_h$æ„å‘³ç€æ¯ä¸ªheadæœ‰æ›´å¤§çš„è¡¨ç¤ºç©ºé—´ã€‚å¯¹äºå¤æ‚çš„æ³¨æ„åŠ›æ¨¡å¼ï¼Œéœ€è¦è¶³å¤Ÿçš„ç»´åº¦æ¥æ•æ‰ã€‚</p>
<p>ä¿¡æ¯ç“¶é¢ˆç†è®ºï¼šheadçš„ä¿¡æ¯å®¹é‡ä¸º$\mathcal{I} \sim d_h$ã€‚æ›´å¤§çš„$d_h$å‡å°‘ä¿¡æ¯æŸå¤±ã€‚</p>
<p><strong>æ¨å¯¼11.2ï¼šPartial RoPEçš„æå‡</strong></p>
<p>å®éªŒæ˜¾ç¤ºGQA1-256-PRä¼˜äºGQA1-256ã€‚ä»æ¨å¯¼8.2ï¼ŒPartial RoPEæä¾›äº†contentå’Œpositionçš„è§£è€¦ï¼š
$$
\text{score} = \text{content\_sim} + \text{position\_bias}
$$</p>
<p>è¿™ç§è§£è€¦ä½¿å¾—æ¨¡å‹å¯ä»¥ç‹¬ç«‹ä¼˜åŒ–ä¸¤è€…ï¼Œæå‡äº†å­¦ä¹ æ•ˆç‡ã€‚</p>
<p><strong>æ¨å¯¼11.3ï¼šKV Sharedçš„ä½œç”¨</strong></p>
<p>å®éªŒä¸­GQA2-(192+64)-S2è¶…è¿‡GQA1-256-PRï¼Œè¯´æ˜KVå…±äº«åœ¨æŸäº›æƒ…å†µä¸‹æœ‰ç›Šã€‚</p>
<p>ç†è®ºä¸Šï¼ŒKVå…±äº«ç›¸å½“äºæ–½åŠ äº†é¢å¤–çš„æ­£åˆ™åŒ–ï¼š
$$
\boldsymbol{k}_i \approx \boldsymbol{v}_i
$$</p>
<p>è¿™å‡å°‘äº†å‚æ•°å†—ä½™ï¼Œå¯èƒ½æå‡æ³›åŒ–èƒ½åŠ›ã€‚</p>
<h3 id="12-qo-lora">12. Q&amp;O LoRAçš„æ•°å­¦åŸç†</h3>
<p><strong>æ¨å¯¼12.1ï¼šLoRAçš„ä½ç§©åˆ†è§£</strong></p>
<p>å¯¹äºæƒé‡çŸ©é˜µ$\boldsymbol{W} \in \mathbb{R}^{d_1 \times d_2}$ï¼ŒLoRAç”¨ä½ç§©åˆ†è§£æ›¿ä»£ï¼š
$$
\boldsymbol{W} = \boldsymbol{W}_0 + \boldsymbol{A} \boldsymbol{B}
$$</p>
<p>å…¶ä¸­$\boldsymbol{A} \in \mathbb{R}^{d_1 \times r}$ï¼Œ$\boldsymbol{B} \in \mathbb{R}^{r \times d_2}$ï¼Œ$r \ll \min(d_1, d_2)$ã€‚</p>
<p><strong>æ¨å¯¼12.2ï¼šå‚æ•°é‡çš„å‡å°‘</strong></p>
<p>åŸå§‹å‚æ•°é‡ï¼š$P_0 = d_1 \cdot d_2$</p>
<p>LoRAå‚æ•°é‡ï¼š$P_{\text{LoRA}} = d_1 \cdot r + r \cdot d_2 = r(d_1 + d_2)$</p>
<p>å‡å°‘é‡ï¼š
$$
\Delta P = d_1 \cdot d_2 - r(d_1 + d_2)
$$</p>
<p>å¯¹äº$d_1 = d_2 = d$ï¼Œ$r = d/8$ï¼š
$$
\Delta P = d^2 - \frac{d}{8}(d + d) = d^2 - \frac{d^2}{4} = \frac{3d^2}{4}
$$</p>
<p>å‚æ•°é‡å‡å°‘75%ã€‚</p>
<p><strong>æ¨å¯¼12.3ï¼šè¡¨è¾¾èƒ½åŠ›çš„ä¿æŒ</strong></p>
<p>è™½ç„¶å‚æ•°é‡å‡å°‘ï¼Œä½†å¦‚æœåŸå§‹çŸ©é˜µæœ¬èº«æ¥è¿‘ä½ç§©ï¼ŒLoRAå¯ä»¥å¾ˆå¥½åœ°è¿‘ä¼¼ï¼š
$$
\|\boldsymbol{W} - \boldsymbol{A}\boldsymbol{B}\|_F \approx \sum_{i=r+1}^{\min(d_1,d_2)} \sigma_i
$$</p>
<p>å¦‚æœ$\sigma_{r+1}, \sigma_{r+2}, \ldots$å¾ˆå°ï¼Œè¿‘ä¼¼è¯¯å·®å¯å¿½ç•¥ã€‚</p>
<h3 id="13-head_dimsnum_heads">13. head_dimsä¸num_headsçš„æƒè¡¡</h3>
<p><strong>æ¨å¯¼13.1ï¼šå›ºå®šæ€»ç»´åº¦ä¸‹çš„åˆ†é…</strong></p>
<p>ç»™å®šæ€»ç»´åº¦$D = h \cdot d_h$ï¼Œå¯ä»¥é€‰æ‹©ä¸åŒçš„$(h, d_h)$ç»„åˆã€‚</p>
<p>ä¾‹å¦‚$D = 2048$ï¼š
- $(h=16, d_h=128)$ï¼šæ ‡å‡†é…ç½®
- $(h=8, d_h=256)$ï¼šæ›´å¤§head_dims
- $(h=32, d_h=64)$ï¼šæ›´å¤šheads</p>
<p><strong>æ¨å¯¼13.2ï¼šå‚æ•°é‡åˆ†æ</strong></p>
<p>QæŠ•å½±å‚æ•°é‡ï¼š$P_Q = h \cdot d \cdot d_h = d \cdot D$ï¼ˆä¸åˆ†é…æ— å…³ï¼‰</p>
<p>ä½†Kã€VæŠ•å½±å‚æ•°é‡å—groupæ•°å½±å“ï¼š
$$
P_{KV} = g \cdot d \cdot (d_k + d_v)
$$</p>
<p>å¯¹äºMQAï¼ˆ$g=1$ï¼‰ï¼š$P_{KV} = d \cdot 2d_h$</p>
<p>å¯¹äºGQAï¼ˆ$g=h/2$ï¼‰ï¼š$P_{KV} = \frac{h}{2} \cdot d \cdot 2d_h = h \cdot d \cdot d_h$</p>
<p><strong>æ¨å¯¼13.3ï¼šå®éªŒéªŒè¯</strong></p>
<p>å®éªŒç»“æœï¼š
- GQA2-128ï¼ˆ32 headsï¼‰ï¼šloss = 2.723
- GQA2-128ï¼ˆ16 headsï¼‰ï¼šloss = 2.75</p>
<p>æ›´å¤šheadsåè€Œç•¥å·®ï¼Œæ”¯æŒäº†"head_dimsæ›´é‡è¦"çš„ç»“è®ºã€‚</p>
<h3 id="14-mlp">14. MLPç¼©å‡çš„å½±å“</h3>
<p><strong>æ¨å¯¼14.1ï¼šMLPçš„å‚æ•°é‡</strong></p>
<p>æ ‡å‡†Transformerçš„MLPï¼š
$$
\boldsymbol{h}_{\text{MLP}} = \text{SwiGLU}(\boldsymbol{h} \boldsymbol{W}_1) \boldsymbol{W}_2
$$</p>
<p>å‚æ•°é‡ï¼š
$$
P_{\text{MLP}} = d \cdot d_{\text{inter}} + d_{\text{inter}} \cdot d = 2d \cdot d_{\text{inter}}
$$</p>
<p>ï¼ˆSwiGLUéœ€è¦ä¸¤ä¸ª$d \times d_{\text{inter}}$çŸ©é˜µï¼Œåˆå¹¶è®¡ç®—ï¼‰</p>
<p><strong>æ¨å¯¼14.2ï¼šç¼©å‡MLPçš„å½±å“</strong></p>
<p>å°†$d_{\text{inter}}$ä»5456é™åˆ°4096ï¼š
$$
\Delta P = 2d \cdot (5456 - 4096) = 2d \cdot 1360 = 2720d
$$</p>
<p>å¯¹äº$d=2048$ï¼š
$$
\Delta P = 2720 \times 2048 \approx 5.57M
$$</p>
<p>è¿™ä¸GQA1-256å’ŒGQA2-128çš„å‚æ•°é‡å·®æ¥è¿‘ã€‚</p>
<p><strong>æ¨å¯¼14.3ï¼šç¼©å‡MLP vs ç¼©å‡head_dims</strong></p>
<p>å®éªŒæ˜¾ç¤ºï¼š
- GQA1-256ï¼ˆç¼©å°MLPï¼‰ï¼šloss = 2.747
- GQA2-128ï¼ˆæ ‡å‡†MLPï¼‰ï¼šloss = 2.75</p>
<p>ç¼©å°MLPæ¯”ç¼©å°head_dimsæ›´ä¼¤æ•ˆæœï¼Œè¯´æ˜MLPå¯¹å®¹é‡æ›´å…³é”®ã€‚</p>
<h3 id="15-vs">15. è®­ç»ƒé˜¶æ®µvsæ¨ç†é˜¶æ®µçš„å¤æ‚åº¦å¯¹æ¯”</h3>
<p><strong>æ¨å¯¼15.1ï¼šè®­ç»ƒé˜¶æ®µçš„ç“¶é¢ˆ</strong></p>
<p>è®­ç»ƒæ—¶ï¼Œä¸»è¦è®¡ç®—é‡åœ¨ï¼š
$$
\mathcal{O}_{\text{train}} = n^2 \cdot h \cdot d_h
$$</p>
<p>è¿™æ˜¯æ³¨æ„åŠ›çŸ©é˜µè®¡ç®—çš„å¤æ‚åº¦ï¼Œä¸åºåˆ—é•¿åº¦$n$çš„å¹³æ–¹æˆæ­£æ¯”ã€‚</p>
<p>å¯¹äº$n=4096$ï¼Œ$h=16$ï¼Œ$d_h=128$ï¼š
$$
\mathcal{O}_{\text{train}} \sim 4096^2 \times 16 \times 128 \approx 3.4 \times 10^{10}
$$</p>
<p><strong>æ¨å¯¼15.2ï¼šæ¨ç†é˜¶æ®µçš„ç“¶é¢ˆ</strong></p>
<p>æ¨ç†æ—¶ä½¿ç”¨KV Cacheï¼Œæ¯æ­¥è®¡ç®—ï¼š
$$
\mathcal{O}_{\text{decode}} = n \cdot h \cdot d_h
$$</p>
<p>ä½†ä¸»è¦ç“¶é¢ˆæ˜¯å†…å­˜å¸¦å®½ï¼Œéœ€è¦åŠ è½½Cacheï¼š
$$
\text{Memory\_access} = n \cdot h \cdot (d_k + d_v)
$$</p>
<p>å¯¹äº$n=4096$ï¼ŒMHAçš„å†…å­˜è®¿é—®ï¼š
$$
4096 \times 16 \times 256 \approx 16.8M \text{ å‚æ•°}
$$</p>
<p>MLAçš„å†…å­˜è®¿é—®ï¼š
$$
4096 \times 576 \approx 2.4M \text{ å‚æ•°}
$$</p>
<p>èŠ‚çœçº¦7å€ã€‚</p>
<p><strong>æ¨å¯¼15.3ï¼šMLAçš„åŒé‡ä¼˜åŒ–</strong></p>
<p>MLAé€šè¿‡åŒé‡æŠ•å½±ï¼š
- è®­ç»ƒæ—¶ï¼šä¿æŒ$d_h$è¾ƒå°ï¼ˆ128ï¼‰ï¼Œæ§åˆ¶$\mathcal{O}_{\text{train}}$
- æ¨ç†æ—¶ï¼šKV Cacheå‹ç¼©åˆ°576ç»´ï¼Œä¼˜åŒ–å†…å­˜è®¿é—®</p>
<p>å®ç°äº†è®­ç»ƒå’Œæ¨ç†çš„åŒé‡ä¼˜åŒ–ã€‚</p>
<h3 id="16">16. é•¿åºåˆ—å»ºæ¨¡çš„æŒ‘æˆ˜</h3>
<p><strong>æ¨å¯¼16.1ï¼šé•¿åºåˆ—çš„å¤æ‚åº¦çˆ†ç‚¸</strong></p>
<p>å¯¹äºåºåˆ—é•¿åº¦$n=32K$ï¼š
$$
\mathcal{O}_{\text{train}} = (32K)^2 \times h \times d_h \approx 1.07 \times 10^9 \times h \times d_h
$$</p>
<p>ç›¸æ¯”$n=4K$ï¼Œè®¡ç®—é‡å¢åŠ 64å€ã€‚</p>
<p><strong>æ¨å¯¼16.2ï¼šKV Cacheçš„å†…å­˜å‹åŠ›</strong></p>
<p>å¯¹äº$n=32K$ï¼ŒMHAçš„KV Cacheï¼š
$$
32K \times 16 \times 256 \approx 134M \text{ å‚æ•°}
$$</p>
<p>ä»¥float16å­˜å‚¨ï¼Œçº¦268MBæ¯ä¸ªæ ·æœ¬ã€‚åœ¨æ‰¹å¤„ç†å’Œå¤šå±‚æƒ…å†µä¸‹ï¼Œå†…å­˜éœ€æ±‚å·¨å¤§ã€‚</p>
<p><strong>æ¨å¯¼16.3ï¼šMLAçš„é•¿åºåˆ—ä¼˜åŠ¿</strong></p>
<p>MLAçš„KV Cacheï¼š
$$
32K \times 576 \approx 18.4M \text{ å‚æ•°}
$$</p>
<p>çº¦37MBæ¯ä¸ªæ ·æœ¬ï¼Œæ˜¯MHAçš„$\frac{18.4}{134} \approx 14\%$ã€‚</p>
<p>è¿™ä½¿å¾—MLAå¯ä»¥åœ¨ç›¸åŒå†…å­˜ä¸‹å¤„ç†æ›´é•¿çš„åºåˆ—æˆ–æ›´å¤§çš„æ‰¹æ¬¡ã€‚</p>
<h3 id="17">17. æ€»ç»“ä¸ç†è®ºå¯ç¤º</h3>
<p><strong>æ¨å¯¼17.1ï¼šMLAçš„æ ¸å¿ƒæ•°å­¦æ€æƒ³</strong></p>
<p>MLAæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªä½ç§©åˆ†è§£çš„Attentionæœºåˆ¶ï¼š
$$
\boldsymbol{K} = \boldsymbol{C} \boldsymbol{W}_k, \quad \boldsymbol{V} = \boldsymbol{C} \boldsymbol{W}_v
$$</p>
<p>é€šè¿‡å…±äº«å‹ç¼©è¡¨ç¤º$\boldsymbol{C}$ï¼Œå®ç°äº†å‚æ•°å’ŒCacheçš„å‹ç¼©ï¼ŒåŒæ—¶ä¿æŒäº†è¡¨è¾¾èƒ½åŠ›ã€‚</p>
<p><strong>æ¨å¯¼17.2ï¼šå…³é”®è®¾è®¡é€‰æ‹©çš„ç†è®ºåŸºç¡€</strong></p>
<ol>
<li><strong>å¢å¤§head_dims</strong>ï¼šæä¾›è¶³å¤Ÿçš„è¡¨ç¤ºç©ºé—´ï¼Œé¿å…ä¿¡æ¯ç“¶é¢ˆ</li>
<li><strong>Partial RoPE</strong>ï¼šè§£è€¦contentå’Œpositionï¼Œæå‡å­¦ä¹ æ•ˆç‡</li>
<li><strong>KV Shared</strong>ï¼šæ–½åŠ æ­£åˆ™åŒ–çº¦æŸï¼Œå‡å°‘å†—ä½™ï¼Œæå‡æ³›åŒ–</li>
</ol>
<p>è¿™äº›è®¾è®¡ä¸æ˜¯å­¤ç«‹çš„ï¼Œè€Œæ˜¯ç›¸äº’é…åˆï¼Œå…±åŒå®ç°äº†MLAçš„ä¼˜å¼‚æ€§èƒ½ã€‚</p>
<p><strong>æ¨å¯¼17.3ï¼šæœªæ¥ç ”ç©¶æ–¹å‘</strong></p>
<p>ä»æ•°å­¦è§’åº¦ï¼ŒMLAè¿˜æœ‰æ”¹è¿›ç©ºé—´ï¼š</p>
<ol>
<li><strong>åŠ¨æ€ç§©åˆ†é…</strong>ï¼šæ ¹æ®ä¸åŒå±‚æˆ–ä¸åŒä½ç½®ï¼ŒåŠ¨æ€è°ƒæ•´$d_c$</li>
<li><strong>éçº¿æ€§å‹ç¼©</strong>ï¼šç”¨éçº¿æ€§å‡½æ•°æ›¿ä»£çº¿æ€§æŠ•å½±$\boldsymbol{W}_c$</li>
<li><strong>è‡ªé€‚åº”head_dims</strong>ï¼šä¸åŒheadsä½¿ç”¨ä¸åŒçš„$d_h$</li>
</ol>
<p>è¿™äº›æ–¹å‘å€¼å¾—è¿›ä¸€æ­¥æ¢ç´¢ã€‚</p>
        </div>
    </div>
</body>
</html>