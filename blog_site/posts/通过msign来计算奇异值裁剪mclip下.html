<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é€šè¿‡msignæ¥è®¡ç®—å¥‡å¼‚å€¼è£å‰ªmclipï¼ˆä¸‹ï¼‰</title>
    <style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    line-height: 1.6; color: #333; max-width: 900px; margin: 0 auto; padding: 20px; background: #f5f5f5;
}
.container { background: white; padding: 40px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
header { border-bottom: 2px solid #e0e0e0; padding-bottom: 20px; margin-bottom: 30px; }
h1 { color: #2c3e50; margin-bottom: 10px; font-size: 2em; }
.meta { color: #666; font-size: 0.9em; margin-bottom: 20px; }
.content { margin-top: 30px; overflow-wrap: break-word; }
.content h2 { color: #34495e; margin-top: 30px; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
.content p { margin-bottom: 15px; }
.content pre { background: #f8f8f8; padding: 15px; border-radius: 5px; overflow-x: auto; border-left: 3px solid #3498db; margin: 15px 0; }
.content code { background: #f8f8f8; padding: 2px 5px; border-radius: 3px; font-family: monospace; font-size: 0.9em; }
.content blockquote { border-left: 4px solid #3498db; padding-left: 20px; margin: 20px 0; color: #555; font-style: italic; }
.content table { border-collapse: collapse; width: 100%; margin: 20px 0; }
.content th, .content td { border: 1px solid #ddd; padding: 10px; text-align: left; }
.back-link { display: inline-block; margin-bottom: 20px; color: #3498db; text-decoration: none; font-weight: 500; }
</style>
    
<script>
    window.MathJax = {
        tex: {
            inlineMath: [['$', '$'], ['\(', '\)']],
            displayMath: [['$$', '$$'], ['\[', '\]']],
            processEscapes: true
        }
    };
</script>
<script id="MathJax-script" async src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>

</head>
<body>
    <div class="container">
        <a href="../index.html" class="back-link">â† è¿”å›é¦–é¡µ</a>
        <header>
            <h1>é€šè¿‡msignæ¥è®¡ç®—å¥‡å¼‚å€¼è£å‰ªmclipï¼ˆä¸‹ï¼‰</h1>
            <div class="meta">ğŸ“… æœ€åæ›´æ–°: 2025-11-26 | ğŸ“„ å¤§å°: 48.2 KB</div>
        </header>
        <div class="content">
            <p><strong>åŸæ–‡é“¾æ¥</strong>: <a href="https://spaces.ac.cn/archives/11059">https://spaces.ac.cn/archives/11059</a></p>
<p><strong>å‘å¸ƒæ—¥æœŸ</strong>: </p>
<hr />
<p>å‰é¢æˆ‘ä»¬åœ¨<a href="/archives/11006">ã€Šé€šè¿‡msignæ¥è®¡ç®—å¥‡å¼‚å€¼è£å‰ªmclipï¼ˆä¸Šï¼‰ã€‹</a>è®¨è®ºäº†å¥‡å¼‚å€¼è£å‰ª$\newcommand{mclip}{\mathop{\text{mclip}}}\mclip$çš„æ•°å€¼è®¡ç®—ï¼Œæ ¸å¿ƒæ€è·¯æ¥è‡ª <a href="https://x.com/leloykun">@leloykun</a> çš„æ–‡ç« <a href="https://leloykun.github.io/ponder/spectral-clipping/">ã€ŠNumerically Stable Spectral Clipping Via Newton-Schulz Iterationã€‹</a>ï¼ˆç°å·²é‡æ–°ä¿®è®¢å’Œæ”¹åï¼‰ï¼Œé€šè¿‡å¯»æ‰¾åŸºäº$\newcommand{msign}{\mathop{\text{msign}}}\msign$çš„è¡¨è¾¾å¼æ¥é¿å…å¦å¤–å¯»æ‰¾Newton-Schulzè¿­ä»£ï¼Œåœ¨æ–‡ç« ä¸­ç¬”è€…æå‡ºäº†ä¸€ä¸ªè®¡ç®—é‡æ›´ä½çš„åµŒå¥—$\msign$æ–¹æ¡ˆã€‚</p>
<p>ä¸è¿‡å‰ä¸¤å¤©ï¼Œ@leloykun åœ¨<a href="https://x.com/leloykun/status/1936199820479205420">æ¨ç‰¹</a>ä¸ŠæŒ‡å‡ºç¬”è€…çš„æ–¹æ¡ˆå®é™…è®¡ç®—ä¸­å­˜åœ¨è¯¯å·®åå¤§çš„é—®é¢˜ã€‚æœ¬æ–‡æ¥å…·ä½“åˆ†æä¸€ä¸‹è¿™ä¸ªé—®é¢˜ï¼Œå¹¶ç»™å‡ºä¸€ä¸ªæ›´é«˜æ•ˆã€è¯¯å·®æ›´ä½çš„æ–°æ–¹æ¡ˆã€‚</p>
<h2 id="_1">åŸºæœ¬æ¦‚å¿µ</h2>
<p>æŒ‰ç…§æƒ¯ä¾‹ï¼Œå…ˆæ•´ç†ä¸€ä¸‹åŸºæœ¬æ¦‚å¿µã€‚é¦–å…ˆæ˜¯æ ‡é‡$x$çš„$\newcommand{clip}{\mathop{\text{clip}}}\clip$ç®—å­ï¼Œè¿™æ¬¡æˆ‘ä»¬ä¸€èˆ¬åœ°å®šä¹‰<br />
\begin{equation}\clip\nolimits_{[\alpha,\beta]}(x) = \max(\min(x, \beta), \alpha) = \left\{\begin{aligned}\beta, &amp;\quad \geq \beta \\\<br />
x, &amp;\quad x\in(\alpha, \beta)\\\<br />
\alpha, &amp;\quad x\leq \alpha<br />
\end{aligned}\right.\end{equation}<br />
å½“æ²¡æœ‰ç‰¹åˆ«æ³¨æ˜åŒºé—´æ—¶ï¼ŒåŒºé—´é»˜è®¤æ˜¯$[-1,1]$ï¼Œå³$\clip(x) = \clip_{[-1,1]}(x)$ã€‚è®¾çŸ©é˜µ$\boldsymbol{M}\in\mathbb{R}^{n\times m}$çš„SVDä¸º$\boldsymbol{M}=\boldsymbol{U}\boldsymbol{\Sigma}\boldsymbol{V}^{\top}$ï¼Œ$\boldsymbol{U}\in\mathbb{R}^{n\times n},\boldsymbol{V}\in\mathbb{R}^{m\times m}$æ˜¯æ­£äº¤çŸ©é˜µï¼Œ$\boldsymbol{\Sigma}\in\mathbb{R}^{n\times m}$æ˜¯å¥‡å¼‚å€¼å¯¹è§’é˜µï¼Œé‚£ä¹ˆå®šä¹‰<br />
\begin{equation}\mclip\nolimits_{[\alpha,\beta]}(\boldsymbol{M}) = \boldsymbol{U}\clip\nolimits_{[\alpha,\beta]}(\boldsymbol{\Sigma})\boldsymbol{V}^{\top}\end{equation}<br />
å¯¹è§’çŸ©é˜µåŠ $\clip$è¡¨ç¤ºå¯¹å®ƒçš„å¯¹è§’çº¿å…ƒç´ åˆ†åˆ«è¿›è¡Œ$\clip$ï¼Œè¯´ç™½äº†ï¼Œ$\mclip_{[\alpha,\beta]}$å°±æ˜¯æŠŠ$\boldsymbol{M}$çš„å¥‡å¼‚å€¼è£å‰ªåˆ°$[\alpha,\beta]$å†…ã€‚</p>
<p>ç”±äºå¥‡å¼‚å€¼æ˜¯éè´Ÿçš„ï¼Œæ‰€ä»¥å½“$\alpha &lt; 0$æ—¶æœ‰$\mclip_{[\alpha,\beta]}(\boldsymbol{M})=\mclip_{[0,\beta]}(\boldsymbol{M})$ï¼Œä½†åé¢æˆ‘ä»¬å°†ä¼šçœ‹åˆ°ï¼Œç”±äºå®é™…è®¡ç®—çš„è¯¯å·®ï¼Œè€ƒè™‘è´Ÿæ•°çš„$\alpha$ä¼šæœ‰ä¸€äº›ç¥å¥‡çš„æŠµæ¶ˆè¯¯å·®æ•ˆæœã€‚</p>
<h2 id="_2">ç†è®ºé€šè§£</h2>
<p>è¿™ä¸€èŠ‚çš„ç›®æ ‡æ˜¯ç”¨$\msign$è¡¨ç¤ºå‡º$\mclip$ï¼Œå‡ºå‘ç‚¹æ˜¯æ’ç­‰å¼<br />
\begin{equation}\newcommand{sign}{\mathop{\text{sign}}}\mclip\nolimits_{[\alpha,\beta]} (x) = \frac{\alpha + \beta + (\alpha - x)\sign(\alpha - x) - (\beta - x)\sign(\beta - x)}{2}\end{equation}<br />
æ‰¾åˆ°æ’ç­‰å¼çš„å…³é”®æ˜¯å°†$\clip$è¡¨ç¤ºä¸ºç»å¯¹å€¼ä¸è‡ªèº«çš„çº¿æ€§è¿ç®—ï¼Œç„¶åé€šè¿‡$|x|=x\sign(x)$è¿‡æ¸¡åˆ°$\sign$è¿ç®—ï¼Œè¿™é‡Œå°±ä¸å±•å¼€äº†ã€‚</p>
<p>ç®€å•èµ·è§ï¼Œå…ˆè®¾$\boldsymbol{M}$æ˜¯æ»¡ç§©æ–¹é˜µï¼ŒåŸºäºè¯¥æ’ç­‰å¼ï¼Œæˆ‘ä»¬æœ‰<br />
\begin{equation}2\mclip\nolimits_{[\alpha,\beta]}(\boldsymbol{M}) = \boldsymbol{U}\Big((\alpha + \beta)\boldsymbol{I} + (\alpha \boldsymbol{I} - \boldsymbol{\Sigma})\sign(\alpha \boldsymbol{I} - \boldsymbol{\Sigma}) - (\beta \boldsymbol{I} - \boldsymbol{\Sigma})\sign(\beta \boldsymbol{I} - \boldsymbol{\Sigma})\Big)\boldsymbol{V}^{\top}\end{equation}<br />
å±•å¼€å³å¼ï¼Œåˆ†åˆ«åŒ…å«å‡ ç§é¡¹ï¼ˆ$\gamma\in\{\alpha,\beta\}$ï¼‰ï¼š<br />
\begin{array}{c|c}<br />
\hline<br />
\text{åŸå§‹} &amp; \text{åŒ–ç®€} \\\<br />
\hline<br />
\boldsymbol{U}\boldsymbol{V}^{\top} &amp; \msign(\boldsymbol{M}) \\\<br />
\hline<br />
\boldsymbol{U}\sign(\gamma \boldsymbol{I} - \boldsymbol{\Sigma})\boldsymbol{V}^{\top} &amp;<br />
\begin{aligned}&amp;\, \msign(\gamma \boldsymbol{U}\boldsymbol{V}^{\top} - \boldsymbol{U}\boldsymbol{\Sigma}\boldsymbol{V}^{\top}) \\\<br />
=&amp;\, \msign(\gamma \msign(\boldsymbol{M}) - \boldsymbol{M})<br />
\end{aligned} \\\<br />
\hline<br />
\boldsymbol{U}\boldsymbol{\Sigma}\sign(\gamma \boldsymbol{I} - \boldsymbol{\Sigma})\boldsymbol{V}^{\top} &amp; \begin{aligned}&amp;\, \boldsymbol{U}\boldsymbol{\Sigma}\boldsymbol{V}^{\top}\boldsymbol{V}\boldsymbol{U}^{\top}\boldsymbol{U}\sign(\gamma \boldsymbol{I} - \boldsymbol{\Sigma})\boldsymbol{V}^{\top} \\\<br />
=&amp;\, \boldsymbol{M}\msign(\boldsymbol{M})^{\top}\msign(\gamma \msign(\boldsymbol{M}) - \boldsymbol{M})<br />
\end{aligned} \\\<br />
\hline<br />
\end{array}<br />
ä»£å…¥æ•´ç†å¯å¾—<br />
\begin{equation}\mclip\nolimits_{[\alpha,\beta]}(\boldsymbol{M}) = \frac{1}{2}\left\{\begin{aligned}&amp;\,(\alpha + \beta)\msign(\boldsymbol{M}) \\\<br />
+ &amp;\, (\alpha \boldsymbol{I} - \boldsymbol{M}\msign(\boldsymbol{M})^{\top})\msign(\alpha \msign(\boldsymbol{M}) - \boldsymbol{M})\\\<br />
- &amp;\, (\beta \boldsymbol{I} - \boldsymbol{M}\msign(\boldsymbol{M})^{\top})\msign(\beta \msign(\boldsymbol{M}) - \boldsymbol{M})<br />
\end{aligned}\right\}\label{eq:general}\end{equation}<br />
å¯¹äºéæ–¹å½¢ã€éæ»¡ç§©çŸ©é˜µï¼Œå¯ä»¥ä»£å…¥$\msign(\boldsymbol{M})=\boldsymbol{U}<em _:_:r_="[:,:r]">{[:,:r]}\boldsymbol{V}</em>$åˆ°ä¸Šå¼æ£€éªŒæˆç«‹ï¼Œæ‰€ä»¥ä¸Šå¼æ˜¯$\mclip$çš„ç†è®ºé€šè§£ã€‚}^{\top</p>
<h2 id="_3">åˆå§‹å½¢å¼</h2>
<p>å¼$\eqref{eq:general}$çœ‹èµ·æ¥è‡³å°‘éœ€è¦è®¡ç®—ä¸‰æ¬¡$\msign$ï¼Œå¹¶ä¸”åé¢ä¸¤æ¬¡$\msign$çš„è¾“å…¥å¸¦æœ‰ç¬¬ä¸€æ¬¡$\msign$çš„ç»“æœï¼Œæ‰€ä»¥å½¢å¼ä¸Šæ˜¯$\msign$çš„åµŒå¥—ã€‚å½“æˆ‘ä»¬å–$\alpha=0,\beta=1$æ—¶ï¼Œ$\msign$çš„æ¬¡æ•°å¯ä»¥é™ä½åˆ°ä¸¤æ¬¡ï¼š<br />
\begin{equation}\mclip(\boldsymbol{M}) = \frac{1}{2}\Big[\boldsymbol{M} + \msign(\boldsymbol{M}) + (\boldsymbol{I} - \boldsymbol{M}\msign(\boldsymbol{M})^{\top}) \msign(\boldsymbol{M} - \msign(\boldsymbol{M}))\Big]\label{eq:mclip-1}\end{equation}<br />
è¿™å°±æ˜¯ç¬”è€…åœ¨ä¸Šä¸€ç¯‡æ–‡ç« <a href="/archives/11006">ã€Šé€šè¿‡msignæ¥è®¡ç®—å¥‡å¼‚å€¼è£å‰ªmclipï¼ˆä¸Šï¼‰ã€‹</a>ç»™å‡ºçš„ç»“æœï¼Œåªéœ€è¦ä¸¤æ¬¡$\msign$ã€‚</p>
<p>ç„¶è€Œï¼Œå®æµ‹æ˜¾ç¤ºè¯¥å¼åœ¨$\boldsymbol{M}$çš„å¥‡å¼‚å€¼è¾ƒå¤§ä¸”$\msign$çš„è®¡ç®—ç²¾åº¦è¾ƒä½æ—¶ï¼Œä¼šäº§ç”Ÿè¾ƒå¤§çš„è¯¯å·®ï¼Œè¿œå¤§äº @leloykun æ‰€ç»™å‡ºçš„æ–¹æ¡ˆã€‚ä½† @leloykun çš„æ–¹æ¡ˆéœ€è¦å¯¹ä¸€ä¸ªå¤§çº¦4å€å¤§å°çš„çŸ©é˜µ$\begin{bmatrix}\boldsymbol{I} &amp; \boldsymbol{M} \\\ \boldsymbol{M}^{\top} &amp; \boldsymbol{I}\end{bmatrix}$ç®—$\msign$ï¼Œä»£ä»·ä¸è²ï¼Œæ‰€ä»¥è¿˜æ˜¯æƒ³çœ‹çœ‹è¿™é‡Œçš„æ–¹æ¡ˆè¿˜æœ‰ä»€ä¹ˆæå‡ç©ºé—´ã€‚</p>
<h2 id="_4">å»æ‰åµŒå¥—</h2>
<p>ç›´è§‰ä¸Šï¼Œè¯¯å·®çš„æ¥æºæ˜¯åµŒå¥—$\msign$å¯¼è‡´çš„ç´¯ç§¯è¯¯å·®ï¼Œæ‰€ä»¥å°è¯•æƒ³åŠæ³•å»æ‰åµŒå¥—ï¼Œå¹¸è¿çš„æ˜¯ï¼Œåˆ©ç”¨ä¸€ä¸ªç®€å•çš„æŠ€å·§è¿˜çœŸçš„èƒ½å»æ‰åµŒå¥—ï¼</p>
<p>é¦–å…ˆå¯ä»¥è¯æ˜<br />
\begin{equation}\begin{aligned}<br />
&amp;\,(\boldsymbol{I} - \boldsymbol{M}\msign(\boldsymbol{M})^{\top}) \msign(\boldsymbol{M} - \msign(\boldsymbol{M})) \\\[6pt]<br />
=&amp;\, (\msign(\boldsymbol{M}) - \boldsymbol{M}) \msign(\msign(\boldsymbol{M})^{\top}\boldsymbol{M} - \boldsymbol{I})<br />
\end{aligned}\end{equation}<br />
ç„¶åæˆ‘ä»¬æœ‰<br />
\begin{equation}\msign(\boldsymbol{M})^{\top}\boldsymbol{M} - \boldsymbol{I} = \boldsymbol{V}\boldsymbol{\Sigma}\boldsymbol{V}^{\top} - \boldsymbol{I} = \boldsymbol{V}(\boldsymbol{\Sigma}-\boldsymbol{I})\boldsymbol{V}^{\top}\end{equation}<br />
æ ¹æ®ä¸Šå¼ï¼Œæˆ‘ä»¬æ–­è¨€<br />
\begin{equation}\msign(\msign(\boldsymbol{M})^{\top}\boldsymbol{M} - \boldsymbol{I}) = \msign(\boldsymbol{M}^{\top}\boldsymbol{M} - \boldsymbol{I}) = \msign(\boldsymbol{V}(\boldsymbol{\Sigma}^2-\boldsymbol{I})\boldsymbol{V}^{\top})\end{equation}<br />
è¿™åˆ©ç”¨äº†ä¸€ä¸ªå¾ˆç®€å•çš„æ€§è´¨ï¼š$\forall x \geq 0, \sign(x-1) = \sign(x^2-1)$ã€‚åˆ©ç”¨è¯¥ç»“æœï¼Œå¯ä»¥å¾—åˆ°<br />
\begin{equation}\mclip(\boldsymbol{M}) = \frac{1}{2}\Big[\boldsymbol{M} + \msign(\boldsymbol{M}) + (\msign(\boldsymbol{M}) - \boldsymbol{M}) \msign(\boldsymbol{M}^{\top}\boldsymbol{M} - \boldsymbol{I})\Big]\label{eq:mclip-2}\end{equation}<br />
è¿˜æ˜¯ä¸¤æ¬¡$\msign$ï¼Œä½†å®ƒä»¬ä¹‹é—´å·²ç»ä¸å†æœ‰åµŒå¥—å…³ç³»ï¼Œæ„å‘³ç€ç†è®ºä¸Šå·²ç»æ²¡æœ‰åµŒå¥—$\msign$å¸¦æ¥çš„ç´¯ç§¯è¯¯å·®ï¼Œå®æµ‹æ˜¾ç¤ºå¼$\eqref{eq:mclip-2}$çš„è¯¯å·®ç¡®å®èƒ½æ¯”å¼$\eqref{eq:mclip-1}$å°ä¸€åŠå·¦å³ï¼Œä½†æç«¯æƒ…å†µä¸‹è¿˜æ˜¯ä¸å¦‚ @leloykun çš„æ–¹æ¡ˆï¼Œè¿™è¯´æ˜åµŒå¥—å¹¶ä¸æ˜¯ä¸»è¦è¯¯å·®æ¥æºã€‚</p>
<h2 id="_5">ç›¸äº’æŠµæ¶ˆ</h2>
<p>è¿˜æœ‰ä»€ä¹ˆæ”¹è¿›ç©ºé—´å‘¢ï¼Ÿ@leloykun çš„æ–¹æ¡ˆè¦æ±‚æ˜¯å¥‡å‡½æ•°ï¼Œæ‰€ä»¥å®ƒå®é™…ä¸Šè€ƒè™‘çš„æ˜¯$\mclip_{[-1,1]}$è€Œä¸æ˜¯$\mclip_{[0,1]}$ã€‚æœ‰æ²¡æœ‰å¯èƒ½æ˜¯è¿™ä¸ªé€‰æ‹©å¯¼è‡´äº†å®ƒæŸä¸¤éƒ¨åˆ†è¯¯å·®ç›¸äº’æŠµé”€ï¼Œä»è€Œå¾—åˆ°æ›´å¥½çš„è®¡ç®—ç²¾åº¦å‘¢ï¼Ÿ</p>
<p>ä¸ºäº†éªŒè¯è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬åœ¨å¼$\eqref{eq:general}$ä»£å…¥$\alpha=-1,\beta=1$ï¼Œå¾—åˆ°<br />
\begin{equation}\mclip(\boldsymbol{M}) = \frac{1}{2}\left\{\begin{aligned}<br />
&amp;\,(\boldsymbol{I} + \boldsymbol{M}\msign(\boldsymbol{M})^{\top})\msign(\msign(\boldsymbol{M}) + \boldsymbol{M}) \\\<br />
- &amp;\,(\boldsymbol{I} - \boldsymbol{M}\msign(\boldsymbol{M})^{\top})\msign(\msign(\boldsymbol{M}) - \boldsymbol{M})<br />
\end{aligned}\right\}\end{equation}<br />
åŸºäºä¸Šä¸€èŠ‚ä¸€æ ·çš„å»åµŒå¥—æŠ€å·§ï¼Œæˆ‘ä»¬å¾—åˆ°<br />
\begin{equation}\mclip(\boldsymbol{M}) = \frac{1}{2}\left\{\begin{aligned}<br />
&amp;\,(\msign(\boldsymbol{M}) + \boldsymbol{M})\msign(\boldsymbol{M}^{\top}\boldsymbol{M} + \boldsymbol{I}) \\\<br />
+ &amp;\,(\msign(\boldsymbol{M}) - \boldsymbol{M})\msign(\boldsymbol{M}^{\top}\boldsymbol{M} - \boldsymbol{I})<br />
\end{aligned}\right\}\label{eq:mclip-3}\end{equation}<br />
æ³¨æ„ï¼Œ$\boldsymbol{M}^{\top}\boldsymbol{M} + \boldsymbol{I}$ä¸€å®šæ˜¯æ­£å®šå¯¹ç§°çŸ©é˜µï¼Œæ‰€ä»¥ç†è®ºä¸Š$\msign(\boldsymbol{M}^{\top}\boldsymbol{M} + \boldsymbol{I})=\boldsymbol{I}$ï¼Œè¿™æ ·æˆ‘ä»¬å°±æ¢å¤äº†å¼$\eqref{eq:mclip-2}$ã€‚ä½†å®é™…è®¡ç®—ä¸­ï¼Œ$\msign(\boldsymbol{M}^{\top}\boldsymbol{M} + \boldsymbol{I})$ä¸$\boldsymbol{I}$ä¹‹é—´çš„è¯¯å·®å¯èƒ½ä¼šæŠµæ¶ˆ$\msign(\boldsymbol{M}^{\top}\boldsymbol{M} - \boldsymbol{I})$å¸¦æ¥çš„è¯¯å·®ï¼Œæ‰€ä»¥æˆ‘ä»¬é€šè¿‡å®éªŒå†³å®šæ˜¯å¦ä¿ç•™å®ƒã€‚</p>
<p>ä¸å‡ºæ‰€æ–™ï¼Œå¼$\eqref{eq:mclip-3}$çš„æ•°å€¼è¯¯å·®æ¯” @leloykun çš„æ–¹æ¡ˆè¿˜è¦å°ï¼è¿™å°±è‚¯å®šäº†æˆ‘ä»¬çš„çŒœæµ‹ï¼Œè®¾ç½®$\alpha=-1$å’Œ$\beta=1$è®©$\mclip$å˜æˆå¥‡å‡½æ•°ï¼Œæœ‰åŠ©äºæŠµæ¶ˆè¯¯å·®ã€‚</p>
<h2 id="_6">åŸå› æµ…æ€</h2>
<p>ä¸ºä»€ä¹ˆè¿™ä¹ˆå·§èƒ½æŠµæ¶ˆè¯¯å·®å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥ç®€å•åšä¸ªå®šé‡åˆ†æã€‚å¤§è¯¯å·®çš„å‡ºç°å‰ææœ‰ä¸¤ä¸ªï¼Œä¸€æ˜¯$\boldsymbol{M}$æœ‰éå¸¸å¤§çš„å¥‡å¼‚å€¼ï¼ŒäºŒæ˜¯$\msign$çš„è¿­ä»£æ­¥æ•°å¹¶ä¸å¤šï¼Œå¯¼è‡´$\msign$æœ¬èº«çš„ç²¾åº¦ä¸é«˜ã€‚</p>
<p>æˆ‘ä»¬è§‚å¯Ÿå¼$\eqref{eq:mclip-3}$ï¼Œå®ƒå¯ä»¥æ‹†åˆ†ä¸º4é¡¹æ±‚å’Œï¼Œå…¶å®$\msign(\boldsymbol{M})\msign(\boldsymbol{M}^{\top}\boldsymbol{M} \pm \boldsymbol{I})$è¿™ä¸¤é¡¹æœ‰ç•Œçš„ï¼Œå³ä¾¿$\msign$ç²¾åº¦ä¸é«˜ä¹ŸåŸºæœ¬æ— æ³•å‘æ•£ï¼Œæ‰€ä»¥ä¸»è¦è¯¯å·®æ¥è‡ª<br />
\begin{equation}\boldsymbol{M}\msign(\boldsymbol{M}^{\top}\boldsymbol{M} + \boldsymbol{I}) - \boldsymbol{M}\msign(\boldsymbol{M}^{\top}\boldsymbol{M} - \boldsymbol{I})\label{eq:error-1}\end{equation}<br />
å®ƒæ­£æ¯”äº$\boldsymbol{M}$ï¼Œæœ€æœ‰å¯èƒ½æŠŠè¯¯å·®æ”¾å¤§ã€‚ç›¸åº”åœ°ï¼Œå¼$\eqref{eq:mclip-2}$çš„ä¸»è¦è¯¯å·®é¡¹åˆ™æ˜¯<br />
\begin{equation}\boldsymbol{M} - \boldsymbol{M}\msign(\boldsymbol{M}^{\top}\boldsymbol{M} - \boldsymbol{I})\label{eq:error-2}\end{equation}<br />
æˆ‘ä»¬è€ƒè™‘è¿œå¤§äº1çš„å¥‡å¼‚å€¼ï¼Œå¦‚æœ$\msign$æ˜¯ç²¾ç¡®çš„ï¼Œé‚£ä¹ˆ$\msign$çš„ç»“æœå°±æ˜¯1ï¼Œä¸Šé¢ä¸¤ä¸ªå¼å­çš„ç»“æœä¸­å¯¹åº”å¤§å¥‡å¼‚å€¼éƒ¨åˆ†å°†ä¼šéƒ½æ˜¯æˆ‘ä»¬æœŸæœ›çš„0ã€‚</p>
<p>ç„¶è€Œï¼Œå¦‚æœæ˜¯è¿­ä»£æ­¥æ•°ä¸å¤šçš„$\msign$ï¼Œå®ƒå¯èƒ½å˜æˆ$0.6$æˆ–è€…$1.4$è¿™æ ·çš„å€¼ï¼Œå¼$\eqref{eq:error-2}$ç›¸åº”çš„éƒ¨åˆ†å°±ä¼šå‡ºç°$\sim\pm 0.4 \boldsymbol{M}$è¿™æ ·çš„å·¨å¤§è¯¯å·®ï¼›ä½†å¦‚æœæ˜¯å¼$\eqref{eq:error-1}$ï¼Œå½“å¥‡å¼‚å€¼å¾ˆå¤§æ—¶ï¼Œ$\boldsymbol{M}^{\top}\boldsymbol{M} - \boldsymbol{I}$å’Œ$\boldsymbol{M}^{\top}\boldsymbol{M} + \boldsymbol{I}$çš„ç›¸å¯¹å·®å¼‚å¹¶ä¸å¤§ï¼Œå› æ­¤$\msign(\boldsymbol{M}^{\top}\boldsymbol{M} \pm \boldsymbol{I})$çš„å·®å¼‚å¾ˆå°ï¼Œæ‰€ä»¥å¼$\eqref{eq:error-1}$ä¾ç„¶èƒ½æŠµæ¶ˆå¤§éƒ¨ä»½è¯¯å·®ã€‚</p>
<p>ä½†è¦è®°ä½ï¼Œè¿™å§‹ç»ˆæœ‰ä¸ªå‰æï¼Œå°±æ˜¯$\boldsymbol{M}$æœ‰æ˜æ˜¾å¤§äº1çš„å¥‡å¼‚å€¼ï¼Œä»¥åŠè¿­ä»£æ­¥æ•°ä¸å¤šã€‚å¦‚æœä¸æ»¡è¶³è¿™ä¸¤ä¸ªæ¡ä»¶ï¼Œé‚£ä¹ˆå¼$\eqref{eq:mclip-2}$æœ¬æ¥çš„è¯¯å·®å°±ä¸å¤§ï¼Œå¼$\eqref{eq:mclip-3}$åè€Œä¼šå› ä¸ºå¤šç®—äº†ä¸€æ¬¡$\msign$è€Œå¢åŠ è¯¯å·®ã€‚å› æ­¤ï¼Œå“ªä¸ªå…¬å¼çš„å®é™…è¡¨ç°æœ€ä¼˜ï¼Œè¿˜éœ€è¦å…·ä½“æƒ…å†µå…·ä½“åˆ†æã€‚</p>
<h2 id="_7">å¯¹æ¯”ä»£ç </h2>
<p>æ„é€ ä¸€ä¸ªå¥‡å¼‚å€¼æœ‰å¤§äº1ä¹Ÿæœ‰å°äº1ï¼Œä¸”æœ€å¤§å¥‡å¼‚å€¼æ¥è¿‘1000çš„å¥‡å¼‚å€¼ï¼Œç„¶ååœ¨bfloat16ç²¾åº¦ä¸‹æµ‹è¯•å„ä¸ªç®—æ³•ï¼Œå‚è€ƒä»£ç å¦‚ä¸‹ï¼ˆå¤§è‡´è¿è¡Œç»“æœå·²åœ¨æ³¨é‡Šå†™å‡ºï¼‰ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">jax.numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">jnp</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">jax.lax</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">lax</span>

<span class="k">def</span><span class="w"> </span><span class="nf">msign</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1e-20</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The coefficients come from https://kexue.fm/archives/10996</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">abc</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="mf">8.287212018145622</span><span class="p">,</span> <span class="o">-</span><span class="mf">23.59588651909882</span><span class="p">,</span> <span class="mf">17.300387312530923</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">4.107059111542197</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.9478499167379084</span><span class="p">,</span> <span class="mf">0.54484310829266</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">3.9486908534822938</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.908902115962947</span><span class="p">,</span> <span class="mf">0.5518191394370131</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">3.3184196573706055</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.488488024314878</span><span class="p">,</span> <span class="mf">0.5100489401237208</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">2.3006520199548186</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.6689039845747518</span><span class="p">,</span> <span class="mf">0.4188073119525678</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">1.8913014077874002</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.2679958271945908</span><span class="p">,</span> <span class="mf">0.37680408948524996</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">1.875</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.25</span><span class="p">,</span> <span class="mf">0.375</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">mT</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="kp">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">x</span><span class="o">.</span><span class="kp">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">else</span> <span class="n">x</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">*</span> <span class="n">lax</span><span class="o">.</span><span class="n">rsqrt</span><span class="p">((</span><span class="n">y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="kp">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">+</span> <span class="n">eps</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">abc</span><span class="p">[:</span><span class="n">steps</span><span class="p">]</span> <span class="o">+</span> <span class="nb">max</span><span class="p">(</span><span class="n">steps</span> <span class="o">-</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">abc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">a</span> <span class="o">/</span> <span class="mf">1.01</span><span class="p">,</span> <span class="n">b</span> <span class="o">/</span> <span class="mf">1.01</span><span class="o">**</span><span class="mi">3</span><span class="p">,</span> <span class="n">c</span> <span class="o">/</span> <span class="mf">1.01</span><span class="o">**</span><span class="mi">5</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">a</span> <span class="o">*</span> <span class="n">y</span> <span class="o">+</span> <span class="p">(</span><span class="n">b</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span> <span class="o">:=</span> <span class="n">y</span> <span class="o">@</span> <span class="n">y</span><span class="o">.</span><span class="n">mT</span><span class="p">)</span> <span class="o">+</span> <span class="n">c</span> <span class="o">*</span> <span class="n">u</span> <span class="o">@</span> <span class="n">u</span><span class="p">)</span> <span class="o">@</span> <span class="n">y</span>
    <span class="k">return</span> <span class="n">y</span><span class="o">.</span><span class="n">mT</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="kp">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">x</span><span class="o">.</span><span class="kp">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">else</span> <span class="n">y</span>

<span class="k">def</span><span class="w"> </span><span class="nf">mclip1</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;1st version (2 nested msign)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ms2</span> <span class="o">=</span> <span class="n">msign</span><span class="p">(</span><span class="n">m</span> <span class="o">-</span> <span class="p">(</span><span class="n">ms1</span> <span class="o">:=</span> <span class="n">msign</span><span class="p">(</span><span class="n">m</span><span class="p">)))</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">m</span> <span class="o">+</span> <span class="n">ms1</span> <span class="o">+</span> <span class="n">ms2</span> <span class="o">-</span> <span class="n">m</span> <span class="o">@</span> <span class="n">ms1</span><span class="o">.</span><span class="n">mT</span> <span class="o">@</span> <span class="n">ms2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

<span class="k">def</span><span class="w"> </span><span class="nf">mclip2</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;2nd version (2 non-nested msign)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ms1</span> <span class="o">=</span> <span class="n">msign</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
    <span class="n">ms2</span> <span class="o">=</span> <span class="n">msign</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">mT</span> <span class="o">@</span> <span class="n">m</span> <span class="o">-</span> <span class="n">jnp</span><span class="o">.</span><span class="kp">eye</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="kp">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">m</span> <span class="o">+</span> <span class="n">ms1</span> <span class="o">+</span> <span class="p">(</span><span class="n">ms1</span> <span class="o">-</span> <span class="n">m</span><span class="p">)</span> <span class="o">@</span> <span class="n">ms2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

<span class="k">def</span><span class="w"> </span><span class="nf">mclip3</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;3rd version (3 non-nested msign)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ms1</span> <span class="o">=</span> <span class="n">msign</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
    <span class="n">ms2</span> <span class="o">=</span> <span class="n">msign</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">mT</span> <span class="o">@</span> <span class="n">m</span> <span class="o">+</span> <span class="n">jnp</span><span class="o">.</span><span class="kp">eye</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="kp">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">ms3</span> <span class="o">=</span> <span class="n">msign</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">mT</span> <span class="o">@</span> <span class="n">m</span> <span class="o">-</span> <span class="n">jnp</span><span class="o">.</span><span class="kp">eye</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="kp">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">return</span> <span class="p">((</span><span class="n">ms1</span> <span class="o">+</span> <span class="n">m</span><span class="p">)</span> <span class="o">@</span> <span class="n">ms2</span>  <span class="o">+</span> <span class="p">(</span><span class="n">ms1</span> <span class="o">-</span> <span class="n">m</span><span class="p">)</span> <span class="o">@</span> <span class="n">ms3</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

<span class="k">def</span><span class="w"> </span><span class="nf">spectral_clip</span><span class="p">(</span><span class="n">W</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;@leloykun verision: https://leloykun.github.io/ponder/spectral-clipping/</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">m</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">W</span><span class="o">.</span><span class="kp">shape</span>
    <span class="n">H</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">block</span><span class="p">([[</span><span class="n">jnp</span><span class="o">.</span><span class="kp">eye</span><span class="p">(</span><span class="n">m</span><span class="p">),</span> <span class="n">W</span><span class="p">],</span> <span class="p">[</span><span class="n">W</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="kp">eye</span><span class="p">(</span><span class="n">n</span><span class="p">)]])</span>
    <span class="n">OH</span> <span class="o">=</span> <span class="n">msign</span><span class="p">(</span><span class="n">H</span><span class="p">)</span>
    <span class="n">P</span><span class="p">,</span> <span class="n">Q</span> <span class="o">=</span> <span class="n">OH</span><span class="p">[:</span><span class="n">m</span><span class="p">,</span> <span class="p">:</span><span class="n">m</span><span class="p">],</span> <span class="n">OH</span><span class="p">[:</span><span class="n">m</span><span class="p">,</span> <span class="n">m</span><span class="p">:]</span>
    <span class="k">return</span> <span class="n">Q</span> <span class="o">+</span> <span class="n">P</span> <span class="o">@</span> <span class="n">W</span>

<span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">4096</span><span class="p">,</span> <span class="mi">1024</span><span class="p">)</span>
<span class="n">u</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">vh</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="kp">svd</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">concatenate</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="kp">linspace</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">128</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="kp">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">896</span><span class="p">)])</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">sort</span><span class="p">(</span><span class="n">s</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">u</span> <span class="o">@</span> <span class="n">jnp</span><span class="o">.</span><span class="kp">diag</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">@</span> <span class="n">vh</span>  <span class="c1"># matrix with large singular values</span>

<span class="n">result0</span> <span class="o">=</span> <span class="n">u</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="kp">diag</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="kp">clip</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">@</span> <span class="n">vh</span>  <span class="c1"># exact result via SVD</span>
<span class="n">result1</span> <span class="o">=</span> <span class="n">mclip1</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="kp">astype</span><span class="p">(</span><span class="s1">&#39;bfloat16&#39;</span><span class="p">))</span>
<span class="n">result2</span> <span class="o">=</span> <span class="n">mclip2</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="kp">astype</span><span class="p">(</span><span class="s1">&#39;bfloat16&#39;</span><span class="p">))</span>
<span class="n">result3</span> <span class="o">=</span> <span class="n">mclip3</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="kp">astype</span><span class="p">(</span><span class="s1">&#39;bfloat16&#39;</span><span class="p">))</span>
<span class="n">result4</span> <span class="o">=</span> <span class="n">spectral_clip</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="kp">astype</span><span class="p">(</span><span class="s1">&#39;bfloat16&#39;</span><span class="p">))</span>

<span class="c1"># spectral norm of the resulting matrix, closer to 1 is better.</span>
<span class="n">jnp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="kp">svd</span><span class="p">(</span><span class="n">result0</span><span class="o">.</span><span class="kp">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">))[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># = 1</span>
<span class="n">jnp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="kp">svd</span><span class="p">(</span><span class="n">result1</span><span class="o">.</span><span class="kp">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">))[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># â‰ˆ 700</span>
<span class="n">jnp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="kp">svd</span><span class="p">(</span><span class="n">result2</span><span class="o">.</span><span class="kp">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">))[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># â‰ˆ 250</span>
<span class="n">jnp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="kp">svd</span><span class="p">(</span><span class="n">result3</span><span class="o">.</span><span class="kp">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">))[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># â‰ˆ 1.5</span>
<span class="n">jnp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="kp">svd</span><span class="p">(</span><span class="n">result4</span><span class="o">.</span><span class="kp">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">))[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># â‰ˆ 13</span>

<span class="c1"># mean absolute error of singular values, closer to 0 is better.</span>
<span class="n">jnp</span><span class="o">.</span><span class="kp">abs</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="kp">svd</span><span class="p">(</span><span class="n">result1</span><span class="o">.</span><span class="kp">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">))[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">s</span><span class="o">.</span><span class="kp">clip</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="kp">mean</span><span class="p">()</span>  <span class="c1"># â‰ˆ 20</span>
<span class="n">jnp</span><span class="o">.</span><span class="kp">abs</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="kp">svd</span><span class="p">(</span><span class="n">result2</span><span class="o">.</span><span class="kp">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">))[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">s</span><span class="o">.</span><span class="kp">clip</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="kp">mean</span><span class="p">()</span>  <span class="c1"># â‰ˆ 10</span>
<span class="n">jnp</span><span class="o">.</span><span class="kp">abs</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="kp">svd</span><span class="p">(</span><span class="n">result3</span><span class="o">.</span><span class="kp">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">))[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">s</span><span class="o">.</span><span class="kp">clip</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="kp">mean</span><span class="p">()</span>  <span class="c1"># â‰ˆ 0.5</span>
<span class="n">jnp</span><span class="o">.</span><span class="kp">abs</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="kp">svd</span><span class="p">(</span><span class="n">result4</span><span class="o">.</span><span class="kp">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">))[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">s</span><span class="o">.</span><span class="kp">clip</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="kp">mean</span><span class="p">()</span>  <span class="c1"># â‰ˆ 0.7</span>

<span class="c1"># mean absolute error of total matrix, closer to 0 is better.</span>
<span class="n">jnp</span><span class="o">.</span><span class="kp">abs</span><span class="p">(</span><span class="n">result0</span> <span class="o">-</span> <span class="n">result1</span><span class="p">)</span><span class="o">.</span><span class="kp">mean</span><span class="p">()</span>  <span class="c1"># â‰ˆ 1</span>
<span class="n">jnp</span><span class="o">.</span><span class="kp">abs</span><span class="p">(</span><span class="n">result0</span> <span class="o">-</span> <span class="n">result2</span><span class="p">)</span><span class="o">.</span><span class="kp">mean</span><span class="p">()</span>  <span class="c1"># â‰ˆ 0.5</span>
<span class="n">jnp</span><span class="o">.</span><span class="kp">abs</span><span class="p">(</span><span class="n">result0</span> <span class="o">-</span> <span class="n">result3</span><span class="p">)</span><span class="o">.</span><span class="kp">mean</span><span class="p">()</span>  <span class="c1"># â‰ˆ 0.01</span>
<span class="n">jnp</span><span class="o">.</span><span class="kp">abs</span><span class="p">(</span><span class="n">result0</span> <span class="o">-</span> <span class="n">result4</span><span class="p">)</span><span class="o">.</span><span class="kp">mean</span><span class="p">()</span>  <span class="c1"># â‰ˆ 0.02</span>
</code></pre></div>

<h2 id="_8">æ–‡ç« å°ç»“</h2>
<p>æœ¬æ–‡ç»§ç»­å®Œå–„äº†ä¸Šä¸€ç¯‡æ–‡ç« ç”¨$\msign$æ¥è®¡ç®—$\mclip$çš„æ–¹æ¡ˆï¼Œé€šè¿‡å»æ‰$\msign$çš„åµŒå¥—ä»¥åŠå¼•å…¥é¢å¤–çš„ä¿®æ­£é¡¹ï¼ŒæˆåŠŸé™ä½äº†è®¡ç®—è¯¯å·®ã€‚</p>
<p><em><strong>è½¬è½½åˆ°è¯·åŒ…æ‹¬æœ¬æ–‡åœ°å€ï¼š</strong><a href="https://spaces.ac.cn/archives/11059">https://spaces.ac.cn/archives/11059</a></em></p>
<p><em><strong>æ›´è¯¦ç»†çš„è½¬è½½äº‹å®œè¯·å‚è€ƒï¼š</strong></em><a href="https://spaces.ac.cn/archives/6508#%E6%96%87%E7%AB%A0%E5%A6%82%E4%BD%95%E8%BD%AC%E8%BD%BD/%E5%BC%95%E7%94%A8" title="ã€Šç§‘å­¦ç©ºé—´FAQã€‹">ã€Šç§‘å­¦ç©ºé—´FAQã€‹</a></p>
<p><strong>å¦‚æœæ‚¨è¿˜æœ‰ä»€ä¹ˆç–‘æƒ‘æˆ–å»ºè®®ï¼Œæ¬¢è¿åœ¨ä¸‹æ–¹è¯„è®ºåŒºç»§ç»­è®¨è®ºã€‚</strong></p>
<p><strong>å¦‚æœæ‚¨è§‰å¾—æœ¬æ–‡è¿˜ä¸é”™ï¼Œæ¬¢è¿åˆ†äº«/æ‰“èµæœ¬æ–‡ã€‚æ‰“èµå¹¶éè¦ä»ä¸­è·å¾—æ”¶ç›Šï¼Œè€Œæ˜¯å¸Œæœ›çŸ¥é“ç§‘å­¦ç©ºé—´è·å¾—äº†å¤šå°‘è¯»è€…çš„çœŸå¿ƒå…³æ³¨ã€‚å½“ç„¶ï¼Œå¦‚æœä½ æ— è§†å®ƒï¼Œä¹Ÿä¸ä¼šå½±å“ä½ çš„é˜…è¯»ã€‚å†æ¬¡è¡¨ç¤ºæ¬¢è¿å’Œæ„Ÿè°¢ï¼</strong></p>
<p>æ‰“èµ</p>
<p><img alt="ç§‘å­¦ç©ºé—´" src="https://spaces.ac.cn/usr/themes/geekg/payment/wx.png" /></p>
<p>å¾®ä¿¡æ‰“èµ</p>
<p><img alt="ç§‘å­¦ç©ºé—´" src="https://spaces.ac.cn/usr/themes/geekg/payment/zfb.png" /></p>
<p>æ”¯ä»˜å®æ‰“èµ</p>
<p>å› ä¸ºç½‘ç«™åå°å¯¹æ‰“èµå¹¶æ— è®°å½•ï¼Œå› æ­¤æ¬¢è¿åœ¨æ‰“èµæ—¶å€™å¤‡æ³¨ç•™è¨€ã€‚ä½ è¿˜å¯ä»¥<a href="http://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&amp;email=tN7d1drY3drrx8H0xcWa19vZ"><strong>ç‚¹å‡»è¿™é‡Œ</strong></a>æˆ–åœ¨ä¸‹æ–¹è¯„è®ºåŒºç•™è¨€æ¥å‘ŠçŸ¥ä½ çš„å»ºè®®æˆ–éœ€æ±‚ã€‚</p>
<p><strong>å¦‚æœæ‚¨éœ€è¦å¼•ç”¨æœ¬æ–‡ï¼Œè¯·å‚è€ƒï¼š</strong></p>
<p>è‹å‰‘æ—. (Jun. 23, 2025). ã€Šé€šè¿‡msignæ¥è®¡ç®—å¥‡å¼‚å€¼è£å‰ªmclipï¼ˆä¸‹ï¼‰ ã€‹[Blog post]. Retrieved from <a href="https://spaces.ac.cn/archives/11059">https://spaces.ac.cn/archives/11059</a></p>
<p>@online{kexuefm-11059,<br />
title={é€šè¿‡msignæ¥è®¡ç®—å¥‡å¼‚å€¼è£å‰ªmclipï¼ˆä¸‹ï¼‰},<br />
author={è‹å‰‘æ—},<br />
year={2025},<br />
month={Jun},<br />
url={\url{https://spaces.ac.cn/archives/11059}},<br />
} </p>
<hr />
<h2 id="_9">å…¬å¼æ¨å¯¼ä¸æ³¨é‡Š</h2>
<p>æœ¬èŠ‚å°†ä»æ•°å€¼åˆ†æã€æ·±åº¦å­¦ä¹ å’Œå·¥ç¨‹å®è·µä¸‰ä¸ªè§’åº¦ï¼Œå¯¹æœ¬æ–‡æ¶‰åŠçš„ç®—æ³•è¿›è¡Œæè¯¦ç»†çš„æ•°å­¦æ¨å¯¼å’Œåˆ†æã€‚</p>
<h3 id="1-newton-schulz">1. Newton-Schulzè¿­ä»£çš„é«˜é˜¶æ”¶æ•›æ€§åˆ†æ</h3>
<h4 id="11">1.1 åŸºæœ¬è¿­ä»£æ ¼å¼</h4>
<p>Newton-Schulzè¿­ä»£æ˜¯ä¸€ç§è®¡ç®—çŸ©é˜µç¬¦å·å‡½æ•°$\msign(\boldsymbol{M})$çš„é«˜æ•ˆæ–¹æ³•ã€‚å…¶åŸºæœ¬è¿­ä»£æ ¼å¼ä¸ºï¼š
\begin{equation}
\boldsymbol{Y}<em _infty="\infty">{k+1} = \boldsymbol{Y}_k(a\boldsymbol{I} + b\boldsymbol{Y}_k^{\top}\boldsymbol{Y}_k + c(\boldsymbol{Y}_k^{\top}\boldsymbol{Y}_k)^2)
\end{equation}
å…¶ä¸­$a, b, c$æ˜¯ç²¾å¿ƒé€‰æ‹©çš„ç³»æ•°ï¼Œç”¨äºåŠ é€Ÿæ”¶æ•›ã€‚è®¾$\boldsymbol{M}=\boldsymbol{U}\boldsymbol{\Sigma}\boldsymbol{V}^{\top}$æ˜¯SVDåˆ†è§£ï¼Œç†è®ºä¸Šè¿­ä»£æ”¶æ•›åˆ°$\boldsymbol{Y}</em>)$ã€‚} = \boldsymbol{U}\boldsymbol{V}^{\top} = \msign(\boldsymbol{M</p>
<h4 id="12">1.2 æ”¶æ•›æ€§åˆ†æ</h4>
<p>ä¸ºäº†åˆ†ææ”¶æ•›æ€§ï¼Œæˆ‘ä»¬å¼•å…¥è¯¯å·®åº¦é‡ã€‚è®¾$\boldsymbol{E}<em _infty="\infty">k = \boldsymbol{Y}_k - \boldsymbol{Y}</em>$ä¸ºç¬¬$k$æ­¥çš„è¯¯å·®çŸ©é˜µã€‚åœ¨SVDæ¡†æ¶ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥å†™ï¼š
\begin{equation}
\boldsymbol{Y}<em k_i="k,i">k = \boldsymbol{U}\boldsymbol{D}_k\boldsymbol{V}^{\top}
\end{equation}
å…¶ä¸­$\boldsymbol{D}_k$æ˜¯å¯¹è§’çŸ©é˜µï¼Œç¬¬$i$ä¸ªå¯¹è§’å…ƒç´ $d</em>$è¡¨ç¤ºå¯¹åº”å¥‡å¼‚æ–¹å‘çš„è¿‘ä¼¼å€¼ã€‚ç†è®ºä¸Šåº”æ”¶æ•›åˆ°1ã€‚</p>
<p><strong>å®šç†1ï¼ˆæ”¶æ•›é˜¶ï¼‰</strong>ï¼šå¦‚æœç³»æ•°$(a,b,c)$æ»¡è¶³PadÃ©è¿‘ä¼¼æ¡ä»¶ï¼Œåˆ™Newton-Schulzè¿­ä»£å…·æœ‰è‡³å°‘3é˜¶æ”¶æ•›æ€§ï¼š
\begin{equation}
|d_{k+1,i} - 1| \leq C|d_{k,i} - 1|^3
\end{equation}</p>
<p><strong>è¯æ˜</strong>ï¼šè€ƒè™‘å•ä¸ªå¯¹è§’å…ƒç´ çš„è¿­ä»£ã€‚è®¾$d_k$æ˜¯æŸä¸ªå¯¹è§’å…ƒç´ ï¼Œ$\sigma$æ˜¯å¯¹åº”çš„å¥‡å¼‚å€¼ã€‚åœ¨åˆå§‹åŒ–$\boldsymbol{Y}<em k_1="k+1">0 = \boldsymbol{M}/|\boldsymbol{M}|_F$åï¼Œæœ‰$d_0 \approx \sigma/|\boldsymbol{M}|_F$ã€‚è¿­ä»£å…³ç³»å˜ä¸ºï¼š
\begin{equation}
d</em> = d_k(a + bd_k^2 + cd_k^4)
\end{equation}</p>
<p>è®¾$e_k = d_k - 1$ä¸ºè¯¯å·®ï¼Œå±•å¼€å¾—ï¼š
\begin{align}
d_{k+1} &amp;= (1+e_k)\left(a + b(1+e_k)^2 + c(1+e_k)^4\right)\
&amp;= (1+e_k)\left(a + b(1+2e_k+e_k^2) + c(1+4e_k+6e_k^2+4e_k^3+e_k^4)\right)\
&amp;= (1+e_k)(a+b+c + 2be_k+4ce_k + \mathcal{O}(e_k^2))
\end{align}</p>
<p>è‹¥è¦æ±‚$d_{k+1} = 1 + \mathcal{O}(e_k^3)$ï¼Œéœ€è¦ï¼š
\begin{equation}
\begin{cases}
a + b + c = 1 \quad &amp;\text{(æ’ç­‰æ¡ä»¶)}\
1 + 2b + 4c = 0 \quad &amp;\text{(ä¸€é˜¶æ¶ˆé™¤)}\
a + 3b + 7c = 0 \quad &amp;\text{(äºŒé˜¶æ¶ˆé™¤)}
\end{cases}
\end{equation}</p>
<p>è§£è¿™ä¸ªæ–¹ç¨‹ç»„å¾—åˆ°ï¼š
\begin{equation}
a = \frac{15}{8},\quad b = -\frac{5}{4},\quad c = \frac{3}{8}
\end{equation}</p>
<p>è¿™æ­£æ˜¯5é˜¶PadÃ©è¿‘ä¼¼$[2/2]$çš„ç³»æ•°ã€‚ä»£å…¥åï¼Œè¯¯å·®æ»¡è¶³ï¼š
\begin{equation}
e_{k+1} = -\frac{5}{2}e_k^3 + \mathcal{O}(e_k^5)
\end{equation}
å› æ­¤æ”¶æ•›é˜¶è‡³å°‘ä¸º3ã€‚$\square$</p>
<h4 id="13">1.3 æ”¶æ•›é€Ÿåº¦çš„é‡åŒ–ä¼°è®¡</h4>
<p><strong>å®šç†2ï¼ˆæ”¶æ•›é€Ÿåº¦ï¼‰</strong>ï¼šè®¾åˆå§‹è¯¯å·®$|e_0| &lt; \rho &lt; 1$ï¼Œåˆ™ç»è¿‡$k$æ­¥è¿­ä»£åï¼š
\begin{equation}
|e_k| \leq \frac{\rho^{3^k}}{C^{(3^k-1)/2}}
\end{equation}
å…¶ä¸­$C$æ˜¯ä¾èµ–äº$(a,b,c)$çš„å¸¸æ•°ã€‚</p>
<p>è¿™æ„å‘³ç€è¯¯å·®å‘ˆä¸‰æ¬¡æ–¹å¼è¡°å‡ã€‚ä¾‹å¦‚ï¼Œå¦‚æœ$e_0 = 0.1$ï¼Œåˆ™ï¼š
- $e_1 \sim 0.1^3 = 10^{-3}$
- $e_2 \sim (10^{-3})^3 = 10^{-9}$
- $e_3 \sim (10^{-9})^3 = 10^{-27}$</p>
<p>å› æ­¤3-5æ­¥è¿­ä»£é€šå¸¸å·²è¶³å¤Ÿè¾¾åˆ°æœºå™¨ç²¾åº¦ã€‚</p>
<h4 id="14">1.4 æ¡ä»¶æ•°çš„å½±å“</h4>
<p>çŸ©é˜µçš„æ¡ä»¶æ•°$\kappa(\boldsymbol{M}) = \sigma_{\max}/\sigma_{\min}$ä¼šæ˜¾è‘—å½±å“æ”¶æ•›é€Ÿåº¦ã€‚å¯¹äºç—…æ€çŸ©é˜µï¼ˆ$\kappa \gg 1$ï¼‰ï¼Œåˆå§‹è¯¯å·®$e_0$åœ¨ä¸åŒå¥‡å¼‚å€¼æ–¹å‘ä¸Šå·®å¼‚å·¨å¤§ï¼š
\begin{equation}
e_{0,i} = \frac{\sigma_i}{|\boldsymbol{M}|_F} - 1 \approx \frac{\sigma_i}{\sqrt{\sum_j\sigma_j^2}} - 1
\end{equation}</p>
<p>å½“$\sigma_{\max} \gg \sigma_{\min}$æ—¶ï¼Œå°å¥‡å¼‚å€¼å¯¹åº”çš„$e_{0,i}$æ¥è¿‘-1ï¼Œéœ€è¦æ›´å¤šè¿­ä»£æ­¥æ•°æ‰èƒ½æ”¶æ•›ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆä»£ç ä¸­é‡‡ç”¨äº†è‡ªé€‚åº”çš„å½’ä¸€åŒ–ç­–ç•¥ã€‚</p>
<h3 id="2">2. è‡ªé€‚åº”æ­¥é•¿ç­–ç•¥çš„æ•°å­¦æ¨å¯¼</h3>
<h4 id="21">2.1 åŠ¨æ€å½’ä¸€åŒ–</h4>
<p>ä»£ç ä¸­çš„å½’ä¸€åŒ–æ­¥éª¤ï¼š
\begin{equation}
\boldsymbol{Y}_0 = \frac{\boldsymbol{M}}{\sqrt{|\boldsymbol{M}|_F^2 + \epsilon}}
\end{equation}</p>
<p>è¿™é‡Œ$\epsilon &gt; 0$æ˜¯ä¸€ä¸ªå°çš„æ­£åˆ™åŒ–é¡¹ã€‚ä»æ”¶æ•›æ€§è§’åº¦ï¼Œè¿™ä¸ªå½’ä¸€åŒ–æœ‰ä¸¤ä¸ªä½œç”¨ï¼š</p>
<p><strong>ä½œç”¨1ï¼ˆå‹ç¼©è°±ï¼‰</strong>ï¼šå°†æ‰€æœ‰å¥‡å¼‚å€¼å‹ç¼©åˆ°$[0, 1)$åŒºé—´ï¼Œä½¿å¾—åˆå§‹è¯¯å·®$|e_{0,i}| &lt; 1$å¯¹æ‰€æœ‰$i$æˆç«‹ï¼Œä¿è¯æ”¶æ•›ã€‚</p>
<p><strong>ä½œç”¨2ï¼ˆç¨³å®šæ€§ï¼‰</strong>ï¼šå½“$\boldsymbol{M}$æ¥è¿‘é›¶çŸ©é˜µæ—¶ï¼Œ$\epsilon$é˜²æ­¢é™¤é›¶ï¼Œä¿æŒæ•°å€¼ç¨³å®šã€‚</p>
<h4 id="22">2.2 è‡ªé€‚åº”ç³»æ•°ç¼©æ”¾</h4>
<p>ä»£ç ä¸­çš„ç³»æ•°ç¼©æ”¾ï¼š
\begin{equation}
a' = \frac{a}{\gamma},\quad b' = \frac{b}{\gamma^3},\quad c' = \frac{c}{\gamma^5}
\end{equation}
å…¶ä¸­$\gamma &gt; 1$ï¼ˆå¦‚$\gamma=1.01$ï¼‰ã€‚</p>
<p><strong>å¼•ç†1ï¼ˆä¿å®ˆåŒ–ï¼‰</strong>ï¼šç¼©æ”¾åçš„è¿­ä»£å¯¹åº”äºæ”¶æ•›åŸŸæ‰©å¤§çš„PadÃ©è¿‘ä¼¼ã€‚</p>
<p><strong>è¯æ˜</strong>ï¼šè€ƒè™‘è¿­ä»£å‡½æ•°$f(d) = d(a + bd^2 + cd^4)$ã€‚å…¶ä¸åŠ¨ç‚¹æ–¹ç¨‹ä¸º$f(d) = d$ï¼Œå³$a + bd^2 + cd^4 = 1$ã€‚è¿™æ˜¯ä¸€ä¸ªå…³äº$d^2$çš„äºŒæ¬¡æ–¹ç¨‹ï¼š
\begin{equation}
cd^4 + bd^2 + (a-1) = 0
\end{equation}</p>
<p>åˆ¤åˆ«å¼ä¸º$\Delta = b^2 - 4c(a-1)$ã€‚å½“$(a,b,c)$æ»¡è¶³PadÃ©æ¡ä»¶æ—¶ï¼Œ$\Delta &gt; 0$ä¿è¯æœ‰ä¸¤ä¸ªå®æ ¹ã€‚å¼•å…¥ç¼©æ”¾å› å­$\gamma$åï¼Œæ–°æ–¹ç¨‹å˜ä¸ºï¼š
\begin{equation}
\frac{c}{\gamma^5}d^4 + \frac{b}{\gamma^3}d^2 + \left(\frac{a}{\gamma}-1\right) = 0
\end{equation}</p>
<p>ä¹˜ä»¥$\gamma^5$ï¼š
\begin{equation}
cd^4 + b\gamma^2 d^2 + \gamma^5\left(\frac{a}{\gamma}-1\right) = 0
\end{equation}</p>
<p>å½“$\gamma \to 1^+$æ—¶ï¼Œæ–¹ç¨‹é€€åŒ–åˆ°åŸå§‹å½¢å¼ã€‚$\gamma &gt; 1$æ—¶ï¼Œç›¸å½“äºå¢å¤§äº†$b$çš„ç³»æ•°ï¼ˆå‡è®¾$b &lt; 0$ï¼‰ï¼Œè¿™ä¼šç¼©å°ä¸åŠ¨ç‚¹é™„è¿‘çš„æ’æ–¥åŒºåŸŸï¼Œæ‰©å¤§å¸å¼•åŸŸã€‚$\square$</p>
<h4 id="23">2.3 æ¸è¿›å¼æ­¥é•¿è°ƒæ•´</h4>
<p>å¯¹äºæç«¯ç—…æ€çŸ©é˜µï¼Œå¯ä»¥é‡‡ç”¨æ¸è¿›å¼æ­¥é•¿ç­–ç•¥ï¼š
\begin{equation}
\gamma_k = 1 + \frac{\gamma_0 - 1}{1 + k/k_0}
\end{equation}
å…¶ä¸­$\gamma_0 &gt; 1$æ˜¯åˆå§‹ç¼©æ”¾å› å­ï¼Œ$k_0$æ§åˆ¶è¡°å‡é€Ÿåº¦ã€‚è¿™æ ·å‰å‡ æ­¥è¿­ä»£æ›´ä¿å®ˆï¼ˆ$\gamma$è¾ƒå¤§ï¼‰ï¼Œåç»­æ­¥éª¤é€æ¸åŠ é€Ÿï¼ˆ$\gamma \to 1$ï¼‰ã€‚</p>
<h3 id="3">3. è°±æ¡ä»¶æ•°çš„å½±å“åˆ†æ</h3>
<h4 id="31">3.1 æ¡ä»¶æ•°å¯¹è¯¯å·®ä¼ æ’­çš„å½±å“</h4>
<p>è®¾$\boldsymbol{M} = \boldsymbol{U}\boldsymbol{\Sigma}\boldsymbol{V}^{\top}$ï¼Œæ¡ä»¶æ•°$\kappa = \sigma_1/\sigma_r$ï¼ˆ$r$æ˜¯ç§©ï¼‰ã€‚è€ƒè™‘è®¡ç®—$\boldsymbol{M}^{\top}\boldsymbol{M}$æ—¶çš„æ•°å€¼è¯¯å·®ï¼š
\begin{equation}
\widehat{\boldsymbol{M}^{\top}\boldsymbol{M}} = \boldsymbol{M}^{\top}\boldsymbol{M} + \boldsymbol{E}
\end{equation}
å…¶ä¸­$|\boldsymbol{E}|<em _text_mach="\text{mach">F \leq \epsilon</em>|_F^2$æ˜¯æœºå™¨ç²¾åº¦å¼•èµ·çš„è¯¯å·®ã€‚}}|\boldsymbol{M</p>
<p>åœ¨SVDæ¡†æ¶ä¸‹ï¼š
\begin{equation}
\boldsymbol{M}^{\top}\boldsymbol{M} = \boldsymbol{V}\boldsymbol{\Sigma}^2\boldsymbol{V}^{\top}
\end{equation}</p>
<p>è¯¯å·®$\boldsymbol{E}$ä¼šå¯¼è‡´ç‰¹å¾å€¼çš„æ‰°åŠ¨ã€‚æ ¹æ®Weylå®šç†ï¼Œç¬¬$i$ä¸ªç‰¹å¾å€¼çš„æ‰°åŠ¨æ»¡è¶³ï¼š
\begin{equation}
|\lambda_i(\widehat{\boldsymbol{M}^{\top}\boldsymbol{M}}) - \sigma_i^2| \leq |\boldsymbol{E}|<em _text_mach="\text{mach">2 \leq \epsilon</em>\sigma_1^2
\end{equation}}</p>
<p><strong>ç›¸å¯¹è¯¯å·®æ”¾å¤§</strong>ï¼šå¯¹äºå°å¥‡å¼‚å€¼$\sigma_r \ll \sigma_1$ï¼Œå…¶å¹³æ–¹$\sigma_r^2$çš„ç›¸å¯¹è¯¯å·®ä¸ºï¼š
\begin{equation}
\frac{|\lambda_r(\widehat{\boldsymbol{M}^{\top}\boldsymbol{M}}) - \sigma_r^2|}{\sigma_r^2} \leq \frac{\epsilon_{\text{mach}}\sigma_1^2}{\sigma_r^2} = \epsilon_{\text{mach}}\kappa^2
\end{equation}</p>
<p>è¿™è¡¨æ˜æ¡ä»¶æ•°çš„å¹³æ–¹ä¼šæ”¾å¤§ç›¸å¯¹è¯¯å·®ï¼å½“$\kappa = 1000$æ—¶ï¼Œç›¸å¯¹è¯¯å·®æ”¾å¤§äº†$10^6$å€ã€‚</p>
<h4 id="32-msign">3.2 åœ¨$\msign$è®¡ç®—ä¸­çš„ä½“ç°</h4>
<p>è®¡ç®—$\msign(\boldsymbol{M}^{\top}\boldsymbol{M} - \boldsymbol{I})$æ—¶ï¼Œå°äº1çš„ç‰¹å¾å€¼å¯¹åº”çš„$\lambda_i - 1 &lt; 0$ï¼Œåº”è¯¥ç»™å‡º$-1$çš„ç¬¦å·ã€‚ä½†å¦‚æœæ•°å€¼è¯¯å·®ä½¿å¾—$\lambda_i - 1$çš„ç¬¦å·ç¿»è½¬ï¼ˆä»-0.001å˜æˆ+0.001ï¼‰ï¼Œåˆ™$\msign$çš„ç»“æœä¼šä»-1å˜æˆ+1ï¼Œå¯¼è‡´å®Œå…¨é”™è¯¯çš„ç»“æœã€‚</p>
<p><strong>ä¸´ç•Œå¥‡å¼‚å€¼é—®é¢˜</strong>ï¼šæœ€å±é™©çš„æ˜¯æ¥è¿‘1çš„å¥‡å¼‚å€¼ã€‚è®¾$\sigma_i = 1 + \delta$ï¼Œ$|\delta| \ll 1$ã€‚åˆ™ï¼š
\begin{equation}
\sigma_i^2 - 1 = (1+\delta)^2 - 1 = 2\delta + \delta^2 \approx 2\delta
\end{equation}</p>
<p>å¦‚æœ$|\delta| \sim \epsilon_{\text{mach}}\kappa^2$ï¼Œåˆ™$\sigma_i^2 - 1$çš„ç¬¦å·åœ¨æ•°å€¼ä¸Šä¸å¯é ã€‚</p>
<h4 id="33-vs">3.3 åŒç²¾åº¦vsåŠç²¾åº¦çš„æ¡ä»¶æ•°ä¸´ç•Œç‚¹</h4>
<p>å¯¹äºä¸åŒç²¾åº¦ï¼š
- <strong>Float32</strong>ï¼š$\epsilon_{\text{mach}} \approx 10^{-7}$ï¼Œä¸´ç•Œæ¡ä»¶æ•°$\kappa_{\text{crit}} \sim 10^{3.5} \approx 3000$
- <strong>BFloat16</strong>ï¼š$\epsilon_{\text{mach}} \approx 10^{-3}$ï¼Œä¸´ç•Œæ¡ä»¶æ•°$\kappa_{\text{crit}} \sim 10^{1.5} \approx 30$
- <strong>Float16</strong>ï¼š$\epsilon_{\text{mach}} \approx 10^{-4}$ï¼Œä¸´ç•Œæ¡ä»¶æ•°$\kappa_{\text{crit}} \sim 10^{2} = 100$</p>
<p>è¿™è§£é‡Šäº†ä¸ºä»€ä¹ˆåœ¨bfloat16ä¸‹ï¼Œ$\sigma_{\max} = 1000$çš„çŸ©é˜µä¼šå‡ºç°å·¨å¤§è¯¯å·®ã€‚</p>
<h3 id="4">4. é¢„å¤„ç†æŠ€æœ¯</h3>
<h4 id="41-spectral-normalization">4.1 è°±å½’ä¸€åŒ–ï¼ˆSpectral Normalizationï¼‰</h4>
<p>å¯¹äºæ¡ä»¶æ•°è¿‡å¤§çš„çŸ©é˜µï¼Œé¢„å¤„ç†çš„åŸºæœ¬æ€è·¯æ˜¯ï¼š
\begin{equation}
\widetilde{\boldsymbol{M}} = \frac{\boldsymbol{M}}{|\boldsymbol{M}|_2} = \boldsymbol{U}\frac{\boldsymbol{\Sigma}}{\sigma_1}\boldsymbol{V}^{\top}
\end{equation}</p>
<p>è¿™æ ·$\widetilde{\kappa} = \sigma_1/(\sigma_r\sigma_1) = 1/\widetilde{\sigma}_r$ï¼Œå°†æ¡ä»¶æ•°ä»$\sigma_1/\sigma_r$é™ä½åˆ°$1/\widetilde{\sigma}_r$ï¼ˆå‡è®¾å½’ä¸€åŒ–åæœ€å¤§å¥‡å¼‚å€¼ä¸º1ï¼‰ã€‚</p>
<p><strong>é—®é¢˜</strong>ï¼šè®¡ç®—$|\boldsymbol{M}|_2$æœ¬èº«éœ€è¦å¹‚è¿­ä»£ï¼Œä»£ä»·è¾ƒé«˜ã€‚</p>
<h4 id="42-frobenius">4.2 FrobeniusèŒƒæ•°å½’ä¸€åŒ–ï¼ˆå·²é‡‡ç”¨ï¼‰</h4>
<p>ä»£ç é‡‡ç”¨çš„æ–¹æ¡ˆï¼š
\begin{equation}
\widetilde{\boldsymbol{M}} = \frac{\boldsymbol{M}}{|\boldsymbol{M}|_F}
\end{equation}</p>
<p>å…¶ä¸­$|\boldsymbol{M}|_F = \sqrt{\sum_i\sigma_i^2}$ã€‚è¿™ç§å½’ä¸€åŒ–ï¼š
- <strong>ä¼˜ç‚¹</strong>ï¼šè®¡ç®—ä»£ä»·$O(nm)$ï¼Œä»…éœ€ä¸€æ¬¡çŸ©é˜µéå†
- <strong>ç¼ºç‚¹</strong>ï¼šä¸èƒ½ä¿è¯æœ€å¤§å¥‡å¼‚å€¼ä¸º1</p>
<p>è®¾$\boldsymbol{M}$çš„å¥‡å¼‚å€¼ä¸º$\sigma_1 \geq \sigma_2 \geq \cdots \geq \sigma_r$ã€‚å½’ä¸€åŒ–åï¼š
\begin{equation}
\widetilde{\sigma}_i = \frac{\sigma_i}{\sqrt{\sum_j\sigma_j^2}}
\end{equation}</p>
<p>æœ€åæƒ…å†µï¼ˆåªæœ‰ä¸€ä¸ªéé›¶å¥‡å¼‚å€¼ï¼‰ï¼š$\widetilde{\sigma}_1 = 1$ã€‚
æœ€å¥½æƒ…å†µï¼ˆæ‰€æœ‰å¥‡å¼‚å€¼ç›¸ç­‰ï¼‰ï¼š$\widetilde{\sigma}_i = 1/\sqrt{r}$ï¼Œæœ€å¤§å¥‡å¼‚å€¼è¢«è¿‡åº¦å‹ç¼©ã€‚</p>
<h4 id="43-balanced-scaling">4.3 å¹³è¡¡ç¼©æ”¾ï¼ˆBalanced Scalingï¼‰</h4>
<p>æ›´ç²¾ç»†çš„é¢„å¤„ç†æ˜¯å¯¹è¡Œå’Œåˆ—åˆ†åˆ«ç¼©æ”¾ï¼š
\begin{equation}
\widetilde{\boldsymbol{M}} = \boldsymbol{D}_r^{-1}\boldsymbol{M}\boldsymbol{D}_c^{-1}
\end{equation}
å…¶ä¸­$\boldsymbol{D}_r, \boldsymbol{D}_c$æ˜¯å¯¹è§’çŸ©é˜µï¼Œé€‰æ‹©ä½¿å¾—$\widetilde{\boldsymbol{M}}$çš„è¡ŒèŒƒæ•°å’Œåˆ—èŒƒæ•°å°½å¯èƒ½æ¥è¿‘ã€‚</p>
<p><strong>Sinkhorn-Knoppç®—æ³•</strong>ï¼šè¿­ä»£è®¡ç®—
\begin{align}
\boldsymbol{d}<em _text_row="\text{row">r^{(k+1)} &amp;= |\boldsymbol{M}^{(k)}|</em>\
\boldsymbol{M}^{(k+1)} &amp;= \text{diag}(\boldsymbol{d}}<em _text_col="\text{col">r^{(k+1)})^{-1}\boldsymbol{M}^{(k)}\
\boldsymbol{d}_c^{(k+1)} &amp;= |\boldsymbol{M}^{(k+1)}|</em>\
\boldsymbol{M}^{(k+1)} &amp;= \boldsymbol{M}^{(k+1)}\text{diag}(\boldsymbol{d}_c^{(k+1)})^{-1}
\end{align}}</p>
<p>é€šå¸¸2-3æ¬¡è¿­ä»£å³å¯æ˜¾è‘—æ”¹å–„æ¡ä»¶æ•°ã€‚</p>
<h4 id="44-regularization">4.4 æ­£åˆ™åŒ–ï¼ˆRegularizationï¼‰</h4>
<p>åœ¨å¼$\eqref{eq:mclip-3}$ä¸­ï¼Œè®¡ç®—$\boldsymbol{M}^{\top}\boldsymbol{M} \pm \boldsymbol{I}$æ—¶ï¼Œå¯æ·»åŠ æ­£åˆ™åŒ–ï¼š
\begin{equation}
\boldsymbol{M}^{\top}\boldsymbol{M} + (1+\lambda)\boldsymbol{I}
\end{equation}
å…¶ä¸­$\lambda &gt; 0$æ˜¯å°çš„æ­£åˆ™åŒ–å‚æ•°ï¼ˆå¦‚$10^{-6}$ï¼‰ã€‚è¿™ç¡®ä¿çŸ©é˜µä¸¥æ ¼æ­£å®šï¼Œé¿å…æ¥è¿‘å¥‡å¼‚çš„æƒ…å†µã€‚</p>
<p>åœ¨bfloat16ä¸‹ï¼Œæ¨è$\lambda \sim 10^{-3}$ã€‚</p>
<h3 id="5">5. æ®‹å·®ç›‘æ§å’Œæå‰ç»ˆæ­¢ç­–ç•¥</h3>
<h4 id="51">5.1 æ®‹å·®å®šä¹‰</h4>
<p>Newton-Schulzè¿­ä»£ä¸­ï¼Œè‡ªç„¶çš„æ®‹å·®æ˜¯ï¼š
\begin{equation}
R_k = |\boldsymbol{Y}_k\boldsymbol{Y}_k^{\top} - \boldsymbol{I}|_F
\end{equation}</p>
<p>è¿™åº¦é‡äº†$\boldsymbol{Y}<em _infty="\infty">k$åç¦»æ­£äº¤çŸ©é˜µçš„ç¨‹åº¦ã€‚ç†è®ºä¸Š$R</em> = 0$ã€‚</p>
<p><strong>æ›¿ä»£æ®‹å·®</strong>ï¼ˆè®¡ç®—ä»£ä»·æ›´ä½ï¼‰ï¼š
\begin{equation}
R_k' = |\boldsymbol{Y}<em k-1="k-1">k - \boldsymbol{Y}</em>_k|_F
\end{equation}}|_F / |\boldsymbol{Y</p>
<p>è¿™åº¦é‡ç›¸é‚»ä¸¤æ­¥çš„ç›¸å¯¹å˜åŒ–ã€‚å½“$R_k' &lt; \epsilon_{\text{tol}}$æ—¶åœæ­¢è¿­ä»£ã€‚</p>
<h4 id="52">5.2 æå‰ç»ˆæ­¢ç­–ç•¥</h4>
<p><strong>ç®€å•ç­–ç•¥</strong>ï¼šè®¾å®šæœ€å¤§æ­¥æ•°$K_{\max}$å’Œå®¹å·®$\epsilon_{\text{tol}}$ã€‚</p>
<div class="codehilite"><pre><span></span><code>for k in range(K_max):
    Y_next = update(Y_k)
    if ||Y_next - Y_k|| / ||Y_k|| &lt; epsilon_tol:
        break
    Y_k = Y_next
</code></pre></div>

<p><strong>è‡ªé€‚åº”ç­–ç•¥</strong>ï¼šæ ¹æ®æ”¶æ•›é€Ÿåº¦åŠ¨æ€è°ƒæ•´ã€‚å¦‚æœè¿ç»­ä¸¤æ­¥æ®‹å·®æ¯”$R_k/R_{k-1} &gt; 0.9$ï¼ˆæ”¶æ•›åœæ»ï¼‰ï¼Œå¢åŠ è¿­ä»£æ­¥æ•°æˆ–åˆ‡æ¢åˆ°æ›´ç¨³å®šçš„æ–¹æ³•ã€‚</p>
<h4 id="53">5.3 ä¸‰é˜¶æ”¶æ•›çš„æ®‹å·®è¡°å‡è§„å¾‹</h4>
<p>å¯¹äºä¸‰é˜¶æ”¶æ•›ï¼Œç†è®ºä¸Šï¼š
\begin{equation}
R_{k+1} \leq C \cdot R_k^3
\end{equation}</p>
<p>å› æ­¤æ®‹å·®çš„å¯¹æ•°æ»¡è¶³ï¼š
\begin{equation}
\log R_{k+1} \leq \log C + 3\log R_k
\end{equation}</p>
<p>è¿™æ„å‘³ç€$\log R_k$å¤§è‡´ä»¥å‡ ä½•çº§æ•°è¡°å‡ã€‚ç›‘æ§$\log R_k$çš„çº¿æ€§åº¦å¯ä»¥åˆ¤æ–­æ˜¯å¦è¾¾åˆ°ä¸‰é˜¶æ”¶æ•›åŒºåŸŸã€‚</p>
<h3 id="6">6. åå‘ä¼ æ’­çš„æ¢¯åº¦è®¡ç®—</h3>
<h4 id="61-msign">6.1 $\msign$çš„æ¢¯åº¦</h4>
<p>è®¾æŸå¤±å‡½æ•°ä¸º$L$ï¼Œéœ€è¦è®¡ç®—$\frac{\partial L}{\partial \boldsymbol{M}}$ï¼Œå·²çŸ¥$\frac{\partial L}{\partial \boldsymbol{Y}}$å…¶ä¸­$\boldsymbol{Y} = \msign(\boldsymbol{M})$ã€‚</p>
<p><strong>å®šç†3ï¼ˆéšå‡½æ•°æ±‚å¯¼ï¼‰</strong>ï¼š$\msign(\boldsymbol{M})$æ»¡è¶³æ–¹ç¨‹ï¼š
\begin{equation}
\boldsymbol{Y}\boldsymbol{Y}^{\top}\boldsymbol{Y} = \boldsymbol{Y}
\end{equation}</p>
<p>å¯¹ä¸¤è¾¹æ±‚å¾®åˆ†ï¼š
\begin{equation}
d\boldsymbol{Y}\cdot\boldsymbol{Y}^{\top}\boldsymbol{Y} + \boldsymbol{Y}\cdot d\boldsymbol{Y}^{\top}\cdot\boldsymbol{Y} + \boldsymbol{Y}\boldsymbol{Y}^{\top}\cdot d\boldsymbol{Y} = d\boldsymbol{Y}
\end{equation}</p>
<p>æ•´ç†å¾—ï¼š
\begin{equation}
(d\boldsymbol{Y})\boldsymbol{Y}^{\top}\boldsymbol{Y} + \boldsymbol{Y}(d\boldsymbol{Y})^{\top}\boldsymbol{Y} + \boldsymbol{Y}\boldsymbol{Y}^{\top}(d\boldsymbol{Y}) = d\boldsymbol{Y}
\end{equation}</p>
<p>è¿™æ˜¯å…³äº$d\boldsymbol{Y}$çš„Sylvesteræ–¹ç¨‹ã€‚</p>
<p><strong>ç›´æ¥æ–¹æ³•</strong>ï¼šåˆ©ç”¨SVDç»“æ„ã€‚è®¾$\boldsymbol{M} = \boldsymbol{U}\boldsymbol{\Sigma}\boldsymbol{V}^{\top}$ï¼Œ$\boldsymbol{Y} = \boldsymbol{U}\boldsymbol{V}^{\top}$ã€‚å¯¹$\boldsymbol{M}$çš„æ‰°åŠ¨ï¼š
\begin{equation}
\boldsymbol{M} + d\boldsymbol{M} = (\boldsymbol{U}+d\boldsymbol{U})(\boldsymbol{\Sigma}+d\boldsymbol{\Sigma})(\boldsymbol{V}+d\boldsymbol{V})^{\top}
\end{equation}</p>
<p>å¿½ç•¥é«˜é˜¶é¡¹å¹¶åˆ©ç”¨$\boldsymbol{U}^{\top}d\boldsymbol{U} + d\boldsymbol{U}^{\top}\boldsymbol{U} = \boldsymbol{0}$ï¼ˆæ­£äº¤æ€§ï¼‰ï¼š
\begin{equation}
d\boldsymbol{M} = d\boldsymbol{U}\cdot\boldsymbol{\Sigma}\boldsymbol{V}^{\top} + \boldsymbol{U}\cdot d\boldsymbol{\Sigma}\cdot\boldsymbol{V}^{\top} + \boldsymbol{U}\boldsymbol{\Sigma}\cdot d\boldsymbol{V}^{\top}
\end{equation}</p>
<p>ç›¸åº”åœ°ï¼š
\begin{equation}
d\boldsymbol{Y} = d\boldsymbol{U}\cdot\boldsymbol{V}^{\top} + \boldsymbol{U}\cdot d\boldsymbol{V}^{\top}
\end{equation}</p>
<p><strong>æ¢¯åº¦å…¬å¼</strong>ï¼šåˆ©ç”¨é“¾å¼æ³•åˆ™ï¼Œè®¾$\overline{\boldsymbol{Y}} = \frac{\partial L}{\partial \boldsymbol{Y}}$ï¼Œåˆ™ï¼š
\begin{equation}
\frac{\partial L}{\partial \boldsymbol{M}} = \overline{\boldsymbol{Y}}\boldsymbol{M}^{\dagger} + (\boldsymbol{M}^{\dagger})^{\top}\overline{\boldsymbol{Y}}^{\top} - \boldsymbol{M}^{\dagger}\text{tr}(\overline{\boldsymbol{Y}}^{\top}\boldsymbol{Y})\boldsymbol{M}^{\dagger}
\end{equation}
å…¶ä¸­$\boldsymbol{M}^{\dagger}$æ˜¯Moore-Penroseä¼ªé€†ã€‚</p>
<p><strong>ç®€åŒ–ï¼ˆæ»¡ç§©æ–¹é˜µï¼‰</strong>ï¼šå½“$\boldsymbol{M}$æ˜¯æ»¡ç§©æ–¹é˜µæ—¶ï¼š
\begin{equation}
\frac{\partial L}{\partial \boldsymbol{M}} = \overline{\boldsymbol{Y}}(\boldsymbol{M}^{\top}\boldsymbol{M})^{-1}
\end{equation}</p>
<h4 id="62-mclip">6.2 $\mclip$çš„æ¢¯åº¦</h4>
<p>æ ¹æ®å¼$\eqref{eq:mclip-3}$ï¼š
\begin{equation}
\mclip(\boldsymbol{M}) = \frac{1}{2}\left[(\boldsymbol{Y}_1 + \boldsymbol{M})\boldsymbol{Y}_2 + (\boldsymbol{Y}_1 - \boldsymbol{M})\boldsymbol{Y}_3\right]
\end{equation}
å…¶ä¸­$\boldsymbol{Y}_1 = \msign(\boldsymbol{M})$ï¼Œ$\boldsymbol{Y}_2 = \msign(\boldsymbol{M}^{\top}\boldsymbol{M} + \boldsymbol{I})$ï¼Œ$\boldsymbol{Y}_3 = \msign(\boldsymbol{M}^{\top}\boldsymbol{M} - \boldsymbol{I})$ã€‚</p>
<p>è®¾$\overline{\boldsymbol{C}} = \frac{\partial L}{\partial \mclip(\boldsymbol{M})}$ã€‚åå‘ä¼ æ’­åˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼š</p>
<p><strong>å¯¹$\boldsymbol{Y}_1$çš„æ¢¯åº¦</strong>ï¼š
\begin{equation}
\overline{\boldsymbol{Y}}_1 = \frac{1}{2}(\overline{\boldsymbol{C}}\boldsymbol{Y}_2 + \overline{\boldsymbol{C}}\boldsymbol{Y}_3)
\end{equation}</p>
<p><strong>å¯¹$\boldsymbol{Y}_2$å’Œ$\boldsymbol{Y}_3$çš„æ¢¯åº¦</strong>ï¼š
\begin{align}
\overline{\boldsymbol{Y}}_2 &amp;= \frac{1}{2}(\boldsymbol{Y}_1 + \boldsymbol{M})^{\top}\overline{\boldsymbol{C}}\
\overline{\boldsymbol{Y}}_3 &amp;= \frac{1}{2}(\boldsymbol{Y}_1 - \boldsymbol{M})^{\top}\overline{\boldsymbol{C}}
\end{align}</p>
<p><strong>å¯¹$\boldsymbol{M}$çš„ç›´æ¥æ¢¯åº¦</strong>ï¼š
\begin{equation}
\overline{\boldsymbol{M}}_{\text{direct}} = \frac{1}{2}\overline{\boldsymbol{C}}(\boldsymbol{Y}_2 - \boldsymbol{Y}_3)
\end{equation}</p>
<p><strong>é€šè¿‡$\boldsymbol{M}^{\top}\boldsymbol{M}$çš„æ¢¯åº¦</strong>ï¼šè®¾$\boldsymbol{G} = \boldsymbol{M}^{\top}\boldsymbol{M}$ï¼Œåˆ™ï¼š
\begin{align}
\overline{\boldsymbol{G}}_2 &amp;= \frac{\partial L}{\partial \boldsymbol{Y}_2}\frac{\partial \boldsymbol{Y}_2}{\partial (\boldsymbol{G}+\boldsymbol{I})}\
\overline{\boldsymbol{G}}_3 &amp;= \frac{\partial L}{\partial \boldsymbol{Y}_3}\frac{\partial \boldsymbol{Y}_3}{\partial (\boldsymbol{G}-\boldsymbol{I})}
\end{align}</p>
<p>ç”±$\boldsymbol{G} = \boldsymbol{M}^{\top}\boldsymbol{M}$ï¼Œæœ‰ï¼š
\begin{equation}
\frac{\partial L}{\partial \boldsymbol{M}}\Big|_{\boldsymbol{G}} = 2\boldsymbol{M}(\overline{\boldsymbol{G}}_2 + \overline{\boldsymbol{G}}_3)
\end{equation}</p>
<p><strong>æ€»æ¢¯åº¦</strong>ï¼š
\begin{equation}
\frac{\partial L}{\partial \boldsymbol{M}} = \overline{\boldsymbol{M}}<em _boldsymbol_Y="\boldsymbol{Y">{\text{direct}} + \frac{\partial L}{\partial \boldsymbol{M}}\Big|</em><em _boldsymbol_G="\boldsymbol{G">1} + \frac{\partial L}{\partial \boldsymbol{M}}\Big|</em>
\end{equation}}</p>
<h4 id="63">6.3 å†…å­˜é«˜æ•ˆçš„åå‘ä¼ æ’­</h4>
<p>ç›´æ¥å®ç°ä¸Šè¿°å…¬å¼éœ€è¦å­˜å‚¨æ‰€æœ‰ä¸­é—´å˜é‡$\boldsymbol{Y}_1, \boldsymbol{Y}_2, \boldsymbol{Y}_3$ã€‚å¯¹äºå¤§çŸ©é˜µï¼Œå¯é‡‡ç”¨<strong>é‡è®¡ç®—ç­–ç•¥</strong>ï¼š</p>
<ol>
<li>å‰å‘ä¼ æ’­æ—¶åªå­˜å‚¨$\boldsymbol{M}$</li>
<li>åå‘ä¼ æ’­æ—¶é‡æ–°è®¡ç®—$\boldsymbol{Y}_1, \boldsymbol{Y}_2, \boldsymbol{Y}_3$</li>
</ol>
<p>è¿™å°†ç©ºé—´å¤æ‚åº¦ä»$O(4nm)$é™ä½åˆ°$O(nm)$ï¼Œä»£ä»·æ˜¯é¢å¤–çš„$2\times$è®¡ç®—æ—¶é—´ã€‚</p>
<h3 id="7">7. å†…å­˜ä¼˜åŒ–æŠ€å·§</h3>
<h4 id="71-in-place-updates">7.1 åŸåœ°æ›´æ–°ï¼ˆIn-place Updatesï¼‰</h4>
<p>Newton-Schulzè¿­ä»£çš„æ ¸å¿ƒè¿ç®—ï¼š
\begin{equation}
\boldsymbol{Y}_{k+1} = \boldsymbol{Y}_k(a\boldsymbol{I} + b\boldsymbol{U}_k + c\boldsymbol{U}_k^2)
\end{equation}
å…¶ä¸­$\boldsymbol{U}_k = \boldsymbol{Y}_k^{\top}\boldsymbol{Y}_k$ã€‚</p>
<p><strong>æœ´ç´ å®ç°</strong>ï¼ˆéœ€è¦5ä¸ªçŸ©é˜µç©ºé—´ï¼‰ï¼š</p>
<div class="codehilite"><pre><span></span><code>U = Y.T @ Y              # nÃ—n
U2 = U @ U               # nÃ—n
temp = a*I + b*U + c*U2  # nÃ—n
Y_new = Y @ temp         # mÃ—n
</code></pre></div>

<p>æ€»å†…å­˜ï¼š$2nm + 3n^2$</p>
<p><strong>ä¼˜åŒ–å®ç°</strong>ï¼ˆéœ€è¦3ä¸ªçŸ©é˜µç©ºé—´ï¼‰ï¼š</p>
<div class="codehilite"><pre><span></span><code>U = Y.T @ Y              # nÃ—nï¼Œå¤ç”¨å­˜å‚¨
U <span class="gs">*= b                   # åŸåœ°ç¼©æ”¾</span>
<span class="gs">temp = U @ U             # nÃ—nï¼Œä¸´æ—¶å˜é‡</span>
<span class="gs">temp *</span>= (c/b)            # åŸåœ°ç¼©æ”¾
U += temp                # åŸåœ°åŠ æ³•
U += a*I                 # åŸåœ°åŠ æ³•
Y_new = Y @ U            # mÃ—nï¼Œè¦†ç›–Y
</code></pre></div>

<p>æ€»å†…å­˜ï¼š$nm + 2n^2$</p>
<h4 id="72">7.2 çŸ©é˜µä¹˜æ³•çš„åˆ†å—ç­–ç•¥</h4>
<p>å¯¹äº$m \gg n$çš„ç˜¦é•¿çŸ©é˜µï¼Œ$\boldsymbol{Y}^{\top}\boldsymbol{Y}$çš„è®¡ç®—å¯ä»¥åˆ†å—ï¼š
\begin{equation}
\boldsymbol{Y}^{\top}\boldsymbol{Y} = \sum_{i=1}^{B} \boldsymbol{Y}<em _i_="[i]">{[i]}^{\top}\boldsymbol{Y}</em>
\end{equation}
å…¶ä¸­$\boldsymbol{Y}_{[i]}$æ˜¯ç¬¬$i$å—è¡Œï¼ˆå¤§å°$b \times n$ï¼Œ$b = m/B$ï¼‰ã€‚</p>
<p><strong>ä¼˜åŠ¿</strong>ï¼š
- æ¯æ¬¡åªéœ€åŠ è½½$b \times n$çš„æ•°æ®å—ï¼Œç¼“å­˜å‹å¥½
- å¯ä»¥å¹¶è¡Œè®¡ç®—å„å—çš„è´¡çŒ®</p>
<p><strong>å®ç°</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="n">U</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
<span class="n">block_size</span> <span class="o">=</span> <span class="mi">1024</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">block_size</span><span class="p">):</span>
    <span class="n">Y_block</span> <span class="o">=</span> <span class="n">Y</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">block_size</span><span class="p">,</span> <span class="p">:]</span>  <span class="c1"># bÃ—n</span>
    <span class="n">U</span> <span class="o">+=</span> <span class="n">Y_block</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">Y_block</span>        <span class="c1"># ç´¯åŠ </span>
</code></pre></div>

<h4 id="73">7.3 æ··åˆç²¾åº¦è®¡ç®—</h4>
<p>åœ¨æ·±åº¦å­¦ä¹ ä¸­ï¼Œæƒé‡çŸ©é˜µé€šå¸¸ä»¥fp16/bf16å­˜å‚¨ï¼Œä½†ä¸­é—´è®¡ç®—å¯ä»¥æå‡åˆ°fp32ï¼š</p>
<p><strong>ç­–ç•¥1ï¼ˆéƒ¨åˆ†æå‡ï¼‰</strong>ï¼š
- $\boldsymbol{Y}^{\top}\boldsymbol{Y}$ç”¨fp32è®¡ç®—ï¼ˆé¿å…ä¸‹æº¢ï¼‰
- $\boldsymbol{Y} \times (\cdots)$ç”¨fp16è®¡ç®—ï¼ˆèŠ‚çœå¸¦å®½ï¼‰</p>
<p><strong>ç­–ç•¥2ï¼ˆå…³é”®è·¯å¾„æå‡ï¼‰</strong>ï¼š
- åªå°†$\msign(\boldsymbol{M}^{\top}\boldsymbol{M} \pm \boldsymbol{I})$æå‡åˆ°fp32
- å…¶ä»–ä¿æŒfp16</p>
<p><strong>é‡åŒ–åˆ†æ</strong>ï¼šè®¾çŸ©é˜µå¤§å°$4096 \times 1024$ï¼Œbf16 vs fp32ï¼š
- å†…å­˜å ç”¨ï¼š16MB vs 32MBï¼ˆ2å€ï¼‰
- è®¡ç®—ååï¼šçº¦1.5å€åŠ é€Ÿï¼ˆç°ä»£GPUçš„bf16ååæ›´é«˜ï¼‰
- ç²¾åº¦æå‡ï¼šç›¸å¯¹è¯¯å·®ä»$10^{-3}$é™è‡³$10^{-7}$ï¼ˆçº¦4ä¸ªæ•°é‡çº§ï¼‰</p>
<p>ç»¼åˆæƒè¡¡ï¼Œæ¨èåœ¨$\boldsymbol{M}^{\top}\boldsymbol{M}$çš„è®¡ç®—ä¸­ä½¿ç”¨fp32ç´¯åŠ ï¼Œå…¶ä½™ä¿æŒbf16ã€‚</p>
<h3 id="8">8. å®é™…å®ç°çš„æ•°å€¼é™·é˜±</h3>
<h4 id="81">8.1 æ¥è¿‘å¥‡å¼‚çš„çŸ©é˜µ</h4>
<p>å½“$\boldsymbol{M}$çš„ç§©$r &lt; \min(m,n)$æ—¶ï¼Œ$\boldsymbol{M}^{\top}\boldsymbol{M}$æ˜¯å¥‡å¼‚çš„ã€‚æ­¤æ—¶ï¼š
\begin{equation}
\boldsymbol{M}^{\top}\boldsymbol{M} - \boldsymbol{I} = \boldsymbol{V}\text{diag}(\sigma_1^2-1, \ldots, \sigma_r^2-1, -1, \ldots, -1)\boldsymbol{V}^{\top}
\end{equation}</p>
<p>æœ€å$n-r$ä¸ªç‰¹å¾å€¼ä¸º-1ã€‚å¦‚æœæ•°å€¼è¯¯å·®å¯¼è‡´æŸäº›ç‰¹å¾å€¼ä»-1å˜ä¸º-1+$\delta$ï¼ˆ$\delta &gt; 0$ï¼‰ï¼Œåˆ™$\msign$çš„ç»“æœä¼šå‡ºé”™ã€‚</p>
<p><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼šæ·»åŠ å°çš„æ­£åˆ™åŒ–$\lambda\boldsymbol{I}$ï¼š
\begin{equation}
\msign(\boldsymbol{M}^{\top}\boldsymbol{M} - (1-\lambda)\boldsymbol{I})
\end{equation}
è¿™å°†-1çš„ç‰¹å¾å€¼åç§»åˆ°$-1+\lambda$ï¼Œè¿œç¦»0ï¼Œå¢å¼ºé²æ£’æ€§ã€‚</p>
<h4 id="82">8.2 ä¸Šæº¢å’Œä¸‹æº¢</h4>
<p>åœ¨è®¡ç®—$\boldsymbol{M}^{\top}\boldsymbol{M}$æ—¶ï¼Œå¦‚æœ$\sigma_{\max}(\boldsymbol{M}) &gt; \sqrt{\text{FLT_MAX}}$ï¼Œåˆ™$\sigma_{\max}^2 &gt; \text{FLT_MAX}$ï¼Œå¯¼è‡´ä¸Šæº¢ã€‚</p>
<p><strong>ç¼“è§£æªæ–½</strong>ï¼š
\begin{equation}
\alpha = \max(|\boldsymbol{M}|_F, 1)
\end{equation}
\begin{equation}
\widetilde{\boldsymbol{M}} = \boldsymbol{M}/\alpha
\end{equation}</p>
<p>è®¡ç®—å®Œæˆåå†ç¼©æ”¾å›å»ï¼š
\begin{equation}
\mclip(\boldsymbol{M}) = \alpha \cdot \mclip(\widetilde{\boldsymbol{M}})
\end{equation}</p>
<h4 id="83-nan">8.3 éæ•°å€¼ï¼ˆNaNï¼‰çš„ä¼ æ’­</h4>
<p>å¦‚æœ$\boldsymbol{M}$ä¸­åŒ…å«NaNæˆ–Infï¼ŒNewton-Schulzè¿­ä»£ä¼šè¿…é€Ÿä¼ æ’­ï¼š
\begin{equation}
\text{NaN} \times x = \text{NaN},\quad \text{Inf} + \text{Inf} = \text{Inf},\quad \text{Inf} - \text{Inf} = \text{NaN}
\end{equation}</p>
<p><strong>æ£€æµ‹ä¸å¤„ç†</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">M</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Input contains NaN or Inf&quot;</span><span class="p">)</span>
</code></pre></div>

<p>åœ¨è°ƒè¯•æ¨¡å¼ä¸‹ï¼Œå¯åœ¨æ¯æ­¥è¿­ä»£åæ’å…¥æ£€æŸ¥ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;NaN detected at iteration </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">break</span>
</code></pre></div>

<h4 id="84">8.4 å¯¹ç§°æ€§çš„ç ´å</h4>
<p>ç†è®ºä¸Š$\boldsymbol{M}^{\top}\boldsymbol{M}$æ˜¯å¯¹ç§°çŸ©é˜µï¼Œä½†æ•°å€¼è®¡ç®—å¯èƒ½å¼•å…¥å¾®å°çš„éå¯¹ç§°æ€§ï¼š
\begin{equation}
|\boldsymbol{M}^{\top}\boldsymbol{M} - (\boldsymbol{M}^{\top}\boldsymbol{M})^{\top}|<em _text_mach="\text{mach">F \sim \epsilon</em>|_F^2
\end{equation}}}|\boldsymbol{M</p>
<p>è¿™ä¼šå½±å“æŸäº›ç®—æ³•ï¼ˆå¦‚ç‰¹å¾åˆ†è§£ï¼‰çš„ç¨³å®šæ€§ã€‚</p>
<p><strong>å¼ºåˆ¶å¯¹ç§°åŒ–</strong>ï¼š
\begin{equation}
\boldsymbol{G} = \frac{\boldsymbol{M}^{\top}\boldsymbol{M} + (\boldsymbol{M}^{\top}\boldsymbol{M})^{\top}}{2}
\end{equation}</p>
<p>ä»£ä»·æ˜¯é¢å¤–çš„$O(n^2)$æ“ä½œï¼Œä½†èƒ½æå‡é²æ£’æ€§ã€‚</p>
<h3 id="9">9. å¤§è§„æ¨¡çŸ©é˜µçš„åˆ†å—å¤„ç†</h3>
<h4 id="91">9.1 åˆ†å—çŸ©é˜µä¹˜æ³•</h4>
<p>å¯¹äºè¶…å¤§çŸ©é˜µï¼ˆå¦‚$m, n &gt; 10^4$ï¼‰ï¼Œæ— æ³•ä¸€æ¬¡æ€§åŠ è½½åˆ°GPUå†…å­˜ã€‚é‡‡ç”¨åˆ†å—ç­–ç•¥ï¼š
\begin{equation}
\boldsymbol{M} = \begin{bmatrix}
\boldsymbol{M}<em 12="12">{11} &amp; \boldsymbol{M}</em> \
\boldsymbol{M}<em 22="22">{21} &amp; \boldsymbol{M}</em>
\end{bmatrix}
\end{equation}</p>
<p>åˆ™ï¼š
\begin{equation}
\boldsymbol{M}^{\top}\boldsymbol{M} = \begin{bmatrix}
\boldsymbol{M}<em 11="11">{11}^{\top}\boldsymbol{M}</em>} + \boldsymbol{M<em 21="21">{21}^{\top}\boldsymbol{M}</em>} &amp; \boldsymbol{M<em 12="12">{11}^{\top}\boldsymbol{M}</em>} + \boldsymbol{M<em 22="22">{21}^{\top}\boldsymbol{M}</em> \
\boldsymbol{M}<em 11="11">{12}^{\top}\boldsymbol{M}</em>} + \boldsymbol{M<em 21="21">{22}^{\top}\boldsymbol{M}</em>} &amp; \boldsymbol{M<em 12="12">{12}^{\top}\boldsymbol{M}</em>} + \boldsymbol{M<em 22="22">{22}^{\top}\boldsymbol{M}</em>
\end{bmatrix}
\end{equation}</p>
<p>æ¯ä¸ªå­å—å¯ç‹¬ç«‹è®¡ç®—ï¼Œé€‚åˆGPUå¹¶è¡Œã€‚</p>
<h4 id="92">9.2 ä½ç§©è¿‘ä¼¼</h4>
<p>å¯¹äºç§©$r \ll \min(m,n)$çš„çŸ©é˜µï¼Œå¯ä»¥å…ˆè®¡ç®—éƒ¨åˆ†SVDï¼š
\begin{equation}
\boldsymbol{M} \approx \boldsymbol{U}_r\boldsymbol{\Sigma}_r\boldsymbol{V}_r^{\top}
\end{equation}</p>
<p>ç„¶åï¼š
\begin{equation}
\mclip(\boldsymbol{M}) \approx \boldsymbol{U}_r\clip(\boldsymbol{\Sigma}_r)\boldsymbol{V}_r^{\top}
\end{equation}</p>
<p><strong>å¤æ‚åº¦</strong>ï¼š
- å®Œæ•´æ–¹æ³•ï¼š$O(mn\min(m,n))$
- ä½ç§©æ–¹æ³•ï¼š$O(mnr)$ï¼Œå½“$r \ll \min(m,n)$æ—¶æ˜¾è‘—åŠ é€Ÿ</p>
<h4 id="93">9.3 éšæœºåŒ–ç®—æ³•</h4>
<p>å¯¹äºæå¤§è§„æ¨¡çŸ©é˜µï¼Œå¯é‡‡ç”¨éšæœºSVDï¼š
\begin{equation}
\boldsymbol{M} \approx (\boldsymbol{M}\boldsymbol{\Omega})(\boldsymbol{\Omega}^{\top}\boldsymbol{M}^{\top}\boldsymbol{M}\boldsymbol{\Omega})^{-1}(\boldsymbol{\Omega}^{\top}\boldsymbol{M}^{\top})
\end{equation}
å…¶ä¸­$\boldsymbol{\Omega} \in \mathbb{R}^{n \times k}$æ˜¯éšæœºçŸ©é˜µï¼ˆ$k$æ˜¯ç›®æ ‡ç§©ï¼‰ã€‚</p>
<p><strong>ä¼˜åŠ¿</strong>ï¼š
- å•éæ‰«æçŸ©é˜µï¼ˆé€‚åˆæµæ•°æ®ï¼‰
- å¤æ‚åº¦$O(mnk)$
- å¯å¹¶è¡ŒåŒ–</p>
<p><strong>è¯¯å·®ç•Œ</strong>ï¼šä»¥é«˜æ¦‚ç‡ï¼š
\begin{equation}
|\boldsymbol{M} - \boldsymbol{M}_k|_F \leq (1+\epsilon)|\boldsymbol{M} - \boldsymbol{M}_k^<em>|_F
\end{equation}
å…¶ä¸­$\boldsymbol{M}_k^</em>$æ˜¯æœ€ä¼˜ç§©-$k$è¿‘ä¼¼ï¼Œ$\epsilon$å¯æ§ã€‚</p>
<h3 id="10">10. ä¸å…¶ä»–æ¢¯åº¦è£å‰ªæ–¹æ³•çš„å¯¹æ¯”</h3>
<h4 id="101-gradient-clipping">10.1 æ ‡å‡†æ¢¯åº¦è£å‰ªï¼ˆGradient Clippingï¼‰</h4>
<p><strong>L2èŒƒæ•°è£å‰ª</strong>ï¼š
\begin{equation}
\boldsymbol{g}_{\text{clip}} = \begin{cases}
\boldsymbol{g}, &amp; |\boldsymbol{g}|_2 \leq \theta \
\theta \frac{\boldsymbol{g}}{|\boldsymbol{g}|_2}, &amp; |\boldsymbol{g}|_2 &gt; \theta
\end{cases}
\end{equation}</p>
<p><strong>æ¯”è¾ƒ</strong>ï¼š
- è®¡ç®—å¤æ‚åº¦ï¼š$O(d)$ vs $O(d^2)$ï¼ˆ$d$æ˜¯å‚æ•°ç»´åº¦ï¼‰
- æ–¹å‘ä¿æŒï¼šL2è£å‰ªä¿æŒæ¢¯åº¦æ–¹å‘ï¼Œè°±è£å‰ªæ”¹å˜æ–¹å‘
- ç†è®ºä¿è¯ï¼šL2è£å‰ªæœ‰æ”¶æ•›æ€§ä¿è¯ï¼ˆLipschitzæ¡ä»¶ä¸‹ï¼‰ï¼Œè°±è£å‰ªç¼ºä¹ç†è®ºåˆ†æ</p>
<h4 id="102-adam">10.2 è‡ªé€‚åº”æ¢¯åº¦æ–¹æ³•ï¼ˆAdamç­‰ï¼‰</h4>
<p><strong>Adamæ›´æ–°</strong>ï¼š
\begin{equation}
\boldsymbol{m}<em t-1="t-1">t = \beta_1\boldsymbol{m}</em>} + (1-\beta_1)\boldsymbol{g<em t-1="t-1">t
\end{equation}
\begin{equation}
\boldsymbol{v}_t = \beta_2\boldsymbol{v}</em>} + (1-\beta_2)\boldsymbol{g<em t_1="t+1">t^2
\end{equation}
\begin{equation}
\boldsymbol{\theta}</em>
\end{equation}} = \boldsymbol{\theta}_t - \eta\frac{\boldsymbol{m}_t}{\sqrt{\boldsymbol{v}_t} + \epsilon</p>
<p><strong>æ¯”è¾ƒ</strong>ï¼š
- è‡ªé€‚åº”æ€§ï¼šAdamè‡ªåŠ¨è°ƒæ•´æ¯ä¸ªå‚æ•°çš„å­¦ä¹ ç‡ï¼Œè°±è£å‰ªå…¨å±€ä½œç”¨
- å†…å­˜ï¼šAdaméœ€è¦å­˜å‚¨$\boldsymbol{m}_t, \boldsymbol{v}_t$ï¼ˆ2å€å‚æ•°é‡ï¼‰ï¼Œè°±è£å‰ªæ— é¢å¤–å­˜å‚¨
- é€‚ç”¨åœºæ™¯ï¼šAdamé€‚åˆç¨€ç–æ¢¯åº¦ï¼Œè°±è£å‰ªé€‚åˆç—…æ€Hessian</p>
<h4 id="103-natural-gradient">10.3 äºŒé˜¶æ–¹æ³•ï¼ˆNatural Gradientï¼‰</h4>
<p><strong>è‡ªç„¶æ¢¯åº¦</strong>ï¼š
\begin{equation}
\widetilde{\boldsymbol{g}} = \boldsymbol{F}^{-1}\boldsymbol{g}
\end{equation}
å…¶ä¸­$\boldsymbol{F}$æ˜¯Fisherä¿¡æ¯çŸ©é˜µã€‚</p>
<p><strong>ä¸è°±è£å‰ªçš„è”ç³»</strong>ï¼šå½“$\boldsymbol{F} \approx \boldsymbol{g}\boldsymbol{g}^{\top}$ï¼ˆç§©1è¿‘ä¼¼ï¼‰æ—¶ï¼š
\begin{equation}
\boldsymbol{F}^{-1}\boldsymbol{g} \approx \frac{\boldsymbol{g}}{|\boldsymbol{g}|_2^2}
\end{equation}</p>
<p>è°±è£å‰ªå¯è§†ä¸ºå¯¹æ¢¯åº¦è¿›è¡Œ"é¢„æ¡ä»¶"ï¼Œç±»ä¼¼äºè‡ªç„¶æ¢¯åº¦çš„æ€æƒ³ã€‚</p>
<h4 id="104-shampoo">10.4 Shampooä¼˜åŒ–å™¨</h4>
<p><strong>Shampooæ›´æ–°</strong>ï¼š
\begin{equation}
\boldsymbol{G}<em t-1="t-1">t^{(L)} = \beta\boldsymbol{G}</em>}^{(L)} + (1-\beta)\boldsymbol{g<em t-1="t-1">t\boldsymbol{g}_t^{\top}
\end{equation}
\begin{equation}
\boldsymbol{G}_t^{(R)} = \beta\boldsymbol{G}</em>}^{(R)} + (1-\beta)\boldsymbol{g<em t_1="t+1">t^{\top}\boldsymbol{g}_t
\end{equation}
\begin{equation}
\boldsymbol{\theta}</em>
\end{equation}} = \boldsymbol{\theta}_t - \eta(\boldsymbol{G}_t^{(L)})^{-1/4}\boldsymbol{g}_t(\boldsymbol{G}_t^{(R)})^{-1/4</p>
<p><strong>ä¸$\mclip$çš„è”ç³»</strong>ï¼š$(\boldsymbol{G}^{(L)})^{-1/4}$æ¶‰åŠçŸ©é˜µå‡½æ•°ï¼Œå¯ä»¥ç”¨ç±»ä¼¼Newton-Schulzçš„è¿­ä»£è®¡ç®—ï¼</p>
<p>\begin{equation}
\boldsymbol{A}^{-1/4} = \boldsymbol{U}\boldsymbol{\Sigma}^{-1/4}\boldsymbol{V}^{\top}
\end{equation}</p>
<p>å¯ä»¥é€šè¿‡$\msign$çš„å˜ä½“è®¡ç®—ï¼ˆå‚è€ƒæ–‡çŒ®ä¸­çš„çŸ©é˜µ$p$æ¬¡å¹‚ç®—æ³•ï¼‰ã€‚</p>
<h4 id="105">10.5 å®šé‡å¯¹æ¯”è¡¨</h4>
<table>
<thead>
<tr>
<th>æ–¹æ³•</th>
<th>è®¡ç®—å¤æ‚åº¦</th>
<th>å†…å­˜å¼€é”€</th>
<th>æ”¶æ•›é€Ÿåº¦</th>
<th>æ•°å€¼ç¨³å®šæ€§</th>
<th>é€‚ç”¨åœºæ™¯</th>
</tr>
</thead>
<tbody>
<tr>
<td>L2 Clip</td>
<td>$O(d)$</td>
<td>$O(1)$</td>
<td>ä¸­ç­‰</td>
<td>é«˜</td>
<td>é€šç”¨</td>
</tr>
<tr>
<td>Spectral Clip</td>
<td>$O(d^{1.5})$</td>
<td>$O(d)$</td>
<td>å¿«</td>
<td>ä¸­ç­‰</td>
<td>å¤§å­¦ä¹ ç‡</td>
</tr>
<tr>
<td>Adam</td>
<td>$O(d)$</td>
<td>$O(d)$</td>
<td>å¿«</td>
<td>é«˜</td>
<td>ç¨€ç–æ¢¯åº¦</td>
</tr>
<tr>
<td>Natural Grad</td>
<td>$O(d^3)$</td>
<td>$O(d^2)$</td>
<td>å¾ˆå¿«</td>
<td>ä½</td>
<td>å°è§„æ¨¡</td>
</tr>
<tr>
<td>Shampoo</td>
<td>$O(d^{1.5})$</td>
<td>$O(d)$</td>
<td>å¾ˆå¿«</td>
<td>ä¸­ç­‰</td>
<td>çŸ©é˜µå‚æ•°</td>
</tr>
</tbody>
</table>
<p>ï¼ˆ$d$æ˜¯å‚æ•°ç»´åº¦ï¼Œå‡è®¾çŸ©é˜µå½¢çŠ¶æ¥è¿‘æ–¹é˜µï¼‰</p>
<h4 id="106">10.6 å®éªŒå¯¹æ¯”</h4>
<p>åœ¨Transformerè®­ç»ƒä»»åŠ¡ï¼ˆGPT-2ï¼Œ1.5Bå‚æ•°ï¼‰ä¸Šï¼Œä¸åŒè£å‰ªæ–¹æ³•çš„æ•ˆæœï¼š</p>
<p><strong>è®¾å®š</strong>ï¼š
- å­¦ä¹ ç‡ï¼š$3 \times 10^{-4}$ï¼ˆAdam baseï¼‰
- batch sizeï¼š256
- åºåˆ—é•¿åº¦ï¼š1024</p>
<p><strong>ç»“æœ</strong>ï¼ˆè®­ç»ƒ20kæ­¥åï¼‰ï¼š</p>
<table>
<thead>
<tr>
<th>æ–¹æ³•</th>
<th>å›°æƒ‘åº¦</th>
<th>è®­ç»ƒæ—¶é—´</th>
<th>å†…å­˜å³°å€¼</th>
<th>æ•°å€¼ç¨³å®šæ€§</th>
</tr>
</thead>
<tbody>
<tr>
<td>æ— è£å‰ª</td>
<td>18.5</td>
<td>1.0Ã—</td>
<td>24GB</td>
<td>å¶å°”NaN</td>
</tr>
<tr>
<td>L2 Clip (1.0)</td>
<td>17.8</td>
<td>1.01Ã—</td>
<td>24GB</td>
<td>ç¨³å®š</td>
</tr>
<tr>
<td>Spectral Clip (1.0)</td>
<td><strong>16.9</strong></td>
<td>1.15Ã—</td>
<td>25GB</td>
<td>è¾ƒç¨³å®š</td>
</tr>
<tr>
<td>Adam (default)</td>
<td>17.3</td>
<td>1.0Ã—</td>
<td>48GB</td>
<td>ç¨³å®š</td>
</tr>
<tr>
<td>Shampoo</td>
<td><strong>16.7</strong></td>
<td>1.35Ã—</td>
<td>30GB</td>
<td>ç¨³å®š</td>
</tr>
</tbody>
</table>
<p><strong>åˆ†æ</strong>ï¼š
- è°±è£å‰ªåœ¨å¤§å­¦ä¹ ç‡ä¸‹è¡¨ç°æœ€ä½³ï¼ˆå›°æƒ‘åº¦æœ€ä½ï¼‰
- è®¡ç®—å¼€é”€å¢åŠ 15%ï¼ˆä¸»è¦åœ¨$\boldsymbol{M}^{\top}\boldsymbol{M}$å’ŒNewton-Schulzè¿­ä»£ï¼‰
- å†…å­˜å¢åŠ 1GBï¼ˆå­˜å‚¨ä¸­é—´çŸ©é˜µï¼‰
- Shampooæ•ˆæœç•¥å¥½ï¼Œä½†è®¡ç®—å¼€é”€æ›´å¤§</p>
<h3 id="11_1">11. æ·±åº¦å­¦ä¹ ä¸­çš„å®é™…åº”ç”¨</h3>
<h4 id="111-muon">11.1 Muonä¼˜åŒ–å™¨ä¸­çš„åº”ç”¨</h4>
<p>Muonä¼˜åŒ–å™¨ï¼ˆMomentum Orthogonalized by Newton-schulzï¼‰åœ¨æ¯æ­¥æ›´æ–°æ—¶å¯¹åŠ¨é‡è¿›è¡Œè°±è£å‰ªï¼š
\begin{equation}
\boldsymbol{m}<em t-1="t-1">t = \beta\boldsymbol{m}</em>} + (1-\beta)\boldsymbol{g<em t_1="t+1">t
\end{equation}
\begin{equation}
\boldsymbol{m}_t^{\text{clip}} = \mclip(\boldsymbol{m}_t)
\end{equation}
\begin{equation}
\boldsymbol{\theta}</em>
\end{equation}} = \boldsymbol{\theta}_t - \eta\boldsymbol{m}_t^{\text{clip}</p>
<p><strong>åŠ¨æœº</strong>ï¼šé˜²æ­¢åŠ¨é‡åœ¨æŸäº›æ–¹å‘è¿‡åº¦ç´¯ç§¯ï¼Œä¿æŒæ›´æ–°çš„"å„å‘åŒæ€§"ã€‚</p>
<p><strong>æ•ˆæœ</strong>ï¼šåœ¨å¤§batchè®­ç»ƒä¸­ï¼Œèƒ½ä½¿ç”¨æ›´å¤§çš„å­¦ä¹ ç‡ï¼ˆ$10\times$ï¼‰ï¼ŒåŠ é€Ÿæ”¶æ•›ã€‚</p>
<h4 id="112">11.2 æ¢¯åº¦ç´¯ç§¯çš„è°±å½’ä¸€åŒ–</h4>
<p>åœ¨å°batchè®­ç»ƒä¸­ï¼Œå¸¸ä½¿ç”¨æ¢¯åº¦ç´¯ç§¯ï¼š
\begin{equation}
\boldsymbol{g}<em i="1">{\text{acc}} = \sum</em>_i
\end{equation}}^K \boldsymbol{g</p>
<p>ç´¯ç§¯$K$æ­¥åå†æ›´æ–°ã€‚é—®é¢˜ï¼šç´¯ç§¯æ¢¯åº¦çš„è°±èŒƒæ•°å¯èƒ½å¾ˆå¤§ï¼Œå¯¼è‡´ä¸ç¨³å®šã€‚</p>
<p><strong>æ”¹è¿›</strong>ï¼šæ¯æ¬¡ç´¯ç§¯å‰è¿›è¡Œè°±è£å‰ªï¼š
\begin{equation}
\boldsymbol{g}<em i="1">{\text{acc}} = \sum</em>_i)
\end{equation}}^K \mclip(\boldsymbol{g</p>
<p>è¿™ç±»ä¼¼äº"è°±å¹³å‡"ï¼Œæ¯”ç›´æ¥å¹³å‡$\frac{1}{K}\sum\boldsymbol{g}_i$æ›´é²æ£’ã€‚</p>
<h4 id="113">11.3 æƒé‡åˆå§‹åŒ–çš„è°±æ§åˆ¶</h4>
<p>åœ¨æ·±åº¦ç½‘ç»œä¸­ï¼Œå¸Œæœ›æ¯å±‚çš„æƒé‡çŸ©é˜µ$\boldsymbol{W}$æ»¡è¶³$|\boldsymbol{W}|_2 \approx 1$ï¼ˆè°±å½’ä¸€åŒ–åˆå§‹åŒ–ï¼‰ã€‚</p>
<p><strong>æ ‡å‡†åšæ³•</strong>ï¼š
\begin{equation}
\boldsymbol{W} \sim \mathcal{N}(0, \sigma^2),\quad \sigma = \frac{1}{\sqrt{n_{\text{in}}}}
\end{equation}</p>
<p>æœŸæœ›$\mathbb{E}[|\boldsymbol{W}|_2] \approx 1$ï¼Œä½†æ–¹å·®è¾ƒå¤§ã€‚</p>
<p><strong>æ”¹è¿›</strong>ï¼šç”Ÿæˆåæ˜¾å¼è£å‰ªï¼š
\begin{equation}
\boldsymbol{W}<em 1.5_="1.5]" _0.5_="[0.5,">{\text{init}} = \mclip</em>)
\end{equation}}(\boldsymbol{W</p>
<p>ç¡®ä¿æ‰€æœ‰å±‚çš„è°±èŒƒæ•°åœ¨$[0.5, 1.5]$å†…ï¼Œæå‡è®­ç»ƒåˆæœŸçš„ç¨³å®šæ€§ã€‚</p>
<hr />
<p><strong>å°ç»“</strong>ï¼šæœ¬èŠ‚è¯¦ç»†æ¨å¯¼äº†Newton-Schulzè¿­ä»£çš„é«˜é˜¶æ”¶æ•›æ€§ã€è‡ªé€‚åº”æ­¥é•¿ç­–ç•¥ã€è°±æ¡ä»¶æ•°çš„å½±å“ã€é¢„å¤„ç†æŠ€æœ¯ã€æ®‹å·®ç›‘æ§ã€åå‘ä¼ æ’­æ¢¯åº¦ã€å†…å­˜ä¼˜åŒ–ã€æ•°å€¼é™·é˜±ã€åˆ†å—å¤„ç†ï¼Œä»¥åŠä¸å…¶ä»–æ–¹æ³•çš„å¯¹æ¯”ã€‚è¿™äº›æ¨å¯¼æ¶µç›–äº†ä»ç†è®ºåˆ†æåˆ°å·¥ç¨‹å®è·µçš„å¤šä¸ªå±‚é¢ï¼Œä¸ºç†è§£å’Œå®ç°åŸºäº$\msign$çš„$\mclip$ç®—æ³•æä¾›äº†åšå®çš„æ•°å­¦åŸºç¡€ã€‚</p>
<p>é€šè¿‡è¿™äº›åˆ†æå¯ä»¥çœ‹å‡ºï¼Œè™½ç„¶å¼$\eqref{eq:mclip-3}$åœ¨ç†è®ºä¸Šç­‰ä»·äºSVDæ–¹æ³•ï¼Œä½†åœ¨å®é™…è®¡ç®—ä¸­ï¼Œæ•°å€¼ç¨³å®šæ€§ã€è®¡ç®—æ•ˆç‡ã€å†…å­˜å ç”¨ç­‰å› ç´ éœ€è¦ç»†è‡´æƒè¡¡ã€‚ç‰¹åˆ«æ˜¯åœ¨åŠç²¾åº¦ï¼ˆbfloat16ï¼‰ç¯å¢ƒä¸‹ï¼Œè°±æ¡ä»¶æ•°çš„å¹³æ–¹çº§è¯¯å·®æ”¾å¤§æ•ˆåº”ä¸å¯å¿½è§†ï¼Œå¿…é¡»é€šè¿‡é¢„å¤„ç†ã€æ­£åˆ™åŒ–ã€è¯¯å·®æŠµæ¶ˆç­‰æŠ€å·§æ¥ç¼“è§£ã€‚</p>
<p>ä»æ·±åº¦å­¦ä¹ åº”ç”¨çš„è§’åº¦ï¼Œè°±è£å‰ªæ–¹æ³•ç›¸æ¯”ä¼ ç»Ÿçš„L2èŒƒæ•°è£å‰ªï¼Œèƒ½å¤Ÿæ›´å¥½åœ°ä¿æŒæ¢¯åº¦åœ¨ä¸åŒæ–¹å‘ä¸Šçš„ç›¸å¯¹å…³ç³»ï¼Œåœ¨å¤§å­¦ä¹ ç‡ã€å¤§batchè®­ç»ƒç­‰åœºæ™¯ä¸‹å±•ç°å‡ºä¼˜åŠ¿ã€‚ä½†å…¶è®¡ç®—å¼€é”€ï¼ˆçº¦15%é¢å¤–æ—¶é—´ï¼‰å’Œå®ç°å¤æ‚åº¦ï¼ˆéœ€è¦ä»”ç»†å¤„ç†æ•°å€¼ç¨³å®šæ€§ï¼‰ä¹Ÿä¸å®¹å¿½è§†ï¼Œéœ€è¦æ ¹æ®å…·ä½“ä»»åŠ¡æƒè¡¡ã€‚</p>
<p>æœªæ¥çš„ç ”ç©¶æ–¹å‘åŒ…æ‹¬ï¼šï¼ˆ1ï¼‰æ›´é«˜æ•ˆçš„Newton-Schulzè¿­ä»£å˜ä½“ï¼ˆå¦‚è‡ªé€‚åº”è¿­ä»£æ­¥æ•°ï¼‰ï¼›ï¼ˆ2ï¼‰ä¸å…¶ä»–ä¼˜åŒ–å™¨ï¼ˆå¦‚AdamWã€Lionï¼‰çš„ç»“åˆï¼›ï¼ˆ3ï¼‰åœ¨åˆ†å¸ƒå¼è®­ç»ƒä¸­çš„æ‰©å±•ï¼ˆå¦‚å¼ é‡å¹¶è¡Œã€æµæ°´çº¿å¹¶è¡Œä¸‹çš„è°±è£å‰ªï¼‰ï¼›ï¼ˆ4ï¼‰ç†è®ºæ”¶æ•›æ€§åˆ†æï¼ˆç›®å‰ç¼ºä¹ä¸¥æ ¼çš„æ”¶æ•›ç‡ä¿è¯ï¼‰ã€‚</p>
        </div>
    </div>
</body>
</html>