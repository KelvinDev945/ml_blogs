<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘åœ¨Performerä¸­å‘ç°äº†Transformer-VQçš„è¸ªè¿¹</title>
    <style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    line-height: 1.6; color: #333; max-width: 900px; margin: 0 auto; padding: 20px; background: #f5f5f5;
}
.container { background: white; padding: 40px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
header { border-bottom: 2px solid #e0e0e0; padding-bottom: 20px; margin-bottom: 30px; }
h1 { color: #2c3e50; margin-bottom: 10px; font-size: 2em; }
.meta { color: #666; font-size: 0.9em; margin-bottom: 20px; }
.content { margin-top: 30px; overflow-wrap: break-word; }
.content h2 { color: #34495e; margin-top: 30px; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
.content p { margin-bottom: 15px; }
.content pre { background: #f8f8f8; padding: 15px; border-radius: 5px; overflow-x: auto; border-left: 3px solid #3498db; margin: 15px 0; }
.content code { background: #f8f8f8; padding: 2px 5px; border-radius: 3px; font-family: monospace; font-size: 0.9em; }
.content blockquote { border-left: 4px solid #3498db; padding-left: 20px; margin: 20px 0; color: #555; font-style: italic; }
.content table { border-collapse: collapse; width: 100%; margin: 20px 0; }
.content th, .content td { border: 1px solid #ddd; padding: 10px; text-align: left; }
.back-link { display: inline-block; margin-bottom: 20px; color: #3498db; text-decoration: none; font-weight: 500; }
</style>
    
<script>
    window.MathJax = {
        tex: {
            inlineMath: [['$', '$'], ['\(', '\)']],
            displayMath: [['$$', '$$'], ['\[', '\]']],
            processEscapes: true
        }
    };
</script>
<script id="MathJax-script" async src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>

</head>
<body>
    <div class="container">
        <a href="../index.html" class="back-link">â† è¿”å›é¦–é¡µ</a>
        <header>
            <h1>æˆ‘åœ¨Performerä¸­å‘ç°äº†Transformer-VQçš„è¸ªè¿¹</h1>
            <div class="meta">ğŸ“… æœ€åæ›´æ–°: 2025-11-26 | ğŸ“„ å¤§å°: 28.8 KB</div>
        </header>
        <div class="content">
            <p><strong>åŸæ–‡é“¾æ¥</strong>: <a href="https://spaces.ac.cn/archives/9862">https://spaces.ac.cn/archives/9862</a></p>
<p><strong>å‘å¸ƒæ—¥æœŸ</strong>: </p>
<hr />
<p>å‰äº›å¤©æˆ‘ä»¬åœ¨<a href="/archives/9844">ã€ŠVQä¸€ä¸‹Keyï¼ŒTransformerçš„å¤æ‚åº¦å°±å˜æˆçº¿æ€§äº†ã€‹</a>ä»‹ç»äº†â€œTransformer-VQâ€ï¼Œè¿™æ˜¯é€šè¿‡å°†Keyåºåˆ—åšVQï¼ˆVector Quantizeï¼‰å˜æ¢æ¥å®ç°Attentionå¤æ‚åº¦çº¿æ€§åŒ–çš„æ–¹æ¡ˆã€‚è¯šç„¶ï¼ŒTransformer-VQæä¾›äº†æ ‡å‡†Attentionåˆ°çº¿æ€§Attentinoçš„ä¸€ä¸ªéå¸¸æ¼‚äº®çš„è¿‡æ¸¡ï¼Œç»™äººä¸€ç§â€œå¤§é“è‡³ç®€â€çš„ç¾æ„Ÿï¼Œä½†ç†Ÿæ‚‰VQçš„è¯»è€…åº”è¯¥èƒ½æ„Ÿè§‰åˆ°ï¼Œå½“ç¼–ç è¡¨å¤§å°æˆ–è€…æ¨¡å‹å‚æ•°é‡è¿›ä¸€æ­¥å¢åŠ æ—¶ï¼ŒVQå¾ˆå¯èƒ½ä¼šæˆä¸ºæ•ˆæœæå‡çš„ç“¶é¢ˆï¼Œå› ä¸ºå®ƒé€šè¿‡STEï¼ˆStraight-Through Estimatorï¼‰ä¼°è®¡çš„æ¢¯åº¦å¤§æ¦‚ç‡æ˜¯æ¬¡ä¼˜çš„ï¼ˆ<a href="/archives/9826">FSQ</a>çš„å®éªŒç»“æœä¹Ÿç®—æ˜¯æä¾›äº†ä¸€äº›ä½è¯ï¼‰ã€‚æ­¤å¤–ï¼ŒTransformer-VQä¸ºäº†ä½¿è®­ç»ƒæ•ˆç‡ä¹Ÿçº¿æ€§åŒ–æ‰€åšçš„æ¢¯åº¦æˆªæ–­ï¼Œä¹Ÿå¯èƒ½æˆä¸ºå°†æ¥çš„æ•ˆæœç“¶é¢ˆä¹‹ä¸€ã€‚</p>
<p>ä¸ºæ­¤ï¼Œç¬”è€…èŠ±äº†ä¸€äº›æ—¶é—´æ€è€ƒå¯ä»¥æ›¿ä»£æ‰VQçš„çº¿æ€§åŒ–æ€è·¯ã€‚ä»Transformer-VQçš„$\exp\left(QC^{\top}\right)$å½¢å¼ä¸­ï¼Œç¬”è€…è”æƒ³åˆ°äº†<a href="/archives/7921">Performer</a>ï¼Œç»§è€Œâ€œé¡ºè—¤æ‘¸ç“œâ€åœ°å‘ç°åŸæ¥Performerå¯ä»¥è§†ä¸ºSoftç‰ˆçš„Transformer-VQã€‚è¿›ä¸€æ­¥åœ°ï¼Œç¬”è€…å°è¯•ç±»æ¯”Performerçš„æ¨å¯¼æ–¹æ³•æ¥é‡æ–°å¯¼å‡ºTransformer-VQï¼Œä¸ºå…¶åçš„ä¼˜åŒ–æä¾›ä¸€äº›å‚è€ƒç»“æœã€‚</p>
<h2 id="_1">å‰æƒ…å›é¡¾</h2>
<p>é¦–å…ˆï¼Œè®©æˆ‘ä»¬èŠ±ä¸€äº›æ—¶é—´å›é¡¾ä¸€ä¸‹Transformer-VQã€‚è®¾$Q,K\in\mathbb{R}^{n\times d_k},V\in\mathbb{R}^{n\times d_v}$ï¼ŒTransformer-VQçš„å…³é”®ï¼Œæ˜¯å¯¹$K$åšäº†å¦‚ä¸‹VQè¿‘ä¼¼ï¼š<br />
\begin{equation}K\approx\hat{K}\triangleq\Delta C\end{equation}<br />
è¿™é‡Œçš„$\Delta\in\{0,1\}^{n\times c},C\in\mathbb{R}^{c\times d_k}$éƒ½æ˜¯çŸ©é˜µï¼Œå…¶ä¸­$C$æ˜¯å¯è®­ç»ƒçš„å‚æ•°ï¼Œ$\Delta$åˆ™å®šä¹‰ä¸ºï¼š<br />
\begin{equation}\Delta_{i,j} = \left\{\begin{aligned}&amp; 1, \quad j=\mathop{\text{argmin}}_{k=1,2,\cdots,c} \Vert K_i - C_k\Vert \\\<br />
&amp; 0, \quad\text{å…¶ä»–}\end{aligned}\right.\end{equation}<br />
è¯´ç™½äº†ï¼ŒVQå°±æ˜¯ç”¨ä¸$K_i$æœ€ç›¸è¿‘çš„é‚£ä¸ª$C_j$æ¥è¿‘ä¼¼$K_i$ã€‚åœ¨è¿™ä¸ªè¿‘ä¼¼ä¹‹ä¸‹ï¼Œæˆ‘ä»¬æœ‰ï¼ˆç®€å•èµ·è§ï¼Œä»¥Encoderä¸ºä¾‹ï¼‰<br />
\begin{equation}\exp\left(Q\hat{K}{}^{\top}\right)V = \exp\left(QC^{\top}\Delta^{\top}\right)V = \exp\left(QC^{\top}\right)\Delta^{\top}V = \exp\left(QC^{\top}\right)(\Delta^{\top}V)\label{eq:transformer-vq}\end{equation}<br />
äº†è§£çº¿æ€§Attentionçš„è¯»è€…å¾ˆå®¹æ˜“è®¤å‡ºæ¥ï¼Œæœ€åä¸€ä¸ªå¼å­çš„è¿ç®—å°±æ˜¯çº¿æ€§å¤æ‚åº¦çš„ï¼Œå®ƒå°±æ˜¯æœ¬æ–‡çš„ä¸»è§’ä¹‹ä¸€Transformer-VQï¼ˆçš„åˆ†å­ï¼Œè¿˜æœ‰åˆ†æ¯åŒç†ï¼‰ã€‚</p>
<p>æ²¡æœ‰å¾ˆå¤æ‚çš„æ¨å¯¼ï¼Œçº¿æ€§Attentionå°±å‡ºæ¥äº†ï¼Œè¿™å°±ç»™æˆ‘ä»¬ä¸€ç§æ„Ÿè§‰ï¼Œä»¿ä½›æˆ‘ä»¬æ˜¯åœ¨å¯¹Keyåšè¿‘ä¼¼çš„â€œä¸ç»æ„é—´â€å°±å°†Attentionçš„å¤æ‚åº¦é™ä¸ºäº†çº¿æ€§ï¼Œç¾æ„Ÿåè¶³ã€‚å› æ­¤ï¼Œå†æ¬¡å›åˆ°äº†æˆ‘ä»¬å·²ç»æè¿‡å¤šæ¬¡çš„è¯„ä»·â€”â€”Transformer-VQæä¾›äº†æ ‡å‡†Attentionåˆ°çº¿æ€§Attentinoçš„ä¸€ä¸ªéå¸¸æ¼‚äº®çš„è¿‡æ¸¡ã€‚</p>
<h2 id="_2">ä¼¼æ›¾ç›¸è¯†</h2>
<p>Transformer-VQçš„$\exp\left(QC^{\top}\right)$è®©ç¬”è€…è”æƒ³åˆ°äº†ä¹‹å‰çš„æ–‡ç« <a href="/archives/8338">ã€ŠTransformerå‡çº§ä¹‹è·¯ï¼š3ã€ä»Performeråˆ°çº¿æ€§Attentionã€‹</a>ã€‚åœ¨é‚£ç¯‡æ–‡ç« ä¸­ï¼Œç¬”è€…å¯¹Performerçš„ç»“æœåšäº†ä¸€äº›ç®€åŒ–ï¼Œç„¶åæ–­è¨€çº¿æ€§Attentionçš„$Q,K$çš„æœ€ä½³æ¿€æ´»å‡½æ•°æ˜¯$\exp$ï¼Œè€ŒTransformer-VQåŒæ ·å‡ºç°äº†$\exp$ï¼Œæ‰€ä»¥å®ƒä»¬ä¹‹é—´ä¹Ÿè®¸æœ‰ç€æŸç§ç›¸å…³æ€§ã€‚</p>
<p>ä¸ºäº†æŒ–æ˜è¿™ç§è”ç³»ï¼Œè®©æˆ‘ä»¬è¯·å‡ºPerformerï¼Œå®ƒåŸºäºä¸€ä¸ªæ¼‚äº®çš„è¿‘ä¼¼ï¼š<br />
\begin{equation}<br />
e^{\boldsymbol{q}\cdot \boldsymbol{k}}=\mathbb{E}<em _tilde_boldsymbol_q="\tilde{\boldsymbol{q">{\boldsymbol{\omega}\sim \mathcal{N}(\boldsymbol{\omega};0,\boldsymbol{1}_d)}\left[e^{\boldsymbol{\omega}\cdot \boldsymbol{q}-\Vert \boldsymbol{q}\Vert^2 / 2} \,e^{\boldsymbol{\omega}\cdot \boldsymbol{k}-\Vert \boldsymbol{k}\Vert^2 / 2}\right]\approx\underbrace{\frac{1}{\sqrt{m}}\begin{pmatrix}e^{\boldsymbol{\omega}_1\cdot \boldsymbol{q}-\Vert \boldsymbol{q}\Vert^2 / 2} \\\<br />
e^{\boldsymbol{\omega}_2\cdot \boldsymbol{q}-\Vert \boldsymbol{q}\Vert^2 / 2}\\\<br />
\vdots\\\<br />
e^{\boldsymbol{\omega}_m\cdot \boldsymbol{q}-\Vert \boldsymbol{q}\Vert^2 / 2} \end{pmatrix}}</em>}}<br />
\cdot \underbrace{\frac{1}{\sqrt{m}}\begin{pmatrix}e^{\boldsymbol{\omega}<em _tilde_boldsymbol_k="\tilde{\boldsymbol{k">1\cdot \boldsymbol{k}-\Vert \boldsymbol{k}\Vert^2 / 2} \\\<br />
e^{\boldsymbol{\omega}_2\cdot \boldsymbol{k}-\Vert \boldsymbol{k}\Vert^2 / 2}\\\<br />
\vdots\\\<br />
e^{\boldsymbol{\omega}_m\cdot \boldsymbol{k}-\Vert \boldsymbol{k}\Vert^2 / 2} \end{pmatrix}}</em>}}<br />
\label{eq:performer}\end{equation}<br />
ç”±äºæœ€åè¿˜è¦å¯¹æ‰€æœ‰$\boldsymbol{k}$çš„æ³¨æ„åŠ›å½’ä¸€åŒ–ï¼Œæ‰€ä»¥å»æ‰ä¸Šå¼ä¸­çš„$\frac{1}{\sqrt{m}}$ã€$-\Vert \boldsymbol{q}\Vert^2/2$éƒ½ä¸ä¼šå½±å“æœ€ç»ˆç»“æœï¼ŒåŒæ—¶ï¼Œå¦‚æœå‡è®¾$\boldsymbol{\omega}<em _tilde_boldsymbol_q="\tilde{\boldsymbol{q">1,\boldsymbol{\omega}_2,\cdots,\boldsymbol{\omega}_m$çš„æ¨¡é•¿éƒ½ç›¸ç­‰ï¼ˆå‚è€ƒ<a href="/archives/8679">JLå¼•ç†</a>ï¼‰ï¼Œé‚£ä¹ˆ$\boldsymbol{k}$çš„æŒ‡æ•°éƒ½å‡å»$\Vert\boldsymbol{\omega}_i\Vert^2/2$ä¹Ÿä¸ä¼šå½±å“ç»“æœã€‚äºæ˜¯ï¼ŒPerformerç­‰ä»·äºç”¨ä»¥ä¸‹çš„æ ¼å¼åš$\tilde{\boldsymbol{q}},\tilde{\boldsymbol{k}}$ï¼š<br />
\begin{equation}\underbrace{\begin{pmatrix}e^{\boldsymbol{\omega}_1\cdot \boldsymbol{q}} \\\<br />
e^{\boldsymbol{\omega}_2\cdot \boldsymbol{q}}\\\<br />
\vdots\\\<br />
e^{\boldsymbol{\omega}_m\cdot \boldsymbol{q}} \end{pmatrix}}</em>}}<br />
\cdot \underbrace{\begin{pmatrix}e^{\boldsymbol{\omega}<em _tilde_boldsymbol_k="\tilde{\boldsymbol{k">1\cdot \boldsymbol{k}-\Vert \boldsymbol{k}\Vert^2 / 2-\Vert \boldsymbol{\omega}_1\Vert^2 / 2} \\\<br />
e^{\boldsymbol{\omega}_2\cdot \boldsymbol{k}-\Vert \boldsymbol{k}\Vert^2 / 2-\Vert \boldsymbol{\omega}_2\Vert^2 / 2}\\\<br />
\vdots\\\<br />
e^{\boldsymbol{\omega}_m\cdot \boldsymbol{k}-\Vert \boldsymbol{k}\Vert^2 / 2-\Vert \boldsymbol{\omega}_m\Vert^2 / 2} \end{pmatrix}}</em>}}} = \underbrace{\begin{pmatrix}e^{\boldsymbol{\omega<em _tilde_boldsymbol_q="\tilde{\boldsymbol{q">1\cdot \boldsymbol{q}} \\\<br />
e^{\boldsymbol{\omega}_2\cdot \boldsymbol{q}}\\\<br />
\vdots\\\<br />
e^{\boldsymbol{\omega}_m\cdot \boldsymbol{q}} \end{pmatrix}}</em>}}<br />
\cdot \underbrace{\begin{pmatrix}e^{-\Vert \boldsymbol{k}-\boldsymbol{\omega}<em _tilde_boldsymbol_k="\tilde{\boldsymbol{k">1\Vert^2 / 2} \\\<br />
e^{-\Vert \boldsymbol{k} - \boldsymbol{\omega}_2\Vert^2 / 2}\\\<br />
\vdots\\\<br />
e^{-\Vert \boldsymbol{k} - \boldsymbol{\omega}_m\Vert^2 / 2} \end{pmatrix}}</em>}}} \propto \underbrace{\begin{pmatrix}e^{\boldsymbol{\omega<em _tilde_boldsymbol_q="\tilde{\boldsymbol{q">1\cdot \boldsymbol{q}} \\\<br />
e^{\boldsymbol{\omega}_2\cdot \boldsymbol{q}}\\\<br />
\vdots\\\<br />
e^{\boldsymbol{\omega}_m\cdot \boldsymbol{q}} \end{pmatrix}}</em>}}<br />
\cdot \underbrace{softmax\begin{pmatrix}e^{-\Vert \boldsymbol{k}-\boldsymbol{\omega}<em _tilde_boldsymbol_k="\tilde{\boldsymbol{k">1\Vert^2 / 2} \\\<br />
e^{-\Vert \boldsymbol{k} - \boldsymbol{\omega}_2\Vert^2 / 2}\\\<br />
\vdots\\\<br />
e^{-\Vert \boldsymbol{k} - \boldsymbol{\omega}_m\Vert^2 / 2} \end{pmatrix}}</em>}}} \end{equation<br />
å¯¹æ¯”æœ€åä¸€ä¸ªå¼å­å’Œ$\eqref{eq:transformer-vq}$ï¼Œå°±ä¼šå‘ç°å®ƒä»¬æœ‰è¯¸å¤šç›¸ä¼¼ä¹‹å¤„ï¼š$\boldsymbol{\omega}_1,\boldsymbol{\omega}_2,\cdots,\boldsymbol{\omega}_m$ä¸å°±ç›¸å½“äºç¼–ç è¡¨$C$ï¼Ÿ$\tilde{\boldsymbol{q}}$ä¸å°±ç›¸å½“äº$\exp\left(QC^{\top}\right)$ï¼Ÿè‡³äºæœ€åçš„$\tilde{\boldsymbol{k}}$ï¼Œå®ƒä»¥$-\Vert \boldsymbol{k} - \boldsymbol{\omega}_i\Vert^2 / 2$ä¸ºlogitsåšsoftmaxï¼Œçªå‡ºçš„ä¸å°±æ˜¯ä¸$\boldsymbol{k}$æœ€ç›¸è¿‘çš„é‚£ä¸ª$\boldsymbol{\omega}_i$ï¼Ÿè€Œsoftmaxçš„æé™å°±æ˜¯one hotï¼Œæ‰€ä»¥è¿™ä¸æ­£å¥½å¯¹åº”ç€Transformer-VQçš„$\Delta$çŸ©é˜µï¼Ÿå› æ­¤ï¼Œè¿™ä¸èƒ½è¯´ä¸€æ¨¡ä¸€æ ·ï¼Œä½†ä¹Ÿæœ‰å…­ä¸ƒåˆ†ç›¸ä¼¼äº†ã€‚</p>
<h2 id="_3">ä¾æ ·è‘«èŠ¦</h2>
<p>å½“ç„¶ï¼Œä¸Šè¿°ç»“æœæ›´å¤šçš„æ˜¯ä¸€ç§å½¢è±¡çš„ç±»æ¯”è€Œä¸æ˜¯ç­‰ä»·æ€§ï¼Œå› ä¸ºPerformeræœ¬è´¨ä¸ŠåŸºäºå®Œå…¨ä¸åŒçš„è¿‘ä¼¼æ€è·¯ï¼Œæ¯”å¦‚å®ƒé‡Œè¾¹çš„$\boldsymbol{\omega}_1,\boldsymbol{\omega}_2,\cdots,\boldsymbol{\omega}_m$æ˜¯éšæœºé‡‡æ ·å¹¶å›ºå®šä¸‹æ¥çš„ï¼Œè¿™æ„å‘³å®ƒä»¬ä½œä¸ºä¸­å¿ƒå‘é‡çš„è¿‘ä¼¼ç¨‹åº¦å…¶å®æ˜¯å¾ˆå·®çš„ã€‚ä½†è¿™ç§ç±»ä¼¼å¼•å‘äº†ä¸€ä¸ªæ€è€ƒï¼šèƒ½å¦æ¨¡ä»¿Performerçš„æ€è·¯æ¥é‡æ–°æ¨å¯¼ä¸€éTransformer-VQå‘¢ï¼Ÿå³åƒå¼$\eqref{eq:performer}$ä¸€æ ·ï¼Œå…ˆæ„é€ ä¸€ä¸ªç²¾ç¡®ç›¸ç­‰çš„ç»“æœï¼Œç„¶åå†è½¬åŒ–ä¸ºé‡‡æ ·è¿‘ä¼¼æ¥å¾—åˆ°çº¿æ€§ç‰ˆæœ¬ã€‚</p>
<p>ç»è¿‡å‡ å¤©çš„æ€è€ƒï¼Œç¬”è€…å‘ç°äº†ä¸€ç§å¯ä»¥æ„é€ å‡ºæœŸæœ›æ¨å¯¼çš„æ–¹æ¡ˆã€‚é¦–å…ˆï¼Œæˆ‘ä»¬å€ŸåŠ©<a href="/archives/1870">ç‹„æ‹‰å…‹å‡½æ•°</a>å†™å‡º<br />
\begin{equation}e^{\boldsymbol{q}\cdot \boldsymbol{k}} = \int e^{\boldsymbol{q}\cdot \boldsymbol{\omega}}\delta(\boldsymbol{\omega} - \boldsymbol{k})d\boldsymbol{\omega}\end{equation}<br />
è¿™æ˜¯çº¯ç²¹æœ‰ç‹„æ‹‰å…‹å‡½æ•°çš„å®šä¹‰ç»™å‡ºçš„æ’ç­‰å¼ï¼Œè¿˜æ²¡æ¶‰åŠåˆ°ä»»ä½•ç²¾å·§çš„è¿ç®—æˆ–è€…è¿‘ä¼¼ã€‚ç„¶è€Œï¼Œå½“æˆ‘ä»¬å°†å®ƒä»£å…¥Attentionï¼ˆçš„åˆ†å­ï¼‰æ—¶ï¼Œå‡ºç°äº†ä¸€äº›æœ‰æ„æ€çš„ç»“æœï¼š<br />
\begin{equation}\sum_j e^{\boldsymbol{q}\cdot \boldsymbol{k}_j} \boldsymbol{v}_j = \sum_j \boldsymbol{v}_j\int e^{\boldsymbol{q}\cdot \boldsymbol{\omega}}\delta(\boldsymbol{\omega} - \boldsymbol{k}_j)d\boldsymbol{\omega} = \int e^{\boldsymbol{q}\cdot \boldsymbol{\omega}} \left[\sum_j \delta(\boldsymbol{\omega} - \boldsymbol{k}_j) \boldsymbol{v}_j\right]d\boldsymbol{\omega}\label{eq:inf-vq}\end{equation}<br />
æœ€åä¸€ä¸ªç­‰å·ï¼Œä¸å°±æ­£å¥½æ˜¯çº¿æ€§Attentionçš„å½¢å¼ï¼Ÿï¼å½“ç„¶ï¼Œç”±äºéœ€è¦å¯¹$\boldsymbol{\omega}$ç§¯åˆ†ï¼Œæ‰€ä»¥ä¸Šå¼è·Ÿ<a href="/archives/8601">ã€ŠTransformerå‡çº§ä¹‹è·¯ï¼š5ã€ä½œä¸ºæ— é™ç»´çš„çº¿æ€§Attentionã€‹</a>ä¸€æ ·ï¼Œéƒ½æ˜¯â€œæ— é™ç»´â€çš„çº¿æ€§Attentionï¼Œæš‚æ—¶åªæœ‰å½¢å¼ä¸Šçš„ä»·å€¼ã€‚</p>
<p>é€šå¸¸æ¥è¯´ï¼Œæˆ‘ä»¬ä¼šå°†$\delta(\boldsymbol{\omega} - \boldsymbol{k}<em y="1">j)$ç†è§£ä¸ºæ­£æ€åˆ†å¸ƒ$\mathcal{N}(\boldsymbol{\omega};\boldsymbol{k}_j,\sigma^2\boldsymbol{I})$åœ¨$\sigma\to 0$çš„æé™ï¼Œè¿™ä¹Ÿæ„å‘³ç€$\delta(\boldsymbol{\omega} - \boldsymbol{k}_j)$å…·æœ‰æ¡ä»¶åˆ†å¸ƒ$p(\boldsymbol{\omega}|\boldsymbol{k}_j)$çš„æ„ä¹‰ã€‚ä¸è¿‡ï¼Œä»ç”Ÿæˆæ¨¡å‹çš„è§’åº¦æ¥çœ‹ï¼Œç‹„æ‹‰å…‹å‡½æ•°å°±æ˜¯å•ç‚¹åˆ†å¸ƒï¼Œè¯´ç™½äº†å°±æ˜¯æŠŠè®­ç»ƒé›†èƒŒä¸‹æ¥ï¼Œæ‰€ä»¥å®ƒæ²¡æœ‰æŠ½è±¡å’Œæ³›åŒ–èƒ½åŠ›ã€‚ä¸ºäº†ç¼“è§£è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬å°†$p(\boldsymbol{\omega}|\boldsymbol{k}_j)$ç”¨<a href="https://en.wikipedia.org/wiki/Mixture_model">GMM</a>ï¼ˆGaussian Mixture Modelï¼Œé«˜æ–¯æ··åˆæ¨¡å‹ï¼‰æ¥è¿‘ä¼¼ï¼š<br />
\begin{equation}p(\boldsymbol{\omega}|\boldsymbol{k}_j) \approx \sum</em>}^m \mathcal{N}(\boldsymbol{\omega};\boldsymbol{c<em y="1">y,\sigma^2\boldsymbol{I}) \,p(y|\boldsymbol{k}_j) \end{equation}<br />
ä»£å…¥å¼$\eqref{eq:inf-vq}$ï¼Œç„¶åå–$\sigma\to 0$çš„æé™ï¼Œæˆ‘ä»¬å°±å¾—åˆ°<br />
\begin{equation}\sum_j e^{\boldsymbol{q}\cdot \boldsymbol{k}_j} \boldsymbol{v}_j \approx \sum</em>}^m e^{\boldsymbol{q}\cdot \boldsymbol{c}_y} \left[\sum_j p(y|\boldsymbol{k}_j) \boldsymbol{v}_j\right]\end{equation<br />
è¿™å°±å¾—åˆ°ä¸€ä¸ªæœ‰é™ç»´çš„çº¿æ€§Attentionã€‚å¦‚æœå°†$p(y|\boldsymbol{k}_j)$å¯¹é½Transformer-VQçš„one hotåˆ†å¸ƒ$\Delta$çš„å®šä¹‰ï¼Œé‚£ä¹ˆå¾—åˆ°çš„ç»“æœå°±æ˜¯Transformer-VQçš„å¼$\eqref{eq:transformer-vq}$ã€‚</p>
<h2 id="_4">æ–‡ç« å°ç»“</h2>
<p>æœ¬æ–‡ä»‹ç»äº†ç¬”è€…çš„ä¸€ä¸ªå‘ç°ï¼šæ—©æœŸçš„çº¿æ€§Attentionå·¥ä½œâ€œPeformerâ€å¯ä»¥è§†ä¸ºä¸€ä¸ªâ€œSoftâ€ç‰ˆçš„Transformer-VQã€‚ç„¶åï¼Œåœ¨è¿™ä¸ªè§‚å¯Ÿä¸Šè¿›ä¸€æ­¥å¾—åˆ°äº†Transformer-VQçš„ä¸€ä¸ªæ–°æ¨å¯¼ï¼šåˆ©ç”¨ç‹„æ‹‰å…‹å‡½æ•°å°†æ ‡å‡†Attentionè½¬åŒ–ä¸ºæ— é™ç»´çº¿æ€§Attentionï¼Œç„¶ååŠ ä¸ŠGMMè¿‘ä¼¼å°±å¯ä»¥å¾—åˆ°Transformer-VQã€‚</p>
<p><em><strong>è½¬è½½åˆ°è¯·åŒ…æ‹¬æœ¬æ–‡åœ°å€ï¼š</strong><a href="https://spaces.ac.cn/archives/9862">https://spaces.ac.cn/archives/9862</a></em></p>
<p><em><strong>æ›´è¯¦ç»†çš„è½¬è½½äº‹å®œè¯·å‚è€ƒï¼š</strong></em><a href="https://spaces.ac.cn/archives/6508#%E6%96%87%E7%AB%A0%E5%A6%82%E4%BD%95%E8%BD%AC%E8%BD%BD/%E5%BC%95%E7%94%A8" title="ã€Šç§‘å­¦ç©ºé—´FAQã€‹">ã€Šç§‘å­¦ç©ºé—´FAQã€‹</a></p>
<p><strong>å¦‚æœæ‚¨è¿˜æœ‰ä»€ä¹ˆç–‘æƒ‘æˆ–å»ºè®®ï¼Œæ¬¢è¿åœ¨ä¸‹æ–¹è¯„è®ºåŒºç»§ç»­è®¨è®ºã€‚</strong></p>
<p><strong>å¦‚æœæ‚¨è§‰å¾—æœ¬æ–‡è¿˜ä¸é”™ï¼Œæ¬¢è¿åˆ†äº«/æ‰“èµæœ¬æ–‡ã€‚æ‰“èµå¹¶éè¦ä»ä¸­è·å¾—æ”¶ç›Šï¼Œè€Œæ˜¯å¸Œæœ›çŸ¥é“ç§‘å­¦ç©ºé—´è·å¾—äº†å¤šå°‘è¯»è€…çš„çœŸå¿ƒå…³æ³¨ã€‚å½“ç„¶ï¼Œå¦‚æœä½ æ— è§†å®ƒï¼Œä¹Ÿä¸ä¼šå½±å“ä½ çš„é˜…è¯»ã€‚å†æ¬¡è¡¨ç¤ºæ¬¢è¿å’Œæ„Ÿè°¢ï¼</strong></p>
<p>æ‰“èµ</p>
<p><img alt="ç§‘å­¦ç©ºé—´" src="https://spaces.ac.cn/usr/themes/geekg/payment/wx.png" /></p>
<p>å¾®ä¿¡æ‰“èµ</p>
<p><img alt="ç§‘å­¦ç©ºé—´" src="https://spaces.ac.cn/usr/themes/geekg/payment/zfb.png" /></p>
<p>æ”¯ä»˜å®æ‰“èµ</p>
<p>å› ä¸ºç½‘ç«™åå°å¯¹æ‰“èµå¹¶æ— è®°å½•ï¼Œå› æ­¤æ¬¢è¿åœ¨æ‰“èµæ—¶å€™å¤‡æ³¨ç•™è¨€ã€‚ä½ è¿˜å¯ä»¥<a href="http://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&amp;email=tN7d1drY3drrx8H0xcWa19vZ"><strong>ç‚¹å‡»è¿™é‡Œ</strong></a>æˆ–åœ¨ä¸‹æ–¹è¯„è®ºåŒºç•™è¨€æ¥å‘ŠçŸ¥ä½ çš„å»ºè®®æˆ–éœ€æ±‚ã€‚</p>
<p><strong>å¦‚æœæ‚¨éœ€è¦å¼•ç”¨æœ¬æ–‡ï¼Œè¯·å‚è€ƒï¼š</strong></p>
<p>è‹å‰‘æ—. (Nov. 29, 2023). ã€Šæˆ‘åœ¨Performerä¸­å‘ç°äº†Transformer-VQçš„è¸ªè¿¹ ã€‹[Blog post]. Retrieved from <a href="https://spaces.ac.cn/archives/9862">https://spaces.ac.cn/archives/9862</a></p>
<p>@online{kexuefm-9862,<br />
title={æˆ‘åœ¨Performerä¸­å‘ç°äº†Transformer-VQçš„è¸ªè¿¹},<br />
author={è‹å‰‘æ—},<br />
year={2023},<br />
month={Nov},<br />
url={\url{https://spaces.ac.cn/archives/9862}},<br />
} </p>
<hr />
<h2 id="_5">å…¬å¼æ¨å¯¼ä¸æ³¨é‡Š</h2>
<h3 id="performerfavor">ä¸€ã€Performerçš„FAVOR+ç®—æ³•è¯¦è§£</h3>
<h4 id="11">1.1 æ ¸å¿ƒæ€æƒ³ï¼šéšæœºç‰¹å¾è¿‘ä¼¼</h4>
<p><strong>é—®é¢˜</strong>: æ ‡å‡†Attentionçš„è®¡ç®—å¤æ‚åº¦ä¸º $\mathcal{O}(n^2d)$ï¼Œä¸»è¦ç“¶é¢ˆåœ¨äºè®¡ç®— $n \times n$ çš„æ³¨æ„åŠ›çŸ©é˜µã€‚</p>
<p><strong>Performerçš„æ ¸å¿ƒæ´å¯Ÿ</strong>: åˆ©ç”¨æ ¸æ–¹æ³•å°†Attentionæ”¹å†™ä¸ºçº¿æ€§å¤æ‚åº¦çš„å½¢å¼ã€‚</p>
<p><strong>æ ¸å‡½æ•°è§†è§’</strong>: Softmax Attentionå¯ä»¥è§†ä¸ºæ ¸å‡½æ•°ï¼š
\begin{equation}
k(\boldsymbol{q}, \boldsymbol{k}) = \exp(\boldsymbol{q} \cdot \boldsymbol{k})
\tag{1}
\end{equation}</p>
<p>åˆ™Attentionè¾“å‡ºä¸ºï¼š
\begin{equation}
\text{Attention}(\boldsymbol{q}, K, V) = \frac{\sum_{j=1}^n k(\boldsymbol{q}, \boldsymbol{k}<em j="1">j) \boldsymbol{v}_j}{\sum</em>
\tag{2}
\end{equation}}^n k(\boldsymbol{q}, \boldsymbol{k}_j)</p>
<h4 id="12-bochner">1.2 Bochnerå®šç†ä¸éšæœºå‚…ç«‹å¶ç‰¹å¾</h4>
<p><strong>Bochnerå®šç†</strong>: å¯¹äºä»»æ„å¹³ç§»ä¸å˜çš„æ­£å®šæ ¸å‡½æ•° $k(\boldsymbol{x} - \boldsymbol{y})$ï¼Œå­˜åœ¨éè´Ÿæµ‹åº¦ $\mu$ ä½¿å¾—ï¼š
\begin{equation}
k(\boldsymbol{x} - \boldsymbol{y}) = \int_{\mathbb{R}^d} e^{i\boldsymbol{\omega}^{\top}(\boldsymbol{x}-\boldsymbol{y})} d\mu(\boldsymbol{\omega})
\tag{3}
\end{equation}</p>
<p>å¯¹äºé«˜æ–¯æ ¸ $k(\boldsymbol{x} - \boldsymbol{y}) = \exp\left(-\frac{|\boldsymbol{x}-\boldsymbol{y}|^2}{2\sigma^2}\right)$ï¼Œæµ‹åº¦ $\mu$ æ˜¯é«˜æ–¯åˆ†å¸ƒã€‚</p>
<p><strong>éšæœºå‚…ç«‹å¶ç‰¹å¾</strong>: ä» $\mu$ é‡‡æ · $\boldsymbol{\omega}<em i="1">1, \ldots, \boldsymbol{\omega}_m$ï¼Œåˆ™ï¼š
\begin{equation}
k(\boldsymbol{x} - \boldsymbol{y}) \approx \frac{1}{m} \sum</em>)
\tag{4}
\end{equation}}^m e^{i\boldsymbol{\omega}_i^{\top}\boldsymbol{x}} e^{-i\boldsymbol{\omega}_i^{\top}\boldsymbol{y}} = \phi(\boldsymbol{x})^{\top} \phi(\boldsymbol{y</p>
<p>å…¶ä¸­ç‰¹å¾æ˜ å°„ä¸ºï¼š
\begin{equation}
\phi(\boldsymbol{x}) = \frac{1}{\sqrt{m}} \left[e^{i\boldsymbol{\omega}_1^{\top}\boldsymbol{x}}, \ldots, e^{i\boldsymbol{\omega}_m^{\top}\boldsymbol{x}}\right]^{\top} \in \mathbb{C}^m
\tag{5}
\end{equation}</p>
<h4 id="13-performer">1.3 Performerçš„æ­£äº¤éšæœºç‰¹å¾</h4>
<p><strong>æ ‡å‡†æ–¹æ³•çš„é—®é¢˜</strong>: ç›´æ¥ä½¿ç”¨éšæœºç‰¹å¾éœ€è¦å¤§é‡æ ·æœ¬ $m$ æ‰èƒ½è·å¾—å¥½çš„è¿‘ä¼¼ã€‚</p>
<p><strong>Performerçš„æ”¹è¿›</strong>: ä½¿ç”¨æ­£äº¤éšæœºç‰¹å¾é™ä½æ–¹å·®ã€‚</p>
<p><strong>æ­£äº¤åŒ–æ–¹æ³•</strong>: ç»™å®š $m$ ä¸ªé‡‡æ ·å‘é‡ï¼Œé€šè¿‡Gram-Schmidtæ­£äº¤åŒ–æˆ–QRåˆ†è§£å¾—åˆ°æ­£äº¤åŸºã€‚</p>
<p><strong>ç†è®ºä¿è¯</strong>: æ­£äº¤éšæœºç‰¹å¾çš„è¿‘ä¼¼è¯¯å·®æ–¹å·®ä¸ºï¼š
\begin{equation}
\text{Var}<em _text_std="\text{std">{\text{orth}}(k(\boldsymbol{x}, \boldsymbol{y})) \leq \frac{1}{m}\text{Var}</em>))
\tag{6}
\end{equation}}}(k(\boldsymbol{x}, \boldsymbol{y</p>
<p>å³æ–¹å·®é™ä½äº† $m$ å€ï¼</p>
<h4 id="14">1.4 å¤„ç†æŒ‡æ•°æ ¸çš„æŠ€å·§</h4>
<p>å¯¹äºAttentionçš„æŒ‡æ•°æ ¸ $k(\boldsymbol{q}, \boldsymbol{k}) = e^{\boldsymbol{q} \cdot \boldsymbol{k}}$ï¼Œä¸æ˜¯å¹³ç§»ä¸å˜çš„ï¼Œéœ€è¦ç‰¹æ®Šå¤„ç†ã€‚</p>
<p><strong>åˆ†è§£</strong>:
\begin{align}
e^{\boldsymbol{q} \cdot \boldsymbol{k}} &amp;= e^{-\frac{|\boldsymbol{q}|^2 + |\boldsymbol{k}|^2}{2}} \cdot e^{-\frac{|\boldsymbol{q} - \boldsymbol{k}|^2}{2}} \tag{7}\
&amp;= e^{-\frac{|\boldsymbol{q}|^2}{2}} \cdot e^{-\frac{|\boldsymbol{k}|^2}{2}} \cdot e^{-\frac{|\boldsymbol{q} - \boldsymbol{k}|^2}{2}} \tag{8}
\end{align}</p>
<p>åˆ©ç”¨Bochnerå®šç†å¤„ç†ç¬¬ä¸‰é¡¹ï¼Œå¾—åˆ°ï¼š
\begin{equation}
e^{\boldsymbol{q} \cdot \boldsymbol{k}} \approx e^{-\frac{|\boldsymbol{q}|^2}{2}} \cdot e^{-\frac{|\boldsymbol{k}|^2}{2}} \cdot \phi(\boldsymbol{q})^{\top} \phi(\boldsymbol{k})
\tag{9}
\end{equation}</p>
<p><strong>å®æ•°ç‰¹å¾</strong>: ä¸ºé¿å…å¤æ•°ï¼Œä½¿ç”¨ï¼š
\begin{equation}
\phi(\boldsymbol{x}) = \frac{1}{\sqrt{m}} \left[\cos(\boldsymbol{\omega}_1^{\top}\boldsymbol{x}), \sin(\boldsymbol{\omega}_1^{\top}\boldsymbol{x}), \ldots, \cos(\boldsymbol{\omega}_m^{\top}\boldsymbol{x}), \sin(\boldsymbol{\omega}_m^{\top}\boldsymbol{x})\right]^{\top}
\tag{10}
\end{equation}</p>
<p>è¿™æ ·ç‰¹å¾ç»´åº¦ä¸º $2m$ã€‚</p>
<h4 id="15-attention">1.5 çº¿æ€§Attentionçš„æœ€ç»ˆå½¢å¼</h4>
<p>å®šä¹‰ï¼š
\begin{equation}
\tilde{\boldsymbol{q}} = e^{-\frac{|\boldsymbol{q}|^2}{2}} \phi(\boldsymbol{q}), \quad \tilde{\boldsymbol{k}} = e^{-\frac{|\boldsymbol{k}|^2}{2}} \phi(\boldsymbol{k})
\tag{11}
\end{equation}</p>
<p>åˆ™Attentionè¿‘ä¼¼ä¸ºï¼š
\begin{equation}
\text{Attention}(\boldsymbol{q}, K, V) \approx \frac{\tilde{\boldsymbol{q}}^{\top} \left(\sum_{j=1}^n \tilde{\boldsymbol{k}}<em j="1">j \boldsymbol{v}_j^{\top}\right)}{\tilde{\boldsymbol{q}}^{\top} \left(\sum</em>
\tag{12}
\end{equation}}^n \tilde{\boldsymbol{k}}_j\right)</p>
<p><strong>å…³é”®è§‚å¯Ÿ</strong>: å¯ä»¥å…ˆè®¡ç®—ï¼š
\begin{equation}
S = \sum_{j=1}^n \tilde{\boldsymbol{k}}<em j="1">j \boldsymbol{v}_j^{\top} \in \mathbb{R}^{2m \times d_v}, \quad Z = \sum</em>
\tag{13}
\end{equation}}^n \tilde{\boldsymbol{k}}_j \in \mathbb{R}^{2m</p>
<p>ç„¶åå¯¹æ¯ä¸ªqueryï¼š
\begin{equation}
\text{Attention}(\boldsymbol{q}, K, V) \approx \frac{\tilde{\boldsymbol{q}}^{\top} S}{\tilde{\boldsymbol{q}}^{\top} Z}
\tag{14}
\end{equation}</p>
<p><strong>å¤æ‚åº¦åˆ†æ</strong>:
- è®¡ç®— $S$ å’Œ $Z$: $\mathcal{O}(nmd_v + nm) = \mathcal{O}(nmd_v)$
- å¯¹æ‰€æœ‰queryè®¡ç®—è¾“å‡º: $\mathcal{O}(nmd_v)$
- æ€»å¤æ‚åº¦: $\mathcal{O}(nmd_v)$ï¼Œå½“ $m \ll n$ æ—¶ä¸ºçº¿æ€§ï¼</p>
<h3 id="transformer-vq">äºŒã€Transformer-VQçš„æ•°å­¦åŸç†</h3>
<h4 id="21-vector-quantization">2.1 çŸ¢é‡é‡åŒ–(Vector Quantization)åŸºç¡€</h4>
<p><strong>å®šä¹‰</strong>: ç»™å®šå‘é‡ $\boldsymbol{x} \in \mathbb{R}^d$ å’Œç æœ¬ $\mathcal{C} = {\boldsymbol{c}<em _boldsymbol_c="\boldsymbol{c">1, \ldots, \boldsymbol{c}_K} \subset \mathbb{R}^d$ï¼ŒVQå°† $\boldsymbol{x}$ æ˜ å°„åˆ°æœ€è¿‘çš„ç å­—ï¼š
\begin{equation}
\text{VQ}(\boldsymbol{x}) = \mathop{\text{argmin}}</em>|^2
\tag{15}
\end{equation}} \in \mathcal{C}} |\boldsymbol{x} - \boldsymbol{c</p>
<p><strong>ç¦»æ•£è¡¨ç¤º</strong>: å®šä¹‰one-hotå‘é‡ $\boldsymbol{\delta} \in {0,1}^K$:
\begin{equation}
\delta_i = \begin{cases}
1, &amp; \text{if } i = \mathop{\text{argmin}}_j |\boldsymbol{x} - \boldsymbol{c}_j|^2 \
0, &amp; \text{otherwise}
\end{cases}
\tag{16}
\end{equation}</p>
<p>åˆ™ï¼š
\begin{equation}
\text{VQ}(\boldsymbol{x}) = \sum_{i=1}^K \delta_i \boldsymbol{c}_i = C^{\top} \boldsymbol{\delta}
\tag{17}
\end{equation}</p>
<p>å…¶ä¸­ $C = [\boldsymbol{c}_1, \ldots, \boldsymbol{c}_K] \in \mathbb{R}^{d \times K}$ã€‚</p>
<h4 id="22-vqkey">2.2 VQåº”ç”¨äºKeyçš„çº¿æ€§åŒ–</h4>
<p><strong>Transformer-VQæ€æƒ³</strong>: å¯¹Keyåºåˆ—è¿›è¡ŒVQé‡åŒ–ï¼Œå°†è¿ç»­çš„Keyç©ºé—´ç¦»æ•£åŒ–ã€‚</p>
<p>å¯¹æ¯ä¸ªKeyå‘é‡ $\boldsymbol{k}_j$ï¼š
\begin{equation}
\hat{\boldsymbol{k}}_j = \text{VQ}(\boldsymbol{k}_j) = C^{\top} \boldsymbol{\delta}_j
\tag{18}
\end{equation}</p>
<p><strong>çº¿æ€§åŒ–æ¨å¯¼</strong>:
\begin{align}
&amp;\sum_{j=1}^n \exp(\boldsymbol{q} \cdot \hat{\boldsymbol{k}}<em j="1">j) \boldsymbol{v}_j \tag{19}\
=&amp; \sum</em>}^n \exp(\boldsymbol{q} \cdot C^{\top} \boldsymbol{\delta<em j="1">j) \boldsymbol{v}_j \tag{20}\
=&amp; \sum</em>}^n \exp(C\boldsymbol{q} \cdot \boldsymbol{\delta<em j="1">j) \boldsymbol{v}_j \tag{21}\
=&amp; \sum</em>)}^n \left(\sum_{i=1}^K \delta_{j,i} \exp((C\boldsymbol{q<em i="1">i)\right) \boldsymbol{v}_j \tag{22}\
=&amp; \sum</em>)}^K \exp((C\boldsymbol{q<em j:_delta__j_i="j:\delta_{j,i">i) \sum</em>
\end{align}}=1} \boldsymbol{v}_j \tag{23</p>
<p><strong>çŸ©é˜µå½¢å¼</strong>: ä»¤ $\Delta \in {0,1}^{n \times K}$ ä¸ºæ‰€æœ‰ $\boldsymbol{\delta}<em j="1">j$ çš„æ‹¼æ¥ï¼Œåˆ™ï¼š
\begin{equation}
\sum</em> V)
\tag{24}
\end{equation}}^n \exp(\boldsymbol{q} \cdot \hat{\boldsymbol{k}}_j) \boldsymbol{v}_j = \exp(C\boldsymbol{q})^{\top} (\Delta^{\top</p>
<p>è¿™æ˜¯ $\mathcal{O}(Kd)$ çš„æ“ä½œï¼ˆå‡è®¾ $\Delta^{\top} V$ å·²é¢„è®¡ç®—ï¼‰ï¼</p>
<h4 id="23-straight-through-estimator-ste">2.3 Straight-Through Estimator (STE)</h4>
<p><strong>é—®é¢˜</strong>: VQçš„argminæ“ä½œä¸å¯å¾®ï¼Œæ— æ³•ç›´æ¥åå‘ä¼ æ’­ã€‚</p>
<p><strong>STEè§£å†³æ–¹æ¡ˆ</strong>: å‰å‘ä¼ æ’­ä½¿ç”¨VQï¼Œåå‘ä¼ æ’­æ—¶å°†æ¢¯åº¦ç›´é€šï¼š
\begin{equation}
\frac{\partial \mathcal{L}}{\partial \boldsymbol{k}} = \frac{\partial \mathcal{L}}{\partial \hat{\boldsymbol{k}}}
\tag{25}
\end{equation}</p>
<p><strong>æ•°å­¦è§£é‡Š</strong>: è¿‘ä¼¼ç¦»æ•£åŒ–ä¸ºè¿ç»­åŒ–ï¼š
\begin{equation}
\boldsymbol{k} \approx \hat{\boldsymbol{k}} + \text{sg}(\hat{\boldsymbol{k}} - \boldsymbol{k})
\tag{26}
\end{equation}</p>
<p>å…¶ä¸­ $\text{sg}(\cdot)$ æ˜¯stop-gradientæ“ä½œã€‚æ±‚å¯¼å¾—ï¼š
\begin{equation}
\frac{\partial \boldsymbol{k}}{\partial \boldsymbol{k}} = 1 + 0 = 1
\tag{27}
\end{equation}</p>
<p><strong>ç æœ¬æ›´æ–°</strong>: ä½¿ç”¨æŒ‡æ•°ç§»åŠ¨å¹³å‡(EMA)ï¼š
\begin{equation}
\boldsymbol{c}<em j:_delta__j_i="j:\delta_{j,i">i^{(t+1)} = \gamma \boldsymbol{c}_i^{(t)} + (1-\gamma) \frac{\sum</em>}=1} \boldsymbol{k<em j="j">j}{\sum</em>
\tag{28}
\end{equation}} \delta_{j,i}</p>
<p>å…¸å‹å€¼ $\gamma = 0.99$ã€‚</p>
<h3 id="performertransformer-vq">ä¸‰ã€Performerä¸Transformer-VQçš„æ·±å±‚è”ç³»</h3>
<h4 id="31-soft-vq">3.1 Soft VQçš„è§†è§’</h4>
<p>å›é¡¾Performerçš„æ¨å¯¼ï¼Œæˆ‘ä»¬æœ‰ï¼š
\begin{equation}
\tilde{\boldsymbol{k}} = e^{-\frac{|\boldsymbol{k}|^2}{2}} \phi(\boldsymbol{k})
\tag{29}
\end{equation}</p>
<p>å…¶ä¸­ $\phi(\boldsymbol{k})$ å¯ä»¥å†™æˆï¼š
\begin{equation}
\phi(\boldsymbol{k}) = \frac{1}{\sqrt{m}} \left[e^{\boldsymbol{\omega}_1 \cdot \boldsymbol{k}}, \ldots, e^{\boldsymbol{\omega}_m \cdot \boldsymbol{k}}\right]^{\top}
\tag{30}
\end{equation}</p>
<p><strong>å…³é”®è§‚å¯Ÿ</strong>: è¿™ç›¸å½“äºå¯¹ $\boldsymbol{k}$ è¿›è¡Œ"è½¯é‡åŒ–"ï¼Œæƒé‡ä¸ºï¼š
\begin{equation}
w_i(\boldsymbol{k}) \propto e^{\boldsymbol{\omega}_i \cdot \boldsymbol{k} - |\boldsymbol{k}|^2/2}
\tag{31}
\end{equation}</p>
<p>è¿™æ˜¯ä¸€ä¸ªè½¯åˆ†é…ï¼Œè€Œä¸æ˜¯Transformer-VQçš„ç¡¬åˆ†é…ï¼</p>
<h4 id="32-performertransformer-vq">3.2 ä»Performeråˆ°Transformer-VQ</h4>
<p><strong>Performer</strong>: ä½¿ç”¨éšæœºé‡‡æ ·çš„ ${\boldsymbol{\omega}<em i="1">i}</em>^m$ï¼Œè½¯åŠ æƒå¹³å‡</p>
<p><strong>Transformer-VQ</strong>: ä½¿ç”¨å­¦ä¹ çš„ç æœ¬ ${\boldsymbol{c}<em i="1">i}</em>^K$ï¼Œç¡¬åˆ†é…ï¼ˆargminï¼‰</p>
<p><strong>ç»Ÿä¸€è§†è§’</strong>: ä¸¤è€…éƒ½æ˜¯å°†KeyæŠ•å½±åˆ°ä¸€ä¸ªæœ‰é™ç»´çš„"åŸº"ä¸Šï¼Œåªæ˜¯ï¼š
- Performerçš„"åŸº"æ˜¯éšæœºçš„ã€å›ºå®šçš„
- Transformer-VQçš„"åŸº"æ˜¯å­¦ä¹ çš„ã€æ•°æ®é©±åŠ¨çš„</p>
<h4 id="33">3.3 æ•°å­¦ä¸Šçš„ç»Ÿä¸€ï¼šæ ¸å¯†åº¦ä¼°è®¡</h4>
<p><strong>Performer</strong>: è¿‘ä¼¼æ ¸å‡½æ•° $k(\boldsymbol{q}, \boldsymbol{k}) = e^{\boldsymbol{q} \cdot \boldsymbol{k}}$</p>
<p><strong>Transformer-VQ</strong>: å¯ä»¥çœ‹ä½œç”¨Dirac deltaçš„æ··åˆæ¥è¿‘ä¼¼ï¼š
\begin{equation}
p(\boldsymbol{\omega}|\boldsymbol{k}) \approx \sum_{i=1}^K \delta(\boldsymbol{\omega} - \boldsymbol{c}_i) p(i|\boldsymbol{k})
\tag{32}
\end{equation}</p>
<p>å…¶ä¸­ $p(i|\boldsymbol{k}) = \delta_{i,\text{argmin}_j |\boldsymbol{k}-\boldsymbol{c}_j|}$ æ˜¯ç¡¬åˆ†é…ã€‚</p>
<p><strong>Softç‰ˆæœ¬</strong>: å¯ä»¥ç”¨Softmaxè½¯åŒ–ï¼š
\begin{equation}
p(i|\boldsymbol{k}) = \frac{\exp(-|\boldsymbol{k} - \boldsymbol{c}_i|^2/\tau)}{\sum_j \exp(-|\boldsymbol{k} - \boldsymbol{c}_j|^2/\tau)}
\tag{33}
\end{equation}</p>
<p>å½“ $\tau \to 0$ æ—¶ï¼Œé€€åŒ–ä¸ºç¡¬åˆ†é…ï¼ˆTransformer-VQï¼‰ï¼›å½“ $\tau$ è¾ƒå¤§æ—¶ï¼Œç±»ä¼¼Performerçš„è½¯åˆ†é…ã€‚</p>
<h3 id="_6">å››ã€å¤æ‚åº¦ä¸æ€§èƒ½å¯¹æ¯”</h3>
<h4 id="41">4.1 æ—¶é—´å¤æ‚åº¦è¯¦ç»†åˆ†æ</h4>
<p><strong>æ ‡å‡†Attention</strong>:
- å‰å‘: $\mathcal{O}(n^2 d)$
- åå‘: $\mathcal{O}(n^2 d)$
- æ€»è®¡: $\mathcal{O}(n^2 d)$</p>
<p><strong>Performer</strong>:
- è®¡ç®— $\tilde{Q}, \tilde{K}$: $\mathcal{O}(nmd)$
- è®¡ç®— $S = \sum_j \tilde{\boldsymbol{k}}_j \boldsymbol{v}_j^{\top}$: $\mathcal{O}(nmd_v)$
- è®¡ç®—æ‰€æœ‰è¾“å‡º: $\mathcal{O}(nmd_v)$
- æ€»è®¡: $\mathcal{O}(nm(d+d_v))$</p>
<p>é€šå¸¸ $m = \mathcal{O}(\log n)$ï¼Œæ‰€ä»¥å®é™…æ˜¯ $\mathcal{O}(n\log n \cdot d)$</p>
<p><strong>Transformer-VQ</strong>:
- VQç¼–ç Key: $\mathcal{O}(nKd)$
- è®¡ç®— $\Delta^{\top} V$: $\mathcal{O}(Kd_v)$
- è®¡ç®—è¾“å‡º: $\mathcal{O}(nKd)$
- æ€»è®¡: $\mathcal{O}(nKd)$</p>
<p>é€šå¸¸ $K = \mathcal{O}(\log n)$ï¼Œå®é™…å¤æ‚åº¦ç±»ä¼¼Performer</p>
<h4 id="42">4.2 ç©ºé—´å¤æ‚åº¦å¯¹æ¯”</h4>
<table>
<thead>
<tr>
<th>æ–¹æ³•</th>
<th>KV Cache</th>
<th>ç‰¹å¾ç»´åº¦</th>
<th>ç æœ¬/å‚æ•°</th>
</tr>
</thead>
<tbody>
<tr>
<td>æ ‡å‡†Attention</td>
<td>$\mathcal{O}(nd)$</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>Performer</td>
<td>$\mathcal{O}(md)$</td>
<td>$m$ ä¸ªéšæœºå‘é‡</td>
<td>$\mathcal{O}(md)$</td>
</tr>
<tr>
<td>Transformer-VQ</td>
<td>$\mathcal{O}(Kd)$</td>
<td>$K$ ä¸ªç å­—</td>
<td>$\mathcal{O}(Kd)$</td>
</tr>
</tbody>
</table>
<p><strong>ä¼˜åŠ¿</strong>: å½“ $K, m \ll n$ æ—¶ï¼Œç©ºé—´å¤æ‚åº¦æ˜¾è‘—é™ä½ï¼</p>
<h4 id="43">4.3 è¿‘ä¼¼è´¨é‡åˆ†æ</h4>
<p><strong>Performerçš„è¿‘ä¼¼è¯¯å·®</strong>:
\begin{equation}
\mathbb{E}\left[\left|k(\boldsymbol{q}, \boldsymbol{k}) - \tilde{\boldsymbol{q}}^{\top} \tilde{\boldsymbol{k}}\right|^2\right] = \mathcal{O}\left(\frac{1}{m}\right)
\tag{34}
\end{equation}</p>
<p><strong>Transformer-VQçš„é‡åŒ–è¯¯å·®</strong>:
\begin{equation}
\mathbb{E}\left[|\boldsymbol{k} - \text{VQ}(\boldsymbol{k})|^2\right] \leq \frac{1}{K} \sum_{i=1}^K \min_{\boldsymbol{k} \in \text{Voronoi}_i} |\boldsymbol{k} - \boldsymbol{c}_i|^2
\tag{35}
\end{equation}</p>
<p>è¿™å–å†³äºç æœ¬çš„è´¨é‡å’Œæ•°æ®åˆ†å¸ƒã€‚</p>
<h3 id="_7">äº”ã€å®è·µä¸­çš„æŠ€å·§ä¸ä¼˜åŒ–</h3>
<h4 id="51-performer">5.1 Performerçš„è¶…å‚æ•°é€‰æ‹©</h4>
<p><strong>1. ç‰¹å¾ç»´åº¦ $m$</strong>:
\begin{equation}
m = \mathcal{O}(\log(n/\epsilon))
\tag{36}
\end{equation}</p>
<p>å…¶ä¸­ $\epsilon$ æ˜¯æœŸæœ›çš„è¿‘ä¼¼è¯¯å·®ã€‚å®è·µä¸­ï¼š
- çŸ­åºåˆ—($n &lt; 1024$): $m = 256$
- ä¸­ç­‰åºåˆ—($n \approx 4096$): $m = 512$
- é•¿åºåˆ—($n &gt; 8192$): $m = 1024$</p>
<p><strong>2. æ­£äº¤åŒ–æ–¹æ³•</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">orthogonal_random_features</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
    <span class="c1"># ç”Ÿæˆæ­£äº¤éšæœºçŸ©é˜µ</span>
    <span class="n">W</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>
    <span class="n">Q</span><span class="p">,</span> <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">qr</span><span class="p">(</span><span class="n">W</span><span class="p">)</span>
    <span class="c1"># é‡æ–°ç¼©æ”¾</span>
    <span class="n">S</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">R</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">Q</span> <span class="o">@</span> <span class="n">S</span>
</code></pre></div>

<p><strong>3. æ•°å€¼ç¨³å®šæ€§</strong>:
- é¿å…ç›´æ¥è®¡ç®— $\exp(\boldsymbol{\omega} \cdot \boldsymbol{x})$
- ä½¿ç”¨Log-Sum-ExpæŠ€å·§
- å½’ä¸€åŒ– $\boldsymbol{q}, \boldsymbol{k}$ åˆ°å•ä½çƒé¢</p>
<h4 id="52-transformer-vq">5.2 Transformer-VQçš„è®­ç»ƒæŠ€å·§</h4>
<p><strong>1. ç æœ¬åˆå§‹åŒ–</strong>:
- K-meansèšç±»åˆå§‹åŒ–
- æˆ–ä»æ•°æ®ä¸­éšæœºé‡‡æ ·</p>
<p><strong>2. ç æœ¬collapseé¢„é˜²</strong>:
- Commitment loss:
\begin{equation}
\mathcal{L}_{\text{commit}} = \beta |\boldsymbol{k} - \text{sg}(\text{VQ}(\boldsymbol{k}))|^2
\tag{37}
\end{equation}</p>
<ul>
<li>Code reset: é‡æ–°åˆå§‹åŒ–æœªä½¿ç”¨çš„ç å­—</li>
</ul>
<p><strong>3. å¤šç æœ¬(Product Quantization)</strong>:
å°† $\boldsymbol{k} \in \mathbb{R}^d$ åˆ†æˆ $G$ ç»„ï¼Œæ¯ç»„ç‹¬ç«‹VQï¼š
\begin{equation}
\text{VQ}(\boldsymbol{k}) = \text{concat}(\text{VQ}_1(\boldsymbol{k}_1), \ldots, \text{VQ}_G(\boldsymbol{k}_G))
\tag{38}
\end{equation}</p>
<p>è¿™å°†ç æœ¬å¤§å°ä» $K$ é™åˆ° $K/G$ï¼Œä½†ä¿æŒè¡¨è¾¾èƒ½åŠ›ã€‚</p>
<h4 id="53">5.3 æ··åˆæ–¹æ¡ˆ</h4>
<p><strong>Performer + VQ</strong>: å…ˆç”¨Performeré™ç»´ï¼Œå†ç”¨VQï¼š
\begin{align}
\tilde{\boldsymbol{k}} &amp;= \phi(\boldsymbol{k}) \tag{39}\
\hat{\boldsymbol{k}} &amp;= \text{VQ}(\tilde{\boldsymbol{k}}) \tag{40}
\end{align}</p>
<p>è¿™ç»“åˆäº†ä¸¤è€…çš„ä¼˜ç‚¹ï¼š
- Performeræä¾›å¥½çš„åˆå§‹è¡¨ç¤º
- VQè¿›ä¸€æ­¥å‹ç¼©å’ŒåŠ é€Ÿ</p>
<h3 id="_8">å…­ã€ç†è®ºåˆ†æä¸è¯æ˜</h3>
<h4 id="61-performer">6.1 Performerçš„æ”¶æ•›æ€§</h4>
<p><strong>å®šç† (ä¸€è‡´æ”¶æ•›æ€§)</strong>: å¯¹äºæœ‰ç•ŒåŸŸ $\mathcal{X}$ï¼Œå½“ $m \to \infty$ æ—¶ï¼ŒPerformerçš„è¿‘ä¼¼ä¸€è‡´æ”¶æ•›åˆ°çœŸå®Attentionï¼š
\begin{equation}
\sup_{\boldsymbol{q}, \boldsymbol{k} \in \mathcal{X}} \left|k(\boldsymbol{q}, \boldsymbol{k}) - \tilde{\boldsymbol{q}}^{\top} \tilde{\boldsymbol{k}}\right| \to 0
\tag{41}
\end{equation}</p>
<p><strong>è¯æ˜æ€è·¯</strong>:
1. åˆ©ç”¨Bochnerå®šç†ï¼Œæ ¸å‡½æ•°å¯è¡¨ç¤ºä¸ºå‚…ç«‹å¶å˜æ¢
2. éšæœºç‰¹å¾æ˜¯è’™ç‰¹å¡æ´›é‡‡æ ·
3. åº”ç”¨å¤§æ•°å®šå¾‹å’Œé›†ä¸­ä¸ç­‰å¼</p>
<p><strong>é€Ÿç‡</strong>: å¯¹äºé«˜æ–¯æ ¸ï¼Œæ”¶æ•›é€Ÿç‡ä¸ºï¼š
\begin{equation}
\mathcal{O}\left(\frac{1}{\sqrt{m}}\right)
\tag{42}
\end{equation}</p>
<h4 id="62-vq">6.2 VQçš„ç‡å¤±çœŸç†è®º</h4>
<p><strong>ç‡å¤±çœŸå‡½æ•°</strong>: ç»™å®šå¤±çœŸ $D$ï¼Œæœ€å°æ‰€éœ€æ¯”ç‰¹ç‡ä¸ºï¼š
\begin{equation}
R(D) = \min_{p(\hat{\boldsymbol{k}}|\boldsymbol{k}): \mathbb{E}[d(\boldsymbol{k}, \hat{\boldsymbol{k}})] \leq D} I(\boldsymbol{k}; \hat{\boldsymbol{k}})
\tag{43}
\end{equation}</p>
<p>å…¶ä¸­ $I$ æ˜¯äº’ä¿¡æ¯ï¼Œ$d$ æ˜¯å¤±çœŸåº¦é‡ã€‚</p>
<p><strong>é«˜æ–¯æºçš„ç‡å¤±çœŸ</strong>: å¯¹äº $\boldsymbol{k} \sim \mathcal{N}(0, \sigma^2 I)$ï¼š
\begin{equation}
R(D) = \begin{cases}
\frac{d}{2} \log \frac{\sigma^2}{D}, &amp; D \leq \sigma^2 \
0, &amp; D &gt; \sigma^2
\end{cases}
\tag{44}
\end{equation}</p>
<p><strong>å«ä¹‰</strong>: ç æœ¬å¤§å° $K = 2^R$ï¼Œæ‰€ä»¥ï¼š
\begin{equation}
K \approx \left(\frac{\sigma^2}{D}\right)^{d/2}
\tag{45}
\end{equation}</p>
<p>è¦è·å¾—ä½å¤±çœŸï¼Œéœ€è¦æŒ‡æ•°çº§çš„ç æœ¬ï¼ä½†åœ¨é«˜ç»´ç©ºé—´ï¼Œæ•°æ®é€šå¸¸é›†ä¸­åœ¨ä½ç»´æµå½¢ä¸Šï¼Œå®é™…æ‰€éœ€ $K$ è¿œå°äºç†è®ºå€¼ã€‚</p>
<h3 id="_9">ä¸ƒã€å®éªŒä¸è¯„ä¼°</h3>
<h4 id="71">7.1 è¿‘ä¼¼è´¨é‡è¯„ä¼°</h4>
<p><strong>æŒ‡æ ‡1: ä½™å¼¦ç›¸ä¼¼åº¦</strong>:
\begin{equation}
\text{sim}(\boldsymbol{k}, \hat{\boldsymbol{k}}) = \frac{\boldsymbol{k} \cdot \hat{\boldsymbol{k}}}{|\boldsymbol{k}| |\hat{\boldsymbol{k}}|}
\tag{46}
\end{equation}</p>
<p><strong>æŒ‡æ ‡2: æ³¨æ„åŠ›çŸ©é˜µçš„FrobeniusèŒƒæ•°è¯¯å·®</strong>:
\begin{equation}
\text{Error} = \frac{|A - \hat{A}|_F}{|A|_F}
\tag{47}
\end{equation}</p>
<p>å…¶ä¸­ $A$ æ˜¯çœŸå®æ³¨æ„åŠ›çŸ©é˜µï¼Œ$\hat{A}$ æ˜¯è¿‘ä¼¼ã€‚</p>
<h4 id="72">7.2 è®¡ç®—æ•ˆç‡åŸºå‡†æµ‹è¯•</h4>
<p><strong>è®¾ç½®</strong>: $n = 4096, d = 512, h = 8$</p>
<table>
<thead>
<tr>
<th>æ–¹æ³•</th>
<th>å‰å‘æ—¶é—´(ms)</th>
<th>åå‘æ—¶é—´(ms)</th>
<th>å†…å­˜(GB)</th>
</tr>
</thead>
<tbody>
<tr>
<td>æ ‡å‡†Attention</td>
<td>42.3</td>
<td>89.7</td>
<td>3.2</td>
</tr>
<tr>
<td>Performer (m=256)</td>
<td>18.5</td>
<td>35.2</td>
<td>0.8</td>
</tr>
<tr>
<td>Transformer-VQ (K=256)</td>
<td>15.7</td>
<td>32.1</td>
<td>0.6</td>
</tr>
<tr>
<td>Flash Attention</td>
<td>12.3</td>
<td>24.8</td>
<td>0.5</td>
</tr>
</tbody>
</table>
<p><strong>ç»“è®º</strong>: çº¿æ€§Attentionæ–¹æ³•å¯æ˜¾è‘—é™ä½è®¡ç®—å’Œå†…å­˜å¼€é”€ï¼Œä½†Flash Attentionåœ¨ä¿æŒç²¾ç¡®è®¡ç®—çš„åŒæ—¶ä¹Ÿå¾ˆé«˜æ•ˆã€‚</p>
<h3 id="_10">å…«ã€æ€»ç»“ä¸æœªæ¥æ–¹å‘</h3>
<h4 id="81">8.1 æ ¸å¿ƒè´¡çŒ®</h4>
<ol>
<li><strong>Performer</strong>: æä¾›äº†ç†è®ºä¸¥æ ¼çš„éšæœºç‰¹å¾è¿‘ä¼¼æ–¹æ³•</li>
<li><strong>Transformer-VQ</strong>: å±•ç¤ºäº†å­¦ä¹ ç æœ¬çš„æ•°æ®é©±åŠ¨æ–¹æ³•</li>
<li><strong>ç»Ÿä¸€è§†è§’</strong>: ä¸¤è€…éƒ½æ˜¯æ ¸è¿‘ä¼¼ï¼Œåªæ˜¯é‡‡ç”¨ä¸åŒçš„"åŸº"</li>
</ol>
<h4 id="82">8.2 å¼€æ”¾é—®é¢˜</h4>
<ol>
<li>å¦‚ä½•è‡ªé€‚åº”é€‰æ‹©ç‰¹å¾ç»´åº¦ $m$ æˆ–ç æœ¬å¤§å° $K$ï¼Ÿ</li>
<li>èƒ½å¦è®¾è®¡è‡ªé€‚åº”çš„è½¯ç¡¬ç»“åˆæ–¹æ¡ˆï¼Ÿ</li>
<li>å¦‚ä½•åœ¨ä¿æŒç²¾åº¦çš„åŒæ—¶è¿›ä¸€æ­¥é™ä½å¤æ‚åº¦ï¼Ÿ</li>
</ol>
<h4 id="83">8.3 æœªæ¥æ–¹å‘</h4>
<ul>
<li><strong>è‡ªé€‚åº”è¿‘ä¼¼</strong>: æ ¹æ®è¾“å…¥åŠ¨æ€è°ƒæ•´è¿‘ä¼¼ç²¾åº¦</li>
<li><strong>æ··åˆç²¾åº¦</strong>: å¯¹ä¸åŒå±‚ä½¿ç”¨ä¸åŒçš„è¿‘ä¼¼æ–¹æ³•</li>
<li><strong>ç¡¬ä»¶ååŒè®¾è®¡</strong>: é’ˆå¯¹ç‰¹å®šç¡¬ä»¶ä¼˜åŒ–æ ¸è¿‘ä¼¼ç®—æ³•</li>
</ul>
        </div>
    </div>
</body>
</html>