<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transformerå‡çº§ä¹‹è·¯ï¼š15ã€Keyå½’ä¸€åŒ–åŠ©åŠ›é•¿åº¦å¤–æ¨</title>
    <style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    line-height: 1.6; color: #333; max-width: 900px; margin: 0 auto; padding: 20px; background: #f5f5f5;
}
.container { background: white; padding: 40px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
header { border-bottom: 2px solid #e0e0e0; padding-bottom: 20px; margin-bottom: 30px; }
h1 { color: #2c3e50; margin-bottom: 10px; font-size: 2em; }
.meta { color: #666; font-size: 0.9em; margin-bottom: 20px; }
.content { margin-top: 30px; overflow-wrap: break-word; }
.content h2 { color: #34495e; margin-top: 30px; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
.content p { margin-bottom: 15px; }
.content pre { background: #f8f8f8; padding: 15px; border-radius: 5px; overflow-x: auto; border-left: 3px solid #3498db; margin: 15px 0; }
.content code { background: #f8f8f8; padding: 2px 5px; border-radius: 3px; font-family: monospace; font-size: 0.9em; }
.content blockquote { border-left: 4px solid #3498db; padding-left: 20px; margin: 20px 0; color: #555; font-style: italic; }
.content table { border-collapse: collapse; width: 100%; margin: 20px 0; }
.content th, .content td { border: 1px solid #ddd; padding: 10px; text-align: left; }
.back-link { display: inline-block; margin-bottom: 20px; color: #3498db; text-decoration: none; font-weight: 500; }
</style>
    
<script>
    window.MathJax = {
        tex: {
            inlineMath: [['$', '$'], ['\(', '\)']],
            displayMath: [['$$', '$$'], ['\[', '\]']],
            processEscapes: true
        }
    };
</script>
<script id="MathJax-script" async src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>

</head>
<body>
    <div class="container">
        <a href="../index.html" class="back-link">â† è¿”å›é¦–é¡µ</a>
        <header>
            <h1>Transformerå‡çº§ä¹‹è·¯ï¼š15ã€Keyå½’ä¸€åŒ–åŠ©åŠ›é•¿åº¦å¤–æ¨</h1>
            <div class="meta">ğŸ“… æœ€åæ›´æ–°: 2025-11-26 | ğŸ“„ å¤§å°: 56.5 KB</div>
        </header>
        <div class="content">
            <p><strong>åŸæ–‡é“¾æ¥</strong>: <a href="https://spaces.ac.cn/archives/9859">https://spaces.ac.cn/archives/9859</a></p>
<p><strong>å‘å¸ƒæ—¥æœŸ</strong>: </p>
<hr />
<p>å¤§ä½“ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥å°†ç›®å‰Transformerçš„é•¿åº¦å¤–æ¨æŠ€æœ¯åˆ†ä¸ºä¸¤ç±»ï¼šä¸€ç±»æ˜¯äº‹åä¿®æ”¹ï¼Œæ¯”å¦‚<a href="/archives/9675">NTK-RoPE</a>ã€<a href="https://papers.cool/arxiv/2309.00071">YaRN</a>ã€<a href="/archives/9708">ReRoPE</a>ç­‰ï¼Œè¿™ç±»æ–¹æ³•çš„ç‰¹ç‚¹æ˜¯ç›´æ¥ä¿®æ”¹æ¨ç†æ¨¡å‹ï¼Œæ— éœ€å¾®è°ƒå°±èƒ½è¾¾åˆ°ä¸€å®šçš„é•¿åº¦å¤–æ¨æ•ˆæœï¼Œä½†ç¼ºç‚¹æ˜¯å®ƒä»¬éƒ½æ— æ³•ä¿æŒæ¨¡å‹åœ¨è®­ç»ƒé•¿åº¦å†…çš„æ’ç­‰æ€§ï¼›å¦ä¸€ç±»è‡ªç„¶æ˜¯äº‹å‰ä¿®æ”¹ï¼Œå¦‚<a href="/archives/9431#ALIBI">ALIBI</a>ã€<a href="/archives/9431#KERPLE">KERPLE</a>ã€<a href="/archives/9431#XPOS">XPOS</a>ä»¥åŠ<a href="/archives/9603">HWFA</a>ç­‰ï¼Œå®ƒä»¬å¯ä»¥ä¸åŠ æ”¹åŠ¨åœ°å®ç°ä¸€å®šçš„é•¿åº¦å¤–æ¨ï¼Œä½†ç›¸åº”çš„æ”¹åŠ¨éœ€è¦åœ¨è®­ç»ƒä¹‹å‰å°±å¼•å…¥ï¼Œå› æ­¤æ— æ³•ä¸å¾®è°ƒåœ°ç”¨äºç°æˆæ¨¡å‹ï¼Œå¹¶ä¸”è¿™ç±»æ–¹æ³•æ˜¯å¦èƒ½å¤ŸScale Upè¿˜æ²¡å¾—åˆ°å¹¿æ³›è®¤å¯ã€‚</p>
<p>åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œç¬”è€…å°†ä»‹ç»ä¸€ç§æ„å¤–å‘ç°çš„é•¿åº¦å¤–æ¨æ–¹æ¡ˆâ€”â€”â€œKeyNormâ€â€”â€”å¯¹Attentionçš„Keyåºåˆ—åšL2 Normalizationï¼Œå¾ˆæ˜æ˜¾å®ƒå±äºäº‹å‰ä¿®æ”¹ä¸€ç±»ï¼Œä½†å¯¹Attentionæœºåˆ¶çš„ä¿®æ”¹éå¸¸å°ï¼Œå› æ­¤çœ‹ä¸Šå»éå¸¸æœ‰å¸Œæœ›èƒ½å¤ŸScale Upã€‚</p>
<h2 id="_1">æœ€åˆåŠ¨æœº</h2>
<p>ä¹‹æ‰€ä»¥è¯´â€œæ„å¤–å‘ç°â€ï¼Œæ˜¯å› ä¸ºè¯¥æ”¹åŠ¨çš„åŸå§‹åŠ¨æœºå¹¶ä¸æ˜¯é•¿åº¦å¤–æ¨ï¼Œè€Œæ˜¯å°è¯•æ›¿æ¢Scaled Dot-Product Attentionä¸­çš„Scaleæ–¹å¼ã€‚æˆ‘ä»¬çŸ¥é“ï¼ŒAttentionçš„æ ‡å‡†å®šä¹‰æ˜¯ï¼ˆæœ¬æ–‡ä¸»è¦è€ƒè™‘Causalåœºæ™¯ï¼‰<br />
\begin{equation}\boldsymbol{o}<em j="j">i = \frac{\sum</em>}^i\exp\left(\frac{\boldsymbol{q<em j="j">i\cdot \boldsymbol{k}_j}{\sqrt{d}}\right)\boldsymbol{v}_j}{\sum</em>}^i\exp\left(\frac{\boldsymbol{q<em i="1">i\cdot \boldsymbol{k}_j}{\sqrt{d}}\right)},\quad \boldsymbol{q}_i,\boldsymbol{k}_j\in\mathbb{R}^d\label{eq:sdpa}\end{equation}<br />
å…¶ä¸­ï¼ŒScaleå› å­$\frac{1}{\sqrt{d}}$æˆ‘ä»¬å·²ç»å¤šæ¬¡è¿›è¡Œè¿‡è§£é‡Šç”šè‡³æ¨å¹¿ï¼Œæ¯”å¦‚<a href="/archives/8620#NTK%E5%8F%82%E6%95%B0%E5%8C%96">ã€Šæµ…è°ˆTransformerçš„åˆå§‹åŒ–ã€å‚æ•°åŒ–ä¸æ ‡å‡†åŒ–ã€‹</a>ã€<a href="/archives/8823">ã€Šä»ç†µä¸å˜æ€§çœ‹Attentionçš„Scaleæ“ä½œã€‹</a>ã€<a href="/archives/9812">ã€Šä»æ¢¯åº¦æœ€å¤§åŒ–çœ‹Attentionçš„Scaleæ“ä½œã€‹</a>ç­‰ã€‚æ ‡å‡†çš„æ¨å¯¼æ˜¯åœ¨â€œ$\boldsymbol{q}_i,\boldsymbol{k}_j$å‡ç‹¬ç«‹åœ°é‡‡æ ·è‡ªâ€œå‡å€¼ä¸º0ã€æ–¹å·®ä¸º1â€çš„åˆ†å¸ƒâ€çš„å‡è®¾ä¸‹è¿›è¡Œçš„ï¼Œè€Œåœ¨è¯¥å‡è®¾ä¹‹ä¸‹ï¼Œæˆ‘ä»¬è¿˜æœ‰<br />
\begin{equation}\Vert\boldsymbol{q}_i\Vert\approx \sqrt{d},\quad \Vert\boldsymbol{k}_j\Vert\approx \sqrt{d}\end{equation}<br />
è¿™æ˜¯å› ä¸º<br />
\begin{equation}\Vert\boldsymbol{x}\Vert^2 = \sum</em>}^d x_i^2 = d\times\frac{1}{d}\sum_{i=1}^d x_i^2\approx d\,\mathbb{E<em j="j">{x\sim\mathcal{N}(0,1)}[x^2] = d\end{equation}<br />
ç›¸å…³æ¨å¹¿è¿˜å¯ä»¥å‚è€ƒ<a href="/archives/8679#%E5%BC%95%E7%90%86%E7%9A%84%E5%BC%95%E7%90%86">ã€Šè®©äººæƒŠå¹çš„Johnson-Lindenstrausså¼•ç†ï¼šç†è®ºç¯‡ã€‹</a>ã€‚è¿™ä¸ªè¿‘ä¼¼å¼æ„å‘³ç€ï¼Œåœ¨Attentionçš„åˆå§‹é˜¶æ®µå¼$\eqref{eq:sdpa}$ä¸ä¸‹é¢ä¸¤ä¸ªå˜ä½“æœ‰ç€ç›¸åŒçš„æ•ˆæœï¼š<br />
\begin{align}\color{red}{\text{Q}}\text{uery}\color{red}{\text{N}}\text{orm:}\quad\boldsymbol{o}_i =&amp;\, \frac{\sum</em>}^i\exp\left(\tilde{\boldsymbol{q}<em j="j">i\cdot \boldsymbol{k}_j\right)\boldsymbol{v}_j}{\sum</em>}^i\exp\left(\tilde{\boldsymbol{q}<em j="j">i\cdot \boldsymbol{k}_j\right)},\qquad \tilde{\boldsymbol{q}}_i = \frac{\boldsymbol{q}_i}{\Vert\boldsymbol{q}_i\Vert} \\\[5pt]<br />
\color{red}{\text{K}}\text{ey}\color{red}{\text{N}}\text{orm:}\quad\boldsymbol{o}_i =&amp;\, \frac{\sum</em>}^i\exp\left(\boldsymbol{q<em j="j">i\cdot \tilde{\boldsymbol{k}}_j\right)\boldsymbol{v}_j}{\sum</em>}^i\exp\left(\boldsymbol{q}_i\cdot \tilde{\boldsymbol{k}}_j\right)},\qquad \tilde{\boldsymbol{k}}_j = \frac{\boldsymbol{k}_j}{\Vert\boldsymbol{k}_j\Vert<br />
\end{align}<br />
å› æ­¤ï¼Œå°±æœ‰äº†éªŒè¯è¿™ä¸¤ä¸ªå˜ä½“ä¸æ ‡å‡†çš„å¼$\eqref{eq:sdpa}$å“ªä¸ªæ›´ä¼˜çš„æƒ³æ³•ã€‚ä¸ºäº†æè¿°çš„æ–¹ä¾¿ï¼Œæˆ‘ä»¬å¯ä»¥ç›¸åº”åœ°ç§°ä¸ºâ€œQuery/Key-Normalized Dot-Product Attentionâ€ï¼Œåˆ†åˆ«ç®€ç§°ä¸ºâ€œQNAâ€å’Œâ€œKNAâ€ã€‚</p>
<p>æ­¤å¤–ï¼Œæ—¢ç„¶å¯ä»¥QueryNormå’ŒKeyNormï¼Œé‚£ä¹ˆè‡ªç„¶ä¹Ÿå¯ä»¥è€ƒè™‘ä¸¤è€…éƒ½Normä¸€ä¸‹ï¼Œæ‰€ä»¥æˆ‘ä»¬å°†å¦‚ä¸‹â€œScaled Cosine Attentionï¼ˆCosAï¼‰â€ä¹Ÿä¸€å¹¶è¿›è¡Œå®éªŒï¼š<br />
\begin{equation}\boldsymbol{o}<em j="j">i = \frac{\sum</em>}^i\exp\left(\lambda\,\tilde{\boldsymbol{q}<em j="j">i\cdot \tilde{\boldsymbol{k}}_j\right)\boldsymbol{v}_j}{\sum</em>}^i\exp\left(\lambda\,\tilde{\boldsymbol{q}<em j="j">i\cdot \tilde{\boldsymbol{k}}_j\right)} = \frac{\sum</em>}^i\exp\left(\lambda\cos(\boldsymbol{q<em j="j">i,\boldsymbol{k}_j)\right)\boldsymbol{v}_j}{\sum</em>}^i\exp\left(\lambda\cos(\boldsymbol{q}_i,\boldsymbol{k}_j)\right)<br />
\end{equation}<br />
å…¶ä¸­$\lambda$é‡‡ç”¨<a href="/archives/9812">ã€Šä»æ¢¯åº¦æœ€å¤§åŒ–çœ‹Attentionçš„Scaleæ“ä½œã€‹</a>ä¸­çš„ç»“æœï¼Œå³$\lambda = 4\log n$ï¼ˆåŸæ–‡æ˜¯3.5ï¼Œä½†ä¸‹é¢è®­ç»ƒé•¿åº¦æ¯”è¾ƒå°ï¼Œæ”¹ä¸º4æ›´ç²¾å‡†ä¸€äº›ï¼‰ï¼Œå…¶ä¸­$n$å›ºå®šä¸ºè®­ç»ƒé•¿åº¦çš„ä¸€åŠï¼Œæˆ–è€…åŠ¨æ€å–ä½ç½®idåŠ 1ã€‚</p>
<h2 id="_2">å…ˆçœ‹ç»“æœ</h2>
<p>æ²¿ç€<a href="/archives/9731#%E5%AE%9E%E9%AA%8C">ä¹‹å‰</a>åšé•¿åº¦å¤–æ¨çš„å®éªŒè®¾ç½®ï¼Œéƒ½æ˜¯1äº¿å‚æ•°çš„å°æ¨¡å‹ï¼Œ<a href="/archives/9052">GAU</a>æ¶æ„ï¼Œè®­ç»ƒç›¸åŒçš„æ­¥æ•°ï¼ˆæ—¶é—´æœ‰é™ï¼Œè¿™ä¸ªæ­¥æ•°ä¸‹å…¶å®æ¨¡å‹è¿˜æ²¡è®­ç»ƒå……åˆ†ï¼‰ï¼Œè®­ç»ƒé•¿åº¦512ï¼Œå¹¶è€ƒè™‘å¤–æ¨åˆ°4096é•¿åº¦ï¼Œå®éªŒç»“æœå¦‚ä¸‹è¡¨ã€‚å…¶ä¸­Baselineå°±æ˜¯å¼$\eqref{eq:sdpa}$ï¼Œ$\text{-}\log n$å°±æ˜¯åŠ å…¥<a href="/archives/8823">ã€Šä»ç†µä¸å˜æ€§çœ‹Attentionçš„Scaleæ“ä½œã€‹</a>ä»‹ç»çš„é•¿åº¦ç›¸å…³çš„ç¼©æ”¾å› å­ã€‚è¯„ä»·æŒ‡æ ‡æ˜¯è¯­è¨€æ¨¡å‹çš„é€tokenå‡†ç¡®ç‡ï¼Œè¶Šå¤§è¶Šå¥½ã€‚<br />
\begin{array}{c|cc}<br />
\hline<br />
\text{æµ‹è¯•é•¿åº¦} &amp; 512(\text{è®­ç»ƒ}) &amp; 4096(\text{é‡å¤}) &amp; 4096(\text{ä¸é‡å¤}) \\\<br />
\hline<br />
\text{Baseline} &amp; 49.41\% &amp; 24.17\% &amp; 23.16\% \\\<br />
\text{Baseline-}\log n &amp; 49.40\% &amp; 24.60\% &amp; 24.02\% \\\<br />
\hline<br />
\text{QNA} &amp; 49.55\% &amp; 22.45\% &amp; 22.18\% \\\<br />
\text{QNA-}\log n &amp; 49.42\% &amp; 19.55\% &amp; 18.74\% \\\<br />
\text{KNA} &amp; 49.60\% &amp; 61.08\% &amp; 47.69\% \\\<br />
\text{KNA-}\log n &amp; 49.58\% &amp; 63.17\% &amp; 46.40\%\\\<br />
\text{CosA} &amp; 49.73\% &amp; 58.90\% &amp; 46.98\% \\\<br />
\text{CosA-}\log n &amp; 49.67\% &amp; 64.74\% &amp; 48.95\% \\\<br />
\hline<br />
\end{array}<br />
ä»è¡¨æ ¼ä¸­æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼š1ã€ä¸ç®¡æ˜¯QueryNormè¿˜æ˜¯KeyNormï¼Œéƒ½åœ¨è®­ç»ƒé•¿åº¦ä¸Šå–å¾—äº†æ›´å¥½çš„æ•ˆæœï¼Œè™½ç„¶è¿™ä¸ªä¼˜åŠ¿éå¸¸å¾®å¼±ï¼Œå¤§æ¦‚ç‡éšç€è®­ç»ƒçš„è¿›ä¸€æ­¥æ¨è¿›å¯ä»¥å¿½ç•¥ä¸è®¡ï¼Œä½†è¿™ä¸ªä¼˜åŠ¿éå¸¸ç¨³å®šï¼Œæš—ç¤ºç€è®©è®­ç»ƒæ›´åŠ å¹³ç¨³çš„å¯èƒ½æ€§ï¼›2ã€<strong>KeyNormå¯¹é•¿åº¦å¤–æ¨çš„æå‡éå¸¸æ˜æ˜¾</strong> ï¼Œè¿™å°±æ˜¯å®éªŒç»“æœä¸­çš„â€œæ„å¤–ä¹‹å–œâ€ï¼</p>
<p>æ³¨æ„ï¼Œè·ŸNTK-RoPEã€YaRNéœ€è¦ä¿®æ”¹æ¨ç†é˜¶æ®µçš„æ¨¡å‹ä¸åŒï¼Œè¿™é‡Œçš„KNAå’ŒCosAçš„é•¿åº¦å¤–æ¨åœ¨æ¨ç†é˜¶æ®µæ˜¯å®Œå…¨ä¸åšæ”¹åŠ¨çš„ã€‚å› æ­¤ï¼Œå¯èƒ½æœ‰è¯»è€…æƒ³çŸ¥é“ï¼Œæ—¢ç„¶KNAå’ŒCosAæ¨ç†æ—¶ä¸åŠ æ”¹åŠ¨å¤–æ¨æ•ˆæœéƒ½è¿™ä¹ˆå¥½äº†ï¼Œå¦‚æœé…åˆNTK-RoPEã€YaRNç­‰å¤–æ¨æŠ€å·§ï¼Œæ•ˆæœä¼šä¸ä¼šâ€œæ›´ä¸Šä¸€å±‚æ¥¼â€ï¼Ÿå¯¹æ­¤ï¼Œç¬”è€…ä¹Ÿè¿›è¡Œäº†æµ‹è¯•ï¼Œç»“æœå¦‚ä¸‹è¡¨ï¼š<br />
\begin{array}{c|cc}<br />
\hline<br />
\text{æµ‹è¯•é•¿åº¦} &amp; 512(\text{è®­ç»ƒ}) &amp; 4096(\text{é‡å¤}) &amp; 4096(\text{ä¸é‡å¤}) \\\<br />
\hline<br />
\text{Baseline} &amp; 49.41\% &amp; 24.17\% &amp; 23.16\% \\\<br />
\text{Baseline-NTK} &amp; 49.41\% &amp; 60.57\% &amp; 42.20\% \\\<br />
\text{Baseline-YaRN} &amp; 49.41\% &amp; 80.10\% &amp; 47.45\% \\\<br />
\text{Baseline-ReRoPE} &amp; 49.41\% &amp; 76.11\% &amp; 47.82\% \\\<br />
\hline<br />
\text{Baseline-}\log n &amp; 49.40\% &amp; 24.60\% &amp; 24.02\% \\\<br />
\text{Baseline-}\log n\text{-NTK} &amp; 49.40\% &amp; 75.86\% &amp; 47.06\% \\\<br />
\text{Baseline-}\log n\text{-YaRN} &amp; 49.40\% &amp; 82.57\% &amp; 46.52\% \\\<br />
\text{Baseline-}\log n\text{-ReRoPE} &amp; 49.40\% &amp; 85.47\% &amp; 48.87\% \\\<br />
\hline<br />
\text{QNA} &amp; 49.55\% &amp; 22.45\% &amp; 22.18\% \\\<br />
\text{QNA-NTK} &amp; 49.55\% &amp; 52.28\% &amp; 39.88\% \\\<br />
\text{QNA-YaRN} &amp; 49.55\% &amp; 82.53\% &amp; 47.50\% \\\<br />
\text{QNA-ReRoPE} &amp; 49.55\% &amp; 78.22\% &amp; 47.72\% \\\<br />
\hline<br />
\text{QNA-}\log n &amp; 49.42\% &amp; 19.55\% &amp; 18.74\% \\\<br />
\text{QNA-}\log n\text{-NTK} &amp; 49.42\% &amp; 57.44\% &amp; 41.56\% \\\<br />
\text{QNA-}\log n\text{-YaRN} &amp; 49.42\% &amp; 80.08\% &amp; 45.16\% \\\<br />
\text{QNA-}\log n\text{-ReRoPE} &amp; 49.42\% &amp; 84.71\% &amp; 48.31\% \\\<br />
\hline<br />
\text{KNA} &amp; 49.60\% &amp; 61.08\% &amp; 47.69\% \\\<br />
\text{KNA-NTK} &amp; 49.60\% &amp; 64.44\% &amp; 43.02\% \\\<br />
\text{KNA-YaRN} &amp; 49.60\% &amp; 84.19\% &amp; 47.44\% \\\<br />
\text{KNA-ReRoPE} &amp; 49.60\% &amp; 77.76\% &amp; 47.73\% \\\<br />
\hline<br />
\text{KNA-}\log n &amp; 49.58\% &amp; 63.17\% &amp; 46.40\%\\\<br />
\text{KNA-}\log n\text{-NTK} &amp; 49.58\% &amp; 79.05\% &amp; 47.43\%\\\<br />
\text{KNA-}\log n\text{-YaRN} &amp; 49.58\% &amp; 83.95\% &amp; 47.16\%\\\<br />
\text{KNA-}\log n\text{-ReRoPE} &amp; 49.58\% &amp; 85.48\% &amp; 48.78\%\\\<br />
\hline<br />
\text{CosA} &amp; 49.73\% &amp; 58.90\% &amp; 46.98\% \\\<br />
\text{CosA-NTK} &amp; 49.73\% &amp; 62.50\% &amp; 42.77\% \\\<br />
\text{CosA-YaRN} &amp; 49.73\% &amp; 83.40\% &amp; 47.80\% \\\<br />
\text{CosA-ReRoPE} &amp; 49.73\% &amp; 77.82\% &amp; 47.80\% \\\<br />
\hline<br />
\text{CosA-}\log n &amp; 49.67\% &amp; 64.74\% &amp; 48.39\% \\\<br />
\text{CosA-}\log n\text{-NTK} &amp; 49.67\% &amp; 78.97\% &amp; 47.46\% \\\<br />
\text{CosA-}\log n\text{-YaRN} &amp; 49.67\% &amp; 82.28\% &amp; 45.72\% \\\<br />
\text{CosA-}\log n\text{-ReRoPE} &amp; 49.67\% &amp; 85.67\% &amp; 48.39\% \\\<br />
\hline<br />
\end{array}<br />
è¿™ä¸ªè¡¨æ¯”è¾ƒå•°å—¦ï¼Œä¸»è¦æ˜¯ä¸ºäº†è®©å¤§å®¶å¯¹ä¸»æµé•¿åº¦å¤–æ¨æŠ€å·§çš„æ•ˆæœå·®å¼‚æœ‰ä¸€ä¸ªå…¨é¢çš„æ„ŸçŸ¥ï¼Œå¤§å®¶é€‰æ‹©è‡ªå·±æ„Ÿå…´è¶£çš„ç»´åº¦æ¯”è¾ƒå°±å¥½ï¼Œä½†è¦æ³¨æ„å¦‚æœçœ‹é•¿åº¦å¤–æ¨æ•ˆæœçš„è¯ï¼Œåº”è¯¥ä»¥â€œä¸é‡å¤â€ä¸€åˆ—ä¸ºä¸»ï¼Œâ€œé‡å¤â€ä¸€åˆ—ä¸ºè¾…ã€‚ä»ä¸Šè¡¨çœ‹ï¼Œç»“æœç€å®æœ‰ç‚¹è®©äººæ„å¤–ï¼ŒKeyNormä¼¼ä¹â€œå…ç–«â€äº†å·²æœ‰çš„RoPEå¤–æ¨æŠ€å·§ï¼ŒNTKã€YaRNç­‰æŠ€å·§å åŠ ä¸Šå»å¹¶æ²¡æœ‰æ˜æ˜¾æå‡ï¼Œç”šè‡³å¯èƒ½ä¼šä¸‹é™ï¼Œä¸è¿‡æ€»ä½“æ¥çœ‹â€œé‡å¤â€ä¸€åˆ—è¿˜æ˜¯æœ‰æ˜¾è‘—æå‡çš„ï¼Œä¸æ˜¾è‘—çš„æ˜¯â€œä¸é‡å¤â€ä¸€åˆ—ã€‚è¿™äº›ç»“æœè¡¨æ˜ï¼ŒKeyNormä¾ç„¶æœ‰ç€æ— æ³•æœ‰æ•ˆè¯†åˆ«è¶…å‡ºè®­ç»ƒé•¿åº¦çš„ä½ç½®ï¼ˆæ‰€ä»¥â€œé‡å¤â€çš„ç»“æœä¸é«˜ï¼‰çš„é—®é¢˜ï¼Œä½†æœ‰æ•ˆåœ°é¿å…äº†PPLçˆ†ç‚¸é—®é¢˜ï¼ˆæ‰€ä»¥â€œä¸é‡å¤â€çš„ç»“æœè¿˜ä¸é”™ï¼‰ã€‚</p>
<p>è¿™å¯¹åšLong Contextçš„åŒå­¦æ¥è¯´å¯èƒ½æ˜¯ä¸ªå¥½æ¶ˆæ¯ï¼šä¸€æ–¹é¢ï¼ŒKeyNormä¸åƒALIBIã€KERPLEç­‰ï¼Œå®ƒçš„é•¿åº¦å¤–æ¨ä¸ç”¨åŠ Localçº¦æŸï¼Œè®­ç»ƒå®Œæˆåä¹Ÿä¸åšä»»ä½•ä¿®æ”¹ï¼Œçº¯å±æ˜¯â€œå…è´¹çš„åˆé¤â€ï¼Œç”šè‡³çœ‹ä¸Šå»åŠ äº†KeyNormåè®­ç»ƒæ•ˆæœéƒ½å˜å¥½äº†ï¼›å¦ä¸€æ–¹é¢ï¼Œä¹Ÿå› ä¸ºå®ƒæ˜¯éLocalçš„ï¼Œæ‰€ä»¥å¯ä»¥æ›´é•¿æ–‡æœ¬ç»§ç»­è®­ç»ƒï¼Œå¹¶ä¸”ç»§ç»­è®­ç»ƒæ—¶å†ä¹Ÿä¸ç”¨çº ç»“æ˜¯é€‰<a href="https://papers.cool/arxiv/2306.15595">PI</a>è¿˜æ˜¯<a href="https://papers.cool/arxiv/2309.16039">ABF</a>äº†ï¼Œå¯¹äºKeyNormæ¥è¯´ï¼Œå•¥ä¹Ÿä¸æ”¹å°±è¡Œã€‚</p>
<h2 id="_3">åŸç†åˆ†æ</h2>
<p>å°½ç®¡è¿™æ˜¯ä¸ªæ„å¤–å‘ç°ï¼Œä½†æˆ‘ä»¬ä»éœ€è¦å°è¯•å»è§£é‡Šå®ƒï¼Œä¸ç„¶å®ƒå°±ä¸€ç›´åªæ˜¯ä¸ªæ„å¤–ã€‚æ‰€ä»¥è¿™ä¸€èŠ‚æˆ‘ä»¬å°è¯•æ¥æ€è€ƒï¼Œä¸ºä»€ä¹ˆKeyNormä¼šæœ‰åŠ©äºé•¿åº¦å¤–æ¨ã€‚</p>
<p>è®©æˆ‘ä»¬é‡æ–°å›åˆ°å¼$\eqref{eq:sdpa}$ï¼Œç¬¬$i$ä¸ªtokenä¸ç¬¬$j$ä¸ªtokençš„ç›¸å…³æ€§æ‰“åˆ†ç”±å†…ç§¯å®Œæˆï¼š<br />
\begin{equation}s(j|i) = \boldsymbol{q}<em j="1">i\cdot \boldsymbol{k}_j = \Vert\boldsymbol{q}_i\Vert \Vert\boldsymbol{k}_j\Vert \cos(\boldsymbol{q}_i,\boldsymbol{k}_j),\quad p(j|i) = \frac{\exp\left(\frac{s(j|i)}{\sqrt{d}}\right)}{\sum</em>}^i \exp\left(\frac{s(j|i)}{\sqrt{d}}\right)}\end{equation<br />
ç¬¬äºŒä¸ªç­‰å·ï¼Œæˆ‘ä»¬ä»å‡ ä½•æ„ä¹‰å‡ºå‘ï¼Œå°†å®ƒåˆ†è§£ä¸ºäº†å„è‡ªæ¨¡é•¿ä¸å¤¹è§’ä½™å¼¦çš„ä¹˜ç§¯ã€‚æ³¨æ„åŠ›$p(j|i)$æ˜¯ä¸€ä¸ªæ¡ä»¶æ¦‚ç‡ï¼Œ$\Vert\boldsymbol{q}_i\Vert$åªè·Ÿå½“å‰ä½ç½®$i$æœ‰å…³ï¼Œå®ƒä¸æ”¹å˜æ³¨æ„åŠ›çš„ç›¸å¯¹å¤§å°ï¼Œè€Œåªæ”¹å˜<a href="/archives/9595">ç¨€ç–ç¨‹åº¦</a>ï¼›$\Vert\boldsymbol{k}_j\Vert$åˆ™æœ‰èƒ½åŠ›æ”¹å˜$p(j|i)$çš„ç›¸å¯¹å¤§å°ï¼Œä½†å®ƒä¸æ¶‰åŠåˆ°$i,j$çš„äº¤äº’ï¼Œå¯ä»¥ç”¨æ¥è¡¨è¾¾ä¸€äº›ç»å¯¹ä¿¡å·ï¼Œæ¯”å¦‚<a href="https://papers.cool/arxiv/2305.17118">Scissorhands</a>è¡¨æ˜æŸäº›ç»å¯¹ä½ç½®çš„tokençš„æ³¨æ„åŠ›ä¸€ç›´éƒ½ä¼šå¾ˆé«˜ï¼Œè¿™å°±æœ‰å¯èƒ½ç”¨$\Vert\boldsymbol{k}_j\Vert$æ¥è¡¨è¾¾ï¼›å‰©ä¸‹çš„$\cos(\boldsymbol{q}_i,\boldsymbol{k}_j)$å°±æ˜¯ç”¨æ¥è¡¨è¾¾$i,j$çš„äº¤äº’ï¼Œå®ƒæ˜¯è‡ªç”±åº¦æœ€å¤§çš„ä¸€é¡¹ã€‚</p>
<p>å¾ˆæ˜æ˜¾ï¼Œä¸ºäº†æé«˜æŸä¸ªä½ç½®$j$çš„ç›¸å¯¹é‡è¦æ€§ï¼Œæ¨¡å‹æœ‰ä¸¤ä¸ªé€‰æ‹©ï¼š1ã€å¢å¤§æ¨¡é•¿$\Vert\boldsymbol{k}_j\Vert$ï¼›2ã€å¢å¤§$\cos(\boldsymbol{q}_i,\boldsymbol{k}_j)$ï¼Œå³ç¼©å°$\boldsymbol{q}_i,\boldsymbol{k}_j$çš„å¤¹è§’å¤§å°ã€‚ç„¶è€Œï¼Œç”±äºâ€œ<a href="/archives/7076">ç»´åº¦ç¾éš¾</a>â€çš„å­˜åœ¨ï¼Œåœ¨é«˜ç»´ç©ºé—´ä¸­æ˜¾è‘—åœ°æ”¹å˜å¤¹è§’å¤§å°ç›¸å¯¹æ¥è¯´æ²¡æœ‰é‚£ä¹ˆå®¹æ˜“ï¼Œæ‰€ä»¥å¦‚æœèƒ½é å¢å¤§æ¨¡é•¿$\Vert\boldsymbol{k}_j\Vert$å®Œæˆçš„ï¼Œæ¨¡å‹ä¼šä¼˜å…ˆé€‰æ‹©é€šè¿‡å¢å¤§æ¨¡é•¿$\Vert\boldsymbol{k}_j\Vert$æ¥å®Œæˆï¼Œè¿™å¯¼è‡´çš„ç›´æ¥åæœæ˜¯ï¼š$\cos(\boldsymbol{q}_i,\boldsymbol{k}_j)$çš„è®­ç»ƒå¯èƒ½å¹¶ä¸å……åˆ†ã€‚</p>
<p>è¿™é‡Œç¬”è€…ä½œå‡ºä¸€ä¸ªæ–­è¨€ï¼ˆçŒœæµ‹ï¼‰ï¼š</p>
<blockquote>
<p>$\cos(\boldsymbol{q}_i,\boldsymbol{k}_j)$çš„è®­ç»ƒä¸å……åˆ†æ˜¯Attentionæ— æ³•é•¿åº¦å¤–æ¨çš„ä¸»è¦åŸå› ã€‚</p>
</blockquote>
<p>$\cos(\boldsymbol{q}_i,\boldsymbol{k}_j)$çš„è®­ç»ƒä¸å……åˆ†ï¼Œæ˜¯æŒ‡è¢«è®­ç»ƒè¿‡çš„$\boldsymbol{q}_i,\boldsymbol{k}_j$çš„å¤¹è§’åªæ˜¯ä¸€ä¸ªæœ‰é™çš„é›†åˆï¼Œè€Œè¿›è¡Œé•¿åº¦å¤–æ¨æ—¶ï¼Œå®ƒè¦é¢å¯¹ä¸€ä¸ªæ›´å¤§çš„é›†åˆï¼Œä»è€Œæ— æ³•è¿›è¡Œæ­£ç¡®çš„é¢„æµ‹ã€‚ä»”ç»†æ€è€ƒ<a href="https://papers.cool/arxiv/2309.00071">YaRN</a>ä¸€æ–‡çš„æ¨å¯¼å°±ä¼šå‘ç°ï¼ŒNTKã€YaRNä¹‹æ‰€ä»¥æœ‰æ•ˆï¼Œæ˜¯å› ä¸ºä¿®æ”¹äº†æ¨ç†é˜¶æ®µRoPEçš„å®ç°ï¼Œä½¿å¾—$\boldsymbol{q}_i,\boldsymbol{k}_j$çš„å¤¹è§’è½åˆ°åŸæœ¬è®­ç»ƒé˜¶æ®µçš„æœ‰é™é›†åˆä¸­ï¼Œé¿å…é¢å¯¹æ²¡è§è¿‡çš„æ›´å¤§çš„é›†åˆï¼Œè½¬å¤–æ¨ä¸ºå†…æ’ï¼›ReRoPEåˆ™æ›´åŠ å¹²è„†ï¼Œç›´æ¥æˆªæ–­Windowä»¥å¤–çš„ç›¸å¯¹ä½ç½®ï¼Œè¿™ä½¿å¾—æ¨ç†é˜¶æ®µçš„ä½ç½®ç¼–ç éƒ½ä¸ä¼šâ€œé¢ç”Ÿâ€ã€‚è¿™äº›æŠ€å·§ä¸€å®šç¨‹åº¦ä¸Šéƒ½é—´æ¥åœ°éªŒè¯äº†è¿™ä¸ªæ–­è¨€ã€‚</p>
<p>ä»è¿™ä¸ªæ–­è¨€å‡ºå‘ï¼ŒKeyNormçš„é•¿åº¦å¤–æ¨èµ·å› å°±å˜å¾—ç®€å•äº†ã€‚ä¸è®ºæ˜¯åªè¿›è¡ŒKeyNormçš„KNAï¼Œè¿˜æ˜¯QueryNormã€KeyNorméƒ½åšçš„CosAï¼Œå®ƒä»¬éƒ½å°†$\Vert\boldsymbol{k}_j\Vert$ä»Attentionçš„å®šä¹‰ä¸­æ’é™¤æ‰äº†ï¼Œäºæ˜¯ä¸ºäº†æ”¹å˜$j$çš„ç›¸å¯¹é‡è¦æ€§ï¼Œæ¨¡å‹å°±åªæœ‰â€œè°ƒæ•´$\cos(\boldsymbol{q}_i,\boldsymbol{k}_j)$â€è¿™ä¸€ä¸ªé€‰æ‹©ï¼Œè¿™å°†ä¼šä½¿å¾—æ¨¡å‹æ›´åŠ å……åˆ†åœ°è®­ç»ƒå’Œåˆ©ç”¨$\cos(\boldsymbol{q}_i,\boldsymbol{k}_j)$ï¼Œä»è€Œé—´æ¥ä¿ƒè¿›äº†é•¿åº¦å¤–æ¨æ€§ã€‚æ­¤å¤–ï¼Œç¬”è€…ä¹Ÿå®éªŒè¿‡â€œKeyNorm + NoPEâ€çš„ç»„åˆï¼Œä½†å¹¶æ²¡æœ‰å‘ç°é•¿åº¦å¤–æ¨æ€§ï¼Œè¿™è¯´æ˜RoPEä¹Ÿåœ¨KeyNormçš„é•¿åº¦å¤–æ¨ä¸­æ‹…ä»»é‡è¦è§’è‰²ã€‚äº‹å®ä¸Šè¿™ä¹Ÿä¸éš¾ç†è§£ï¼ŒRoPEå¯¹$\boldsymbol{q}_i,\boldsymbol{k}_j$è¿›è¡Œæ—‹è½¬ï¼Œæ›´æœ‰åŠ©äºæ‰©å¤§è®­ç»ƒæœŸé—´$\cos(\boldsymbol{q}_i,\boldsymbol{k}_j)$çš„èŒƒå›´ï¼Œä»è€Œä½¿å¾—$\cos(\boldsymbol{q}_i,\boldsymbol{k}_j)$çš„è®­ç»ƒæ›´ä¸ºå……åˆ†ã€‚</p>
<p>æœ‰æ²¡æœ‰å·¥ä½œå·²ç»å°è¯•è¿‡QueryNormå’ŒKeyNormäº†å‘¢ï¼Ÿæœ‰ã€‚2020å¹´çš„è®ºæ–‡<a href="https://papers.cool/arxiv/2010.04245">ã€ŠQuery-Key Normalization for Transformersã€‹</a>æ›¾å®éªŒè¿‡CosAï¼Œè®ºæ–‡è¿˜æå‡ºäº†ä¸€ä¸ªç±»ä¼¼çš„é•¿åº¦å¯¹æ•°çš„Scaleå› å­ï¼Œä½†æ²¡æœ‰è®¨è®ºåˆ°é•¿åº¦å¤–æ¨é—®é¢˜ã€‚æ­¤å¤–ï¼Œä»Šå¹´åˆGoogleçš„è®ºæ–‡<a href="https://papers.cool/arxiv/2302.05442">ã€ŠScaling Vision Transformers to 22 Billion Parametersã€‹</a>ä¹Ÿåœ¨Queryå’ŒKeyåŠ äº†Normï¼Œä½†åŠ çš„æ˜¯LayerNormï¼ŒLayerNormæˆ–è€…RMSNorméƒ½å¸¦æœ‰å¯å­¦çš„gammaå‚æ•°ï¼Œè¿™ä½¿å¾—Normä¹‹åçš„å‘é‡æ¨¡é•¿æœªå¿…ä¸ºå¸¸æ•°ï¼Œå› æ­¤å¹¶ä¸å¥½è¯´æ˜¯å¦èƒ½è¾¾åˆ°æœ¬æ–‡ä¸€æ ·çš„é•¿åº¦å¤–æ¨æ•ˆæœã€‚</p>
<h2 id="_4">æ–‡ç« å°ç»“</h2>
<p>æœ¬æ–‡ä»‹ç»äº†ç¬”è€…æ„å¤–å‘ç°çš„ä¸€ç§é•¿åº¦å¤–æ¨æ–¹æ¡ˆâ€œKeyNormâ€â€”â€”å¯¹Attentionçš„Keyåºåˆ—è¿›è¡ŒL2å½’ä¸€åŒ–ï¼Œåœ¨è®­ç»ƒé•¿åº¦ä¸Šå–å¾—äº†æ›´å¥½çš„æ•ˆæœï¼Œå¹¶åœ¨é•¿åº¦å¤–æ¨æ–¹é¢è¡¨ç°å‡ºæ˜¾è‘—çš„æå‡ã€‚å®ƒå±äºâ€œäº‹å‰ä¿®æ”¹â€æ–¹æ¡ˆï¼Œè·Ÿå…¶ä»–äº‹å‰ä¿®æ”¹æ–¹æ¡ˆå¦‚ALIBIã€KERPLEç­‰ç›¸æ¯”ï¼Œå®ƒæ²¡æœ‰Localçº¦æŸï¼Œå› æ­¤æ›´æœ‰å¸Œæœ›èƒ½å¤ŸScale Upï¼›ç›¸æ¯”äºNTK-RoPEã€YaRNç­‰â€œäº‹åä¿®æ”¹â€æ–¹æ¡ˆï¼Œå®ƒåœ¨å¤–æ¨çš„æ—¶å€™åˆ™ä¸ä¼šæŸå¤±è®­ç»ƒé•¿åº¦å†…çš„æ€§èƒ½ã€‚</p>
<p><em><strong>è½¬è½½åˆ°è¯·åŒ…æ‹¬æœ¬æ–‡åœ°å€ï¼š</strong><a href="https://spaces.ac.cn/archives/9859">https://spaces.ac.cn/archives/9859</a></em></p>
<p><em><strong>æ›´è¯¦ç»†çš„è½¬è½½äº‹å®œè¯·å‚è€ƒï¼š</strong></em><a href="https://spaces.ac.cn/archives/6508#%E6%96%87%E7%AB%A0%E5%A6%82%E4%BD%95%E8%BD%AC%E8%BD%BD/%E5%BC%95%E7%94%A8" title="ã€Šç§‘å­¦ç©ºé—´FAQã€‹">ã€Šç§‘å­¦ç©ºé—´FAQã€‹</a></p>
<p><strong>å¦‚æœæ‚¨è¿˜æœ‰ä»€ä¹ˆç–‘æƒ‘æˆ–å»ºè®®ï¼Œæ¬¢è¿åœ¨ä¸‹æ–¹è¯„è®ºåŒºç»§ç»­è®¨è®ºã€‚</strong></p>
<p><strong>å¦‚æœæ‚¨è§‰å¾—æœ¬æ–‡è¿˜ä¸é”™ï¼Œæ¬¢è¿åˆ†äº«/æ‰“èµæœ¬æ–‡ã€‚æ‰“èµå¹¶éè¦ä»ä¸­è·å¾—æ”¶ç›Šï¼Œè€Œæ˜¯å¸Œæœ›çŸ¥é“ç§‘å­¦ç©ºé—´è·å¾—äº†å¤šå°‘è¯»è€…çš„çœŸå¿ƒå…³æ³¨ã€‚å½“ç„¶ï¼Œå¦‚æœä½ æ— è§†å®ƒï¼Œä¹Ÿä¸ä¼šå½±å“ä½ çš„é˜…è¯»ã€‚å†æ¬¡è¡¨ç¤ºæ¬¢è¿å’Œæ„Ÿè°¢ï¼</strong></p>
<p>æ‰“èµ</p>
<p><img alt="ç§‘å­¦ç©ºé—´" src="https://spaces.ac.cn/usr/themes/geekg/payment/wx.png" /></p>
<p>å¾®ä¿¡æ‰“èµ</p>
<p><img alt="ç§‘å­¦ç©ºé—´" src="https://spaces.ac.cn/usr/themes/geekg/payment/zfb.png" /></p>
<p>æ”¯ä»˜å®æ‰“èµ</p>
<p>å› ä¸ºç½‘ç«™åå°å¯¹æ‰“èµå¹¶æ— è®°å½•ï¼Œå› æ­¤æ¬¢è¿åœ¨æ‰“èµæ—¶å€™å¤‡æ³¨ç•™è¨€ã€‚ä½ è¿˜å¯ä»¥<a href="http://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&amp;email=tN7d1drY3drrx8H0xcWa19vZ"><strong>ç‚¹å‡»è¿™é‡Œ</strong></a>æˆ–åœ¨ä¸‹æ–¹è¯„è®ºåŒºç•™è¨€æ¥å‘ŠçŸ¥ä½ çš„å»ºè®®æˆ–éœ€æ±‚ã€‚</p>
<p><strong>å¦‚æœæ‚¨éœ€è¦å¼•ç”¨æœ¬æ–‡ï¼Œè¯·å‚è€ƒï¼š</strong></p>
<p>è‹å‰‘æ—. (Nov. 20, 2023). ã€ŠTransformerå‡çº§ä¹‹è·¯ï¼š15ã€Keyå½’ä¸€åŒ–åŠ©åŠ›é•¿åº¦å¤–æ¨ ã€‹[Blog post]. Retrieved from <a href="https://spaces.ac.cn/archives/9859">https://spaces.ac.cn/archives/9859</a></p>
<p>@online{kexuefm-9859,<br />
title={Transformerå‡çº§ä¹‹è·¯ï¼š15ã€Keyå½’ä¸€åŒ–åŠ©åŠ›é•¿åº¦å¤–æ¨},<br />
author={è‹å‰‘æ—},<br />
year={2023},<br />
month={Nov},<br />
url={\url{https://spaces.ac.cn/archives/9859}},<br />
} </p>
<hr />
<h2 id="_5">å…¬å¼æ¨å¯¼ä¸æ³¨é‡Š</h2>
<h3 id="1-key">1. Keyå½’ä¸€åŒ–çš„æ•°å­¦åŸºç¡€</h3>
<p><strong>å®šä¹‰1.1ï¼šæ ‡å‡†Scaled Dot-Product Attention</strong></p>
<p>æ ‡å‡†çš„æ³¨æ„åŠ›æœºåˆ¶å¯ä»¥è¡¨ç¤ºä¸ºï¼š
$$
\boldsymbol{o}_i = \frac{\sum_{j=1}^i \exp\left(\frac{\boldsymbol{q}_i \cdot \boldsymbol{k}_j}{\sqrt{d}}\right) \boldsymbol{v}_j}{\sum_{j=1}^i \exp\left(\frac{\boldsymbol{q}_i \cdot \boldsymbol{k}_j}{\sqrt{d}}\right)}
$$</p>
<p>å…¶ä¸­ï¼š
- $\boldsymbol{q}_i, \boldsymbol{k}_j \in \mathbb{R}^d$ åˆ†åˆ«æ˜¯Queryå’ŒKeyå‘é‡
- $d$ æ˜¯å‘é‡ç»´åº¦
- $\boldsymbol{v}_j \in \mathbb{R}^d$ æ˜¯Valueå‘é‡
- $i$ è¡¨ç¤ºå½“å‰ä½ç½®ï¼ˆCausal Maskï¼‰</p>
<p><strong>æ¨å¯¼1.1ï¼šScaleå› å­$\frac{1}{\sqrt{d}}$çš„æ¥æº</strong></p>
<p>å‡è®¾$\boldsymbol{q}_i, \boldsymbol{k}_j$çš„æ¯ä¸ªåˆ†é‡ç‹¬ç«‹åŒåˆ†å¸ƒäº$\mathcal{N}(0,1)$ï¼Œåˆ™ï¼š
$$
\boldsymbol{q}_i \cdot \boldsymbol{k}_j = \sum_{\ell=1}^d q_{i,\ell} k_{j,\ell}
$$</p>
<p>ç”±äº$q_{i,\ell} \sim \mathcal{N}(0,1)$ä¸”$k_{j,\ell} \sim \mathcal{N}(0,1)$æ˜¯ç‹¬ç«‹çš„ï¼Œæˆ‘ä»¬æœ‰ï¼š
$$
\mathbb{E}[q_{i,\ell} k_{j,\ell}] = \mathbb{E}[q_{i,\ell}] \mathbb{E}[k_{j,\ell}] = 0 \cdot 0 = 0
$$</p>
<p>æ–¹å·®ä¸ºï¼š
$$
\text{Var}[q_{i,\ell} k_{j,\ell}] = \mathbb{E}[(q_{i,\ell} k_{j,\ell})^2] - (\mathbb{E}[q_{i,\ell} k_{j,\ell}])^2 = \mathbb{E}[q_{i,\ell}^2]\mathbb{E}[k_{j,\ell}^2] = 1 \cdot 1 = 1
$$</p>
<p>å› æ­¤å†…ç§¯çš„æ–¹å·®ä¸ºï¼š
$$
\text{Var}\left[\sum_{\ell=1}^d q_{i,\ell} k_{j,\ell}\right] = \sum_{\ell=1}^d \text{Var}[q_{i,\ell} k_{j,\ell}] = d
$$</p>
<p>æ•…ï¼š
$$
\boldsymbol{q}_i \cdot \boldsymbol{k}_j \sim \mathcal{N}(0, d)
$$</p>
<p>ä¸ºäº†å½’ä¸€åŒ–æ–¹å·®åˆ°1ï¼Œæˆ‘ä»¬é™¤ä»¥$\sqrt{d}$ï¼š
$$
\frac{\boldsymbol{q}_i \cdot \boldsymbol{k}_j}{\sqrt{d}} \sim \mathcal{N}(0, 1)
$$</p>
<h3 id="2">2. å‘é‡æ¨¡é•¿çš„ç»Ÿè®¡æ€§è´¨</h3>
<p><strong>å®šç†2.1ï¼šé«˜ç»´éšæœºå‘é‡çš„æ¨¡é•¿</strong></p>
<p>å¯¹äº$\boldsymbol{x} \in \mathbb{R}^d$ï¼Œå…¶ä¸­$x_i \stackrel{i.i.d.}{\sim} \mathcal{N}(0,1)$ï¼Œæœ‰ï¼š
$$
\|\boldsymbol{x}\|^2 = \sum_{i=1}^d x_i^2
$$</p>
<p>ç”±äº$x_i^2 \sim \chi^2(1)$ï¼ˆå¡æ–¹åˆ†å¸ƒï¼‰ï¼Œæ‰€ä»¥ï¼š
$$
\|\boldsymbol{x}\|^2 \sim \chi^2(d)
$$</p>
<p><strong>æ¨å¯¼2.1ï¼šæ¨¡é•¿çš„æœŸæœ›</strong></p>
<p>å¡æ–¹åˆ†å¸ƒ$\chi^2(d)$çš„æœŸæœ›å’Œæ–¹å·®åˆ†åˆ«ä¸º$d$å’Œ$2d$ï¼Œå› æ­¤ï¼š
$$
\mathbb{E}[\|\boldsymbol{x}\|^2] = d
$$</p>
<p>åˆ©ç”¨Jensenä¸ç­‰å¼ï¼ˆç”±äºå¹³æ–¹æ ¹æ˜¯å‡¹å‡½æ•°ï¼‰ï¼š
$$
\mathbb{E}[\|\boldsymbol{x}\|] \leq \sqrt{\mathbb{E}[\|\boldsymbol{x}\|^2]} = \sqrt{d}
$$</p>
<p>å®é™…ä¸Šï¼Œå¯¹äºå¡æ–¹åˆ†å¸ƒï¼Œæˆ‘ä»¬æœ‰æ›´ç²¾ç¡®çš„ç»“æœï¼š
$$
\mathbb{E}[\|\boldsymbol{x}\|] = \sqrt{2} \frac{\Gamma((d+1)/2)}{\Gamma(d/2)} \approx \sqrt{d} - \frac{1}{4\sqrt{d}} + O(d^{-3/2})
$$</p>
<p>å½“$d$è¾ƒå¤§æ—¶ï¼Œæˆ‘ä»¬æœ‰è¿‘ä¼¼ï¼š
$$
\|\boldsymbol{x}\| \approx \sqrt{d}
$$</p>
<p><strong>æ¨å¯¼2.2ï¼šé›†ä¸­ä¸ç­‰å¼</strong></p>
<p>åˆ©ç”¨å¡æ–¹åˆ†å¸ƒçš„é›†ä¸­æ€§ï¼Œå¯¹äºä»»æ„$\epsilon &gt; 0$ï¼š
$$
\mathbb{P}\left(\left|\|\boldsymbol{x}\|^2 - d\right| > \epsilon d\right) \leq 2\exp\left(-\frac{d\epsilon^2}{8}\right)
$$</p>
<p>è¿™è¯´æ˜å½“ç»´åº¦$d$è¾ƒå¤§æ—¶ï¼Œ$|\boldsymbol{x}|^2$é«˜æ¦‚ç‡é›†ä¸­åœ¨$d$é™„è¿‘ï¼Œå› æ­¤ï¼š
$$
\mathbb{P}\left(\left|\|\boldsymbol{x}\| - \sqrt{d}\right| > \frac{\epsilon\sqrt{d}}{2}\right) \to 0 \quad \text{å½“} \quad d \to \infty
$$</p>
<h3 id="3-key-normalization">3. Key Normalizationçš„æ•°å­¦å®šä¹‰</h3>
<p><strong>å®šä¹‰3.1ï¼šKey Normalized Attention (KNA)</strong></p>
<p>Keyå½’ä¸€åŒ–æ³¨æ„åŠ›å®šä¹‰ä¸ºï¼š
$$
\boldsymbol{o}_i = \frac{\sum_{j=1}^i \exp\left(\boldsymbol{q}_i \cdot \tilde{\boldsymbol{k}}_j\right) \boldsymbol{v}_j}{\sum_{j=1}^i \exp\left(\boldsymbol{q}_i \cdot \tilde{\boldsymbol{k}}_j\right)}
$$</p>
<p>å…¶ä¸­å½’ä¸€åŒ–çš„Keyå‘é‡ä¸ºï¼š
$$
\tilde{\boldsymbol{k}}_j = \frac{\boldsymbol{k}_j}{\|\boldsymbol{k}_j\|}
$$</p>
<p>æ»¡è¶³$|\tilde{\boldsymbol{k}}_j| = 1$ã€‚</p>
<p><strong>å®šç†3.1ï¼šKNAä¸æ ‡å‡†Attentionçš„åˆå§‹ç­‰ä»·æ€§</strong></p>
<p>åœ¨è®­ç»ƒåˆæœŸï¼Œå½“$\boldsymbol{q}_i, \boldsymbol{k}_j$çš„åˆ†é‡ç‹¬ç«‹åŒåˆ†å¸ƒäº$\mathcal{N}(0,1)$æ—¶ï¼ŒKNAè¿‘ä¼¼ç­‰ä»·äºæ ‡å‡†çš„Scaled Attentionã€‚</p>
<p><strong>è¯æ˜ï¼š</strong></p>
<p>ç”±å‰è¿°åˆ†æï¼Œå½“$\boldsymbol{k}_j$çš„åˆ†é‡ç‹¬ç«‹åŒåˆ†å¸ƒäº$\mathcal{N}(0,1)$æ—¶ï¼š
$$
\|\boldsymbol{k}_j\| \approx \sqrt{d}
$$</p>
<p>å› æ­¤ï¼š
$$
\tilde{\boldsymbol{k}}_j = \frac{\boldsymbol{k}_j}{\|\boldsymbol{k}_j\|} \approx \frac{\boldsymbol{k}_j}{\sqrt{d}}
$$</p>
<p>ä»£å…¥KNAçš„å®šä¹‰ï¼š
$$
\boldsymbol{q}_i \cdot \tilde{\boldsymbol{k}}_j \approx \boldsymbol{q}_i \cdot \frac{\boldsymbol{k}_j}{\sqrt{d}} = \frac{\boldsymbol{q}_i \cdot \boldsymbol{k}_j}{\sqrt{d}}
$$</p>
<p>è¿™æ°å¥½æ˜¯æ ‡å‡†Attentionä¸­çš„å½¢å¼ã€‚$\square$</p>
<h3 id="4-query-key">4. Query-Keyå†…ç§¯çš„å‡ ä½•åˆ†è§£</h3>
<p><strong>å®šç†4.1ï¼šå†…ç§¯çš„å‡ ä½•åˆ†è§£</strong></p>
<p>ä»»æ„ä¸¤ä¸ªå‘é‡$\boldsymbol{q}_i, \boldsymbol{k}_j \in \mathbb{R}^d$çš„å†…ç§¯å¯ä»¥åˆ†è§£ä¸ºï¼š
$$
\boldsymbol{q}_i \cdot \boldsymbol{k}_j = \|\boldsymbol{q}_i\| \|\boldsymbol{k}_j\| \cos(\boldsymbol{q}_i, \boldsymbol{k}_j)
$$</p>
<p>å…¶ä¸­$\cos(\boldsymbol{q}_i, \boldsymbol{k}_j)$æ˜¯ä¸¤å‘é‡å¤¹è§’çš„ä½™å¼¦å€¼ï¼š
$$
\cos(\boldsymbol{q}_i, \boldsymbol{k}_j) = \frac{\boldsymbol{q}_i \cdot \boldsymbol{k}_j}{\|\boldsymbol{q}_i\| \|\boldsymbol{k}_j\|}
$$</p>
<p><strong>æ¨å¯¼4.1ï¼šä¸‰ä¸ªå› å­çš„ä½œç”¨åˆ†æ</strong></p>
<p>åœ¨æ ‡å‡†Attentionä¸­ï¼Œæ³¨æ„åŠ›åˆ†æ•°ä¸ºï¼š
$$
s(j|i) = \frac{\boldsymbol{q}_i \cdot \boldsymbol{k}_j}{\sqrt{d}} = \frac{\|\boldsymbol{q}_i\| \|\boldsymbol{k}_j\| \cos(\boldsymbol{q}_i, \boldsymbol{k}_j)}{\sqrt{d}}
$$</p>
<p>ä¸‰ä¸ªå› å­çš„ä½œç”¨ï¼š</p>
<ol>
<li>
<p><strong>Queryæ¨¡é•¿$|\boldsymbol{q}_i|$</strong>ï¼šåªä¾èµ–äºä½ç½®$i$ï¼Œä¸æ”¹å˜æ³¨æ„åŠ›çš„ç›¸å¯¹å¤§å°ï¼Œåªå½±å“æ³¨æ„åŠ›åˆ†å¸ƒçš„ç¨€ç–ç¨‹åº¦ï¼ˆæ¸©åº¦ï¼‰ã€‚</p>
</li>
<li>
<p><strong>Keyæ¨¡é•¿$|\boldsymbol{k}_j|$</strong>ï¼šèƒ½å¤Ÿæ”¹å˜ä½ç½®$j$çš„ç»å¯¹é‡è¦æ€§ï¼Œä¸æ¶‰åŠ$i,j$çš„äº¤äº’ã€‚</p>
</li>
<li>
<p><strong>ä½™å¼¦$\cos(\boldsymbol{q}_i, \boldsymbol{k}_j)$</strong>ï¼šè¡¨è¾¾$i,j$ä¹‹é—´çš„çœŸæ­£äº¤äº’ï¼Œå–å€¼èŒƒå›´$[-1,1]$ï¼Œæ˜¯è‡ªç”±åº¦æœ€å¤§çš„ä¸€é¡¹ã€‚</p>
</li>
</ol>
<p><strong>æ¨å¯¼4.2ï¼šæ³¨æ„åŠ›æƒé‡çš„è¯¦ç»†å±•å¼€</strong></p>
<p>æ³¨æ„åŠ›æƒé‡ä¸ºï¼š
$$
\alpha_{ij} = \frac{\exp\left(\frac{s(j|i)}{\sqrt{d}}\right)}{\sum_{k=1}^i \exp\left(\frac{s(k|i)}{\sqrt{d}}\right)}
$$</p>
<p>ä»£å…¥å‡ ä½•åˆ†è§£ï¼š
$$
\alpha_{ij} = \frac{\exp\left(\frac{\|\boldsymbol{q}_i\| \|\boldsymbol{k}_j\| \cos(\boldsymbol{q}_i, \boldsymbol{k}_j)}{\sqrt{d}}\right)}{\sum_{k=1}^i \exp\left(\frac{\|\boldsymbol{q}_i\| \|\boldsymbol{k}_k\| \cos(\boldsymbol{q}_i, \boldsymbol{k}_k)}{\sqrt{d}}\right)}
$$</p>
<p>ç”±äº$|\boldsymbol{q}_i|$åœ¨åˆ†å­åˆ†æ¯ä¸­éƒ½æœ‰ï¼Œå¯ä»¥æå–å‡ºæ¥ï¼š
$$
\alpha_{ij} = \frac{\exp\left(\frac{\|\boldsymbol{k}_j\| \cos(\boldsymbol{q}_i, \boldsymbol{k}_j)}{\sqrt{d}/\|\boldsymbol{q}_i\|}\right)}{\sum_{k=1}^i \exp\left(\frac{\|\boldsymbol{k}_k\| \cos(\boldsymbol{q}_i, \boldsymbol{k}_k)}{\sqrt{d}/\|\boldsymbol{q}_i\|}\right)}
$$</p>
<p>è¿™è¡¨æ˜$|\boldsymbol{q}_i|$èµ·åˆ°æ¸©åº¦å‚æ•°çš„ä½œç”¨ã€‚</p>
<h3 id="5-key">5. Keyå½’ä¸€åŒ–å¯¹æ³¨æ„åŠ›åˆ†å¸ƒçš„å½±å“</h3>
<p><strong>å®šç†5.1ï¼šKNAæ¶ˆé™¤äº†Keyæ¨¡é•¿çš„å½±å“</strong></p>
<p>åœ¨Keyå½’ä¸€åŒ–åï¼Œæ³¨æ„åŠ›åˆ†æ•°å˜ä¸ºï¼š
$$
s_{KNA}(j|i) = \boldsymbol{q}_i \cdot \tilde{\boldsymbol{k}}_j = \|\boldsymbol{q}_i\| \cos(\boldsymbol{q}_i, \boldsymbol{k}_j)
$$</p>
<p><strong>æ¨å¯¼5.1ï¼šKNAçš„æ³¨æ„åŠ›æƒé‡</strong></p>
<p>$$
\alpha_{ij}^{KNA} = \frac{\exp\left(\|\boldsymbol{q}_i\| \cos(\boldsymbol{q}_i, \boldsymbol{k}_j)\right)}{\sum_{k=1}^i \exp\left(\|\boldsymbol{q}_i\| \cos(\boldsymbol{q}_i, \boldsymbol{k}_k)\right)}
$$</p>
<p>å¯¹æ¯”æ ‡å‡†Attentionï¼ŒKNAæœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š</p>
<ol>
<li>
<p><strong>æ¶ˆé™¤äº†Keyæ¨¡é•¿çš„å½±å“</strong>ï¼šæ‰€æœ‰Keyçš„æ¨¡é•¿éƒ½è¢«å½’ä¸€åŒ–ä¸º1ï¼Œæ¨¡å‹æ— æ³•é€šè¿‡å¢å¤§$|\boldsymbol{k}_j|$æ¥æé«˜ä½ç½®$j$çš„é‡è¦æ€§ã€‚</p>
</li>
<li>
<p><strong>å¼ºåˆ¶æ¨¡å‹ä¼˜åŒ–ä½™å¼¦ç›¸ä¼¼åº¦</strong>ï¼šæ¨¡å‹åªèƒ½é€šè¿‡è°ƒæ•´$\cos(\boldsymbol{q}_i, \boldsymbol{k}_j)$ï¼ˆå³å‘é‡æ–¹å‘ï¼‰æ¥æ”¹å˜æ³¨æ„åŠ›åˆ†å¸ƒã€‚</p>
</li>
<li>
<p><strong>ä¿ç•™äº†Queryæ¨¡é•¿çš„æ¸©åº¦æ•ˆåº”</strong>ï¼š$|\boldsymbol{q}_i|$ä»ç„¶å¯ä»¥æ§åˆ¶æ³¨æ„åŠ›åˆ†å¸ƒçš„å°–é”ç¨‹åº¦ã€‚</p>
</li>
</ol>
<p><strong>å®šç†5.2ï¼šä½™å¼¦ç›¸ä¼¼åº¦çš„æœ‰ç•Œæ€§</strong></p>
<p>ç”±äº$\cos(\boldsymbol{q}_i, \boldsymbol{k}_j) \in [-1, 1]$ï¼ŒKNAçš„æ³¨æ„åŠ›åˆ†æ•°æ»¡è¶³ï¼š
$$
-\|\boldsymbol{q}_i\| \leq s_{KNA}(j|i) \leq \|\boldsymbol{q}_i\|
$$</p>
<p>è¿™ä¸ªæœ‰ç•Œæ€§ä¿è¯äº†æ³¨æ„åŠ›åˆ†æ•°ä¸ä¼šè¿‡å¤§ï¼Œæœ‰åŠ©äºè®­ç»ƒç¨³å®šæ€§ã€‚</p>
<h3 id="6">6. ç»´åº¦ç¾éš¾ä¸è§’åº¦è°ƒæ•´çš„å›°éš¾</h3>
<p><strong>å®šç†6.1ï¼šé«˜ç»´ç©ºé—´ä¸­çš„è§’åº¦åˆ†å¸ƒ</strong></p>
<p>åœ¨$d$ç»´ç©ºé—´ä¸­ï¼Œéšæœºå‘é‡ä¹‹é—´çš„å¤¹è§’ä½™å¼¦å€¼è¶‹å‘äºé›†ä¸­åœ¨0é™„è¿‘ã€‚</p>
<p><strong>æ¨å¯¼6.1ï¼šéšæœºå‘é‡å¤¹è§’çš„åˆ†å¸ƒ</strong></p>
<p>è®¾$\boldsymbol{u}, \boldsymbol{v} \in \mathbb{R}^d$ä¸ºä¸¤ä¸ªç‹¬ç«‹çš„éšæœºå‘é‡ï¼Œåˆ†é‡ç‹¬ç«‹åŒåˆ†å¸ƒäº$\mathcal{N}(0,1)$ã€‚å®šä¹‰ï¼š
$$
\rho = \cos(\boldsymbol{u}, \boldsymbol{v}) = \frac{\boldsymbol{u} \cdot \boldsymbol{v}}{\|\boldsymbol{u}\| \|\boldsymbol{v}\|}
$$</p>
<p>ç”±äº$\boldsymbol{u} \cdot \boldsymbol{v} = \sum_{i=1}^d u_i v_i$ï¼Œå…¶ä¸­$u_i v_i$ç‹¬ç«‹ï¼Œæˆ‘ä»¬æœ‰ï¼š
$$
\mathbb{E}[\boldsymbol{u} \cdot \boldsymbol{v}] = \sum_{i=1}^d \mathbb{E}[u_i v_i] = 0
$$
$$
\text{Var}[\boldsymbol{u} \cdot \boldsymbol{v}] = \sum_{i=1}^d \text{Var}[u_i v_i] = d
$$</p>
<p>å› æ­¤$\boldsymbol{u} \cdot \boldsymbol{v} \sim \mathcal{N}(0, d)$ã€‚åŒæ—¶ï¼š
$$
\|\boldsymbol{u}\|^2 \sim \chi^2(d), \quad \|\boldsymbol{v}\|^2 \sim \chi^2(d)
$$</p>
<p>ç”±å¤§æ•°å®šå¾‹ï¼š
$$
\frac{\|\boldsymbol{u}\|^2}{d} \to 1, \quad \frac{\|\boldsymbol{v}\|^2}{d} \to 1 \quad \text{å½“} \quad d \to \infty
$$</p>
<p>å› æ­¤ï¼š
$$
\rho = \frac{\boldsymbol{u} \cdot \boldsymbol{v}}{\|\boldsymbol{u}\| \|\boldsymbol{v}\|} \approx \frac{\boldsymbol{u} \cdot \boldsymbol{v}}{d}
$$</p>
<p>æ ‡å‡†åŒ–åï¼š
$$
\sqrt{d} \cdot \rho \approx \frac{\boldsymbol{u} \cdot \boldsymbol{v}}{\sqrt{d}} \sim \mathcal{N}(0, 1)
$$</p>
<p>å³ï¼š
$$
\rho \sim \mathcal{N}\left(0, \frac{1}{d}\right)
$$</p>
<p>è¿™è¯´æ˜éšç€ç»´åº¦$d$å¢å¤§ï¼Œä½™å¼¦ç›¸ä¼¼åº¦é›†ä¸­åœ¨0é™„è¿‘ï¼Œæ–¹å·®ä¸º$O(1/d)$ã€‚</p>
<p><strong>æ¨å¯¼6.2ï¼šè§’åº¦è°ƒæ•´çš„æ¢¯åº¦åˆ†æ</strong></p>
<p>è¦æ”¹å˜ä¸¤ä¸ªå‘é‡çš„ä½™å¼¦ç›¸ä¼¼åº¦ï¼Œéœ€è¦è°ƒæ•´å‘é‡çš„æ–¹å‘ã€‚è®¾æˆ‘ä»¬è¦é€šè¿‡æ¢¯åº¦ä¸‹é™ä¼˜åŒ–$\boldsymbol{k}_j$ä½¿å¾—$\cos(\boldsymbol{q}_i, \boldsymbol{k}_j)$å¢å¤§ã€‚æŸå¤±å‡½æ•°ä¸ºï¼š
$$
\mathcal{L} = -\cos(\boldsymbol{q}_i, \boldsymbol{k}_j) = -\frac{\boldsymbol{q}_i \cdot \boldsymbol{k}_j}{\|\boldsymbol{q}_i\| \|\boldsymbol{k}_j\|}
$$</p>
<p>æ¢¯åº¦ä¸ºï¼š
$$
\frac{\partial \mathcal{L}}{\partial \boldsymbol{k}_j} = -\frac{\boldsymbol{q}_i}{\|\boldsymbol{q}_i\| \|\boldsymbol{k}_j\|} + \frac{(\boldsymbol{q}_i \cdot \boldsymbol{k}_j) \boldsymbol{k}_j}{\|\boldsymbol{q}_i\| \|\boldsymbol{k}_j\|^3}
$$</p>
<p>ç®€åŒ–ä¸ºï¼š
$$
\frac{\partial \mathcal{L}}{\partial \boldsymbol{k}_j} = -\frac{1}{\|\boldsymbol{q}_i\| \|\boldsymbol{k}_j\|}\left(\boldsymbol{q}_i - \frac{\boldsymbol{q}_i \cdot \boldsymbol{k}_j}{\|\boldsymbol{k}_j\|^2} \boldsymbol{k}_j\right)
$$</p>
<p>è¿™æ˜¯$\boldsymbol{q}_i$åœ¨å‚ç›´äº$\boldsymbol{k}_j$æ–¹å‘ä¸Šçš„åˆ†é‡ï¼ˆå½’ä¸€åŒ–åï¼‰ã€‚</p>
<p>å¦ä¸€æ–¹é¢ï¼Œå¦‚æœç›´æ¥ä¼˜åŒ–æ¨¡é•¿ï¼š
$$
\mathcal{L}' = -\|\boldsymbol{k}_j\|
$$</p>
<p>æ¢¯åº¦ä¸ºï¼š
$$
\frac{\partial \mathcal{L}'}{\partial \boldsymbol{k}_j} = -\frac{\boldsymbol{k}_j}{\|\boldsymbol{k}_j\|}
$$</p>
<p>åœ¨é«˜ç»´ç©ºé—´ä¸­ï¼Œæ”¹å˜å‘é‡æ–¹å‘ï¼ˆè°ƒæ•´ä½™å¼¦ï¼‰æ¯”æ”¹å˜å‘é‡æ¨¡é•¿éœ€è¦æ›´ç²¾ç»†çš„åè°ƒï¼Œå› æ­¤æ¨¡å‹å€¾å‘äºä¼˜å…ˆè°ƒæ•´æ¨¡é•¿ã€‚</p>
<h3 id="7">7. é•¿åº¦å¤–æ¨ä¸ä½ç½®ç¼–ç çš„è®­ç»ƒå……åˆ†æ€§</h3>
<p><strong>å®šä¹‰7.1ï¼šä½ç½®ç¼–ç çš„è®­ç»ƒé›†</strong></p>
<p>è®¾è®­ç»ƒé•¿åº¦ä¸º$L_{train}$ï¼Œåˆ™è®­ç»ƒè¿‡ç¨‹ä¸­å‡ºç°çš„ç›¸å¯¹ä½ç½®é›†åˆä¸ºï¼š
$$
\mathcal{P}_{train} = \{m - n : 0 \leq m, n \leq L_{train}, m \geq n\} = \{0, 1, 2, \ldots, L_{train}\}
$$</p>
<p>åœ¨é•¿åº¦å¤–æ¨åˆ°$L_{test} &gt; L_{train}$æ—¶ï¼Œéœ€è¦é¢„æµ‹çš„ç›¸å¯¹ä½ç½®é›†åˆä¸ºï¼š
$$
\mathcal{P}_{test} = \{0, 1, 2, \ldots, L_{test}\}
$$</p>
<p>æ˜¾ç„¶$\mathcal{P}<em test="test">{train} \subset \mathcal{P}</em>}$ï¼Œä¸”$\mathcal{P<em train="train">{test} \setminus \mathcal{P}</em> \neq \emptyset$ã€‚</p>
<p><strong>å‡è®¾7.1ï¼šä½™å¼¦è®­ç»ƒå……åˆ†æ€§å‡è®¾</strong></p>
<p>æ¨¡å‹èƒ½å¤ŸæˆåŠŸè¿›è¡Œé•¿åº¦å¤–æ¨ï¼Œå½“ä¸”ä»…å½“$\cos(\boldsymbol{q}_i, \boldsymbol{k}_j)$åœ¨è®­ç»ƒé˜¶æ®µå¾—åˆ°å……åˆ†è®­ç»ƒï¼Œä½¿å¾—å…¶å­¦åˆ°çš„æ¨¡å¼èƒ½å¤Ÿæ³›åŒ–åˆ°æ–°çš„ç›¸å¯¹ä½ç½®ã€‚</p>
<p><strong>æ¨å¯¼7.1ï¼šæ ‡å‡†Attentionä¸­ä½™å¼¦è®­ç»ƒä¸è¶³çš„åŸå› </strong></p>
<p>åœ¨æ ‡å‡†Attentionä¸­ï¼Œä¸ºäº†æé«˜ä½ç½®$j$ç›¸å¯¹äºä½ç½®$i$çš„æ³¨æ„åŠ›æƒé‡ï¼Œæ¨¡å‹æœ‰ä¸¤ä¸ªé€‰æ‹©ï¼š</p>
<ol>
<li><strong>å¢å¤§$|\boldsymbol{k}_j|$</strong>ï¼šè¿™ä¸éœ€è¦æ”¹å˜å‘é‡æ–¹å‘ï¼Œç›¸å¯¹ç®€å•ã€‚</li>
<li><strong>å¢å¤§$\cos(\boldsymbol{q}_i, \boldsymbol{k}_j)$</strong>ï¼šè¿™éœ€è¦ç²¾ç»†è°ƒæ•´å‘é‡æ–¹å‘ï¼Œåœ¨é«˜ç»´ç©ºé—´ä¸­è¾ƒå›°éš¾ã€‚</li>
</ol>
<p>ç”±äºè·¯å¾„1æ›´å®¹æ˜“ï¼Œæ¨¡å‹ä¼šä¼˜å…ˆé€‰æ‹©è°ƒæ•´$|\boldsymbol{k}_j|$ï¼Œå¯¼è‡´ï¼š
- $|\boldsymbol{k}_j|$å……åˆ†è®­ç»ƒï¼Œä½†å®ƒç¼–ç çš„æ˜¯ç»å¯¹ä½ç½®ä¿¡æ¯
- $\cos(\boldsymbol{q}_i, \boldsymbol{k}_j)$è®­ç»ƒä¸è¶³ï¼Œä½†å®ƒæ‰æ˜¯çœŸæ­£ç¼–ç ç›¸å¯¹ä½ç½®çš„å…³é”®</p>
<p><strong>æ¨å¯¼7.2ï¼šKNAå¼ºåˆ¶ä½™å¼¦å……åˆ†è®­ç»ƒ</strong></p>
<p>åœ¨KNAä¸­ï¼Œç”±äº$|\tilde{\boldsymbol{k}}_j| = 1$æ’å®šï¼Œæ¨¡å‹æ— æ³•é€šè¿‡è°ƒæ•´Keyæ¨¡é•¿æ¥æ”¹å˜æ³¨æ„åŠ›ã€‚å› æ­¤ï¼š
$$
\text{å”¯ä¸€çš„ä¼˜åŒ–è·¯å¾„ï¼š} \quad \max_{\boldsymbol{k}_j} \cos(\boldsymbol{q}_i, \boldsymbol{k}_j)
$$</p>
<p>è¿™å¼ºåˆ¶æ¨¡å‹å……åˆ†è®­ç»ƒä½™å¼¦ç›¸ä¼¼åº¦ï¼Œä½¿å¾—ä½ç½®ä¿¡æ¯æ›´å¤šåœ°ç¼–ç åœ¨å‘é‡æ–¹å‘è€Œéæ¨¡é•¿ä¸­ã€‚</p>
<h3 id="8-ropekey">8. RoPEä¸Keyå½’ä¸€åŒ–çš„ååŒä½œç”¨</h3>
<p><strong>å®šç†8.1ï¼šRoPEçš„æ—‹è½¬æ€§è´¨</strong></p>
<p>RoPEé€šè¿‡æ—‹è½¬çŸ©é˜µ$\boldsymbol{\mathcal{R}}_m$å¯¹Queryå’ŒKeyè¿›è¡Œå˜æ¢ï¼š
$$
\tilde{\boldsymbol{q}}_m = \boldsymbol{\mathcal{R}}_m \boldsymbol{q}_m, \quad \tilde{\boldsymbol{k}}_n = \boldsymbol{\mathcal{R}}_n \boldsymbol{k}_n
$$</p>
<p>å…¶ä¸­æ—‹è½¬çŸ©é˜µä¿æŒå‘é‡æ¨¡é•¿ä¸å˜ï¼š
$$
\|\boldsymbol{\mathcal{R}}_m \boldsymbol{q}_m\| = \|\boldsymbol{q}_m\|, \quad \|\boldsymbol{\mathcal{R}}_n \boldsymbol{k}_n\| = \|\boldsymbol{k}_n\|
$$</p>
<p>ä¸”æ»¡è¶³ç›¸å¯¹ä½ç½®æ€§è´¨ï¼š
$$
\tilde{\boldsymbol{q}}_m \cdot \tilde{\boldsymbol{k}}_n = \boldsymbol{q}_m^T \boldsymbol{\mathcal{R}}_m^T \boldsymbol{\mathcal{R}}_n \boldsymbol{k}_n = \boldsymbol{q}_m^T \boldsymbol{\mathcal{R}}_{n-m} \boldsymbol{k}_n
$$</p>
<p><strong>æ¨å¯¼8.1ï¼šRoPEå¢åŠ è§’åº¦å¤šæ ·æ€§</strong></p>
<p>å¯¹äºäºŒç»´æ—‹è½¬çŸ©é˜µï¼š
$$
\boldsymbol{\mathcal{R}}_m = \begin{pmatrix} \cos(m\theta) & -\sin(m\theta) \\ \sin(m\theta) & \cos(m\theta) \end{pmatrix}
$$</p>
<p>ç›¸å¯¹æ—‹è½¬ä¸ºï¼š
$$
\boldsymbol{\mathcal{R}}_{n-m} = \begin{pmatrix} \cos((n-m)\theta) & -\sin((n-m)\theta) \\ \sin((n-m)\theta) & \cos((n-m)\theta) \end{pmatrix}
$$</p>
<p>è¿™ä½¿å¾—$\boldsymbol{q}_m$å’Œ$\boldsymbol{k}_n$ä¹‹é—´çš„å¤¹è§’å˜ä¸ºï¼š
$$
\cos(\tilde{\boldsymbol{q}}_m, \tilde{\boldsymbol{k}}_n) = \cos(\boldsymbol{q}_m, \boldsymbol{\mathcal{R}}_{n-m} \boldsymbol{k}_n)
$$</p>
<p>é€šè¿‡ä¸åŒçš„ç›¸å¯¹ä½ç½®$n-m$ï¼Œæ—‹è½¬è§’åº¦$(n-m)\theta$ä¼šéå†$[0, 2\pi)$çš„å¤šä¸ªå€¼ï¼ˆå½“$\theta$é€‰æ‹©åˆé€‚æ—¶ï¼‰ï¼Œè¿™æ˜¾è‘—å¢åŠ äº†ä¸åŒä½ç½®å¯¹ä¹‹é—´è§’åº¦çš„å¤šæ ·æ€§ã€‚</p>
<p><strong>æ¨å¯¼8.2ï¼šè§’åº¦è¦†ç›–ç‡åˆ†æ</strong></p>
<p>è®¾è®­ç»ƒé•¿åº¦ä¸º$L_{train}$ï¼ŒRoPEçš„åŸºé¢‘ç‡ä¸º$\theta$ã€‚åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œç›¸å¯¹ä½ç½®$\Delta = n - m \in [0, L_{train}]$å¯¹åº”çš„æ—‹è½¬è§’åº¦ä¸ºï¼š
$$
\{\Delta \theta : \Delta = 0, 1, 2, \ldots, L_{train}\}
$$</p>
<p>è¿™äº›è§’åº¦åœ¨å•ä½åœ†ä¸Šçš„åˆ†å¸ƒå¯†åº¦ä¸ºï¼š
$$
\rho = \frac{L_{train} \theta}{2\pi}
$$</p>
<p>å½“$\rho \gg 1$æ—¶ï¼Œå³ï¼š
$$
\theta > \frac{2\pi}{L_{train}}
$$</p>
<p>å•ä½åœ†è¢«å¯†é›†è¦†ç›–ï¼Œè®­ç»ƒåˆ°çš„è§’åº¦æ ·æœ¬å……åˆ†ï¼Œæœ‰åˆ©äºæ³›åŒ–åˆ°æ›´é•¿çš„åºåˆ—ã€‚</p>
<p><strong>å®šç†8.2ï¼šKNA + RoPEçš„ååŒæ•ˆåº”</strong></p>
<p>KNAå¼ºåˆ¶æ¨¡å‹ä¼˜åŒ–ä½™å¼¦ç›¸ä¼¼åº¦ï¼ŒRoPEå¢åŠ è§’åº¦çš„å¤šæ ·æ€§ã€‚ä¸¤è€…ç»“åˆï¼š</p>
<ol>
<li><strong>KNAä½œç”¨</strong>ï¼š$|\tilde{\boldsymbol{k}}_j| = 1$ï¼Œæ¶ˆé™¤æ¨¡é•¿å¹²æ‰°</li>
<li><strong>RoPEä½œç”¨</strong>ï¼šé€šè¿‡æ—‹è½¬å¢åŠ ä¸åŒç›¸å¯¹ä½ç½®çš„è§’åº¦å¤šæ ·æ€§</li>
<li><strong>ååŒæ•ˆåº”</strong>ï¼šå……åˆ†è®­ç»ƒçš„è§’åº¦æ¨¡å¼ + ä¸°å¯Œçš„è§’åº¦æ ·æœ¬ = æ›´å¥½çš„é•¿åº¦å¤–æ¨</li>
</ol>
<h3 id="9-cosine-attention">9. Cosine Attentionçš„æ•°å­¦è¡¨ç¤º</h3>
<p><strong>å®šä¹‰9.1ï¼šScaled Cosine Attention (CosA)</strong></p>
<p>Cosine AttentionåŒæ—¶å¯¹Queryå’ŒKeyè¿›è¡Œå½’ä¸€åŒ–ï¼š
$$
\boldsymbol{o}_i = \frac{\sum_{j=1}^i \exp\left(\lambda \tilde{\boldsymbol{q}}_i \cdot \tilde{\boldsymbol{k}}_j\right) \boldsymbol{v}_j}{\sum_{j=1}^i \exp\left(\lambda \tilde{\boldsymbol{q}}_i \cdot \tilde{\boldsymbol{k}}_j\right)}
$$</p>
<p>å…¶ä¸­ï¼š
$$
\tilde{\boldsymbol{q}}_i = \frac{\boldsymbol{q}_i}{\|\boldsymbol{q}_i\|}, \quad \tilde{\boldsymbol{k}}_j = \frac{\boldsymbol{k}_j}{\|\boldsymbol{k}_j\|}
$$</p>
<p>$\lambda$æ˜¯å¯å­¦ä¹ çš„æ¸©åº¦å‚æ•°ã€‚</p>
<p><strong>æ¨å¯¼9.1ï¼šCosAæ³¨æ„åŠ›åˆ†æ•°çš„æ€§è´¨</strong></p>
<p>æ³¨æ„åŠ›åˆ†æ•°ä¸ºï¼š
$$
s_{CosA}(j|i) = \lambda \tilde{\boldsymbol{q}}_i \cdot \tilde{\boldsymbol{k}}_j = \lambda \cos(\boldsymbol{q}_i, \boldsymbol{k}_j)
$$</p>
<p>ç”±äº$\cos(\boldsymbol{q}_i, \boldsymbol{k}_j) \in [-1, 1]$ï¼Œæœ‰ï¼š
$$
s_{CosA}(j|i) \in [-\lambda, \lambda]
$$</p>
<p>è¿™æä¾›äº†ä¸¥æ ¼çš„åˆ†æ•°ç•Œé™ï¼Œæœ‰åŠ©äºè®­ç»ƒç¨³å®šæ€§ã€‚</p>
<p><strong>å®šç†9.1ï¼šæ¸©åº¦å‚æ•°çš„ç†è®ºå€¼</strong></p>
<p>æ ¹æ®ç†µä¸å˜æ€§åŸç†ï¼Œæ¸©åº¦å‚æ•°åº”è¯¥è®¾ç½®ä¸ºï¼š
$$
\lambda = c \log n
$$</p>
<p>å…¶ä¸­$n$æ˜¯åºåˆ—é•¿åº¦ï¼Œ$c$æ˜¯å¸¸æ•°ï¼ˆé€šå¸¸å–4å·¦å³ï¼‰ã€‚</p>
<p><strong>æ¨å¯¼9.2ï¼šæ¸©åº¦å‚æ•°çš„æ¢¯åº¦æœ€å¤§åŒ–æ¨å¯¼</strong></p>
<p>å‡è®¾æˆ‘ä»¬å¸Œæœ›æ³¨æ„åŠ›åˆ†å¸ƒçš„æœ€å¤§æ¢¯åº¦ä¿æŒç¨³å®šã€‚æ³¨æ„åŠ›å¯¹è¾“å…¥çš„æ¢¯åº¦ä¸ºï¼š
$$
\frac{\partial \alpha_{ij}}{\partial s(j|i)} = \alpha_{ij}(1 - \alpha_{ij})
$$</p>
<p>æ¢¯åº¦æœ€å¤§å€¼å‡ºç°åœ¨$\alpha_{ij} = 0.5$æ—¶ï¼Œæ­¤æ—¶ï¼š
$$
\frac{\partial \alpha_{ij}}{\partial s(j|i)} = 0.25
$$</p>
<p>å¯¹äºå‡åŒ€åˆ†å¸ƒï¼ˆ$n$ä¸ªä½ç½®ï¼‰ï¼Œæœ‰$\alpha_{ij} = 1/n$ã€‚softmaxçš„æ€§è´¨å‘Šè¯‰æˆ‘ä»¬ï¼Œå½“åˆ†æ•°å·®å¼‚ä¸ºï¼š
$$
\Delta s = \log n
$$</p>
<p>æ—¶ï¼Œèƒ½å¤Ÿäº§ç”Ÿæ˜¾è‘—çš„æ¦‚ç‡å·®å¼‚ã€‚å› æ­¤æ¸©åº¦å‚æ•°åº”è¯¥éš$\log n$ç¼©æ”¾ã€‚</p>
<h3 id="10">10. æ¸©åº¦å‚æ•°çš„è‡ªé€‚åº”è°ƒæ•´</h3>
<p><strong>å®šä¹‰10.1ï¼šåŠ¨æ€æ¸©åº¦å‚æ•°</strong></p>
<p>å¯¹äºå˜é•¿åºåˆ—ï¼Œæ¸©åº¦å‚æ•°åº”è¯¥æ ¹æ®å®é™…åºåˆ—é•¿åº¦åŠ¨æ€è°ƒæ•´ï¼š
$$
\lambda(n) = \max(1, c \log n)
$$</p>
<p>å…¶ä¸­$c \in [3.5, 4]$æ˜¯å¸¸æ•°ï¼Œ$n$æ˜¯å½“å‰ä½ç½®çš„ç´¢å¼•ï¼ˆæˆ–åºåˆ—é•¿åº¦çš„ä¸€åŠï¼‰ã€‚</p>
<p><strong>æ¨å¯¼10.1ï¼šç†µä¸å˜æ€§æ¡ä»¶</strong></p>
<p>è®¾æ³¨æ„åŠ›åˆ†å¸ƒä¸º${\alpha_{ij}}_{j=1}^i$ï¼Œå…¶ç†µä¸ºï¼š
$$
H_i = -\sum_{j=1}^i \alpha_{ij} \log \alpha_{ij}
$$</p>
<p>åœ¨æ ‡å‡†Attentionä¸­ï¼Œç”±äºsoftmaxçš„æ€§è´¨ï¼Œå½“åˆ†æ•°å°ºåº¦å›ºå®šæ—¶ï¼š
$$
H_i \approx \log i - \text{const}
$$</p>
<p>å³ç†µéšåºåˆ—é•¿åº¦å¯¹æ•°å¢é•¿ã€‚</p>
<p>ä¸ºäº†ä¿æŒç†µç›¸å¯¹ç¨³å®šï¼ˆç›¸å¯¹äºæœ€å¤§ç†µ$\log i$çš„æ¯”ä¾‹ï¼‰ï¼Œæˆ‘ä»¬éœ€è¦æ¸©åº¦å‚æ•°éš$\log i$è°ƒæ•´ï¼š
$$
s'(j|i) = \frac{s(j|i)}{\lambda(i)}, \quad \lambda(i) \propto \log i
$$</p>
<p><strong>æ¨å¯¼10.2ï¼šæ¸©åº¦å‚æ•°å¯¹æ³¨æ„åŠ›åˆ†å¸ƒçš„å½±å“</strong></p>
<p>æ³¨æ„åŠ›æƒé‡å¯¹æ¸©åº¦çš„å¯¼æ•°ï¼š
$$
\frac{\partial \alpha_{ij}}{\partial \lambda} = \frac{\partial}{\partial \lambda} \frac{\exp(\lambda s_{ij})}{\sum_k \exp(\lambda s_{ik})}
$$</p>
<p>åˆ©ç”¨softmaxçš„å¯¼æ•°æ€§è´¨ï¼š
$$
\frac{\partial \alpha_{ij}}{\partial \lambda} = \alpha_{ij} \left(s_{ij} - \sum_k \alpha_{ik} s_{ik}\right)
$$</p>
<p>è¿™è¡¨æ˜ï¼š
- å½“$s_{ij}$é«˜äºå¹³å‡åˆ†æ•°æ—¶ï¼Œå¢å¤§$\lambda$ä¼šå¢å¤§$\alpha_{ij}$ï¼ˆå¯Œè€…æ›´å¯Œï¼‰
- æ¸©åº¦å‚æ•°æ§åˆ¶åˆ†å¸ƒçš„å°–é”ç¨‹åº¦</p>
<h3 id="11-layernorml2-normalization">11. LayerNormä¸L2 Normalizationçš„å¯¹æ¯”</h3>
<p><strong>å®šä¹‰11.1ï¼šLayerNorm</strong></p>
<p>LayerNormå¯¹å‘é‡è¿›è¡Œå¦‚ä¸‹å˜æ¢ï¼š
$$
\text{LayerNorm}(\boldsymbol{x}) = \gamma \odot \frac{\boldsymbol{x} - \mu}{\sigma} + \beta
$$</p>
<p>å…¶ä¸­ï¼š
$$
\mu = \frac{1}{d}\sum_{i=1}^d x_i, \quad \sigma = \sqrt{\frac{1}{d}\sum_{i=1}^d (x_i - \mu)^2}
$$</p>
<p>$\gamma, \beta \in \mathbb{R}^d$æ˜¯å¯å­¦ä¹ å‚æ•°ã€‚</p>
<p><strong>å®šä¹‰11.2ï¼šL2 Normalization</strong></p>
<p>L2å½’ä¸€åŒ–ä»…è°ƒæ•´æ¨¡é•¿ï¼š
$$
\text{L2Norm}(\boldsymbol{x}) = \frac{\boldsymbol{x}}{\|\boldsymbol{x}\|}
$$</p>
<p>ä¸æ”¹å˜å‘é‡æ–¹å‘ï¼Œæ— å¯å­¦ä¹ å‚æ•°ã€‚</p>
<p><strong>å¯¹æ¯”11.1ï¼šä¸­å¿ƒåŒ–</strong></p>
<ul>
<li><strong>LayerNorm</strong>ï¼šå…ˆå‡å»å‡å€¼$\mu$ï¼Œè¿›è¡Œä¸­å¿ƒåŒ–</li>
<li><strong>L2Norm</strong>ï¼šä¸è¿›è¡Œä¸­å¿ƒåŒ–ï¼Œä¿ç•™åŸå§‹æ–¹å‘</li>
</ul>
<p><strong>å¯¹æ¯”11.2ï¼šç¼©æ”¾</strong></p>
<ul>
<li><strong>LayerNorm</strong>ï¼šé™¤ä»¥æ ‡å‡†å·®$\sigma$åï¼Œå†ä¹˜ä»¥å¯å­¦ä¹ çš„$\gamma$ï¼Œè¾“å‡ºæ¨¡é•¿ä¸å›ºå®š</li>
<li><strong>L2Norm</strong>ï¼šå›ºå®šè¾“å‡ºæ¨¡é•¿ä¸º1ï¼Œ$|\text{L2Norm}(\boldsymbol{x})| = 1$</li>
</ul>
<p><strong>å¯¹æ¯”11.3ï¼šå¯å­¦ä¹ å‚æ•°</strong></p>
<ul>
<li><strong>LayerNorm</strong>ï¼šæœ‰$2d$ä¸ªå¯å­¦ä¹ å‚æ•°ï¼ˆ$\gamma, \beta$ï¼‰</li>
<li><strong>L2Norm</strong>ï¼šæ— å¯å­¦ä¹ å‚æ•°</li>
</ul>
<p><strong>å®šç†11.1ï¼šLayerNormå¯èƒ½ç ´åKeyå½’ä¸€åŒ–çš„æ•ˆæœ</strong></p>
<p>å¦‚æœå¯¹Keyåº”ç”¨LayerNormè€ŒéL2å½’ä¸€åŒ–ï¼š
$$
\tilde{\boldsymbol{k}}_j = \gamma \odot \frac{\boldsymbol{k}_j - \mu_j}{\sigma_j} + \beta
$$</p>
<p>ç”±äº$\gamma$æ˜¯å¯å­¦ä¹ çš„ï¼Œæ¨¡å‹å¯ä»¥é€šè¿‡è°ƒæ•´$\gamma$æ¥æ”¹å˜$|\tilde{\boldsymbol{k}}_j|$ï¼š
$$
\|\tilde{\boldsymbol{k}}_j\| = \left\|\gamma \odot \frac{\boldsymbol{k}_j - \mu_j}{\sigma_j} + \beta\right\|
$$</p>
<p>è¿™ä¸ªæ¨¡é•¿ä¸å†å›ºå®šä¸º1ï¼Œå› æ­¤LayerNormæ— æ³•ä¿è¯æ¶ˆé™¤Keyæ¨¡é•¿çš„å½±å“ã€‚</p>
<h3 id="12">12. é•¿åº¦å¤–æ¨çš„ç¨³å®šæ€§åˆ†æ</h3>
<p><strong>å®šä¹‰12.1ï¼šPPLçˆ†ç‚¸</strong></p>
<p>åœ¨é•¿åº¦å¤–æ¨æ—¶ï¼Œå¦‚æœæµ‹è¯•é›†çš„å›°æƒ‘åº¦(Perplexity)æ˜¾è‘—é«˜äºè®­ç»ƒé•¿åº¦ä¸‹çš„å›°æƒ‘åº¦ï¼Œæˆ‘ä»¬ç§°å‘ç”Ÿäº†PPLçˆ†ç‚¸ï¼š
$$
\text{PPL}_{test}(L_{test}) \gg \text{PPL}_{train}(L_{train}) \quad \text{å½“} \quad L_{test} \gg L_{train}
$$</p>
<p><strong>å®šç†12.1ï¼šKNAçš„æ•°å€¼ç¨³å®šæ€§</strong></p>
<p>åœ¨Keyå½’ä¸€åŒ–åï¼Œæ³¨æ„åŠ›åˆ†æ•°æœ‰ä¸¥æ ¼çš„ä¸Šç•Œï¼š
$$
|s_{KNA}(j|i)| = |\|\boldsymbol{q}_i\| \cos(\boldsymbol{q}_i, \boldsymbol{k}_j)| \leq \|\boldsymbol{q}_i\|
$$</p>
<p>è¿™é˜²æ­¢äº†æ³¨æ„åŠ›åˆ†æ•°è¿‡å¤§å¯¼è‡´çš„softmaxæº¢å‡ºã€‚</p>
<p><strong>æ¨å¯¼12.1ï¼šæ ‡å‡†Attentionçš„ä¸ç¨³å®šæ€§æ¥æº</strong></p>
<p>åœ¨æ ‡å‡†Attentionä¸­ï¼Œå¦‚æœæŸä¸ªKeyçš„æ¨¡é•¿å¼‚å¸¸å¤§ï¼š
$$
\|\boldsymbol{k}_j\| \gg \sqrt{d}
$$</p>
<p>åˆ™å¯¹åº”çš„æ³¨æ„åŠ›åˆ†æ•°ï¼š
$$
s(j|i) = \frac{\|\boldsymbol{q}_i\| \|\boldsymbol{k}_j\| \cos(\boldsymbol{q}_i, \boldsymbol{k}_j)}{\sqrt{d}}
$$</p>
<p>å¯èƒ½éå¸¸å¤§ï¼Œå¯¼è‡´ï¼š
$$
\exp(s(j|i)) \gg \sum_{k \neq j} \exp(s(k|i))
$$</p>
<p>æ³¨æ„åŠ›å‡ ä¹å®Œå…¨é›†ä¸­åœ¨ä½ç½®$j$ï¼ŒæŸå¤±äº†å¯¹å…¶ä»–ä½ç½®çš„æ„ŸçŸ¥ã€‚</p>
<p><strong>æ¨å¯¼12.2ï¼šKNAä¿æŒæ³¨æ„åŠ›åˆ†å¸ƒçš„å¤šæ ·æ€§</strong></p>
<p>ç”±äº$s_{KNA}(j|i)$æœ‰ç•Œï¼Œsoftmaxä¸ä¼šå‡ºç°æç«¯é›†ä¸­ï¼š
$$
\alpha_{ij}^{KNA} = \frac{\exp(\|\boldsymbol{q}_i\| \cos_j)}{\sum_{k=1}^i \exp(\|\boldsymbol{q}_i\| \cos_k)}
$$</p>
<p>å³ä½¿$\cos_j = 1$ï¼ˆæœ€å¤§å€¼ï¼‰ï¼Œåªè¦å­˜åœ¨å…¶ä»–$\cos_k$æ¥è¿‘1çš„ä½ç½®ï¼Œæ³¨æ„åŠ›ä»ä¼šåˆ†æ•£ã€‚</p>
<h3 id="13">13. ç›¸å¯¹ä½ç½®çš„å¤–æ¨è¯¯å·®ç•Œ</h3>
<p><strong>å®šä¹‰13.1ï¼šä½ç½®ç¼–ç å‡½æ•°</strong></p>
<p>è®¾ä½ç½®ç¼–ç ä¸ºå‡½æ•°$f: \mathbb{N} \to \mathbb{R}^d$ï¼Œæ»¡è¶³ç›¸å¯¹ä½ç½®æ€§è´¨ï¼š
$$
\boldsymbol{q}_m^T \boldsymbol{k}_n = g(f(m), f(n)) = h(m - n)
$$</p>
<p>å…¶ä¸­$h: \mathbb{Z} \to \mathbb{R}$ä»…ä¾èµ–äºç›¸å¯¹ä½ç½®ã€‚</p>
<p><strong>å®šç†13.1ï¼šè®­ç»ƒä½ç½®é›†çš„Lipschitzæ€§è´¨</strong></p>
<p>å‡è®¾$h$åœ¨è®­ç»ƒé›†$[0, L_{train}]$ä¸Šæ˜¯Lipschitzè¿ç»­çš„ï¼Œå¸¸æ•°ä¸º$L$ï¼š
$$
|h(\Delta_1) - h(\Delta_2)| \leq L |\Delta_1 - \Delta_2|, \quad \forall \Delta_1, \Delta_2 \in [0, L_{train}]
$$</p>
<p><strong>æ¨å¯¼13.1ï¼šå¤–æ¨è¯¯å·®çš„ä¸Šç•Œ</strong></p>
<p>å½“å¤–æ¨åˆ°$L_{test} &gt; L_{train}$æ—¶ï¼Œå¯¹äºæ–°çš„ç›¸å¯¹ä½ç½®$\Delta \in (L_{train}, L_{test}]$ï¼Œæˆ‘ä»¬éœ€è¦ä¼°è®¡$h(\Delta)$ã€‚</p>
<p>æœ€è¿‘é‚»æ’å€¼ï¼š
$$
\hat{h}(\Delta) = h(L_{train})
$$</p>
<p>è¯¯å·®ä¸ºï¼š
$$
|h(\Delta) - \hat{h}(\Delta)| = |h(\Delta) - h(L_{train})|
$$</p>
<p>å¦‚æœ$h$æ»¡è¶³å…¨å±€Lipschitzæ¡ä»¶ï¼ˆå¤–æ¨å‡è®¾ï¼‰ï¼š
$$
|h(\Delta) - h(L_{train})| \leq L (\Delta - L_{train}) \leq L (L_{test} - L_{train})
$$</p>
<p>è¯¯å·®éšå¤–æ¨é•¿åº¦çº¿æ€§å¢é•¿ã€‚</p>
<p><strong>æ¨å¯¼13.2ï¼šKNAå‡å°Lipschitzå¸¸æ•°</strong></p>
<p>åœ¨æ ‡å‡†Attentionä¸­ï¼š
$$
h(\Delta) = \|\boldsymbol{q}\| \|\boldsymbol{k}\| \cos(\Delta\theta) / \sqrt{d}
$$</p>
<p>å…¶å¯¼æ•°ï¼š
$$
|h'(\Delta)| = \frac{\|\boldsymbol{q}\| \|\boldsymbol{k}\| \theta |\sin(\Delta\theta)|}{\sqrt{d}} \leq \frac{\|\boldsymbol{q}\| \|\boldsymbol{k}\| \theta}{\sqrt{d}}
$$</p>
<p>åœ¨KNAä¸­ï¼š
$$
h_{KNA}(\Delta) = \|\boldsymbol{q}\| \cos(\Delta\theta)
$$</p>
<p>å¯¼æ•°ï¼š
$$
|h'_{KNA}(\Delta)| = \|\boldsymbol{q}\| \theta |\sin(\Delta\theta)| \leq \|\boldsymbol{q}\| \theta
$$</p>
<p>å¦‚æœ$|\boldsymbol{k}| &gt; \sqrt{d}$ï¼ˆè®­ç»ƒåæœŸå¸¸è§ï¼‰ï¼Œåˆ™ï¼š
$$
|h'_{KNA}| < |h'_{std}|
$$</p>
<p>å³KNAçš„Lipschitzå¸¸æ•°æ›´å°ï¼Œå¤–æ¨è¯¯å·®æ›´å°ã€‚</p>
<h3 id="14">14. æ³¨æ„åŠ›ç†µä¸é•¿åº¦å¤–æ¨çš„å…³ç³»</h3>
<p><strong>å®šä¹‰14.1ï¼šæ³¨æ„åŠ›ç†µ</strong></p>
<p>ä½ç½®$i$çš„æ³¨æ„åŠ›åˆ†å¸ƒçš„ç†µå®šä¹‰ä¸ºï¼š
$$
H_i = -\sum_{j=1}^i \alpha_{ij} \log \alpha_{ij}
$$</p>
<p>ç†µè¶Šå¤§ï¼Œæ³¨æ„åŠ›è¶Šåˆ†æ•£ï¼›ç†µè¶Šå°ï¼Œæ³¨æ„åŠ›è¶Šé›†ä¸­ã€‚</p>
<p><strong>å®šç†14.1ï¼šé•¿åº¦å¤–æ¨éœ€è¦é€‚åº¦çš„æ³¨æ„åŠ›ç†µ</strong></p>
<p>æˆåŠŸçš„é•¿åº¦å¤–æ¨è¦æ±‚ï¼š
$$
\frac{H_i}{\log i} \approx \text{const}, \quad \forall i \in [1, L_{test}]
$$</p>
<p>å³å½’ä¸€åŒ–ç†µä¿æŒç¨³å®šã€‚</p>
<p><strong>æ¨å¯¼14.1ï¼šç†µå´©å¡Œå¯¼è‡´PPLçˆ†ç‚¸</strong></p>
<p>å¦‚æœåœ¨é•¿åºåˆ—ä¸­$H_i \to 0$ï¼ˆç†µå´©å¡Œï¼‰ï¼Œæ„å‘³ç€æ³¨æ„åŠ›å‡ ä¹å®Œå…¨é›†ä¸­åœ¨å°‘æ•°ä½ç½®ï¼š
$$
\exists j^* : \alpha_{ij^*} \approx 1, \quad \alpha_{ij} \approx 0, \forall j \neq j^*
$$</p>
<p>è¿™å¯¼è‡´è¾“å‡ºä»…ä¾èµ–äºä½ç½®$j^*$çš„ä¿¡æ¯ï¼Œä¸¢å¤±äº†å…¶ä»–ä½ç½®çš„ä¿¡æ¯ï¼Œé¢„æµ‹è´¨é‡ä¸‹é™ã€‚</p>
<p><strong>æ¨å¯¼14.2ï¼šKNAç»´æŒæ³¨æ„åŠ›ç†µ</strong></p>
<p>åœ¨KNAä¸­ï¼Œç”±äºæ‰€æœ‰Keyå½’ä¸€åŒ–ï¼Œä¸å­˜åœ¨æŸä¸ªä½ç½®é€šè¿‡æå¤§çš„$|\boldsymbol{k}_j|$"å„æ–­"æ³¨æ„åŠ›çš„æƒ…å†µã€‚æ³¨æ„åŠ›åˆ†æ•°ï¼š
$$
s_{KNA}(j|i) = \|\boldsymbol{q}_i\| \cos(\boldsymbol{q}_i, \boldsymbol{k}_j)
$$</p>
<p>æ‰€æœ‰ä½ç½®"å¹³ç­‰ç«äº‰"ï¼Œ$\cos$å€¼åœ¨$[-1,1]$èŒƒå›´å†…ï¼Œå·®å¼‚ç›¸å¯¹æ¸©å’Œï¼Œä»è€Œç»´æŒäº†é€‚åº¦çš„æ³¨æ„åŠ›ç†µã€‚</p>
<h3 id="15-query-normalization">15. Query Normalizationçš„å¯¹æ¯”å®éªŒ</h3>
<p><strong>å®šä¹‰15.1ï¼šQuery Normalized Attention (QNA)</strong></p>
<p>$$
\boldsymbol{o}_i = \frac{\sum_{j=1}^i \exp\left(\tilde{\boldsymbol{q}}_i \cdot \boldsymbol{k}_j\right) \boldsymbol{v}_j}{\sum_{j=1}^i \exp\left(\tilde{\boldsymbol{q}}_i \cdot \boldsymbol{k}_j\right)}, \quad \tilde{\boldsymbol{q}}_i = \frac{\boldsymbol{q}_i}{\|\boldsymbol{q}_i\|}
$$</p>
<p><strong>å®šç†15.1ï¼šQNAæ— æ³•å®ç°é•¿åº¦å¤–æ¨</strong></p>
<p>å®éªŒè¡¨æ˜ï¼ŒQNAåœ¨è®­ç»ƒé•¿åº¦ä¸Šæ•ˆæœä¸æ ‡å‡†Attentionç›¸å½“ï¼Œä½†åœ¨é•¿åº¦å¤–æ¨ä¸Šè¡¨ç°ç³Ÿç³•ï¼Œç”šè‡³åŠ£äºBaselineã€‚</p>
<p><strong>æ¨å¯¼15.1ï¼šQNAå¤±æ•ˆçš„åŸå› </strong></p>
<p>åœ¨QNAä¸­ï¼š
$$
s_{QNA}(j|i) = \tilde{\boldsymbol{q}}_i \cdot \boldsymbol{k}_j = \frac{\boldsymbol{q}_i \cdot \boldsymbol{k}_j}{\|\boldsymbol{q}_i\|} = \|\boldsymbol{k}_j\| \cos(\boldsymbol{q}_i, \boldsymbol{k}_j)
$$</p>
<p>Keyæ¨¡é•¿$|\boldsymbol{k}_j|$ä»ç„¶å­˜åœ¨ï¼Œæ¨¡å‹ä»å¯é€šè¿‡è°ƒæ•´$|\boldsymbol{k}_j|$æ¥æ”¹å˜æ³¨æ„åŠ›åˆ†å¸ƒï¼Œå› æ­¤$\cos$çš„è®­ç»ƒä¸å……åˆ†é—®é¢˜æœªè§£å†³ã€‚</p>
<p>åŒæ—¶ï¼ŒQueryå½’ä¸€åŒ–æ¶ˆé™¤äº†$|\boldsymbol{q}_i|$çš„æ¸©åº¦æ•ˆåº”ï¼š
$$
\alpha_{ij}^{QNA} = \frac{\exp(\|\boldsymbol{k}_j\| \cos_j)}{\sum_k \exp(\|\boldsymbol{k}_k\| \cos_k)}
$$</p>
<p>å¤±å»äº†é€šè¿‡$|\boldsymbol{q}_i|$è°ƒèŠ‚æ³¨æ„åŠ›å°–é”åº¦çš„èƒ½åŠ›ï¼Œåè€Œå¢åŠ äº†è®­ç»ƒéš¾åº¦ã€‚</p>
<h3 id="16-key">16. å¤šå¤´æ³¨æ„åŠ›ä¸­çš„Keyå½’ä¸€åŒ–</h3>
<p><strong>å®šä¹‰16.1ï¼šå¤šå¤´Keyå½’ä¸€åŒ–</strong></p>
<p>å¯¹äº$H$ä¸ªæ³¨æ„åŠ›å¤´ï¼Œæ¯ä¸ªå¤´ç‹¬ç«‹è¿›è¡ŒKeyå½’ä¸€åŒ–ï¼š
$$
\tilde{\boldsymbol{k}}_{j}^{(h)} = \frac{\boldsymbol{k}_j^{(h)}}{\|\boldsymbol{k}_j^{(h)}\|}, \quad h = 1, 2, \ldots, H
$$</p>
<p><strong>æ¨å¯¼16.1ï¼šä¸åŒå¤´å­¦ä¹ ä¸åŒçš„è§’åº¦æ¨¡å¼</strong></p>
<p>ç”±äºæ¯ä¸ªå¤´çš„Queryå’ŒKeyæŠ•å½±ä¸åŒï¼š
$$
\boldsymbol{q}_i^{(h)} = \boldsymbol{W}_Q^{(h)} \boldsymbol{x}_i, \quad \boldsymbol{k}_j^{(h)} = \boldsymbol{W}_K^{(h)} \boldsymbol{x}_j
$$</p>
<p>å½’ä¸€åŒ–åï¼š
$$
\cos^{(h)}(\boldsymbol{q}_i, \boldsymbol{k}_j) = \frac{\boldsymbol{q}_i^{(h)} \cdot \boldsymbol{k}_j^{(h)}}{\|\boldsymbol{q}_i^{(h)}\| \|\boldsymbol{k}_j^{(h)}\|}
$$</p>
<p>ä¸åŒçš„$\boldsymbol{W}_Q^{(h)}, \boldsymbol{W}_K^{(h)}$å¯¼è‡´ä¸åŒçš„ä½™å¼¦æ¨¡å¼ï¼Œå®ç°å¤šæ ·åŒ–çš„ä½ç½®æ„ŸçŸ¥ã€‚</p>
<p><strong>å®šç†16.1ï¼šå¤šå¤´KNAå¢å¼ºè¡¨è¾¾èƒ½åŠ›</strong></p>
<p>å¤šå¤´KNAçš„è¾“å‡ºä¸ºï¼š
$$
\boldsymbol{o}_i = \boldsymbol{W}_O \text{Concat}(\text{head}_1, \text{head}_2, \ldots, \text{head}_H)
$$</p>
<p>å…¶ä¸­æ¯ä¸ªheadå­¦ä¹ ä¸åŒçš„ç›¸å¯¹ä½ç½®æ¨¡å¼ï¼Œç»„åˆåèƒ½å¤Ÿè¡¨è¾¾å¤æ‚çš„ä½ç½®ä¾èµ–å…³ç³»ã€‚</p>
<h3 id="17">17. è®­ç»ƒç¨³å®šæ€§çš„ç†è®ºåˆ†æ</h3>
<p><strong>å®šä¹‰17.1ï¼šæ¢¯åº¦èŒƒæ•°</strong></p>
<p>è®­ç»ƒç¨³å®šæ€§å¯ä»¥é€šè¿‡æ¢¯åº¦èŒƒæ•°æ¥è¡¡é‡ï¼š
$$
\|\nabla_\theta \mathcal{L}\|
$$</p>
<p>å¦‚æœæ¢¯åº¦èŒƒæ•°åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ä¿æŒé€‚åº¦èŒƒå›´ï¼Œè®­ç»ƒç¨³å®šï¼›å¦‚æœå‡ºç°æ¢¯åº¦çˆ†ç‚¸æˆ–æ¶ˆå¤±ï¼Œè®­ç»ƒä¸ç¨³å®šã€‚</p>
<p><strong>å®šç†17.1ï¼šKNAçš„æ¢¯åº¦æœ‰ç•Œæ€§</strong></p>
<p>ç”±äºKNAçš„æ³¨æ„åŠ›åˆ†æ•°æœ‰ç•Œï¼š
$$
|s_{KNA}(j|i)| \leq \|\boldsymbol{q}_i\|
$$</p>
<p>åå‘ä¼ æ’­æ—¶æ¢¯åº¦ä¹Ÿç›¸åº”æœ‰ç•Œï¼Œä¸ä¼šå‡ºç°æç«¯çš„æ¢¯åº¦çˆ†ç‚¸ã€‚</p>
<p><strong>æ¨å¯¼17.1ï¼šæ³¨æ„åŠ›åˆ†æ•°å¯¹å‚æ•°çš„æ¢¯åº¦</strong></p>
<p>$$
\frac{\partial s_{KNA}(j|i)}{\partial \theta} = \frac{\partial}{\partial \theta} \left(\boldsymbol{q}_i \cdot \frac{\boldsymbol{k}_j}{\|\boldsymbol{k}_j\|}\right)
$$</p>
<p>åˆ©ç”¨é“¾å¼æ³•åˆ™ï¼š
$$
\frac{\partial s_{KNA}}{\partial \theta} = \frac{\boldsymbol{q}_i}{\|\boldsymbol{k}_j\|} \cdot \frac{\partial \boldsymbol{k}_j}{\partial \theta} - \frac{(\boldsymbol{q}_i \cdot \boldsymbol{k}_j) \boldsymbol{k}_j}{\|\boldsymbol{k}_j\|^3} \cdot \frac{\partial \boldsymbol{k}_j}{\partial \theta}
$$</p>
<p>ç”±äº$|\tilde{\boldsymbol{k}}_j| = 1$ï¼Œç¬¬äºŒé¡¹æä¾›äº†è‡ªåŠ¨çš„æ¢¯åº¦ç¼©æ”¾ï¼Œé˜²æ­¢æ¢¯åº¦è¿‡å¤§ã€‚</p>
<h3 id="18">18. é•¿åº¦å¤–æ¨çš„å®è¯åˆ†æ</h3>
<p><strong>å®éªŒè®¾ç½®</strong>ï¼š
- æ¨¡å‹ï¼šGAUæ¶æ„ï¼Œ1äº¿å‚æ•°
- è®­ç»ƒé•¿åº¦ï¼š512
- æµ‹è¯•é•¿åº¦ï¼š4096
- è¯„ä»·æŒ‡æ ‡ï¼šé€tokenå‡†ç¡®ç‡</p>
<p><strong>ç»“æœ18.1ï¼šKNAæ˜¾è‘—æå‡å¤–æ¨æ•ˆæœ</strong></p>
<p>ä»å®éªŒè¡¨æ ¼å¯è§ï¼š
- Baselineåœ¨4096ï¼ˆä¸é‡å¤ï¼‰ï¼š23.16%
- KNAåœ¨4096ï¼ˆä¸é‡å¤ï¼‰ï¼š47.69%ï¼ˆæå‡è¶…è¿‡2å€ï¼‰
- CosAåœ¨4096ï¼ˆä¸é‡å¤ï¼‰ï¼š46.98%ï¼ˆæ¥è¿‘KNAï¼‰</p>
<p><strong>åˆ†æ18.1ï¼šä¸ºä½•"ä¸é‡å¤"æ¯”"é‡å¤"æ›´é‡è¦</strong></p>
<p>"é‡å¤"æµ‹è¯•é›†ï¼šå°†512é•¿åº¦çš„æ–‡æœ¬é‡å¤8æ¬¡æ‹¼æ¥æˆ4096
"ä¸é‡å¤"æµ‹è¯•é›†ï¼šçœŸå®çš„4096é•¿åº¦æ–‡æœ¬</p>
<p>"ä¸é‡å¤"æ›´èƒ½åæ˜ çœŸå®çš„é•¿åº¦å¤–æ¨èƒ½åŠ›ï¼Œå› ä¸ºï¼š
1. çœŸå®åœºæ™¯ä¸­ä¸ä¼šæœ‰å¤§é‡é‡å¤æ–‡æœ¬
2. "é‡å¤"å¯èƒ½è¢«æ¨¡å‹è¯†åˆ«å‡ºå‘¨æœŸæ€§æ¨¡å¼
3. "ä¸é‡å¤"éœ€è¦æ¨¡å‹çœŸæ­£ç†è§£é•¿è·ç¦»ä¾èµ–</p>
<p><strong>åˆ†æ18.2ï¼šKNAä¸å¤–æ¨æŠ€å·§çš„å åŠ æ•ˆæœ</strong></p>
<p>å®éªŒæ˜¾ç¤ºï¼š
- Baseline + YaRNï¼š47.45%
- KNAï¼ˆæ— ä¿®æ”¹ï¼‰ï¼š47.69%
- KNA + YaRNï¼š47.44%ï¼ˆå‡ ä¹æ— æå‡ï¼‰</p>
<p>ç»“è®ºï¼šKNAå·²ç»éšå¼åœ°è§£å†³äº†é•¿åº¦å¤–æ¨é—®é¢˜ï¼Œè¿›ä¸€æ­¥å åŠ YaRNç­‰æŠ€å·§æ— æ˜¾è‘—å¢ç›Šã€‚</p>
<h3 id="19">19. è®¡ç®—å¤æ‚åº¦åˆ†æ</h3>
<p><strong>å®šç†19.1ï¼šKNAçš„é¢å¤–è®¡ç®—æˆæœ¬</strong></p>
<p>Keyå½’ä¸€åŒ–çš„æ“ä½œä¸ºï¼š
$$
\tilde{\boldsymbol{k}}_j = \frac{\boldsymbol{k}_j}{\|\boldsymbol{k}_j\|} = \frac{\boldsymbol{k}_j}{\sqrt{\sum_{\ell=1}^d k_{j,\ell}^2}}
$$</p>
<p><strong>è®¡ç®—æ­¥éª¤</strong>ï¼š
1. è®¡ç®—$|\boldsymbol{k}<em _ell="1">j|^2 = \sum</em>^2$ï¼š$O(d)$
2. è®¡ç®—$|\boldsymbol{k}_j| = \sqrt{|\boldsymbol{k}_j|^2}$ï¼š$O(1)$
3. é€å…ƒç´ é™¤æ³•ï¼š$O(d)$}^d k_{j,\ell</p>
<p>æ€»è®¡ï¼š$O(d)$</p>
<p>å¯¹äºåºåˆ—é•¿åº¦$n$ï¼Œæ€»å¤æ‚åº¦ä¸º$O(nd)$ã€‚</p>
<p><strong>å¯¹æ¯”19.1ï¼šç›¸å¯¹äºAttentionçš„è®¡ç®—é‡</strong></p>
<p>æ ‡å‡†Attentionçš„è®¡ç®—å¤æ‚åº¦ï¼š
- Query-Keyç‚¹ç§¯ï¼š$O(n^2 d)$
- Softmaxï¼š$O(n^2)$
- Attention-ValueåŠ æƒï¼š$O(n^2 d)$</p>
<p>æ€»è®¡ï¼š$O(n^2 d)$</p>
<p>Keyå½’ä¸€åŒ–çš„$O(nd)$ç›¸å¯¹äº$O(n^2 d)$å¯å¿½ç•¥ä¸è®¡ï¼ˆå½“$n \gg 1$æ—¶ï¼‰ã€‚</p>
<h3 id="20">20. ä¸å…¶ä»–ä½ç½®ç¼–ç æ–¹æ¡ˆçš„æ¯”è¾ƒ</h3>
<p><strong>å¯¹æ¯”20.1ï¼šALIBI</strong></p>
<p>ALIBIé€šè¿‡åœ¨Attentionåˆ†æ•°ä¸ŠåŠ å…¥çº¿æ€§è¡°å‡biasï¼š
$$
s_{ALIBI}(j|i) = \boldsymbol{q}_i \cdot \boldsymbol{k}_j - m \cdot (i - j)
$$</p>
<p>å…¶ä¸­$m$æ˜¯è¡°å‡ç‡ã€‚</p>
<p>ç¼ºç‚¹ï¼š
- æ˜¾å¼çš„å±€éƒ¨æ³¨æ„åŠ›åå¥½ï¼Œå¯èƒ½æŸå¤±è¿œç¨‹ä¾èµ–
- éœ€è¦ä¸ºæ¯ä¸ªå¤´è®¾ç½®ä¸åŒçš„$m$
- ä¸é€‚ç”¨äºEncoder</p>
<p><strong>å¯¹æ¯”20.2ï¼šNTK-RoPE</strong></p>
<p>NTK-RoPEä¿®æ”¹RoPEçš„baseï¼š
$$
\theta_i = (10000 \cdot \kappa)^{-2i/d}, \quad \kappa = \left(\frac{L_{test}}{L_{train}}\right)^{d/(d-2)}
$$</p>
<p>ç¼ºç‚¹ï¼š
- éœ€è¦ä¿®æ”¹æ¨ç†é˜¶æ®µçš„æ¨¡å‹
- æ— æ³•ä¿æŒè®­ç»ƒé•¿åº¦å†…çš„æ’ç­‰æ€§
- å¤–æ¨æ•ˆæœæœ‰é™ï¼ˆçº¦$L_{test}/2$ï¼‰</p>
<p><strong>å¯¹æ¯”20.3ï¼šYaRN</strong></p>
<p>YaRNå¯¹ä¸åŒé¢‘ç‡è¿›è¡Œåˆ†æ®µå¤„ç†ï¼š
$$
\theta_i^{new} = \left[\gamma_i + (1-\gamma_i)\frac{L_{train}}{L_{test}}\right] \theta_i
$$</p>
<p>ä¼˜ç‚¹ï¼š
- æ•ˆæœå¥½äºNTK-RoPE
- ç†è®ºåŸºç¡€è¾ƒå¥½ï¼ˆè½¬åœˆè§†è§’ï¼‰</p>
<p>ç¼ºç‚¹ï¼š
- ä»éœ€ä¿®æ”¹æ¨ç†æ¨¡å‹
- å®ç°ç›¸å¯¹å¤æ‚</p>
<p><strong>å¯¹æ¯”20.4ï¼šKNAçš„ä¼˜åŠ¿æ€»ç»“</strong></p>
<table>
<thead>
<tr>
<th>æ–¹æ¡ˆ</th>
<th>è®­ç»ƒä¿®æ”¹</th>
<th>æ¨ç†ä¿®æ”¹</th>
<th>ä¿æŒæ’ç­‰æ€§</th>
<th>è¿œç¨‹ä¾èµ–</th>
<th>å®ç°å¤æ‚åº¦</th>
</tr>
</thead>
<tbody>
<tr>
<td>ALIBI</td>
<td>æ˜¯</td>
<td>å¦</td>
<td>å¦</td>
<td>æŸå¤±</td>
<td>ä½</td>
</tr>
<tr>
<td>NTK-RoPE</td>
<td>å¦</td>
<td>æ˜¯</td>
<td>å¦</td>
<td>ä¿ç•™</td>
<td>ä½</td>
</tr>
<tr>
<td>YaRN</td>
<td>å¦</td>
<td>æ˜¯</td>
<td>å¦</td>
<td>ä¿ç•™</td>
<td>ä¸­</td>
</tr>
<tr>
<td>KNA</td>
<td>æ˜¯</td>
<td>å¦</td>
<td>æ˜¯</td>
<td>ä¿ç•™</td>
<td>ä½</td>
</tr>
</tbody>
</table>
<p>KNAçš„ç‹¬ç‰¹ä¼˜åŠ¿ï¼š
1. æ¨ç†æ—¶å®Œå…¨ä¸ä¿®æ”¹ï¼ˆä¿æŒæ’ç­‰æ€§ï¼‰
2. ä¸å¼•å…¥å±€éƒ¨åå¥½ï¼ˆä¿ç•™è¿œç¨‹ä¾èµ–ï¼‰
3. å®ç°ç®€å•ï¼ˆå•ä¸ªå½’ä¸€åŒ–æ“ä½œï¼‰
4. è®­ç»ƒæ•ˆæœè¿˜ç•¥æœ‰æå‡</p>
<h3 id="21-key">21. Keyå½’ä¸€åŒ–çš„å‡ ä½•è§£é‡Š</h3>
<p><strong>å‡ ä½•è§†è§’21.1ï¼šå•ä½çƒé¢ä¸Šçš„ç‚¹</strong></p>
<p>Keyå½’ä¸€åŒ–å°†æ‰€æœ‰Keyå‘é‡æŠ•å½±åˆ°å•ä½çƒé¢ï¼š
$$
\mathcal{S}^{d-1} = \{\boldsymbol{k} \in \mathbb{R}^d : \|\boldsymbol{k}\| = 1\}
$$</p>
<p>æ³¨æ„åŠ›åˆ†æ•°å˜ä¸ºï¼š
$$
s_{KNA}(j|i) = \|\boldsymbol{q}_i\| \cdot (\hat{\boldsymbol{q}}_i \cdot \hat{\boldsymbol{k}}_j)
$$</p>
<p>å…¶ä¸­$\hat{\boldsymbol{q}}_i = \boldsymbol{q}_i / |\boldsymbol{q}_i|$ä¹Ÿåœ¨å•ä½çƒé¢ä¸Šã€‚</p>
<p><strong>å‡ ä½•æ„ä¹‰</strong>ï¼šæ³¨æ„åŠ›åˆ†æ•°æ­£æ¯”äºä¸¤ä¸ªå•ä½å‘é‡çš„å†…ç§¯ï¼Œå³å®ƒä»¬åœ¨çƒé¢ä¸Šçš„è·ç¦»ï¼ˆæµ‹åœ°çº¿è·ç¦»ï¼‰ã€‚</p>
<p><strong>æ¨å¯¼21.1ï¼šçƒé¢è·ç¦»ä¸ä½™å¼¦ç›¸ä¼¼åº¦</strong></p>
<p>å•ä½çƒé¢ä¸Šä¸¤ç‚¹$\hat{\boldsymbol{q}}, \hat{\boldsymbol{k}}$çš„æµ‹åœ°çº¿è·ç¦»ä¸ºï¼š
$$
d(\hat{\boldsymbol{q}}, \hat{\boldsymbol{k}}) = \arccos(\hat{\boldsymbol{q}} \cdot \hat{\boldsymbol{k}})
$$</p>
<p>Taylorå±•å¼€ï¼š
$$
\hat{\boldsymbol{q}} \cdot \hat{\boldsymbol{k}} = \cos d = 1 - \frac{d^2}{2} + O(d^4)
$$</p>
<p>å½“ä¸¤å‘é‡æ¥è¿‘æ—¶ï¼š
$$
\hat{\boldsymbol{q}} \cdot \hat{\boldsymbol{k}} \approx 1 - \frac{d^2}{2}
$$</p>
<p>å› æ­¤ä½™å¼¦ç›¸ä¼¼åº¦è¿‘ä¼¼åæ˜ äº†çƒé¢è·ç¦»çš„å¹³æ–¹ã€‚</p>
<p><strong>å‡ ä½•è§†è§’21.2ï¼šRoPEçš„æ—‹è½¬ç¾¤ä½œç”¨</strong></p>
<p>RoPEåœ¨çƒé¢ä¸Šæ–½åŠ æ—‹è½¬ç¾¤$SO(d)$çš„ä½œç”¨ï¼š
$$
\hat{\boldsymbol{k}}_n \mapsto \boldsymbol{\mathcal{R}}_n \hat{\boldsymbol{k}}_n
$$</p>
<p>ç”±äºæ—‹è½¬ä¿æŒå†…ç§¯ï¼š
$$
(\boldsymbol{\mathcal{R}}_m \hat{\boldsymbol{q}}) \cdot (\boldsymbol{\mathcal{R}}_n \hat{\boldsymbol{k}}) = \hat{\boldsymbol{q}} \cdot (\boldsymbol{\mathcal{R}}_{n-m} \hat{\boldsymbol{k}})
$$</p>
<p>è¿™åœ¨çƒé¢ä¸Šå®ç°äº†ç›¸å¯¹ä½ç½®ç¼–ç ã€‚</p>
<h3 id="22-key">22. ä¿¡æ¯è®ºè§†è§’ä¸‹çš„Keyå½’ä¸€åŒ–</h3>
<p><strong>å®šä¹‰22.1ï¼šæ³¨æ„åŠ›çš„ä¿¡æ¯å®¹é‡</strong></p>
<p>ä½ç½®$i$çš„æ³¨æ„åŠ›åˆ†å¸ƒ${\alpha_{ij}}$çš„ä¿¡æ¯å®¹é‡ï¼ˆè´Ÿç†µï¼‰ä¸ºï¼š
$$
C_i = \max_{p} I(Y; X) = H(Y) - H(Y|X) = H(Y)
$$</p>
<p>å…¶ä¸­$Y$æ˜¯é€‰æ‹©çš„ä½ç½®ï¼Œ$X$æ˜¯ç»™å®šçš„Queryã€‚</p>
<p><strong>å®šç†22.1ï¼šKNAæœ€å¤§åŒ–ä½ç½®ä¿¡æ¯</strong></p>
<p>ç”±äºKNAæ¶ˆé™¤äº†Keyæ¨¡é•¿çš„å½±å“ï¼Œæ‰€æœ‰ä½ç½®"å¹³ç­‰ç«äº‰"ï¼Œä½ç½®é€‰æ‹©çš„ç†µæ¥è¿‘æœ€å¤§ï¼š
$$
H_i^{KNA} \approx \log i
$$</p>
<p>ç›¸æ¯”ä¹‹ä¸‹ï¼Œæ ‡å‡†Attentionå¯èƒ½å‡ºç°æŸäº›ä½ç½®å› æ¨¡é•¿è¿‡å¤§è€Œ"å„æ–­"æ³¨æ„åŠ›ï¼Œé™ä½ç†µã€‚</p>
<p><strong>æ¨å¯¼22.1ï¼šäº’ä¿¡æ¯çš„åˆ†è§£</strong></p>
<p>æ³¨æ„åŠ›åˆ†å¸ƒä¸ä½ç½®çš„äº’ä¿¡æ¯ï¼š
$$
I(\alpha; \Delta) = H(\alpha) - H(\alpha | \Delta)
$$</p>
<p>å…¶ä¸­$\Delta = n - m$æ˜¯ç›¸å¯¹ä½ç½®ã€‚</p>
<p>KNAå¼ºåˆ¶$|\boldsymbol{k}_j| = 1$ï¼Œä½¿å¾—$H(\alpha | \Delta)$æœ€å°åŒ–ï¼ˆç»™å®šç›¸å¯¹ä½ç½®ï¼Œæ³¨æ„åŠ›ç¡®å®šæ€§æœ€å¼ºï¼‰ï¼Œä»è€Œæœ€å¤§åŒ–äº’ä¿¡æ¯$I(\alpha; \Delta)$ã€‚</p>
<p>è¿™æ„å‘³ç€KNAè®©æ³¨æ„åŠ›åˆ†å¸ƒä¸ç›¸å¯¹ä½ç½®çš„å…³ç³»æœ€ç´§å¯†ï¼Œæœ‰åŠ©äºå­¦ä¹ ä½ç½®æ¨¡å¼ã€‚</p>
<h3 id="23">23. è®­ç»ƒåŠ¨æ€ä¸æ”¶æ•›æ€§</h3>
<p><strong>å®šä¹‰23.1ï¼šè®­ç»ƒæŸå¤±çš„Lipschitzå¹³æ»‘æ€§</strong></p>
<p>å¦‚æœæŸå¤±å‡½æ•°$\mathcal{L}(\theta)$æ»¡è¶³ï¼š
$$
\|\nabla \mathcal{L}(\theta_1) - \nabla \mathcal{L}(\theta_2)\| \leq L \|\theta_1 - \theta_2\|
$$</p>
<p>åˆ™ç§°$\mathcal{L}$æ˜¯$L$-Lipschitzå¹³æ»‘çš„ã€‚</p>
<p><strong>å®šç†23.1ï¼šKNAæå‡è®­ç»ƒå¹³æ»‘æ€§</strong></p>
<p>ç”±äºKNAé™åˆ¶äº†æ³¨æ„åŠ›åˆ†æ•°çš„èŒƒå›´ï¼ŒæŸå¤±å‡½æ•°çš„Lipschitzå¸¸æ•°$L$å‡å°ï¼Œè®­ç»ƒæ›´å¹³æ»‘ã€‚</p>
<p><strong>æ¨å¯¼23.1ï¼šæ³¨æ„åŠ›åˆ†æ•°å¯¹å‚æ•°çš„äºŒé˜¶å¯¼æ•°</strong></p>
<p>$$
\frac{\partial^2 s_{KNA}}{\partial \theta^2} = \frac{\partial}{\partial \theta} \left(\frac{\partial s_{KNA}}{\partial \theta}\right)
$$</p>
<p>ç”±äº$s_{KNA}$æœ‰ç•Œï¼Œå…¶äºŒé˜¶å¯¼æ•°ä¹Ÿæœ‰ç•Œï¼Œä¿è¯äº†æŸå¤±å‡½æ•°çš„å¹³æ»‘æ€§ã€‚</p>
<p><strong>å®šç†23.2ï¼šKNAçš„æ”¶æ•›ä¿è¯</strong></p>
<p>åœ¨å¹³æ»‘æŸå¤±ä¸‹ï¼Œæ¢¯åº¦ä¸‹é™çš„æ”¶æ•›ç‡ä¸ºï¼š
$$
\mathcal{L}(\theta_T) - \mathcal{L}(\theta^*) \leq \frac{L \|\theta_0 - \theta^*\|^2}{2T}
$$</p>
<p>å…¶ä¸­$T$æ˜¯è¿­ä»£æ¬¡æ•°ï¼Œ$\theta^*$æ˜¯æœ€ä¼˜è§£ã€‚</p>
<p>KNAçš„è¾ƒå°Lipschitzå¸¸æ•°$L$æ„å‘³ç€æ›´å¿«çš„æ”¶æ•›é€Ÿåº¦ã€‚</p>
<h3 id="24">24. æ³›åŒ–ç†è®º</h3>
<p><strong>å®šä¹‰24.1ï¼šæ³›åŒ–è¯¯å·®</strong></p>
<p>$$
\mathcal{E}_{gen} = \mathbb{E}_{(x,y) \sim \mathcal{D}_{test}}[\mathcal{L}(f(x), y)] - \mathbb{E}_{(x,y) \sim \mathcal{D}_{train}}[\mathcal{L}(f(x), y)]
$$</p>
<p><strong>å®šç†24.1ï¼šKNAå‡å°Rademacherå¤æ‚åº¦</strong></p>
<p>æ¨¡å‹çš„Rademacherå¤æ‚åº¦ä¸ºï¼š
$$
\mathcal{R}(\mathcal{F}) = \mathbb{E}_{\sigma} \sup_{f \in \mathcal{F}} \frac{1}{n} \sum_{i=1}^n \sigma_i f(x_i)
$$</p>
<p>KNAé€šè¿‡é™åˆ¶Keyçš„èŒƒæ•°ï¼Œå‡å°äº†å‡½æ•°ç±»$\mathcal{F}$çš„å¤æ‚åº¦ï¼Œä»è€Œå‡å°$\mathcal{R}(\mathcal{F})$ã€‚</p>
<p><strong>æ¨å¯¼24.1ï¼šæ³›åŒ–ç•Œ</strong></p>
<p>æ ¹æ®Rademacherå¤æ‚åº¦ç†è®ºï¼Œæ³›åŒ–è¯¯å·®æœ‰ç•Œï¼š
$$
\mathcal{E}_{gen} \leq 2\mathcal{R}(\mathcal{F}) + \sqrt{\frac{\log(1/\delta)}{2n}}
$$</p>
<p>å…¶ä¸­$n$æ˜¯è®­ç»ƒæ ·æœ¬æ•°ï¼Œ$\delta$æ˜¯ç½®ä¿¡åº¦ã€‚</p>
<p>KNAçš„è¾ƒå°$\mathcal{R}(\mathcal{F})$å¯¼è‡´æ›´å°çš„æ³›åŒ–ç•Œã€‚</p>
<h3 id="25">25. ä½ç½®ç¼–ç çš„å‚…é‡Œå¶åˆ†æ</h3>
<p><strong>å®šç†25.1ï¼šRoPEçš„é¢‘è°±ç‰¹æ€§</strong></p>
<p>RoPEå¯ä»¥çœ‹ä½œå‚…é‡Œå¶å˜æ¢çš„ä¸€ç§å½¢å¼ï¼š
$$
e^{i n \theta_k} = \cos(n\theta_k) + i\sin(n\theta_k)
$$</p>
<p>ä¸åŒçš„$\theta_k = 10000^{-2k/d}$å¯¹åº”ä¸åŒçš„é¢‘ç‡ã€‚</p>
<p><strong>æ¨å¯¼25.1ï¼šé«˜é¢‘ä¸ä½é¢‘çš„ä½ç½®åˆ†è¾¨ç‡</strong></p>
<p>å¯¹äº$\theta_k = 10000^{-2k/d}$ï¼š
- å½“$k \to 0$ï¼ˆé«˜é¢‘ï¼‰ï¼š$\theta_k \to 1$ï¼Œå‘¨æœŸ$T_k = 2\pi / \theta_k \approx 6.28$
- å½“$k \to d/2$ï¼ˆä½é¢‘ï¼‰ï¼š$\theta_k \to 10000^{-1}$ï¼Œå‘¨æœŸ$T_k \approx 62800$</p>
<p>é«˜é¢‘æˆåˆ†èƒ½å¤Ÿåˆ†è¾¨çŸ­è·ç¦»çš„ç›¸å¯¹ä½ç½®ï¼Œä½é¢‘æˆåˆ†èƒ½å¤Ÿåˆ†è¾¨é•¿è·ç¦»çš„ç›¸å¯¹ä½ç½®ã€‚</p>
<p><strong>æ¨å¯¼25.2ï¼šKNAä¸é¢‘è°±çš„äº¤äº’</strong></p>
<p>KNAä¸æ”¹å˜RoPEçš„é¢‘è°±ç»“æ„ï¼Œåªæ˜¯æ¶ˆé™¤äº†Keyæ¨¡é•¿çš„å½±å“ã€‚å› æ­¤ï¼š
$$
s_{KNA}(n-m) = \|\boldsymbol{q}_m\| \text{Re}\left[\sum_{k=0}^{d/2-1} q_k^* k_k e^{i(n-m)\theta_k}\right]
$$</p>
<p>å…¶ä¸­$q_k, k_k$æ˜¯Queryå’ŒKeyçš„é¢‘åŸŸç³»æ•°ï¼ˆå½’ä¸€åŒ–åï¼‰ã€‚</p>
<p>è¿™ä¿ç•™äº†RoPEçš„å¤šå°ºåº¦ä½ç½®æ„ŸçŸ¥èƒ½åŠ›ã€‚</p>
<h3 id="26">26. å®è·µå»ºè®®ä¸è¶…å‚æ•°è®¾ç½®</h3>
<p><strong>å»ºè®®26.1ï¼šKeyå½’ä¸€åŒ–çš„å®ç°</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># ä¼ªä»£ç </span>
<span class="n">k_norm</span> <span class="o">=</span> <span class="n">k</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">scores</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">k_norm</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
</code></pre></div>

<p>æ³¨æ„ï¼š
1. å½’ä¸€åŒ–åœ¨æœ€åä¸€ç»´ï¼ˆhead_dimï¼‰è¿›è¡Œ
2. ä½¿ç”¨<code>keepdim=True</code>ä¿æŒç»´åº¦ä¸€è‡´
3. æ•°å€¼ç¨³å®šæ€§ï¼šå¯ä»¥åŠ ä¸Šå°å¸¸æ•°$\epsilon$é˜²æ­¢é™¤é›¶</p>
<p><strong>å»ºè®®26.2ï¼šæ˜¯å¦åŒæ—¶å½’ä¸€åŒ–Query</strong></p>
<p>å®éªŒè¡¨æ˜ï¼š
- åªå½’ä¸€åŒ–Keyï¼ˆKNAï¼‰ï¼šæœ€ä½³é•¿åº¦å¤–æ¨æ•ˆæœ
- åŒæ—¶å½’ä¸€åŒ–Queryå’ŒKeyï¼ˆCosAï¼‰ï¼šæ•ˆæœæ¥è¿‘KNAï¼Œä½†éœ€è¦è°ƒæ•´æ¸©åº¦å‚æ•°
- åªå½’ä¸€åŒ–Queryï¼ˆQNAï¼‰ï¼šæ— é•¿åº¦å¤–æ¨æ•ˆæœ</p>
<p>æ¨èï¼š
- å¦‚æœä¸æƒ³è°ƒæ¸©åº¦å‚æ•°ï¼Œä½¿ç”¨KNA
- å¦‚æœèƒ½ç²¾ç»†è°ƒå‚ï¼ŒCosAå¯èƒ½ç•¥ä¼˜</p>
<p><strong>å»ºè®®26.3ï¼šä¸RoPEçš„ç»“åˆ</strong></p>
<p>KNAå¿…é¡»ä¸RoPEç»“åˆä½¿ç”¨æ‰èƒ½ä½“ç°é•¿åº¦å¤–æ¨æ•ˆæœï¼š
- KNA + RoPEï¼šæ˜¾è‘—å¤–æ¨æ•ˆæœ
- KNA + NoPEï¼šæ— å¤–æ¨æ•ˆæœ
- KNA + ALIBIï¼šæœªå……åˆ†æµ‹è¯•ï¼Œç†è®ºä¸Šæœ‰å†²çª</p>
<h3 id="27">27. æ³¨æ„åŠ›çŸ©é˜µçš„ç§©åˆ†æ</h3>
<p><strong>å®šä¹‰27.1ï¼šæ³¨æ„åŠ›çŸ©é˜µ</strong></p>
<p>$$
\boldsymbol{A} \in \mathbb{R}^{n \times n}, \quad A_{ij} = \alpha_{ij}
$$</p>
<p><strong>å®šç†27.1ï¼šKNAä¿æŒæ³¨æ„åŠ›çŸ©é˜µçš„ç§©</strong></p>
<p>æ ‡å‡†Attentionä¸­ï¼Œå¦‚æœæŸäº›Keyçš„æ¨¡é•¿è¿‡å¤§ï¼Œå¯èƒ½å¯¼è‡´æ³¨æ„åŠ›çŸ©é˜µé€€åŒ–ä¸ºä½ç§©ï¼š
$$
\text{rank}(\boldsymbol{A}) \ll n
$$</p>
<p>KNAé€šè¿‡å½’ä¸€åŒ–ä¿æŒå„ä½ç½®çš„ç«äº‰åŠ›ï¼Œç»´æŒè¾ƒé«˜çš„ç§©ï¼š
$$
\text{rank}(\boldsymbol{A}_{KNA}) \approx n
$$</p>
<p><strong>æ¨å¯¼27.1ï¼šä½ç§©é€€åŒ–çš„æœºåˆ¶</strong></p>
<p>å¦‚æœ$|\boldsymbol{k}_{j^<em>}| \gg |\boldsymbol{k}_j|$ for $j \neq j^</em>$ï¼Œåˆ™ï¼š
$$
\alpha_{i j^*} \approx 1, \quad \alpha_{ij} \approx 0, \quad \forall i
$$</p>
<p>æ³¨æ„åŠ›çŸ©é˜µè¿‘ä¼¼ä¸ºï¼š
$$
\boldsymbol{A} \approx \boldsymbol{1} \boldsymbol{e}_{j^*}^T
$$</p>
<p>è¿™æ˜¯ç§©1çŸ©é˜µã€‚</p>
<p>KNAæ¶ˆé™¤äº†è¿™ç§é€€åŒ–çš„å¯èƒ½æ€§ã€‚</p>
<h3 id="28">28. é•¿åº¦å¤–æ¨çš„å¿…è¦æ¡ä»¶</h3>
<p><strong>å®šç†28.1ï¼šæˆåŠŸé•¿åº¦å¤–æ¨çš„ä¸‰è¦ç´ </strong></p>
<ol>
<li><strong>ç›¸å¯¹ä½ç½®ç¼–ç </strong>ï¼šå¿…é¡»ä½¿ç”¨RoPEç­‰ç›¸å¯¹ä½ç½®ç¼–ç ï¼Œç»å¯¹ä½ç½®ç¼–ç æ— æ³•å¤–æ¨</li>
<li><strong>å……åˆ†çš„è§’åº¦è®­ç»ƒ</strong>ï¼š$\cos(\boldsymbol{q}_i, \boldsymbol{k}_j)$å¿…é¡»åœ¨è®­ç»ƒä¸­å……åˆ†ä¼˜åŒ–</li>
<li><strong>æ•°å€¼ç¨³å®šæ€§</strong>ï¼šæ³¨æ„åŠ›åˆ†æ•°ä¸èƒ½è¿‡å¤§ï¼Œé¿å…softmaxé¥±å’Œ</li>
</ol>
<p><strong>æ¨å¯¼28.1ï¼šä¸ºä½•ç»å¯¹ä½ç½®ç¼–ç æ— æ³•å¤–æ¨</strong></p>
<p>ç»å¯¹ä½ç½®ç¼–ç ï¼š
$$
\boldsymbol{q}_m = \boldsymbol{W}_Q (\boldsymbol{x}_m + \boldsymbol{p}_m)
$$</p>
<p>å…¶ä¸­$\boldsymbol{p}_m$æ˜¯ä½ç½®$m$çš„åµŒå…¥ã€‚</p>
<p>å½“$m &gt; L_{train}$æ—¶ï¼Œ$\boldsymbol{p}_m$ä»æœªè§è¿‡ï¼Œæ¨¡å‹æ— æ³•æ³›åŒ–ã€‚</p>
<p>ç›¸å¯¹ä½ç½®ç¼–ç ï¼š
$$
\boldsymbol{q}_m^T \boldsymbol{k}_n = f(m - n)
$$</p>
<p>åªè¦ç›¸å¯¹ä½ç½®$m - n$çš„æ¨¡å¼åœ¨è®­ç»ƒä¸­å­¦åˆ°ï¼Œå°±èƒ½å¤–æ¨ã€‚</p>
<p><strong>æ¨å¯¼28.2ï¼šKNAæ»¡è¶³æ‰€æœ‰ä¸‰è¦ç´ </strong></p>
<ol>
<li>âœ“ ä¸RoPEé…åˆï¼Œä¿ç•™ç›¸å¯¹ä½ç½®ç¼–ç </li>
<li>âœ“ å¼ºåˆ¶æ¨¡å‹å……åˆ†è®­ç»ƒ$\cos$</li>
<li>âœ“ å½’ä¸€åŒ–ä¿è¯æ•°å€¼ç¨³å®šæ€§</li>
</ol>
<p>å› æ­¤KNAèƒ½å¤ŸæˆåŠŸå®ç°é•¿åº¦å¤–æ¨ã€‚</p>
<h3 id="29-transformer">29. ä¸Transformeræ¶æ„å˜ä½“çš„å…¼å®¹æ€§</h3>
<p><strong>å…¼å®¹æ€§29.1ï¼šGAU (Gated Attention Unit)</strong></p>
<p>GAUä½¿ç”¨å•å¤´æ³¨æ„åŠ›ï¼š
$$
\boldsymbol{o} = (\boldsymbol{Z} \odot \text{Attention}(\boldsymbol{U})) \boldsymbol{V}
$$</p>
<p>KNAå¯ä»¥ç›´æ¥åº”ç”¨äºGAUçš„æ³¨æ„åŠ›éƒ¨åˆ†ï¼Œå®éªŒè¡¨æ˜æ•ˆæœæ˜¾è‘—ã€‚</p>
<p><strong>å…¼å®¹æ€§29.2ï¼šMulti-Query Attention (MQA)</strong></p>
<p>MQAä¸­æ‰€æœ‰Queryå¤´å…±äº«åŒä¸€ç»„Keyå’ŒValueï¼š
$$
\boldsymbol{K} = \boldsymbol{W}_K \boldsymbol{X}, \quad \text{æ‰€æœ‰å¤´å…±äº«}
$$</p>
<p>Keyå½’ä¸€åŒ–ä»ç„¶æœ‰æ•ˆï¼š
$$
\tilde{\boldsymbol{K}} = \boldsymbol{K} / \|\boldsymbol{K}\|_{\text{row}}
$$</p>
<p><strong>å…¼å®¹æ€§29.3ï¼šGrouped-Query Attention (GQA)</strong></p>
<p>GQAæ˜¯MQAçš„æ³›åŒ–ï¼Œå¤šä¸ªQueryå¤´å…±äº«ä¸€ç»„Key-Valueã€‚KNAåŒæ ·é€‚ç”¨ã€‚</p>
<h3 id="30">30. æ€»ç»“ä¸å±•æœ›</h3>
<p><strong>æ€»ç»“30.1ï¼šKeyå½’ä¸€åŒ–çš„æ ¸å¿ƒæ´å¯Ÿ</strong></p>
<p>Keyå½’ä¸€åŒ–é€šè¿‡ä¸€ä¸ªç®€å•çš„æ“ä½œâ€”â€”å°†Keyå‘é‡å½’ä¸€åŒ–åˆ°å•ä½çƒé¢â€”â€”å®ç°äº†æ˜¾è‘—çš„é•¿åº¦å¤–æ¨æ•ˆæœã€‚å…¶æ ¸å¿ƒæœºåˆ¶æ˜¯ï¼š</p>
<ol>
<li><strong>æ¶ˆé™¤æ·å¾„</strong>ï¼šå»é™¤Keyæ¨¡é•¿è¿™ä¸€"ç®€å•è·¯å¾„"ï¼Œå¼ºåˆ¶æ¨¡å‹ä¼˜åŒ–æ›´æœ¬è´¨çš„è§’åº¦ä¿¡æ¯</li>
<li><strong>å……åˆ†è®­ç»ƒ</strong>ï¼šä½¿$\cos(\boldsymbol{q}_i, \boldsymbol{k}_j)$å¾—åˆ°å……åˆ†è®­ç»ƒï¼Œå¢å¼ºæ³›åŒ–èƒ½åŠ›</li>
<li><strong>æ•°å€¼ç¨³å®š</strong>ï¼šæœ‰ç•Œçš„æ³¨æ„åŠ›åˆ†æ•°ä¿è¯è®­ç»ƒå’Œæ¨ç†çš„ç¨³å®šæ€§</li>
<li><strong>ä¿æŒæ’ç­‰</strong>ï¼šæ¨ç†æ—¶æ— éœ€ä¿®æ”¹ï¼Œåœ¨è®­ç»ƒé•¿åº¦å†…ä¿æŒåŸå§‹æ€§èƒ½</li>
</ol>
<p><strong>å±•æœ›30.2ï¼šæœªæ¥ç ”ç©¶æ–¹å‘</strong></p>
<ol>
<li><strong>ç†è®ºå®Œå–„</strong>ï¼šè¿›ä¸€æ­¥å»ºç«‹Keyå½’ä¸€åŒ–ä¸é•¿åº¦å¤–æ¨çš„ä¸¥æ ¼ç†è®ºè”ç³»</li>
<li><strong>å¤§è§„æ¨¡éªŒè¯</strong>ï¼šåœ¨æ›´å¤§è§„æ¨¡çš„LLMä¸ŠéªŒè¯æ•ˆæœï¼ˆæ•°åäº¿ã€åƒäº¿å‚æ•°ï¼‰</li>
<li><strong>å¤šæ¨¡æ€æ‰©å±•</strong>ï¼šå°†KNAåº”ç”¨äºè§†è§‰ã€éŸ³é¢‘ç­‰å¤šæ¨¡æ€åœºæ™¯</li>
<li><strong>ä¼˜åŒ–ç®—æ³•</strong>ï¼šè®¾è®¡é’ˆå¯¹KNAçš„ä¸“ç”¨ä¼˜åŒ–ç®—æ³•</li>
<li><strong>ç¡¬ä»¶åŠ é€Ÿ</strong>ï¼šå¼€å‘é’ˆå¯¹å½’ä¸€åŒ–æ“ä½œçš„é«˜æ•ˆç¡¬ä»¶å®ç°</li>
</ol>
<p><strong>ç†è®ºæ„ä¹‰</strong>ï¼šKeyå½’ä¸€åŒ–æ­ç¤ºäº†Attentionæœºåˆ¶ä¸­æ¨¡é•¿ä¸æ–¹å‘çš„ä¸åŒä½œç”¨ï¼Œä¸ºç†è§£å’Œæ”¹è¿›Transformeræä¾›äº†æ–°è§†è§’ã€‚</p>
<p><strong>å®è·µä»·å€¼</strong>ï¼šä½œä¸ºä¸€ä¸ªç®€å•ã€æœ‰æ•ˆã€æ˜“äºå®ç°çš„æ–¹æ³•ï¼ŒKNAä¸ºé•¿æ–‡æœ¬å»ºæ¨¡æä¾›äº†æ–°çš„å·¥å…·ï¼Œç‰¹åˆ«é€‚åˆèµ„æºæœ‰é™ä½†éœ€è¦é•¿åº¦å¤–æ¨çš„åœºæ™¯ã€‚</p>
        </div>
    </div>
</body>
</html>