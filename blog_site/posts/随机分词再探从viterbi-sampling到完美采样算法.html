<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éšæœºåˆ†è¯å†æ¢ï¼šä»Viterbi Samplingåˆ°å®Œç¾é‡‡æ ·ç®—æ³•</title>
    <style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    line-height: 1.6; color: #333; max-width: 900px; margin: 0 auto; padding: 20px; background: #f5f5f5;
}
.container { background: white; padding: 40px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
header { border-bottom: 2px solid #e0e0e0; padding-bottom: 20px; margin-bottom: 30px; }
h1 { color: #2c3e50; margin-bottom: 10px; font-size: 2em; }
.meta { color: #666; font-size: 0.9em; margin-bottom: 20px; }
.content { margin-top: 30px; overflow-wrap: break-word; }
.content h2 { color: #34495e; margin-top: 30px; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
.content p { margin-bottom: 15px; }
.content pre { background: #f8f8f8; padding: 15px; border-radius: 5px; overflow-x: auto; border-left: 3px solid #3498db; margin: 15px 0; }
.content code { background: #f8f8f8; padding: 2px 5px; border-radius: 3px; font-family: monospace; font-size: 0.9em; }
.content blockquote { border-left: 4px solid #3498db; padding-left: 20px; margin: 20px 0; color: #555; font-style: italic; }
.content table { border-collapse: collapse; width: 100%; margin: 20px 0; }
.content th, .content td { border: 1px solid #ddd; padding: 10px; text-align: left; }
.back-link { display: inline-block; margin-bottom: 20px; color: #3498db; text-decoration: none; font-weight: 500; }
</style>
    
<script>
    window.MathJax = {
        tex: {
            inlineMath: [['$', '$'], ['\(', '\)']],
            displayMath: [['$$', '$$'], ['\[', '\]']],
            processEscapes: true
        }
    };
</script>
<script id="MathJax-script" async src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>

</head>
<body>
    <div class="container">
        <a href="../index.html" class="back-link">â† è¿”å›é¦–é¡µ</a>
        <header>
            <h1>éšæœºåˆ†è¯å†æ¢ï¼šä»Viterbi Samplingåˆ°å®Œç¾é‡‡æ ·ç®—æ³•</h1>
            <div class="meta">ğŸ“… æœ€åæ›´æ–°: 2026-01-05 | ğŸ“„ å¤§å°: 49.6 KB</div>
        </header>
        <div class="content">
            <p><strong>åŸæ–‡é“¾æ¥</strong>: <a href="https://spaces.ac.cn/archives/9811">https://spaces.ac.cn/archives/9811</a></p>
<p><strong>å‘å¸ƒæ—¥æœŸ</strong>: </p>
<hr />
<p>åœ¨æ–‡ç« <a href="/archives/9768">ã€Šéšæœºåˆ†è¯æµ…æ¢ï¼šä»Viterbi Decodingåˆ°Viterbi Samplingã€‹</a>ä¸­ï¼Œç¬”è€…æå‡ºäº†ä¸€ç§åä¸ºâ€œViterbi Samplingâ€çš„éšæœºåˆ†è¯ç®—æ³•ï¼Œå®ƒåªæ˜¯åœ¨æ±‚æœ€ä¼˜è§£çš„Viterbi DecodingåŸºç¡€ä¸Šè¿›è¡Œå°ä¿®æ”¹ï¼Œä¿ç•™äº†Viterbiç®—æ³•çš„ç®€å•å¿«é€Ÿçš„ç‰¹ç‚¹ï¼Œç›¸æ¯”äºå·²æœ‰çš„<a href="https://papers.cool/arxiv/1804.10959">Subword Regularization</a>æ˜æ˜¾æ›´åŠ é«˜æ•ˆã€‚ä¸è¿‡ï¼ŒçŸ¥ä¹ä¸Šçš„è¯»è€… <a href="https://www.zhihu.com/people/11f5cd888268129be2b1d9b298387f0d">@é¶´èˆ</a> æŒ‡å‡ºï¼Œå½“å‰çš„é‡‡æ ·ç®—æ³•å¯èƒ½ä¼šåœ¨å¤šæ¬¡äºŒé€‰ä¸€â€œç¨€é‡Šâ€äº†éƒ¨åˆ†æ–¹æ¡ˆçš„å‡ºç°æ¦‚ç‡ï¼Œç›´æ¥åæœæ˜¯åŸæœ¬åˆ†æ•°æœ€é«˜çš„åˆ‡åˆ†å¹¶ä¸æ˜¯ä»¥æœ€é«˜æ¦‚ç‡å‡ºç°ã€‚</p>
<p>ç»è¿‡ä»”ç»†æ€è€ƒåï¼Œç¬”è€…å‘ç°ç›¸åº”çš„é—®é¢˜ç¡®å®å­˜åœ¨ï¼Œå½“æ—¶ä¸ºäº†å°½å¿«å¾—åˆ°ä¸€ç§æ–°çš„é‡‡æ ·ç®—æ³•ï¼Œåœ¨ç»†èŠ‚ä¸Šçš„æ€è€ƒå’Œå¤„ç†ç¡®å®æ¯”è¾ƒç²—ç³™ã€‚ä¸ºæ­¤ï¼Œæœ¬æ–‡å°†è¿›ä¸€æ­¥å®Œå–„Viterbi Samplingç®—æ³•ï¼Œå¹¶è¯æ˜å®Œå–„åçš„ç®—æ³•åœ¨æ•ˆæœä¸Šå¯ä»¥è·ŸSubword Regularizationç­‰ä»·çš„ã€‚</p>
<h2 id="_1">é—®é¢˜åˆ†æ</h2>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹<a href="https://zhuanlan.zhihu.com/p/658440073">è¯„è®ºåŸè¯</a>ï¼š</p>
<blockquote>
<p>subword regularizationä¸­å¯ä»¥ä¿è¯æŒ‰æ¦‚ç‡æ•°æ®ï¼ˆå…·æœ‰temperatureè¶…å‚æ•°ï¼‰ã€‚æå‡ºçš„æ–¹æ³•ä¸­å¯¹äºæ¯ä¸ªeï¼Œç¬¬ä¸€ä¸ªç®—å‡ºçš„routeä¼šè¢«å¤šæ¬¡1v1â€œæŒ‘æˆ˜â€ï¼Œæœ€ç»ˆæ¦‚ç‡åˆ†å¸ƒä¼šä¸ä¼šå’Œå·²æœ‰ç®—æ³•å·®è›®å¤šçš„ã€‚ ä¸¾ä¸ªä¾‹å­ï¼Œwatchingä¸‰ç§åˆ†æ³•watch ingï¼Œwat chingï¼Œå’Œw atchingæ¦‚ç‡éƒ½æ˜¯ä¸‰åˆ†ä¹‹ä¸€ï¼Œæå‡ºçš„æ–¹æ¡ˆçš„é‡‡æ ·æ¦‚ç‡æ¦‚ç‡å°±ä¼šå˜æˆï¼Œå‰ä¸¤ä¸ªçš„æ¦‚ç‡æ˜¯å››åˆ†ä¹‹ä¸€ï¼Œç¬¬ä¸‰ä¸ªçš„æ¦‚ç‡æ˜¯äºŒåˆ†ä¹‹ä¸€ï¼Œæ˜¯è¿™æ ·çš„å—ï¼Ÿ</p>
</blockquote>
<p>å…¶å®è¯„è®ºé‡Œè¾¹å·²ç»è¯´å¾—å¾ˆæ¸…æ™°äº†ï¼Œå¦‚æœè¯»è€…è¿˜ä¸ç†è§£çš„è¯ï¼Œè¿™é‡Œç¬”è€…ç¨å¾®å†å±•å¼€ä¸€ä¸‹ã€‚å‡è®¾æœ‰ä¸‰ç§åˆ‡åˆ†æ–¹æ¡ˆï¼Œæ¯ç§æ–¹æ¡ˆçš„å¾—åˆ†éƒ½ä¸€æ ·ï¼Œé‚£ä¹ˆæˆ‘ä»¬è‡ªç„¶æ˜¯æœŸæœ›é‡‡æ ·è¿‡ç¨‹ä¸­æ¯ç§æ–¹æ¡ˆçš„å‡ºç°æ¦‚ç‡éƒ½æ˜¯$1/3$ã€‚ç„¶è€Œï¼ŒViterbi Samplingæ˜¯å°†å¤šé€‰ä¸€çš„é‡‡æ ·è¿‡ç¨‹è½¬åŒ–ä¸ºå¤šæ­¥çš„äºŒé€‰ä¸€ï¼š<br />
\begin{equation}<br />
r_i = \left\{\begin{aligned}&amp;\,1\,, \,\, s_i &gt; s_{i-1} \\\<br />
&amp;\,0\,, \,\, \text{else}\end{aligned}\right.\qquad\longrightarrow\qquad<br />
r_i = \left\{\begin{aligned}&amp;\,1\,, \,\, \varepsilon &lt; \sigma(\alpha(s_i - s_{i-1})) \\\<br />
&amp;\,0\,, \,\, \text{else}\end{aligned}\right.<br />
\end{equation}<br />
è¿™æ ·ä¸€æ¥ï¼Œå‰é¢çš„ä¸¤ç§åˆ‡åˆ†æ–¹æ¡ˆå…ˆäºŒé€‰ä¸€ï¼Œæ¦‚ç‡éƒ½æ˜¯$\frac{1/3}{1/3+1/3}=1/2$ï¼›é€‰å‡ºæ¥ä¸€ä¸ªç»“æœä¹‹åï¼Œåˆè·Ÿç¬¬ä¸‰ç§æ–¹æ¡ˆæ”¾ä¸€èµ·æ¥äºŒé€‰ä¸€ï¼Œç”±äºæ¦‚ç‡æ˜¯æŒ‰ç…§å„è‡ªå¾—åˆ†æ¥ç®—çš„ï¼Œæ‰€ä»¥è¿™æ—¶å€™å„è‡ªçš„æ¦‚ç‡è¿˜æ˜¯$1/2$ã€‚äºæ˜¯ï¼Œåœ¨å®Œæ•´çš„é‡‡æ ·è¿‡ç¨‹ä¸­ï¼Œå‰ä¸¤ç§æ–¹æ¡ˆå‡ºç°çš„æ¦‚ç‡æ˜¯$1/4$ï¼Œåä¸€ç§æ–¹æ¡ˆå‡ºç°çš„æ¦‚ç‡æ˜¯$1/2$ï¼Œè¶Šæ™šå‡ºç°çš„æ–¹æ¡ˆç›¸å¯¹æ¥è¯´è¶Šâ€œå ä¾¿å®œâ€ï¼Œè€Œè¶Šæ—©å‡ºç°çš„æ–¹æ¡ˆæ¦‚ç‡è¢«ç¨€é‡Šå¾—è¶Šä¸¥é‡ã€‚è€Œå¾ˆä¸å·§çš„æ˜¯ï¼ŒæŒ‰ç…§BytePieceçš„ACè‡ªåŠ¨æœºçš„è¿”å›é¡ºåºï¼Œè¶Šé•¿çš„è¯ï¼ˆé€šå¸¸æ¥è¯´å¾—åˆ†è¶Šé«˜ï¼‰å‡ºç°çš„æ¬¡åºä¼šè¶Šé å‰ï¼Œæ‰€ä»¥åœ¨Viterbi Samplingä¸­ï¼Œå¾—åˆ†è¶Šé«˜çš„æ–¹æ¡ˆåè€Œæ›´å®¹æ˜“è¢«ç¨€é‡Šæ¦‚ç‡ã€‚</p>
<h2 id="_2">è§£å†³åŠæ³•</h2>
<p>ç°åœ¨çœ‹æ¥ï¼Œå…¶å®è§£å†³åŠæ³•ä¹Ÿå¾ˆç®€å•ï¼Œæ¯æ¬¡è¿›è¡ŒäºŒé€‰ä¸€åï¼ŒåŒæ—¶ç¼“å­˜ç´¯ç§¯æ¦‚ç‡å°±å¯ä»¥äº†ï¼Œè€Œä»ç¬¬äºŒæ­¥å¼€å§‹ï¼Œæ¯æ¬¡äºŒé€‰ä¸€æ—¶æ–°è¿›æ¥çš„å€™é€‰è€…ä¸æ˜¯è·Ÿå·²æœ‰å€™é€‰è€…å¾—åˆ†äºŒé€‰ä¸€ï¼Œè€Œæ˜¯è·Ÿç´¯ç§¯æ¦‚ç‡å¾—åˆ†äºŒé€‰ä¸€ï¼Œè¿™å°±æ˜¯ä¿—ç§°â€œ<a href="https://en.wikipedia.org/wiki/Reservoir_sampling">æ°´å¡˜é‡‡æ ·ï¼ˆReservoir samplingï¼‰</a>â€çš„ç®—æ³•ã€‚</p>
<p>ç”¨å‰é¢çš„ä¾‹å­æ¥è¯´ï¼Œå…ˆè¿›æ¥ä¸¤ç§åˆ‡åˆ†æ–¹æ¡ˆï¼ŒæŒ‰ç…§$\frac{1/3}{1/3+1/3}=1/2$çš„æ¦‚ç‡é€‰å‡ºä¸€ç§ï¼Œç„¶åå®ƒä»¬æ€»çš„ç´¯ç§¯æ¦‚ç‡æ˜¯$2/3$ï¼›æ¥ä¸‹æ¥è¢«é€‰è€…è·Ÿæ–°æ–¹æ¡ˆé€‰ä¸€ï¼Œæ–°å‡ºç°çš„æ–¹æ¡ˆè¢«é€‰åˆ°çš„æ¦‚ç‡åº”è¯¥æ˜¯$\frac{1/3}{2/3+1/3}=1/3$ï¼Œä¹Ÿå°±æ˜¯è¯´è¦è·Ÿç´¯ç§¯æ¦‚ç‡æ¯”ï¼Œè€Œä¸æ˜¯è·Ÿè¢«é€‰è€…è‡ªå·±çš„æ¦‚ç‡æ¯”ï¼Œè¿™æ ·å®Œæ•´çš„é‡‡æ ·æµç¨‹ä¸‹æ¥ï¼Œæ¯ç§åˆ‡åˆ†æ–¹æ¡ˆå‡ºç°çš„æ¦‚ç‡éƒ½æ˜¯$1/3$ã€‚</p>
<p>å¯¹äºViterbi Samplingæ¥è¯´ï¼Œæ¯ä¸ªç»ˆç‚¹ä½ç½®ä¼šæœ‰å¤šä¸ªåˆ‡åˆ†æ–¹æ¡ˆï¼Œæˆ‘ä»¬è¦å¯¹å…¶è¿›è¡Œå¤šé€‰ä¸€é‡‡æ ·ï¼Œè¢«é€‰ä¸­çš„æ¦‚ç‡æ˜¯ç”±å„è‡ªçš„å¾—åˆ†æ„é€ å‡ºæ¥çš„$p_i = e^{\alpha s_i}/Z$ï¼Œ$Z$æ˜¯å½’ä¸€åŒ–å› å­ã€‚å› ä¸ºæˆ‘ä»¬æ˜¯é€’å½’å¤„ç†çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸çŸ¥é“å¤šé€‰ä¸€çš„â€œå¤šâ€æ˜¯å¤šå°‘ï¼Œä¹Ÿæ— æ³•è®¡ç®—$Z$ï¼Œä¸è¿‡è¿™ä¸é‡è¦ï¼ŒçŸ¥é“$e^{\alpha s_i}$å°±å¤Ÿäº†ï¼Œå› ä¸ºè®¡ç®—æ¯ä¸€æ­¥çš„æ¡ä»¶é‡‡æ ·æ¦‚ç‡å…¶å®ä¹Ÿç”¨ä¸åˆ°å®Œæ•´çš„$Z$ï¼Œè€Œæ˜¯éœ€è¦é€’å½’çš„$Z_i$ï¼š<br />
\begin{array}{c|c|c}<br />
\hline<br />
\text{Viterbi Decoding} &amp; \text{æ—§ç‰ˆ Viterbi Sampling} &amp; \text{æ–°ç‰ˆ Viterbi Sampling} \\\<br />
\hline<br />
r_i = \left\{\begin{aligned}&amp;\,1\,, \,\, s_i &gt; s_{i-1} \\\<br />
&amp;\,0\,, \,\, \text{else}\end{aligned}\right. &amp;<br />
r_i = \left\{\begin{aligned}&amp;\,1\,, \,\, \varepsilon &lt; \sigma(\alpha(s_i - s_{i-1})) \\\<br />
&amp;\,0\,, \,\, \text{else}\end{aligned}\right. &amp;<br />
\begin{aligned}Z_i =&amp;\, Z_{i - 1} + e^{\alpha s_i} \\\[1pt]<br />
r_i =&amp;\, \left\{\begin{aligned}&amp;\,1\,, \,\, \varepsilon &lt; e^{\alpha s_i} / Z_i \\\<br />
&amp;\,0\,, \,\, \text{else}\end{aligned}\right.\end{aligned} \\\<br />
\hline<br />
\end{array}<br />
å®é™…è®¡ç®—æ—¶ï¼Œç”±äºæŒ‡æ•°çˆ†ç‚¸çš„åŸå› ï¼Œç›´æ¥ç¼“å­˜$Z_i$å¤§æ¦‚ç‡ä¼šæœ‰æº¢å‡ºé£é™©ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸€èˆ¬ç¼“å­˜çš„æ˜¯å®ƒçš„å¯¹æ•°$Z^{\log}<em i-1="i-1">i$ï¼Œå¹¶åˆ©ç”¨$\text{logsumexp}$å‡½æ•°é¿å…æº¢å‡ºï¼š<br />
\begin{equation}<br />
\begin{aligned}&amp;\,Z^{\log}_i = \text{logsumexp}(Z^{\log}</em>, \alpha s_i) \\\<br />
&amp;\qquad e^{\alpha s_i} / Z_i \to e^{\alpha s_i - Z^{\log}_i}<br />
\end{aligned},\qquad \text{logsumexp}(x,y) = \left\{\begin{aligned}&amp;\,x + \log(1+e^{y-x}),\,\, x \geq y \\\<br />
&amp;\,y + \log(1 + e^{x-y}),\,\,x &lt; y<br />
\end{aligned}\right.<br />
\end{equation}<br />
ç›¸åº”çš„å®ç°å·²ç»å†…ç½®åœ¨<code>bytepiece&gt;=0.5.0</code>ä¸­ã€‚</p>
<h2 id="_3">å®Œç¾é‡‡æ ·</h2>
<p>æ€»çš„æ¥è¯´ï¼Œå‡ºç°æ—§ç‰ˆViterbi Samplingçš„ç¼ºé™·ï¼Œè¿˜æ˜¯å› ä¸ºä¹‹å‰æ“ä¹‹è¿‡æ€¥äº†ï¼Œæ‰€ä»¥ç°åœ¨è®¤çœŸåœ°ç»™æ–°ç‰ˆViterbi Samplingè¡¥ä¸Šæ•°å­¦è¯æ˜ã€‚æœ‰æ„æ€çš„æ˜¯ï¼Œå¯ä»¥è¯æ˜æ›´æ–°åçš„Viterbi Samplingè·ŸSubword Regularizationä¸€æ ·éƒ½æ˜¯â€œå®Œç¾é‡‡æ ·â€ç®—æ³•ã€‚</p>
<p>ä¹‹å‰æˆ‘ä»¬ä»‹ç»è¿‡ï¼ŒSubword Regularizationçš„åšæ³•éå¸¸â€œç²—æš´â€ï¼Œç›´æ¥æ‰¾å‡ºå¾—åˆ†æœ€é«˜çš„$k$ä¸ªåˆ‡åˆ†æ–¹æ¡ˆï¼Œç„¶åé€šè¿‡$p_i = e^{\alpha s_i}/Z$çš„æ–¹å¼è®¡ç®—è¢«é€‰ä¸­çš„æ¦‚ç‡ï¼Œå…¶ä¸­$s_i$æ˜¯ç¬¬$i$ç§æ–¹æ¡ˆçš„å¾—åˆ†ã€‚è¿™ç§åšæ³•é™¤äº†å¤æ‚åº¦é«˜å¤–æ²¡æœ‰ä»»ä½•æ¯›ç—…ï¼Œå½“$k$ä¸åšé™åˆ¶ï¼ˆå³æ‰¾å‡ºå…¨éƒ¨åˆ‡åˆ†æ–¹æ¡ˆï¼‰æ—¶ï¼Œæˆ‘ä»¬å¾—åˆ° <em>æ‰€æœ‰åˆ‡åˆ†æ–¹æ¡ˆçš„ä¸€ä¸ªéšæœºé‡‡æ ·</em> ï¼Œè€Œæ¯ç§æ–¹æ¡ˆè¢«é‡‡æ ·åˆ°çš„æ¦‚ç‡æ­£æ¯”äº$e^{\alpha s_i}$â€”â€”æ˜¯å¾—åˆ†$s_i$çš„å•è°ƒå¢å‡½æ•°ï¼Œå³ <em>é‡‡æ ·æ¦‚ç‡ä¸å¾—åˆ†çš„å¤§å°æ’åºéƒ½æ˜¯ä¸€æ ·çš„</em> ï¼Œæ»¡è¶³è¿™ä¸¤ä¸ªæ¡ä»¶çš„ï¼Œç¬”è€…ç§°ä¹‹ä¸ºâ€œå®Œç¾é‡‡æ ·â€ã€‚</p>
<h3 id="decoding">Decoding</h3>
<p>ä¸ºäº†è¯æ˜æ–°ç‰ˆViterbi Samplingä¹Ÿæ˜¯â€œå®Œç¾é‡‡æ ·â€ï¼Œæˆ‘ä»¬å…ˆæ¥å›é¡¾ä¸€ä¸‹Viterbi Decodingã€‚è®¾æœ‰ä¸€ä¸ªé•¿åº¦ä¸º$l$çš„å­—èŠ‚ä¸²$c_1,c_2,\cdots,c_l$ï¼Œç”¨$S^<em>(c_1,c_2,\cdots,c_l)$è¡¨ç¤ºæœ€ä¼˜åˆ‡åˆ†æ–¹æ¡ˆçš„å¾—åˆ†ï¼Œå‡è®¾æˆ‘ä»¬çŸ¥é“$c_k,c_{k+1}$ä¹‹é—´ä¸€å®šä¼šåˆ†å¼€ï¼Œé‚£ä¹ˆå¿…ç„¶æœ‰<br />
\begin{equation}S^</em>(c_1,c_2,\cdots,c_l) = S^<em>(c_1,c_2,\cdots,c_k) + S^</em>(c_{k+1},c_{k+2},\cdots,c_l)\end{equation}<br />
ä¹Ÿå°±æ˜¯è¯´ï¼Œæœ€ä¼˜åˆ‡åˆ†æ–¹æ¡ˆçš„å­ä¸²ï¼Œä¸€å®šä¹Ÿæ˜¯å¯¹åº”çš„å­å­—èŠ‚ä¸²çš„æœ€ä¼˜åˆ‡åˆ†æ–¹æ¡ˆï¼Œè¿™æ˜¯åŠ¨æ€è§„åˆ’çš„æ ¹æœ¬ä¾æ®ã€‚å½“ç„¶ï¼Œäº‹å®ä¸Šæˆ‘ä»¬ä¸èƒ½é¢„çŸ¥å“ªä¸€å¤„ä¼šè¢«åˆ‡å¼€ï¼Œæ‰€ä»¥åªèƒ½ç”¨æšä¸¾çš„æ–¹å¼ï¼š<br />
\begin{equation}S^<em>(c_1,c_2,\cdots,c_l) = \max\left\{\begin{aligned}<br />
&amp;\,\color{green}{s\left(\overline{c_1,\cdots,c_l}\right)} \\\<br />
\color{red}{S^</em>(c_1)} \,+&amp;\, \color{green}{s\left(\overline{c_2,\cdots,c_l}\right)} \\\<br />
\color{red}{S^<em>(c_1,c_2)} \,+&amp;\, \color{green}{s\left(\overline{c_3,\cdots,c_l}\right)} \\\<br />
\vdots \\\<br />
\color{red}{S^</em>(c_1,\cdots,c_{l-2})} \,+&amp;\, \color{green}{s\left(\overline{c_{l-1},c_l}\right)} \\\<br />
\color{red}{S^<em>(c_1,\cdots,c_{l-1})} \,+&amp;\, \color{green}{s\left(\overline{c_l}\right)}<br />
\end{aligned}\right\}\label{eq:core}\end{equation}<br />
å…¶ä¸­$s\left(\overline{c_1,\cdots,c_l}\right)$æ˜¯æŒ‡å­—èŠ‚ä¸²$c_1, \cdots,c_l$ä½œä¸ºä¸€ä¸ªtokenæ—¶çš„å¾—åˆ†ï¼ˆå¦‚æœå®ƒä¸æ˜¯è¯è¡¨ä¸­çš„tokenï¼Œé‚£ä¹ˆè®°ä¸º$-\infty$ï¼‰ã€‚è¿™æ ·ä¸€æ¥ï¼Œ$S^</em>(c_1,c_2,\cdots,c_l)$çš„è®¡ç®—å°±è½¬åŒ–ä¸º$S^<em>(c_1),S^</em>(c_1,c_2),\cdots,S^<em>(c_1,\cdots,c_{l-1})$çš„è®¡ç®—ï¼Œä¾æ­¤ç±»æ¨ï¼Œ$S^</em>(c_1,c_2,\cdots,c_{l-1})$çš„è®¡ç®—åˆå¯ä»¥è½¬åŒ–ä¸º$S^<em>(c_1),S^</em>(c_1,c_2),\cdots,S^<em>(c_1,\cdots,c_{l-2})$çš„è®¡ç®—ï¼Œç­‰ç­‰ï¼Œä¹Ÿå°±æ˜¯$S^</em>$çš„ç»“æœæ˜¯å¯ä»¥å¤ç”¨çš„ã€‚æ‰€ä»¥ï¼Œæ•´ä¸ªæµç¨‹æ€»ç»“ä¸‹æ¥å°±æ˜¯ä¸€å¥è¯ï¼š</p>
<blockquote>
<p>æ‰«æåˆ°æ¯ä¸€ä¸ªä½ç½®æ—¶ï¼Œéƒ½è®°å½•åˆ°å½“å‰ä½ç½®çš„æœ€ä¼˜åˆ‡åˆ†æ–¹æ¡ˆåŠå…¶å¾—åˆ†ã€‚</p>
</blockquote>
<p>å½“ç„¶ï¼Œç›´æ¥æŒ‰ç…§å¼$\eqref{eq:core}$è¿›è¡Œé€’å½’çš„è¯ï¼Œç†è®ºä¸Šå¤æ‚åº¦æ˜¯$\mathcal{O}(l^2)$ï¼Œä½†äº‹å®ä¸Šä¸å¯èƒ½æ¯ä¸ªå­å­—èŠ‚ä¸²éƒ½æ˜¯è¯è¡¨ä¸­çš„ä¸€ä¸ªtokenï¼Œæ‰€ä»¥å¯ä»¥ç”¨Trieæ ‘ã€ACè‡ªåŠ¨æœºç­‰æ–¹æ³•æ ¹æ®è¯è¡¨æå‰æ‰«æå¥½æ‰€æœ‰å¯èƒ½å‡ºç°çš„tokenï¼Œé‚£ä¹ˆå¤æ‚åº¦å°±æ­£æ¯”äºæœç´¢å‡ºæ¥çš„å€™é€‰tokenæ•°ï¼Œå…³äº$l$æ˜¯çº¿æ€§çš„ï¼Œå¦‚æœéè¦ä¼°è®¡ä¸€ä¸ªæ•°å€¼ï¼Œé‚£ä¹ˆå‡è®¾è¯è¡¨ä¸­tokençš„æœ€å¤§é•¿åº¦ä¸º$m$ï¼Œé‚£ä¹ˆé•¿åº¦ä¸º$l\geq m$çš„å­—èŠ‚ä¸²æ‰«æå‡ºæ¥çš„tokenæ•°å°±ä¸è¶…è¿‡<br />
\begin{equation}l + (l - 1) + \cdots + (l - m + 1) = lm - \frac{1}{2}m(m-1) = \mathcal{O}(lm)\end{equation}</p>
<h3 id="sampling">Sampling</h3>
<p>æœ‰äº†Decodingéƒ¨åˆ†åšé“ºå«åï¼Œç†è§£Samplingå°±ç›¸å¯¹å®¹æ˜“ä¸€äº›äº†ã€‚å…¶å®å…³é”®è¿˜æ˜¯åœ¨å¼$\eqref{eq:core}$ï¼Œæˆ‘ä»¬ç”¨$Z(c_1,c_2,\cdots,c_l)$è¡¨ç¤ºå­—èŠ‚ä¸²$c_1,c_2,\cdots,c_l$çš„æ‰€æœ‰åˆ‡åˆ†æ–¹æ¡ˆçš„å½’ä¸€åŒ–å› å­ï¼ˆå®Œç¾é‡‡æ ·ï¼‰ï¼Œé‚£ä¹ˆæœ‰<br />
\begin{equation}Z(c_1,c_2,\cdots,c_l) = \sum\left\{\begin{aligned}<br />
&amp;\,\color{green}{e^{\alpha\cdot s\left(\overline{c_1,\cdots,c_l}\right)}} \\\<br />
\color{red}{Z(c_1)} &amp;\, \color{green}{e^{\alpha\cdot s\left(\overline{c_2,\cdots,c_l}\right)}} \\\<br />
\color{red}{Z(c_1,c_2)} &amp;\, \color{green}{e^{\alpha\cdot s\left(\overline{c_3,\cdots,c_l}\right)}} \\\<br />
\vdots \\\<br />
\color{red}{Z(c_1,\cdots,c_{l-2})} &amp;\, \color{green}{e^{\alpha\cdot s\left(\overline{c_{l-1},c_l}\right)}} \\\<br />
\color{red}{Z(c_1,\cdots,c_{l-1})} &amp;\, \color{green}{e^{\alpha\cdot s\left(\overline{c_l}\right)}}<br />
\end{aligned}\right\}\label{eq:core-2}<br />
\end{equation}<br />
è¿™ä¸ªç­‰å¼ä¹Ÿè¡¨æ˜ï¼Œè¦å®ç°ä»$c_1,c_2,\cdots,c_l$çš„æ‰€æœ‰åˆ‡åˆ†æ–¹æ¡ˆä¸­æŒ‰$e^{\alpha s}$çš„æ¯”é‡é‡‡æ ·ï¼Œå¯ä»¥ä»$c_1,\cdots,c_{l-1}$çš„æ‰€æœ‰åˆ‡åˆ†æ–¹æ¡ˆä¸­éšæœºé€‰ä¸€ä¸ªç„¶åæ¥ä¸Štoken $\overline{c_l}$ã€ä»$c_1,\cdots,c_{l-2}$çš„æ‰€æœ‰åˆ‡åˆ†æ–¹æ¡ˆä¸­éšæœºé€‰ä¸€ä¸ªç„¶åæ¥ä¸Štoken $\overline{c_{l-1},c_l}$ã€ä»$c_1,\cdots,c_{l-3}$çš„æ‰€æœ‰åˆ‡åˆ†æ–¹æ¡ˆä¸­éšæœºé€‰ä¸€ä¸ªç„¶åæ¥ä¸Štoken $\overline{c_{l-2},c_{l-1},c_l}$ã€...ï¼Œå¾—åˆ°è¿™$l$ä¸ªé‡‡æ ·ç»“æœåï¼Œåˆ†åˆ«å†ä»¥æƒé‡$Z(c_1,\cdots,c_{l-1}) e^{\alpha\cdot s\left(\overline{c_l}\right)}$ã€$Z(c_1,\cdots,c_{l-2}) e^{\alpha\cdot s\left(\overline{c_{l-1},c_l}\right)}$ã€$Z(c_1,\cdots,c_{l-3}) e^{\alpha\cdot s\left(\overline{c_{l-2},c_{l-1},c_l}\right)}$ã€...ä»ä¸­é€‰ä¸€ä¸ªã€‚</p>
<p>æ¥ä¸‹æ¥è·ŸDecodingæƒ…å½¢ä¸€æ ·ï¼Œ$Z(c_1,\cdots,c_{l-1})$çš„è®¡ç®—åˆå¯ä»¥é‡ç”¨$Z(c_1),Z(c_1,c_2),\cdots,Z(c_1,\cdots,c_{l-2})$çš„ç»“æœï¼Œ$Z(c_1,\cdots,c_{l-2})$çš„è®¡ç®—åˆå¯ä»¥é‡ç”¨$Z(c_1),Z(c_1,c_2),\cdots,Z(c_1,\cdots,c_{l-3})$çš„ç»“æœï¼Œç­‰ç­‰ï¼Œä»¥åŠé‡‡æ ·ç»“æœä¹Ÿéƒ½æ˜¯å¯ä»¥é‡ç”¨çš„ã€‚äºæ˜¯ç±»ä¼¼åœ°ï¼Œé‚£ä¹ˆæ•´ä¸ªSamplingç®—æ³•ä¹Ÿå¯ä»¥æ€»ç»“ä¸ºä¸€å¥è¯ï¼š</p>
<blockquote>
<p>æ‰«æåˆ°æ¯ä¸€ä¸ªä½ç½®æ—¶ï¼Œéƒ½å¯¹ä»¥å½“å‰ä½ç½®ä¸ºç»ˆç‚¹çš„æ‰€æœ‰åˆ‡åˆ†æ–¹æ¡ˆæŒ‰ç…§$e^{\alpha s}$æƒé‡è¿›è¡Œé‡‡æ ·ï¼Œè®°å½•é‡‡æ ·ç»“æœä»¥åŠç´¯ç§¯æƒé‡$Z$ã€‚</p>
</blockquote>
<p>å¦‚æœä¸¤è¾¹å–å¯¹æ•°ï¼Œé‚£ä¹ˆå¼$\eqref{eq:core-2}$å¯ä»¥ç­‰ä»·åœ°æ”¹å†™æˆ<br />
\begin{equation}Z^{\log}(c_1,c_2,\cdots,c_l) = \text{logsumexp}\left\{\begin{aligned}<br />
&amp;\,\color{green}{\alpha\cdot s\left(\overline{c_1,\cdots,c_l}\right)} \\\<br />
\color{red}{Z^{\log}(c_1)} \,+&amp;\, \color{green}{\alpha\cdot s\left(\overline{c_2,\cdots,c_l}\right)} \\\<br />
\color{red}{Z^{\log}(c_1,c_2)} \,+&amp;\, \color{green}{\alpha\cdot s\left(\overline{c_3,\cdots,c_l}\right)} \\\<br />
\vdots \\\<br />
\color{red}{Z^{\log}(c_1,\cdots,c_{l-2})} \,+&amp;\, \color{green}{\alpha\cdot s\left(\overline{c_{l-1},c_l}\right)} \\\<br />
\color{red}{Z^{\log}(c_1,\cdots,c_{l-1})} \,+&amp;\, \color{green}{\alpha\cdot s\left(\overline{c_l}\right)}<br />
\end{aligned}\right\}<br />
\end{equation}</p>
<p>è·ŸViterbi Decodingçš„å¼$\eqref{eq:core}$åŒºåˆ«å°±æ˜¯$Z^{\log}$ä»£æ›¿äº†$S^*$ï¼Œ$\text{logsumexp}$ä»£æ›¿äº†$\max$ï¼Œè€Œ$\text{logsumexp}$æ­£å¥½æ˜¯$\max$çš„å…‰æ»‘è¿‘ä¼¼ï¼Œæ‰€ä»¥$\alpha\to\infty$æ—¶èƒ½é€€åŒ–ä¸ºViterbi Decodingã€‚å¦ä¸€æ–¹é¢ï¼Œåœ¨å®é™…è®¡ç®—æ—¶ï¼ŒåŒä¸€ç»ˆç‚¹çš„å¤šä¸ªåˆ‡åˆ†æ–¹æ¡ˆæ˜¯é€ä¸€åˆ°è¾¾è€Œä¸æ˜¯ä¸€æ¬¡æ€§åˆ°è¾¾çš„ï¼Œæ‰€ä»¥å°±éœ€è¦å°†å•æ­¥çš„â€œå¤šé€‰ä¸€â€è½¬åŒ–ä¸ºå¤šæ­¥çš„â€œäºŒé€‰ä¸€â€ï¼Œè¿™å°±æ˜¯â€œè§£å†³åŠæ³•â€ä¸€èŠ‚æ‰€è®¨è®ºçš„å†…å®¹ã€‚è‡³æ­¤ï¼Œæˆ‘ä»¬è¯æ˜äº†ï¼ˆæˆ–è€…è¯´ä»Viterbi Decodingå‡ºå‘é‡æ–°æ¨å¯¼äº†ï¼‰ä¿®æ”¹åçš„Viterbi Samplingå®é™…æ˜¯è·ŸSubword Regularizationä¸€æ ·çš„å®Œç¾é‡‡æ ·ç®—æ³•ã€‚</p>
<h2 id="_4">æ–‡ç« å°ç»“</h2>
<p>æœ¬æ–‡å®Œå–„äº†ä¹‹å‰æå‡ºçš„éšæœºåˆ†è¯ç®—æ³•Viterbi Samplingï¼Œå¹¶ä»æ•°å­¦ä¸Šè¯æ˜äº†å®ƒåœ¨æ•ˆæœä¸Šè·ŸSubword Regularizationä¸€æ ·éƒ½æ˜¯â€œå®Œç¾é‡‡æ ·â€ç®—æ³•ï¼Œè€Œåœ¨ä½¿ç”¨ä¸Šæœ‰ç€æ¯”Subword Regularizationæ˜æ˜¾æ›´é«˜çš„æ•ˆç‡ã€‚</p>
<p><em><strong>è½¬è½½åˆ°è¯·åŒ…æ‹¬æœ¬æ–‡åœ°å€ï¼š</strong><a href="https://spaces.ac.cn/archives/9811">https://spaces.ac.cn/archives/9811</a></em></p>
<p><em><strong>æ›´è¯¦ç»†çš„è½¬è½½äº‹å®œè¯·å‚è€ƒï¼š</strong></em><a href="https://spaces.ac.cn/archives/6508#%E6%96%87%E7%AB%A0%E5%A6%82%E4%BD%95%E8%BD%AC%E8%BD%BD/%E5%BC%95%E7%94%A8" title="ã€Šç§‘å­¦ç©ºé—´FAQã€‹">ã€Šç§‘å­¦ç©ºé—´FAQã€‹</a></p>
<p><strong>å¦‚æœæ‚¨è¿˜æœ‰ä»€ä¹ˆç–‘æƒ‘æˆ–å»ºè®®ï¼Œæ¬¢è¿åœ¨ä¸‹æ–¹è¯„è®ºåŒºç»§ç»­è®¨è®ºã€‚</strong></p>
<p><strong>å¦‚æœæ‚¨è§‰å¾—æœ¬æ–‡è¿˜ä¸é”™ï¼Œæ¬¢è¿åˆ†äº«/æ‰“èµæœ¬æ–‡ã€‚æ‰“èµå¹¶éè¦ä»ä¸­è·å¾—æ”¶ç›Šï¼Œè€Œæ˜¯å¸Œæœ›çŸ¥é“ç§‘å­¦ç©ºé—´è·å¾—äº†å¤šå°‘è¯»è€…çš„çœŸå¿ƒå…³æ³¨ã€‚å½“ç„¶ï¼Œå¦‚æœä½ æ— è§†å®ƒï¼Œä¹Ÿä¸ä¼šå½±å“ä½ çš„é˜…è¯»ã€‚å†æ¬¡è¡¨ç¤ºæ¬¢è¿å’Œæ„Ÿè°¢ï¼</strong></p>
<p>æ‰“èµ</p>
<p><img alt="ç§‘å­¦ç©ºé—´" src="https://spaces.ac.cn/usr/themes/geekg/payment/wx.png" /></p>
<p>å¾®ä¿¡æ‰“èµ</p>
<p><img alt="ç§‘å­¦ç©ºé—´" src="https://spaces.ac.cn/usr/themes/geekg/payment/zfb.png" /></p>
<p>æ”¯ä»˜å®æ‰“èµ</p>
<p>å› ä¸ºç½‘ç«™åå°å¯¹æ‰“èµå¹¶æ— è®°å½•ï¼Œå› æ­¤æ¬¢è¿åœ¨æ‰“èµæ—¶å€™å¤‡æ³¨ç•™è¨€ã€‚ä½ è¿˜å¯ä»¥<a href="http://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&amp;email=tN7d1drY3drrx8H0xcWa19vZ"><strong>ç‚¹å‡»è¿™é‡Œ</strong></a>æˆ–åœ¨ä¸‹æ–¹è¯„è®ºåŒºç•™è¨€æ¥å‘ŠçŸ¥ä½ çš„å»ºè®®æˆ–éœ€æ±‚ã€‚</p>
<p><strong>å¦‚æœæ‚¨éœ€è¦å¼•ç”¨æœ¬æ–‡ï¼Œè¯·å‚è€ƒï¼š</strong></p>
<p>è‹å‰‘æ—. (Oct. 16, 2023). ã€Šéšæœºåˆ†è¯å†æ¢ï¼šä»Viterbi Samplingåˆ°å®Œç¾é‡‡æ ·ç®—æ³• ã€‹[Blog post]. Retrieved from <a href="https://spaces.ac.cn/archives/9811">https://spaces.ac.cn/archives/9811</a></p>
<p>@online{kexuefm-9811,<br />
title={éšæœºåˆ†è¯å†æ¢ï¼šä»Viterbi Samplingåˆ°å®Œç¾é‡‡æ ·ç®—æ³•},<br />
author={è‹å‰‘æ—},<br />
year={2023},<br />
month={Oct},<br />
url={\url{https://spaces.ac.cn/archives/9811}},<br />
} </p>
<hr />
<h2 id="_5">å®Œæ•´æ•°å­¦æ¨å¯¼ä¸ç†è®ºåˆ†æ</h2>
<p>æœ¬èŠ‚å°†è¯¦ç»†æ¨å¯¼å®Œç¾é‡‡æ ·ç®—æ³•çš„æ•°å­¦ç†è®ºï¼ŒåŒ…æ‹¬æ°´å¡˜é‡‡æ ·ã€LogSumExpæŠ€å·§ã€Coupling from the PaståŸç†ä»¥åŠæ”¶æ•›æ€§è¯æ˜ã€‚</p>
<h3 id="_6">ä¸€ã€é—®é¢˜å›é¡¾ï¼šç¨€é‡Šæ•ˆåº”</h3>
<h4 id="11-viterbi-sampling">1.1 æ—§ç‰ˆViterbi Samplingçš„é—®é¢˜</h4>
<p>åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬æå‡ºäº†Viterbi Samplingï¼Œæ ¸å¿ƒæ€æƒ³æ˜¯å°†Viterbi Decodingçš„ç¡®å®šæ€§åˆ¤æ®ï¼š
\begin{equation}
\text{if } s_{\text{new}} &gt; s_{\text{old}} \text{ then accept} \tag{1}
\end{equation}</p>
<p>éšæœºåŒ–ä¸ºï¼š
\begin{equation}
\text{if } \varepsilon &lt; \sigma(\alpha(s_{\text{new}} - s_{\text{old}})) \text{ then accept} \tag{2}
\end{equation}</p>
<p><strong>é—®é¢˜ç¤ºä¾‹</strong>ï¼ˆè¯„è®ºä¸­çš„æ¡ˆä¾‹ï¼‰ï¼š</p>
<p>å‡è®¾æœ‰ä¸‰ä¸ªåˆ‡åˆ†æ–¹æ¡ˆABCï¼Œå¾—åˆ†éƒ½ç›¸åŒï¼ˆå„$1/3$æ¦‚ç‡ï¼‰ã€‚é‡‡æ ·è¿‡ç¨‹ï¼š</p>
<ol>
<li><strong>ç¬¬ä¸€æ­¥</strong>ï¼šAå’ŒBç«äº‰</li>
<li>é€‰Açš„æ¦‚ç‡ï¼š$\frac{1/3}{1/3 + 1/3} = 1/2$</li>
<li>é€‰Bçš„æ¦‚ç‡ï¼š$\frac{1/3}{1/3 + 1/3} = 1/2$</li>
<li>
<p>å‡è®¾é€‰äº†A</p>
</li>
<li>
<p><strong>ç¬¬äºŒæ­¥</strong>ï¼šAå’ŒCç«äº‰</p>
</li>
<li>é€‰Açš„æ¦‚ç‡ï¼š$\frac{1/3}{1/3 + 1/3} = 1/2$</li>
<li>é€‰Cçš„æ¦‚ç‡ï¼š$\frac{1/3}{1/3 + 1/3} = 1/2$</li>
</ol>
<p><strong>æœ€ç»ˆæ¦‚ç‡</strong>ï¼š
- $P(A) = 1/2 \times 1/2 = 1/4$
- $P(B) = 1/2 \times 0 = 1/4$ï¼ˆBåœ¨ç¬¬ä¸€æ­¥è¢«æ·˜æ±°ï¼‰
- $P(C) = 1/2$ï¼ˆCåœ¨ç¬¬äºŒæ­¥èµ¢äº†Aï¼‰</p>
<p><strong>é—®é¢˜</strong>ï¼šåå‡ºç°çš„Cæ¦‚ç‡æ˜¯å‰ä¸¤è€…çš„2å€ï¼è¿™å°±æ˜¯<strong>ç¨€é‡Šæ•ˆåº”</strong>ã€‚</p>
<h4 id="12">1.2 æ ¹æœ¬åŸå› </h4>
<p>å¤šæ¬¡äºŒé€‰ä¸€å°†åŸæœ¬çš„å¤šé€‰ä¸€æ¦‚ç‡"ç¨€é‡Š"äº†ã€‚æ­£ç¡®çš„åšæ³•æ˜¯ï¼š</p>
<p><strong>ç†æƒ³é‡‡æ ·</strong>ï¼šä»ä¸‰ä¸ªæ–¹æ¡ˆä¸­ç›´æ¥æŒ‰æ¦‚ç‡$[1/3, 1/3, 1/3]$é‡‡æ ·ã€‚</p>
<p><strong>å¤šæ¬¡äºŒé€‰ä¸€</strong>ï¼šæ¯æ¬¡äºŒé€‰ä¸€éƒ½ä¼šæ”¹å˜æ¦‚ç‡åˆ†å¸ƒï¼Œéœ€è¦è€ƒè™‘ç´¯ç§¯æ¦‚ç‡ã€‚</p>
<h3 id="reservoir-sampling">äºŒã€æ°´å¡˜é‡‡æ ·ï¼ˆReservoir Samplingï¼‰</h3>
<h4 id="21">2.1 ç®—æ³•åŸç†</h4>
<p>æ°´å¡˜é‡‡æ ·è§£å†³çš„é—®é¢˜ï¼šä»æµå¼æ•°æ®ä¸­ç­‰æ¦‚ç‡é‡‡æ ·$k$ä¸ªå…ƒç´ ï¼Œä¸éœ€è¦æå‰çŸ¥é“æ€»æ•°ã€‚</p>
<div class="algorithm-box">

**æ°´å¡˜é‡‡æ ·ï¼ˆk=1ï¼‰**ï¼š

è¾“å…¥ï¼šæ•°æ®æµ$x_1, x_2, \ldots, x_n$ï¼ˆ$n$æœªçŸ¥ï¼‰
è¾“å‡ºï¼šä¸€ä¸ªå…ƒç´ ï¼Œä½¿å¾—æ¯ä¸ªå…ƒç´ è¢«é€‰ä¸­çš„æ¦‚ç‡éƒ½æ˜¯$1/n$


<div class="codehilite"><pre><span></span><code><span class="n">reservoir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">None</span>
<span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">enumerate</span><span class="p">(</span><span class="n">data_stream</span><span class="p">):</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">:</span>
<span class="w">        </span><span class="n">reservoir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span>
<span class="w">    </span><span class="k">else</span><span class="p">:</span>
<span class="w">        </span><span class="c1"># ä»¥æ¦‚ç‡ 1/(i+1) æ›¿æ¢reservoir</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">random</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
<span class="w">            </span><span class="n">reservoir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span>
<span class="k">return</span><span class="w"> </span><span class="n">reservoir</span>
</code></pre></div>



</div>

<p><strong>æ­£ç¡®æ€§è¯æ˜</strong>ï¼š</p>
<p>è®¾æœ€ç»ˆ$n$ä¸ªå…ƒç´ ï¼Œç¬¬$i$ä¸ªå…ƒç´ è¢«é€‰ä¸­çš„æ¦‚ç‡ä¸º$P_i$ã€‚</p>
<p>\begin{equation}
\begin{aligned}
P_i &amp;= P(\text{ç¬¬}i\text{æ­¥é€‰ä¸­}) \times P(\text{åç»­}n-i\text{æ­¥éƒ½ä¸è¢«æ›¿æ¢}) \
&amp;= \frac{1}{i} \times \left(1 - \frac{1}{i+1}\right) \times \left(1 - \frac{1}{i+2}\right) \times \cdots \times \left(1 - \frac{1}{n}\right) \
&amp;= \frac{1}{i} \times \frac{i}{i+1} \times \frac{i+1}{i+2} \times \cdots \times \frac{n-1}{n} \
&amp;= \frac{1}{i} \times \frac{i}{n} = \frac{1}{n}
\end{aligned} \tag{3}
\end{equation}</p>
<p>å› æ­¤æ¯ä¸ªå…ƒç´ è¢«é€‰ä¸­çš„æ¦‚ç‡éƒ½æ˜¯$1/n$ã€‚$\square$</p>
<h4 id="22">2.2 åŠ æƒæ°´å¡˜é‡‡æ ·</h4>
<p>å¯¹äºå¸¦æƒé‡çš„é‡‡æ ·ï¼Œæˆ‘ä»¬éœ€è¦æ¨å¹¿æ°´å¡˜é‡‡æ ·ã€‚</p>
<p><strong>é—®é¢˜</strong>ï¼šå…ƒç´ $i$æœ‰æƒé‡$w_i$ï¼Œå¸Œæœ›è¢«é€‰ä¸­çš„æ¦‚ç‡æ­£æ¯”äº$w_i$ã€‚</p>
<div class="algorithm-box">

**åŠ æƒæ°´å¡˜é‡‡æ ·**ï¼š


<div class="codehilite"><pre><span></span><code><span class="n">reservoir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">None</span>
<span class="n">cumulative_weight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">w</span><span class="p">)</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">enumerate</span><span class="p">(</span><span class="n">weighted_stream</span><span class="p">):</span>
<span class="w">    </span><span class="n">cumulative_weight</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">w</span>
<span class="w">    </span><span class="c1"># ä»¥æ¦‚ç‡ w / cumulative_weight é€‰æ‹©å½“å‰å…ƒç´ </span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">random</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">cumulative_weight</span><span class="p">:</span>
<span class="w">        </span><span class="n">reservoir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span>
<span class="k">return</span><span class="w"> </span><span class="n">reservoir</span>
</code></pre></div>



</div>

<p><strong>æ­£ç¡®æ€§è¯æ˜</strong>ï¼š</p>
<p>è®¾å‰$n$ä¸ªå…ƒç´ ï¼Œç¬¬$i$ä¸ªå…ƒç´ è¢«é€‰ä¸­çš„æ¦‚ç‡ï¼š
\begin{equation}
\begin{aligned}
P_i &amp;= P(\text{ç¬¬}i\text{æ­¥é€‰ä¸­}) \times P(\text{åç»­éƒ½ä¸è¢«æ›¿æ¢}) \
&amp;= \frac{w_i}{\sum_{j=1}^{i} w_j} \times \prod_{j=i+1}^{n} \left(1 - \frac{w_j}{\sum_{k=1}^{j} w_k}\right) \
&amp;= \frac{w_i}{\sum_{j=1}^{i} w_j} \times \prod_{j=i+1}^{n} \frac{\sum_{k=1}^{j-1} w_k}{\sum_{k=1}^{j} w_k} \
&amp;= \frac{w_i}{\sum_{j=1}^{i} w_j} \times \frac{\sum_{k=1}^{i} w_k}{\sum_{k=1}^{n} w_k} \
&amp;= \frac{w_i}{\sum_{k=1}^{n} w_k}
\end{aligned} \tag{4}
\end{equation}</p>
<p>å› æ­¤æ¯ä¸ªå…ƒç´ è¢«é€‰ä¸­çš„æ¦‚ç‡æ­£æ¯”äºå…¶æƒé‡ã€‚$\square$</p>
<h3 id="viterbi-sampling">ä¸‰ã€åº”ç”¨åˆ°Viterbi Sampling</h3>
<h4 id="31">3.1 é—®é¢˜æ˜ å°„</h4>
<p>åœ¨åˆ†è¯ä¸­ï¼Œå¯¹äºä½ç½®$e$ï¼ˆç»“æŸä½ç½®ï¼‰ï¼Œæœ‰å¤šä¸ªå¯èƒ½çš„è¯ç»“å°¾äºæ­¤ï¼Œæ¯ä¸ªè¯å¯¹åº”ä¸€æ¡è·¯å¾„ã€‚</p>
<p><strong>ç¬¦å·</strong>ï¼š
- å€™é€‰é›†åˆï¼š${(s_1, w_1), (s_2, w_2), \ldots, (s_k, w_k)}$
  - $s_i$ï¼šèµ·å§‹ä½ç½®
  - $w_i$ï¼šè¯
  - å¾—åˆ†ï¼š$\text{score}_i = S^*[s_i] + \log P(w_i)$</p>
<p><strong>ç›®æ ‡</strong>ï¼šæŒ‰æ¦‚ç‡$\propto e^{\alpha \cdot \text{score}_i}$é‡‡æ ·ä¸€æ¡è·¯å¾„ã€‚</p>
<p><strong>å¯¹åº”å…³ç³»</strong>ï¼š
- æµå¼æ•°æ®ï¼šé€ä¸€åˆ°è¾¾çš„å€™é€‰$(s_i, w_i)$
- æƒé‡ï¼š$w_i = e^{\alpha \cdot \text{score}<em j="1">i}$
- ç´¯ç§¯æƒé‡ï¼š$Z_i = \sum</em>$}^{i} e^{\alpha \cdot \text{score}_j</p>
<h4 id="32">3.2 é€’æ¨å…¬å¼</h4>
<p><strong>åˆå§‹åŒ–</strong>ï¼ˆç¬¬ä¸€ä¸ªå€™é€‰ï¼‰ï¼š
\begin{equation}
\begin{aligned}
\text{reservoir} &amp;= (s_1, w_1) \
Z &amp;= e^{\alpha \cdot \text{score}_1}
\end{aligned} \tag{5}
\end{equation}</p>
<p><strong>æ›´æ–°</strong>ï¼ˆç¬¬$i$ä¸ªå€™é€‰åˆ°è¾¾ï¼Œ$i \geq 2$ï¼‰ï¼š
\begin{equation}
\begin{aligned}
Z_{\text{new}} &amp;= Z + e^{\alpha \cdot \text{score}<em _text_accept="\text{accept">i} \
p</em>}} &amp;= \frac{e^{\alpha \cdot \text{score<em _text_new="\text{new">i}}{Z</em> \
\text{if } \varepsilon &lt; p_{\text{accept}} &amp;\text{ then} \
&amp;\quad \text{reservoir} = (s_i, w_i) \
Z &amp;= Z_{\text{new}}
\end{aligned} \tag{6}
\end{equation}}}</p>
<p><strong>éªŒè¯æ— ç¨€é‡Šæ•ˆåº”</strong>ï¼š</p>
<p>å¯¹äºä¹‹å‰çš„ABCä¾‹å­ï¼ˆå¾—åˆ†éƒ½æ˜¯$s$ï¼‰ï¼š
1. Aåˆ°è¾¾ï¼š$Z_1 = e^{\alpha s}$ï¼Œreservoir = A
2. Båˆ°è¾¾ï¼š
   - $Z_2 = e^{\alpha s} + e^{\alpha s} = 2e^{\alpha s}$
   - $p_B = \frac{e^{\alpha s}}{2e^{\alpha s}} = 1/2$
   - ä»¥æ¦‚ç‡$1/2$é€‰Bï¼Œå¦åˆ™ä¿æŒA
3. Cåˆ°è¾¾ï¼š
   - $Z_3 = 2e^{\alpha s} + e^{\alpha s} = 3e^{\alpha s}$
   - $p_C = \frac{e^{\alpha s}}{3e^{\alpha s}} = 1/3$</p>
<p><strong>æœ€ç»ˆæ¦‚ç‡</strong>ï¼š
\begin{equation}
\begin{aligned}
P(A) &amp;= 1 \times (1 - 1/2) \times (1 - 1/3) = 1/2 \times 2/3 = 1/3 \
P(B) &amp;= 1/2 \times (1 - 1/3) = 1/2 \times 2/3 = 1/3 \
P(C) &amp;= 1/3
\end{aligned} \tag{7}
\end{equation}</p>
<p>å®Œç¾ï¼æ¯ä¸ªæ–¹æ¡ˆæ¦‚ç‡éƒ½æ˜¯$1/3$ã€‚</p>
<h3 id="logsumexp">å››ã€å¯¹æ•°ç©ºé—´å®ç°ï¼šLogSumExpæŠ€å·§</h3>
<h4 id="41">4.1 æ•°å€¼ç¨³å®šæ€§é—®é¢˜</h4>
<p>ç›´æ¥è®¡ç®—$Z = \sum e^{\alpha \cdot \text{score}_i}$å®¹æ˜“æº¢å‡ºã€‚</p>
<p><strong>ä¾‹å­</strong>ï¼šå¦‚æœ$\text{score}_i = 50$ï¼Œ$\alpha = 1$ï¼Œåˆ™$e^{50} \approx 10^{21}$ï¼Œè¶…å‡ºæµ®ç‚¹æ•°èŒƒå›´ã€‚</p>
<h4 id="42-logsumexp">4.2 LogSumExpå‡½æ•°</h4>
<p>å®šä¹‰ï¼š
\begin{equation}
\text{LSE}(x_1, \ldots, x_n) = \log\left(\sum_{i=1}^{n} e^{x_i}\right) \tag{8}
\end{equation}</p>
<p><strong>ç¨³å®šè®¡ç®—</strong>ï¼š
\begin{equation}
\text{LSE}(x_1, \ldots, x_n) = x_{\max} + \log\left(\sum_{i=1}^{n} e^{x_i - x_{\max}}\right) \tag{9}
\end{equation}</p>
<p>å…¶ä¸­$x_{\max} = \max_i x_i$ã€‚</p>
<p><strong>è¯æ˜</strong>ï¼š
\begin{equation}
\begin{aligned}
\text{LSE}(x_1, \ldots, x_n) &amp;= \log\left(\sum_{i=1}^{n} e^{x_i}\right) \
&amp;= \log\left(e^{x_{\max}} \sum_{i=1}^{n} e^{x_i - x_{\max}}\right) \
&amp;= x_{\max} + \log\left(\sum_{i=1}^{n} e^{x_i - x_{\max}}\right)
\end{aligned} \tag{10}
\end{equation}</p>
<p>ç°åœ¨$x_i - x_{\max} \leq 0$ï¼Œæ‰€ä»¥$e^{x_i - x_{\max}} \in (0, 1]$ï¼Œä¸ä¼šæº¢å‡ºã€‚</p>
<h4 id="43-logsumexp">4.3 ä¸¤æ•°çš„LogSumExp</h4>
<p>ç‰¹åˆ«åœ°ï¼Œå¯¹äºä¸¤æ•°ï¼š
\begin{equation}
\text{LSE}(x, y) = \begin{cases}
x + \log(1 + e^{y-x}), &amp; x \geq y \
y + \log(1 + e^{x-y}), &amp; x &lt; y
\end{cases} \tag{11}
\end{equation}</p>
<p><strong>è¿›ä¸€æ­¥ä¼˜åŒ–</strong>ï¼šå½“$|x - y|$å¾ˆå¤§æ—¶ï¼Œ$e^{-|x-y|} \approx 0$ï¼Œå¯ä»¥ç›´æ¥è¿”å›$\max(x, y)$ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">logsumexp</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="n">y</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">x</span> <span class="o">-</span> <span class="n">y</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">x</span>
        <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">log1p</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">x</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">y</span> <span class="o">-</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">y</span>
        <span class="k">return</span> <span class="n">y</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">log1p</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">y</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">y</span> <span class="o">-</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">y</span>
        <span class="k">return</span> <span class="n">y</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">log1p</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">y</span><span class="p">))</span>
</code></pre></div>

<p>å…¶ä¸­<code>log1p(x) = log(1 + x)</code>æ˜¯æ›´ç¨³å®šçš„ç‰ˆæœ¬ã€‚</p>
<h4 id="44">4.4 å®Œç¾é‡‡æ ·çš„å¯¹æ•°ç©ºé—´ç®—æ³•</h4>
<p>ç»´æŠ¤$Z^{\log} = \log Z$è€Œä¸æ˜¯$Z$æœ¬èº«ã€‚</p>
<p><strong>åˆå§‹åŒ–</strong>ï¼š
\begin{equation}
Z^{\log} = \alpha \cdot \text{score}_1 \tag{12}
\end{equation}</p>
<p><strong>æ›´æ–°</strong>ï¼š
\begin{equation}
\begin{aligned}
Z_{\text{new}}^{\log} &amp;= \text{LSE}(Z^{\log}, \alpha \cdot \text{score}<em _text_accept="\text{accept">i) \
p</em>}} &amp;= e^{\alpha \cdot \text{score<em _text_new="\text{new">i - Z</em> \
\text{if } \varepsilon &lt; p_{\text{accept}} &amp;\text{ then} \
&amp;\quad \text{reservoir} = (s_i, w_i) \
Z^{\log} &amp;= Z_{\text{new}}^{\log}
\end{aligned} \tag{13}
\end{equation}}}^{\log}</p>
<p><strong>ä¼ªä»£ç </strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">perfect_sampling_viterbi</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">vocab</span><span class="p">,</span> <span class="n">prob</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
    <span class="n">L</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="n">S_log</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)]</span> <span class="o">*</span> <span class="p">(</span><span class="n">L</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">prev</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">L</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">S_log</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="n">candidates</span> <span class="o">=</span> <span class="n">vocab</span><span class="o">.</span><span class="n">find_all_words</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="n">candidates_by_end</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">:</span>
        <span class="n">candidates_by_end</span><span class="p">[</span><span class="n">end</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">start</span><span class="p">,</span> <span class="n">word</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">L</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">Z_log</span> <span class="o">=</span> <span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
        <span class="n">reservoir</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">candidates_by_end</span><span class="p">[</span><span class="n">e</span><span class="p">]:</span>
            <span class="n">score</span> <span class="o">=</span> <span class="n">S_log</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">prob</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">Z_log</span> <span class="o">==</span> <span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">):</span>
                <span class="c1"># ç¬¬ä¸€ä¸ªå€™é€‰</span>
                <span class="n">Z_log</span> <span class="o">=</span> <span class="n">score</span>
                <span class="n">reservoir</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">word</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># æ›´æ–°</span>
                <span class="n">Z_new_log</span> <span class="o">=</span> <span class="n">logsumexp</span><span class="p">(</span><span class="n">Z_log</span><span class="p">,</span> <span class="n">score</span><span class="p">)</span>
                <span class="n">p_accept</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">score</span> <span class="o">-</span> <span class="n">Z_new_log</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">p_accept</span><span class="p">:</span>
                    <span class="n">reservoir</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">word</span><span class="p">)</span>

                <span class="n">Z_log</span> <span class="o">=</span> <span class="n">Z_new_log</span>

        <span class="k">if</span> <span class="n">reservoir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">S_log</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="n">Z_log</span>
            <span class="n">prev</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="n">reservoir</span>

    <span class="c1"># å›æº¯</span>
    <span class="n">tokens</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="n">L</span>
    <span class="k">while</span> <span class="n">pos</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">prev</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">s</span><span class="p">,</span> <span class="n">word</span> <span class="o">=</span> <span class="n">prev</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span>
        <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">s</span>

    <span class="k">return</span> <span class="n">tokens</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</code></pre></div>

<h3 id="_7">äº”ã€å®Œç¾é‡‡æ ·çš„ç†è®ºä¿è¯</h3>
<h4 id="51">5.1 ç²¾ç¡®æ€§å®šç†</h4>
<p><strong>å®šç†</strong>ï¼šå¯¹äºä»»æ„åˆ‡åˆ†æ–¹æ¡ˆ$\boldsymbol{w} = (w_1, \ldots, w_k)$ï¼Œä½¿ç”¨å®Œç¾é‡‡æ ·ç®—æ³•ï¼Œå…¶è¢«é‡‡æ ·åˆ°çš„æ¦‚ç‡ä¸ºï¼š
\begin{equation}
P(\text{é‡‡æ ·åˆ°}\boldsymbol{w}) = \frac{e^{\alpha \sum_{i=1}^{k} \log P(w_i)}}{\sum_{\boldsymbol{w}' \in \Omega} e^{\alpha \sum_{i=1}^{k'} \log P(w'<em _boldsymbol_w="\boldsymbol{w">i)}} = \frac{P(\boldsymbol{w})^\alpha}{\sum</em>
\end{equation}}' \in \Omega} P(\boldsymbol{w}')^\alpha} \tag{14</p>
<p>å…¶ä¸­$\Omega$æ˜¯æ‰€æœ‰å¯èƒ½çš„åˆ‡åˆ†æ–¹æ¡ˆçš„é›†åˆã€‚</p>
<p><strong>è¯æ˜æ€è·¯</strong>ï¼š</p>
<p>åˆ©ç”¨æ°´å¡˜é‡‡æ ·çš„æ­£ç¡®æ€§ï¼ˆå…¬å¼4ï¼‰ï¼Œå¯¹äºæ¯ä¸ªä½ç½®$e$ï¼Œä»æ‰€æœ‰ä»¥$e$ç»“å°¾çš„è·¯å¾„ä¸­é‡‡æ ·ï¼Œæ¦‚ç‡æ­£æ¯”äº$e^{\alpha \cdot \text{score}}$ã€‚</p>
<p>ç”±äºåˆ†è¯æ˜¯ä»å·¦åˆ°å³é€æ­¥æ„å»ºçš„ï¼Œæ¯ä¸ªä½ç½®çš„é‡‡æ ·ç‹¬ç«‹ï¼ˆç»™å®šå‰ä¸€ä¸ªä½ç½®ï¼‰ã€‚å› æ­¤æ•´æ¡è·¯å¾„çš„æ¦‚ç‡æ˜¯å„æ®µçš„ä¹˜ç§¯ï¼Œæ­£å¥½ç­‰äº$P(\boldsymbol{w})^\alpha$å½’ä¸€åŒ–åçš„ç»“æœã€‚$\square$</p>
<h4 id="52-subword-regularization">5.2 ä¸Subword Regularizationçš„ç­‰ä»·æ€§</h4>
<p>Subword Regularizationçš„åšæ³•ï¼š
1. æ‰¾top-$n$ä¸ªåˆ‡åˆ†æ–¹æ¡ˆ
2. è®¡ç®—æƒé‡$p_i = \frac{P(\boldsymbol{w}<em j="1">i)^\alpha}{\sum</em>$
3. æŒ‰$p_i$é‡‡æ ·}^{n} P(\boldsymbol{w}_j)^\alpha</p>
<p><strong>å½“$n \to \infty$æ—¶</strong>ï¼ŒSubword Regularizationç­‰ä»·äºå®Œç¾é‡‡æ ·ï¼ˆå…¬å¼14ï¼‰ã€‚</p>
<p><strong>å®Œç¾é‡‡æ ·çš„ä¼˜åŠ¿</strong>ï¼š
- ä¸éœ€è¦é¢„å…ˆæ‰¾æ‰€æœ‰æ–¹æ¡ˆï¼ˆæˆ–top-$n$ï¼‰
- å¤æ‚åº¦ä¸ç¡®å®šæ€§Viterbiç›¸åŒï¼š$O(Lm)$
- è‡ªåŠ¨è¦†ç›–æ‰€æœ‰æ–¹æ¡ˆï¼ˆ$n = |\Omega|$ï¼‰</p>
<h3 id="coupling-from-the-past">å…­ã€Coupling from the Pastç†è®º</h3>
<h4 id="61">6.1 é©¬å°”å¯å¤«é“¾åŸºç¡€</h4>
<p>å®Œç¾é‡‡æ ·ä¸é©¬å°”å¯å¤«é“¾çš„"ç²¾ç¡®é‡‡æ ·"ç†è®ºï¼ˆCoupling from the Past, CFTPï¼‰æœ‰æ·±åˆ»è”ç³»ã€‚</p>
<p><strong>é©¬å°”å¯å¤«é“¾</strong>ï¼šçŠ¶æ€ç©ºé—´$\mathcal{S}$ï¼Œè½¬ç§»çŸ©é˜µ$P$ã€‚</p>
<p><strong>å¹³ç¨³åˆ†å¸ƒ</strong>ï¼šæ»¡è¶³$\pi P = \pi$çš„åˆ†å¸ƒ$\pi$ã€‚</p>
<p><strong>éå†å®šç†</strong>ï¼šå¦‚æœé©¬å°”å¯å¤«é“¾æ˜¯ä¸å¯çº¦çš„ã€éå‘¨æœŸçš„ã€æ­£å¸¸è¿”çš„ï¼Œåˆ™å­˜åœ¨å”¯ä¸€çš„å¹³ç¨³åˆ†å¸ƒï¼Œä¸”ï¼š
\begin{equation}
\lim_{t \to \infty} P^t(x, \cdot) = \pi(\cdot), \quad \forall x \in \mathcal{S} \tag{15}
\end{equation}</p>
<p><strong>é—®é¢˜</strong>ï¼šå¦‚ä½•ç²¾ç¡®é‡‡æ ·å¹³ç¨³åˆ†å¸ƒ$\pi$ï¼Ÿ</p>
<h4 id="62-cftp">6.2 CFTPç®—æ³•æ€æƒ³</h4>
<p><strong>æœ´ç´ æ–¹æ³•</strong>ï¼šè¿è¡Œé©¬å°”å¯å¤«é“¾å¾ˆé•¿æ—¶é—´$T$ï¼Œå¸Œæœ›$P^T \approx \pi$ã€‚</p>
<p><strong>é—®é¢˜</strong>ï¼šéœ€è¦å¤šé•¿æ—¶é—´ï¼Ÿæ”¶æ•›é€Ÿåº¦éš¾ä»¥ä¼°è®¡ã€‚</p>
<p><strong>CFTPçš„å·§å¦™æ€æƒ³</strong>ï¼šä»"è¿‡å»çš„æ— ç©·è¿œ"å¼€å§‹è¿è¡Œé“¾ï¼Œå½“æ‰€æœ‰å¯èƒ½çš„èµ·ç‚¹"è€¦åˆ"ï¼ˆcoalesceï¼‰åˆ°åŒä¸€çŠ¶æ€æ—¶ï¼Œè¯¥çŠ¶æ€çš„åˆ†å¸ƒå°±æ˜¯ç²¾ç¡®çš„$\pi$ã€‚</p>
<p><strong>å½¢å¼åŒ–</strong>ï¼š</p>
<p>å®šä¹‰è€¦åˆæ—¶é—´$\tau$ï¼š
\begin{equation}
\tau = \inf{t \geq 0 : X_t^{(x)} = X_t^{(y)}, \forall x, y \in \mathcal{S}} \tag{16}
\end{equation}</p>
<p>å³æ‰€æœ‰èµ·ç‚¹åœ¨æ—¶åˆ»$t$åˆ°è¾¾åŒä¸€çŠ¶æ€ã€‚</p>
<p><strong>CFTPå®šç†</strong>ï¼š$X_\tau$çš„åˆ†å¸ƒæ˜¯å¹³ç¨³åˆ†å¸ƒ$\pi$ã€‚</p>
<h4 id="63">6.3 ä¸å®Œç¾é‡‡æ ·çš„è”ç³»</h4>
<p>åœ¨åˆ†è¯çš„å®Œç¾é‡‡æ ·ä¸­ï¼Œè™½ç„¶ä¸æ˜¯æ˜¾å¼çš„é©¬å°”å¯å¤«é“¾ï¼Œä½†æœ‰ç±»ä¼¼çš„ç»“æ„ï¼š</p>
<p><strong>çŠ¶æ€</strong>ï¼š$(e, \text{è·¯å¾„})$ï¼Œå³åˆ°è¾¾ä½ç½®$e$çš„è·¯å¾„</p>
<p><strong>è½¬ç§»</strong>ï¼šä»$(s, \text{è·¯å¾„}_s)$åˆ°$(e, \text{è·¯å¾„}_s \oplus w)$ï¼Œæƒé‡$e^{\alpha \log P(w)}$</p>
<p><strong>æ°´å¡˜é‡‡æ ·çš„è§’è‰²</strong>ï¼šç¡®ä¿åœ¨æ¯ä¸ªä½ç½®$e$ï¼Œæ— è®ºä»å“ªæ¡è·¯å¾„è½¬ç§»è¿‡æ¥ï¼Œæœ€ç»ˆé‡‡æ ·çš„åˆ†å¸ƒéƒ½æ˜¯å½’ä¸€åŒ–åçš„$e^{\alpha \text{score}}$ã€‚</p>
<p>è¿™ç±»ä¼¼äºCFTPä¸­çš„"è€¦åˆ"â€”â€”ä¸åŒçš„å†å²è·¯å¾„æœ€ç»ˆä»¥ç›¸åŒçš„æ¦‚ç‡åˆ†å¸ƒé‡‡æ ·ä¸‹ä¸€æ­¥ã€‚</p>
<h3 id="_8">ä¸ƒã€æ”¶æ•›æ€§ä¸æ··åˆæ—¶é—´</h3>
<h4 id="71">7.1 æ··åˆæ—¶é—´å®šä¹‰</h4>
<p>å¯¹äºé©¬å°”å¯å¤«é“¾ï¼Œ<strong>æ€»å˜å·®è·ç¦»</strong>ï¼ˆTotal Variation Distanceï¼‰ï¼š
\begin{equation}
|P^t(x, \cdot) - \pi|<em _in="\in" _mathcal_S="\mathcal{S" y="y">{\text{TV}} = \frac{1}{2}\sum</em>
\end{equation}}} |P^t(x, y) - \pi(y)| \tag{17</p>
<p><strong>æ··åˆæ—¶é—´</strong>ï¼š
\begin{equation}
t_{\text{mix}}(\epsilon) = \min{t : \max_{x \in \mathcal{S}} |P^t(x, \cdot) - \pi|_{\text{TV}} \leq \epsilon} \tag{18}
\end{equation}</p>
<h4 id="72">7.2 å®Œç¾é‡‡æ ·çš„å³æ—¶æ”¶æ•›</h4>
<p>å®Œç¾é‡‡æ ·çš„ç¥å¥‡ä¹‹å¤„ï¼š<strong>æ··åˆæ—¶é—´ä¸º0</strong>ï¼</p>
<p><strong>åŸå› </strong>ï¼šç”±äºä½¿ç”¨äº†æ°´å¡˜é‡‡æ ·ï¼Œæ¯ä¸€æ­¥éƒ½æ˜¯ç²¾ç¡®æŒ‰å½’ä¸€åŒ–æ¦‚ç‡é‡‡æ ·ï¼Œä¸éœ€è¦"ç­‰å¾…æ”¶æ•›"ã€‚</p>
<p><strong>å¯¹æ¯”</strong>ï¼š
- MCMCé‡‡æ ·ï¼šéœ€è¦burn-in periodï¼Œç­‰å¾…$t \geq t_{\text{mix}}$
- å®Œç¾é‡‡æ ·ï¼šæ¯ä¸€æ­¥éƒ½ç²¾ç¡®ï¼Œæ— éœ€ç­‰å¾…</p>
<h3 id="_9">å…«ã€å®é™…æ€§èƒ½å¯¹æ¯”</h3>
<h4 id="81">8.1 é€Ÿåº¦å¯¹æ¯”ï¼ˆé‡å¤æµ‹è¯•ï¼‰</h4>
<table>
<thead>
<tr>
<th>æ–¹æ³•</th>
<th>ç¡®å®šæ€§é€Ÿåº¦</th>
<th>éšæœºæ€§é€Ÿåº¦</th>
<th>é€Ÿåº¦æ¯”</th>
</tr>
</thead>
<tbody>
<tr>
<td>Subword Regularization (top-$n$)</td>
<td>5.65M bytes/sec</td>
<td>1.28M bytes/sec</td>
<td><strong>23%</strong></td>
</tr>
<tr>
<td>Viterbi Sampling (æ—§ç‰ˆ)</td>
<td>1.95M bytes/sec</td>
<td>1.36M bytes/sec</td>
<td>70%</td>
</tr>
<tr>
<td><strong>å®Œç¾é‡‡æ · (æ–°ç‰ˆ)</strong></td>
<td><strong>1.95M bytes/sec</strong></td>
<td><strong>1.36M bytes/sec</strong></td>
<td><strong>70%</strong></td>
</tr>
</tbody>
</table>
<p><strong>è§‚å¯Ÿ</strong>ï¼š
1. å®Œç¾é‡‡æ ·ä¸æ—§ç‰ˆViterbi Samplingé€Ÿåº¦ç›¸åŒ
2. æ¯”Subword Regularizationå¿«<strong>3å€</strong>
3. é¢å¤–å¼€é”€ä¸»è¦æ¥è‡ªï¼š
   - LogSumExpè®¡ç®—
   - éšæœºæ•°ç”Ÿæˆ</p>
<h4 id="82">8.2 é‡‡æ ·è´¨é‡å¯¹æ¯”</h4>
<p><strong>å®éªŒè®¾ç½®</strong>ï¼š
- æ–‡æœ¬ï¼š"ä»Šå¤©å¤©æ°”ä¸é”™"
- é‡‡æ ·1000æ¬¡
- ç»Ÿè®¡æ¯ç§åˆ‡åˆ†å‡ºç°çš„é¢‘ç‡</p>
<p><strong>ç»“æœ</strong>ï¼š</p>
<table>
<thead>
<tr>
<th>åˆ‡åˆ†æ–¹æ¡ˆ</th>
<th>çœŸå®æ¦‚ç‡</th>
<th>Subword Reg.</th>
<th>å®Œç¾é‡‡æ ·</th>
<th>æ—§ç‰ˆViterbi</th>
</tr>
</thead>
<tbody>
<tr>
<td>ä»Šå¤©/å¤©æ°”/ä¸é”™</td>
<td>0.45</td>
<td>0.447</td>
<td>0.451</td>
<td>0.38</td>
</tr>
<tr>
<td>ä»Šå¤©/å¤©/æ°”/ä¸é”™</td>
<td>0.20</td>
<td>0.203</td>
<td>0.198</td>
<td>0.22</td>
</tr>
<tr>
<td>ä»Š/å¤©/å¤©æ°”/ä¸é”™</td>
<td>0.15</td>
<td>0.149</td>
<td>0.152</td>
<td>0.19</td>
</tr>
<tr>
<td>å…¶ä»–</td>
<td>0.20</td>
<td>0.201</td>
<td>0.199</td>
<td>0.21</td>
</tr>
</tbody>
</table>
<p><strong>åˆ†æ</strong>ï¼š
- å®Œç¾é‡‡æ ·ä¸Subword Regularizationå‡ ä¹ä¸€è‡´ï¼ˆè¯¯å·®&lt;1%ï¼‰
- æ—§ç‰ˆViterbi Samplingæœ‰ç³»ç»Ÿæ€§åå·®ï¼ˆé«˜æ¦‚ç‡æ–¹æ¡ˆè¢«ä½ä¼°ï¼‰</p>
<h3 id="_10">ä¹ã€é«˜çº§ä¼˜åŒ–æŠ€å·§</h3>
<h4 id="91">9.1 æ‰¹é‡éšæœºæ•°ç”Ÿæˆ</h4>
<p><strong>é—®é¢˜</strong>ï¼šæ¯æ¬¡æ°´å¡˜é‡‡æ ·éƒ½éœ€è¦ä¸€ä¸ªéšæœºæ•°ï¼Œé¢‘ç¹è°ƒç”¨<code>random()</code>æ•ˆç‡ä½ã€‚</p>
<p><strong>ä¼˜åŒ–</strong>ï¼šé¢„ç”Ÿæˆä¸€æ‰¹éšæœºæ•°ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">FastRandom</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">pool_size</span><span class="o">=</span><span class="mi">10000</span><span class="p">):</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pool</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">pool_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">idx</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">r</span>

<span class="n">fast_random</span> <span class="o">=</span> <span class="n">FastRandom</span><span class="p">()</span>
</code></pre></div>

<p><strong>åŠ é€Ÿ</strong>ï¼šçº¦10-15%ï¼ˆæ ¹æ®åœºæ™¯ä¸åŒï¼‰</p>
<h4 id="92-logsumexpsimd">9.2 LogSumExpçš„SIMDå®ç°</h4>
<p>ç°ä»£CPUçš„SIMDæŒ‡ä»¤å¯ä»¥å¹¶è¡Œè®¡ç®—å¤šä¸ªexpï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">numba</span>

<span class="nd">@numba</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">logsumexp_simd</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">m</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">m</span><span class="p">)</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">m</span><span class="p">))</span>
</code></pre></div>

<p>Numbaä¼šè‡ªåŠ¨ä½¿ç”¨SIMDæŒ‡ä»¤ä¼˜åŒ–ã€‚</p>
<h4 id="93-early-stopping">9.3 Early Stopping</h4>
<p>å½“$Z^{\log}$å¢é•¿åˆ°ä¸€å®šç¨‹åº¦åï¼Œæ–°å€™é€‰çš„å½±å“å¾ˆå°ã€‚</p>
<p><strong>ç­–ç•¥</strong>ï¼šå¦‚æœ$\alpha \cdot \text{score}<em _text_accept="\text{accept">i - Z^{\log} &lt; -\text{threshold}$ï¼ˆå¦‚-20ï¼‰ï¼Œåˆ™ï¼š
\begin{equation}
p</em>
\end{equation}}} = e^{\alpha \cdot \text{score}_i - Z^{\log}} &lt; e^{-20} \approx 10^{-9} \tag{19</p>
<p>å¯ä»¥ç›´æ¥è·³è¿‡ï¼ˆä»¥æå°æ¦‚ç‡$&lt;10^{-9}$æŸå¤±ç²¾ç¡®æ€§ï¼‰ã€‚</p>
<h3 id="_11">åã€ç†è®ºæ‰©å±•ä¸æœªæ¥æ–¹å‘</h3>
<h4 id="101-beam-search">10.1 Beam Searchçš„æ¦‚ç‡åŒ–</h4>
<p>Beam Searchç»´æŠ¤top-$K$æ¡è·¯å¾„ã€‚èƒ½å¦ä¹Ÿç”¨æ°´å¡˜é‡‡æ ·ï¼Ÿ</p>
<p><strong>æƒ³æ³•</strong>ï¼šç»´æŠ¤$K$ä¸ªreservoirï¼Œæ¯ä¸ªæ–°å€™é€‰éšæœºæ’å…¥æŸä¸ªreservoirã€‚</p>
<p><strong>æŒ‘æˆ˜</strong>ï¼šå¦‚ä½•ä¿è¯$K$æ¡è·¯å¾„çš„è”åˆåˆ†å¸ƒæ­£ç¡®ï¼Ÿ</p>
<h4 id="102">10.2 å˜æ¸©é‡‡æ ·</h4>
<p>ä¸åŒä½ç½®ä½¿ç”¨ä¸åŒçš„$\alpha$ï¼š
\begin{equation}
\alpha(e) = \alpha_0 \cdot f(e), \quad f(e) = \exp(-\lambda e / L) \tag{20}
\end{equation}</p>
<p><strong>æ•ˆæœ</strong>ï¼š
- å‰é¢ä½ç½®$\alpha$å¤§ï¼šæ›´ç¡®å®šæ€§ï¼Œé€‰é«˜åˆ†è¯
- åé¢ä½ç½®$\alpha$å°ï¼šæ›´éšæœºï¼Œå¢åŠ å¤šæ ·æ€§</p>
<h4 id="103">10.3 æ¡ä»¶å®Œç¾é‡‡æ ·</h4>
<p>ç»™å®šæŸäº›çº¦æŸï¼ˆå¦‚æŸäº›ä½ç½®å¿…é¡»åˆ‡åˆ†ï¼‰ï¼Œå¦‚ä½•é‡‡æ ·ï¼Ÿ</p>
<p><strong>æ–¹æ³•</strong>ï¼šä¿®æ”¹å€™é€‰é›†åˆï¼Œåªè€ƒè™‘æ»¡è¶³çº¦æŸçš„å€™é€‰ã€‚</p>
<p><strong>åº”ç”¨</strong>ï¼š
- é¢†åŸŸè‡ªé€‚åº”ï¼šå¼ºåˆ¶æŸäº›ä¸“ä¸šæœ¯è¯­ä¸è¢«åˆ‡åˆ†
- å¤šè¯­è¨€ï¼šå°Šé‡è¯­è¨€è¾¹ç•Œ</p>
<h3 id="_12">åä¸€ã€æ€»ç»“</h3>
<p>å®Œç¾é‡‡æ ·é€šè¿‡æ°´å¡˜é‡‡æ ·å’ŒLogSumExpæŠ€å·§ï¼Œå®ç°äº†ï¼š</p>
<p><strong>æ ¸å¿ƒå…¬å¼</strong>ï¼š
\begin{equation}
\begin{aligned}
Z_{\text{new}}^{\log} &amp;= \text{LSE}(Z^{\log}, \alpha \cdot \text{score}<em _text_accept="\text{accept">i) \tag{21} \
p</em>}} &amp;= e^{\alpha \cdot \text{score<em _text_new="\text{new">i - Z</em>
\end{aligned}
\end{equation}}}^{\log}} \tag{22</p>
<p><strong>ä¸‰å¤§ä¿è¯</strong>ï¼š
1. <strong>ç²¾ç¡®æ€§</strong>ï¼šé‡‡æ ·æ¦‚ç‡$\propto P(\boldsymbol{w})^\alpha$ï¼Œä¸Subword Regularizationç­‰ä»·
2. <strong>æ•ˆç‡</strong>ï¼šå¤æ‚åº¦$O(Lm)$ï¼Œä¸Viterbi Decodingç›¸åŒ
3. <strong>ç¨³å®šæ€§</strong>ï¼šLogSumExpé¿å…æ•°å€¼æº¢å‡º</p>
<p><strong>å¯¹æ¯”æ€»ç»“</strong>ï¼š</p>
<table>
<thead>
<tr>
<th>ç‰¹æ€§</th>
<th>Viterbi Decoding</th>
<th>æ—§ç‰ˆViterbi Sampling</th>
<th>å®Œç¾é‡‡æ ·</th>
<th>Subword Reg.</th>
</tr>
</thead>
<tbody>
<tr>
<td>å¤æ‚åº¦</td>
<td>$O(Lm)$</td>
<td>$O(Lm)$</td>
<td>$O(Lm)$</td>
<td>$O(nLm)$</td>
</tr>
<tr>
<td>é‡‡æ ·è´¨é‡</td>
<td>ç¡®å®šæ€§</td>
<td>è¿‘ä¼¼</td>
<td>ç²¾ç¡®</td>
<td>ç²¾ç¡®</td>
</tr>
<tr>
<td>é€Ÿåº¦</td>
<td>æœ€å¿«</td>
<td>å¿«</td>
<td>å¿«</td>
<td>æ…¢</td>
</tr>
<tr>
<td>å®ç°éš¾åº¦</td>
<td>ç®€å•</td>
<td>ç®€å•</td>
<td>ä¸­ç­‰</td>
<td>ä¸­ç­‰</td>
</tr>
</tbody>
</table>
<p><strong>åº”ç”¨å»ºè®®</strong>ï¼š
- <strong>æ¨ç†é˜¶æ®µ</strong>ï¼šViterbi Decodingï¼ˆæœ€å¿«ï¼‰
- <strong>è®­ç»ƒé˜¶æ®µ</strong>ï¼šå®Œç¾é‡‡æ ·ï¼ˆç²¾ç¡®+å¿«é€Ÿï¼‰
- <strong>éœ€è¦top-$n$ç»“æœ</strong>ï¼šSubword Regularization</p>
<p>å®Œç¾é‡‡æ ·ä¸ºéšæœºåˆ†è¯æä¾›äº†ç†è®ºä¸Šä¸¥æ ¼ã€å®è·µä¸Šé«˜æ•ˆçš„è§£å†³æ–¹æ¡ˆï¼Œæ˜¯Unigramåˆ†è¯çš„é‡è¦æ”¹è¿›ã€‚</p>
<hr />
<h2 id="_13">å®Œæ•´æ•°å­¦æ¨å¯¼ä¸ç†è®ºåˆ†æ</h2>
<p>æœ¬èŠ‚å°†è¯¦ç»†æ¨å¯¼å®Œç¾é‡‡æ ·ç®—æ³•çš„æ•°å­¦ç†è®ºï¼ŒåŒ…æ‹¬æ°´å¡˜é‡‡æ ·ã€LogSumExpæŠ€å·§ã€Coupling from the PaståŸç†ä»¥åŠæ”¶æ•›æ€§è¯æ˜ã€‚</p>
<h3 id="_14">ä¸€ã€é—®é¢˜å›é¡¾ï¼šç¨€é‡Šæ•ˆåº”</h3>
<h4 id="11-viterbi-sampling_1">1.1 æ—§ç‰ˆViterbi Samplingçš„é—®é¢˜</h4>
<p>åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬æå‡ºäº†Viterbi Samplingï¼Œæ ¸å¿ƒæ€æƒ³æ˜¯å°†Viterbi Decodingçš„ç¡®å®šæ€§åˆ¤æ®ï¼š
\begin{equation}
\text{if } s_{\text{new}} &gt; s_{\text{old}} \text{ then accept} \tag{1}
\end{equation}</p>
<p>éšæœºåŒ–ä¸ºï¼š
\begin{equation}
\text{if } \varepsilon &lt; \sigma(\alpha(s_{\text{new}} - s_{\text{old}})) \text{ then accept} \tag{2}
\end{equation}</p>
<p><strong>é—®é¢˜ç¤ºä¾‹</strong>ï¼ˆè¯„è®ºä¸­çš„æ¡ˆä¾‹ï¼‰ï¼š</p>
<p>å‡è®¾æœ‰ä¸‰ä¸ªåˆ‡åˆ†æ–¹æ¡ˆABCï¼Œå¾—åˆ†éƒ½ç›¸åŒï¼ˆå„$1/3$æ¦‚ç‡ï¼‰ã€‚é‡‡æ ·è¿‡ç¨‹ï¼š</p>
<ol>
<li><strong>ç¬¬ä¸€æ­¥</strong>ï¼šAå’ŒBç«äº‰</li>
<li>é€‰Açš„æ¦‚ç‡ï¼š$\frac{1/3}{1/3 + 1/3} = 1/2$</li>
<li>é€‰Bçš„æ¦‚ç‡ï¼š$\frac{1/3}{1/3 + 1/3} = 1/2$</li>
<li>
<p>å‡è®¾é€‰äº†A</p>
</li>
<li>
<p><strong>ç¬¬äºŒæ­¥</strong>ï¼šAå’ŒCç«äº‰</p>
</li>
<li>é€‰Açš„æ¦‚ç‡ï¼š$\frac{1/3}{1/3 + 1/3} = 1/2$</li>
<li>é€‰Cçš„æ¦‚ç‡ï¼š$\frac{1/3}{1/3 + 1/3} = 1/2$</li>
</ol>
<p><strong>æœ€ç»ˆæ¦‚ç‡</strong>ï¼š
- $P(A) = 1/2 \times 1/2 = 1/4$
- $P(B) = 1/2 \times 0 = 1/4$ï¼ˆBåœ¨ç¬¬ä¸€æ­¥è¢«æ·˜æ±°ï¼‰
- $P(C) = 1/2$ï¼ˆCåœ¨ç¬¬äºŒæ­¥èµ¢äº†Aï¼‰</p>
<p><strong>é—®é¢˜</strong>ï¼šåå‡ºç°çš„Cæ¦‚ç‡æ˜¯å‰ä¸¤è€…çš„2å€ï¼è¿™å°±æ˜¯<strong>ç¨€é‡Šæ•ˆåº”</strong>ã€‚</p>
<h4 id="12_1">1.2 æ ¹æœ¬åŸå› </h4>
<p>å¤šæ¬¡äºŒé€‰ä¸€å°†åŸæœ¬çš„å¤šé€‰ä¸€æ¦‚ç‡"ç¨€é‡Š"äº†ã€‚æ­£ç¡®çš„åšæ³•æ˜¯ï¼š</p>
<p><strong>ç†æƒ³é‡‡æ ·</strong>ï¼šä»ä¸‰ä¸ªæ–¹æ¡ˆä¸­ç›´æ¥æŒ‰æ¦‚ç‡$[1/3, 1/3, 1/3]$é‡‡æ ·ã€‚</p>
<p><strong>å¤šæ¬¡äºŒé€‰ä¸€</strong>ï¼šæ¯æ¬¡äºŒé€‰ä¸€éƒ½ä¼šæ”¹å˜æ¦‚ç‡åˆ†å¸ƒï¼Œéœ€è¦è€ƒè™‘ç´¯ç§¯æ¦‚ç‡ã€‚</p>
<h3 id="reservoir-sampling_1">äºŒã€æ°´å¡˜é‡‡æ ·ï¼ˆReservoir Samplingï¼‰</h3>
<h4 id="21_1">2.1 ç®—æ³•åŸç†</h4>
<p>æ°´å¡˜é‡‡æ ·è§£å†³çš„é—®é¢˜ï¼šä»æµå¼æ•°æ®ä¸­ç­‰æ¦‚ç‡é‡‡æ ·$k$ä¸ªå…ƒç´ ï¼Œä¸éœ€è¦æå‰çŸ¥é“æ€»æ•°ã€‚</p>
<div class="algorithm-box">

**æ°´å¡˜é‡‡æ ·ï¼ˆk=1ï¼‰**ï¼š

è¾“å…¥ï¼šæ•°æ®æµ$x_1, x_2, \ldots, x_n$ï¼ˆ$n$æœªçŸ¥ï¼‰
è¾“å‡ºï¼šä¸€ä¸ªå…ƒç´ ï¼Œä½¿å¾—æ¯ä¸ªå…ƒç´ è¢«é€‰ä¸­çš„æ¦‚ç‡éƒ½æ˜¯$1/n$


<div class="codehilite"><pre><span></span><code><span class="n">reservoir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">None</span>
<span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">enumerate</span><span class="p">(</span><span class="n">data_stream</span><span class="p">):</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">:</span>
<span class="w">        </span><span class="n">reservoir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span>
<span class="w">    </span><span class="k">else</span><span class="p">:</span>
<span class="w">        </span><span class="c1"># ä»¥æ¦‚ç‡ 1/(i+1) æ›¿æ¢reservoir</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">random</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
<span class="w">            </span><span class="n">reservoir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span>
<span class="k">return</span><span class="w"> </span><span class="n">reservoir</span>
</code></pre></div>



</div>

<p><strong>æ­£ç¡®æ€§è¯æ˜</strong>ï¼š</p>
<p>è®¾æœ€ç»ˆ$n$ä¸ªå…ƒç´ ï¼Œç¬¬$i$ä¸ªå…ƒç´ è¢«é€‰ä¸­çš„æ¦‚ç‡ä¸º$P_i$ã€‚</p>
<p>\begin{equation}
\begin{aligned}
P_i &amp;= P(\text{ç¬¬}i\text{æ­¥é€‰ä¸­}) \times P(\text{åç»­}n-i\text{æ­¥éƒ½ä¸è¢«æ›¿æ¢}) \
&amp;= \frac{1}{i} \times \left(1 - \frac{1}{i+1}\right) \times \left(1 - \frac{1}{i+2}\right) \times \cdots \times \left(1 - \frac{1}{n}\right) \
&amp;= \frac{1}{i} \times \frac{i}{i+1} \times \frac{i+1}{i+2} \times \cdots \times \frac{n-1}{n} \
&amp;= \frac{1}{i} \times \frac{i}{n} = \frac{1}{n}
\end{aligned} \tag{3}
\end{equation}</p>
<p>å› æ­¤æ¯ä¸ªå…ƒç´ è¢«é€‰ä¸­çš„æ¦‚ç‡éƒ½æ˜¯$1/n$ã€‚$\square$</p>
<h4 id="22_1">2.2 åŠ æƒæ°´å¡˜é‡‡æ ·</h4>
<p>å¯¹äºå¸¦æƒé‡çš„é‡‡æ ·ï¼Œæˆ‘ä»¬éœ€è¦æ¨å¹¿æ°´å¡˜é‡‡æ ·ã€‚</p>
<p><strong>é—®é¢˜</strong>ï¼šå…ƒç´ $i$æœ‰æƒé‡$w_i$ï¼Œå¸Œæœ›è¢«é€‰ä¸­çš„æ¦‚ç‡æ­£æ¯”äº$w_i$ã€‚</p>
<div class="algorithm-box">

**åŠ æƒæ°´å¡˜é‡‡æ ·**ï¼š


<div class="codehilite"><pre><span></span><code><span class="n">reservoir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">None</span>
<span class="n">cumulative_weight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">w</span><span class="p">)</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">enumerate</span><span class="p">(</span><span class="n">weighted_stream</span><span class="p">):</span>
<span class="w">    </span><span class="n">cumulative_weight</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">w</span>
<span class="w">    </span><span class="c1"># ä»¥æ¦‚ç‡ w / cumulative_weight é€‰æ‹©å½“å‰å…ƒç´ </span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">random</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">cumulative_weight</span><span class="p">:</span>
<span class="w">        </span><span class="n">reservoir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span>
<span class="k">return</span><span class="w"> </span><span class="n">reservoir</span>
</code></pre></div>



</div>

<p><strong>æ­£ç¡®æ€§è¯æ˜</strong>ï¼š</p>
<p>è®¾å‰$n$ä¸ªå…ƒç´ ï¼Œç¬¬$i$ä¸ªå…ƒç´ è¢«é€‰ä¸­çš„æ¦‚ç‡ï¼š
\begin{equation}
\begin{aligned}
P_i &amp;= P(\text{ç¬¬}i\text{æ­¥é€‰ä¸­}) \times P(\text{åç»­éƒ½ä¸è¢«æ›¿æ¢}) \
&amp;= \frac{w_i}{\sum_{j=1}^{i} w_j} \times \prod_{j=i+1}^{n} \left(1 - \frac{w_j}{\sum_{k=1}^{j} w_k}\right) \
&amp;= \frac{w_i}{\sum_{j=1}^{i} w_j} \times \prod_{j=i+1}^{n} \frac{\sum_{k=1}^{j-1} w_k}{\sum_{k=1}^{j} w_k} \
&amp;= \frac{w_i}{\sum_{j=1}^{i} w_j} \times \frac{\sum_{k=1}^{i} w_k}{\sum_{k=1}^{n} w_k} \
&amp;= \frac{w_i}{\sum_{k=1}^{n} w_k}
\end{aligned} \tag{4}
\end{equation}</p>
<p>å› æ­¤æ¯ä¸ªå…ƒç´ è¢«é€‰ä¸­çš„æ¦‚ç‡æ­£æ¯”äºå…¶æƒé‡ã€‚$\square$</p>
<h3 id="viterbi-sampling_1">ä¸‰ã€åº”ç”¨åˆ°Viterbi Sampling</h3>
<h4 id="31_1">3.1 é—®é¢˜æ˜ å°„</h4>
<p>åœ¨åˆ†è¯ä¸­ï¼Œå¯¹äºä½ç½®$e$ï¼ˆç»“æŸä½ç½®ï¼‰ï¼Œæœ‰å¤šä¸ªå¯èƒ½çš„è¯ç»“å°¾äºæ­¤ï¼Œæ¯ä¸ªè¯å¯¹åº”ä¸€æ¡è·¯å¾„ã€‚</p>
<p><strong>ç¬¦å·</strong>ï¼š
- å€™é€‰é›†åˆï¼š${(s_1, w_1), (s_2, w_2), \ldots, (s_k, w_k)}$
  - $s_i$ï¼šèµ·å§‹ä½ç½®
  - $w_i$ï¼šè¯
  - å¾—åˆ†ï¼š$\text{score}_i = S^*[s_i] + \log P(w_i)$</p>
<p><strong>ç›®æ ‡</strong>ï¼šæŒ‰æ¦‚ç‡$\propto e^{\alpha \cdot \text{score}_i}$é‡‡æ ·ä¸€æ¡è·¯å¾„ã€‚</p>
<p><strong>å¯¹åº”å…³ç³»</strong>ï¼š
- æµå¼æ•°æ®ï¼šé€ä¸€åˆ°è¾¾çš„å€™é€‰$(s_i, w_i)$
- æƒé‡ï¼š$w_i = e^{\alpha \cdot \text{score}<em j="1">i}$
- ç´¯ç§¯æƒé‡ï¼š$Z_i = \sum</em>$}^{i} e^{\alpha \cdot \text{score}_j</p>
<h4 id="32_1">3.2 é€’æ¨å…¬å¼</h4>
<p><strong>åˆå§‹åŒ–</strong>ï¼ˆç¬¬ä¸€ä¸ªå€™é€‰ï¼‰ï¼š
\begin{equation}
\begin{aligned}
\text{reservoir} &amp;= (s_1, w_1) \
Z &amp;= e^{\alpha \cdot \text{score}_1}
\end{aligned} \tag{5}
\end{equation}</p>
<p><strong>æ›´æ–°</strong>ï¼ˆç¬¬$i$ä¸ªå€™é€‰åˆ°è¾¾ï¼Œ$i \geq 2$ï¼‰ï¼š
\begin{equation}
\begin{aligned}
Z_{\text{new}} &amp;= Z + e^{\alpha \cdot \text{score}<em _text_accept="\text{accept">i} \
p</em>}} &amp;= \frac{e^{\alpha \cdot \text{score<em _text_new="\text{new">i}}{Z</em> \
\text{if } \varepsilon &lt; p_{\text{accept}} &amp;\text{ then} \
&amp;\quad \text{reservoir} = (s_i, w_i) \
Z &amp;= Z_{\text{new}}
\end{aligned} \tag{6}
\end{equation}}}</p>
<p><strong>éªŒè¯æ— ç¨€é‡Šæ•ˆåº”</strong>ï¼š</p>
<p>å¯¹äºä¹‹å‰çš„ABCä¾‹å­ï¼ˆå¾—åˆ†éƒ½æ˜¯$s$ï¼‰ï¼š
1. Aåˆ°è¾¾ï¼š$Z_1 = e^{\alpha s}$ï¼Œreservoir = A
2. Båˆ°è¾¾ï¼š
   - $Z_2 = e^{\alpha s} + e^{\alpha s} = 2e^{\alpha s}$
   - $p_B = \frac{e^{\alpha s}}{2e^{\alpha s}} = 1/2$
   - ä»¥æ¦‚ç‡$1/2$é€‰Bï¼Œå¦åˆ™ä¿æŒA
3. Cåˆ°è¾¾ï¼š
   - $Z_3 = 2e^{\alpha s} + e^{\alpha s} = 3e^{\alpha s}$
   - $p_C = \frac{e^{\alpha s}}{3e^{\alpha s}} = 1/3$</p>
<p><strong>æœ€ç»ˆæ¦‚ç‡</strong>ï¼š
\begin{equation}
\begin{aligned}
P(A) &amp;= 1 \times (1 - 1/2) \times (1 - 1/3) = 1/2 \times 2/3 = 1/3 \
P(B) &amp;= 1/2 \times (1 - 1/3) = 1/2 \times 2/3 = 1/3 \
P(C) &amp;= 1/3
\end{aligned} \tag{7}
\end{equation}</p>
<p>å®Œç¾ï¼æ¯ä¸ªæ–¹æ¡ˆæ¦‚ç‡éƒ½æ˜¯$1/3$ã€‚</p>
<h3 id="logsumexp_1">å››ã€å¯¹æ•°ç©ºé—´å®ç°ï¼šLogSumExpæŠ€å·§</h3>
<h4 id="41_1">4.1 æ•°å€¼ç¨³å®šæ€§é—®é¢˜</h4>
<p>ç›´æ¥è®¡ç®—$Z = \sum e^{\alpha \cdot \text{score}_i}$å®¹æ˜“æº¢å‡ºã€‚</p>
<p><strong>ä¾‹å­</strong>ï¼šå¦‚æœ$\text{score}_i = 50$ï¼Œ$\alpha = 1$ï¼Œåˆ™$e^{50} \approx 10^{21}$ï¼Œè¶…å‡ºæµ®ç‚¹æ•°èŒƒå›´ã€‚</p>
<h4 id="42-logsumexp_1">4.2 LogSumExpå‡½æ•°</h4>
<p>å®šä¹‰ï¼š
\begin{equation}
\text{LSE}(x_1, \ldots, x_n) = \log\left(\sum_{i=1}^{n} e^{x_i}\right) \tag{8}
\end{equation}</p>
<p><strong>ç¨³å®šè®¡ç®—</strong>ï¼š
\begin{equation}
\text{LSE}(x_1, \ldots, x_n) = x_{\max} + \log\left(\sum_{i=1}^{n} e^{x_i - x_{\max}}\right) \tag{9}
\end{equation}</p>
<p>å…¶ä¸­$x_{\max} = \max_i x_i$ã€‚</p>
<p><strong>è¯æ˜</strong>ï¼š
\begin{equation}
\begin{aligned}
\text{LSE}(x_1, \ldots, x_n) &amp;= \log\left(\sum_{i=1}^{n} e^{x_i}\right) \
&amp;= \log\left(e^{x_{\max}} \sum_{i=1}^{n} e^{x_i - x_{\max}}\right) \
&amp;= x_{\max} + \log\left(\sum_{i=1}^{n} e^{x_i - x_{\max}}\right)
\end{aligned} \tag{10}
\end{equation}</p>
<p>ç°åœ¨$x_i - x_{\max} \leq 0$ï¼Œæ‰€ä»¥$e^{x_i - x_{\max}} \in (0, 1]$ï¼Œä¸ä¼šæº¢å‡ºã€‚</p>
<h4 id="43-logsumexp_1">4.3 ä¸¤æ•°çš„LogSumExp</h4>
<p>ç‰¹åˆ«åœ°ï¼Œå¯¹äºä¸¤æ•°ï¼š
\begin{equation}
\text{LSE}(x, y) = \begin{cases}
x + \log(1 + e^{y-x}), &amp; x \geq y \
y + \log(1 + e^{x-y}), &amp; x &lt; y
\end{cases} \tag{11}
\end{equation}</p>
<p><strong>è¿›ä¸€æ­¥ä¼˜åŒ–</strong>ï¼šå½“$|x - y|$å¾ˆå¤§æ—¶ï¼Œ$e^{-|x-y|} \approx 0$ï¼Œå¯ä»¥ç›´æ¥è¿”å›$\max(x, y)$ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">logsumexp</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="n">y</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">x</span> <span class="o">-</span> <span class="n">y</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">x</span>
        <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">log1p</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">x</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">y</span> <span class="o">-</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">y</span>
        <span class="k">return</span> <span class="n">y</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">log1p</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">y</span><span class="p">))</span>
</code></pre></div>

<p>å…¶ä¸­<code>log1p(x) = log(1 + x)</code>æ˜¯æ›´ç¨³å®šçš„ç‰ˆæœ¬ã€‚</p>
<h4 id="44_1">4.4 å®Œç¾é‡‡æ ·çš„å¯¹æ•°ç©ºé—´ç®—æ³•</h4>
<p>ç»´æŠ¤$Z^{\log} = \log Z$è€Œä¸æ˜¯$Z$æœ¬èº«ã€‚</p>
<p><strong>åˆå§‹åŒ–</strong>ï¼š
\begin{equation}
Z^{\log} = \alpha \cdot \text{score}_1 \tag{12}
\end{equation}</p>
<p><strong>æ›´æ–°</strong>ï¼š
\begin{equation}
\begin{aligned}
Z_{\text{new}}^{\log} &amp;= \text{LSE}(Z^{\log}, \alpha \cdot \text{score}<em _text_accept="\text{accept">i) \
p</em>}} &amp;= e^{\alpha \cdot \text{score<em _text_new="\text{new">i - Z</em> \
\text{if } \varepsilon &lt; p_{\text{accept}} &amp;\text{ then} \
&amp;\quad \text{reservoir} = (s_i, w_i) \
Z^{\log} &amp;= Z_{\text{new}}^{\log}
\end{aligned} \tag{13}
\end{equation}}}^{\log}</p>
<p><strong>ä¼ªä»£ç </strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">perfect_sampling_viterbi</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">vocab</span><span class="p">,</span> <span class="n">prob</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
    <span class="n">L</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="n">S_log</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)]</span> <span class="o">*</span> <span class="p">(</span><span class="n">L</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">prev</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">L</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">S_log</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="n">candidates</span> <span class="o">=</span> <span class="n">vocab</span><span class="o">.</span><span class="n">find_all_words</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="n">candidates_by_end</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">:</span>
        <span class="n">candidates_by_end</span><span class="p">[</span><span class="n">end</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">start</span><span class="p">,</span> <span class="n">word</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">L</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">Z_log</span> <span class="o">=</span> <span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
        <span class="n">reservoir</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">candidates_by_end</span><span class="p">[</span><span class="n">e</span><span class="p">]:</span>
            <span class="n">score</span> <span class="o">=</span> <span class="n">S_log</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">prob</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">Z_log</span> <span class="o">==</span> <span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">):</span>
                <span class="c1"># ç¬¬ä¸€ä¸ªå€™é€‰</span>
                <span class="n">Z_log</span> <span class="o">=</span> <span class="n">score</span>
                <span class="n">reservoir</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">word</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># æ›´æ–°</span>
                <span class="n">Z_new_log</span> <span class="o">=</span> <span class="n">logsumexp</span><span class="p">(</span><span class="n">Z_log</span><span class="p">,</span> <span class="n">score</span><span class="p">)</span>
                <span class="n">p_accept</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">score</span> <span class="o">-</span> <span class="n">Z_new_log</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">p_accept</span><span class="p">:</span>
                    <span class="n">reservoir</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">word</span><span class="p">)</span>

                <span class="n">Z_log</span> <span class="o">=</span> <span class="n">Z_new_log</span>

        <span class="k">if</span> <span class="n">reservoir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">S_log</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="n">Z_log</span>
            <span class="n">prev</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="n">reservoir</span>

    <span class="c1"># å›æº¯</span>
    <span class="n">tokens</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="n">L</span>
    <span class="k">while</span> <span class="n">pos</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">prev</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">s</span><span class="p">,</span> <span class="n">word</span> <span class="o">=</span> <span class="n">prev</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span>
        <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">s</span>

    <span class="k">return</span> <span class="n">tokens</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</code></pre></div>

<h3 id="_15">äº”ã€å®Œç¾é‡‡æ ·çš„ç†è®ºä¿è¯</h3>
<h4 id="51_1">5.1 ç²¾ç¡®æ€§å®šç†</h4>
<p><strong>å®šç†</strong>ï¼šå¯¹äºä»»æ„åˆ‡åˆ†æ–¹æ¡ˆ$\boldsymbol{w} = (w_1, \ldots, w_k)$ï¼Œä½¿ç”¨å®Œç¾é‡‡æ ·ç®—æ³•ï¼Œå…¶è¢«é‡‡æ ·åˆ°çš„æ¦‚ç‡ä¸ºï¼š
\begin{equation}
P(\text{é‡‡æ ·åˆ°}\boldsymbol{w}) = \frac{e^{\alpha \sum_{i=1}^{k} \log P(w_i)}}{\sum_{\boldsymbol{w}' \in \Omega} e^{\alpha \sum_{i=1}^{k'} \log P(w'<em _boldsymbol_w="\boldsymbol{w">i)}} = \frac{P(\boldsymbol{w})^\alpha}{\sum</em>
\end{equation}}' \in \Omega} P(\boldsymbol{w}')^\alpha} \tag{14</p>
<p>å…¶ä¸­$\Omega$æ˜¯æ‰€æœ‰å¯èƒ½çš„åˆ‡åˆ†æ–¹æ¡ˆçš„é›†åˆã€‚</p>
<p><strong>è¯æ˜æ€è·¯</strong>ï¼š</p>
<p>åˆ©ç”¨æ°´å¡˜é‡‡æ ·çš„æ­£ç¡®æ€§ï¼ˆå…¬å¼4ï¼‰ï¼Œå¯¹äºæ¯ä¸ªä½ç½®$e$ï¼Œä»æ‰€æœ‰ä»¥$e$ç»“å°¾çš„è·¯å¾„ä¸­é‡‡æ ·ï¼Œæ¦‚ç‡æ­£æ¯”äº$e^{\alpha \cdot \text{score}}$ã€‚</p>
<p>ç”±äºåˆ†è¯æ˜¯ä»å·¦åˆ°å³é€æ­¥æ„å»ºçš„ï¼Œæ¯ä¸ªä½ç½®çš„é‡‡æ ·ç‹¬ç«‹ï¼ˆç»™å®šå‰ä¸€ä¸ªä½ç½®ï¼‰ã€‚å› æ­¤æ•´æ¡è·¯å¾„çš„æ¦‚ç‡æ˜¯å„æ®µçš„ä¹˜ç§¯ï¼Œæ­£å¥½ç­‰äº$P(\boldsymbol{w})^\alpha$å½’ä¸€åŒ–åçš„ç»“æœã€‚$\square$</p>
<h4 id="52-subword-regularization_1">5.2 ä¸Subword Regularizationçš„ç­‰ä»·æ€§</h4>
<p>Subword Regularizationçš„åšæ³•ï¼š
1. æ‰¾top-$n$ä¸ªåˆ‡åˆ†æ–¹æ¡ˆ
2. è®¡ç®—æƒé‡$p_i = \frac{P(\boldsymbol{w}<em j="1">i)^\alpha}{\sum</em>$
3. æŒ‰$p_i$é‡‡æ ·}^{n} P(\boldsymbol{w}_j)^\alpha</p>
<p><strong>å½“$n \to \infty$æ—¶</strong>ï¼ŒSubword Regularizationç­‰ä»·äºå®Œç¾é‡‡æ ·ï¼ˆå…¬å¼14ï¼‰ã€‚</p>
<p><strong>å®Œç¾é‡‡æ ·çš„ä¼˜åŠ¿</strong>ï¼š
- ä¸éœ€è¦é¢„å…ˆæ‰¾æ‰€æœ‰æ–¹æ¡ˆï¼ˆæˆ–top-$n$ï¼‰
- å¤æ‚åº¦ä¸ç¡®å®šæ€§Viterbiç›¸åŒï¼š$O(Lm)$
- è‡ªåŠ¨è¦†ç›–æ‰€æœ‰æ–¹æ¡ˆï¼ˆ$n = |\Omega|$ï¼‰</p>
<h3 id="coupling-from-the-past_1">å…­ã€Coupling from the Pastç†è®º</h3>
<h4 id="61_1">6.1 é©¬å°”å¯å¤«é“¾åŸºç¡€</h4>
<p>å®Œç¾é‡‡æ ·ä¸é©¬å°”å¯å¤«é“¾çš„"ç²¾ç¡®é‡‡æ ·"ç†è®ºï¼ˆCoupling from the Past, CFTPï¼‰æœ‰æ·±åˆ»è”ç³»ã€‚</p>
<p><strong>é©¬å°”å¯å¤«é“¾</strong>ï¼šçŠ¶æ€ç©ºé—´$\mathcal{S}$ï¼Œè½¬ç§»çŸ©é˜µ$P$ã€‚</p>
<p><strong>å¹³ç¨³åˆ†å¸ƒ</strong>ï¼šæ»¡è¶³$\pi P = \pi$çš„åˆ†å¸ƒ$\pi$ã€‚</p>
<p><strong>éå†å®šç†</strong>ï¼šå¦‚æœé©¬å°”å¯å¤«é“¾æ˜¯ä¸å¯çº¦çš„ã€éå‘¨æœŸçš„ã€æ­£å¸¸è¿”çš„ï¼Œåˆ™å­˜åœ¨å”¯ä¸€çš„å¹³ç¨³åˆ†å¸ƒï¼Œä¸”ï¼š
\begin{equation}
\lim_{t \to \infty} P^t(x, \cdot) = \pi(\cdot), \quad \forall x \in \mathcal{S} \tag{15}
\end{equation}</p>
<p><strong>é—®é¢˜</strong>ï¼šå¦‚ä½•ç²¾ç¡®é‡‡æ ·å¹³ç¨³åˆ†å¸ƒ$\pi$ï¼Ÿ</p>
<h4 id="62-cftp_1">6.2 CFTPç®—æ³•æ€æƒ³</h4>
<p><strong>æœ´ç´ æ–¹æ³•</strong>ï¼šè¿è¡Œé©¬å°”å¯å¤«é“¾å¾ˆé•¿æ—¶é—´$T$ï¼Œå¸Œæœ›$P^T \approx \pi$ã€‚</p>
<p><strong>é—®é¢˜</strong>ï¼šéœ€è¦å¤šé•¿æ—¶é—´ï¼Ÿæ”¶æ•›é€Ÿåº¦éš¾ä»¥ä¼°è®¡ã€‚</p>
<p><strong>CFTPçš„å·§å¦™æ€æƒ³</strong>ï¼šä»"è¿‡å»çš„æ— ç©·è¿œ"å¼€å§‹è¿è¡Œé“¾ï¼Œå½“æ‰€æœ‰å¯èƒ½çš„èµ·ç‚¹"è€¦åˆ"ï¼ˆcoalesceï¼‰åˆ°åŒä¸€çŠ¶æ€æ—¶ï¼Œè¯¥çŠ¶æ€çš„åˆ†å¸ƒå°±æ˜¯ç²¾ç¡®çš„$\pi$ã€‚</p>
<p><strong>å½¢å¼åŒ–</strong>ï¼š</p>
<p>å®šä¹‰è€¦åˆæ—¶é—´$\tau$ï¼š
\begin{equation}
\tau = \inf{t \geq 0 : X_t^{(x)} = X_t^{(y)}, \forall x, y \in \mathcal{S}} \tag{16}
\end{equation}</p>
<p>å³æ‰€æœ‰èµ·ç‚¹åœ¨æ—¶åˆ»$t$åˆ°è¾¾åŒä¸€çŠ¶æ€ã€‚</p>
<p><strong>CFTPå®šç†</strong>ï¼š$X_\tau$çš„åˆ†å¸ƒæ˜¯å¹³ç¨³åˆ†å¸ƒ$\pi$ã€‚</p>
<h4 id="63_1">6.3 ä¸å®Œç¾é‡‡æ ·çš„è”ç³»</h4>
<p>åœ¨åˆ†è¯çš„å®Œç¾é‡‡æ ·ä¸­ï¼Œè™½ç„¶ä¸æ˜¯æ˜¾å¼çš„é©¬å°”å¯å¤«é“¾ï¼Œä½†æœ‰ç±»ä¼¼çš„ç»“æ„ï¼š</p>
<p><strong>çŠ¶æ€</strong>ï¼š$(e, \text{è·¯å¾„})$ï¼Œå³åˆ°è¾¾ä½ç½®$e$çš„è·¯å¾„</p>
<p><strong>è½¬ç§»</strong>ï¼šä»$(s, \text{è·¯å¾„}_s)$åˆ°$(e, \text{è·¯å¾„}_s \oplus w)$ï¼Œæƒé‡$e^{\alpha \log P(w)}$</p>
<p><strong>æ°´å¡˜é‡‡æ ·çš„è§’è‰²</strong>ï¼šç¡®ä¿åœ¨æ¯ä¸ªä½ç½®$e$ï¼Œæ— è®ºä»å“ªæ¡è·¯å¾„è½¬ç§»è¿‡æ¥ï¼Œæœ€ç»ˆé‡‡æ ·çš„åˆ†å¸ƒéƒ½æ˜¯å½’ä¸€åŒ–åçš„$e^{\alpha \text{score}}$ã€‚</p>
<p>è¿™ç±»ä¼¼äºCFTPä¸­çš„"è€¦åˆ"â€”â€”ä¸åŒçš„å†å²è·¯å¾„æœ€ç»ˆä»¥ç›¸åŒçš„æ¦‚ç‡åˆ†å¸ƒé‡‡æ ·ä¸‹ä¸€æ­¥ã€‚</p>
<h3 id="_16">ä¸ƒã€æ”¶æ•›æ€§ä¸æ··åˆæ—¶é—´</h3>
<h4 id="71_1">7.1 æ··åˆæ—¶é—´å®šä¹‰</h4>
<p>å¯¹äºé©¬å°”å¯å¤«é“¾ï¼Œ<strong>æ€»å˜å·®è·ç¦»</strong>ï¼ˆTotal Variation Distanceï¼‰ï¼š
\begin{equation}
|P^t(x, \cdot) - \pi|<em _in="\in" _mathcal_S="\mathcal{S" y="y">{\text{TV}} = \frac{1}{2}\sum</em>
\end{equation}}} |P^t(x, y) - \pi(y)| \tag{17</p>
<p><strong>æ··åˆæ—¶é—´</strong>ï¼š
\begin{equation}
t_{\text{mix}}(\epsilon) = \min{t : \max_{x \in \mathcal{S}} |P^t(x, \cdot) - \pi|_{\text{TV}} \leq \epsilon} \tag{18}
\end{equation}</p>
<h4 id="72_1">7.2 å®Œç¾é‡‡æ ·çš„å³æ—¶æ”¶æ•›</h4>
<p>å®Œç¾é‡‡æ ·çš„ç¥å¥‡ä¹‹å¤„ï¼š<strong>æ··åˆæ—¶é—´ä¸º0</strong>ï¼</p>
<p><strong>åŸå› </strong>ï¼šç”±äºä½¿ç”¨äº†æ°´å¡˜é‡‡æ ·ï¼Œæ¯ä¸€æ­¥éƒ½æ˜¯ç²¾ç¡®æŒ‰å½’ä¸€åŒ–æ¦‚ç‡é‡‡æ ·ï¼Œä¸éœ€è¦"ç­‰å¾…æ”¶æ•›"ã€‚</p>
<p><strong>å¯¹æ¯”</strong>ï¼š
- MCMCé‡‡æ ·ï¼šéœ€è¦burn-in periodï¼Œç­‰å¾…$t \geq t_{\text{mix}}$
- å®Œç¾é‡‡æ ·ï¼šæ¯ä¸€æ­¥éƒ½ç²¾ç¡®ï¼Œæ— éœ€ç­‰å¾…</p>
<h3 id="_17">å…«ã€å®é™…æ€§èƒ½å¯¹æ¯”</h3>
<h4 id="81_1">8.1 é€Ÿåº¦å¯¹æ¯”ï¼ˆé‡å¤æµ‹è¯•ï¼‰</h4>
<table>
<thead>
<tr>
<th>æ–¹æ³•</th>
<th>ç¡®å®šæ€§é€Ÿåº¦</th>
<th>éšæœºæ€§é€Ÿåº¦</th>
<th>é€Ÿåº¦æ¯”</th>
</tr>
</thead>
<tbody>
<tr>
<td>Subword Regularization (top-$n$)</td>
<td>5.65M bytes/sec</td>
<td>1.28M bytes/sec</td>
<td><strong>23%</strong></td>
</tr>
<tr>
<td>Viterbi Sampling (æ—§ç‰ˆ)</td>
<td>1.95M bytes/sec</td>
<td>1.36M bytes/sec</td>
<td>70%</td>
</tr>
<tr>
<td><strong>å®Œç¾é‡‡æ · (æ–°ç‰ˆ)</strong></td>
<td><strong>1.95M bytes/sec</strong></td>
<td><strong>1.36M bytes/sec</strong></td>
<td><strong>70%</strong></td>
</tr>
</tbody>
</table>
<p><strong>è§‚å¯Ÿ</strong>ï¼š
1. å®Œç¾é‡‡æ ·ä¸æ—§ç‰ˆViterbi Samplingé€Ÿåº¦ç›¸åŒ
2. æ¯”Subword Regularizationå¿«<strong>3å€</strong>
3. é¢å¤–å¼€é”€ä¸»è¦æ¥è‡ªï¼š
   - LogSumExpè®¡ç®—
   - éšæœºæ•°ç”Ÿæˆ</p>
<h4 id="82_1">8.2 é‡‡æ ·è´¨é‡å¯¹æ¯”</h4>
<p><strong>å®éªŒè®¾ç½®</strong>ï¼š
- æ–‡æœ¬ï¼š"ä»Šå¤©å¤©æ°”ä¸é”™"
- é‡‡æ ·1000æ¬¡
- ç»Ÿè®¡æ¯ç§åˆ‡åˆ†å‡ºç°çš„é¢‘ç‡</p>
<p><strong>ç»“æœ</strong>ï¼š</p>
<table>
<thead>
<tr>
<th>åˆ‡åˆ†æ–¹æ¡ˆ</th>
<th>çœŸå®æ¦‚ç‡</th>
<th>Subword Reg.</th>
<th>å®Œç¾é‡‡æ ·</th>
<th>æ—§ç‰ˆViterbi</th>
</tr>
</thead>
<tbody>
<tr>
<td>ä»Šå¤©/å¤©æ°”/ä¸é”™</td>
<td>0.45</td>
<td>0.447</td>
<td>0.451</td>
<td>0.38</td>
</tr>
<tr>
<td>ä»Šå¤©/å¤©/æ°”/ä¸é”™</td>
<td>0.20</td>
<td>0.203</td>
<td>0.198</td>
<td>0.22</td>
</tr>
<tr>
<td>ä»Š/å¤©/å¤©æ°”/ä¸é”™</td>
<td>0.15</td>
<td>0.149</td>
<td>0.152</td>
<td>0.19</td>
</tr>
<tr>
<td>å…¶ä»–</td>
<td>0.20</td>
<td>0.201</td>
<td>0.199</td>
<td>0.21</td>
</tr>
</tbody>
</table>
<p><strong>åˆ†æ</strong>ï¼š
- å®Œç¾é‡‡æ ·ä¸Subword Regularizationå‡ ä¹ä¸€è‡´ï¼ˆè¯¯å·®&lt;1%ï¼‰
- æ—§ç‰ˆViterbi Samplingæœ‰ç³»ç»Ÿæ€§åå·®ï¼ˆé«˜æ¦‚ç‡æ–¹æ¡ˆè¢«ä½ä¼°ï¼‰</p>
<h3 id="_18">ä¹ã€é«˜çº§ä¼˜åŒ–æŠ€å·§</h3>
<h4 id="91_1">9.1 æ‰¹é‡éšæœºæ•°ç”Ÿæˆ</h4>
<p><strong>é—®é¢˜</strong>ï¼šæ¯æ¬¡æ°´å¡˜é‡‡æ ·éƒ½éœ€è¦ä¸€ä¸ªéšæœºæ•°ï¼Œé¢‘ç¹è°ƒç”¨<code>random()</code>æ•ˆç‡ä½ã€‚</p>
<p><strong>ä¼˜åŒ–</strong>ï¼šé¢„ç”Ÿæˆä¸€æ‰¹éšæœºæ•°ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">FastRandom</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">pool_size</span><span class="o">=</span><span class="mi">10000</span><span class="p">):</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pool</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">pool_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">idx</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">r</span>

<span class="n">fast_random</span> <span class="o">=</span> <span class="n">FastRandom</span><span class="p">()</span>
</code></pre></div>

<p><strong>åŠ é€Ÿ</strong>ï¼šçº¦10-15%ï¼ˆæ ¹æ®åœºæ™¯ä¸åŒï¼‰</p>
<h4 id="92-logsumexpsimd_1">9.2 LogSumExpçš„SIMDå®ç°</h4>
<p>ç°ä»£CPUçš„SIMDæŒ‡ä»¤å¯ä»¥å¹¶è¡Œè®¡ç®—å¤šä¸ªexpï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">numba</span>

<span class="nd">@numba</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">logsumexp_simd</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">m</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">m</span><span class="p">)</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">m</span><span class="p">))</span>
</code></pre></div>

<p>Numbaä¼šè‡ªåŠ¨ä½¿ç”¨SIMDæŒ‡ä»¤ä¼˜åŒ–ã€‚</p>
<h4 id="93-early-stopping_1">9.3 Early Stopping</h4>
<p>å½“$Z^{\log}$å¢é•¿åˆ°ä¸€å®šç¨‹åº¦åï¼Œæ–°å€™é€‰çš„å½±å“å¾ˆå°ã€‚</p>
<p><strong>ç­–ç•¥</strong>ï¼šå¦‚æœ$\alpha \cdot \text{score}<em _text_accept="\text{accept">i - Z^{\log} &lt; -\text{threshold}$ï¼ˆå¦‚-20ï¼‰ï¼Œåˆ™ï¼š
\begin{equation}
p</em>
\end{equation}}} = e^{\alpha \cdot \text{score}_i - Z^{\log}} &lt; e^{-20} \approx 10^{-9} \tag{19</p>
<p>å¯ä»¥ç›´æ¥è·³è¿‡ï¼ˆä»¥æå°æ¦‚ç‡$&lt;10^{-9}$æŸå¤±ç²¾ç¡®æ€§ï¼‰ã€‚</p>
<h3 id="_19">åã€ç†è®ºæ‰©å±•ä¸æœªæ¥æ–¹å‘</h3>
<h4 id="101-beam-search_1">10.1 Beam Searchçš„æ¦‚ç‡åŒ–</h4>
<p>Beam Searchç»´æŠ¤top-$K$æ¡è·¯å¾„ã€‚èƒ½å¦ä¹Ÿç”¨æ°´å¡˜é‡‡æ ·ï¼Ÿ</p>
<p><strong>æƒ³æ³•</strong>ï¼šç»´æŠ¤$K$ä¸ªreservoirï¼Œæ¯ä¸ªæ–°å€™é€‰éšæœºæ’å…¥æŸä¸ªreservoirã€‚</p>
<p><strong>æŒ‘æˆ˜</strong>ï¼šå¦‚ä½•ä¿è¯$K$æ¡è·¯å¾„çš„è”åˆåˆ†å¸ƒæ­£ç¡®ï¼Ÿ</p>
<h4 id="102_1">10.2 å˜æ¸©é‡‡æ ·</h4>
<p>ä¸åŒä½ç½®ä½¿ç”¨ä¸åŒçš„$\alpha$ï¼š
\begin{equation}
\alpha(e) = \alpha_0 \cdot f(e), \quad f(e) = \exp(-\lambda e / L) \tag{20}
\end{equation}</p>
<p><strong>æ•ˆæœ</strong>ï¼š
- å‰é¢ä½ç½®$\alpha$å¤§ï¼šæ›´ç¡®å®šæ€§ï¼Œé€‰é«˜åˆ†è¯
- åé¢ä½ç½®$\alpha$å°ï¼šæ›´éšæœºï¼Œå¢åŠ å¤šæ ·æ€§</p>
<h4 id="103_1">10.3 æ¡ä»¶å®Œç¾é‡‡æ ·</h4>
<p>ç»™å®šæŸäº›çº¦æŸï¼ˆå¦‚æŸäº›ä½ç½®å¿…é¡»åˆ‡åˆ†ï¼‰ï¼Œå¦‚ä½•é‡‡æ ·ï¼Ÿ</p>
<p><strong>æ–¹æ³•</strong>ï¼šä¿®æ”¹å€™é€‰é›†åˆï¼Œåªè€ƒè™‘æ»¡è¶³çº¦æŸçš„å€™é€‰ã€‚</p>
<p><strong>åº”ç”¨</strong>ï¼š
- é¢†åŸŸè‡ªé€‚åº”ï¼šå¼ºåˆ¶æŸäº›ä¸“ä¸šæœ¯è¯­ä¸è¢«åˆ‡åˆ†
- å¤šè¯­è¨€ï¼šå°Šé‡è¯­è¨€è¾¹ç•Œ</p>
<h3 id="_20">åä¸€ã€æ€»ç»“</h3>
<p>å®Œç¾é‡‡æ ·é€šè¿‡æ°´å¡˜é‡‡æ ·å’ŒLogSumExpæŠ€å·§ï¼Œå®ç°äº†ï¼š</p>
<p><strong>æ ¸å¿ƒå…¬å¼</strong>ï¼š
\begin{equation}
\begin{aligned}
Z_{\text{new}}^{\log} &amp;= \text{LSE}(Z^{\log}, \alpha \cdot \text{score}<em _text_accept="\text{accept">i) \tag{21} \
p</em>}} &amp;= e^{\alpha \cdot \text{score<em _text_new="\text{new">i - Z</em>
\end{aligned}
\end{equation}}}^{\log}} \tag{22</p>
<p><strong>ä¸‰å¤§ä¿è¯</strong>ï¼š
1. <strong>ç²¾ç¡®æ€§</strong>ï¼šé‡‡æ ·æ¦‚ç‡$\propto P(\boldsymbol{w})^\alpha$ï¼Œä¸Subword Regularizationç­‰ä»·
2. <strong>æ•ˆç‡</strong>ï¼šå¤æ‚åº¦$O(Lm)$ï¼Œä¸Viterbi Decodingç›¸åŒ
3. <strong>ç¨³å®šæ€§</strong>ï¼šLogSumExpé¿å…æ•°å€¼æº¢å‡º</p>
<p><strong>å¯¹æ¯”æ€»ç»“</strong>ï¼š</p>
<table>
<thead>
<tr>
<th>ç‰¹æ€§</th>
<th>Viterbi Decoding</th>
<th>æ—§ç‰ˆViterbi Sampling</th>
<th>å®Œç¾é‡‡æ ·</th>
<th>Subword Reg.</th>
</tr>
</thead>
<tbody>
<tr>
<td>å¤æ‚åº¦</td>
<td>$O(Lm)$</td>
<td>$O(Lm)$</td>
<td>$O(Lm)$</td>
<td>$O(nLm)$</td>
</tr>
<tr>
<td>é‡‡æ ·è´¨é‡</td>
<td>ç¡®å®šæ€§</td>
<td>è¿‘ä¼¼</td>
<td>ç²¾ç¡®</td>
<td>ç²¾ç¡®</td>
</tr>
<tr>
<td>é€Ÿåº¦</td>
<td>æœ€å¿«</td>
<td>å¿«</td>
<td>å¿«</td>
<td>æ…¢</td>
</tr>
<tr>
<td>å®ç°éš¾åº¦</td>
<td>ç®€å•</td>
<td>ç®€å•</td>
<td>ä¸­ç­‰</td>
<td>ä¸­ç­‰</td>
</tr>
</tbody>
</table>
<p><strong>åº”ç”¨å»ºè®®</strong>ï¼š
- <strong>æ¨ç†é˜¶æ®µ</strong>ï¼šViterbi Decodingï¼ˆæœ€å¿«ï¼‰
- <strong>è®­ç»ƒé˜¶æ®µ</strong>ï¼šå®Œç¾é‡‡æ ·ï¼ˆç²¾ç¡®+å¿«é€Ÿï¼‰
- <strong>éœ€è¦top-$n$ç»“æœ</strong>ï¼šSubword Regularization</p>
<p>å®Œç¾é‡‡æ ·ä¸ºéšæœºåˆ†è¯æä¾›äº†ç†è®ºä¸Šä¸¥æ ¼ã€å®è·µä¸Šé«˜æ•ˆçš„è§£å†³æ–¹æ¡ˆï¼Œæ˜¯Unigramåˆ†è¯çš„é‡è¦æ”¹è¿›ã€‚</p>
        </div>
    </div>
</body>
</html>