<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®­ç»ƒ1000å±‚çš„Transformerç©¶ç«Ÿæœ‰ä»€ä¹ˆå›°éš¾ï¼Ÿ</title>
    <style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    line-height: 1.6; color: #333; max-width: 900px; margin: 0 auto; padding: 20px; background: #f5f5f5;
}
.container { background: white; padding: 40px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
header { border-bottom: 2px solid #e0e0e0; padding-bottom: 20px; margin-bottom: 30px; }
h1 { color: #2c3e50; margin-bottom: 10px; font-size: 2em; }
.meta { color: #666; font-size: 0.9em; margin-bottom: 20px; }
.content { margin-top: 30px; overflow-wrap: break-word; }
.content h2 { color: #34495e; margin-top: 30px; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
.content p { margin-bottom: 15px; }
.content pre { background: #f8f8f8; padding: 15px; border-radius: 5px; overflow-x: auto; border-left: 3px solid #3498db; margin: 15px 0; }
.content code { background: #f8f8f8; padding: 2px 5px; border-radius: 3px; font-family: monospace; font-size: 0.9em; }
.content blockquote { border-left: 4px solid #3498db; padding-left: 20px; margin: 20px 0; color: #555; font-style: italic; }
.content table { border-collapse: collapse; width: 100%; margin: 20px 0; }
.content th, .content td { border: 1px solid #ddd; padding: 10px; text-align: left; }
.back-link { display: inline-block; margin-bottom: 20px; color: #3498db; text-decoration: none; font-weight: 500; }
</style>
    
<script>
    window.MathJax = {
        tex: {
            inlineMath: [['$', '$'], ['\(', '\)']],
            displayMath: [['$$', '$$'], ['\[', '\]']],
            processEscapes: true
        }
    };
</script>
<script id="MathJax-script" async src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>

</head>
<body>
    <div class="container">
        <a href="../index.html" class="back-link">â† è¿”å›é¦–é¡µ</a>
        <header>
            <h1>è®­ç»ƒ1000å±‚çš„Transformerç©¶ç«Ÿæœ‰ä»€ä¹ˆå›°éš¾ï¼Ÿ</h1>
            <div class="meta">ğŸ“… æœ€åæ›´æ–°: 2025-11-26 | ğŸ“„ å¤§å°: 43.0 KB</div>
        </header>
        <div class="content">
            <p><strong>åŸæ–‡é“¾æ¥</strong>: <a href="https://spaces.ac.cn/archives/8978">https://spaces.ac.cn/archives/8978</a></p>
<p><strong>å‘å¸ƒæ—¥æœŸ</strong>: </p>
<hr />
<p>ä¼—æ‰€å‘¨çŸ¥ï¼Œç°åœ¨çš„Transformerè¶Šåšè¶Šå¤§ï¼Œä½†è¿™ä¸ªâ€œå¤§â€é€šå¸¸æ˜¯â€œå®½â€è€Œä¸æ˜¯â€œæ·±â€ï¼ŒåƒGPT-3è™½ç„¶å‚æ•°æœ‰ä¸Šåƒäº¿ï¼Œä½†ä¹Ÿåªæ˜¯ä¸€ä¸ª96å±‚çš„Transformeræ¨¡å‹ï¼Œä¸æˆ‘ä»¬èƒ½æƒ³è±¡çš„æ·±åº¦ç›¸å·®ç”šè¿œã€‚æ˜¯ä»€ä¹ˆé™åˆ¶äº†Transformerå¾€â€œæ·±â€å‘å±•å‘¢ï¼Ÿå¯èƒ½æœ‰çš„è¯»è€…è®¤ä¸ºæ˜¯ç®—åŠ›ï¼Œä½†â€œå®½è€Œæµ…â€çš„æ¨¡å‹æ‰€éœ€çš„ç®—åŠ›ä¸ä¼šæ¯”â€œçª„è€Œæ·±â€çš„æ¨¡å‹å°‘å¤šå°‘ï¼Œæ‰€ä»¥ç®—åŠ›å¹¶éä¸»è¦é™åˆ¶ï¼Œå½’æ ¹ç»“åº•è¿˜æ˜¯Transformerå›ºæœ‰çš„è®­ç»ƒå›°éš¾ã€‚ä¸€èˆ¬çš„è§‚ç‚¹æ˜¯ï¼Œæ·±æ¨¡å‹çš„è®­ç»ƒå›°éš¾æºäºæ¢¯åº¦æ¶ˆå¤±æˆ–è€…æ¢¯åº¦çˆ†ç‚¸ï¼Œç„¶è€Œå®è·µæ˜¾ç¤ºï¼Œå“ªæ€•é€šè¿‡å„ç§æ‰‹æ®µæ”¹è‰¯äº†æ¢¯åº¦ï¼Œæ·±æ¨¡å‹ä¾ç„¶ä¸å®¹æ˜“è®­ç»ƒã€‚</p>
<p>è¿‘æ¥çš„ä¸€äº›å·¥ä½œï¼ˆå¦‚<a href="https://papers.cool/arxiv/2004.08249">Admin</a>ï¼‰æŒ‡å‡ºï¼Œæ·±æ¨¡å‹è®­ç»ƒçš„æ ¹æœ¬å›°éš¾åœ¨äºâ€œå¢é‡çˆ†ç‚¸â€ï¼Œå³æ¨¡å‹è¶Šæ·±å¯¹è¾“å‡ºçš„æ‰°åŠ¨å°±è¶Šå¤§ã€‚ä¸Šå‘¨çš„è®ºæ–‡<a href="https://papers.cool/arxiv/2203.00555">ã€ŠDeepNet: Scaling Transformers to 1,000 Layersã€‹</a>åˆ™æ²¿ç€è¿™ä¸ªæ€è·¯è¿›è¡Œå°ºåº¦åˆ†æï¼Œæ ¹æ®åˆ†æç»“æœè°ƒæ•´äº†æ¨¡å‹çš„å½’ä¸€åŒ–å’Œåˆå§‹åŒ–æ–¹æ¡ˆï¼Œæœ€ç»ˆæˆåŠŸè®­ç»ƒå‡ºäº†1000å±‚çš„Transformeræ¨¡å‹ã€‚æ•´ä¸ªåˆ†æè¿‡ç¨‹é¢‡æœ‰å‚è€ƒä»·å€¼ï¼Œæˆ‘ä»¬ä¸å¦¨æ¥å­¦ä¹ ä¸€ä¸‹ã€‚</p>
<h2 id="_1">å¢é‡çˆ†ç‚¸</h2>
<p>åŸè®ºæ–‡çš„å®Œæ•´åˆ†ææ¯”è¾ƒé•¿ï¼Œè€Œä¸”æœ‰äº›å‡è®¾æˆ–è€…æè¿°ç»†é…Œä¹‹ä¸‹æ˜¯ä¸å¤Ÿåˆç†çš„ã€‚æ‰€ä»¥åœ¨æœ¬æ–‡çš„åˆ†äº«ä¸­ï¼Œç¬”è€…ä¼šå°½é‡ä¿®æ­£è¿™äº›é—®é¢˜ï¼Œè¯•å›¾ä»¥ä¸€ä¸ªæ›´åˆç†çš„æ–¹å¼æ¥å¾—åˆ°ç±»ä¼¼ç»“æœã€‚</p>
<p>å‡è®¾æŸå¤±å‡½æ•°ä¸º$\mathcal{L}(\boldsymbol{\theta})$ï¼Œ$\boldsymbol{\theta}$æ˜¯å®ƒçš„å‚æ•°ï¼Œè€ƒè™‘å‚æ•°ç”±$\boldsymbol{\theta}$å˜ä¸º$\boldsymbol{\theta}+\Delta\boldsymbol{\theta}$æ—¶æŸå¤±å‡½æ•°çš„å¢é‡ï¼š<br />
\begin{equation}\Delta\mathcal{L} = \mathcal{L}(\boldsymbol{\theta}+\Delta\boldsymbol{\theta}) - \mathcal{L}(\boldsymbol{\theta}) \approx \langle\nabla_{\boldsymbol{\theta}}\mathcal{L}(\boldsymbol{\theta}),\Delta\boldsymbol{\theta}\rangle\end{equation}<br />
å¯¹äºSGDæœ‰$\Delta\boldsymbol{\theta}=-\eta \nabla_{\boldsymbol{\theta}}\mathcal{L}(\boldsymbol{\theta})$ï¼Œé‚£ä¹ˆ$\Delta\mathcal{L} \approx -\eta\Vert\nabla_{\boldsymbol{\theta}}\mathcal{L}(\boldsymbol{\theta})\Vert^2$ã€‚è®¾æ¨¡å‹æœ‰$N$å±‚ï¼Œæ¯å±‚æœ‰$K$ä¸ªå‚æ•°çŸ©é˜µï¼ˆ$K$æ¥è¿‘å¸¸æ•°ï¼‰ï¼Œé…åˆXavieråˆå§‹åŒ–ä»¥åŠå„ç§Normalizationæ‰‹æ®µï¼Œæˆ‘ä»¬å¯ä»¥ä½¿å¾—æ¯ä¸ªå‚æ•°çŸ©é˜µçš„æ¢¯åº¦æ¨¡é•¿æ˜¯$\mathcal{O}(1)$é‡çº§ï¼Œæ‰€ä»¥æœ‰$\Delta\mathcal{L}=\mathcal{O}(\eta NK)$ã€‚å› æ­¤ï¼Œæ¨¡å‹æ¯ä¸€æ­¥çš„æ›´æ–°é‡æ˜¯æ­£æ¯”äºæ¨¡å‹æ·±åº¦$N$çš„ï¼Œå¦‚æœæ¨¡å‹è¶Šæ·±ï¼Œé‚£ä¹ˆæ›´æ–°é‡å°±è¶Šå¤§ï¼Œè¿™æ„å‘³ç€åˆå§‹é˜¶æ®µæ¨¡å‹è¶Šå®¹æ˜“è¿›å…¥ä¸å¤§å¥½çš„å±€éƒ¨æœ€ä¼˜ç‚¹ï¼Œç„¶åè®­ç»ƒåœæ»ç”šè‡³å´©æºƒï¼Œè¿™å°±æ˜¯â€œå¢é‡çˆ†ç‚¸â€é—®é¢˜ã€‚</p>
<p>è¿™æ—¶å€™è§£å†³æ–¹æ³•æœ‰ä¸¤ä¸ªï¼Œä¸€æ˜¯åˆå§‹é˜¶æ®µç”¨æ›´å°çš„å­¦ä¹ ç‡è¿›è¡Œè®­ç»ƒï¼ˆä¸è¶…è¿‡$\eta/N$é‡çº§ï¼‰ï¼Œç„¶åæ…¢æ…¢å¢å¤§å­¦ä¹ ç‡ï¼Œè¿™å°±æ˜¯WarmupæŠ€å·§ï¼›äºŒå°±æ˜¯è°ƒæ•´åˆå§‹åŒ–æ–¹æ¡ˆï¼Œä½¿å¾—å‚æ•°çš„æ¢¯åº¦æ˜¯$\mathcal{O}(1/\sqrt{N})$é‡çº§ï¼Œè¿™æ ·å°±è‡ªåŠ¨æŠµæ¶ˆæ‰æ¨¡å‹æ·±åº¦çš„å½±å“ã€‚</p>
<h2 id="_2">é‡çº§åˆ†æ</h2>
<p>æ€ä¹ˆåšåˆ°ç¬¬äºŒç§æ–¹æ¡ˆå‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥å°è¯•åˆ†æTransformerçš„æ¢¯åº¦ã€‚ç„¶è€Œï¼Œç²¾ç¡®çš„æ¢¯åº¦æ±‚èµ·æ¥æ¯”è¾ƒç¹çï¼Œå¹¶ä¸”äº‹å®ä¸Šæˆ‘ä»¬ä¹Ÿä¸éœ€è¦ç²¾ç¡®çš„æ¢¯åº¦ï¼Œè€Œåªæ˜¯è¦å¯¹æ¢¯åº¦åšä¸€ä¸ªé‡çº§åˆ†æï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç”¨å¦‚ä¸‹çš„â€œé‡çº§åˆ†è§£â€æŠ€å·§è½¬åŒ–ä¸ºæ ‡é‡çš„å¯¼æ•°é—®é¢˜ã€‚</p>
<p>å¯¹äºä¸€ä¸ªçŸ©é˜µ$\boldsymbol{W}$ï¼Œæˆ‘ä»¬å°†å…¶åˆ†è§£ä¸º$\boldsymbol{W}=\lambda \boldsymbol{U}$çš„å½¢å¼ï¼Œå…¶ä¸­<br />
\begin{equation}\lambda = \mathop{\text{argmin}}_{\kappa &gt; 0} \Vert \boldsymbol{W}\boldsymbol{W}^{\top}/\kappa^2 - \boldsymbol{I}\Vert,\quad \end{equation}<br />
è¯´ç™½äº†ï¼Œæˆ‘ä»¬å°±æ˜¯è¦å°†ä¸€ä¸ªçŸ©é˜µåˆ†è§£ä¸ºä¸€ä¸ªæ ‡é‡$\lambda$ä¸ä¸€ä¸ªå°½å¯èƒ½æ­£äº¤çš„çŸ©é˜µ$\boldsymbol{U}$ä¹‹ç§¯ã€‚ç”±äº$\boldsymbol{U}$æ¥è¿‘æ­£äº¤çŸ©é˜µï¼Œå®ƒèµ·åˆ°äº†ä¸€ä¸ªæ ‡å‡†å‚è€ƒç³»çš„ä½œç”¨ï¼Œè€Œå¯¹åº”çš„$\lambda$åˆ™ä»£è¡¨äº†çŸ©é˜µ$\boldsymbol{W}$çš„é‡çº§ã€‚å¦‚æœ$\boldsymbol{W}$ä½¿ç”¨Xavieråˆå§‹åŒ–ï¼Œé‚£ä¹ˆ$\lambda$ç›¸å½“äºå…¶ä¸­çš„gainå‚æ•°ï¼Œå³åœ¨Xavieråˆå§‹åŒ–çš„åŸºç¡€ä¸Šè¿˜è¦å†ä¹˜ä¸€ä¸ª$\lambda$ã€‚è¿™æ˜¯å› ä¸ºXavieråˆå§‹åŒ–çš„ç»“æœå°±æ¥è¿‘ä¸€ä¸ªæ­£äº¤çŸ©é˜µï¼Œè¿™ä¸€ç‚¹å¯ä»¥å‚è€ƒ<a href="/archives/7180">ã€Šä»å‡ ä½•è§†è§’æ¥ç†è§£æ¨¡å‹å‚æ•°çš„åˆå§‹åŒ–ç­–ç•¥ã€‹</a>ã€‚</p>
<p>åœ¨æ­¤åˆ†è§£ä¹‹ä¸‹ï¼Œæˆ‘ä»¬æœ‰<br />
\begin{equation}\frac{\partial \mathcal{L}(\lambda \boldsymbol{U})}{\partial \lambda} = \left\langle\frac{\partial \mathcal{L}(\lambda \boldsymbol{U})}{\partial (\lambda \boldsymbol{U})}, \boldsymbol{U}\right\rangle = \left\langle\frac{\partial \mathcal{L}(\boldsymbol{W})}{\partial \boldsymbol{W}}, \boldsymbol{U}\right\rangle\end{equation}<br />
è¿™æ„å‘³ç€$\frac{\partial \mathcal{L}}{\partial \lambda}$è·Ÿ$\frac{\partial \mathcal{L}}{\partial \boldsymbol{W}}$åœ¨é‡çº§ä¸Šæ˜¯æˆæ­£æ¯”çš„ï¼Œæ‰€ä»¥å¯¹$\frac{\partial \mathcal{L}}{\partial \lambda}$åšé‡çº§åˆ†æå°±ç›¸å½“äºå¯¹$\frac{\partial \mathcal{L}}{\partial \boldsymbol{W}}$åšé‡çº§åˆ†æã€‚è¿™æ ·$\frac{\partial \mathcal{L}}{\partial \lambda}$å°±ç›¸å½“äº$\frac{\partial \mathcal{L}}{\partial \boldsymbol{W}}$é‡çº§çš„ä¸€ä¸ªç®€å•çš„â€œæ¢é’ˆâ€ï¼ŒåŸæ¥çš„çŸ©é˜µæ±‚å¯¼å°±å¯ä»¥è½¬åŒ–ä¸ºæ ‡é‡æ±‚å¯¼ï¼Œé™ä½äº†åˆ†æéš¾åº¦ã€‚</p>
<h2 id="_3">å‰é¦ˆæ¢¯åº¦</h2>
<p>å¾ˆå¤šå®éªŒç»“æœéƒ½æ˜¾ç¤ºè™½ç„¶Pre Normæ¯”Post Normæ›´å®¹æ˜“è®­ç»ƒï¼Œä½†Post Normçš„æœ€ç»ˆæ•ˆæœå¾€å¾€æ›´å¥½äº›ï¼Œæ‰€ä»¥åŸè®ºæ–‡ä¿ç•™äº†Post Normç»“æ„ï¼Œå¹¶è€ƒè™‘äº†æ›´ä¸€èˆ¬çš„å½¢å¼ï¼ˆDeepNormï¼‰ï¼š<br />
\begin{equation}\boldsymbol{x}<em l_1="l+1">{l+1} = \text{LN}(\alpha\boldsymbol{x}_l + F(\boldsymbol{x}_l)) = \text{LN}(\boldsymbol{x}_l + F(\boldsymbol{x}_l)/\alpha)\end{equation}<br />
å…¶ä¸­$\alpha &gt; 0$æ˜¯ä¸€ä¸ªå¸¸æ•°ã€‚ç®€å•èµ·è§ï¼Œæˆ‘ä»¬å…ˆè€ƒè™‘FFNå±‚ï¼Œæ­¤æ—¶<br />
\begin{equation}\boldsymbol{x}</em>} = \text{LN}(\boldsymbol{x<em l_1="l+1">l + \phi(\boldsymbol{x}_l \boldsymbol{W}_1)\boldsymbol{W}_2/\alpha)\end{equation}<br />
è¿™é‡Œçš„$\phi$æ˜¯æ¿€æ´»å‡½æ•°ï¼Œä¸€èˆ¬ä¸ºReLUæˆ–å…¶å˜ä½“ï¼ˆSwishã€GeLUç­‰ï¼‰ï¼Œå®ƒä»¬ï¼ˆè¿‘ä¼¼ï¼‰æ»¡è¶³$\phi(\lambda x) = \lambda \phi(x),\forall \lambda &gt; 0$ã€‚ä½¿ç”¨å‰ä¸€èŠ‚çš„é‡çº§åˆ†è§£æ¢é’ˆï¼Œæˆ‘ä»¬å¾—åˆ°<br />
\begin{equation}\boldsymbol{x}</em>} = \text{LN}(\underbrace{\boldsymbol{x<em _text_è®°ä¸º="\text{è®°ä¸º">l + \lambda_1 \lambda_2 \phi(\boldsymbol{x}_l \boldsymbol{U}_1)\boldsymbol{U}_2/\alpha}</em>}\boldsymbol{z<em l_1="l+1">{l+1}})\label{eq:ffn}\end{equation}<br />
æ±‚$\lambda$çš„æ¢¯åº¦ï¼š<br />
\begin{equation}\begin{aligned}<br />
\frac{\partial \mathcal{L}}{\partial \lambda_1} = \frac{\partial \mathcal{L}}{\partial \boldsymbol{x}</em>}}\frac{\partial \boldsymbol{x<em l_1="l+1">{l+1}}{\partial \boldsymbol{z}</em>}}\frac{\partial \boldsymbol{z<em l_1="l+1">{l+1}}{\partial \lambda_1} = \frac{\partial \mathcal{L}}{\partial \boldsymbol{x}</em>}}\frac{\partial \boldsymbol{x<em l_1="l+1">{l+1}}{\partial \boldsymbol{z}</em>}}\frac{\lambda_2 \phi(\boldsymbol{x<em l_1="l+1">l \boldsymbol{U}_1)\boldsymbol{U}_2}{\alpha} \\\<br />
\frac{\partial \mathcal{L}}{\partial \lambda_2} = \frac{\partial \mathcal{L}}{\partial \boldsymbol{x}</em>}}\frac{\partial \boldsymbol{x<em l_1="l+1">{l+1}}{\partial \boldsymbol{z}</em>}}\frac{\partial \boldsymbol{z<em l_1="l+1">{l+1}}{\partial \lambda_2} = \frac{\partial \mathcal{L}}{\partial \boldsymbol{x}</em>}}\frac{\partial \boldsymbol{x<em l_1="l+1">{l+1}}{\partial \boldsymbol{z}</em>}}\frac{\lambda_1 \phi(\boldsymbol{x<em l_1="l+1">l \boldsymbol{U}_1)\boldsymbol{U}_2}{\alpha} \end{aligned}\end{equation}<br />
æˆ‘ä»¬æ–­è¨€$\frac{\partial \mathcal{L}}{\partial \boldsymbol{x}</em>}}$ã€$\frac{\partial \boldsymbol{x<em l_1="l+1">{l+1}}{\partial \boldsymbol{z}</em>(1)$çš„ï¼Œå› æ­¤æœ€ç»ˆæœ‰}}$éƒ½æ˜¯$\mathcal{O}(1)$çš„ï¼Œå¹¶ä¸”ç”±äº$\boldsymbol{U}_1$ã€$\boldsymbol{U}_2$éƒ½æ¥è¿‘æ­£äº¤çŸ©é˜µï¼Œæ‰€ä»¥$\phi(\boldsymbol{x}_l \boldsymbol{U}_1)\boldsymbol{U}_2$ä¹Ÿæ˜¯$\mathcal{O<br />
\begin{equation}\frac{\partial \mathcal{L}}{\partial \lambda_1} = \mathcal{O}\left(\frac{\lambda_2}{\alpha}\right),\quad \frac{\partial \mathcal{L}}{\partial \lambda_2} = \mathcal{O}\left(\frac{\lambda_1}{\alpha}\right)\end{equation}</p>
<h2 id="_4">è‡ªæ³¨æ„åŠ›</h2>
<p>ç°åœ¨è€ƒè™‘è‡ªSelf Attentionï¼Œä½œä¸ºé‡çº§åˆ†æï¼Œæˆ‘ä»¬è€ƒè™‘å•å¤´æ³¨æ„åŠ›å³å¯ï¼Œå…¶å½¢å¼ä¸º<br />
\begin{equation}\boldsymbol{x}<em l_1="l+1">{l+1} = \text{LN}(\boldsymbol{x}_l + \sigma(\boldsymbol{x}_l \boldsymbol{W}_q\boldsymbol{W}_k^{\top}\boldsymbol{x}_l^{\top})\boldsymbol{x}_l\boldsymbol{W}_v\boldsymbol{W}_o/\alpha)\end{equation}<br />
å…¶ä¸­$\sigma(\cdot)$æ˜¯softmaxæ“ä½œçš„ç®€å†™ï¼Œè¿™é‡Œçœç•¥äº†Attentionçš„scaleæ“ä½œã€‚å¯¹ä¸Šå¼è¿›è¡Œé‡çº§åˆ†è§£åçš„å½¢å¼ä¸º<br />
\begin{equation}\boldsymbol{x}</em>} = \text{LN}(\underbrace{\boldsymbol{x<em _text_è®°ä¸º="\text{è®°ä¸º">l + \lambda_v\lambda_o \sigma (\lambda_q\lambda_k\boldsymbol{x}_l \boldsymbol{U}_q\boldsymbol{U}_k^{\top}\boldsymbol{x}_l^{\top})\boldsymbol{x}_l\boldsymbol{U}_v\boldsymbol{U}_o/\alpha}</em>}\boldsymbol{z<em l_1="l+1">{l+1}})\label{eq:sa}\end{equation}<br />
ç°åœ¨æˆ‘ä»¬å¯ä»¥å¯¹å„ä¸ª$\lambda$åˆ†åˆ«æ±‚æ¢¯åº¦ï¼Œè€Œç”±äºsoftmaxçš„å­˜åœ¨ï¼Œäº‹å®ä¸Š$\lambda_q,\lambda_k$çš„æ¢¯åº¦æœ¬èº«ä¼šå¾ˆå°ï¼Œä¸ä¼šæ˜æ˜¾å½±å“æœ€ç»ˆçš„æ›´æ–°é‡ï¼Œæ‰€ä»¥å…¶å®æˆ‘ä»¬è€ƒè™‘$\lambda_v,\lambda_o$çš„æ›´æ–°é‡è¶³çŸ£ï¼š<br />
\begin{equation}\begin{aligned}<br />
\frac{\partial \mathcal{L}}{\partial \lambda_v} = \frac{\partial \mathcal{L}}{\partial \boldsymbol{x}</em>}}\frac{\partial \boldsymbol{x<em l_1="l+1">{l+1}}{\partial \boldsymbol{z}</em>}}\frac{\partial \boldsymbol{z<em l_1="l+1">{l+1}}{\partial \lambda_v} = \frac{\partial \mathcal{L}}{\partial \boldsymbol{x}</em>}}\frac{\partial \boldsymbol{x<em l_1="l+1">{l+1}}{\partial \boldsymbol{z}</em>}}\frac{\lambda_o \sigma (\lambda_q\lambda_k\boldsymbol{x<em l_1="l+1">l \boldsymbol{U}_q\boldsymbol{U}_k^{\top}\boldsymbol{x}_l^{\top})\boldsymbol{x}_l\boldsymbol{U}_v\boldsymbol{U}_o}{\alpha} \\\<br />
\frac{\partial \mathcal{L}}{\partial \lambda_o} = \frac{\partial \mathcal{L}}{\partial \boldsymbol{x}</em>}}\frac{\partial \boldsymbol{x<em l_1="l+1">{l+1}}{\partial \boldsymbol{z}</em>}}\frac{\partial \boldsymbol{z<em l_1="l+1">{l+1}}{\partial \lambda_o} = \frac{\partial \mathcal{L}}{\partial \boldsymbol{x}</em>}}\frac{\partial \boldsymbol{x<em l_1="l+1">{l+1}}{\partial \boldsymbol{z}</em>}}\frac{\lambda_v \sigma (\lambda_q\lambda_k\boldsymbol{x<em l_1="l+1">l \boldsymbol{U}_q\boldsymbol{U}_k^{\top}\boldsymbol{x}_l^{\top})\boldsymbol{x}_l\boldsymbol{U}_v\boldsymbol{U}_o}{\alpha} \end{aligned}\end{equation}<br />
åŒæ ·æ–­è¨€$\frac{\partial \mathcal{L}}{\partial \boldsymbol{x}</em>}}$ã€$\frac{\partial \boldsymbol{x<em l_1="l+1">{l+1}}{\partial \boldsymbol{z}</em>(1)$çš„ï¼Œå› æ­¤ç»“æœè·ŸFFNå±‚çš„ç±»ä¼¼ï¼š}}$éƒ½æ˜¯$\mathcal{O}(1)$çš„ï¼Œå¹¶ä¸”æ³¨æ„softmaxå‡ºæ¥æ˜¯ä¸€ä¸ªæ¦‚ç‡åˆ†å¸ƒï¼Œç„¶åå¯¹$\boldsymbol{x}_l$çš„å„ä¸ªtokenåšåŠ æƒå¹³å‡ï¼Œé€šå¸¸è€Œè¨€ï¼Œå¹³å‡å‰åçš„å‘é‡ä¼šåœ¨åŒä¸€æ•°é‡çº§ï¼Œæ‰€ä»¥æˆ‘ä»¬è®¤ä¸º$\sigma (\lambda_q\lambda_k\boldsymbol{x}_l \boldsymbol{U}_q\boldsymbol{U}_k^{\top}\boldsymbol{x}_l^{\top})\boldsymbol{x}_l\boldsymbol{U}_v\boldsymbol{U}_o$ä¹Ÿæ˜¯$\mathcal{O<br />
\begin{equation}\frac{\partial \mathcal{L}}{\partial \lambda_v} = \mathcal{O}\left(\frac{\lambda_o}{\alpha}\right),\quad \frac{\partial \mathcal{L}}{\partial \lambda_o} = \mathcal{O}\left(\frac{\lambda_v}{\alpha}\right)\end{equation}</p>
<h2 id="_5">åˆæ­¥ç»“è®º</h2>
<p>ç°åœ¨ä¸ç®¡æ˜¯FFNè¿˜æ˜¯Self Attentionï¼Œæˆ‘ä»¬éƒ½å¾—åˆ°äº†ç›¸ä¼¼çš„ç»“è®ºï¼Œç°åœ¨ç®€å•èµ·è§ï¼Œå‡è®¾æ¯ä¸ªå‚æ•°çš„é‡çº§ï¼ˆè‡³å°‘åœ¨åˆå§‹åŒ–é˜¶æ®µï¼‰æ˜¯ä¸€è‡´çš„ï¼Œå³æ‰€æœ‰çš„$\lambda$å–åŒä¸€ä¸ªå€¼ï¼Œé‚£ä¹ˆæ€»çš„ç»“è®ºæ˜¯<br />
\begin{equation}\frac{\partial \mathcal{L}}{\partial \lambda} = \mathcal{O}\left(\frac{\lambda}{\alpha}\right)\end{equation}<br />
å³æ¢¯åº¦çš„é‡çº§æ˜¯$\mathcal{O}(\lambda/\alpha)$ã€‚å¦ä¸€æ–¹é¢ï¼Œæˆ‘ä»¬è¯´$N$å±‚çš„Transformeræ¨¡å‹ï¼Œä¸€èˆ¬æ˜¯$N$å±‚çš„Self AttentionåŠ $N$å±‚çš„FFNï¼Œæ‰€ä»¥ä¸¥æ ¼æ¥è¯´å±‚æ•°æ˜¯$2N$ã€‚å› æ­¤ï¼ŒæŒ‰ç…§â€œå¢é‡çˆ†ç‚¸â€ä¸€èŠ‚çš„åˆ†æï¼Œæˆ‘ä»¬éœ€è¦å°†æ¢¯åº¦è°ƒæ•´åˆ°$\mathcal{O}(1/\sqrt{2N})$ï¼Œä¸Šå¼å‘Šè¯‰æˆ‘ä»¬å¯ä»¥é€šè¿‡è®©$\lambda/\alpha=1/\sqrt{2N}$æ¥å®ç°ã€‚åŸè®ºæ–‡çš„æ”¾ç¼©æ›´ä¸ºå®½æ¾ä¸€äº›ï¼Œå¾—åˆ°çš„ç»“æœæ˜¯$\lambda/\alpha = 1/\sqrt{4N}$ï¼Œé‡çº§ä¸Šæ˜¯ç­‰ä»·çš„ã€‚</p>
<p>ç°åœ¨æˆ‘ä»¬å¾—åˆ°äº†$\lambda$ä¸$\alpha$çš„ä¸€ä¸ªæ¯”ä¾‹å…³ç³»ï¼Œä½†æ— æ³•ç›´æ¥å¾—åˆ°$\lambda$å’Œ$\alpha$çš„å…·ä½“å€¼ã€‚æŒ‰ç…§è®ºæ–‡çš„è¯´æ³•ï¼Œæ˜¯ä»å¯¹ç§°è§’åº¦å‡ºå‘ï¼Œè®©$\lambda=1/\alpha$ï¼Œä»è€Œå¯ä»¥è§£å¾—<br />
\begin{equation}\alpha = (2N)^{1/4},\quad \lambda = (2N)^{-1/4}\label{eq:result}\end{equation}<br />
ç„¶è€Œï¼Œå•çº¯å¯¹ç§°çš„è§£é‡Šæ˜¾ç„¶æ˜¯ä¸å¤Ÿè¯´æœåŠ›çš„ï¼Œæˆ‘ä»¬éœ€è¦ææ¸…æ¥šä¸åŒçš„é€‰æ‹©ç©¶ç«Ÿæœ‰ä»€ä¹ˆä¸åŒçš„ç»“æœã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬å¯ä»¥æ¯”è¾ƒå¦å¤–ä¸¤ç»„è§£ï¼š</p>
<blockquote>
<p><strong>å¦è§£ä¸€ï¼š</strong> $\alpha=1,\lambda=(2N)^{-1/2}$ï¼Œæ­¤æ—¶å‚æ•°çš„åˆå§‹åŒ–ç¼©å°åˆ°åŸæ¥çš„$(2N)^{-1/2}$å€ï¼Œæ¢¯åº¦ä¹Ÿè¢«ç¼©å°åˆ°åŸæ¥çš„$(2N)^{-1/2}$å€ï¼Œæ ¹æ®SGDçš„$\Delta\boldsymbol{\theta}=-\eta \nabla_{\boldsymbol{\theta}}\mathcal{L}(\boldsymbol{\theta})$å¾—å‡ºæ¯æ­¥çš„æ›´æ–°é‡ä¹Ÿæ˜¯åŸæ¥çš„$(2N)^{-1/2}$å€ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè°ƒæ•´å‰åçš„ç›¸å¯¹å­¦ä¹ å¹…åº¦æ˜¯æ²¡æœ‰å˜åŒ–çš„ï¼Œå› æ­¤æœ‰å¯èƒ½åˆšå¼€å§‹$\lambda=\mathcal{O}((2N)^{-1/2})$çº§åˆ«ï¼Œä½†è®­ç»ƒé›†å‡ æ­¥åå°±è„±ç¦»äº†è¿™ä¸ªé‡çº§äº†ã€‚</p>
<p><strong>å¦è§£äºŒï¼š</strong> $\alpha=(2N)^{1/2},\lambda=1$ï¼Œæ­¤æ—¶å‚æ•°çš„åˆå§‹åŒ–æ²¡æœ‰ç¼©å°ï¼Œä½†æ¢¯åº¦ä¹Ÿè¢«ç¼©å°åˆ°åŸæ¥çš„$(2N)^{-1/2}$å€ï¼Œæ ¹æ®SGDçš„$\Delta\boldsymbol{\theta}=-\eta \nabla_{\boldsymbol{\theta}}\mathcal{L}(\boldsymbol{\theta})$å¾—å‡ºæ¯æ­¥çš„æ›´æ–°é‡ä¹Ÿæ˜¯åŸæ¥çš„$(2N)^{-1/2}$å€ï¼Œè°ƒæ•´å‰åçš„ç›¸å¯¹å­¦ä¹ å¹…åº¦æ˜¯æ˜æ˜¾ç¼©å°äº†ï¼Œå› æ­¤æœ‰å¯èƒ½å‡ºç°å­¦ä¹ å¾—éå¸¸æ…¢çš„æƒ…å†µã€‚</p>
</blockquote>
<p>è¿™ä¸¤ç§æƒ…å†µçœ‹ä¸Šå»éƒ½å„æœ‰ç¼ºç‚¹ï¼Œå› æ­¤ä»‹ä¹ä¸¤è€…ä¹‹é—´çš„å¼$\eqref{eq:result}$ä¼¼ä¹å°±èƒ½è§£é‡Šå¾—é€šäº†ï¼Œå®ƒå°±æ˜¯ä¿æŒæ¢¯åº¦ç¼©æ”¾åˆ°åŸæ¥çš„$(2N)^{-1/2}$å€çš„åŒæ—¶ï¼Œè®©åˆå§‹å­¦ä¹ æ­¥ä¼ç¨å¾®æ…¢ä¸€äº›ï¼Œä½†åˆä¸è‡³äºå¤ªæ…¢ï¼Œéšå¼åœ°èµ·åˆ°äº†Warmupçš„ä½œç”¨ã€‚</p>
<h2 id="_6">å¤šç§ä¼˜åŒ–</h2>
<p>ä¸Šé¢çš„åˆ†æéƒ½æ˜¯åŸºäºSGDè¿›è¡Œçš„ï¼Œä½†äº‹å®ä¸Šæˆ‘ä»¬å¾ˆå°‘ç›´æ¥ç”¨SGDå»è®­ç»ƒNLPæ¨¡å‹ï¼Œæˆ‘ä»¬æ›´å¤šæ˜¯è‡ªé€‚åº”å­¦ä¹ ç‡ä¼˜åŒ–å™¨ï¼Œä¸»è¦æœ‰ä¸¤å¤§ç±»ï¼šä¸€æ˜¯ç”¨äºŒé˜¶çŸ©æ¥æ ¡æ­£å­¦ä¹ ç‡ï¼ŒAdamã€AdamWç­‰éƒ½å±æ­¤ç±»ï¼›å¦ä¸€ç±»æ˜¯é€šè¿‡å‚æ•°æ¨¡é•¿è¿›ä¸€æ­¥æ ¡æ­£å­¦ä¹ ç‡ï¼Œæ¯”å¦‚<a href="/archives/7094">LAMB</a>ã€<a href="/archives/7302">AdaFactor</a>ã€‚åŸè®ºæ–‡çš„è¯´æ³•æ˜¯â€œæˆ‘ä»¬åœ¨SGDä¸Šè¿›è¡Œæ¨å¯¼ï¼Œç„¶ååœ¨Adamä¸ŠéªŒè¯å‘ç°ä¹Ÿè¿˜å¯ä»¥â€ï¼Œä½†ä»ç†è®ºä¸Šæ¥è®²ï¼Œå®ƒä»¬å¹¶ä¸å®Œå…¨é€šç”¨ï¼Œè¿™ä¸€èŠ‚æˆ‘ä»¬å°±æ¥é’ˆå¯¹æ€§åœ°åšä¸€ä¸‹åˆ†æã€‚</p>
<p>å¯¹äºAdamç±»ä¼˜åŒ–å™¨æ¥è¯´ï¼Œæ¯ä¸€æ­¥çš„æ›´æ–°é‡å¤§çº¦ä¸º$\Delta\boldsymbol{\theta}=-\eta\,\text{sign}(\nabla_{\boldsymbol{\theta}}\mathcal{L}(\boldsymbol{\theta}))$ï¼Œæ‰€ä»¥$\Delta\mathcal{L} \approx -\eta\Vert\nabla_{\boldsymbol{\theta}}\mathcal{L}(\boldsymbol{\theta})\Vert_1$ï¼Œå®ƒæ˜¯æ­£æ¯”äºæ¢¯åº¦çš„1æ¬¡æ–¹è€Œä¸æ˜¯2æ¬¡æ–¹ï¼Œå› æ­¤è¦è¿‡è¦è®©æ›´æ–°é‡è·Ÿå±‚æ•°æ— å…³ï¼Œé‚£ä¹ˆæ¢¯åº¦åº”è¯¥ç¼©å°åˆ°åŸæ¥çš„$1/(2N)$å€æ‰å¯¹ï¼Œå³åº”è¯¥æœ‰$\lambda/\alpha=1/(2N)$ï¼Œå¦‚æœåŒæ ·è®©$\lambda=1/\alpha$ï¼Œé‚£ä¹ˆæœ‰<br />
\begin{equation}\alpha = (2N)^{1/2},\quad \lambda = (2N)^{-1/2}\end{equation}</p>
<p>å¯¹äºLAMBç±»ä¼˜åŒ–å™¨æ¥è¯´ï¼Œæ¯ä¸€æ­¥æ›´æ–°é‡å¤§çº¦ä¸º$\Delta\boldsymbol{\theta}=-\eta\Vert\theta\Vert\,\text{sign}(\nabla_{\boldsymbol{\theta}}\mathcal{L}(\boldsymbol{\theta}))$ï¼Œæ‰€ä»¥$\Delta\mathcal{L} \approx -\eta\Vert\theta\Vert\Vert\nabla_{\boldsymbol{\theta}}\mathcal{L}(\boldsymbol{\theta})\Vert_1$ï¼Œæ³¨æ„åˆ°å‚æ•°çš„ç¼©æ”¾æ¯”ä¾‹æ˜¯$\lambda$ã€æ¢¯åº¦çš„ç¼©æ”¾æ¯”ä¾‹æ˜¯$\lambda/\alpha$ï¼Œæ‰€ä»¥$\Delta\mathcal{L}=\mathcal{O}(2N\lambda^2/\alpha)$ï¼Œä»è€Œæ˜¯$\lambda^2/\alpha=1/(2N)$ã€‚æ³¨æ„è¿™ç±»ä¼˜åŒ–å™¨æ¯æ­¥çš„ç›¸å¯¹æ›´æ–°é‡æ˜¯ä¸€æ ·çš„ï¼ˆç­‰äºå­¦ä¹ ç‡$\eta$ï¼‰ï¼Œä¸ç®¡æ€ä¹ˆè°ƒæ•´$\alpha,\lambda$å…¶ç›¸å¯¹æ›´æ–°å¤§å°éƒ½ä¸ä¼šå˜åŒ–ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç›´æ¥å–$\alpha=1,\lambda=(2N)^{-1/2}$ã€‚</p>
<p>ç»“æœæ±‡æ€»å¯¹æ¯”å¦‚ä¸‹ï¼š<br />
\begin{array}{c|cc|cc}<br />
\hline<br />
\text{ä¼˜åŒ–å™¨} &amp; \Delta\boldsymbol{\theta} &amp; \Delta\mathcal{L} &amp; \alpha &amp; \lambda \\\<br />
\hline<br />
\text{SGD} &amp; -\eta \nabla_{\boldsymbol{\theta}}\mathcal{L}(\boldsymbol{\theta}) &amp; -\eta\Vert\nabla_{\boldsymbol{\theta}}\mathcal{L}(\boldsymbol{\theta})\Vert^2 &amp; (2N)^{1/4} &amp; (2N)^{-1/4}\\\<br />
\text{Adam} &amp; -\eta\,\text{sign}(\nabla_{\boldsymbol{\theta}}\mathcal{L}(\boldsymbol{\theta})) &amp; -\eta\Vert\nabla_{\boldsymbol{\theta}}\mathcal{L}(\boldsymbol{\theta})\Vert_1 &amp; (2N)^{1/2}&amp; (2N)^{-1/2}\\\<br />
\text{LAMB} &amp; -\eta\Vert\theta\Vert\,\text{sign}(\nabla_{\boldsymbol{\theta}}\mathcal{L}(\boldsymbol{\theta})) &amp; -\eta\Vert\theta\Vert\Vert\nabla_{\boldsymbol{\theta}}\mathcal{L}(\boldsymbol{\theta})\Vert_1 &amp; 1 &amp; (2N)^{-1/2}\\\<br />
\hline<br />
\end{array}</p>
<h2 id="_7">äº‹ååˆ†æ</h2>
<p>å‰é¢çš„ä¸¤èŠ‚æ¨å¯¼è¿‡ç¨‹éƒ½ç”¨åˆ°äº†æ–­è¨€â€œ$\frac{\partial \mathcal{L}}{\partial \boldsymbol{x}<em l_1="l+1">{l+1}}$ã€$\frac{\partial \boldsymbol{x}</em>(1)$çš„â€ï¼Œé‚£ä¹ˆå®ƒæ˜¯å¦æˆç«‹å‘¢ï¼Ÿè¿™é‡Œæˆ‘ä»¬äº‹ååˆ†æä¸€ä¸‹ã€‚}}{\partial \boldsymbol{z}_{l+1}}$éƒ½æ˜¯$\mathcal{O</p>
<p>å…¶å®ä¹Ÿå¾ˆç®€å•ï¼Œç»è¿‡å‰è¿°è°ƒæ•´åï¼Œä¸ç®¡æ˜¯FFNå±‚$\eqref{eq:ffn}$è¿˜æ˜¯Self Attentionå±‚$\eqref{eq:sa}$ï¼Œåˆå§‹é˜¶æ®µæ¯ä¸ªæ®‹å·®åˆ†æ”¯çš„æƒé‡è¢«ç¼©æ”¾åˆ°åŸæ¥çš„$\lambda^2/\alpha$å€ï¼Œä¸ç®¡æ˜¯å“ªç§ä¼˜åŒ–å™¨çš„ç»“æœï¼Œ$\lambda^2/\alpha$éƒ½æ˜¯ä¸€ä¸ªæ¯”è¾ƒå°çš„æ•°å­—ï¼Œè¿™æ„å‘³ç€åˆå§‹é˜¶æ®µæ•´ä¸ªæ¨¡å‹å…¶å®æ¥è¿‘ä¸€ä¸ªæ’ç­‰å‡½æ•°ï¼Œå› æ­¤$\frac{\partial \mathcal{L}}{\partial \boldsymbol{x}<em l_1="l+1">{l+1}}$ã€$\frac{\partial \boldsymbol{x}</em>(1)$çš„ï¼Œæ‰€ä»¥ç»“è®ºå’Œæ–­è¨€æ˜¯è‡ªæ´½çš„ã€‚}}{\partial \boldsymbol{z}_{l+1}}$è‡ªç„¶éƒ½æ˜¯$\mathcal{O</p>
<p>å¦å¤–ï¼Œå¯èƒ½æœ‰è¯»è€…æƒ³é—®åŒæ ·çš„åˆ†ææ˜¯å¦å¯ä»¥ç”¨åˆ°Pre Normç»“æ„ä¸Šå‘¢ï¼Ÿç­”æ¡ˆæ˜¯å¯ä»¥çš„ï¼Œå¹¶ä¸”ç»“è®ºæ˜¯åŸºæœ¬ä¸€è‡´çš„ï¼Œåªæ˜¯å› ä¸ºNormæ”¾åœ¨äº†æ®‹å·®åˆ†æ”¯ä¹‹å‰ï¼Œæ‰€ä»¥å°±æ²¡å¿…è¦è®¾ç½®$\alpha$å‚æ•°äº†ï¼Œæ‰€ä»¥ç»“è®ºå°±æ˜¯ä¸Šè¿°å…³äºPost Normçš„ç»“æœä¸­æ‰€æœ‰çš„$\alpha$éƒ½ç­‰äºä¸º1ï¼Œç„¶åé‡æ–°è®¡ç®—ç›¸åº”çš„$\lambda$ã€‚</p>
<p>æœ€åï¼Œè¯»è€…å¯èƒ½æœ‰ç–‘é—®çš„æ˜¯èŠ±äº†é‚£ä¹ˆå¤šåŠŸå¤«è®¨è®ºæŠŠæ¨¡å‹åšæ·±ï¼Œé‚£ä¹ˆæ¨¡å‹æ·±åº¦çœŸæœ‰é‚£ä¹ˆé‡è¦å—ï¼Ÿæœ‰ï¼ŒåŸè®ºæ–‡ç»™å‡ºäº†ä¸€ä¸ªæ¼‚äº®çš„å®éªŒç»“æœï¼Œç”¨ä¸€ä¸ª200å±‚çš„â€œæ·±è€Œçª„â€çš„æ¨¡å‹ï¼ˆ32äº¿å‚æ•°ï¼‰ï¼Œæˆ˜èƒœäº†ä¹‹å‰48å±‚â€œæµ…è€Œå®½â€çš„SOTAæ¨¡å‹ï¼ˆ120äº¿å‚æ•°ï¼‰ï¼š  </p>
<p><a href="/usr/uploads/2022/03/2952207079.png" title="ç‚¹å‡»æŸ¥çœ‹åŸå›¾"><img alt="â€œæ·±è€Œçª„â€çš„æ¨¡å‹èƒœäºâ€œæµ…è€Œå®½â€çš„æ¨¡å‹" src="/usr/uploads/2022/03/2952207079.png" /></a></p>
<p>â€œæ·±è€Œçª„â€çš„æ¨¡å‹èƒœäºâ€œæµ…è€Œå®½â€çš„æ¨¡å‹</p>
<h2 id="_8">æ–‡ç« å°ç»“</h2>
<p>æœ¬æ–‡åˆ†æäº†å°†Transformeråšâ€œæ·±â€çš„ç“¶é¢ˆæ‰€åœ¨å¹¶ç»™å‡ºäº†ç›¸åº”çš„è§£å†³æ–¹æ¡ˆï¼Œæ–‡ç« çš„ä¸»è¦æ€è·¯æºäºå¾®è½¯æ–°å‡ºçš„DeepNetï¼Œå¹¶å¯¹åŸè®ºæ–‡çš„åˆ†æè¿‡ç¨‹åšäº†ä¸€å®šçš„ç®€åŒ–å’Œå®Œå–„ã€‚</p>
<p><em><strong>è½¬è½½åˆ°è¯·åŒ…æ‹¬æœ¬æ–‡åœ°å€ï¼š</strong><a href="https://spaces.ac.cn/archives/8978">https://spaces.ac.cn/archives/8978</a></em></p>
<p><em><strong>æ›´è¯¦ç»†çš„è½¬è½½äº‹å®œè¯·å‚è€ƒï¼š</strong></em><a href="https://spaces.ac.cn/archives/6508#%E6%96%87%E7%AB%A0%E5%A6%82%E4%BD%95%E8%BD%AC%E8%BD%BD/%E5%BC%95%E7%94%A8" title="ã€Šç§‘å­¦ç©ºé—´FAQã€‹">ã€Šç§‘å­¦ç©ºé—´FAQã€‹</a></p>
<p><strong>å¦‚æœæ‚¨è¿˜æœ‰ä»€ä¹ˆç–‘æƒ‘æˆ–å»ºè®®ï¼Œæ¬¢è¿åœ¨ä¸‹æ–¹è¯„è®ºåŒºç»§ç»­è®¨è®ºã€‚</strong></p>
<p><strong>å¦‚æœæ‚¨è§‰å¾—æœ¬æ–‡è¿˜ä¸é”™ï¼Œæ¬¢è¿åˆ†äº«/æ‰“èµæœ¬æ–‡ã€‚æ‰“èµå¹¶éè¦ä»ä¸­è·å¾—æ”¶ç›Šï¼Œè€Œæ˜¯å¸Œæœ›çŸ¥é“ç§‘å­¦ç©ºé—´è·å¾—äº†å¤šå°‘è¯»è€…çš„çœŸå¿ƒå…³æ³¨ã€‚å½“ç„¶ï¼Œå¦‚æœä½ æ— è§†å®ƒï¼Œä¹Ÿä¸ä¼šå½±å“ä½ çš„é˜…è¯»ã€‚å†æ¬¡è¡¨ç¤ºæ¬¢è¿å’Œæ„Ÿè°¢ï¼</strong></p>
<p>æ‰“èµ</p>
<p><img alt="ç§‘å­¦ç©ºé—´" src="https://spaces.ac.cn/usr/themes/geekg/payment/wx.png" /></p>
<p>å¾®ä¿¡æ‰“èµ</p>
<p><img alt="ç§‘å­¦ç©ºé—´" src="https://spaces.ac.cn/usr/themes/geekg/payment/zfb.png" /></p>
<p>æ”¯ä»˜å®æ‰“èµ</p>
<p>å› ä¸ºç½‘ç«™åå°å¯¹æ‰“èµå¹¶æ— è®°å½•ï¼Œå› æ­¤æ¬¢è¿åœ¨æ‰“èµæ—¶å€™å¤‡æ³¨ç•™è¨€ã€‚ä½ è¿˜å¯ä»¥<a href="http://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&amp;email=tN7d1drY3drrx8H0xcWa19vZ"><strong>ç‚¹å‡»è¿™é‡Œ</strong></a>æˆ–åœ¨ä¸‹æ–¹è¯„è®ºåŒºç•™è¨€æ¥å‘ŠçŸ¥ä½ çš„å»ºè®®æˆ–éœ€æ±‚ã€‚</p>
<p><strong>å¦‚æœæ‚¨éœ€è¦å¼•ç”¨æœ¬æ–‡ï¼Œè¯·å‚è€ƒï¼š</strong></p>
<p>è‹å‰‘æ—. (Mar. 09, 2022). ã€Šè®­ç»ƒ1000å±‚çš„Transformerç©¶ç«Ÿæœ‰ä»€ä¹ˆå›°éš¾ï¼Ÿ ã€‹[Blog post]. Retrieved from <a href="https://spaces.ac.cn/archives/8978">https://spaces.ac.cn/archives/8978</a></p>
<p>@online{kexuefm-8978,<br />
title={è®­ç»ƒ1000å±‚çš„Transformerç©¶ç«Ÿæœ‰ä»€ä¹ˆå›°éš¾ï¼Ÿ},<br />
author={è‹å‰‘æ—},<br />
year={2022},<br />
month={Mar},<br />
url={\url{https://spaces.ac.cn/archives/8978}},<br />
} </p>
<hr />
<h2 id="_9">å…¬å¼æ¨å¯¼ä¸æ³¨é‡Š</h2>
<h3 id="_10">ä¸€ã€æ·±å±‚ç½‘ç»œçš„æ¢¯åº¦é—®é¢˜æ•°å­¦åˆ†æ</h3>
<h4 id="11">1.1 æ¢¯åº¦æ¶ˆå¤±ä¸æ¢¯åº¦çˆ†ç‚¸çš„åŸºç¡€ç†è®º</h4>
<p>è€ƒè™‘ä¸€ä¸ª $N$ å±‚çš„æ·±åº¦ç¥ç»ç½‘ç»œï¼ŒæŸå¤±å‡½æ•°ä¸º $\mathcal{L}$ã€‚ç¬¬ $l$ å±‚çš„å‚æ•° $\boldsymbol{\theta}_l$ çš„æ¢¯åº¦å¯ä»¥é€šè¿‡é“¾å¼æ³•åˆ™è¡¨ç¤ºï¼š</p>
<p>\begin{equation}
\frac{\partial \mathcal{L}}{\partial \boldsymbol{\theta}<em i="l+1">l} = \frac{\partial \mathcal{L}}{\partial \boldsymbol{x}_N} \prod</em>}^{N} \frac{\partial \boldsymbol{x<em i-1="i-1">i}{\partial \boldsymbol{x}</em>
\tag{1}
\end{equation}}} \frac{\partial \boldsymbol{x}_l}{\partial \boldsymbol{\theta}_l</p>
<p>å…¶ä¸­ $\boldsymbol{x}_i$ æ˜¯ç¬¬ $i$ å±‚çš„è¾“å‡ºã€‚</p>
<p><strong>å…³é”®è§‚å¯Ÿ</strong>: æ¢¯åº¦åŒ…å«ä¸€ä¸ªè¿ä¹˜é¡¹ $\prod_{i=l+1}^{N} \frac{\partial \boldsymbol{x}<em i-1="i-1">i}{\partial \boldsymbol{x}</em>$ï¼Œè¿™æ˜¯æ¢¯åº¦ä¼ æ’­çš„é›…å¯æ¯”çŸ©é˜µé“¾ã€‚}</p>
<h4 id="12">1.2 é›…å¯æ¯”çŸ©é˜µçš„èŒƒæ•°åˆ†æ</h4>
<p>è®¾æ¯å±‚çš„é›…å¯æ¯”çŸ©é˜µ $\boldsymbol{J}<em i-1="i-1">i = \frac{\partial \boldsymbol{x}_i}{\partial \boldsymbol{x}</em>_i|$ã€‚åˆ™ï¼š}}$ï¼Œå…¶èŒƒæ•°ä¸º $|\boldsymbol{J</p>
<p>\begin{equation}
\left|\prod_{i=l+1}^{N} \boldsymbol{J}<em i="l+1">i\right| \leq \prod</em>_i|
\tag{2}
\end{equation}}^{N} |\boldsymbol{J</p>
<p><strong>æƒ…å†µ1: æ¢¯åº¦æ¶ˆå¤±</strong> - å¦‚æœ $|\boldsymbol{J}_i| &lt; 1$ï¼Œè®¾ $|\boldsymbol{J}_i| = \gamma &lt; 1$:</p>
<p>\begin{equation}
\left|\prod_{i=l+1}^{N} \boldsymbol{J}_i\right| \leq \gamma^{N-l}
\tag{3}
\end{equation}</p>
<p>å½“ $N-l$ å¾ˆå¤§æ—¶ï¼Œ$\gamma^{N-l} \to 0$ï¼Œå¯¼è‡´æ¢¯åº¦æ¶ˆå¤±ã€‚</p>
<p><strong>æƒ…å†µ2: æ¢¯åº¦çˆ†ç‚¸</strong> - å¦‚æœ $|\boldsymbol{J}_i| &gt; 1$ï¼Œè®¾ $|\boldsymbol{J}_i| = \beta &gt; 1$:</p>
<p>\begin{equation}
\left|\prod_{i=l+1}^{N} \boldsymbol{J}_i\right| \geq \beta^{N-l}
\tag{4}
\end{equation}</p>
<p>å½“ $N-l$ å¾ˆå¤§æ—¶ï¼Œ$\beta^{N-l} \to \infty$ï¼Œå¯¼è‡´æ¢¯åº¦çˆ†ç‚¸ã€‚</p>
<p><strong>æ•°å€¼ç¤ºä¾‹</strong>: å‡è®¾ $\gamma = 0.9$ï¼Œ$N = 100$ï¼Œ$l = 1$:</p>
<p>\begin{equation}
0.9^{99} \approx 2.65 \times 10^{-5}
\tag{5}
\end{equation}</p>
<p>æ¢¯åº¦è¡°å‡äº†çº¦ $10^5$ å€ï¼</p>
<h4 id="13-transformer">1.3 Transformerä¸­çš„æ¢¯åº¦ä¼ æ’­</h4>
<p>æ ‡å‡†Transformerçš„ä¸€å±‚åŒ…å«ä¸¤ä¸ªå­å±‚ï¼š
1. è‡ªæ³¨æ„åŠ›å±‚: $\boldsymbol{y}<em l_1="l+1">l = \boldsymbol{x}_l + \text{Attention}(\boldsymbol{x}_l)$
2. FFNå±‚: $\boldsymbol{x}</em>_l)$} = \boldsymbol{y}_l + \text{FFN}(\boldsymbol{y</p>
<p>ä¸å«æ®‹å·®æ—¶ï¼Œé›…å¯æ¯”çŸ©é˜µä¸ºï¼š</p>
<p>\begin{equation}
\boldsymbol{J}_l = \frac{\partial \text{FFN}(\text{Attention}(\boldsymbol{x}_l))}{\partial \boldsymbol{x}_l}
\tag{6}
\end{equation}</p>
<p>å«æ®‹å·®æ—¶ï¼ˆPost-LNï¼‰ï¼š</p>
<p>\begin{equation}
\boldsymbol{J}_l = \boldsymbol{I} + \frac{\partial \text{FFN}(\boldsymbol{y}_l)}{\partial \boldsymbol{y}_l} \left(\boldsymbol{I} + \frac{\partial \text{Attention}(\boldsymbol{x}_l)}{\partial \boldsymbol{x}_l}\right)
\tag{7}
\end{equation}</p>
<p><strong>å…³é”®æ´å¯Ÿ</strong>: æ®‹å·®è¿æ¥å¼•å…¥çš„ $\boldsymbol{I}$ é¡¹ç¡®ä¿ $\boldsymbol{J}_l$ çš„ç‰¹å¾å€¼è‡³å°‘æœ‰1ï¼Œé˜²æ­¢æ¢¯åº¦æ¶ˆå¤±ã€‚</p>
<h3 id="_11">äºŒã€å¢é‡çˆ†ç‚¸é—®é¢˜çš„æ·±å…¥åˆ†æ</h3>
<h4 id="21">2.1 å¢é‡çˆ†ç‚¸çš„æ•°å­¦å®šä¹‰</h4>
<p>å¯¹äºå‚æ•°æ›´æ–° $\Delta \boldsymbol{\theta} = -\eta \nabla_{\boldsymbol{\theta}} \mathcal{L}$ï¼ŒæŸå¤±å‡½æ•°çš„ä¸€é˜¶è¿‘ä¼¼å˜åŒ–ä¸ºï¼š</p>
<p>\begin{equation}
\Delta \mathcal{L} = \mathcal{L}(\boldsymbol{\theta} + \Delta\boldsymbol{\theta}) - \mathcal{L}(\boldsymbol{\theta}) \approx \langle \nabla_{\boldsymbol{\theta}} \mathcal{L}, \Delta\boldsymbol{\theta} \rangle
\tag{8}
\end{equation}</p>
<p>å¯¹äºSGD:</p>
<p>\begin{equation}
\Delta \mathcal{L} \approx -\eta |\nabla_{\boldsymbol{\theta}} \mathcal{L}|^2
\tag{9}
\end{equation}</p>
<p><strong>é—®é¢˜</strong>: å¯¹äº $N$ å±‚Transformerï¼Œæ¯å±‚æœ‰ $K$ ä¸ªå‚æ•°çŸ©é˜µï¼ˆSelf-Attentionæœ‰QKVå’Œè¾“å‡ºï¼ŒFFNæœ‰ä¸¤å±‚ï¼Œé€šå¸¸ $K \approx 6$ï¼‰ã€‚</p>
<h4 id="22">2.2 æ·±åº¦æ¨¡å‹çš„æ¢¯åº¦èŒƒæ•°</h4>
<p>å‡è®¾æ¯ä¸ªå‚æ•°çŸ©é˜µ $\boldsymbol{W}<em _boldsymbol_W="\boldsymbol{W">i$ çš„æ¢¯åº¦èŒƒæ•°ä¸º $|\nabla</em>| = g$ (é€šè¿‡å½’ä¸€åŒ–å’Œåˆå§‹åŒ–æ§åˆ¶)ã€‚}_i} \mathcal{L</p>
<p>æ€»æ¢¯åº¦èŒƒæ•°çš„å¹³æ–¹ï¼š</p>
<p>\begin{equation}
|\nabla_{\boldsymbol{\theta}} \mathcal{L}|^2 = \sum_{i=1}^{NK} |\nabla_{\boldsymbol{W}_i} \mathcal{L}|^2 = NKg^2
\tag{10}
\end{equation}</p>
<p>å› æ­¤ï¼š</p>
<p>\begin{equation}
\Delta \mathcal{L} \approx -\eta NK g^2 = \mathcal{O}(\eta N)
\tag{11}
\end{equation}</p>
<p><strong>å…³é”®ç»“è®º</strong>: æ›´æ–°é‡æ­£æ¯”äºå±‚æ•° $N$ï¼</p>
<h4 id="23">2.3 å¢é‡çˆ†ç‚¸çš„åæœ</h4>
<p>å¯¹äºæ·±å±‚ç½‘ç»œï¼ˆ$N$ å¾ˆå¤§ï¼‰ï¼š
1. åˆå§‹é˜¶æ®µæ¢¯åº¦æ­¥é•¿è¿‡å¤§
2. å®¹æ˜“è·³è¿‡å±€éƒ¨æœ€ä¼˜ï¼Œè¿›å…¥æ¬¡ä¼˜åŒºåŸŸ
3. è®­ç»ƒä¸ç¨³å®šï¼Œç”šè‡³å‘æ•£</p>
<p><strong>æ•°å€¼ç¤ºä¾‹</strong>: $N=100$ å±‚ vs $N=10$ å±‚ï¼Œç›¸åŒå­¦ä¹ ç‡ä¸‹æ›´æ–°é‡å·® 10 å€ï¼</p>
<p>\begin{equation}
\frac{\Delta \mathcal{L}<em N="10">{N=100}}{\Delta \mathcal{L}</em> = 10
\tag{12}
\end{equation}}} = \frac{100}{10</p>
<h3 id="layernorm">ä¸‰ã€LayerNormçš„æ•°å­¦æ¨å¯¼</h3>
<h4 id="31-layernorm">3.1 LayerNormçš„å®šä¹‰</h4>
<p>å¯¹äºè¾“å…¥ $\boldsymbol{x} \in \mathbb{R}^d$ï¼ŒLayerNormè®¡ç®—ï¼š</p>
<p>\begin{equation}
\text{LN}(\boldsymbol{x}) = \boldsymbol{\gamma} \odot \frac{\boldsymbol{x} - \boldsymbol{\mu}}{\sqrt{\boldsymbol{\sigma}^2 + \epsilon}} + \boldsymbol{\beta}
\tag{13}
\end{equation}</p>
<p>å…¶ä¸­ï¼š
- $\boldsymbol{\mu} = \frac{1}{d} \sum_{i=1}^{d} x_i$ (å‡å€¼)
- $\boldsymbol{\sigma}^2 = \frac{1}{d} \sum_{i=1}^{d} (x_i - \mu)^2$ (æ–¹å·®)
- $\boldsymbol{\gamma}, \boldsymbol{\beta} \in \mathbb{R}^d$ æ˜¯å¯å­¦ä¹ å‚æ•°
- $\epsilon$ æ˜¯æ•°å€¼ç¨³å®šæ€§å¸¸æ•°ï¼ˆé€šå¸¸ $10^{-5}$ï¼‰</p>
<h4 id="32-layernorm">3.2 LayerNormçš„æ¢¯åº¦æ¨å¯¼</h4>
<p>è®¾ $\boldsymbol{y} = \text{LN}(\boldsymbol{x})$ï¼Œè®¡ç®— $\frac{\partial \mathcal{L}}{\partial \boldsymbol{x}}$ï¼š</p>
<p>é¦–å…ˆè®¡ç®—å½’ä¸€åŒ–éƒ¨åˆ† $\hat{\boldsymbol{x}} = \frac{\boldsymbol{x} - \boldsymbol{\mu}}{\sqrt{\boldsymbol{\sigma}^2 + \epsilon}}$ï¼š</p>
<p>\begin{equation}
\frac{\partial \hat{x}<em ij="ij">i}{\partial x_j} = \frac{1}{\sqrt{\boldsymbol{\sigma}^2 + \epsilon}} \left(\delta</em>
\tag{14}
\end{equation}} - \frac{1}{d}\right) - \frac{\hat{x}_i \cdot (x_j - \mu)}{d(\boldsymbol{\sigma}^2 + \epsilon)</p>
<p>å…¶ä¸­ $\delta_{ij}$ æ˜¯Kronecker deltaã€‚</p>
<p>å®Œæ•´çš„æ¢¯åº¦ä¸ºï¼š</p>
<p>\begin{equation}
\frac{\partial \mathcal{L}}{\partial x_i} = \frac{\gamma_i}{\sqrt{\boldsymbol{\sigma}^2 + \epsilon}} \left[\frac{\partial \mathcal{L}}{\partial y_i} - \frac{1}{d} \sum_{j=1}^{d} \frac{\partial \mathcal{L}}{\partial y_j} - \hat{x}<em j="1">i \frac{1}{d} \sum</em>\right]
\tag{15}
\end{equation}}^{d} \hat{x}_j \frac{\partial \mathcal{L}}{\partial y_j</p>
<p><strong>é‡è¦æ€§è´¨</strong>: LayerNormçš„æ¢¯åº¦è‡ªåŠ¨å½’ä¸€åŒ–ï¼Œ$|\frac{\partial \mathcal{L}}{\partial \boldsymbol{x}}| = \mathcal{O}(1)$ï¼Œæœ‰åŠ©äºç¨³å®šè®­ç»ƒã€‚</p>
<h4 id="33-rmsnorm">3.3 RMSNormçš„ç®€åŒ–æ¨å¯¼</h4>
<p>RMSNormç®€åŒ–äº†LayerNormï¼Œå»æ‰äº†å‡å€¼è®¡ç®—å’Œåç½®é¡¹ï¼š</p>
<p>\begin{equation}
\text{RMSNorm}(\boldsymbol{x}) = \boldsymbol{\gamma} \odot \frac{\boldsymbol{x}}{\text{RMS}(\boldsymbol{x})}
\tag{16}
\end{equation}</p>
<p>å…¶ä¸­ RMS (Root Mean Square):</p>
<p>\begin{equation}
\text{RMS}(\boldsymbol{x}) = \sqrt{\frac{1}{d} \sum_{i=1}^{d} x_i^2 + \epsilon}
\tag{17}
\end{equation}</p>
<p><strong>ä¼˜åŠ¿</strong>:
1. è®¡ç®—æ›´å¿«ï¼ˆå°‘ä¸€æ¬¡å‡å€¼è®¡ç®—ï¼‰
2. æ¢¯åº¦æ›´ç®€å•
3. å®éªŒæ•ˆæœä¸LayerNormç›¸å½“</p>
<p>RMSNormçš„æ¢¯åº¦ï¼š</p>
<p>\begin{equation}
\frac{\partial \mathcal{L}}{\partial x_i} = \frac{\gamma_i}{\text{RMS}(\boldsymbol{x})} \left[\frac{\partial \mathcal{L}}{\partial y_i} - \frac{x_i}{d \cdot \text{RMS}(\boldsymbol{x})^2} \sum_{j=1}^{d} x_j \frac{\partial \mathcal{L}}{\partial y_j}\right]
\tag{18}
\end{equation}</p>
<h3 id="post-ln-vs-pre-ln">å››ã€Post-LN vs Pre-LNçš„ç†è®ºåˆ†æ</h3>
<h4 id="41-post-ln">4.1 Post-LNçš„ç»“æ„</h4>
<p>\begin{equation}
\boldsymbol{x}_{l+1} = \text{LN}(\boldsymbol{x}_l + F(\boldsymbol{x}_l))
\tag{19}
\end{equation}</p>
<p>å…¶ä¸­ $F$ æ˜¯Self-Attentionæˆ–FFNã€‚</p>
<p><strong>æ¢¯åº¦æµ</strong>:</p>
<p>\begin{equation}
\frac{\partial \mathcal{L}}{\partial \boldsymbol{x}<em l_1="l+1">l} = \frac{\partial \mathcal{L}}{\partial \boldsymbol{x}</em>\right)
\tag{20}
\end{equation}}} \frac{\partial \text{LN}(\boldsymbol{x}_l + F(\boldsymbol{x}_l))}{\partial (\boldsymbol{x}_l + F(\boldsymbol{x}_l))} \left(\boldsymbol{I} + \frac{\partial F(\boldsymbol{x}_l)}{\partial \boldsymbol{x}_l</p>
<p><strong>é—®é¢˜</strong>: LayerNormçš„é›…å¯æ¯”çŸ©é˜µä¼šé‡æ–°ç¼©æ”¾æ¢¯åº¦ï¼Œå¯èƒ½ç ´åæ®‹å·®è¿æ¥çš„æ’ç­‰æ˜ å°„ã€‚</p>
<h4 id="42-pre-ln">4.2 Pre-LNçš„ç»“æ„</h4>
<p>\begin{equation}
\boldsymbol{x}_{l+1} = \boldsymbol{x}_l + F(\text{LN}(\boldsymbol{x}_l))
\tag{21}
\end{equation}</p>
<p><strong>æ¢¯åº¦æµ</strong>:</p>
<p>\begin{equation}
\frac{\partial \mathcal{L}}{\partial \boldsymbol{x}<em l_1="l+1">l} = \frac{\partial \mathcal{L}}{\partial \boldsymbol{x}</em>\right)
\tag{22}
\end{equation}}} \left(\boldsymbol{I} + \frac{\partial F(\text{LN}(\boldsymbol{x}_l))}{\partial \text{LN}(\boldsymbol{x}_l)} \frac{\partial \text{LN}(\boldsymbol{x}_l)}{\partial \boldsymbol{x}_l</p>
<p><strong>ä¼˜åŠ¿</strong>: æ’ç­‰è·¯å¾„ $\boldsymbol{I}$ ä¸å—LayerNormå½±å“ï¼Œæ¢¯åº¦ä¼ æ’­æ›´ç¨³å®šã€‚</p>
<h4 id="43-deepnorm">4.3 DeepNormçš„æ”¹è¿›</h4>
<p>DeepNormå¼•å…¥ç¼©æ”¾å› å­ $\alpha$:</p>
<p>\begin{equation}
\boldsymbol{x}_{l+1} = \text{LN}(\alpha \boldsymbol{x}_l + F(\boldsymbol{x}_l))
\tag{23}
\end{equation}</p>
<p>ç­‰ä»·å½¢å¼ï¼š</p>
<p>\begin{equation}
\boldsymbol{x}_{l+1} = \text{LN}\left(\boldsymbol{x}_l + \frac{F(\boldsymbol{x}_l)}{\alpha}\right)
\tag{24}
\end{equation}</p>
<p><strong>è®¾è®¡åŸç†</strong>: é€šè¿‡è°ƒæ•´ $\alpha$ æ§åˆ¶æ®‹å·®åˆ†æ”¯çš„è´¡çŒ®ï¼Œä½¿åˆå§‹é˜¶æ®µæ¨¡å‹æ¥è¿‘æ’ç­‰å‡½æ•°ã€‚</p>
<h3 id="_12">äº”ã€é‡çº§åˆ†è§£ä¸åˆå§‹åŒ–ç­–ç•¥</h3>
<h4 id="51">5.1 çŸ©é˜µçš„é‡çº§åˆ†è§£</h4>
<p>å°†å‚æ•°çŸ©é˜µ $\boldsymbol{W}$ åˆ†è§£ä¸º:</p>
<p>\begin{equation}
\boldsymbol{W} = \lambda \boldsymbol{U}
\tag{25}
\end{equation}</p>
<p>å…¶ä¸­ï¼š
- $\lambda &gt; 0$ æ˜¯æ ‡é‡å¢ç›Š
- $\boldsymbol{U}$ æ¥è¿‘æ­£äº¤çŸ©é˜µ ($\boldsymbol{U}\boldsymbol{U}^\top \approx \boldsymbol{I}$)</p>
<p><strong>æœ€ä¼˜åŒ–é—®é¢˜</strong>:</p>
<p>\begin{equation}
\lambda = \arg\min_{\kappa &gt; 0} |\boldsymbol{W}\boldsymbol{W}^\top / \kappa^2 - \boldsymbol{I}|_F
\tag{26}
\end{equation}</p>
<p>è§£ä¸ºï¼š</p>
<p>\begin{equation}
\lambda = \sqrt{\frac{\text{tr}(\boldsymbol{W}\boldsymbol{W}^\top)}{d}} = |\boldsymbol{W}|_F / \sqrt{d}
\tag{27}
\end{equation}</p>
<h4 id="52">5.2 æ¢¯åº¦çš„é‡çº§æ¢é’ˆ</h4>
<p>å¯¹äºæŸå¤±å‡½æ•° $\mathcal{L}(\lambda \boldsymbol{U})$ï¼Œæ ‡é‡æ¢¯åº¦ä¸ºï¼š</p>
<p>\begin{equation}
\frac{\partial \mathcal{L}}{\partial \lambda} = \left\langle \frac{\partial \mathcal{L}}{\partial (\lambda \boldsymbol{U})}, \boldsymbol{U} \right\rangle = \left\langle \frac{\partial \mathcal{L}}{\partial \boldsymbol{W}}, \boldsymbol{U} \right\rangle
\tag{28}
\end{equation}</p>
<p><strong>å…³é”®æ€§è´¨</strong>: $\frac{\partial \mathcal{L}}{\partial \lambda}$ ä¸ $|\frac{\partial \mathcal{L}}{\partial \boldsymbol{W}}|$ åœ¨é‡çº§ä¸Šæˆæ­£æ¯”ã€‚</p>
<h4 id="53-xavier">5.3 Xavieråˆå§‹åŒ–çš„æ•°å­¦åŸç†</h4>
<p>Xavieråˆå§‹åŒ–è¦æ±‚å‰å‘ä¼ æ’­æ—¶æ–¹å·®ä¿æŒä¸å˜ã€‚å¯¹äºçº¿æ€§å±‚ $\boldsymbol{y} = \boldsymbol{W}\boldsymbol{x}$:</p>
<p>\begin{equation}
\text{Var}(y_i) = \sum_{j=1}^{d_{\text{in}}} \text{Var}(W_{ij} x_j) = d_{\text{in}} \cdot \text{Var}(W_{ij}) \cdot \text{Var}(x_j)
\tag{29}
\end{equation}</p>
<p>è¦ä½¿ $\text{Var}(y_i) = \text{Var}(x_j)$ï¼Œéœ€è¦ï¼š</p>
<p>\begin{equation}
\text{Var}(W_{ij}) = \frac{1}{d_{\text{in}}}
\tag{30}
\end{equation}</p>
<p>è€ƒè™‘åå‘ä¼ æ’­çš„å¯¹ç§°æ€§ï¼Œæœ€ç»ˆï¼š</p>
<p>\begin{equation}
W_{ij} \sim \mathcal{N}\left(0, \frac{2}{d_{\text{in}} + d_{\text{out}}}\right)
\tag{31}
\end{equation}</p>
<p><strong>çŸ©é˜µè§†è§’</strong>: Xavieråˆå§‹åŒ–ä½¿ $\boldsymbol{W}$ æ¥è¿‘æ­£äº¤çŸ©é˜µï¼Œå³ $\lambda \approx 1$ã€‚</p>
<h3 id="ffn">å…­ã€FFNå±‚çš„æ¢¯åº¦é‡çº§åˆ†æ</h3>
<h4 id="61-ffn">6.1 FFNçš„æ•°å­¦å½¢å¼</h4>
<p>\begin{equation}
\boldsymbol{x}_{l+1} = \text{LN}(\boldsymbol{x}_l + \phi(\boldsymbol{x}_l \boldsymbol{W}_1) \boldsymbol{W}_2 / \alpha)
\tag{32}
\end{equation}</p>
<p>å…¶ä¸­ $\phi$ æ˜¯æ¿€æ´»å‡½æ•°ï¼ˆReLU, GELUç­‰ï¼‰ã€‚</p>
<p><strong>é½æ¬¡æ€§</strong>: å¯¹äºReLUåŠå…¶å˜ä½“ï¼Œæ»¡è¶³ $\phi(\lambda \boldsymbol{x}) \approx \lambda \phi(\boldsymbol{x})$ (å½“ $\lambda &gt; 0$)ã€‚</p>
<h4 id="62">6.2 é‡çº§åˆ†è§£åçš„å½¢å¼</h4>
<p>ä½¿ç”¨ $\boldsymbol{W}_i = \lambda_i \boldsymbol{U}_i$:</p>
<p>\begin{equation}
\boldsymbol{z}_{l+1} = \boldsymbol{x}_l + \lambda_1 \lambda_2 \phi(\boldsymbol{x}_l \boldsymbol{U}_1) \boldsymbol{U}_2 / \alpha
\tag{33}
\end{equation}</p>
<h4 id="63">6.3 æ¢¯åº¦è®¡ç®—</h4>
<p>å¯¹ $\lambda_1$ çš„æ¢¯åº¦ï¼š</p>
<p>\begin{equation}
\frac{\partial \mathcal{L}}{\partial \lambda_1} = \frac{\partial \mathcal{L}}{\partial \boldsymbol{x}<em l_1="l+1">{l+1}} \frac{\partial \boldsymbol{x}</em>
\tag{34}
\end{equation}}}{\partial \boldsymbol{z}_{l+1}} \frac{\lambda_2 \phi(\boldsymbol{x}_l \boldsymbol{U}_1) \boldsymbol{U}_2}{\alpha</p>
<p><strong>é‡çº§ä¼°è®¡</strong>:
- $\frac{\partial \mathcal{L}}{\partial \boldsymbol{x}<em l_1="l+1">{l+1}} = \mathcal{O}(1)$ (å½’ä¸€åŒ–ä½œç”¨)
- $\frac{\partial \boldsymbol{x}</em>(1)$ (LayerNormé›…å¯æ¯”)
- $\phi(\boldsymbol{x}_l \boldsymbol{U}_1) \boldsymbol{U}_2 = \mathcal{O}(1)$ (æ­£äº¤æ€§)}}{\partial \boldsymbol{z}_{l+1}} = \mathcal{O</p>
<p>å› æ­¤ï¼š</p>
<p>\begin{equation}
\frac{\partial \mathcal{L}}{\partial \lambda_1} = \mathcal{O}\left(\frac{\lambda_2}{\alpha}\right)
\tag{35}
\end{equation}</p>
<p>åŒç†ï¼š</p>
<p>\begin{equation}
\frac{\partial \mathcal{L}}{\partial \lambda_2} = \mathcal{O}\left(\frac{\lambda_1}{\alpha}\right)
\tag{36}
\end{equation}</p>
<h3 id="self-attention">ä¸ƒã€Self-Attentionçš„æ¢¯åº¦é‡çº§åˆ†æ</h3>
<h4 id="71">7.1 å•å¤´æ³¨æ„åŠ›çš„é‡çº§åˆ†è§£</h4>
<p>\begin{equation}
\boldsymbol{x}_{l+1} = \text{LN}(\boldsymbol{x}_l + \sigma(\boldsymbol{x}_l \boldsymbol{W}_q \boldsymbol{W}_k^\top \boldsymbol{x}_l^\top) \boldsymbol{x}_l \boldsymbol{W}_v \boldsymbol{W}_o / \alpha)
\tag{37}
\end{equation}</p>
<p>å…¶ä¸­ $\sigma$ è¡¨ç¤ºsoftmaxæ“ä½œã€‚</p>
<p>åˆ†è§£åï¼š</p>
<p>\begin{equation}
\boldsymbol{z}_{l+1} = \boldsymbol{x}_l + \lambda_v \lambda_o \sigma(\lambda_q \lambda_k \boldsymbol{x}_l \boldsymbol{U}_q \boldsymbol{U}_k^\top \boldsymbol{x}_l^\top) \boldsymbol{x}_l \boldsymbol{U}_v \boldsymbol{U}_o / \alpha
\tag{38}
\end{equation}</p>
<h4 id="72-softmax">7.2 Softmaxçš„é‡çº§ä¸å˜æ€§</h4>
<p><strong>å…³é”®æ€§è´¨</strong>: Softmaxå¯¹è¾“å…¥çš„ç¼©æ”¾ä¸æ•æ„Ÿï¼ˆåˆ°æŸç§ç¨‹åº¦ï¼‰ã€‚</p>
<p>\begin{equation}
\sigma(c\boldsymbol{x}) = \sigma(\boldsymbol{x}), \quad \text{å½“ç¼©æ”¾è¢«æ¸©åº¦å¸æ”¶}
\tag{39}
\end{equation}</p>
<p>åœ¨Attentionä¸­ï¼Œ$\lambda_q \lambda_k$ çš„ç¼©æ”¾æ•ˆæœç±»ä¼¼äºè°ƒæ•´æ¸©åº¦ï¼Œä½†softmaxåçš„åŠ æƒå¹³å‡ä»ä¿æŒ $\mathcal{O}(1)$ é‡çº§ã€‚</p>
<p><strong>æ•°å­¦ç›´è§‰</strong>:</p>
<p>\begin{equation}
\sum_{i} \text{softmax}(\boldsymbol{a})_i \boldsymbol{v}_i \approx \mathcal{O}(|\boldsymbol{v}|)
\tag{40}
\end{equation}</p>
<p>ç”±äº $\boldsymbol{v}_i = \boldsymbol{x}_i \boldsymbol{U}_v$ ä¸” $\boldsymbol{U}_v$ æ­£äº¤ï¼Œæœ‰ $|\boldsymbol{v}| = \mathcal{O}(|\boldsymbol{x}|) = \mathcal{O}(1)$ (ç»è¿‡LayerNorm)ã€‚</p>
<h4 id="73-vo">7.3 Vå’ŒOçš„æ¢¯åº¦</h4>
<p>å¯¹ $\lambda_v$ çš„æ¢¯åº¦ï¼š</p>
<p>\begin{equation}
\frac{\partial \mathcal{L}}{\partial \lambda_v} = \frac{\partial \mathcal{L}}{\partial \boldsymbol{x}<em l_1="l+1">{l+1}} \frac{\partial \boldsymbol{x}</em>\right)
\tag{41}
\end{equation}}}{\partial \boldsymbol{z}_{l+1}} \frac{\lambda_o \sigma(\cdots) \boldsymbol{x}_l \boldsymbol{U}_v \boldsymbol{U}_o}{\alpha} = \mathcal{O}\left(\frac{\lambda_o}{\alpha</p>
<p>å¯¹ $\lambda_o$ çš„æ¢¯åº¦ï¼š</p>
<p>\begin{equation}
\frac{\partial \mathcal{L}}{\partial \lambda_o} = \mathcal{O}\left(\frac{\lambda_v}{\alpha}\right)
\tag{42}
\end{equation}</p>
<p><strong>ç»Ÿä¸€ç»“è®º</strong>: æ— è®ºFFNè¿˜æ˜¯Self-Attentionï¼š</p>
<p>\begin{equation}
\frac{\partial \mathcal{L}}{\partial \lambda} = \mathcal{O}\left(\frac{\lambda}{\alpha}\right)
\tag{43}
\end{equation}</p>
<h3 id="_13">å…«ã€æ·±åº¦å½’ä¸€åŒ–æ–¹æ¡ˆçš„æ¨å¯¼</h3>
<h4 id="81">8.1 æŠ‘åˆ¶å¢é‡çˆ†ç‚¸çš„ç›®æ ‡</h4>
<p>å›é¡¾å¢é‡çˆ†ç‚¸ï¼šæ¯ä¸ªå‚æ•°çš„æ¢¯åº¦ä¸º $\mathcal{O}(\lambda/\alpha)$ï¼Œ$N$ å±‚ç½‘ç»œå…± $2NK$ ä¸ªå‚æ•°ï¼ˆæ¯å±‚Kä¸ªSelf-Attentionå‚æ•°ï¼ŒKä¸ªFFNå‚æ•°ï¼‰ã€‚</p>
<p>æ€»æ¢¯åº¦èŒƒæ•°å¹³æ–¹ï¼š</p>
<p>\begin{equation}
|\nabla_{\boldsymbol{\theta}} \mathcal{L}|^2 = 2NK \cdot \mathcal{O}\left(\frac{\lambda^2}{\alpha^2}\right)
\tag{44}
\end{equation}</p>
<p>SGDçš„æ›´æ–°é‡ï¼š</p>
<p>\begin{equation}
\Delta \mathcal{L} = -\eta |\nabla_{\boldsymbol{\theta}} \mathcal{L}|^2 = \mathcal{O}\left(\eta \cdot 2NK \cdot \frac{\lambda^2}{\alpha^2}\right)
\tag{45}
\end{equation}</p>
<p><strong>ç›®æ ‡</strong>: ä½¿æ›´æ–°é‡ä¸ $N$ æ— å…³ï¼Œå³ï¼š</p>
<p>\begin{equation}
\frac{\lambda^2}{\alpha^2} = \mathcal{O}\left(\frac{1}{N}\right)
\tag{46}
\end{equation}</p>
<h4 id="82">8.2 ä¸‰ç§ä¼˜åŒ–å™¨çš„åˆ†æ</h4>
<p><strong>SGD</strong>: $\Delta \boldsymbol{\theta} = -\eta \nabla_{\boldsymbol{\theta}} \mathcal{L}$</p>
<p>\begin{equation}
\Delta \mathcal{L} \propto -\eta |\nabla_{\boldsymbol{\theta}} \mathcal{L}|^2 = \mathcal{O}\left(\eta NK \frac{\lambda^2}{\alpha^2}\right)
\tag{47}
\end{equation}</p>
<p>è¦æ±‚ $\frac{\lambda^2}{\alpha^2} = \frac{1}{2NK}$ï¼Œå³ï¼š</p>
<p>\begin{equation}
\frac{\lambda}{\alpha} = \frac{1}{\sqrt{2NK}} = \frac{1}{\sqrt{2N}} \quad (\text{å‡è®¾} K \approx 1)
\tag{48}
\end{equation}</p>
<p><strong>Adam</strong>: $\Delta \boldsymbol{\theta} \approx -\eta \cdot \text{sign}(\nabla_{\boldsymbol{\theta}} \mathcal{L})$</p>
<p>\begin{equation}
\Delta \mathcal{L} \propto -\eta |\nabla_{\boldsymbol{\theta}} \mathcal{L}|_1 = \mathcal{O}\left(\eta \sqrt{NK} \cdot \frac{\lambda}{\alpha}\right)
\tag{49}
\end{equation}</p>
<p>è¦æ±‚ $\frac{\lambda}{\alpha} = \frac{1}{\sqrt{NK}} = \frac{1}{\sqrt{N}}$ã€‚</p>
<p><strong>LAMB</strong>: $\Delta \boldsymbol{\theta} \approx -\eta |\boldsymbol{\theta}| \cdot \text{sign}(\nabla_{\boldsymbol{\theta}} \mathcal{L})$</p>
<p>\begin{equation}
\Delta \mathcal{L} \propto -\eta \lambda \sqrt{NK} \cdot \frac{\lambda}{\alpha} = \mathcal{O}\left(\eta \sqrt{NK} \cdot \frac{\lambda^2}{\alpha}\right)
\tag{50}
\end{equation}</p>
<p>è¦æ±‚ $\frac{\lambda^2}{\alpha} = \frac{1}{\sqrt{NK}}$ï¼Œå³ $\lambda = 1, \alpha = \sqrt{N}$ (é€‰æ‹©ä¸€ç§ç®€å•è§£)ã€‚</p>
<h4 id="83-alpha-lambda">8.3 $\alpha$ å’Œ $\lambda$ çš„æœ€ä¼˜é€‰æ‹©</h4>
<p><strong>å¯¹ç§°æ€§åŸåˆ™</strong>: è®© $\lambda = 1/\alpha$ï¼Œä½¿å¾—æ®‹å·®åˆ†æ”¯å’Œä¸»è·¯å¾„åœ¨åˆå§‹é˜¶æ®µå¹³è¡¡ã€‚</p>
<p>å¯¹äºSGD:</p>
<p>\begin{equation}
\frac{\lambda}{\alpha} = \frac{1}{\sqrt{2N}} \quad \text{ä¸”} \quad \lambda = \frac{1}{\alpha}
\tag{51}
\end{equation}</p>
<p>è§£å¾—ï¼š</p>
<p>\begin{equation}
\alpha = (2N)^{1/4}, \quad \lambda = (2N)^{-1/4}
\tag{52}
\end{equation}</p>
<p>å¯¹äºAdam:</p>
<p>\begin{equation}
\alpha = N^{1/2}, \quad \lambda = N^{-1/2}
\tag{53}
\end{equation}</p>
<p>å¯¹äºLAMB:</p>
<p>\begin{equation}
\alpha = 1, \quad \lambda = N^{-1/2}
\tag{54}
\end{equation}</p>
<h3 id="_14">ä¹ã€åˆå§‹åŒ–å¯¹è®­ç»ƒçš„å½±å“</h3>
<h4 id="91">9.1 æ®‹å·®åˆ†æ”¯çš„åˆå§‹æƒé‡</h4>
<p>DeepNormè®¾ç½® $\lambda = (2N)^{-1/4}$ æ„å‘³ç€æ¯ä¸ªæ®‹å·®åˆ†æ”¯çš„åˆå§‹è´¡çŒ®ä¸ºï¼š</p>
<p>\begin{equation}
\frac{\lambda^2}{\alpha} = \frac{(2N)^{-1/2}}{(2N)^{1/4}} = (2N)^{-3/4}
\tag{55}
\end{equation}</p>
<p><strong>æ•°å€¼ç¤ºä¾‹</strong>: $N=1000$ æ—¶ï¼š</p>
<p>\begin{equation}
\frac{\lambda^2}{\alpha} = (2000)^{-3/4} \approx 0.0042
\tag{56}
\end{equation}</p>
<p>åˆå§‹é˜¶æ®µæ¯ä¸ªæ®‹å·®åˆ†æ”¯ä»…è´¡çŒ® $0.4\%$ çš„å˜åŒ–ï¼Œæ¨¡å‹æ¥è¿‘æ’ç­‰å‡½æ•°ï¼</p>
<h4 id="92">9.2 æ’ç­‰åˆå§‹åŒ–çš„é‡è¦æ€§</h4>
<p><strong>å®šç†</strong>: å¦‚æœåˆå§‹é˜¶æ®µ $\boldsymbol{x}_{l+1} \approx \boldsymbol{x}_l$ï¼ˆæ’ç­‰å‡½æ•°ï¼‰ï¼Œåˆ™ï¼š</p>
<p>\begin{equation}
\frac{\partial \mathcal{L}}{\partial \boldsymbol{x}_{l+1}} \approx \frac{\partial \mathcal{L}}{\partial \boldsymbol{x}_l}
\tag{57}
\end{equation}</p>
<p>æ¢¯åº¦å‡ ä¹æ— è¡°å‡åœ°ä¼ æ’­åˆ°åº•å±‚ã€‚</p>
<p><strong>è¯æ˜</strong>: ç”±é“¾å¼æ³•åˆ™ï¼š</p>
<p>\begin{equation}
\frac{\partial \mathcal{L}}{\partial \boldsymbol{x}<em l_1="l+1">l} = \frac{\partial \mathcal{L}}{\partial \boldsymbol{x}</em>
\tag{58}
\end{equation}}} \frac{\partial \boldsymbol{x}_{l+1}}{\partial \boldsymbol{x}_l</p>
<p>å½“ $\boldsymbol{x}_{l+1} = \boldsymbol{x}_l + \epsilon F(\boldsymbol{x}_l)$ ä¸” $\epsilon \to 0$:</p>
<p>\begin{equation}
\frac{\partial \boldsymbol{x}_{l+1}}{\partial \boldsymbol{x}_l} \approx \boldsymbol{I}
\tag{59}
\end{equation}</p>
<p>å› æ­¤ $\frac{\partial \mathcal{L}}{\partial \boldsymbol{x}<em l_1="l+1">l} \approx \frac{\partial \mathcal{L}}{\partial \boldsymbol{x}</em>$ã€‚â–¡}</p>
<h3 id="warmup">åã€Warmupçš„æ•°å­¦å¿…è¦æ€§</h3>
<h4 id="101-warmup">10.1 å­¦ä¹ ç‡warmupçš„ç›®çš„</h4>
<p>åœ¨è®­ç»ƒåˆæœŸï¼Œå³ä½¿æœ‰DeepNormï¼Œå‚æ•°çš„é‡çº§ä»éœ€è¦æ—¶é—´æ¥ç¨³å®šã€‚Warmupé€šè¿‡é€æ¸å¢å¤§å­¦ä¹ ç‡æ¥é€‚åº”è¿™ä¸ªè¿‡ç¨‹ã€‚</p>
<p><strong>çº¿æ€§warmup</strong>:</p>
<p>\begin{equation}
\eta(t) = \begin{cases}
\frac{t}{T_{\text{warmup}}} \eta_{\text{max}}, &amp; t \leq T_{\text{warmup}} \
\eta_{\text{max}}, &amp; t &gt; T_{\text{warmup}}
\end{cases}
\tag{60}
\end{equation}</p>
<h4 id="102-warmup">10.2 Warmupä¸å¢é‡çˆ†ç‚¸çš„å…³ç³»</h4>
<p>å³ä½¿æ¢¯åº¦è¢«å½’ä¸€åŒ–åˆ° $\mathcal{O}(1/\sqrt{N})$ï¼Œåˆå§‹çš„å¤§æ­¥é•¿ä»å¯èƒ½å¯¼è‡´å‚æ•°åç¦»æœ€ä¼˜åˆå§‹åŒ–ã€‚</p>
<p><strong>è‡ªé€‚åº”ç­–ç•¥</strong>: Warmupç›¸å½“äºåŠ¨æ€è°ƒæ•´ $\eta$ ä½¿å¾—ï¼š</p>
<p>\begin{equation}
\eta(t) \cdot |\nabla_{\boldsymbol{\theta}} \mathcal{L}| \approx \text{constant}
\tag{61}
\end{equation}</p>
<p>åœ¨åˆæœŸæ¢¯åº¦è¾ƒå¤§æ—¶ç”¨è¾ƒå°çš„ $\eta$ï¼Œé¿å…è¿‡åº¦æ›´æ–°ã€‚</p>
<h4 id="103">10.3 æ•°å€¼ç¤ºä¾‹</h4>
<p>å‡è®¾ $N=100$ï¼Œä½¿ç”¨Adamï¼š
- æ— warmup: ç›´æ¥ç”¨ $\eta = 10^{-4}$ å¯èƒ½å¯¼è‡´åˆæœŸéœ‡è¡
- æœ‰warmup: å‰1000æ­¥ä» $\eta = 10^{-7}$ çº¿æ€§å¢åŠ åˆ° $10^{-4}$</p>
<p>åˆæœŸæ›´æ–°é‡ï¼š</p>
<p>\begin{equation}
\Delta \boldsymbol{\theta}_{\text{warmup}} = \frac{t}{1000} \cdot 10^{-4} \cdot \text{sign}(\nabla) \approx 10^{-7} \text{sign}(\nabla) \quad (t \ll 1000)
\tag{62}
\end{equation}</p>
<p>ç›¸æ¯”æ— warmupå‡å°‘äº†1000å€ï¼Œè®©å‚æ•°æœ‰æ—¶é—´"é€‚åº”"ã€‚</p>
<h3 id="pre-ln-vs-post-ln">åä¸€ã€Pre-LN vs Post-LNçš„æ”¶æ•›æ€§åˆ†æ</h3>
<h4 id="111-pre-ln">11.1 Pre-LNçš„æ¢¯åº¦ä¼ æ’­</h4>
<p>Pre-LN: $\boldsymbol{x}_{l+1} = \boldsymbol{x}_l + F(\text{LN}(\boldsymbol{x}_l))$</p>
<p>æ¢¯åº¦ï¼š</p>
<p>\begin{equation}
\frac{\partial \mathcal{L}}{\partial \boldsymbol{x}<em l_1="l+1">l} = \frac{\partial \mathcal{L}}{\partial \boldsymbol{x}</em>(\lambda)\right]
\tag{63}
\end{equation}}} \left[\boldsymbol{I} + \mathcal{O</p>
<p>è·¨ $N$ å±‚ï¼š</p>
<p>\begin{equation}
\frac{\partial \mathcal{L}}{\partial \boldsymbol{x}<em l="1">1} = \frac{\partial \mathcal{L}}{\partial \boldsymbol{x}_N} \prod</em>(\lambda)]
\tag{64}
\end{equation}}^{N-1} [\boldsymbol{I} + \mathcal{O</p>
<p><strong>èŒƒæ•°ä¼°è®¡</strong>:</p>
<p>\begin{equation}
\left|\frac{\partial \mathcal{L}}{\partial \boldsymbol{x}_1}\right| \approx \left|\frac{\partial \mathcal{L}}{\partial \boldsymbol{x}_N}\right| (1 + \mathcal{O}(\lambda))^N
\tag{65}
\end{equation}</p>
<p>å½“ $\lambda$ å¾ˆå°æ—¶ï¼Œ$(1 + \mathcal{O}(\lambda))^N \approx 1$ï¼Œæ¢¯åº¦ä¼ æ’­ç¨³å®šã€‚</p>
<h4 id="112-post-ln">11.2 Post-LNçš„æ¢¯åº¦ä¼ æ’­</h4>
<p>Post-LN: $\boldsymbol{x}_{l+1} = \text{LN}(\boldsymbol{x}_l + F(\boldsymbol{x}_l))$</p>
<p>æ¢¯åº¦åŒ…å«LayerNormçš„é›…å¯æ¯”ï¼š</p>
<p>\begin{equation}
\frac{\partial \mathcal{L}}{\partial \boldsymbol{x}<em l_1="l+1">l} = \frac{\partial \mathcal{L}}{\partial \boldsymbol{x}</em>(\lambda)]
\tag{66}
\end{equation}}} \cdot \boldsymbol{J}_{\text{LN}} \cdot [\boldsymbol{I} + \mathcal{O</p>
<p><strong>é—®é¢˜</strong>: $\boldsymbol{J}_{\text{LN}}$ ä¼šé‡æ–°å½’ä¸€åŒ–ï¼Œå¯èƒ½ç ´åæ¢¯åº¦çš„æ’ç­‰ä¼ æ’­ã€‚</p>
<h4 id="113-deepnorm">11.3 DeepNormçš„ä¼˜åŒ–</h4>
<p>DeepNormåœ¨Post-LNåŸºç¡€ä¸Šæ·»åŠ  $\alpha$ ç¼©æ”¾ï¼š</p>
<p>\begin{equation}
\boldsymbol{x}_{l+1} = \text{LN}(\alpha \boldsymbol{x}_l + F(\boldsymbol{x}_l))
\tag{67}
\end{equation}</p>
<p>å½“ $\alpha &gt; 1$ æ—¶ï¼Œä¸»è·¯å¾„è¢«æ”¾å¤§ï¼Œå‡è½»LayerNormçš„ç ´åä½œç”¨ã€‚</p>
<p><strong>æœ€ä¼˜ $\alpha$</strong>: ä½¿å¾—ä¸»è·¯å¾„åœ¨LayerNormåä»å ä¸»å¯¼ï¼š</p>
<p>\begin{equation}
\alpha = (2N)^{1/4}
\tag{68}
\end{equation}</p>
<h3 id="_15">åäºŒã€å®è·µå»ºè®®ä¸æ•°å€¼éªŒè¯</h3>
<h4 id="121">12.1 ä¸åŒæ·±åº¦çš„é…ç½®å»ºè®®</h4>
<table>
<thead>
<tr>
<th>å±‚æ•° $N$</th>
<th>ä¼˜åŒ–å™¨</th>
<th>$\alpha$</th>
<th>$\lambda$</th>
<th>Warmupæ­¥æ•°</th>
</tr>
</thead>
<tbody>
<tr>
<td>12</td>
<td>Adam</td>
<td>2.5</td>
<td>0.4</td>
<td>1000</td>
</tr>
<tr>
<td>24</td>
<td>Adam</td>
<td>3.5</td>
<td>0.29</td>
<td>2000</td>
</tr>
<tr>
<td>100</td>
<td>Adam</td>
<td>7.1</td>
<td>0.14</td>
<td>4000</td>
</tr>
<tr>
<td>200</td>
<td>Adam</td>
<td>10</td>
<td>0.1</td>
<td>8000</td>
</tr>
<tr>
<td>1000</td>
<td>Adam</td>
<td>22.4</td>
<td>0.045</td>
<td>16000</td>
</tr>
</tbody>
</table>
<h4 id="122">12.2 è®­ç»ƒç¨³å®šæ€§æŒ‡æ ‡</h4>
<p><strong>æ¢¯åº¦èŒƒæ•°ç›‘æ§</strong>:</p>
<p>\begin{equation}
G(l) = \left|\frac{\partial \mathcal{L}}{\partial \boldsymbol{x}_l}\right|, \quad l = 1, 2, \ldots, N
\tag{69}
\end{equation}</p>
<p>å¥åº·è®­ç»ƒåº”æ»¡è¶³ï¼š</p>
<p>\begin{equation}
0.1 \leq \frac{G(l)}{G(N)} \leq 10, \quad \forall l
\tag{70}
\end{equation}</p>
<p><strong>å‚æ•°æ›´æ–°æ¯”ä¾‹</strong>:</p>
<p>\begin{equation}
R = \frac{|\Delta \boldsymbol{\theta}|}{|\boldsymbol{\theta}|} \approx 10^{-3} \sim 10^{-2}
\tag{71}
\end{equation}</p>
<h4 id="123-1000transformer">12.3 æ•°å€¼ç¤ºä¾‹ï¼š1000å±‚Transformer</h4>
<p>é…ç½®ï¼š
- $d = 1024$, $h = 8$
- Adamä¼˜åŒ–å™¨
- $\alpha = 22.4$, $\lambda = 0.045$
- å­¦ä¹ ç‡ $10^{-4}$ (å³°å€¼)
- Warmup 16000æ­¥</p>
<p>åˆå§‹æ¢¯åº¦èŒƒæ•°ï¼ˆç¬¬1å±‚ vs ç¬¬1000å±‚ï¼‰ï¼š</p>
<p>\begin{equation}
\frac{G(1)}{G(1000)} = (1.045)^{1000} \approx 2.1
\tag{72}
\end{equation}</p>
<p>åœ¨å¯æ¥å—èŒƒå›´å†…ï¼</p>
<h3 id="_16">åä¸‰ã€æ€»ç»“</h3>
<p>æœ¬èŠ‚è¯¦ç»†æ¨å¯¼äº†æ·±å±‚Transformerè®­ç»ƒçš„æ•°å­¦åŸç†ï¼š</p>
<p><strong>æ ¸å¿ƒé—®é¢˜</strong>:
1. æ¢¯åº¦æ¶ˆå¤±/çˆ†ç‚¸: $|\nabla| \propto \gamma^N$ æˆ– $\beta^N$
2. å¢é‡çˆ†ç‚¸: $\Delta \mathcal{L} \propto \eta N$</p>
<p><strong>è§£å†³æ–¹æ¡ˆ</strong>:
1. æ®‹å·®è¿æ¥: ç¡®ä¿ $\boldsymbol{J}_l \succeq \boldsymbol{I}$
2. LayerNorm: å½’ä¸€åŒ–æ¢¯åº¦åˆ° $\mathcal{O}(1)$
3. DeepNorm: é€šè¿‡ $\alpha, \lambda$ ç¼©æ”¾æŠ‘åˆ¶å¢é‡çˆ†ç‚¸
4. Warmup: åˆæœŸå°å­¦ä¹ ç‡é€‚åº”å‚æ•°</p>
<p><strong>å…³é”®å…¬å¼</strong>:
\begin{equation}
\begin{cases}
\alpha = (2N)^{1/4}, \lambda = (2N)^{-1/4} &amp; \text{(SGD)} \
\alpha = N^{1/2}, \lambda = N^{-1/2} &amp; \text{(Adam)} \
\alpha = 1, \lambda = N^{-1/2} &amp; \text{(LAMB)}
\end{cases}
\tag{73}
\end{equation}</p>
<p>è¿™äº›ç†è®ºä¿è¯äº†1000å±‚ç”šè‡³æ›´æ·±çš„Transformerèƒ½å¤Ÿç¨³å®šè®­ç»ƒï¼Œæ‰“ç ´äº†"æµ…è€Œå®½"çš„å±€é™ã€‚</p>
        </div>
    </div>
</body>
</html>