<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éšæœºåˆ†è¯æµ…æ¢ï¼šä»Viterbi Decodingåˆ°Viterbi Sampling</title>
    <style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    line-height: 1.6; color: #333; max-width: 900px; margin: 0 auto; padding: 20px; background: #f5f5f5;
}
.container { background: white; padding: 40px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
header { border-bottom: 2px solid #e0e0e0; padding-bottom: 20px; margin-bottom: 30px; }
h1 { color: #2c3e50; margin-bottom: 10px; font-size: 2em; }
.meta { color: #666; font-size: 0.9em; margin-bottom: 20px; }
.content { margin-top: 30px; overflow-wrap: break-word; }
.content h2 { color: #34495e; margin-top: 30px; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
.content p { margin-bottom: 15px; }
.content pre { background: #f8f8f8; padding: 15px; border-radius: 5px; overflow-x: auto; border-left: 3px solid #3498db; margin: 15px 0; }
.content code { background: #f8f8f8; padding: 2px 5px; border-radius: 3px; font-family: monospace; font-size: 0.9em; }
.content blockquote { border-left: 4px solid #3498db; padding-left: 20px; margin: 20px 0; color: #555; font-style: italic; }
.content table { border-collapse: collapse; width: 100%; margin: 20px 0; }
.content th, .content td { border: 1px solid #ddd; padding: 10px; text-align: left; }
.back-link { display: inline-block; margin-bottom: 20px; color: #3498db; text-decoration: none; font-weight: 500; }
</style>
    
<script>
    window.MathJax = {
        tex: {
            inlineMath: [['$', '$'], ['\(', '\)']],
            displayMath: [['$$', '$$'], ['\[', '\]']],
            processEscapes: true
        }
    };
</script>
<script id="MathJax-script" async src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>

</head>
<body>
    <div class="container">
        <a href="../index.html" class="back-link">â† è¿”å›é¦–é¡µ</a>
        <header>
            <h1>éšæœºåˆ†è¯æµ…æ¢ï¼šä»Viterbi Decodingåˆ°Viterbi Sampling</h1>
            <div class="meta">ğŸ“… æœ€åæ›´æ–°: 2026-01-05 | ğŸ“„ å¤§å°: 53.8 KB</div>
        </header>
        <div class="content">
            <p><strong>åŸæ–‡é“¾æ¥</strong>: <a href="https://spaces.ac.cn/archives/9768">https://spaces.ac.cn/archives/9768</a></p>
<p><strong>å‘å¸ƒæ—¥æœŸ</strong>: </p>
<hr />
<p>ä¸Šä¸€ç¯‡æ–‡ç« <a href="/archives/9762">ã€Šå¤§è¯è¡¨è¯­è¨€æ¨¡å‹åœ¨ç»­å†™ä»»åŠ¡ä¸Šçš„ä¸€ä¸ªé—®é¢˜åŠå¯¹ç­–ã€‹</a>å‘å¸ƒåï¼Œå¾ˆå¿«å°±æœ‰è¯»è€…æŒ‡å‡ºå¯ä»¥åœ¨è®­ç»ƒé˜¶æ®µå¼•å…¥å¸¦æœ‰éšæœºæ€§çš„åˆ†è¯ç»“æœæ¥è§£å†³åŒæ ·çš„é—®é¢˜ï¼Œå¹¶ä¸”å·²ç»æœ‰è®ºæ–‡å’Œå®ç°ã€‚ç»è¿‡è¿›ä¸€æ­¥æŸ¥é˜…å­¦ä¹ ï¼Œç¬”è€…å‘ç°è¿™æ˜¯ä¸€ä¸ªåä¸º<a href="https://papers.cool/arxiv/1804.10959">Subword Regularization</a>çš„æŠ€å·§ï¼Œæœ€æ—©åº”ç”¨åœ¨NMTï¼ˆæœºå™¨ç¿»è¯‘ï¼‰ä¸­ï¼Œç›®å‰SentencePieceä¹Ÿæœ‰ç›¸åº”çš„å®ç°ã€‚çœ‹èµ·æ¥è¿™ä¸ªæŠ€å·§ç¡®å®èƒ½ç¼“è§£å‰è¿°é—®é¢˜ï¼Œç”šè‡³æœ‰åŠ©äºå¢å¼ºè¯­è¨€æ¨¡å‹çš„å®¹é”™èƒ½åŠ›ï¼Œæ‰€ä»¥å°±æœ‰äº†å°†å®ƒåŠ è¿›å»<a href="/archives/9752">BytePiece</a>çš„æƒ³æ³•ã€‚</p>
<p>é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œå¦‚ä½•å°†ç¡®å®šæ€§åˆ†è¯æ”¹ä¸ºéšæœºæ€§åˆ†è¯å‘¢ï¼ŸBytePieceæ˜¯åŸºäºUnigramæ¨¡å‹çš„ï¼Œå®ƒé€šè¿‡Viterbiç®—æ³•æ‰¾æœ€å¤§æ¦‚ç‡çš„åˆ†è¯æ–¹æ¡ˆï¼Œæ—¢ç„¶æœ‰æ¦‚ç‡ï¼Œæ˜¯å¦å°±å¯ä»¥è‡ªç„¶åœ°å¯¼å‡ºéšæœºé‡‡æ ·ï¼Ÿæœ¬æ–‡æ¥è®¨è®ºè¿™ä¸ªé—®é¢˜ï¼Œå¹¶åˆ†äº«è‡ªå·±çš„è§£å†³æ–¹æ¡ˆã€‚</p>
<h2 id="_1">è¦ç‚¹åˆ†æ</h2>
<p>ç°é˜¶æ®µï¼ŒUnigramåˆ†è¯æ˜¯ç›´æ¥è¾“å‡ºæœ€å¤§æ¦‚ç‡çš„åˆ‡åˆ†æ–¹æ¡ˆï¼Œé€šå¸¸è¿™æ˜¯ä¸€ä¸ªç¡®å®šæ€§çš„è¾“å‡ºã€‚å…·ä½“æ¥è¯´ï¼Œå‡è®¾$\boldsymbol{w}=(w_1,w_2,\cdots,w_k)$ä»£è¡¨ä¸€ä¸ªåˆ‡åˆ†æ–¹æ¡ˆï¼Œå¯¹åº”çš„æ‰“åˆ†ä¸º$P(\boldsymbol{w})=p(w_1)p(w_2)\cdots p(w_k)$ï¼Œ$\Omega(S)$ä»£è¡¨å¥å­$S$æ‰€æœ‰å¯èƒ½çš„åˆ‡åˆ†æ–¹æ¡ˆçš„é›†åˆï¼Œé‚£ä¹ˆåˆ†è¯ç®—æ³•å¯ä»¥æè¿°ä¸º<br />
\begin{equation}\boldsymbol{w}^* = \mathop{\text{argmax}}_{\boldsymbol{w}\in \Omega(S)}P(\boldsymbol{w})\end{equation}<br />
è¿™å¯ä»¥é€šè¿‡Viterbiç®—æ³•åœ¨çº¿æ€§æ—¶é—´å†…æ¥å®Œæˆï¼Œæ‰€ä»¥è¿™ä¸ªè¿‡ç¨‹æˆ‘ä»¬ä¹Ÿç§°ä¹‹ä¸ºâ€œViterbi Decodingâ€ã€‚çœ‹èµ·æ¥ï¼ŒUnigramæ¨¡å‹å¤©ç„¶å¸¦æœ‰æ¦‚ç‡ï¼Œæ‰€ä»¥ä¼¼ä¹å¹¶ä¸éš¾å°†å®ƒæ”¹ä¸ºä¾æ¦‚ç‡é‡‡æ ·çš„å½¢å¼ï¼Œä½†ç»†æƒ³ä¹‹ä¸‹æ‰å‘ç°è¿™å¹¶éä¸€ä¸ªå¹³å‡¡çš„é—®é¢˜ï¼Œæœ‰å¾ˆå¤šç»†èŠ‚ä¸Šçš„å›°éš¾éœ€è¦å…‹æœã€‚</p>
<p>ç¬”è€…è®¾æƒ³æ˜¯æ¨¡ä»¿è‡ªå›å½’è¯­è¨€æ¨¡å‹è®¾è®¡ä¸€ä¸ªé€’å½’é‡‡æ ·æµç¨‹ï¼Œä½†è¿™é‡Œæœ€å›°éš¾çš„åœ°æ–¹æ˜¯å¦‚ä½•å°½é‡ä¿æŒåŸæ¥çš„å€™é€‰åˆ‡åˆ†æ–¹æ¡ˆçš„æ’åºä¸å˜ï¼Œæˆ–è€…å°±ç®—ä¸èƒ½ä¿æŒæ‰€æœ‰çš„æ’åºä¸å˜ï¼Œä¹Ÿè‡³å°‘æ»¡è¶³æœ€å¤§æ¦‚ç‡ä¸å˜ï¼Œå³Viterbiè§£ç çš„æœ€å¤§æ¦‚ç‡è·¯å¾„$\boldsymbol{w}^*$åº”è¯¥å¯¹åº”æ‰€è®¾è®¡çš„é€’å½’é‡‡æ ·ç®—æ³•çš„æœ€å¤§æ¦‚ç‡é‡‡æ ·ç»“æœã€‚ç”±äºæ‰€æœ‰åˆ‡åˆ†æ–¹æ¡ˆ$\Omega(S)$æ„æˆä¸€ä¸ªæœ‰å‘æ— ç¯å›¾ï¼ˆDAGï¼ŒDirected Acyclic Graphï¼‰ï¼Œç¬”è€…ä¸€å¼€å§‹ä»¥ä¸ºç›´æ¥åœ¨æœ‰å‘æ— ç¯å›¾ä¸Šéšæœºæ¸¸èµ°æ˜¯ä¸€ä¸ªå¯è¡Œæ–¹æ¡ˆï¼Œä½†å†æ€è€ƒåå‘ç°å¾ˆéš¾è®¾è®¡é€‚å½“çš„è½¬ç§»æ¦‚ç‡æ¥ä¿è¯æœ€å¤§æ¦‚ç‡è·¯å¾„ä¸å˜ï¼ˆå› ä¸ºåŒä¸€èµ·ç‚¹çš„ä¸åŒè¾¹ä¸æ˜¯å¹³æƒçš„ï¼Œä¸èƒ½ç®€å•æŒ‰ç…§è¾¹çš„é¢‘ç‡ä¸ºæƒé‡åšé‡‡æ ·ï¼‰ã€‚</p>
<h2 id="_2">å·²æœ‰æ–¹æ¡ˆ</h2>
<p>ç”±äºä¸€æ—¶åŠä¼šæ²¡æœ‰æ–°æƒ³æ³•ï¼Œæ‰€ä»¥ç¬”è€…å†³å®šå»ç¿»ç¿»â€œå‚è€ƒç­”æ¡ˆâ€â€”â€”çœ‹çœ‹Subword Regularizationçš„åŸå§‹è®ºæ–‡<a href="https://papers.cool/arxiv/1804.10959">ã€ŠSubword Regularization: Improving Neural Network Translation Models with Multiple Subword Candidatesã€‹</a>æ˜¯æ€ä¹ˆåšçš„ã€‚</p>
<p>ç„¶è€Œï¼Œè¿™ä¸ªâ€œæ ‡å‡†ç­”æ¡ˆâ€å´è®©ç¬”è€…æœ‰ç‚¹å“­ç¬‘ä¸å¾—ã€‚åŸæ¥Subword Regularizationçš„æ€è·¯éå¸¸ç®€å•ç›´æ¥ï¼šå…ˆæœç´¢å‡º$P(\boldsymbol{w})$æœ€å¤§çš„$n$ä¸ªåˆ†è¯æ–¹æ¡ˆ$\boldsymbol{w}^<em>_1,\boldsymbol{w}^</em><em j="1">2,\cdots,\boldsymbol{w}^<em>_n$ï¼ˆ$n$-best segmentationsï¼‰ï¼Œç„¶åæ„å»ºå¦‚ä¸‹åˆ†å¸ƒ<br />
\begin{equation}p_i = \frac{P(\boldsymbol{w}^</em>_i)^{\alpha}}{\sum\limits</em>}^n P(\boldsymbol{w}^*_j)^{\alpha}}\end{equation<br />
å¯¹è¿™$n$ä¸ªæ–¹æ¡ˆè¿›è¡Œä¾æ¦‚ç‡é‡‡æ ·ï¼Œå…¶ä¸­$\alpha &gt; 0$æ˜¯ä¸€ä¸ªè¶…å‚æ•°ã€‚è¯¥ç®—æ³•å·²ç»é›†æˆåœ¨SentencePieceä¸­ï¼Œè¯»è€…å¯ä»¥è‡ªè¡Œæµ‹è¯•ï¼ˆä½¿ç”¨æ–¹æ³•å‚è€ƒ<a href="https://github.com/google/sentencepiece/tree/master#subword-regularization-and-bpe-dropout">è¿™é‡Œ</a>ï¼‰ã€‚</p>
<p>é—®é¢˜æ˜¯ï¼Œâ€œç®€å•ç›´æ¥â€ä¸ä»£è¡¨ç€â€œé«˜æ•ˆâ€ï¼Œå°½ç®¡æœç´¢top-$n$ä¸ªåˆ†è¯æ–¹æ¡ˆæœ€ä¼˜æ–¹æ¡ˆçš„å¤æ‚åº¦ä¹Ÿæ˜¯çº¿æ€§çš„ï¼ˆæœ‰å…´è¶£çš„è¯»è€…å¯ä»¥è‡ªè¡Œæ‰¾æ‰¾N-best Viterbiçš„èµ„æ–™)ï¼Œä½†æ˜æ˜¾æ¯”åªæ‰¾top1çš„Viterbi Decodingè¦å¤§å¾ˆå¤šï¼ˆç†è®ºä¸Šæ˜¯$n$å€å¤æ‚åº¦ï¼‰ï¼Œæ‰€ä»¥ç›´æ¥çš„åæœæ˜¯å¼€å¯äº†éšæœºé‡‡æ ·åï¼Œä¼šæ¯”ç¡®å®šæ€§çš„åˆ†è¯è¦æ…¢å¾ˆå¤šï¼Œæ‰€ä»¥è¿™å¹¶éæ˜¯ç¬”è€…å¿ƒä¸­çš„ç†æƒ³é‡‡æ ·æ–¹æ³•ã€‚</p>
<h2 id="_3">ä¸ªäººæ€è·¯</h2>
<p>æ€è·¯å†åº¦é™·å…¥äº†åƒµå±€ã€‚ä¸€ç­¹è«å±•ä¹‹é™…ï¼Œç¬”è€…å†³å®šæŠŠæ€è·¯å†æ‹ä¸€æ‹ï¼šæˆ‘ä»¬çš„ç›®æ ‡æ˜¯æƒ³è¦æ‰¾åˆ°å¤æ‚åº¦ç±»ä¼¼Viterbi Decodingçš„éšæœºé‡‡æ ·ç®—æ³•ï¼Œæ—¢ç„¶å¦‚æ­¤ï¼ŒViterbi Decodingæœ¬èº«åº”è¯¥æ˜¯ä¸€ä¸ªä¸é”™çš„çªç ´ç‚¹ã€‚äºæ˜¯ï¼Œç¬”è€…å†æ¬¡ç¿»å¼€äº†åˆ†è¯ä»£ç ï¼Œ<a href="https://github.com/bojone/bytepiece/blob/b65716b76938b3ac4124661a3367fc1c270373fa/bytepiece/faster.pyx">å½“æ—¶çš„åˆ†è¯å‡½æ•°</a>é•¿è¿™ä¸ªæ ·ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="s s-Atom">def</span> <span class="k">_</span><span class="nf">tokenize</span><span class="p">(</span><span class="s s-Atom">self</span><span class="p">,</span> <span class="s s-Atom">bytes</span> <span class="s s-Atom">text</span><span class="p">)</span><span class="o">:</span>
    <span class="s s-Atom">cdef</span> <span class="s s-Atom">int</span> <span class="s s-Atom">e</span><span class="p">,</span> <span class="s s-Atom">k</span><span class="p">,</span> <span class="s s-Atom">s</span>
    <span class="s s-Atom">cdef</span> <span class="s s-Atom">double</span> <span class="s s-Atom">v</span><span class="p">,</span> <span class="s s-Atom">score</span>
    <span class="s s-Atom">cdef</span> <span class="s s-Atom">list</span> <span class="s s-Atom">routes</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="nv">None</span><span class="p">)]</span> <span class="o">+</span> <span class="p">[(</span><span class="o">-</span><span class="nv">INFINITY</span><span class="p">,</span> <span class="nv">None</span><span class="p">)</span> <span class="s s-Atom">for</span> <span class="k">_</span> <span class="s s-Atom">in</span> <span class="s s-Atom">text</span><span class="p">]</span>
    <span class="s s-Atom">cdef</span> <span class="s s-Atom">list</span> <span class="s s-Atom">tokens</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="s s-Atom">for</span> <span class="s s-Atom">e</span><span class="p">,</span> <span class="p">(</span><span class="s s-Atom">k</span><span class="p">,</span> <span class="s s-Atom">v</span><span class="p">)</span> <span class="s s-Atom">in</span> <span class="s s-Atom">self</span><span class="p">.</span><span class="k">_</span><span class="s s-Atom">automaton</span><span class="p">.</span><span class="nf">iter</span><span class="p">(</span><span class="s s-Atom">text</span><span class="p">)</span><span class="o">:</span>
        <span class="s s-Atom">s</span><span class="p">,</span> <span class="s s-Atom">e</span> <span class="o">=</span> <span class="s s-Atom">e</span> <span class="o">-</span> <span class="s s-Atom">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="s s-Atom">e</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="s s-Atom">score</span> <span class="o">=</span> <span class="s s-Atom">routes</span><span class="p">[</span><span class="s s-Atom">s</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s s-Atom">v</span>
        <span class="s s-Atom">if</span> <span class="s s-Atom">score</span> <span class="o">&gt;</span> <span class="s s-Atom">routes</span><span class="p">[</span><span class="s s-Atom">e</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">:</span>
            <span class="s s-Atom">routes</span><span class="p">[</span><span class="s s-Atom">e</span><span class="p">]</span> <span class="o">=</span> <span class="s s-Atom">score</span><span class="p">,</span> <span class="s s-Atom">s</span>
    <span class="s s-Atom">while</span> <span class="s s-Atom">text</span><span class="p">:</span>
        <span class="s s-Atom">s</span> <span class="o">=</span> <span class="s s-Atom">routes</span><span class="p">[</span><span class="s s-Atom">e</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="s s-Atom">tokens</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="s s-Atom">text</span><span class="p">[</span><span class="s s-Atom">s</span><span class="p">:</span><span class="s s-Atom">e</span><span class="p">])</span>
        <span class="s s-Atom">text</span><span class="p">,</span> <span class="s s-Atom">e</span> <span class="o">=</span> <span class="s s-Atom">text</span><span class="p">[</span><span class="o">:</span><span class="s s-Atom">s</span><span class="p">],</span> <span class="s s-Atom">s</span>
    <span class="s s-Atom">return</span> <span class="s s-Atom">tokens</span><span class="p">[</span><span class="o">::-</span><span class="mi">1</span><span class="p">]</span>
</code></pre></div>

<p>åå¤è¯»äº†å‡ éï¼Œæ€»ç®—æœ‰äº†çµæ„Ÿï¼šViterbi Decodingçš„å…³é”®æ˜¯<code>if score &gt; routes[e][0]:</code>è¿™ä¸€å¥ï¼Œå®ƒä»£è¡¨ä¿ç•™æˆªæ­¢åˆ°å½“å‰ä½ç½®çš„æœ€ä¼˜åˆ‡åˆ†æ–¹æ¡ˆï¼Œå…¶ä¸­<code>score</code>æ˜¯æ–°åˆ‡åˆ†æ–¹æ¡ˆåˆ†æ•°ï¼ˆæ¦‚ç‡å¯¹æ•°ï¼‰ï¼Œ<code>routes[e][0]</code>æ˜¯å†å²æœ€ä¼˜åˆ†æ•°ï¼Œå¦‚æœæ–°æ–¹æ¡ˆæ›´ä¼˜åˆ™è¦†ç›–ã€‚è¿™è®©ç¬”è€…è”æƒ³åˆ°äº†<a href="/archives/8084">MCMCç®—æ³•</a>çš„æ¥å—ç‡è®¾è®¡ï¼Œå¦‚æœåœ¨è¿™é‡Œå¼•å…¥éšæœºé‡‡æ ·ï¼Œä¸å°±å¯ä»¥å°†åˆ†è¯ç»“æœéšæœºåŒ–äº†ï¼Ÿ</p>
<p>æˆ‘ä»¬ç”¨$r\in \{1, 0\}$è¡¨ç¤ºæ¥å—/æ‹’ç»æ–°æ–¹æ¡ˆï¼Œç”±äºè¿™ä¸€æ­¥åªæ˜¯ä¸€ä¸ªäºŒå…ƒé€‰æ‹©ï¼Œæ‰€ä»¥å°†å®ƒæ¦‚ç‡åŒ–ä¹Ÿéå¸¸ç®€å•ï¼š<br />
\begin{equation}<br />
r_i = \left\{\begin{aligned}&amp;\,1\,, \,\, s_i &gt; s_{i-1} \\\<br />
&amp;\,0\,, \,\, \text{else}\end{aligned}\right.\qquad\longrightarrow\qquad<br />
r_i = \left\{\begin{aligned}&amp;\,1\,, \,\, \varepsilon &lt; \sigma(\alpha(s_i - s_{i-1})) \\\<br />
&amp;\,0\,, \,\, \text{else}\end{aligned}\right.<br />
\end{equation}<br />
è¿™é‡Œ$\varepsilon\sim U[0,1]$æ˜¯å‡åŒ€éšæœºæ•°ï¼Œ$\alpha &gt; 0$æ˜¯è¶…å‚æ•°ï¼Œ$\sigma(t)=1/(1+e^{-t})$æ˜¯Sigmoidå‡½æ•°ï¼Œ$s_i,s_{i-1}$åˆ†åˆ«æ˜¯æ–°æ—§æ–¹æ¡ˆçš„å¾—åˆ†ï¼ˆæ¦‚ç‡å¯¹æ•°ï¼‰ã€‚ä¸éš¾å‘ç°ï¼Œå·¦ç«¯çš„ç¡®å®šæ€§é‡‡æ ·å¯¹åº”$\alpha\to\infty$çš„éšæœºæ€§é‡‡æ ·ã€‚</p>
<p>è¿™æ ·ï¼Œåœ¨Viterbiè§£ç çš„åŸºç¡€ä¸Šæˆ‘ä»¬å¾—åˆ°äº†ä¸€ä¸ªéå¸¸è‡ªç„¶ã€éå¸¸è½»é‡çº§çš„éšæœºé‡‡æ ·ç®—æ³•ï¼Œè¿™é‡Œç§°ä¹‹ä¸ºâ€œViterbi Samplingâ€ï¼Œå®ç°å®ƒåªéœ€è¦å°†<code>if score &gt; routes[e][0]:</code>è¿™ä¸€åˆ¤æ®æ¢æˆå¸¦éšæœºæ•°çš„ç‰ˆæœ¬ã€‚ç”±äºSigmoidå‡½æ•°çš„å•è°ƒæ€§ï¼Œå½“$s_i &gt; s_{i-1}$æ—¶ï¼Œå®ƒè‡ªç„¶ä¼šç»™æ–°æ–¹æ¡ˆåˆ†é…æ›´å¤§çš„æ¦‚ç‡ï¼Œæ‰€ä»¥å¾ˆæ˜æ˜¾åŸæ¥çš„çš„æœ€å¤§æ¦‚ç‡åˆ‡åˆ†åœ¨Viterbi Samplingä¹‹ä¸‹ä¹Ÿæ˜¯æœ€å¤§æ¦‚ç‡ç»“æœï¼Œå¹¶ä¸”å½“$s_i - s_{i-1}$è¶Šå¤§ï¼Œ$\sigma(\alpha(s_i - s_{i-1}))$ä¹Ÿè¶Šå¤§ï¼Œè¿™æ„å‘³ç€åŸæœ¬å¾—åˆ†è¶Šå¤§çš„æ–¹æ¡ˆè¢«é‡‡æ ·åˆ°çš„æ¦‚ç‡ä¹Ÿè¶Šé«˜ï¼Œä¸€å®šç¨‹åº¦ä¸Šä¿æŒäº†åˆ‡åˆ†æ–¹æ¡ˆçš„æ’åºä¸å˜ï¼ˆå°½ç®¡è¿˜æ²¡æœ‰è¯æ˜ä¸€å®šä¸¥æ ¼ä¿åºï¼Œä½†ä»åº”ç”¨è§’åº¦çœ‹ï¼Œè¿‘ä¼¼ä¿åºå°±å¤Ÿäº†ï¼‰ã€‚</p>
<h2 id="_4">ç®€å•æµ‹è¯•</h2>
<p>ä»0.4.0ç‰ˆæœ¬å¼€å§‹ï¼ŒViterbi Samplingå°±å†…ç½®åœ¨BytePieceçš„åˆ†è¯å‡½æ•°ä¸­ï¼Œåªéœ€è¦åœ¨<code>tokenizer.tokenize</code>æˆ–è€…<code>tokenizer.encode</code>æ—¶åŠ å…¥å¤§äº0çš„alphaå‚æ•°ï¼Œç»“æœå°±æ˜¯éšæœºçš„ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">bytepiece</span>
<span class="k">assert</span> <span class="n">bytepiece</span><span class="o">.</span><span class="n">__version__</span> <span class="o">&gt;=</span> <span class="s1">&#39;0.4.0&#39;</span>

<span class="n">tokenizer</span> <span class="o">=</span> <span class="n">bytepiece</span><span class="o">.</span><span class="n">Tokenizer</span><span class="p">(</span><span class="s1">&#39;bytepiece_160k.model&#39;</span><span class="p">)</span>
<span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;ä»Šå¤©å¤©æ°”ä¸é”™&#39;</span>
<span class="nb">print</span><span class="p">(</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">tokenize</span><span class="p">(</span><span class="n">text</span><span class="p">))</span>  <span class="c1"># alphaé»˜è®¤å€¼ä¸º-1ï¼Œalphaâ‰¤0 éƒ½ä»£è¡¨ç¡®å®šæ€§åˆ†è¯</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">tokenize</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">))</span>

<span class="c1"># [b&#39;\xe4\xbb\x8a\xe5\xa4\xa9&#39;, b&#39;\xe5\xa4\xa9\xe6\xb0\x94&#39;, b&#39;\xe4\xb8\x8d\xe9\x94\x99&#39;]</span>
<span class="c1"># [b&#39;\xe4\xbb\x8a\xe5\xa4\xa9&#39;, b&#39;\xe5\xa4\xa9\xe6&#39;, b&#39;\xb0\x94&#39;, b&#39;\xe4\xb8\x8d\xe9\x94\x99&#39;]</span>
<span class="c1"># [b&#39;\xe4\xbb\x8a\xe5\xa4\xa9&#39;, b&#39;\xe5\xa4\xa9\xe6\xb0\x94&#39;, b&#39;\xe4\xb8\x8d\xe9\x94\x99&#39;]</span>
<span class="c1"># [b&#39;\xe4\xbb\x8a\xe5\xa4\xa9&#39;, b&#39;\xe5\xa4\xa9\xe6\xb0\x94&#39;, b&#39;\xe4\xb8&#39;, b&#39;\x8d&#39;, b&#39;\xe9\x94&#39;, b&#39;\x99&#39;]</span>
<span class="c1"># [b&#39;\xe4\xbb\x8a\xe5\xa4\xa9&#39;, b&#39;\xe5\xa4\xa9&#39;, b&#39;\xe6\xb0\x94&#39;, b&#39;\xe4\xb8\x8d\xe9\x94\x99&#39;]</span>
<span class="c1"># [b&#39;\xe4\xbb&#39;, b&#39;\x8a\xe5\xa4\xa9&#39;, b&#39;\xe5\xa4\xa9&#39;, b&#39;\xe6\xb0\x94\xe4\xb8\x8d&#39;, b&#39;\xe9\x94&#39;, b&#39;\x99&#39;]</span>
</code></pre></div>

<p>ä¸‹é¢å¯¹æ¯”ä¸€ä¸‹SentencePieceçš„Subword Regularizationå’ŒBytePieceçš„Viterbi Samplingçš„é€Ÿåº¦ï¼ˆéšæœºæ€§åˆ†è¯æ—¶éƒ½è®¾$\alpha=0.1$ï¼‰ï¼š<br />
\begin{array}{c|cc}<br />
\hline<br />
&amp; \text{ç¡®å®šæ€§åˆ†è¯} &amp; \text{éšæœºæ€§åˆ†è¯} &amp; \\\<br />
\hline<br />
\text{SP-BPE} &amp; \text{1.36M bytes/sec} &amp; \text{1.25M bytes/sec} \\\<br />
\text{SP-Unigram} &amp; \text{5.65M bytes/sec} &amp; \text{1.28M bytes/sec} \\\<br />
\text{BytePiece} &amp; \text{1.95M bytes/sec} &amp; \text{1.36M bytes/sec}\\\<br />
\hline<br />
\end{array}<br />
å¯ä»¥çœ‹åˆ°ï¼ŒSubword Regularizationï¼ˆâ€œSP-Unigramâ€è¿™ä¸€è¡Œï¼‰å¼€å¯ä¹‹åï¼Œåˆ†è¯é€Ÿåº¦ä¸åˆ°åŸæ¥çš„1/4ï¼Œè¿™è¡¨æ˜Subword Regularizationçš„é‡‡æ ·ç®—æ³•æ˜¯ç›¸å½“ä½æ•ˆçš„ã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼Œæœ¬æ–‡æå‡ºçš„Viterbi Samplingåªä¸‹é™äº†30%å·¦å³ï¼Œæ•ˆç‡æ˜¾ç„¶æ›´é«˜ï¼Œä¸‹é™çš„éƒ¨åˆ†åœ¨äºéšæœºæ•°çš„ç”Ÿæˆå’ŒSigmoidå‡½æ•°çš„è®¡ç®—ï¼Œå¦‚æœèƒ½è¿›ä¸€æ­¥ä¼˜åŒ–è¿™ä¸¤éƒ¨åˆ†ï¼Œé€Ÿåº¦è¿˜èƒ½è¿›ä¸€æ­¥æå‡ã€‚è‡³äºBPEæ¨¡å‹ï¼Œå®ƒçš„éšæœºåˆ†è¯å«åš<a href="https://papers.cool/arxiv/1910.13267">BPE Dropout</a>ï¼Œè¿™æ˜¯ä¸“å±äºBPEæ¨¡å‹çš„æ–¹æ³•ï¼Œæœ‰å…´è¶£çš„è¯»è€…è‡ªè¡Œäº†è§£ï¼Œè¿™é‡Œå°±ä¸ä»‹ç»äº†ã€‚</p>
<h2 id="_5">æ–‡ç« å°ç»“</h2>
<p>æœ¬æ–‡ä¸»è¦æ¢è®¨äº†å°†Unigramåˆ†è¯æ¨¡å‹çš„ç¡®å®šæ€§åˆ†è¯æ”¹ä¸ºéšæœºæ€§åˆ†è¯çš„ç­–ç•¥ã€‚å°½ç®¡å·²æœ‰åä¸ºâ€œSubword Regularizationâ€çš„æ–¹æ³•å¯ä»¥å®ç°è¿™ä¸€ç›®æ ‡ï¼Œä½†å…¶æ•ˆç‡ç›¸å¯¹è¾ƒä½ã€‚ä¸ºæ­¤ï¼Œç¬”è€…æå‡ºäº†ä¸€ç§æ›´é«˜æ•ˆçš„é‡‡æ ·ç®—æ³•Viterbi Samplingï¼Œå®ƒä»…éœ€å¯¹ç¡®å®šæ€§çš„Viterbi Decodingè¿›è¡Œç®€å•çš„ä¿®æ”¹ï¼Œä»è€ŒåŸºæœ¬ä¿æŒäº†åŸæœ‰çš„æ•ˆç‡ã€‚å®éªŒè¯æ˜ï¼Œæ–°çš„ç®—æ³•é‡‡æ ·é€Ÿåº¦æ˜æ˜¾è¶…è¶Šäº†Subword Regularizationã€‚ç›¸åº”çš„å®ç°å·²ç»å†…ç½®åœ¨BytePieceæœ€æ–°ç‰ˆä¸­ã€‚</p>
<p><em><strong>è½¬è½½åˆ°è¯·åŒ…æ‹¬æœ¬æ–‡åœ°å€ï¼š</strong><a href="https://spaces.ac.cn/archives/9768">https://spaces.ac.cn/archives/9768</a></em></p>
<p><em><strong>æ›´è¯¦ç»†çš„è½¬è½½äº‹å®œè¯·å‚è€ƒï¼š</strong></em><a href="https://spaces.ac.cn/archives/6508#%E6%96%87%E7%AB%A0%E5%A6%82%E4%BD%95%E8%BD%AC%E8%BD%BD/%E5%BC%95%E7%94%A8" title="ã€Šç§‘å­¦ç©ºé—´FAQã€‹">ã€Šç§‘å­¦ç©ºé—´FAQã€‹</a></p>
<p><strong>å¦‚æœæ‚¨è¿˜æœ‰ä»€ä¹ˆç–‘æƒ‘æˆ–å»ºè®®ï¼Œæ¬¢è¿åœ¨ä¸‹æ–¹è¯„è®ºåŒºç»§ç»­è®¨è®ºã€‚</strong></p>
<p><strong>å¦‚æœæ‚¨è§‰å¾—æœ¬æ–‡è¿˜ä¸é”™ï¼Œæ¬¢è¿åˆ†äº«/æ‰“èµæœ¬æ–‡ã€‚æ‰“èµå¹¶éè¦ä»ä¸­è·å¾—æ”¶ç›Šï¼Œè€Œæ˜¯å¸Œæœ›çŸ¥é“ç§‘å­¦ç©ºé—´è·å¾—äº†å¤šå°‘è¯»è€…çš„çœŸå¿ƒå…³æ³¨ã€‚å½“ç„¶ï¼Œå¦‚æœä½ æ— è§†å®ƒï¼Œä¹Ÿä¸ä¼šå½±å“ä½ çš„é˜…è¯»ã€‚å†æ¬¡è¡¨ç¤ºæ¬¢è¿å’Œæ„Ÿè°¢ï¼</strong></p>
<p>æ‰“èµ</p>
<p><img alt="ç§‘å­¦ç©ºé—´" src="https://spaces.ac.cn/usr/themes/geekg/payment/wx.png" /></p>
<p>å¾®ä¿¡æ‰“èµ</p>
<p><img alt="ç§‘å­¦ç©ºé—´" src="https://spaces.ac.cn/usr/themes/geekg/payment/zfb.png" /></p>
<p>æ”¯ä»˜å®æ‰“èµ</p>
<p>å› ä¸ºç½‘ç«™åå°å¯¹æ‰“èµå¹¶æ— è®°å½•ï¼Œå› æ­¤æ¬¢è¿åœ¨æ‰“èµæ—¶å€™å¤‡æ³¨ç•™è¨€ã€‚ä½ è¿˜å¯ä»¥<a href="http://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&amp;email=tN7d1drY3drrx8H0xcWa19vZ"><strong>ç‚¹å‡»è¿™é‡Œ</strong></a>æˆ–åœ¨ä¸‹æ–¹è¯„è®ºåŒºç•™è¨€æ¥å‘ŠçŸ¥ä½ çš„å»ºè®®æˆ–éœ€æ±‚ã€‚</p>
<p><strong>å¦‚æœæ‚¨éœ€è¦å¼•ç”¨æœ¬æ–‡ï¼Œè¯·å‚è€ƒï¼š</strong></p>
<p>è‹å‰‘æ—. (Sep. 16, 2023). ã€Šéšæœºåˆ†è¯æµ…æ¢ï¼šä»Viterbi Decodingåˆ°Viterbi Sampling ã€‹[Blog post]. Retrieved from <a href="https://spaces.ac.cn/archives/9768">https://spaces.ac.cn/archives/9768</a></p>
<p>@online{kexuefm-9768,<br />
title={éšæœºåˆ†è¯æµ…æ¢ï¼šä»Viterbi Decodingåˆ°Viterbi Sampling},<br />
author={è‹å‰‘æ—},<br />
year={2023},<br />
month={Sep},<br />
url={\url{https://spaces.ac.cn/archives/9768}},<br />
} </p>
<hr />
<h2 id="_6">å®Œæ•´æ•°å­¦æ¨å¯¼ä¸ç†è®ºåˆ†æ</h2>
<p>æœ¬èŠ‚å°†è¯¦ç»†æ¨å¯¼Viterbiç®—æ³•çš„æ•°å­¦åŸºç¡€ï¼ŒåŒ…æ‹¬HMMæ¨¡å‹ã€åŠ¨æ€è§„åˆ’ã€å‰å‘åå‘ç®—æ³•ï¼Œä»¥åŠViterbi Samplingçš„å®Œæ•´ç†è®ºã€‚</p>
<h3 id="hmm">ä¸€ã€éšé©¬å°”å¯å¤«æ¨¡å‹(HMM)åŸºç¡€</h3>
<h4 id="11-hmm">1.1 HMMçš„ä¸‰è¦ç´ </h4>
<p><strong>å®šä¹‰</strong>ï¼šéšé©¬å°”å¯å¤«æ¨¡å‹æ˜¯å…³äºæ—¶åºçš„æ¦‚ç‡æ¨¡å‹ï¼Œæè¿°ä¸€ä¸ªéšè—çš„é©¬å°”å¯å¤«é“¾éšæœºç”Ÿæˆä¸å¯è§‚æµ‹çš„çŠ¶æ€åºåˆ—ï¼Œå†ç”±å„ä¸ªçŠ¶æ€ç”Ÿæˆè§‚æµ‹åºåˆ—çš„è¿‡ç¨‹ã€‚</p>
<div class="definition-box">

**HMMçš„ä¸‰è¦ç´ **ï¼š

è®¾çŠ¶æ€é›†åˆ$\mathcal{S} = \{s_1, s_2, \ldots, s_N\}$ï¼Œè§‚æµ‹é›†åˆ$\mathcal{O} = \{o_1, o_2, \ldots, o_M\}$ã€‚

1. **åˆå§‹çŠ¶æ€æ¦‚ç‡**ï¼š$\boldsymbol{\pi} = (\pi_1, \ldots, \pi_N)$
   \begin{equation}
   \pi_i = P(q_1 = s_i), \quad \sum_{i=1}^{N} \pi_i = 1 \tag{1}
   \end{equation}

2. **çŠ¶æ€è½¬ç§»æ¦‚ç‡**ï¼š$\mathbf{A} = (a_{ij})_{N \times N}$
   \begin{equation}
   a_{ij} = P(q_{t+1} = s_j | q_t = s_i), \quad \sum_{j=1}^{N} a_{ij} = 1 \tag{2}
   \end{equation}

3. **å‘å°„æ¦‚ç‡ï¼ˆè§‚æµ‹æ¦‚ç‡ï¼‰**ï¼š$\mathbf{B} = (b_j(o_k))$
   \begin{equation}
   b_j(o_k) = P(x_t = o_k | q_t = s_j), \quad \sum_{k=1}^{M} b_j(o_k) = 1 \tag{3}
   \end{equation}

HMMè®°ä¸º$\lambda = (\mathbf{A}, \mathbf{B}, \boldsymbol{\pi})$ã€‚

</div>

<p><strong>é©¬å°”å¯å¤«æ€§å‡è®¾</strong>ï¼š</p>
<ol>
<li>
<p><strong>é½æ¬¡é©¬å°”å¯å¤«å‡è®¾</strong>ï¼šçŠ¶æ€è½¬ç§»æ¦‚ç‡ä¸æ—¶é—´æ— å…³
   \begin{equation}
   P(q_t | q_{t-1}, \ldots, q_1) = P(q_t | q_{t-1}) \tag{4}
   \end{equation}</p>
</li>
<li>
<p><strong>è§‚æµ‹ç‹¬ç«‹æ€§å‡è®¾</strong>ï¼šè§‚æµ‹åªä¾èµ–äºå½“å‰çŠ¶æ€
   \begin{equation}
   P(x_t | q_1, \ldots, q_T, x_1, \ldots, x_{t-1}, x_{t+1}, \ldots, x_T) = P(x_t | q_t) \tag{5}
   \end{equation}</p>
</li>
</ol>
<h4 id="12-hmmunigram">1.2 HMMçš„åº”ç”¨ï¼šUnigramåˆ†è¯</h4>
<p>åœ¨Unigramåˆ†è¯ä¸­ï¼ŒHMMçš„å¯¹åº”å…³ç³»ï¼š</p>
<ul>
<li><strong>è§‚æµ‹åºåˆ—</strong>ï¼šåŸå§‹æ–‡æœ¬ï¼ˆå­—èŠ‚åºåˆ—ï¼‰$\boldsymbol{c} = (c_1, c_2, \ldots, c_L)$</li>
<li><strong>çŠ¶æ€åºåˆ—</strong>ï¼šåˆ‡åˆ†æ–¹æ¡ˆï¼ˆè¯åºåˆ—ï¼‰$\boldsymbol{w} = (w_1, w_2, \ldots, w_K)$</li>
<li><strong>çŠ¶æ€è½¬ç§»</strong>ï¼šä»ä¸€ä¸ªè¯åˆ°ä¸‹ä¸€ä¸ªè¯ï¼ˆå®é™…ä¸Šæ˜¯ç‹¬ç«‹çš„ï¼Œ$a_{ij} = 1$ï¼‰</li>
<li><strong>å‘å°„æ¦‚ç‡</strong>ï¼šè¯çš„æ¦‚ç‡$P(w_i)$</li>
</ul>
<p><strong>ç®€åŒ–çš„Unigramæ¨¡å‹</strong>ï¼š</p>
<p>ç”±äºå‡è®¾è¯ä¹‹é—´ç‹¬ç«‹ï¼ˆunigramï¼‰ï¼Œä¸å­˜åœ¨çœŸæ­£çš„çŠ¶æ€è½¬ç§»ï¼Œåªæœ‰å‘å°„æ¦‚ç‡ï¼š
\begin{equation}
P(\boldsymbol{w}) = \prod_{i=1}^{K} P(w_i) \tag{6}
\end{equation}</p>
<p><strong>åˆ†è¯é—®é¢˜çš„å½¢å¼åŒ–</strong>ï¼š</p>
<p>ç»™å®šå­—èŠ‚åºåˆ—$\boldsymbol{c} = c_1c_2\cdots c_L$ï¼Œæ‰¾åˆ°æ¦‚ç‡æœ€å¤§çš„åˆ‡åˆ†æ–¹æ¡ˆï¼š
\begin{equation}
\boldsymbol{w}^* = \arg\max_{\boldsymbol{w} \in \Omega(\boldsymbol{c})} P(\boldsymbol{w}) \tag{7}
\end{equation}</p>
<p>å…¶ä¸­$\Omega(\boldsymbol{c})$æ˜¯æ‰€æœ‰èƒ½å¤Ÿå®Œæ•´è¦†ç›–$\boldsymbol{c}$çš„åˆ‡åˆ†æ–¹æ¡ˆçš„é›†åˆã€‚</p>
<h3 id="viterbi">äºŒã€Viterbiç®—æ³•ï¼šåŠ¨æ€è§„åˆ’è§£ç </h3>
<h4 id="21">2.1 é—®é¢˜è®¾å®š</h4>
<p><strong>ç›®æ ‡</strong>ï¼šç»™å®šè§‚æµ‹åºåˆ—$\boldsymbol{x} = (x_1, \ldots, x_T)$å’ŒHMMå‚æ•°$\lambda$ï¼Œæ‰¾åˆ°æœ€å¯èƒ½çš„çŠ¶æ€åºåˆ—ï¼š
\begin{equation}
\boldsymbol{q}^* = \arg\max_{\boldsymbol{q}} P(\boldsymbol{q} | \boldsymbol{x}, \lambda) = \arg\max_{\boldsymbol{q}} P(\boldsymbol{q}, \boldsymbol{x} | \lambda) \tag{8}
\end{equation}</p>
<p><strong>æœ´ç´ æ–¹æ³•çš„é—®é¢˜</strong>ï¼š</p>
<p>éå†æ‰€æœ‰å¯èƒ½çš„çŠ¶æ€åºåˆ—ï¼Œå…±$N^T$ç§ï¼Œå¤æ‚åº¦æŒ‡æ•°çº§ï¼</p>
<h4 id="22">2.2 åŠ¨æ€è§„åˆ’çš„æ€æƒ³</h4>
<p><strong>å…³é”®è§‚å¯Ÿ</strong>ï¼šæœ€ä¼˜è·¯å¾„çš„ä»»ä½•å­è·¯å¾„ä¹Ÿæ˜¯æœ€ä¼˜çš„ï¼ˆæœ€ä¼˜å­ç»“æ„æ€§è´¨ï¼‰ã€‚</p>
<p>å®šä¹‰å˜é‡$\delta_t(i)$ï¼š
\begin{equation}
\delta_t(i) = \max_{q_1, \ldots, q_{t-1}} P(q_1, \ldots, q_{t-1}, q_t = s_i, x_1, \ldots, x_t | \lambda) \tag{9}
\end{equation}</p>
<p><strong>å«ä¹‰</strong>ï¼šåˆ°æ—¶åˆ»$t$ï¼Œä»¥çŠ¶æ€$s_i$ç»“å°¾ï¼Œè§‚æµ‹åºåˆ—ä¸º$x_1, \ldots, x_t$çš„æ‰€æœ‰è·¯å¾„ä¸­ï¼Œæ¦‚ç‡æœ€å¤§çš„è·¯å¾„çš„æ¦‚ç‡ã€‚</p>
<h4 id="23-viterbi">2.3 Viterbié€’æ¨å…¬å¼</h4>
<p><strong>åˆå§‹åŒ–</strong>ï¼ˆ$t = 1$ï¼‰ï¼š
\begin{equation}
\delta_1(i) = \pi_i \cdot b_i(x_1), \quad i = 1, \ldots, N \tag{10}
\end{equation}
\begin{equation}
\psi_1(i) = 0 \tag{11}
\end{equation}</p>
<p><strong>é€’æ¨</strong>ï¼ˆ$t = 2, \ldots, T$ï¼‰ï¼š
\begin{equation}
\delta_t(j) = \max_{1 \leq i \leq N} [\delta_{t-1}(i) \cdot a_{ij}] \cdot b_j(x_t) \tag{12}
\end{equation}
\begin{equation}
\psi_t(j) = \arg\max_{1 \leq i \leq N} [\delta_{t-1}(i) \cdot a_{ij}] \tag{13}
\end{equation}</p>
<p>å…¶ä¸­$\psi_t(j)$è®°å½•äº†åˆ°è¾¾çŠ¶æ€$j$çš„æœ€ä¼˜å‰é©±çŠ¶æ€ã€‚</p>
<p><strong>è¯æ˜é€’æ¨å…¬å¼çš„æ­£ç¡®æ€§</strong>ï¼š</p>
<p>\begin{equation}
\begin{aligned}
\delta_t(j) &amp;= \max_{q_1, \ldots, q_{t-1}} P(q_1, \ldots, q_{t-1}, q_t = s_j, x_1, \ldots, x_t | \lambda) \
&amp;= \max_{q_1, \ldots, q_{t-1}} P(q_1, \ldots, q_{t-1}, x_1, \ldots, x_{t-1} | \lambda) \
&amp;\quad \times P(q_t = s_j | q_{t-1}) \times P(x_t | q_t = s_j) \
&amp;= \max_{1 \leq i \leq N} \left[ \max_{q_1, \ldots, q_{t-2}} P(q_1, \ldots, q_{t-2}, q_{t-1} = s_i, x_1, \ldots, x_{t-1}) \right] \
&amp;\quad \times a_{ij} \times b_j(x_t) \
&amp;= \max_{1 \leq i \leq N} [\delta_{t-1}(i) \cdot a_{ij}] \cdot b_j(x_t)
\end{aligned} \tag{14}
\end{equation}</p>
<p><strong>ç»ˆæ­¢</strong>ï¼š
\begin{equation}
P^<em> = \max_{1 \leq i \leq N} \delta_T(i) \tag{15}
\end{equation}
\begin{equation}
q_T^</em> = \arg\max_{1 \leq i \leq N} \delta_T(i) \tag{16}
\end{equation}</p>
<p><strong>å›æº¯</strong>ï¼ˆ$t = T-1, T-2, \ldots, 1$ï¼‰ï¼š
\begin{equation}
q_t^<em> = \psi_{t+1}(q_{t+1}^</em>) \tag{17}
\end{equation}</p>
<h4 id="24-viterbi">2.4 å¯¹æ•°ç©ºé—´çš„Viterbiç®—æ³•</h4>
<p><strong>æ•°å€¼ç¨³å®šæ€§é—®é¢˜</strong>ï¼šè¿ä¹˜å¾ˆå¤šå°æ¦‚ç‡ä¼šå¯¼è‡´ä¸‹æº¢ã€‚</p>
<p><strong>è§£å†³æ–¹æ³•</strong>ï¼šåœ¨å¯¹æ•°ç©ºé—´è¿›è¡Œè®¡ç®—ã€‚</p>
<p>å®šä¹‰ï¼š
\begin{equation}
\tilde{\delta}_t(i) = \log \delta_t(i) \tag{18}
\end{equation}</p>
<p>é€’æ¨å…¬å¼å˜ä¸ºï¼š
\begin{equation}
\tilde{\delta}<em 1="1" N="N" _leq="\leq" i="i">t(j) = \max</em>} [\tilde{\delta<em ij="ij">{t-1}(i) + \log a</em>
\end{equation}}] + \log b_j(x_t) \tag{19</p>
<p><strong>å…³é”®å˜åŒ–</strong>ï¼š
- ä¹˜æ³• â†’ åŠ æ³•
- $\max$æ“ä½œä¿æŒä¸å˜</p>
<h3 id="unigramviterbi">ä¸‰ã€åº”ç”¨äºUnigramåˆ†è¯çš„Viterbiç®—æ³•</h3>
<h4 id="31-dag">3.1 åˆ†è¯çš„DAGè¡¨ç¤º</h4>
<p>ç»™å®šå­—èŠ‚åºåˆ—$\boldsymbol{c} = c_1c_2\cdots c_L$å’Œè¯è¡¨$\mathcal{V}$ã€‚</p>
<p><strong>æ„å»ºDAGï¼ˆæœ‰å‘æ— ç¯å›¾ï¼‰</strong>ï¼š
- <strong>èŠ‚ç‚¹</strong>ï¼šä½ç½®$0, 1, 2, \ldots, L$
- <strong>è¾¹</strong>ï¼šå¦‚æœ$\overline{c_i c_{i+1} \cdots c_j} \in \mathcal{V}$ï¼Œåˆ™å­˜åœ¨è¾¹$(i-1) \to j$
- <strong>è¾¹æƒ</strong>ï¼š$\log P(\overline{c_i \cdots c_j})$</p>
<p><strong>æœ€ä¼˜è·¯å¾„</strong>ï¼šä»èŠ‚ç‚¹0åˆ°èŠ‚ç‚¹$L$çš„æœ€å¤§æƒé‡è·¯å¾„ã€‚</p>
<h4 id="32-viterbiforward-dp">3.2 å‰å‘Viterbiç®—æ³•ï¼ˆForward DPï¼‰</h4>
<p>å®šä¹‰$S^*(i)$ï¼šä»ä½ç½®0åˆ°ä½ç½®$i$çš„æœ€ä¼˜è·¯å¾„å¾—åˆ†ã€‚</p>
<p><strong>åˆå§‹åŒ–</strong>ï¼š
\begin{equation}
S^*(0) = 0 \tag{20}
\end{equation}</p>
<p><strong>é€’æ¨</strong>ï¼ˆ$i = 1, 2, \ldots, L$ï¼‰ï¼š
\begin{equation}
S^<em>(i) = \max_{j &lt; i, \overline{c_{j+1}\cdots c_i} \in \mathcal{V}} [S^</em>(j) + \log P(\overline{c_{j+1}\cdots c_i})] \tag{21}
\end{equation}</p>
<p>åŒæ—¶è®°å½•å‰é©±ï¼š
\begin{equation}
\text{prev}(i) = \arg\max_{j &lt; i, \overline{c_{j+1}\cdots c_i} \in \mathcal{V}} [S^*(j) + \log P(\overline{c_{j+1}\cdots c_i})] \tag{22}
\end{equation}</p>
<p><strong>å›æº¯</strong>ï¼š
\begin{equation}
i \gets L; \quad \text{tokens} = [] \
\text{while } i &gt; 0: \
\quad j = \text{prev}(i) \
\quad \text{tokens.append}(\overline{c_{j+1}\cdots c_i}) \
\quad i \gets j \tag{23}
\end{equation}</p>
<h4 id="33-ac">3.3 ACè‡ªåŠ¨æœºåŠ é€Ÿ</h4>
<p><strong>é—®é¢˜</strong>ï¼šå¯¹äºæ¯ä¸ªä½ç½®$i$ï¼Œéœ€è¦éå†æ‰€æœ‰$j &lt; i$æ£€æŸ¥æ˜¯å¦å­˜åœ¨è¯ï¼Œå¤æ‚åº¦$O(L^2)$ã€‚</p>
<p><strong>ACè‡ªåŠ¨æœºï¼ˆAho-Corasick Automatonï¼‰</strong>ï¼š</p>
<p>é¢„å¤„ç†è¯è¡¨ï¼Œæ„å»ºå¤±é…æŒ‡é’ˆï¼Œå¯ä»¥åœ¨$O(L)$æ—¶é—´å†…æ‰¾åˆ°æ‰€æœ‰è¯çš„ç»ˆæ­¢ä½ç½®ã€‚</p>
<p><strong>ç®—æ³•æµç¨‹</strong>ï¼š
1. é¢„å¤„ç†ï¼šæ„å»ºACè‡ªåŠ¨æœºï¼ˆ$O(|\mathcal{V}| \cdot \bar{L}_w)$ï¼Œ$\bar{L}_w$æ˜¯å¹³å‡è¯é•¿ï¼‰
2. æ‰«æï¼šç”¨ACè‡ªåŠ¨æœºæ‰«ææ–‡æœ¬ï¼Œæ‰¾åˆ°æ‰€æœ‰å¯èƒ½çš„è¯$(s, e, w)$ï¼ˆèµ·å§‹ã€ç»“æŸã€è¯æœ¬èº«ï¼‰
3. DPï¼šæŒ‰ç»“æŸä½ç½®$e$æ’åºï¼Œä¾æ¬¡è®¡ç®—$S^*(e)$</p>
<p><strong>å¤æ‚åº¦</strong>ï¼š$O(L \cdot m)$ï¼Œå…¶ä¸­$m$æ˜¯è¯è¡¨ä¸­æœ€å¤§è¯é•¿ã€‚</p>
<h4 id="34">3.4 ä¼ªä»£ç å®ç°</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">viterbi_decoding</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">vocab</span><span class="p">,</span> <span class="n">prob</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    text: è¾“å…¥å­—èŠ‚åºåˆ—</span>
<span class="sd">    vocab: è¯è¡¨ï¼ˆTrieæˆ–ACè‡ªåŠ¨æœºï¼‰</span>
<span class="sd">    prob: è¯çš„å¯¹æ•°æ¦‚ç‡å‡½æ•°ï¼Œprob(w) = log P(w)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">L</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="c1"># åˆå§‹åŒ–</span>
    <span class="n">S</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)]</span> <span class="o">*</span> <span class="p">(</span><span class="n">L</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">prev</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">L</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">S</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="c1"># ä½¿ç”¨ACè‡ªåŠ¨æœºæ‰¾åˆ°æ‰€æœ‰å¯èƒ½çš„è¯</span>
    <span class="n">candidates</span> <span class="o">=</span> <span class="n">vocab</span><span class="o">.</span><span class="n">find_all_words</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>  <span class="c1"># [(start, end, word), ...]</span>

    <span class="c1"># æŒ‰ç»“æŸä½ç½®åˆ†ç»„</span>
    <span class="n">candidates_by_end</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">:</span>
        <span class="n">candidates_by_end</span><span class="p">[</span><span class="n">end</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">start</span><span class="p">,</span> <span class="n">word</span><span class="p">))</span>

    <span class="c1"># åŠ¨æ€è§„åˆ’</span>
    <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">L</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">candidates_by_end</span><span class="p">[</span><span class="n">e</span><span class="p">]:</span>
            <span class="n">score</span> <span class="o">=</span> <span class="n">S</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">+</span> <span class="n">prob</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">score</span> <span class="o">&gt;</span> <span class="n">S</span><span class="p">[</span><span class="n">e</span><span class="p">]:</span>
                <span class="n">S</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="n">score</span>
                <span class="n">prev</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">word</span><span class="p">)</span>

    <span class="c1"># å›æº¯</span>
    <span class="k">if</span> <span class="n">S</span><span class="p">[</span><span class="n">L</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>  <span class="c1"># æ— æ³•åˆ‡åˆ†</span>

    <span class="n">tokens</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="n">L</span>
    <span class="k">while</span> <span class="n">pos</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">s</span><span class="p">,</span> <span class="n">word</span> <span class="o">=</span> <span class="n">prev</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span>
        <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">s</span>

    <span class="k">return</span> <span class="n">tokens</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</code></pre></div>

<h3 id="-">å››ã€å‰å‘-åå‘ç®—æ³•å¯¹æ¯”</h3>
<h4 id="41-forward-algorithm">4.1 å‰å‘ç®—æ³•ï¼ˆForward Algorithmï¼‰</h4>
<p><strong>ç›®çš„</strong>ï¼šè®¡ç®—è§‚æµ‹åºåˆ—çš„æ¦‚ç‡$P(\boldsymbol{x}|\lambda)$ã€‚</p>
<p>å®šä¹‰å‰å‘å˜é‡ï¼š
\begin{equation}
\alpha_t(i) = P(x_1, \ldots, x_t, q_t = s_i | \lambda) \tag{24}
\end{equation}</p>
<p><strong>é€’æ¨</strong>ï¼š
\begin{equation}
\alpha_t(j) = \left[\sum_{i=1}^{N} \alpha_{t-1}(i) a_{ij}\right] b_j(x_t) \tag{25}
\end{equation}</p>
<p><strong>ä¸Viterbiçš„å¯¹æ¯”</strong>ï¼š
- å‰å‘ï¼š$\sum$ï¼ˆæ±‚å’Œï¼Œæ‰€æœ‰è·¯å¾„ï¼‰
- Viterbiï¼š$\max$ï¼ˆæœ€å¤§å€¼ï¼Œæœ€ä¼˜è·¯å¾„ï¼‰</p>
<h4 id="42-backward-algorithm">4.2 åå‘ç®—æ³•ï¼ˆBackward Algorithmï¼‰</h4>
<p>å®šä¹‰åå‘å˜é‡ï¼š
\begin{equation}
\beta_t(i) = P(x_{t+1}, \ldots, x_T | q_t = s_i, \lambda) \tag{26}
\end{equation}</p>
<p><strong>é€’æ¨</strong>ï¼ˆä»$T$åˆ°$1$ï¼‰ï¼š
\begin{equation}
\beta_t(i) = \sum_{j=1}^{N} a_{ij} b_j(x_{t+1}) \beta_{t+1}(j) \tag{27}
\end{equation}</p>
<h4 id="43-">4.3 å‰å‘-åå‘çš„åº”ç”¨</h4>
<p><strong>è¾¹ç¼˜æ¦‚ç‡</strong>ï¼š
\begin{equation}
P(q_t = s_i | \boldsymbol{x}, \lambda) = \frac{\alpha_t(i) \beta_t(i)}{P(\boldsymbol{x}|\lambda)} = \frac{\alpha_t(i) \beta_t(i)}{\sum_{j=1}^{N} \alpha_T(j)} \tag{28}
\end{equation}</p>
<p><strong>è¾¹ç¼˜æ¦‚ç‡ vs Viterbiè·¯å¾„</strong>ï¼š
- è¾¹ç¼˜æ¦‚ç‡ï¼šè€ƒè™‘æ‰€æœ‰è·¯å¾„ï¼Œç»™å‡ºæ¯ä¸ªä½ç½®æ¯ä¸ªçŠ¶æ€çš„æ¦‚ç‡
- Viterbiï¼šåªè€ƒè™‘æœ€ä¼˜è·¯å¾„</p>
<h3 id="viterbi-decodingviterbi-sampling">äº”ã€ä»Viterbi Decodingåˆ°Viterbi Sampling</h3>
<h4 id="51">5.1 é‡‡æ ·çš„åŠ¨æœº</h4>
<p><strong>Viterbi Decodingçš„å±€é™</strong>ï¼š
1. <strong>ç¡®å®šæ€§</strong>ï¼šæ€»æ˜¯è¾“å‡ºåŒä¸€ä¸ªç»“æœ
2. <strong>è¿‡åº¦è‡ªä¿¡</strong>ï¼šå³ä½¿å¤šä¸ªåˆ‡åˆ†æ–¹æ¡ˆæ¦‚ç‡æ¥è¿‘ï¼Œä¹Ÿåªè¿”å›ä¸€ä¸ª
3. <strong>è®­ç»ƒ-æ¨ç†ä¸ä¸€è‡´</strong>ï¼šè®­ç»ƒæ—¶å¯èƒ½éœ€è¦å¤šæ ·æ€§</p>
<p><strong>Viterbi Samplingçš„ç›®æ ‡</strong>ï¼š
- ä¾æ¦‚ç‡é‡‡æ ·åˆ‡åˆ†æ–¹æ¡ˆ
- æ¦‚ç‡é«˜çš„æ–¹æ¡ˆè¢«é‡‡æ ·åˆ°çš„æ¦‚ç‡å¤§
- ä¿æŒViterbi Decodingçš„æ•ˆç‡ï¼ˆçº¿æ€§å¤æ‚åº¦ï¼‰</p>
<h4 id="52-n-best">5.2 æœ´ç´ é‡‡æ ·æ–¹æ³•ï¼šN-bestæœç´¢</h4>
<p><strong>Subword Regularizationçš„åšæ³•</strong>ï¼š</p>
<ol>
<li>æ‰¾åˆ°æ¦‚ç‡æœ€é«˜çš„$n$ä¸ªåˆ‡åˆ†æ–¹æ¡ˆ$\boldsymbol{w}_1^<em>, \ldots, \boldsymbol{w}_n^</em>$</li>
<li>è®¡ç®—æƒé‡ï¼š
   \begin{equation}
   p_i = \frac{P(\boldsymbol{w}_i^<em>)^\alpha}{\sum_{j=1}^{n} P(\boldsymbol{w}_j^</em>)^\alpha} \tag{29}
   \end{equation}</li>
<li>æŒ‰$p_i$è¿›è¡Œé‡‡æ ·</li>
</ol>
<p><strong>N-best Viterbiç®—æ³•</strong>ï¼š</p>
<p>ç»´æŠ¤æ¯ä¸ªä½ç½®çš„top-$n$è·¯å¾„ï¼Œå¤æ‚åº¦$O(nLm)$ï¼Œå…¶ä¸­$m$æ˜¯æœ€å¤§è¯é•¿ã€‚</p>
<p><strong>ç¼ºç‚¹</strong>ï¼š
- æ•ˆç‡ä½ï¼ˆ$n$å€å¤æ‚åº¦ï¼‰
- éœ€è¦é€‰æ‹©$n$ï¼ˆå¤ªå°ï¼šè¦†ç›–ä¸è¶³ï¼›å¤ªå¤§ï¼šæµªè´¹ï¼‰</p>
<h4 id="53-viterbi-sampling">5.3 Viterbi Samplingçš„æ ¸å¿ƒæ€æƒ³</h4>
<p><strong>é—®é¢˜é‡æ–°è¡¨è¿°</strong>ï¼š</p>
<p>Viterbi Decodingçš„åˆ¤æ®æ˜¯ï¼š
\begin{equation}
\text{if } \text{score}<em _text_old="\text{old">{\text{new}} &gt; \text{score}</em>
\end{equation}}} \text{ then accept new} \tag{30</p>
<p><strong>éšæœºåŒ–åˆ¤æ®</strong>ï¼š
\begin{equation}
\text{if } \varepsilon &lt; \sigma(\alpha(\text{score}<em _text_old="\text{old">{\text{new}} - \text{score}</em>
\end{equation}}})) \text{ then accept new} \tag{31</p>
<p>å…¶ä¸­ï¼š
- $\varepsilon \sim U[0,1]$ï¼šå‡åŒ€éšæœºæ•°
- $\sigma(x) = 1/(1 + e^{-x})$ï¼šSigmoidå‡½æ•°
- $\alpha &gt; 0$ï¼šæ¸©åº¦å‚æ•°</p>
<p><strong>æ€§è´¨</strong>ï¼š
1. å½“$\text{score}<em _text_old="\text{old">{\text{new}} &gt; \text{score}</em>$æ—¶ï¼Œæ¥å—æ¦‚ç‡$&gt; 0.5$
2. åˆ†æ•°å·®è·è¶Šå¤§ï¼Œæ¥å—æ¦‚ç‡è¶Šæç«¯ï¼ˆæ¥è¿‘0æˆ–1ï¼‰
3. $\alpha \to \infty$æ—¶ï¼Œé€€åŒ–ä¸ºViterbi Decoding}</p>
<h4 id="54-viterbi-sampling">5.4 Viterbi Samplingçš„é€’æ¨å…¬å¼</h4>
<p><strong>ä¿®æ”¹Viterbié€’æ¨</strong>ï¼š</p>
<p>åŸæœ¬ï¼š
\begin{equation}
\text{if } S[j] + s(w) &gt; S[i] \text{ then} \
\quad S[i] = S[j] + s(w) \
\quad \text{prev}[i] = (j, w) \tag{32}
\end{equation}</p>
<p>éšæœºåŒ–ä¸ºï¼š
\begin{equation}
\text{score}<em _text_old="\text{old">{\text{new}} = S[j] + s(w) \
\text{score}</em> = S[i] \
p_{\text{accept}} = \sigma(\alpha(\text{score}}<em _text_old="\text{old">{\text{new}} - \text{score}</em>)) \
\text{if } \varepsilon &lt; p_{\text{accept}} \text{ then} \
\quad S[i] = \text{score}_{\text{new}} \
\quad \text{prev}[i] = (j, w) \tag{33}
\end{equation}}</p>
<p><strong>åˆå§‹åŒ–</strong>ï¼š
\begin{equation}
S[i] = -\infty, \quad i = 1, \ldots, L \tag{34}
\end{equation}</p>
<h4 id="55">5.5 ä¿åºæ€§åˆ†æ</h4>
<p><strong>å®šä¹‰</strong>ï¼šå¦‚æœåˆ‡åˆ†æ–¹æ¡ˆ$\boldsymbol{w}_1$çš„å¾—åˆ†é«˜äº$\boldsymbol{w}_2$ï¼Œå³$P(\boldsymbol{w}_1) &gt; P(\boldsymbol{w}_2)$ï¼Œé‚£ä¹ˆåœ¨é‡‡æ ·ä¸­$\boldsymbol{w}_1$è¢«é‡‡åˆ°çš„æ¦‚ç‡æ˜¯å¦ä¹Ÿæ›´é«˜ï¼Ÿ</p>
<p><strong>Viterbi Samplingçš„ä¿åºæ€§</strong>ï¼š</p>
<p>ä¸æ˜¯ä¸¥æ ¼ä¿åºçš„ï¼Œä½†è¿‘ä¼¼ä¿åºã€‚</p>
<p><strong>åˆ†æ</strong>ï¼šè€ƒè™‘ä¸¤æ¡è·¯å¾„$A$å’Œ$B$ï¼Œå¾—åˆ†åˆ†åˆ«ä¸º$s_A$å’Œ$s_B$ï¼Œ$s_A &gt; s_B$ã€‚</p>
<p>å¦‚æœä¸¤æ¡è·¯å¾„åœ¨ä½ç½®$i$ç«äº‰ï¼š
\begin{equation}
P(\text{é€‰æ‹©}A) = \sigma(\alpha(s_A - s_B)) &gt; 0.5 \tag{35}
\end{equation}</p>
<p>ä½†æ˜¯ï¼Œå¦‚æœè·¯å¾„æ¶‰åŠå¤šæ­¥ç«äº‰ï¼Œæ¯æ­¥éƒ½æœ‰éšæœºæ€§ï¼Œæœ€ç»ˆçš„æ’åºå¯èƒ½æ”¹å˜ã€‚</p>
<p><strong>å®è¯è§‚å¯Ÿ</strong>ï¼šåœ¨å®é™…åº”ç”¨ä¸­ï¼Œå¾—åˆ†é«˜çš„æ–¹æ¡ˆç¡®å®æ›´å¸¸è¢«é‡‡æ ·åˆ°ï¼Œå°¤å…¶æ˜¯å½“$\alpha$è¾ƒå¤§æ—¶ã€‚</p>
<h3 id="_7">å…­ã€æ•°å€¼ç¨³å®šæ€§ä¸å®ç°æŠ€å·§</h3>
<h4 id="61-logsumexp">6.1 LogSumExpæŠ€å·§</h4>
<p>å‰å‘ç®—æ³•æ¶‰åŠåˆ°æ±‚å’Œï¼š
\begin{equation}
\alpha_t(j) = \left[\sum_{i=1}^{N} \alpha_{t-1}(i) a_{ij}\right] b_j(x_t) \tag{36}
\end{equation}</p>
<p>åœ¨å¯¹æ•°ç©ºé—´ï¼š
\begin{equation}
\log \alpha_t(j) = \log \left[\sum_{i=1}^{N} e^{\log \alpha_{t-1}(i) + \log a_{ij}}\right] + \log b_j(x_t) \tag{37}
\end{equation}</p>
<p>ç›´æ¥è®¡ç®—$\sum e^{x_i}$å¯èƒ½æº¢å‡ºã€‚ä½¿ç”¨LogSumExpï¼š
\begin{equation}
\text{LSE}(x_1, \ldots, x_N) = x_{\max} + \log \sum_{i=1}^{N} e^{x_i - x_{\max}} \tag{38}
\end{equation}</p>
<p>å…¶ä¸­$x_{\max} = \max_i x_i$ã€‚</p>
<h4 id="62-sigmoid">6.2 Sigmoidçš„æ•°å€¼ç¨³å®šè®¡ç®—</h4>
<p>Sigmoidå‡½æ•°ï¼š
\begin{equation}
\sigma(x) = \frac{1}{1 + e^{-x}} \tag{39}
\end{equation}</p>
<p><strong>é—®é¢˜</strong>ï¼š
- å½“$x$å¾ˆå¤§æ—¶ï¼Œ$e^{-x} \to 0$ï¼Œä½†è®¡ç®—$e^{-x}$å¯èƒ½ä¸‹æº¢
- å½“$x$å¾ˆå°æ—¶ï¼Œ$e^{-x} \to \infty$ï¼Œä¸Šæº¢</p>
<p><strong>ç¨³å®šè®¡ç®—</strong>ï¼š
\begin{equation}
\sigma(x) = \begin{cases}
\frac{1}{1 + e^{-x}}, &amp; x \geq 0 \
\frac{e^x}{1 + e^x}, &amp; x &lt; 0
\end{cases} \tag{40}
\end{equation}</p>
<p><strong>æ¨å¯¼</strong>ï¼š
\begin{equation}
\sigma(x) = \frac{1}{1 + e^{-x}} = \frac{e^x}{e^x + 1} = \frac{e^x}{1 + e^x} \tag{41}
\end{equation}</p>
<p>ä¸¤ç§å½¢å¼ç­‰ä»·ï¼Œä½†æ•°å€¼ç¨³å®šæ€§ä¸åŒã€‚</p>
<h4 id="63">6.3 éšæœºæ•°ç”Ÿæˆçš„æ•ˆç‡</h4>
<p>Viterbi Samplingæ¯æ¬¡DPæ›´æ–°éƒ½éœ€è¦ä¸€ä¸ªéšæœºæ•°$\varepsilon \sim U[0,1]$ã€‚</p>
<p><strong>ä¼˜åŒ–æ–¹æ³•</strong>ï¼š
1. <strong>æ‰¹é‡ç”Ÿæˆ</strong>ï¼šé¢„å…ˆç”Ÿæˆä¸€å¤§æ‰¹éšæœºæ•°
2. <strong>å¿«é€ŸRNG</strong>ï¼šä½¿ç”¨Xorshiftç­‰å¿«é€Ÿéšæœºæ•°ç”Ÿæˆå™¨
3. <strong>å‘é‡åŒ–</strong>ï¼šä½¿ç”¨SIMDæŒ‡ä»¤å¹¶è¡Œç”Ÿæˆ</p>
<p><strong>Pythonç¤ºä¾‹</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># é¢„ç”Ÿæˆéšæœºæ•°</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">random_pool</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>
<span class="n">rand_idx</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">def</span><span class="w"> </span><span class="nf">get_random</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">rand_idx</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">random_pool</span><span class="p">[</span><span class="n">rand_idx</span><span class="p">]</span>
    <span class="n">rand_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">rand_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">random_pool</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">r</span>
</code></pre></div>

<h3 id="_8">ä¸ƒã€é‡‡æ ·è´¨é‡åˆ†æ</h3>
<h4 id="71">7.1 æœŸæœ›å€¼åˆ†æ</h4>
<p><strong>é—®é¢˜</strong>ï¼šViterbi Samplingé‡‡æ ·åˆ°æŸä¸ªåˆ‡åˆ†æ–¹æ¡ˆ$\boldsymbol{w}$çš„æ¦‚ç‡æ˜¯å¤šå°‘ï¼Ÿ</p>
<p>è¿™æ˜¯ä¸€ä¸ªå¤æ‚çš„é—®é¢˜ï¼Œå› ä¸ºé‡‡æ ·è¿‡ç¨‹æ¶‰åŠå¤šæ­¥éšæœºå†³ç­–ã€‚</p>
<p><strong>è¿‘ä¼¼åˆ†æ</strong>ï¼š</p>
<p>å‡è®¾DPè¿‡ç¨‹ä¸­ï¼Œæ¯ä¸ªä½ç½®ç‹¬ç«‹åšå†³ç­–ï¼ˆè¿™æ˜¯ä¸€ä¸ªç®€åŒ–å‡è®¾ï¼‰ã€‚è®¾ä½ç½®$i$æœ‰$k_i$ä¸ªå€™é€‰è¯ç»“å°¾ï¼Œå¾—åˆ†åˆ†åˆ«ä¸º$s_1^{(i)}, \ldots, s_{k_i}^{(i)}$ã€‚</p>
<p>é‡‡æ ·åˆ°å¾—åˆ†ä¸º$s_j^{(i)}$çš„å€™é€‰çš„æ¦‚ç‡çº¦ä¸ºï¼š
\begin{equation}
p_j^{(i)} \approx \frac{e^{\alpha s_j^{(i)}}}{\sum_{\ell=1}^{k_i} e^{\alpha s_\ell^{(i)}}} \tag{42}
\end{equation}</p>
<p>è¿™ç±»ä¼¼äºSoftmaxï¼</p>
<p>æ•´æ¡è·¯å¾„è¢«é‡‡æ ·åˆ°çš„æ¦‚ç‡ï¼ˆè¿‘ä¼¼ï¼‰ï¼š
\begin{equation}
P_{\text{sample}}(\boldsymbol{w}) \approx \prod_{i \in \boldsymbol{w}} p_j^{(i)} \tag{43}
\end{equation}</p>
<h4 id="72">7.2 ä¸çœŸå®æ¦‚ç‡çš„å…³ç³»</h4>
<p><strong>ç†æƒ³æƒ…å†µ</strong>ï¼šæˆ‘ä»¬å¸Œæœ›é‡‡æ ·æ¦‚ç‡æ­£æ¯”äºçœŸå®æ¦‚ç‡ï¼š
\begin{equation}
P_{\text{sample}}(\boldsymbol{w}) \propto P(\boldsymbol{w}) = e^{s(\boldsymbol{w})} \tag{44}
\end{equation}</p>
<p>å…¶ä¸­$s(\boldsymbol{w}) = \sum_{w_i \in \boldsymbol{w}} \log P(w_i)$ã€‚</p>
<p><strong>Viterbi Samplingçš„åå·®</strong>ï¼š</p>
<p>ç”±äºå¤šæ¬¡äºŒé€‰ä¸€çš„ç¨€é‡Šæ•ˆåº”ï¼ˆåé¢çš„å€™é€‰"å ä¾¿å®œ"ï¼‰ï¼ŒViterbi Samplingçš„é‡‡æ ·æ¦‚ç‡ä¸çœŸå®æ¦‚ç‡ä¸å®Œå…¨ä¸€è‡´ã€‚</p>
<p><strong>æ–‡ç« çš„æ”¹è¿›æ–¹å‘</strong>ï¼š
- ä½¿ç”¨æ°´å¡˜é‡‡æ ·ï¼ˆReservoir Samplingï¼‰
- ç¼“å­˜ç´¯ç§¯æ¦‚ç‡
- è¯¦è§ä¸‹ä¸€ç¯‡æ–‡ç« ã€Šéšæœºåˆ†è¯å†æ¢ã€‹</p>
<h4 id="73-alpha">7.3 æ¸©åº¦å‚æ•°$\alpha$çš„å½±å“</h4>
<p><strong>$\alpha \to 0$</strong>ï¼š
\begin{equation}
\sigma(\alpha \Delta s) \to \begin{cases}
1, &amp; \Delta s &gt; 0 \
0.5, &amp; \Delta s = 0 \
0, &amp; \Delta s &lt; 0
\end{cases} \tag{45}
\end{equation}</p>
<p>æ¥è¿‘å‡åŒ€é‡‡æ ·ï¼ˆæ‰€æœ‰æ­£åˆ†æ•°å·®éƒ½ä»¥æ¦‚ç‡0.5æ¥å—ï¼‰ã€‚</p>
<p><strong>$\alpha \to \infty$</strong>ï¼š
\begin{equation}
\sigma(\alpha \Delta s) \to \begin{cases}
1, &amp; \Delta s &gt; 0 \
0.5, &amp; \Delta s = 0 \
0, &amp; \Delta s &lt; 0
\end{cases} \tag{46}
\end{equation}</p>
<p>é€€åŒ–ä¸ºViterbi Decodingï¼ˆæ€»æ˜¯é€‰æ‹©åˆ†æ•°é«˜çš„ï¼‰ã€‚</p>
<p><strong>$\alpha = 0.1$ï¼ˆç»éªŒå€¼ï¼‰</strong>ï¼š
- ä¿æŒä¸€å®šçš„éšæœºæ€§
- åŒæ—¶åå‘é«˜åˆ†æ–¹æ¡ˆ
- åœ¨è®­ç»ƒä¸­å¼•å…¥æ­£åˆ™åŒ–æ•ˆæœ</p>
<h3 id="bpe-dropout">å…«ã€ä¸BPE Dropoutçš„å¯¹æ¯”</h3>
<h4 id="81-bpe-dropout">8.1 BPE Dropout</h4>
<p>BPEï¼ˆByte Pair Encodingï¼‰ä½¿ç”¨è´ªå¿ƒmergeç­–ç•¥ï¼Œæ¯æ¬¡é€‰æ‹©é¢‘ç‡æœ€é«˜çš„å­—èŠ‚å¯¹åˆå¹¶ã€‚</p>
<p><strong>BPE Dropout</strong>ï¼šåœ¨mergeè¿‡ç¨‹ä¸­ï¼Œä»¥æ¦‚ç‡$p$éšæœºè·³è¿‡æŸäº›mergeæ“ä½œã€‚</p>
<p><strong>ç®—æ³•</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">bpe_dropout</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">merge_rules</span><span class="p">,</span> <span class="n">p_dropout</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">merge_rules</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">p_dropout</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">apply_merge</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">rule</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">text</span>
</code></pre></div>

<h4 id="82">8.2 å¯¹æ¯”</h4>
<table>
<thead>
<tr>
<th>æ–¹é¢</th>
<th>Viterbi Sampling</th>
<th>BPE Dropout</th>
</tr>
</thead>
<tbody>
<tr>
<td>é€‚ç”¨æ¨¡å‹</td>
<td>Unigram</td>
<td>BPE</td>
</tr>
<tr>
<td>éšæœºåŒ–æ–¹å¼</td>
<td>DPè¿‡ç¨‹ä¸­éšæœºé€‰æ‹©</td>
<td>Mergeè¿‡ç¨‹ä¸­éšæœºè·³è¿‡</td>
</tr>
<tr>
<td>æ¦‚ç‡ä¿è¯</td>
<td>è¿‘ä¼¼æŒ‰æ¦‚ç‡é‡‡æ ·</td>
<td>æ— æ˜ç¡®æ¦‚ç‡ä¿è¯</td>
</tr>
<tr>
<td>å®ç°å¤æ‚åº¦</td>
<td>ä¸­ç­‰</td>
<td>ç®€å•</td>
</tr>
<tr>
<td>æ•ˆç‡</td>
<td>ä¸ç¡®å®šæ€§ç‰ˆæœ¬ç›¸è¿‘</td>
<td>ä¸ç¡®å®šæ€§ç‰ˆæœ¬ç›¸åŒ</td>
</tr>
</tbody>
</table>
<h4 id="83-subword-regularization">8.3 Subword Regularizationå¯¹æ¯”</h4>
<p><strong>æ–¹æ³•</strong>ï¼šæ‰¾top-$n$ä¸ªåˆ‡åˆ†æ–¹æ¡ˆï¼ŒæŒ‰æ¦‚ç‡åŠ æƒé‡‡æ ·ã€‚</p>
<p><strong>ä¼˜ç‚¹</strong>ï¼š
- ç²¾ç¡®æŒ‰æ¦‚ç‡é‡‡æ ·
- ç†è®ºä¿è¯å¼º</p>
<p><strong>ç¼ºç‚¹</strong>ï¼š
- æ•ˆç‡ä½ï¼ˆ$n$å€å¤æ‚åº¦ï¼‰
- éœ€è¦è°ƒå‚$n$</p>
<p><strong>Viterbi Samplingçš„ä¼˜åŠ¿</strong>ï¼š
- æ¥è¿‘åŸå§‹æ•ˆç‡
- è‡ªåŠ¨é€‚åº”ï¼ˆæ— éœ€è°ƒ$n$ï¼‰
- å®ç°ç®€å•</p>
<h3 id="_9">ä¹ã€å®é™…åº”ç”¨ä¸æ•ˆæœ</h3>
<h4 id="91">9.1 è®­ç»ƒæ•°æ®å¢å¼º</h4>
<p><strong>åº”ç”¨åœºæ™¯</strong>ï¼šè®­ç»ƒè¯­è¨€æ¨¡å‹æ—¶ï¼Œæ¯ä¸ªepochä½¿ç”¨ä¸åŒçš„åˆ†è¯ç»“æœã€‚</p>
<p><strong>æ•ˆæœ</strong>ï¼š
- å¢å¼ºæ¨¡å‹é²æ£’æ€§
- å‡å°‘å¯¹ç‰¹å®šåˆ†è¯çš„è¿‡æ‹Ÿåˆ
- æ”¹å–„out-of-vocabulary (OOV)å¤„ç†</p>
<p><strong>ç¤ºä¾‹</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># è®­ç»ƒæ—¶</span>
<span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_epochs</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">dataset</span><span class="p">:</span>
        <span class="c1"># æ¯æ¬¡ä½¿ç”¨éšæœºåˆ†è¯</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">tokenize</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">random</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">train_step</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>
</code></pre></div>

<h4 id="92">9.2 é€Ÿåº¦å¯¹æ¯”</h4>
<p>æ ¹æ®æ–‡ç« çš„å®éªŒæ•°æ®ï¼š</p>
<table>
<thead>
<tr>
<th>æ–¹æ³•</th>
<th>ç¡®å®šæ€§é€Ÿåº¦</th>
<th>éšæœºæ€§é€Ÿåº¦</th>
<th>é€Ÿåº¦æ¯”</th>
</tr>
</thead>
<tbody>
<tr>
<td>SP-BPE</td>
<td>1.36M bytes/sec</td>
<td>1.25M bytes/sec</td>
<td>92%</td>
</tr>
<tr>
<td><strong>SP-Unigram</strong></td>
<td><strong>5.65M bytes/sec</strong></td>
<td><strong>1.28M bytes/sec</strong></td>
<td><strong>23%</strong></td>
</tr>
<tr>
<td>BytePiece (Viterbi Sampling)</td>
<td>1.95M bytes/sec</td>
<td>1.36M bytes/sec</td>
<td><strong>70%</strong></td>
</tr>
</tbody>
</table>
<p><strong>è§‚å¯Ÿ</strong>ï¼š
- Subword Regularization (SP-Unigraméšæœºç‰ˆ)é€Ÿåº¦ä¸‹é™åˆ°23%
- Viterbi Samplingä¿æŒ70%çš„é€Ÿåº¦
- <strong>3å€åŠ é€Ÿ</strong>ï¼</p>
<h4 id="93">9.3 åˆ†è¯å¤šæ ·æ€§</h4>
<p><strong>å®éªŒ</strong>ï¼ˆä»æ–‡ç« ï¼‰ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;ä»Šå¤©å¤©æ°”ä¸é”™&#39;</span>

<span class="c1"># ç¡®å®šæ€§åˆ†è¯</span>
<span class="nb">print</span><span class="p">(</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">tokenize</span><span class="p">(</span><span class="n">text</span><span class="p">))</span>
<span class="c1"># [b&#39;\xe4\xbb\x8a\xe5\xa4\xa9&#39;, b&#39;\xe5\xa4\xa9\xe6\xb0\x94&#39;, b&#39;\xe4\xb8\x8d\xe9\x94\x99&#39;]</span>

<span class="c1"># Viterbi Sampling (alpha=0.1)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">tokenize</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">))</span>
<span class="c1"># [b&#39;\xe4\xbb\x8a\xe5\xa4\xa9&#39;, b&#39;\xe5\xa4\xa9\xe6&#39;, b&#39;\xb0\x94&#39;, b&#39;\xe4\xb8\x8d\xe9\x94\x99&#39;]</span>
<span class="c1"># [b&#39;\xe4\xbb\x8a\xe5\xa4\xa9&#39;, b&#39;\xe5\xa4\xa9\xe6\xb0\x94&#39;, b&#39;\xe4\xb8\x8d\xe9\x94\x99&#39;]</span>
<span class="c1"># [b&#39;\xe4\xbb\x8a\xe5\xa4\xa9&#39;, b&#39;\xe5\xa4\xa9\xe6\xb0\x94&#39;, b&#39;\xe4\xb8&#39;, b&#39;\x8d&#39;, b&#39;\xe9\x94&#39;, b&#39;\x99&#39;]</span>
<span class="c1"># [b&#39;\xe4\xbb\x8a\xe5\xa4\xa9&#39;, b&#39;\xe5\xa4\xa9&#39;, b&#39;\xe6\xb0\x94&#39;, b&#39;\xe4\xb8\x8d\xe9\x94\x99&#39;]</span>
<span class="c1"># [b&#39;\xe4\xbb&#39;, b&#39;\x8a\xe5\xa4\xa9&#39;, b&#39;\xe5\xa4\xa9&#39;, b&#39;\xe6\xb0\x94\xe4\xb8\x8d&#39;, b&#39;\xe9\x94&#39;, b&#39;\x99&#39;]</span>
</code></pre></div>

<p><strong>åˆ†æ</strong>ï¼š
- ç¡®å®šæ€§ç‰ˆæœ¬æ€»æ˜¯è¾“å‡ºåŒä¸€ç»“æœ
- éšæœºç‰ˆæœ¬äº§ç”Ÿå¤šç§åˆ‡åˆ†
- æŸäº›å¸¸è§åˆ‡åˆ†å‡ºç°é¢‘ç‡æ›´é«˜ï¼ˆå¦‚"ä»Šå¤©"ã€"å¤©æ°”"ï¼‰</p>
<h3 id="_10">åã€ç†è®ºä¿è¯ä¸å±€é™æ€§</h3>
<h4 id="101-viterbi-sampling">10.1 Viterbi Samplingçš„ç†è®ºæ€§è´¨</h4>
<p><strong>æ€§è´¨1ï¼ˆè¿‘ä¼¼ä¿åºï¼‰</strong>ï¼šé«˜åˆ†åˆ‡åˆ†æ–¹æ¡ˆè¢«é‡‡æ ·åˆ°çš„æ¦‚ç‡æ›´å¤§ã€‚</p>
<p><strong>æ€§è´¨2ï¼ˆæ•ˆç‡ï¼‰</strong>ï¼šå¤æ‚åº¦ä¸Viterbi Decodingç›¸åŒï¼Œéƒ½æ˜¯$O(Lm)$ã€‚</p>
<p><strong>æ€§è´¨3ï¼ˆå¯æ§éšæœºæ€§ï¼‰</strong>ï¼šé€šè¿‡$\alpha$æ§åˆ¶éšæœºæ€§å¼ºåº¦ã€‚</p>
<h4 id="102">10.2 æœªè§£å†³çš„é—®é¢˜</h4>
<p><strong>é—®é¢˜1</strong>ï¼šé‡‡æ ·æ¦‚ç‡çš„ç²¾ç¡®è¡¨è¾¾å¼æ˜¯ä»€ä¹ˆï¼Ÿ</p>
<p>ç›®å‰åªæœ‰è¿‘ä¼¼åˆ†æï¼Œç¼ºä¹ç²¾ç¡®çš„æ¦‚ç‡åˆ†å¸ƒã€‚</p>
<p><strong>é—®é¢˜2</strong>ï¼šå¦‚ä½•ä¿è¯é‡‡æ ·çš„æ— åæ€§ï¼Ÿ</p>
<p>Viterbi Samplingç”±äºç¨€é‡Šæ•ˆåº”ï¼Œä¸æ˜¯ä¸¥æ ¼æŒ‰$P(\boldsymbol{w})$é‡‡æ ·ã€‚</p>
<p><strong>è§£å†³æ–¹å‘</strong>ï¼š
- æ°´å¡˜é‡‡æ ·ï¼ˆä¸‹ä¸€ç¯‡æ–‡ç« ï¼‰
- åŸºäºCDFçš„é€†å˜æ¢é‡‡æ ·</p>
<h4 id="103">10.3 é€‚ç”¨åœºæ™¯</h4>
<p><strong>é€‚åˆ</strong>ï¼š
- éœ€è¦å¿«é€Ÿéšæœºåˆ†è¯
- è®­ç»ƒæ•°æ®å¢å¼º
- è½»é‡çº§æ­£åˆ™åŒ–</p>
<p><strong>ä¸é€‚åˆ</strong>ï¼š
- éœ€è¦ç²¾ç¡®æ¦‚ç‡åˆ†å¸ƒçš„åœºæ™¯
- ç†è®ºåˆ†æè¦æ±‚ä¸¥æ ¼æ— åé‡‡æ ·</p>
<h3 id="_11">åä¸€ã€æ€»ç»“</h3>
<p>Viterbiç®—æ³•æ˜¯åºåˆ—æ ‡æ³¨å’Œåˆ†è¯é—®é¢˜çš„æ ¸å¿ƒç®—æ³•ï¼Œé€šè¿‡åŠ¨æ€è§„åˆ’åœ¨çº¿æ€§æ—¶é—´å†…æ‰¾åˆ°æœ€ä¼˜è·¯å¾„ã€‚</p>
<p><strong>Viterbi Decoding</strong>ï¼š
\begin{equation}
S^<em>(i) = \max_{j &lt; i} [S^</em>(j) + \log P(w_{j+1:i})] \tag{47}
\end{equation}</p>
<p><strong>Viterbi Samplingï¼ˆåˆæ­¥ç‰ˆæœ¬ï¼‰</strong>ï¼š
\begin{equation}
\text{accept new if } \varepsilon &lt; \sigma(\alpha \cdot \Delta s) \tag{48}
\end{equation}</p>
<p><strong>ä¼˜åŠ¿</strong>ï¼š
- âœ… ä¿æŒçº¿æ€§å¤æ‚åº¦
- âœ… å¼•å…¥éšæœºæ€§
- âœ… å®ç°ç®€å•
- âœ… é€Ÿåº¦å¿«ï¼ˆç›¸æ¯”Subword Regularizationï¼‰</p>
<p><strong>å±€é™</strong>ï¼š
- âŒ é‡‡æ ·æ¦‚ç‡ä¸ç²¾ç¡®
- âŒ ç¨€é‡Šæ•ˆåº”ï¼ˆåç»­å€™é€‰å ä¾¿å®œï¼‰
- âŒ ç†è®ºä¿è¯ä¸è¶³</p>
<p><strong>ä¸‹ä¸€æ­¥</strong>ï¼šåœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ã€Šéšæœºåˆ†è¯å†æ¢ã€‹ä¸­ï¼Œæˆ‘ä»¬å°†è§£å†³ç¨€é‡Šæ•ˆåº”ï¼Œé€šè¿‡æ°´å¡˜é‡‡æ ·å®ç°å®Œç¾é‡‡æ ·ï¼Œè¾¾åˆ°ä¸Subword Regularizationç­‰ä»·çš„æ•ˆæœï¼ŒåŒæ—¶ä¿æŒé«˜æ•ˆç‡ã€‚</p>
<hr />
<h2 id="_12">å®Œæ•´æ•°å­¦æ¨å¯¼ä¸ç†è®ºåˆ†æ</h2>
<p>æœ¬èŠ‚å°†è¯¦ç»†æ¨å¯¼Viterbiç®—æ³•çš„æ•°å­¦åŸºç¡€ï¼ŒåŒ…æ‹¬HMMæ¨¡å‹ã€åŠ¨æ€è§„åˆ’ã€å‰å‘åå‘ç®—æ³•ï¼Œä»¥åŠViterbi Samplingçš„å®Œæ•´ç†è®ºã€‚</p>
<h3 id="hmm_1">ä¸€ã€éšé©¬å°”å¯å¤«æ¨¡å‹(HMM)åŸºç¡€</h3>
<h4 id="11-hmm_1">1.1 HMMçš„ä¸‰è¦ç´ </h4>
<p><strong>å®šä¹‰</strong>ï¼šéšé©¬å°”å¯å¤«æ¨¡å‹æ˜¯å…³äºæ—¶åºçš„æ¦‚ç‡æ¨¡å‹ï¼Œæè¿°ä¸€ä¸ªéšè—çš„é©¬å°”å¯å¤«é“¾éšæœºç”Ÿæˆä¸å¯è§‚æµ‹çš„çŠ¶æ€åºåˆ—ï¼Œå†ç”±å„ä¸ªçŠ¶æ€ç”Ÿæˆè§‚æµ‹åºåˆ—çš„è¿‡ç¨‹ã€‚</p>
<div class="definition-box">

**HMMçš„ä¸‰è¦ç´ **ï¼š

è®¾çŠ¶æ€é›†åˆ$\mathcal{S} = \{s_1, s_2, \ldots, s_N\}$ï¼Œè§‚æµ‹é›†åˆ$\mathcal{O} = \{o_1, o_2, \ldots, o_M\}$ã€‚

1. **åˆå§‹çŠ¶æ€æ¦‚ç‡**ï¼š$\boldsymbol{\pi} = (\pi_1, \ldots, \pi_N)$
   \begin{equation}
   \pi_i = P(q_1 = s_i), \quad \sum_{i=1}^{N} \pi_i = 1 \tag{1}
   \end{equation}

2. **çŠ¶æ€è½¬ç§»æ¦‚ç‡**ï¼š$\mathbf{A} = (a_{ij})_{N \times N}$
   \begin{equation}
   a_{ij} = P(q_{t+1} = s_j | q_t = s_i), \quad \sum_{j=1}^{N} a_{ij} = 1 \tag{2}
   \end{equation}

3. **å‘å°„æ¦‚ç‡ï¼ˆè§‚æµ‹æ¦‚ç‡ï¼‰**ï¼š$\mathbf{B} = (b_j(o_k))$
   \begin{equation}
   b_j(o_k) = P(x_t = o_k | q_t = s_j), \quad \sum_{k=1}^{M} b_j(o_k) = 1 \tag{3}
   \end{equation}

HMMè®°ä¸º$\lambda = (\mathbf{A}, \mathbf{B}, \boldsymbol{\pi})$ã€‚

</div>

<p><strong>é©¬å°”å¯å¤«æ€§å‡è®¾</strong>ï¼š</p>
<ol>
<li>
<p><strong>é½æ¬¡é©¬å°”å¯å¤«å‡è®¾</strong>ï¼šçŠ¶æ€è½¬ç§»æ¦‚ç‡ä¸æ—¶é—´æ— å…³
   \begin{equation}
   P(q_t | q_{t-1}, \ldots, q_1) = P(q_t | q_{t-1}) \tag{4}
   \end{equation}</p>
</li>
<li>
<p><strong>è§‚æµ‹ç‹¬ç«‹æ€§å‡è®¾</strong>ï¼šè§‚æµ‹åªä¾èµ–äºå½“å‰çŠ¶æ€
   \begin{equation}
   P(x_t | q_1, \ldots, q_T, x_1, \ldots, x_{t-1}, x_{t+1}, \ldots, x_T) = P(x_t | q_t) \tag{5}
   \end{equation}</p>
</li>
</ol>
<h4 id="12-hmmunigram_1">1.2 HMMçš„åº”ç”¨ï¼šUnigramåˆ†è¯</h4>
<p>åœ¨Unigramåˆ†è¯ä¸­ï¼ŒHMMçš„å¯¹åº”å…³ç³»ï¼š</p>
<ul>
<li><strong>è§‚æµ‹åºåˆ—</strong>ï¼šåŸå§‹æ–‡æœ¬ï¼ˆå­—èŠ‚åºåˆ—ï¼‰$\boldsymbol{c} = (c_1, c_2, \ldots, c_L)$</li>
<li><strong>çŠ¶æ€åºåˆ—</strong>ï¼šåˆ‡åˆ†æ–¹æ¡ˆï¼ˆè¯åºåˆ—ï¼‰$\boldsymbol{w} = (w_1, w_2, \ldots, w_K)$</li>
<li><strong>çŠ¶æ€è½¬ç§»</strong>ï¼šä»ä¸€ä¸ªè¯åˆ°ä¸‹ä¸€ä¸ªè¯ï¼ˆå®é™…ä¸Šæ˜¯ç‹¬ç«‹çš„ï¼Œ$a_{ij} = 1$ï¼‰</li>
<li><strong>å‘å°„æ¦‚ç‡</strong>ï¼šè¯çš„æ¦‚ç‡$P(w_i)$</li>
</ul>
<p><strong>ç®€åŒ–çš„Unigramæ¨¡å‹</strong>ï¼š</p>
<p>ç”±äºå‡è®¾è¯ä¹‹é—´ç‹¬ç«‹ï¼ˆunigramï¼‰ï¼Œä¸å­˜åœ¨çœŸæ­£çš„çŠ¶æ€è½¬ç§»ï¼Œåªæœ‰å‘å°„æ¦‚ç‡ï¼š
\begin{equation}
P(\boldsymbol{w}) = \prod_{i=1}^{K} P(w_i) \tag{6}
\end{equation}</p>
<p><strong>åˆ†è¯é—®é¢˜çš„å½¢å¼åŒ–</strong>ï¼š</p>
<p>ç»™å®šå­—èŠ‚åºåˆ—$\boldsymbol{c} = c_1c_2\cdots c_L$ï¼Œæ‰¾åˆ°æ¦‚ç‡æœ€å¤§çš„åˆ‡åˆ†æ–¹æ¡ˆï¼š
\begin{equation}
\boldsymbol{w}^* = \arg\max_{\boldsymbol{w} \in \Omega(\boldsymbol{c})} P(\boldsymbol{w}) \tag{7}
\end{equation}</p>
<p>å…¶ä¸­$\Omega(\boldsymbol{c})$æ˜¯æ‰€æœ‰èƒ½å¤Ÿå®Œæ•´è¦†ç›–$\boldsymbol{c}$çš„åˆ‡åˆ†æ–¹æ¡ˆçš„é›†åˆã€‚</p>
<h3 id="viterbi_1">äºŒã€Viterbiç®—æ³•ï¼šåŠ¨æ€è§„åˆ’è§£ç </h3>
<h4 id="21_1">2.1 é—®é¢˜è®¾å®š</h4>
<p><strong>ç›®æ ‡</strong>ï¼šç»™å®šè§‚æµ‹åºåˆ—$\boldsymbol{x} = (x_1, \ldots, x_T)$å’ŒHMMå‚æ•°$\lambda$ï¼Œæ‰¾åˆ°æœ€å¯èƒ½çš„çŠ¶æ€åºåˆ—ï¼š
\begin{equation}
\boldsymbol{q}^* = \arg\max_{\boldsymbol{q}} P(\boldsymbol{q} | \boldsymbol{x}, \lambda) = \arg\max_{\boldsymbol{q}} P(\boldsymbol{q}, \boldsymbol{x} | \lambda) \tag{8}
\end{equation}</p>
<p><strong>æœ´ç´ æ–¹æ³•çš„é—®é¢˜</strong>ï¼š</p>
<p>éå†æ‰€æœ‰å¯èƒ½çš„çŠ¶æ€åºåˆ—ï¼Œå…±$N^T$ç§ï¼Œå¤æ‚åº¦æŒ‡æ•°çº§ï¼</p>
<h4 id="22_1">2.2 åŠ¨æ€è§„åˆ’çš„æ€æƒ³</h4>
<p><strong>å…³é”®è§‚å¯Ÿ</strong>ï¼šæœ€ä¼˜è·¯å¾„çš„ä»»ä½•å­è·¯å¾„ä¹Ÿæ˜¯æœ€ä¼˜çš„ï¼ˆæœ€ä¼˜å­ç»“æ„æ€§è´¨ï¼‰ã€‚</p>
<p>å®šä¹‰å˜é‡$\delta_t(i)$ï¼š
\begin{equation}
\delta_t(i) = \max_{q_1, \ldots, q_{t-1}} P(q_1, \ldots, q_{t-1}, q_t = s_i, x_1, \ldots, x_t | \lambda) \tag{9}
\end{equation}</p>
<p><strong>å«ä¹‰</strong>ï¼šåˆ°æ—¶åˆ»$t$ï¼Œä»¥çŠ¶æ€$s_i$ç»“å°¾ï¼Œè§‚æµ‹åºåˆ—ä¸º$x_1, \ldots, x_t$çš„æ‰€æœ‰è·¯å¾„ä¸­ï¼Œæ¦‚ç‡æœ€å¤§çš„è·¯å¾„çš„æ¦‚ç‡ã€‚</p>
<h4 id="23-viterbi_1">2.3 Viterbié€’æ¨å…¬å¼</h4>
<p><strong>åˆå§‹åŒ–</strong>ï¼ˆ$t = 1$ï¼‰ï¼š
\begin{equation}
\delta_1(i) = \pi_i \cdot b_i(x_1), \quad i = 1, \ldots, N \tag{10}
\end{equation}
\begin{equation}
\psi_1(i) = 0 \tag{11}
\end{equation}</p>
<p><strong>é€’æ¨</strong>ï¼ˆ$t = 2, \ldots, T$ï¼‰ï¼š
\begin{equation}
\delta_t(j) = \max_{1 \leq i \leq N} [\delta_{t-1}(i) \cdot a_{ij}] \cdot b_j(x_t) \tag{12}
\end{equation}
\begin{equation}
\psi_t(j) = \arg\max_{1 \leq i \leq N} [\delta_{t-1}(i) \cdot a_{ij}] \tag{13}
\end{equation}</p>
<p>å…¶ä¸­$\psi_t(j)$è®°å½•äº†åˆ°è¾¾çŠ¶æ€$j$çš„æœ€ä¼˜å‰é©±çŠ¶æ€ã€‚</p>
<p><strong>è¯æ˜é€’æ¨å…¬å¼çš„æ­£ç¡®æ€§</strong>ï¼š</p>
<p>\begin{equation}
\begin{aligned}
\delta_t(j) &amp;= \max_{q_1, \ldots, q_{t-1}} P(q_1, \ldots, q_{t-1}, q_t = s_j, x_1, \ldots, x_t | \lambda) \
&amp;= \max_{q_1, \ldots, q_{t-1}} P(q_1, \ldots, q_{t-1}, x_1, \ldots, x_{t-1} | \lambda) \
&amp;\quad \times P(q_t = s_j | q_{t-1}) \times P(x_t | q_t = s_j) \
&amp;= \max_{1 \leq i \leq N} \left[ \max_{q_1, \ldots, q_{t-2}} P(q_1, \ldots, q_{t-2}, q_{t-1} = s_i, x_1, \ldots, x_{t-1}) \right] \
&amp;\quad \times a_{ij} \times b_j(x_t) \
&amp;= \max_{1 \leq i \leq N} [\delta_{t-1}(i) \cdot a_{ij}] \cdot b_j(x_t)
\end{aligned} \tag{14}
\end{equation}</p>
<p><strong>ç»ˆæ­¢</strong>ï¼š
\begin{equation}
P^<em> = \max_{1 \leq i \leq N} \delta_T(i) \tag{15}
\end{equation}
\begin{equation}
q_T^</em> = \arg\max_{1 \leq i \leq N} \delta_T(i) \tag{16}
\end{equation}</p>
<p><strong>å›æº¯</strong>ï¼ˆ$t = T-1, T-2, \ldots, 1$ï¼‰ï¼š
\begin{equation}
q_t^<em> = \psi_{t+1}(q_{t+1}^</em>) \tag{17}
\end{equation}</p>
<h4 id="24-viterbi_1">2.4 å¯¹æ•°ç©ºé—´çš„Viterbiç®—æ³•</h4>
<p><strong>æ•°å€¼ç¨³å®šæ€§é—®é¢˜</strong>ï¼šè¿ä¹˜å¾ˆå¤šå°æ¦‚ç‡ä¼šå¯¼è‡´ä¸‹æº¢ã€‚</p>
<p><strong>è§£å†³æ–¹æ³•</strong>ï¼šåœ¨å¯¹æ•°ç©ºé—´è¿›è¡Œè®¡ç®—ã€‚</p>
<p>å®šä¹‰ï¼š
\begin{equation}
\tilde{\delta}_t(i) = \log \delta_t(i) \tag{18}
\end{equation}</p>
<p>é€’æ¨å…¬å¼å˜ä¸ºï¼š
\begin{equation}
\tilde{\delta}<em 1="1" N="N" _leq="\leq" i="i">t(j) = \max</em>} [\tilde{\delta<em ij="ij">{t-1}(i) + \log a</em>
\end{equation}}] + \log b_j(x_t) \tag{19</p>
<p><strong>å…³é”®å˜åŒ–</strong>ï¼š
- ä¹˜æ³• â†’ åŠ æ³•
- $\max$æ“ä½œä¿æŒä¸å˜</p>
<h3 id="unigramviterbi_1">ä¸‰ã€åº”ç”¨äºUnigramåˆ†è¯çš„Viterbiç®—æ³•</h3>
<h4 id="31-dag_1">3.1 åˆ†è¯çš„DAGè¡¨ç¤º</h4>
<p>ç»™å®šå­—èŠ‚åºåˆ—$\boldsymbol{c} = c_1c_2\cdots c_L$å’Œè¯è¡¨$\mathcal{V}$ã€‚</p>
<p><strong>æ„å»ºDAGï¼ˆæœ‰å‘æ— ç¯å›¾ï¼‰</strong>ï¼š
- <strong>èŠ‚ç‚¹</strong>ï¼šä½ç½®$0, 1, 2, \ldots, L$
- <strong>è¾¹</strong>ï¼šå¦‚æœ$\overline{c_i c_{i+1} \cdots c_j} \in \mathcal{V}$ï¼Œåˆ™å­˜åœ¨è¾¹$(i-1) \to j$
- <strong>è¾¹æƒ</strong>ï¼š$\log P(\overline{c_i \cdots c_j})$</p>
<p><strong>æœ€ä¼˜è·¯å¾„</strong>ï¼šä»èŠ‚ç‚¹0åˆ°èŠ‚ç‚¹$L$çš„æœ€å¤§æƒé‡è·¯å¾„ã€‚</p>
<h4 id="32-viterbiforward-dp_1">3.2 å‰å‘Viterbiç®—æ³•ï¼ˆForward DPï¼‰</h4>
<p>å®šä¹‰$S^*(i)$ï¼šä»ä½ç½®0åˆ°ä½ç½®$i$çš„æœ€ä¼˜è·¯å¾„å¾—åˆ†ã€‚</p>
<p><strong>åˆå§‹åŒ–</strong>ï¼š
\begin{equation}
S^*(0) = 0 \tag{20}
\end{equation}</p>
<p><strong>é€’æ¨</strong>ï¼ˆ$i = 1, 2, \ldots, L$ï¼‰ï¼š
\begin{equation}
S^<em>(i) = \max_{j &lt; i, \overline{c_{j+1}\cdots c_i} \in \mathcal{V}} [S^</em>(j) + \log P(\overline{c_{j+1}\cdots c_i})] \tag{21}
\end{equation}</p>
<p>åŒæ—¶è®°å½•å‰é©±ï¼š
\begin{equation}
\text{prev}(i) = \arg\max_{j &lt; i, \overline{c_{j+1}\cdots c_i} \in \mathcal{V}} [S^*(j) + \log P(\overline{c_{j+1}\cdots c_i})] \tag{22}
\end{equation}</p>
<p><strong>å›æº¯</strong>ï¼š
\begin{equation}
i \gets L; \quad \text{tokens} = [] \
\text{while } i &gt; 0: \
\quad j = \text{prev}(i) \
\quad \text{tokens.append}(\overline{c_{j+1}\cdots c_i}) \
\quad i \gets j \tag{23}
\end{equation}</p>
<h4 id="33-ac_1">3.3 ACè‡ªåŠ¨æœºåŠ é€Ÿ</h4>
<p><strong>é—®é¢˜</strong>ï¼šå¯¹äºæ¯ä¸ªä½ç½®$i$ï¼Œéœ€è¦éå†æ‰€æœ‰$j &lt; i$æ£€æŸ¥æ˜¯å¦å­˜åœ¨è¯ï¼Œå¤æ‚åº¦$O(L^2)$ã€‚</p>
<p><strong>ACè‡ªåŠ¨æœºï¼ˆAho-Corasick Automatonï¼‰</strong>ï¼š</p>
<p>é¢„å¤„ç†è¯è¡¨ï¼Œæ„å»ºå¤±é…æŒ‡é’ˆï¼Œå¯ä»¥åœ¨$O(L)$æ—¶é—´å†…æ‰¾åˆ°æ‰€æœ‰è¯çš„ç»ˆæ­¢ä½ç½®ã€‚</p>
<p><strong>ç®—æ³•æµç¨‹</strong>ï¼š
1. é¢„å¤„ç†ï¼šæ„å»ºACè‡ªåŠ¨æœºï¼ˆ$O(|\mathcal{V}| \cdot \bar{L}_w)$ï¼Œ$\bar{L}_w$æ˜¯å¹³å‡è¯é•¿ï¼‰
2. æ‰«æï¼šç”¨ACè‡ªåŠ¨æœºæ‰«ææ–‡æœ¬ï¼Œæ‰¾åˆ°æ‰€æœ‰å¯èƒ½çš„è¯$(s, e, w)$ï¼ˆèµ·å§‹ã€ç»“æŸã€è¯æœ¬èº«ï¼‰
3. DPï¼šæŒ‰ç»“æŸä½ç½®$e$æ’åºï¼Œä¾æ¬¡è®¡ç®—$S^*(e)$</p>
<p><strong>å¤æ‚åº¦</strong>ï¼š$O(L \cdot m)$ï¼Œå…¶ä¸­$m$æ˜¯è¯è¡¨ä¸­æœ€å¤§è¯é•¿ã€‚</p>
<h4 id="34_1">3.4 ä¼ªä»£ç å®ç°</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">viterbi_decoding</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">vocab</span><span class="p">,</span> <span class="n">prob</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    text: è¾“å…¥å­—èŠ‚åºåˆ—</span>
<span class="sd">    vocab: è¯è¡¨ï¼ˆTrieæˆ–ACè‡ªåŠ¨æœºï¼‰</span>
<span class="sd">    prob: è¯çš„å¯¹æ•°æ¦‚ç‡å‡½æ•°ï¼Œprob(w) = log P(w)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">L</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="c1"># åˆå§‹åŒ–</span>
    <span class="n">S</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)]</span> <span class="o">*</span> <span class="p">(</span><span class="n">L</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">prev</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">L</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">S</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="c1"># ä½¿ç”¨ACè‡ªåŠ¨æœºæ‰¾åˆ°æ‰€æœ‰å¯èƒ½çš„è¯</span>
    <span class="n">candidates</span> <span class="o">=</span> <span class="n">vocab</span><span class="o">.</span><span class="n">find_all_words</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>  <span class="c1"># [(start, end, word), ...]</span>

    <span class="c1"># æŒ‰ç»“æŸä½ç½®åˆ†ç»„</span>
    <span class="n">candidates_by_end</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">:</span>
        <span class="n">candidates_by_end</span><span class="p">[</span><span class="n">end</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">start</span><span class="p">,</span> <span class="n">word</span><span class="p">))</span>

    <span class="c1"># åŠ¨æ€è§„åˆ’</span>
    <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">L</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">candidates_by_end</span><span class="p">[</span><span class="n">e</span><span class="p">]:</span>
            <span class="n">score</span> <span class="o">=</span> <span class="n">S</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">+</span> <span class="n">prob</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">score</span> <span class="o">&gt;</span> <span class="n">S</span><span class="p">[</span><span class="n">e</span><span class="p">]:</span>
                <span class="n">S</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="n">score</span>
                <span class="n">prev</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">word</span><span class="p">)</span>

    <span class="c1"># å›æº¯</span>
    <span class="k">if</span> <span class="n">S</span><span class="p">[</span><span class="n">L</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>  <span class="c1"># æ— æ³•åˆ‡åˆ†</span>

    <span class="n">tokens</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="n">L</span>
    <span class="k">while</span> <span class="n">pos</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">s</span><span class="p">,</span> <span class="n">word</span> <span class="o">=</span> <span class="n">prev</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span>
        <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">s</span>

    <span class="k">return</span> <span class="n">tokens</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</code></pre></div>

<h3 id="-_1">å››ã€å‰å‘-åå‘ç®—æ³•å¯¹æ¯”</h3>
<h4 id="41-forward-algorithm_1">4.1 å‰å‘ç®—æ³•ï¼ˆForward Algorithmï¼‰</h4>
<p><strong>ç›®çš„</strong>ï¼šè®¡ç®—è§‚æµ‹åºåˆ—çš„æ¦‚ç‡$P(\boldsymbol{x}|\lambda)$ã€‚</p>
<p>å®šä¹‰å‰å‘å˜é‡ï¼š
\begin{equation}
\alpha_t(i) = P(x_1, \ldots, x_t, q_t = s_i | \lambda) \tag{24}
\end{equation}</p>
<p><strong>é€’æ¨</strong>ï¼š
\begin{equation}
\alpha_t(j) = \left[\sum_{i=1}^{N} \alpha_{t-1}(i) a_{ij}\right] b_j(x_t) \tag{25}
\end{equation}</p>
<p><strong>ä¸Viterbiçš„å¯¹æ¯”</strong>ï¼š
- å‰å‘ï¼š$\sum$ï¼ˆæ±‚å’Œï¼Œæ‰€æœ‰è·¯å¾„ï¼‰
- Viterbiï¼š$\max$ï¼ˆæœ€å¤§å€¼ï¼Œæœ€ä¼˜è·¯å¾„ï¼‰</p>
<h4 id="42-backward-algorithm_1">4.2 åå‘ç®—æ³•ï¼ˆBackward Algorithmï¼‰</h4>
<p>å®šä¹‰åå‘å˜é‡ï¼š
\begin{equation}
\beta_t(i) = P(x_{t+1}, \ldots, x_T | q_t = s_i, \lambda) \tag{26}
\end{equation}</p>
<p><strong>é€’æ¨</strong>ï¼ˆä»$T$åˆ°$1$ï¼‰ï¼š
\begin{equation}
\beta_t(i) = \sum_{j=1}^{N} a_{ij} b_j(x_{t+1}) \beta_{t+1}(j) \tag{27}
\end{equation}</p>
<h4 id="43-_1">4.3 å‰å‘-åå‘çš„åº”ç”¨</h4>
<p><strong>è¾¹ç¼˜æ¦‚ç‡</strong>ï¼š
\begin{equation}
P(q_t = s_i | \boldsymbol{x}, \lambda) = \frac{\alpha_t(i) \beta_t(i)}{P(\boldsymbol{x}|\lambda)} = \frac{\alpha_t(i) \beta_t(i)}{\sum_{j=1}^{N} \alpha_T(j)} \tag{28}
\end{equation}</p>
<p><strong>è¾¹ç¼˜æ¦‚ç‡ vs Viterbiè·¯å¾„</strong>ï¼š
- è¾¹ç¼˜æ¦‚ç‡ï¼šè€ƒè™‘æ‰€æœ‰è·¯å¾„ï¼Œç»™å‡ºæ¯ä¸ªä½ç½®æ¯ä¸ªçŠ¶æ€çš„æ¦‚ç‡
- Viterbiï¼šåªè€ƒè™‘æœ€ä¼˜è·¯å¾„</p>
<h3 id="viterbi-decodingviterbi-sampling_1">äº”ã€ä»Viterbi Decodingåˆ°Viterbi Sampling</h3>
<h4 id="51_1">5.1 é‡‡æ ·çš„åŠ¨æœº</h4>
<p><strong>Viterbi Decodingçš„å±€é™</strong>ï¼š
1. <strong>ç¡®å®šæ€§</strong>ï¼šæ€»æ˜¯è¾“å‡ºåŒä¸€ä¸ªç»“æœ
2. <strong>è¿‡åº¦è‡ªä¿¡</strong>ï¼šå³ä½¿å¤šä¸ªåˆ‡åˆ†æ–¹æ¡ˆæ¦‚ç‡æ¥è¿‘ï¼Œä¹Ÿåªè¿”å›ä¸€ä¸ª
3. <strong>è®­ç»ƒ-æ¨ç†ä¸ä¸€è‡´</strong>ï¼šè®­ç»ƒæ—¶å¯èƒ½éœ€è¦å¤šæ ·æ€§</p>
<p><strong>Viterbi Samplingçš„ç›®æ ‡</strong>ï¼š
- ä¾æ¦‚ç‡é‡‡æ ·åˆ‡åˆ†æ–¹æ¡ˆ
- æ¦‚ç‡é«˜çš„æ–¹æ¡ˆè¢«é‡‡æ ·åˆ°çš„æ¦‚ç‡å¤§
- ä¿æŒViterbi Decodingçš„æ•ˆç‡ï¼ˆçº¿æ€§å¤æ‚åº¦ï¼‰</p>
<h4 id="52-n-best_1">5.2 æœ´ç´ é‡‡æ ·æ–¹æ³•ï¼šN-bestæœç´¢</h4>
<p><strong>Subword Regularizationçš„åšæ³•</strong>ï¼š</p>
<ol>
<li>æ‰¾åˆ°æ¦‚ç‡æœ€é«˜çš„$n$ä¸ªåˆ‡åˆ†æ–¹æ¡ˆ$\boldsymbol{w}_1^<em>, \ldots, \boldsymbol{w}_n^</em>$</li>
<li>è®¡ç®—æƒé‡ï¼š
   \begin{equation}
   p_i = \frac{P(\boldsymbol{w}_i^<em>)^\alpha}{\sum_{j=1}^{n} P(\boldsymbol{w}_j^</em>)^\alpha} \tag{29}
   \end{equation}</li>
<li>æŒ‰$p_i$è¿›è¡Œé‡‡æ ·</li>
</ol>
<p><strong>N-best Viterbiç®—æ³•</strong>ï¼š</p>
<p>ç»´æŠ¤æ¯ä¸ªä½ç½®çš„top-$n$è·¯å¾„ï¼Œå¤æ‚åº¦$O(nLm)$ï¼Œå…¶ä¸­$m$æ˜¯æœ€å¤§è¯é•¿ã€‚</p>
<p><strong>ç¼ºç‚¹</strong>ï¼š
- æ•ˆç‡ä½ï¼ˆ$n$å€å¤æ‚åº¦ï¼‰
- éœ€è¦é€‰æ‹©$n$ï¼ˆå¤ªå°ï¼šè¦†ç›–ä¸è¶³ï¼›å¤ªå¤§ï¼šæµªè´¹ï¼‰</p>
<h4 id="53-viterbi-sampling_1">5.3 Viterbi Samplingçš„æ ¸å¿ƒæ€æƒ³</h4>
<p><strong>é—®é¢˜é‡æ–°è¡¨è¿°</strong>ï¼š</p>
<p>Viterbi Decodingçš„åˆ¤æ®æ˜¯ï¼š
\begin{equation}
\text{if } \text{score}<em _text_old="\text{old">{\text{new}} &gt; \text{score}</em>
\end{equation}}} \text{ then accept new} \tag{30</p>
<p><strong>éšæœºåŒ–åˆ¤æ®</strong>ï¼š
\begin{equation}
\text{if } \varepsilon &lt; \sigma(\alpha(\text{score}<em _text_old="\text{old">{\text{new}} - \text{score}</em>
\end{equation}}})) \text{ then accept new} \tag{31</p>
<p>å…¶ä¸­ï¼š
- $\varepsilon \sim U[0,1]$ï¼šå‡åŒ€éšæœºæ•°
- $\sigma(x) = 1/(1 + e^{-x})$ï¼šSigmoidå‡½æ•°
- $\alpha &gt; 0$ï¼šæ¸©åº¦å‚æ•°</p>
<p><strong>æ€§è´¨</strong>ï¼š
1. å½“$\text{score}<em _text_old="\text{old">{\text{new}} &gt; \text{score}</em>$æ—¶ï¼Œæ¥å—æ¦‚ç‡$&gt; 0.5$
2. åˆ†æ•°å·®è·è¶Šå¤§ï¼Œæ¥å—æ¦‚ç‡è¶Šæç«¯ï¼ˆæ¥è¿‘0æˆ–1ï¼‰
3. $\alpha \to \infty$æ—¶ï¼Œé€€åŒ–ä¸ºViterbi Decoding}</p>
<h4 id="54-viterbi-sampling_1">5.4 Viterbi Samplingçš„é€’æ¨å…¬å¼</h4>
<p><strong>ä¿®æ”¹Viterbié€’æ¨</strong>ï¼š</p>
<p>åŸæœ¬ï¼š
\begin{equation}
\text{if } S[j] + s(w) &gt; S[i] \text{ then} \
\quad S[i] = S[j] + s(w) \
\quad \text{prev}[i] = (j, w) \tag{32}
\end{equation}</p>
<p>éšæœºåŒ–ä¸ºï¼š
\begin{equation}
\text{score}<em _text_old="\text{old">{\text{new}} = S[j] + s(w) \
\text{score}</em> = S[i] \
p_{\text{accept}} = \sigma(\alpha(\text{score}}<em _text_old="\text{old">{\text{new}} - \text{score}</em>)) \
\text{if } \varepsilon &lt; p_{\text{accept}} \text{ then} \
\quad S[i] = \text{score}_{\text{new}} \
\quad \text{prev}[i] = (j, w) \tag{33}
\end{equation}}</p>
<p><strong>åˆå§‹åŒ–</strong>ï¼š
\begin{equation}
S[i] = -\infty, \quad i = 1, \ldots, L \tag{34}
\end{equation}</p>
<h4 id="55_1">5.5 ä¿åºæ€§åˆ†æ</h4>
<p><strong>å®šä¹‰</strong>ï¼šå¦‚æœåˆ‡åˆ†æ–¹æ¡ˆ$\boldsymbol{w}_1$çš„å¾—åˆ†é«˜äº$\boldsymbol{w}_2$ï¼Œå³$P(\boldsymbol{w}_1) &gt; P(\boldsymbol{w}_2)$ï¼Œé‚£ä¹ˆåœ¨é‡‡æ ·ä¸­$\boldsymbol{w}_1$è¢«é‡‡åˆ°çš„æ¦‚ç‡æ˜¯å¦ä¹Ÿæ›´é«˜ï¼Ÿ</p>
<p><strong>Viterbi Samplingçš„ä¿åºæ€§</strong>ï¼š</p>
<p>ä¸æ˜¯ä¸¥æ ¼ä¿åºçš„ï¼Œä½†è¿‘ä¼¼ä¿åºã€‚</p>
<p><strong>åˆ†æ</strong>ï¼šè€ƒè™‘ä¸¤æ¡è·¯å¾„$A$å’Œ$B$ï¼Œå¾—åˆ†åˆ†åˆ«ä¸º$s_A$å’Œ$s_B$ï¼Œ$s_A &gt; s_B$ã€‚</p>
<p>å¦‚æœä¸¤æ¡è·¯å¾„åœ¨ä½ç½®$i$ç«äº‰ï¼š
\begin{equation}
P(\text{é€‰æ‹©}A) = \sigma(\alpha(s_A - s_B)) &gt; 0.5 \tag{35}
\end{equation}</p>
<p>ä½†æ˜¯ï¼Œå¦‚æœè·¯å¾„æ¶‰åŠå¤šæ­¥ç«äº‰ï¼Œæ¯æ­¥éƒ½æœ‰éšæœºæ€§ï¼Œæœ€ç»ˆçš„æ’åºå¯èƒ½æ”¹å˜ã€‚</p>
<p><strong>å®è¯è§‚å¯Ÿ</strong>ï¼šåœ¨å®é™…åº”ç”¨ä¸­ï¼Œå¾—åˆ†é«˜çš„æ–¹æ¡ˆç¡®å®æ›´å¸¸è¢«é‡‡æ ·åˆ°ï¼Œå°¤å…¶æ˜¯å½“$\alpha$è¾ƒå¤§æ—¶ã€‚</p>
<h3 id="_13">å…­ã€æ•°å€¼ç¨³å®šæ€§ä¸å®ç°æŠ€å·§</h3>
<h4 id="61-logsumexp_1">6.1 LogSumExpæŠ€å·§</h4>
<p>å‰å‘ç®—æ³•æ¶‰åŠåˆ°æ±‚å’Œï¼š
\begin{equation}
\alpha_t(j) = \left[\sum_{i=1}^{N} \alpha_{t-1}(i) a_{ij}\right] b_j(x_t) \tag{36}
\end{equation}</p>
<p>åœ¨å¯¹æ•°ç©ºé—´ï¼š
\begin{equation}
\log \alpha_t(j) = \log \left[\sum_{i=1}^{N} e^{\log \alpha_{t-1}(i) + \log a_{ij}}\right] + \log b_j(x_t) \tag{37}
\end{equation}</p>
<p>ç›´æ¥è®¡ç®—$\sum e^{x_i}$å¯èƒ½æº¢å‡ºã€‚ä½¿ç”¨LogSumExpï¼š
\begin{equation}
\text{LSE}(x_1, \ldots, x_N) = x_{\max} + \log \sum_{i=1}^{N} e^{x_i - x_{\max}} \tag{38}
\end{equation}</p>
<p>å…¶ä¸­$x_{\max} = \max_i x_i$ã€‚</p>
<h4 id="62-sigmoid_1">6.2 Sigmoidçš„æ•°å€¼ç¨³å®šè®¡ç®—</h4>
<p>Sigmoidå‡½æ•°ï¼š
\begin{equation}
\sigma(x) = \frac{1}{1 + e^{-x}} \tag{39}
\end{equation}</p>
<p><strong>é—®é¢˜</strong>ï¼š
- å½“$x$å¾ˆå¤§æ—¶ï¼Œ$e^{-x} \to 0$ï¼Œä½†è®¡ç®—$e^{-x}$å¯èƒ½ä¸‹æº¢
- å½“$x$å¾ˆå°æ—¶ï¼Œ$e^{-x} \to \infty$ï¼Œä¸Šæº¢</p>
<p><strong>ç¨³å®šè®¡ç®—</strong>ï¼š
\begin{equation}
\sigma(x) = \begin{cases}
\frac{1}{1 + e^{-x}}, &amp; x \geq 0 \
\frac{e^x}{1 + e^x}, &amp; x &lt; 0
\end{cases} \tag{40}
\end{equation}</p>
<p><strong>æ¨å¯¼</strong>ï¼š
\begin{equation}
\sigma(x) = \frac{1}{1 + e^{-x}} = \frac{e^x}{e^x + 1} = \frac{e^x}{1 + e^x} \tag{41}
\end{equation}</p>
<p>ä¸¤ç§å½¢å¼ç­‰ä»·ï¼Œä½†æ•°å€¼ç¨³å®šæ€§ä¸åŒã€‚</p>
<h4 id="63_1">6.3 éšæœºæ•°ç”Ÿæˆçš„æ•ˆç‡</h4>
<p>Viterbi Samplingæ¯æ¬¡DPæ›´æ–°éƒ½éœ€è¦ä¸€ä¸ªéšæœºæ•°$\varepsilon \sim U[0,1]$ã€‚</p>
<p><strong>ä¼˜åŒ–æ–¹æ³•</strong>ï¼š
1. <strong>æ‰¹é‡ç”Ÿæˆ</strong>ï¼šé¢„å…ˆç”Ÿæˆä¸€å¤§æ‰¹éšæœºæ•°
2. <strong>å¿«é€ŸRNG</strong>ï¼šä½¿ç”¨Xorshiftç­‰å¿«é€Ÿéšæœºæ•°ç”Ÿæˆå™¨
3. <strong>å‘é‡åŒ–</strong>ï¼šä½¿ç”¨SIMDæŒ‡ä»¤å¹¶è¡Œç”Ÿæˆ</p>
<p><strong>Pythonç¤ºä¾‹</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># é¢„ç”Ÿæˆéšæœºæ•°</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">random_pool</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>
<span class="n">rand_idx</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">def</span><span class="w"> </span><span class="nf">get_random</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">rand_idx</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">random_pool</span><span class="p">[</span><span class="n">rand_idx</span><span class="p">]</span>
    <span class="n">rand_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">rand_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">random_pool</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">r</span>
</code></pre></div>

<h3 id="_14">ä¸ƒã€é‡‡æ ·è´¨é‡åˆ†æ</h3>
<h4 id="71_1">7.1 æœŸæœ›å€¼åˆ†æ</h4>
<p><strong>é—®é¢˜</strong>ï¼šViterbi Samplingé‡‡æ ·åˆ°æŸä¸ªåˆ‡åˆ†æ–¹æ¡ˆ$\boldsymbol{w}$çš„æ¦‚ç‡æ˜¯å¤šå°‘ï¼Ÿ</p>
<p>è¿™æ˜¯ä¸€ä¸ªå¤æ‚çš„é—®é¢˜ï¼Œå› ä¸ºé‡‡æ ·è¿‡ç¨‹æ¶‰åŠå¤šæ­¥éšæœºå†³ç­–ã€‚</p>
<p><strong>è¿‘ä¼¼åˆ†æ</strong>ï¼š</p>
<p>å‡è®¾DPè¿‡ç¨‹ä¸­ï¼Œæ¯ä¸ªä½ç½®ç‹¬ç«‹åšå†³ç­–ï¼ˆè¿™æ˜¯ä¸€ä¸ªç®€åŒ–å‡è®¾ï¼‰ã€‚è®¾ä½ç½®$i$æœ‰$k_i$ä¸ªå€™é€‰è¯ç»“å°¾ï¼Œå¾—åˆ†åˆ†åˆ«ä¸º$s_1^{(i)}, \ldots, s_{k_i}^{(i)}$ã€‚</p>
<p>é‡‡æ ·åˆ°å¾—åˆ†ä¸º$s_j^{(i)}$çš„å€™é€‰çš„æ¦‚ç‡çº¦ä¸ºï¼š
\begin{equation}
p_j^{(i)} \approx \frac{e^{\alpha s_j^{(i)}}}{\sum_{\ell=1}^{k_i} e^{\alpha s_\ell^{(i)}}} \tag{42}
\end{equation}</p>
<p>è¿™ç±»ä¼¼äºSoftmaxï¼</p>
<p>æ•´æ¡è·¯å¾„è¢«é‡‡æ ·åˆ°çš„æ¦‚ç‡ï¼ˆè¿‘ä¼¼ï¼‰ï¼š
\begin{equation}
P_{\text{sample}}(\boldsymbol{w}) \approx \prod_{i \in \boldsymbol{w}} p_j^{(i)} \tag{43}
\end{equation}</p>
<h4 id="72_1">7.2 ä¸çœŸå®æ¦‚ç‡çš„å…³ç³»</h4>
<p><strong>ç†æƒ³æƒ…å†µ</strong>ï¼šæˆ‘ä»¬å¸Œæœ›é‡‡æ ·æ¦‚ç‡æ­£æ¯”äºçœŸå®æ¦‚ç‡ï¼š
\begin{equation}
P_{\text{sample}}(\boldsymbol{w}) \propto P(\boldsymbol{w}) = e^{s(\boldsymbol{w})} \tag{44}
\end{equation}</p>
<p>å…¶ä¸­$s(\boldsymbol{w}) = \sum_{w_i \in \boldsymbol{w}} \log P(w_i)$ã€‚</p>
<p><strong>Viterbi Samplingçš„åå·®</strong>ï¼š</p>
<p>ç”±äºå¤šæ¬¡äºŒé€‰ä¸€çš„ç¨€é‡Šæ•ˆåº”ï¼ˆåé¢çš„å€™é€‰"å ä¾¿å®œ"ï¼‰ï¼ŒViterbi Samplingçš„é‡‡æ ·æ¦‚ç‡ä¸çœŸå®æ¦‚ç‡ä¸å®Œå…¨ä¸€è‡´ã€‚</p>
<p><strong>æ–‡ç« çš„æ”¹è¿›æ–¹å‘</strong>ï¼š
- ä½¿ç”¨æ°´å¡˜é‡‡æ ·ï¼ˆReservoir Samplingï¼‰
- ç¼“å­˜ç´¯ç§¯æ¦‚ç‡
- è¯¦è§ä¸‹ä¸€ç¯‡æ–‡ç« ã€Šéšæœºåˆ†è¯å†æ¢ã€‹</p>
<h4 id="73-alpha_1">7.3 æ¸©åº¦å‚æ•°$\alpha$çš„å½±å“</h4>
<p><strong>$\alpha \to 0$</strong>ï¼š
\begin{equation}
\sigma(\alpha \Delta s) \to \begin{cases}
1, &amp; \Delta s &gt; 0 \
0.5, &amp; \Delta s = 0 \
0, &amp; \Delta s &lt; 0
\end{cases} \tag{45}
\end{equation}</p>
<p>æ¥è¿‘å‡åŒ€é‡‡æ ·ï¼ˆæ‰€æœ‰æ­£åˆ†æ•°å·®éƒ½ä»¥æ¦‚ç‡0.5æ¥å—ï¼‰ã€‚</p>
<p><strong>$\alpha \to \infty$</strong>ï¼š
\begin{equation}
\sigma(\alpha \Delta s) \to \begin{cases}
1, &amp; \Delta s &gt; 0 \
0.5, &amp; \Delta s = 0 \
0, &amp; \Delta s &lt; 0
\end{cases} \tag{46}
\end{equation}</p>
<p>é€€åŒ–ä¸ºViterbi Decodingï¼ˆæ€»æ˜¯é€‰æ‹©åˆ†æ•°é«˜çš„ï¼‰ã€‚</p>
<p><strong>$\alpha = 0.1$ï¼ˆç»éªŒå€¼ï¼‰</strong>ï¼š
- ä¿æŒä¸€å®šçš„éšæœºæ€§
- åŒæ—¶åå‘é«˜åˆ†æ–¹æ¡ˆ
- åœ¨è®­ç»ƒä¸­å¼•å…¥æ­£åˆ™åŒ–æ•ˆæœ</p>
<h3 id="bpe-dropout_1">å…«ã€ä¸BPE Dropoutçš„å¯¹æ¯”</h3>
<h4 id="81-bpe-dropout_1">8.1 BPE Dropout</h4>
<p>BPEï¼ˆByte Pair Encodingï¼‰ä½¿ç”¨è´ªå¿ƒmergeç­–ç•¥ï¼Œæ¯æ¬¡é€‰æ‹©é¢‘ç‡æœ€é«˜çš„å­—èŠ‚å¯¹åˆå¹¶ã€‚</p>
<p><strong>BPE Dropout</strong>ï¼šåœ¨mergeè¿‡ç¨‹ä¸­ï¼Œä»¥æ¦‚ç‡$p$éšæœºè·³è¿‡æŸäº›mergeæ“ä½œã€‚</p>
<p><strong>ç®—æ³•</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">bpe_dropout</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">merge_rules</span><span class="p">,</span> <span class="n">p_dropout</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">merge_rules</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">p_dropout</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">apply_merge</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">rule</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">text</span>
</code></pre></div>

<h4 id="82_1">8.2 å¯¹æ¯”</h4>
<table>
<thead>
<tr>
<th>æ–¹é¢</th>
<th>Viterbi Sampling</th>
<th>BPE Dropout</th>
</tr>
</thead>
<tbody>
<tr>
<td>é€‚ç”¨æ¨¡å‹</td>
<td>Unigram</td>
<td>BPE</td>
</tr>
<tr>
<td>éšæœºåŒ–æ–¹å¼</td>
<td>DPè¿‡ç¨‹ä¸­éšæœºé€‰æ‹©</td>
<td>Mergeè¿‡ç¨‹ä¸­éšæœºè·³è¿‡</td>
</tr>
<tr>
<td>æ¦‚ç‡ä¿è¯</td>
<td>è¿‘ä¼¼æŒ‰æ¦‚ç‡é‡‡æ ·</td>
<td>æ— æ˜ç¡®æ¦‚ç‡ä¿è¯</td>
</tr>
<tr>
<td>å®ç°å¤æ‚åº¦</td>
<td>ä¸­ç­‰</td>
<td>ç®€å•</td>
</tr>
<tr>
<td>æ•ˆç‡</td>
<td>ä¸ç¡®å®šæ€§ç‰ˆæœ¬ç›¸è¿‘</td>
<td>ä¸ç¡®å®šæ€§ç‰ˆæœ¬ç›¸åŒ</td>
</tr>
</tbody>
</table>
<h4 id="83-subword-regularization_1">8.3 Subword Regularizationå¯¹æ¯”</h4>
<p><strong>æ–¹æ³•</strong>ï¼šæ‰¾top-$n$ä¸ªåˆ‡åˆ†æ–¹æ¡ˆï¼ŒæŒ‰æ¦‚ç‡åŠ æƒé‡‡æ ·ã€‚</p>
<p><strong>ä¼˜ç‚¹</strong>ï¼š
- ç²¾ç¡®æŒ‰æ¦‚ç‡é‡‡æ ·
- ç†è®ºä¿è¯å¼º</p>
<p><strong>ç¼ºç‚¹</strong>ï¼š
- æ•ˆç‡ä½ï¼ˆ$n$å€å¤æ‚åº¦ï¼‰
- éœ€è¦è°ƒå‚$n$</p>
<p><strong>Viterbi Samplingçš„ä¼˜åŠ¿</strong>ï¼š
- æ¥è¿‘åŸå§‹æ•ˆç‡
- è‡ªåŠ¨é€‚åº”ï¼ˆæ— éœ€è°ƒ$n$ï¼‰
- å®ç°ç®€å•</p>
<h3 id="_15">ä¹ã€å®é™…åº”ç”¨ä¸æ•ˆæœ</h3>
<h4 id="91_1">9.1 è®­ç»ƒæ•°æ®å¢å¼º</h4>
<p><strong>åº”ç”¨åœºæ™¯</strong>ï¼šè®­ç»ƒè¯­è¨€æ¨¡å‹æ—¶ï¼Œæ¯ä¸ªepochä½¿ç”¨ä¸åŒçš„åˆ†è¯ç»“æœã€‚</p>
<p><strong>æ•ˆæœ</strong>ï¼š
- å¢å¼ºæ¨¡å‹é²æ£’æ€§
- å‡å°‘å¯¹ç‰¹å®šåˆ†è¯çš„è¿‡æ‹Ÿåˆ
- æ”¹å–„out-of-vocabulary (OOV)å¤„ç†</p>
<p><strong>ç¤ºä¾‹</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># è®­ç»ƒæ—¶</span>
<span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_epochs</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">dataset</span><span class="p">:</span>
        <span class="c1"># æ¯æ¬¡ä½¿ç”¨éšæœºåˆ†è¯</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">tokenize</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">random</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">train_step</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>
</code></pre></div>

<h4 id="92_1">9.2 é€Ÿåº¦å¯¹æ¯”</h4>
<p>æ ¹æ®æ–‡ç« çš„å®éªŒæ•°æ®ï¼š</p>
<table>
<thead>
<tr>
<th>æ–¹æ³•</th>
<th>ç¡®å®šæ€§é€Ÿåº¦</th>
<th>éšæœºæ€§é€Ÿåº¦</th>
<th>é€Ÿåº¦æ¯”</th>
</tr>
</thead>
<tbody>
<tr>
<td>SP-BPE</td>
<td>1.36M bytes/sec</td>
<td>1.25M bytes/sec</td>
<td>92%</td>
</tr>
<tr>
<td><strong>SP-Unigram</strong></td>
<td><strong>5.65M bytes/sec</strong></td>
<td><strong>1.28M bytes/sec</strong></td>
<td><strong>23%</strong></td>
</tr>
<tr>
<td>BytePiece (Viterbi Sampling)</td>
<td>1.95M bytes/sec</td>
<td>1.36M bytes/sec</td>
<td><strong>70%</strong></td>
</tr>
</tbody>
</table>
<p><strong>è§‚å¯Ÿ</strong>ï¼š
- Subword Regularization (SP-Unigraméšæœºç‰ˆ)é€Ÿåº¦ä¸‹é™åˆ°23%
- Viterbi Samplingä¿æŒ70%çš„é€Ÿåº¦
- <strong>3å€åŠ é€Ÿ</strong>ï¼</p>
<h4 id="93_1">9.3 åˆ†è¯å¤šæ ·æ€§</h4>
<p><strong>å®éªŒ</strong>ï¼ˆä»æ–‡ç« ï¼‰ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;ä»Šå¤©å¤©æ°”ä¸é”™&#39;</span>

<span class="c1"># ç¡®å®šæ€§åˆ†è¯</span>
<span class="nb">print</span><span class="p">(</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">tokenize</span><span class="p">(</span><span class="n">text</span><span class="p">))</span>
<span class="c1"># [b&#39;\xe4\xbb\x8a\xe5\xa4\xa9&#39;, b&#39;\xe5\xa4\xa9\xe6\xb0\x94&#39;, b&#39;\xe4\xb8\x8d\xe9\x94\x99&#39;]</span>

<span class="c1"># Viterbi Sampling (alpha=0.1)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">tokenize</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">))</span>
<span class="c1"># [b&#39;\xe4\xbb\x8a\xe5\xa4\xa9&#39;, b&#39;\xe5\xa4\xa9\xe6&#39;, b&#39;\xb0\x94&#39;, b&#39;\xe4\xb8\x8d\xe9\x94\x99&#39;]</span>
<span class="c1"># [b&#39;\xe4\xbb\x8a\xe5\xa4\xa9&#39;, b&#39;\xe5\xa4\xa9\xe6\xb0\x94&#39;, b&#39;\xe4\xb8\x8d\xe9\x94\x99&#39;]</span>
<span class="c1"># [b&#39;\xe4\xbb\x8a\xe5\xa4\xa9&#39;, b&#39;\xe5\xa4\xa9\xe6\xb0\x94&#39;, b&#39;\xe4\xb8&#39;, b&#39;\x8d&#39;, b&#39;\xe9\x94&#39;, b&#39;\x99&#39;]</span>
<span class="c1"># [b&#39;\xe4\xbb\x8a\xe5\xa4\xa9&#39;, b&#39;\xe5\xa4\xa9&#39;, b&#39;\xe6\xb0\x94&#39;, b&#39;\xe4\xb8\x8d\xe9\x94\x99&#39;]</span>
<span class="c1"># [b&#39;\xe4\xbb&#39;, b&#39;\x8a\xe5\xa4\xa9&#39;, b&#39;\xe5\xa4\xa9&#39;, b&#39;\xe6\xb0\x94\xe4\xb8\x8d&#39;, b&#39;\xe9\x94&#39;, b&#39;\x99&#39;]</span>
</code></pre></div>

<p><strong>åˆ†æ</strong>ï¼š
- ç¡®å®šæ€§ç‰ˆæœ¬æ€»æ˜¯è¾“å‡ºåŒä¸€ç»“æœ
- éšæœºç‰ˆæœ¬äº§ç”Ÿå¤šç§åˆ‡åˆ†
- æŸäº›å¸¸è§åˆ‡åˆ†å‡ºç°é¢‘ç‡æ›´é«˜ï¼ˆå¦‚"ä»Šå¤©"ã€"å¤©æ°”"ï¼‰</p>
<h3 id="_16">åã€ç†è®ºä¿è¯ä¸å±€é™æ€§</h3>
<h4 id="101-viterbi-sampling_1">10.1 Viterbi Samplingçš„ç†è®ºæ€§è´¨</h4>
<p><strong>æ€§è´¨1ï¼ˆè¿‘ä¼¼ä¿åºï¼‰</strong>ï¼šé«˜åˆ†åˆ‡åˆ†æ–¹æ¡ˆè¢«é‡‡æ ·åˆ°çš„æ¦‚ç‡æ›´å¤§ã€‚</p>
<p><strong>æ€§è´¨2ï¼ˆæ•ˆç‡ï¼‰</strong>ï¼šå¤æ‚åº¦ä¸Viterbi Decodingç›¸åŒï¼Œéƒ½æ˜¯$O(Lm)$ã€‚</p>
<p><strong>æ€§è´¨3ï¼ˆå¯æ§éšæœºæ€§ï¼‰</strong>ï¼šé€šè¿‡$\alpha$æ§åˆ¶éšæœºæ€§å¼ºåº¦ã€‚</p>
<h4 id="102_1">10.2 æœªè§£å†³çš„é—®é¢˜</h4>
<p><strong>é—®é¢˜1</strong>ï¼šé‡‡æ ·æ¦‚ç‡çš„ç²¾ç¡®è¡¨è¾¾å¼æ˜¯ä»€ä¹ˆï¼Ÿ</p>
<p>ç›®å‰åªæœ‰è¿‘ä¼¼åˆ†æï¼Œç¼ºä¹ç²¾ç¡®çš„æ¦‚ç‡åˆ†å¸ƒã€‚</p>
<p><strong>é—®é¢˜2</strong>ï¼šå¦‚ä½•ä¿è¯é‡‡æ ·çš„æ— åæ€§ï¼Ÿ</p>
<p>Viterbi Samplingç”±äºç¨€é‡Šæ•ˆåº”ï¼Œä¸æ˜¯ä¸¥æ ¼æŒ‰$P(\boldsymbol{w})$é‡‡æ ·ã€‚</p>
<p><strong>è§£å†³æ–¹å‘</strong>ï¼š
- æ°´å¡˜é‡‡æ ·ï¼ˆä¸‹ä¸€ç¯‡æ–‡ç« ï¼‰
- åŸºäºCDFçš„é€†å˜æ¢é‡‡æ ·</p>
<h4 id="103_1">10.3 é€‚ç”¨åœºæ™¯</h4>
<p><strong>é€‚åˆ</strong>ï¼š
- éœ€è¦å¿«é€Ÿéšæœºåˆ†è¯
- è®­ç»ƒæ•°æ®å¢å¼º
- è½»é‡çº§æ­£åˆ™åŒ–</p>
<p><strong>ä¸é€‚åˆ</strong>ï¼š
- éœ€è¦ç²¾ç¡®æ¦‚ç‡åˆ†å¸ƒçš„åœºæ™¯
- ç†è®ºåˆ†æè¦æ±‚ä¸¥æ ¼æ— åé‡‡æ ·</p>
<h3 id="_17">åä¸€ã€æ€»ç»“</h3>
<p>Viterbiç®—æ³•æ˜¯åºåˆ—æ ‡æ³¨å’Œåˆ†è¯é—®é¢˜çš„æ ¸å¿ƒç®—æ³•ï¼Œé€šè¿‡åŠ¨æ€è§„åˆ’åœ¨çº¿æ€§æ—¶é—´å†…æ‰¾åˆ°æœ€ä¼˜è·¯å¾„ã€‚</p>
<p><strong>Viterbi Decoding</strong>ï¼š
\begin{equation}
S^<em>(i) = \max_{j &lt; i} [S^</em>(j) + \log P(w_{j+1:i})] \tag{47}
\end{equation}</p>
<p><strong>Viterbi Samplingï¼ˆåˆæ­¥ç‰ˆæœ¬ï¼‰</strong>ï¼š
\begin{equation}
\text{accept new if } \varepsilon &lt; \sigma(\alpha \cdot \Delta s) \tag{48}
\end{equation}</p>
<p><strong>ä¼˜åŠ¿</strong>ï¼š
- âœ… ä¿æŒçº¿æ€§å¤æ‚åº¦
- âœ… å¼•å…¥éšæœºæ€§
- âœ… å®ç°ç®€å•
- âœ… é€Ÿåº¦å¿«ï¼ˆç›¸æ¯”Subword Regularizationï¼‰</p>
<p><strong>å±€é™</strong>ï¼š
- âŒ é‡‡æ ·æ¦‚ç‡ä¸ç²¾ç¡®
- âŒ ç¨€é‡Šæ•ˆåº”ï¼ˆåç»­å€™é€‰å ä¾¿å®œï¼‰
- âŒ ç†è®ºä¿è¯ä¸è¶³</p>
<p><strong>ä¸‹ä¸€æ­¥</strong>ï¼šåœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ã€Šéšæœºåˆ†è¯å†æ¢ã€‹ä¸­ï¼Œæˆ‘ä»¬å°†è§£å†³ç¨€é‡Šæ•ˆåº”ï¼Œé€šè¿‡æ°´å¡˜é‡‡æ ·å®ç°å®Œç¾é‡‡æ ·ï¼Œè¾¾åˆ°ä¸Subword Regularizationç­‰ä»·çš„æ•ˆæœï¼ŒåŒæ—¶ä¿æŒé«˜æ•ˆç‡ã€‚</p>
        </div>
    </div>
</body>
</html>