<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MoEç¯æ¸¸è®°ï¼š2ã€ä¸æ‚£å¯¡è€Œæ‚£ä¸å‡</title>
    <style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    line-height: 1.6; color: #333; max-width: 900px; margin: 0 auto; padding: 20px; background: #f5f5f5;
}
.container { background: white; padding: 40px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
header { border-bottom: 2px solid #e0e0e0; padding-bottom: 20px; margin-bottom: 30px; }
h1 { color: #2c3e50; margin-bottom: 10px; font-size: 2em; }
.meta { color: #666; font-size: 0.9em; margin-bottom: 20px; }
.content { margin-top: 30px; overflow-wrap: break-word; }
.content h2 { color: #34495e; margin-top: 30px; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
.content p { margin-bottom: 15px; }
.content pre { background: #f8f8f8; padding: 15px; border-radius: 5px; overflow-x: auto; border-left: 3px solid #3498db; margin: 15px 0; }
.content code { background: #f8f8f8; padding: 2px 5px; border-radius: 3px; font-family: monospace; font-size: 0.9em; }
.content blockquote { border-left: 4px solid #3498db; padding-left: 20px; margin: 20px 0; color: #555; font-style: italic; }
.content table { border-collapse: collapse; width: 100%; margin: 20px 0; }
.content th, .content td { border: 1px solid #ddd; padding: 10px; text-align: left; }
.back-link { display: inline-block; margin-bottom: 20px; color: #3498db; text-decoration: none; font-weight: 500; }
</style>
    
<script>
    window.MathJax = {
        tex: {
            inlineMath: [['$', '$'], ['\(', '\)']],
            displayMath: [['$$', '$$'], ['\[', '\]']],
            processEscapes: true
        }
    };
</script>
<script id="MathJax-script" async src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>

</head>
<body>
    <div class="container">
        <a href="../index.html" class="back-link">â† è¿”å›é¦–é¡µ</a>
        <header>
            <h1>MoEç¯æ¸¸è®°ï¼š2ã€ä¸æ‚£å¯¡è€Œæ‚£ä¸å‡</h1>
            <div class="meta">ğŸ“… æœ€åæ›´æ–°: 2025-11-26 | ğŸ“„ å¤§å°: 59.7 KB</div>
        </header>
        <div class="content">
            <p><strong>åŸæ–‡é“¾æ¥</strong>: <a href="https://spaces.ac.cn/archives/10735">https://spaces.ac.cn/archives/10735</a></p>
<p><strong>å‘å¸ƒæ—¥æœŸ</strong>: </p>
<hr />
<p>åœ¨ä¸Šä¸€ç¯‡æ–‡ç« <a href="/archives/10699">ã€ŠMoEç¯æ¸¸è®°ï¼š1ã€ä»å‡ ä½•æ„ä¹‰å‡ºå‘ã€‹</a>ä¸­ï¼Œæˆ‘ä»¬ä»‹ç»äº†MoEçš„ä¸€ä¸ªå‡ ä½•è¯ é‡Šï¼Œæ—¨åœ¨é€šè¿‡Denseæ¨¡å‹çš„æœ€ä½³é€¼è¿‘å‡ºå‘æ¥æ¨å¯¼å’Œç†è§£MoEã€‚åŒæ—¶åœ¨æ–‡æœ«æˆ‘ä»¬ä¹Ÿè¯´äº†ï¼Œç»™å‡ºMoEçš„è®¡ç®—å…¬å¼ä»…ä»…æ˜¯å¼€å§‹ï¼Œè®­ç»ƒä¸€ä¸ªå®é™…æœ‰æ•ˆçš„MoEæ¨¡å‹è¿˜æœ‰å¾ˆå¤šç»†èŠ‚è¡¥ï¼Œæ¯”å¦‚æœ¬æ–‡è¦è®¨è®ºçš„è´Ÿè½½å‡è¡¡ï¼ˆLoad Balanceï¼‰é—®é¢˜ã€‚</p>
<p>è´Ÿè½½å‡è¡¡ï¼Œå³â€œä¸æ‚£å¯¡è€Œæ‚£ä¸å‡â€ï¼Œè¯´ç™½äº†å°±æ˜¯è®©æ¯ä¸ªExpertéƒ½åœ¨å¹²æ´»ï¼Œå¹¶ä¸”éƒ½åœ¨å¹²å°½å¯èƒ½ä¸€æ ·å¤šçš„æ´»ï¼Œé¿å…æŸäº›Expertæµªè´¹ç®—åŠ›ã€‚è´Ÿè½½å‡è¡¡æ—¢æ˜¯å……åˆ†åˆ©ç”¨è®­ç»ƒç®—åŠ›çš„éœ€æ±‚ï¼Œä¹Ÿæ˜¯å°½å¯èƒ½å‘æŒ¥MoEå¤§å‚æ•°é‡æ½œåŠ›çš„éœ€æ±‚ã€‚</p>
<h2 id="_1">éœ€æ±‚åˆ†æ</h2>
<p>æˆ‘ä»¬çŸ¥é“ï¼ŒMoEçš„åŸºæœ¬å½¢å¼æ˜¯<br />
\begin{equation}\boldsymbol{y} = \sum_{i\in \mathop{\text{argtop}}_k \boldsymbol{\rho}} \rho_i \boldsymbol{e}_i\end{equation}<br />
å¯¹äºä¼ ç»ŸMoEï¼Œ$\boldsymbol{\rho}$æ˜¯ä¸€ä¸ªæ¦‚ç‡åˆ†å¸ƒï¼ˆRouterï¼‰ï¼Œ$\boldsymbol{e}_i=\boldsymbol{v}_i$ï¼Œ$\boldsymbol{v}_i$æ˜¯ä¸€ä¸ªå°å‹FFNï¼ˆExpertï¼‰çš„è¾“å‡ºï¼›è€Œå¯¹äºæˆ‘ä»¬ä¸Šä¸€ç¯‡æ¨å¯¼çš„å‡ ä½•MoEï¼Œ$\boldsymbol{\rho}$æ²¡æœ‰å½’ä¸€åŒ–çš„è¦æ±‚ï¼Œå®ƒé¢„æµ‹çš„æ˜¯Expertçš„æ¨¡é•¿ï¼Œè€Œ$\boldsymbol{e}_i=\boldsymbol{v}_i/\Vert\boldsymbol{v}_i\Vert$é¢„æµ‹çš„æ˜¯Expertçš„æ–¹å‘ã€‚</p>
<p>ä¸ç®¡å“ªç§æ ¼å¼çš„MoEï¼Œå®é™…è¡¨ç°éƒ½å·®ä¸å¤šï¼Œåªæ˜¯ç†è§£è§†è§’çš„ä¸åŒã€‚ä½†è¦æ³¨æ„ï¼Œè™½ç„¶MoEçš„å…¬å¼ç»™äººçš„æ„Ÿè§‰æ˜¯â€œæ¯é‡åˆ°ä¸€ä¸ªTokenï¼Œå°±å»æ‰¾ç›¸åº”çš„Expertæ¥è®¡ç®—â€ï¼Œä½†å®é™…è®­ç»ƒæ—¶å…¶å®æ˜¯åè¿‡æ¥çš„ï¼šå…ˆç»™æ¯ä¸ªExpertåˆ†é…å¥½ç›¸åº”çš„ç®—åŠ›ï¼Œç„¶åå°†Tokenåˆ†é…ï¼ˆRouteï¼‰åˆ°æ‰€å±çš„Expertä¸­å¹¶è¡Œè®¡ç®—ï¼Œè¿™ä¹Ÿå°±ä¸ºä»€ä¹ˆè´Ÿè´£æ‰“åˆ†çš„$\boldsymbol{\rho}$è¢«ç§°ä¸ºRouterã€‚</p>
<p>è¿™æ ·ä¸€æ¥ï¼Œå¦‚æœExpertçš„åˆ†é…ä¸å‡è¡¡ï¼Œå°±å¯èƒ½å‡ºç°å¦‚ä¸‹å±€é¢ï¼šæŸäº›Expertï¼ˆDead Expertï¼‰å‡ ä¹ä¸€ç›´é—²ç½®ï¼Œæµªè´¹ç®—åŠ›ï¼›æŸäº›Expertè¦å¤„ç†çš„Tokenå¤ªå¤šï¼Œæ ¹æœ¬å¿™ä¸è¿‡æ¥ï¼Œåªèƒ½Token Dropï¼ˆå³æ”¾å¼ƒå¤„ç†éƒ¨åˆ†Tokenï¼‰ã€‚ä»ç†è®ºä¸Šæ¥è¯´ï¼Œå‡ºç°Dead Expertæ„å‘³ç€MoEæ²¡æœ‰è¾¾åˆ°é¢„æœŸçš„å‚æ•°é‡ï¼Œå³èŠ±äº†å¤§å‚æ•°é‡çš„æ˜¾å­˜ï¼Œç»“æœåªè®­å‡ºæ¥å°å‚æ•°é‡çš„æ•ˆæœã€‚</p>
<p>æ‰€ä»¥ï¼Œä¸ç®¡æ˜¯ä»è®­ç»ƒè¿˜æ˜¯æ€§èƒ½è§’åº¦çœ‹ï¼Œæˆ‘ä»¬éƒ½å¸Œæœ›ä¿è¯Expertçš„è´Ÿè½½å‡è¡¡ã€‚</p>
<h2 id="_2">è¾…åŠ©æŸå¤±</h2>
<p>ä¿ƒè¿›è´Ÿè½½å‡è¡¡çš„å¸¸è§„æ€è·¯æ˜¯æ·»åŠ ä¸ä¹‹ç›¸å…³çš„æŸå¤±å‡½æ•°ï¼Œæˆ‘ä»¬é€šå¸¸ç§°ä¹‹ä¸ºâ€œAux Lossï¼ˆAuxiliary Lossï¼‰â€ï¼Œç›®å‰ä¸»æµç”¨çš„Aux Lossæœ€æ—©å¯ä»¥è¿½æº¯åˆ°2020å¹´çš„<a href="https://papers.cool/arxiv/2006.16668">ã€ŠGShard: Scaling Giant Models with Conditional Computation and Automatic Shardingã€‹</a>ã€‚</p>
<p>ä»‹ç»Aux Lossä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆå¼•å…¥ä¸€äº›æ–°æ¦‚å¿µã€‚é¦–å…ˆï¼Œæˆ‘ä»¬å·²ç»æåˆ°å¯¹äºä¸€èˆ¬çš„MoEæ¥è¯´ï¼Œ$\boldsymbol{\rho}$æœªå¿…æ˜¯æ¦‚ç‡åˆ†å¸ƒï¼Œæˆ‘ä»¬å°†å½’ä¸€åŒ–çš„$\boldsymbol{\rho}$è®°ä¸º$\boldsymbol{p}=[p_1,p_2,\cdots,p_n]$ï¼Œä»¥åŠå®ƒTop-$k$ç‰ˆä¸º$\boldsymbol{f}=[f_1,f_2,\cdots,f_n]$ï¼Œå…¶ä¸­<br />
\begin{equation}p_i = \frac{\rho_i}{\sum_{i=1}^n \rho_i},\qquad f_i = \left\{\begin{aligned}1/k, \quad i\in \mathop{\text{argtop}}\nolimits_k \boldsymbol{\rho} \\\<br />
0, \quad i\not\in \mathop{\text{argtop}}\nolimits_k \boldsymbol{\rho}\end{aligned}\right.\end{equation}<br />
æ¥ç€æˆ‘ä»¬å®šä¹‰$\boldsymbol{P}=\mathbb{E}[\boldsymbol{p}],\boldsymbol{F}=\mathbb{E}[\boldsymbol{f}]$ï¼Œè¿™é‡Œçš„$\mathbb{E}$æ˜¯æŒ‡å¯¹æ‰€æœ‰æ ·æœ¬çš„æ‰€æœ‰Tokenåšå¹³å‡ã€‚ä¸éš¾çœ‹å‡ºï¼Œ$\boldsymbol{F}$å°±æ˜¯Expertå½“å‰çš„è´Ÿè½½åˆ†å¸ƒï¼Œè€Œ$\boldsymbol{P}$åˆ™ç›¸å½“äº$\boldsymbol{F}$çš„ä¸€ä¸ªå…‰æ»‘è¿‘ä¼¼ã€‚</p>
<p>æœ‰äº†è¿™äº›è®°å·ï¼Œæˆ‘ä»¬å°±å¯ä»¥å†™å‡ºAux Lossä¸ºï¼š<br />
\begin{equation}\mathcal{L}<em i="1">{\text{aux}} = \boldsymbol{F}\cdot \boldsymbol{P} = \sum</em>}^n F_i P_i\label{eq:aux-loss}\end{equation<br />
ä¸€èˆ¬æ–‡çŒ®å®šä¹‰Aux Lossä¼šå¤šä¹˜ä¸€ä¸ª$n$ï¼Œå³å®ƒä»¬çš„Aux Lossç­‰äºè¿™é‡Œçš„$n \mathcal{L}_{\text{aux}}$ã€‚æ­¤å¤–ï¼Œæœ‰äº›å¤§å‹MoEå¯èƒ½ä¼šæŒ‰è®¾å¤‡æ¥ç®—Aux Lossï¼Œä»¥è¾¾åˆ°è®¾å¤‡å†…çš„å‡è¡¡ï¼Œå‡å°‘è®¾å¤‡é—´çš„é€šä¿¡ï¼Œè¿™äº›å°±å„è‡ªå‘æŒ¥äº†ã€‚ä½†ä¹Ÿæœ‰è¾ƒæ–°çš„å®éªŒæ˜¾ç¤ºï¼Œå¼ºè¡Œå±€éƒ¨å‡è¡¡ææœ‰å¯èƒ½å½±å“æ¨¡å‹æœ€ç»ˆæ•ˆæœã€‚</p>
<h2 id="_3">ç›´é€šä¼°è®¡</h2>
<p>ä¸çŸ¥é“å¤§å®¶æœ‰æ²¡æœ‰å‘ç°ä¸€ä¸ªå¥‡æ€ªçš„ç°è±¡ï¼šä¸ç®¡æ˜¯æœ€æ—©å‡ºå¤„ã€åç»­æ–‡çŒ®è¿˜æ˜¯ç§‘æ™®æ–‡ç« ï¼Œæ€»ä¹‹ç¬”è€…é˜…è¯»è¿‡çš„èµ„æ–™ä¸­ï¼Œå¯¹Aux Lossçš„å¼•ç”¨éƒ½æ˜¯ä¸åŠ è¯æ˜çš„ï¼Œä¼¼ä¹å¤§å®¶éƒ½å…¬è®¤ä¸Šè¿°Aux Lossèƒ½ä¿ƒè¿›å‡è¡¡æ˜¯ä¸€ä»¶æ˜¾ç„¶æˆç«‹çš„äº‹æƒ…ã€‚å¯çœŸæœ‰è¿™ä¹ˆæ˜¾ç„¶æ˜“å¾—å—ï¼Ÿ</p>
<p>åæ­£ç¬”è€…æ˜¯æ²¡çœ‹å‡ºæ¥ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥ç¬”è€…ç»™å‡ºå¼$\eqref{eq:aux-loss}$çš„ä¸€ç§æ¨å¯¼æ€è·¯ï¼Œç”±æ­¤æ€è·¯æˆ‘ä»¬è¿˜å¯ä»¥è‡ªå®šä¹‰å…¶ä»–å½¢å¼çš„Aux Lossã€‚é¦–å…ˆï¼Œå®šä¹‰å‡åŒ€åˆ†å¸ƒ$\boldsymbol{Q}=(1/n,1/n,\cdots,1/n)$ï¼Œåˆšæ‰æˆ‘ä»¬è¯´äº†$\boldsymbol{F}$å°±æ˜¯å½“å‰è´Ÿè½½åˆ†å¸ƒï¼Œå› æ­¤è´Ÿè½½å‡è¡¡ç­‰ä»·äº$\boldsymbol{F}=\boldsymbol{Q}$ï¼Œé‚£ä¹ˆä¸‹å¼å°±æ˜¯ä¸€ä¸ªæ¯”è¾ƒç›´è§‚çš„Aux Lossï¼š<br />
\begin{equation}\mathcal{L}<em i="1">{\text{aux}} = \frac{1}{2}\Vert\boldsymbol{F} - \boldsymbol{Q}\Vert^2 = \frac{1}{2}\sum</em>}^n (F_i - 1/n)^2\label{eq:aux-loss-2}\end{equation<br />
é—®é¢˜æ˜¯$\boldsymbol{F}$æ˜¯ç”±$\mathop{\text{argtop}}<em _text_aux="\text{aux">k$å‡ºæ¥çš„ï¼Œè¿™æ„å‘³ç€ä¸Šå¼å¹¶ä¸æ˜¯ä¸€ä¸ªèƒ½ç›´æ¥ç”¨çš„å¯å¯¼ç›®æ ‡ã€‚æ€ä¹ˆè§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿç­”æ¡ˆæ˜¯<a href="/archives/6760#%E8%87%AA%E8%A1%8C%E8%AE%BE%E8%AE%A1%E6%A2%AF%E5%BA%A6">STEï¼ˆStraight-Through Estimatorï¼‰</a>æŠ€å·§ï¼Œåˆ†åˆ«è®¾è®¡å‰å‘ä¼ æ’­å’Œåå‘ä¼ æ’­çš„å‡½æ•°ã€‚å…·ä½“æ¥è¯´ï¼Œ$\boldsymbol{F}$ä¸å¯å¯¼ï¼Œ$\boldsymbol{P}$ä½œä¸ºå®ƒçš„å…‰æ»‘è¿‘ä¼¼æ˜¯å¯å¯¼çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬åœ¨åå‘ä¼ æ’­çš„æ—¶å€™å°†$\boldsymbol{F}$æ›¿æ¢æˆ$\boldsymbol{P}$å°±è¡Œäº†ï¼Œå³<br />
\begin{equation}\mathcal{L}</em>}} = \frac{1}{2}\Vert \boldsymbol{P} + \text{sg}[\boldsymbol{F}-\boldsymbol{P}] - \boldsymbol{Q}\Vert^2 = \frac{1}{2}\sum_{i=1}^n (P_i + \text{sg}[F_i - P_i] - 1/n)^2\label{eq:aux-loss-3}\end{equation<br />
å…¶ä¸­$\text{sg}[]$æ˜¯stop gradientç®—å­ï¼Œç‰¹ç‚¹æ˜¯ä¿æŒå‰å‘è¾“å‡ºä¸å˜ï¼Œä½†å¼ºåˆ¶æ¢¯åº¦ä¸ºé›¶ã€‚è¿™æ ·æ”¹åŠ¨ä¹‹åï¼Œ$\mathcal{L}<em _boldsymbol_theta="\boldsymbol{\theta">{\text{aux}}$å°±æ˜¯ä¸€ä¸ªåˆ‡å®å¯è¡Œçš„Aux Lossäº†ï¼Œæˆ‘ä»¬å¯ä»¥è¯•æ±‚ä¸€ä¸‹å®ƒçš„æ¢¯åº¦ï¼š<br />
\begin{equation}\begin{aligned}<br />
\nabla</em>}}\mathcal{L<em _boldsymbol_theta="\boldsymbol{\theta">{\text{aux}} =&amp;\, \frac{1}{2}\nabla</em>[F_i - P_i] - 1/n)^2 \\\}}\sum_{i=1}^n (P_i + \text{sg<br />
=&amp;\, \sum_{i=1}^n (P_i + \text{sg}[F_i - P_i] - 1/n) \nabla_{\boldsymbol{\theta}}(P_i + \text{sg}[F_i - P_i] - 1/n)\\\<br />
=&amp;\, \sum_{i=1}^n (F_i - 1/n) \nabla_{\boldsymbol{\theta}}P_i = \nabla_{\boldsymbol{\theta}}\sum_{i=1}^n (F_i - 1/n) P_i\\\<br />
=&amp;\, \nabla_{\boldsymbol{\theta}}\left(\sum_{i=1}^n F_i P_i\right)<br />
\end{aligned}\end{equation}<br />
è¿™é‡Œ$\boldsymbol{\theta}$æ˜¯æ¨¡å‹å‚æ•°ã€‚æœ€åçš„ç»“æœè¡¨æ˜å¼$\eqref{eq:aux-loss-3}$çš„æ¢¯åº¦ç­‰äºå¼$\eqref{eq:aux-loss}$æ¢¯åº¦ï¼Œè¿™æ„å‘³ç€ç”¨å¼$\eqref{eq:aux-loss}$ä½œä¸ºAux Lossè·Ÿå¼$\eqref{eq:aux-loss-3}$åœ¨æ¢¯åº¦ä¸Šæ˜¯ç­‰ä»·çš„ï¼Œæ‰€ä»¥å°±å‡ºç°äº†å¼$\eqref{eq:aux-loss}$çš„Aux Lossã€‚</p>
<p>ç„¶è€Œï¼Œå¼$\eqref{eq:aux-loss}$åªæœ‰ç­‰æ•ˆæ¢¯åº¦çš„æ„ä¹‰ï¼Œä½†æ²¡æœ‰Lossçš„æ„ä¹‰ï¼Œä¸ç®—ä¸€ä¸ªçœŸæ­£çš„Lossï¼Œæ¯”å¦‚å½“$\boldsymbol{F} = \boldsymbol{P}$æ—¶æˆ‘ä»¬å¯ä»¥ç®—å‡ºå¼$\eqref{eq:aux-loss}$ç­‰äº$1/n$ï¼Œä½†å®é™…ä¸Šæˆ‘ä»¬å¯ä»¥æ„é€ å‡ºä¸€ä¸ªä¸ç­‰äº$\boldsymbol{P}$çš„$\boldsymbol{F}$è®©å®ƒå°äº$1/n$ï¼Œæ‰€ä»¥å¼$\eqref{eq:aux-loss}$å¹¶ä¸æ˜¯åƒæ­£å¸¸çš„Lossä¸€æ ·è¶Šå°è¶Šå¥½ï¼Œæœ€å°å€¼ä¹Ÿä¸æ˜¯$\boldsymbol{F} = \boldsymbol{P}$æ—¶å–åˆ°ã€‚</p>
<h2 id="_4">ä¸€èˆ¬å½¢å¼</h2>
<p>ä¸Šè¿°æ¨å¯¼å®é™…ä¸Šæä¾›äº†æ„å»ºAux Lossçš„ä¸€èˆ¬æ€è·¯ï¼š<strong>é¦–å…ˆåŸºäº$\boldsymbol{F}$æ„å»ºç¬¦åˆè¦æ±‚çš„æŸå¤±ï¼Œç„¶ååœ¨å®ç°æ—¶å°†$\boldsymbol{F}$æ›¿æ¢æˆ$\boldsymbol{P} + \text{sg}[\boldsymbol{F}-\boldsymbol{P}]$ã€‚</strong> æ¯”å¦‚ï¼Œæˆ‘ä»¬çŸ¥é“æœ€å¤§ç†µä¹Ÿå¯ä»¥å°†åˆ†å¸ƒæ¨å‘å‡è¡¡ï¼Œå› æ­¤ä¹Ÿå¯ä»¥ç”¨ç†µçš„ç›¸åæ•°æ¥æ„å»ºAux Lossï¼š<br />
\begin{equation}\mathcal{L}<em i="1">{\text{aux}} = \sum</em>}^n (P_i + \text{sg}[F_i - P_i])\log(P_i + \text{sg}[F_i - P_i])\end{equation<br />
ä¸Šå¼å°±å¯ä»¥ç›´æ¥ç”¨ä½œä»£ç å®ç°ï¼Œå½“ç„¶å¦‚æœæˆ‘ä»¬è¿½æ±‚ç®€åŒ–ï¼Œä¹Ÿå¯ä»¥ç±»ä¼¼åœ°æ±‚æ¢¯åº¦ï¼Œç»“æœå°†æ˜¯<br />
\begin{equation}\nabla_{\boldsymbol{\theta}}\mathcal{L}<em _boldsymbol_theta="\boldsymbol{\theta">{\text{aux}} = \nabla</em>}}\sum_{i=1}^n(P_i + \text{sg}[F_i - P_i]) \log(P_i + \text{sg}[F_i - P_i]) = \nabla_{\boldsymbol{\theta}}\sum_{i=1}^n P_i \log F_i\end{equation<br />
ä¸¤æ¬¡ç®€åŒ–æ¢¯åº¦çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬éƒ½ç”¨åˆ°äº†å¦‚ä¸‹æ’ç­‰å¼<br />
\begin{equation}\sum_{i=1}^n \nabla_{\boldsymbol{\theta}}P_i = \nabla_{\boldsymbol{\theta}}\sum_{i=1}^n P_i = \nabla_{\boldsymbol{\theta}}1 = \boldsymbol{0}\end{equation}<br />
è¿™ä¾èµ–äº$\boldsymbol{P}$æ˜¯ä¸€ä¸ªæ¦‚ç‡åˆ†å¸ƒï¼Œä»¥åŠç›®æ ‡åˆ†å¸ƒ$\boldsymbol{Q}$æ˜¯å‡åŒ€åˆ†å¸ƒçš„äº‹å®ã€‚è€Œå¦‚æœæˆ‘ä»¬ä¸è¿½æ±‚ç®€åŒ–åçš„ç­‰ä»·ç»“æœï¼Œè€Œæ˜¯ç›´æ¥ç”¨$\boldsymbol{F}\to \boldsymbol{P} + \text{sg}[\boldsymbol{F}-\boldsymbol{P}]$å½¢å¼çš„Aux Lossï¼Œé‚£ä¹ˆå¯ä»¥ä¸å—è¿™ä¸¤ä¸ªçº¦æŸã€‚</p>
<p>æ¯”å¦‚ï¼Œ$\boldsymbol{P}$ä½œä¸º$\boldsymbol{F}$å…‰æ»‘è¿‘ä¼¼è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬åªç”¨åˆ°äº†â€œ$P_i$å¤§$F_i$é€šå¸¸ä¹Ÿå¤§â€çš„æ€§è´¨ï¼Œæ‰€ä»¥ç”¨éå½’ä¸€åŒ–çš„$\mathbb{E}[\boldsymbol{\rho}]$ä½œä¸º$\boldsymbol{P}$é€šå¸¸ä¹Ÿæ²¡é—®é¢˜ï¼Œè¿™ä¸€ç‚¹åœ¨ä¸€äº›ç‰¹æ®Šåœºæ™¯ï¼ˆä¾‹å¦‚æœ‰æ­£æœ‰è´Ÿçš„$\boldsymbol{\rho}$ï¼‰å¯èƒ½ä¼šæ¯”è¾ƒå…³é”®ï¼Œå› ä¸ºæ­¤æ—¶æ— æ³•å½’ä¸€åŒ–ä¸ºæ¦‚ç‡åˆ†å¸ƒã€‚åˆæ¯”å¦‚ç›®æ ‡$\Vert\boldsymbol{F} - \boldsymbol{Q}\Vert^2$ï¼Œæ˜¾ç„¶èƒ½å°†$\boldsymbol{F}$æ¨å‘ä»»æ„æˆ‘ä»¬æƒ³è¦çš„ã€ä¸ä¸€å®šæ˜¯å‡åŒ€çš„ç›®æ ‡åˆ†å¸ƒ$\boldsymbol{Q}$ã€‚</p>
<h2 id="_5">æ–‡ç« å°ç»“</h2>
<p>æœ¬æ–‡ä»‹ç»äº†MoEçš„è´Ÿè½½å‡è¡¡é—®é¢˜ï¼Œå¹¶ç»™å‡ºäº†ä¸€ç§æ„å»ºAux Lossçš„ä¸€èˆ¬æ€è·¯ã€‚é™¤äº†Aux Losså¤–ï¼Œä¿ƒè¿›è´Ÿè½½å‡è¡¡è¿˜æœ‰ä¸€äº›å…¶ä»–æ–¹æ¡ˆï¼Œæˆ‘ä»¬ä¸‹å›å†è°ˆã€‚</p>
<p><em><strong>è½¬è½½åˆ°è¯·åŒ…æ‹¬æœ¬æ–‡åœ°å€ï¼š</strong><a href="https://spaces.ac.cn/archives/10735">https://spaces.ac.cn/archives/10735</a></em></p>
<p><em><strong>æ›´è¯¦ç»†çš„è½¬è½½äº‹å®œè¯·å‚è€ƒï¼š</strong></em><a href="https://spaces.ac.cn/archives/6508#%E6%96%87%E7%AB%A0%E5%A6%82%E4%BD%95%E8%BD%AC%E8%BD%BD/%E5%BC%95%E7%94%A8" title="ã€Šç§‘å­¦ç©ºé—´FAQã€‹">ã€Šç§‘å­¦ç©ºé—´FAQã€‹</a></p>
<p><strong>å¦‚æœæ‚¨è¿˜æœ‰ä»€ä¹ˆç–‘æƒ‘æˆ–å»ºè®®ï¼Œæ¬¢è¿åœ¨ä¸‹æ–¹è¯„è®ºåŒºç»§ç»­è®¨è®ºã€‚</strong></p>
<p><strong>å¦‚æœæ‚¨è§‰å¾—æœ¬æ–‡è¿˜ä¸é”™ï¼Œæ¬¢è¿åˆ†äº«/æ‰“èµæœ¬æ–‡ã€‚æ‰“èµå¹¶éè¦ä»ä¸­è·å¾—æ”¶ç›Šï¼Œè€Œæ˜¯å¸Œæœ›çŸ¥é“ç§‘å­¦ç©ºé—´è·å¾—äº†å¤šå°‘è¯»è€…çš„çœŸå¿ƒå…³æ³¨ã€‚å½“ç„¶ï¼Œå¦‚æœä½ æ— è§†å®ƒï¼Œä¹Ÿä¸ä¼šå½±å“ä½ çš„é˜…è¯»ã€‚å†æ¬¡è¡¨ç¤ºæ¬¢è¿å’Œæ„Ÿè°¢ï¼</strong></p>
<p>æ‰“èµ</p>
<p><img alt="ç§‘å­¦ç©ºé—´" src="https://spaces.ac.cn/usr/themes/geekg/payment/wx.png" /></p>
<p>å¾®ä¿¡æ‰“èµ</p>
<p><img alt="ç§‘å­¦ç©ºé—´" src="https://spaces.ac.cn/usr/themes/geekg/payment/zfb.png" /></p>
<p>æ”¯ä»˜å®æ‰“èµ</p>
<p>å› ä¸ºç½‘ç«™åå°å¯¹æ‰“èµå¹¶æ— è®°å½•ï¼Œå› æ­¤æ¬¢è¿åœ¨æ‰“èµæ—¶å€™å¤‡æ³¨ç•™è¨€ã€‚ä½ è¿˜å¯ä»¥<a href="http://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&amp;email=tN7d1drY3drrx8H0xcWa19vZ"><strong>ç‚¹å‡»è¿™é‡Œ</strong></a>æˆ–åœ¨ä¸‹æ–¹è¯„è®ºåŒºç•™è¨€æ¥å‘ŠçŸ¥ä½ çš„å»ºè®®æˆ–éœ€æ±‚ã€‚</p>
<p><strong>å¦‚æœæ‚¨éœ€è¦å¼•ç”¨æœ¬æ–‡ï¼Œè¯·å‚è€ƒï¼š</strong></p>
<p>è‹å‰‘æ—. (Feb. 21, 2025). ã€ŠMoEç¯æ¸¸è®°ï¼š2ã€ä¸æ‚£å¯¡è€Œæ‚£ä¸å‡ ã€‹[Blog post]. Retrieved from <a href="https://spaces.ac.cn/archives/10735">https://spaces.ac.cn/archives/10735</a></p>
<p>@online{kexuefm-10735,<br />
title={MoEç¯æ¸¸è®°ï¼š2ã€ä¸æ‚£å¯¡è€Œæ‚£ä¸å‡},<br />
author={è‹å‰‘æ—},<br />
year={2025},<br />
month={Feb},<br />
url={\url{https://spaces.ac.cn/archives/10735}},<br />
} </p>
<hr />
<h2 id="_6">å…¬å¼æ¨å¯¼ä¸æ³¨é‡Š</h2>
<hr />
<h3 id="2">ç¬¬2éƒ¨åˆ†ï¼šä¸¥è°¨çš„æ ¸å¿ƒæ•°å­¦æ¨å¯¼</h3>
<p>æœ¬èŠ‚å°†å¯¹MoEè´Ÿè½½å‡è¡¡é—®é¢˜è¿›è¡Œæ·±å…¥çš„æ•°å­¦æ¨å¯¼ä¸åˆ†æï¼ŒåŒ…æ‹¬MoEçš„æ•°å­¦å®šä¹‰ã€è´Ÿè½½å‡è¡¡æŸå¤±çš„ç†è®ºåŸºç¡€ã€å‡åŒ€åˆ†å¸ƒçš„å¿…è¦æ€§è¯æ˜ã€ç†µæ­£åˆ™åŒ–çš„ä½œç”¨æœºåˆ¶ã€ä¸åŒå¹³è¡¡ç­–ç•¥çš„æ•°å­¦å¯¹æ¯”ï¼Œä»¥åŠæ”¶æ•›æ€§ä¸ç¨³å®šæ€§çš„ç†è®ºåˆ†æã€‚</p>
<h4 id="21-moe">2.1 MoEçš„æ•°å­¦å®šä¹‰ä¸è·¯ç”±æœºåˆ¶</h4>
<h4 id="11-moe">1.1 åŸºæœ¬MoEæ¶æ„çš„æ•°å­¦è¡¨ç¤º</h4>
<p>å¯¹äºä¸€ä¸ªåŒ…å«$n$ä¸ªä¸“å®¶çš„MoEç³»ç»Ÿï¼Œç»™å®šè¾“å…¥$\boldsymbol{x} \in \mathbb{R}^d$ï¼ŒMoEçš„è¾“å‡ºå®šä¹‰ä¸ºï¼š</p>
<p>$$
\boldsymbol{y} = \sum_{i=1}^{n} g_i(\boldsymbol{x}) \boldsymbol{e}_i(\boldsymbol{x})
$$</p>
<p>å…¶ä¸­ï¼š
- $g_i(\boldsymbol{x})$æ˜¯è·¯ç”±ç½‘ç»œï¼ˆRouterï¼‰çš„è¾“å‡ºï¼Œå†³å®šç¬¬$i$ä¸ªä¸“å®¶çš„æƒé‡
- $\boldsymbol{e}<em i="1">i(\boldsymbol{x})$æ˜¯ç¬¬$i$ä¸ªä¸“å®¶ç½‘ç»œçš„è¾“å‡º
- $\sum</em>) \geq 0$ï¼ˆæ¦‚ç‡åˆ†å¸ƒçº¦æŸï¼‰}^{n} g_i(\boldsymbol{x}) = 1$ä¸”$g_i(\boldsymbol{x</p>
<p><strong>æ¨å¯¼1ï¼šRouterçš„Softmaxè¡¨ç¤º</strong></p>
<p>Routeré€šå¸¸é€šè¿‡ä¸€ä¸ªçº¿æ€§å˜æ¢åæ¥Softmaxå®ç°ï¼š</p>
<p>$$
\boldsymbol{\rho} = \boldsymbol{W}_r \boldsymbol{x} + \boldsymbol{b}_r
$$</p>
<p>å…¶ä¸­$\boldsymbol{W}_r \in \mathbb{R}^{n \times d}$ï¼Œ$\boldsymbol{b}_r \in \mathbb{R}^n$ã€‚ç„¶åå¯¹$\boldsymbol{\rho}$åº”ç”¨Softmaxï¼š</p>
<p>$$
g_i(\boldsymbol{x}) = \frac{e^{\rho_i}}{\sum_{j=1}^{n} e^{\rho_j}}
$$</p>
<p>è¿™ä¿è¯äº†$\sum_{i=1}^{n} g_i(\boldsymbol{x}) = 1$ã€‚</p>
<h4 id="12-top-kmoe">1.2 Top-Kç¨€ç–åŒ–MoE</h4>
<p>ä¸ºäº†å‡å°‘è®¡ç®—é‡ï¼Œå®é™…åº”ç”¨ä¸­é‡‡ç”¨Top-Kç¨€ç–åŒ–ï¼š</p>
<p>$$
\boldsymbol{y} = \sum_{i \in \mathop{\text{argtop}}_k \boldsymbol{\rho}} \rho_i \boldsymbol{e}_i
$$</p>
<p><strong>æ¨å¯¼2ï¼šTop-Kæ“ä½œçš„æ•°å­¦å®šä¹‰</strong></p>
<p>å®šä¹‰Top-Ké€‰æ‹©å‡½æ•°ï¼š</p>
<p>$$
\mathcal{I}_k(\boldsymbol{\rho}) = \{i_1, i_2, \ldots, i_k\} \quad \text{æ»¡è¶³} \quad \rho_{i_1} \geq \rho_{i_2} \geq \cdots \geq \rho_{i_k} \geq \rho_j, \forall j \notin \mathcal{I}_k
$$</p>
<p>åˆ™Top-Kç¨€ç–MoEå¯ä»¥é‡å†™ä¸ºï¼š</p>
<p>$$
\boldsymbol{y} = \sum_{i=1}^{n} \mathbb{1}_{i \in \mathcal{I}_k(\boldsymbol{\rho})} \cdot \rho_i \boldsymbol{e}_i
$$</p>
<p>å…¶ä¸­$\mathbb{1}_{i \in \mathcal{I}_k(\boldsymbol{\rho})}$æ˜¯æŒ‡ç¤ºå‡½æ•°ã€‚</p>
<h4 id="13-moe">1.3 å‡ ä½•MoEçš„è§£é‡Š</h4>
<p><strong>æ¨å¯¼3ï¼šå‡ ä½•è§†è§’ä¸‹çš„MoEåˆ†è§£</strong></p>
<p>åœ¨å‡ ä½•MoEä¸­ï¼Œæˆ‘ä»¬å°†ä¸“å®¶è¾“å‡ºåˆ†è§£ä¸ºæ¨¡é•¿å’Œæ–¹å‘ï¼š</p>
<p>$$
\boldsymbol{e}_i = \rho_i \frac{\boldsymbol{v}_i}{\|\boldsymbol{v}_i\|}
$$</p>
<p>å…¶ä¸­ï¼š
- $\rho_i$é¢„æµ‹çš„æ˜¯ä¸“å®¶è´¡çŒ®çš„å¹…åº¦ï¼ˆæ¨¡é•¿ï¼‰
- $\frac{\boldsymbol{v}_i}{|\boldsymbol{v}_i|}$é¢„æµ‹çš„æ˜¯ä¸“å®¶è´¡çŒ®çš„æ–¹å‘ï¼ˆå•ä½å‘é‡ï¼‰</p>
<p>è¿™æ ·ï¼ŒMoEçš„è¾“å‡ºå˜ä¸ºï¼š</p>
<p>$$
\boldsymbol{y} = \sum_{i \in \mathop{\text{argtop}}_k \boldsymbol{\rho}} \rho_i \frac{\boldsymbol{v}_i}{\|\boldsymbol{v}_i\|}
$$</p>
<p><strong>æ¨å¯¼4ï¼šéå½’ä¸€åŒ–Routerçš„æœ‰æ•ˆæ€§</strong></p>
<p>å‡ ä½•MoEä¸è¦æ±‚$\boldsymbol{\rho}$å½’ä¸€åŒ–ï¼Œå› ä¸ºæˆ‘ä»¬åªå…³å¿ƒç›¸å¯¹å¤§å°ï¼š</p>
<p>$$
\mathop{\text{argtop}}_k \boldsymbol{\rho} = \mathop{\text{argtop}}_k (c\boldsymbol{\rho}) \quad \forall c > 0
$$</p>
<p>è¿™ç»™äºˆäº†æ¨¡å‹æ›´å¤§çš„è¡¨è¾¾è‡ªç”±åº¦ã€‚</p>
<h3 id="2_1">2. è´Ÿè½½å‡è¡¡é—®é¢˜çš„æ•°å­¦åˆ†æ</h3>
<h4 id="21">2.1 è´Ÿè½½åˆ†å¸ƒçš„å®šä¹‰</h4>
<p><strong>æ¨å¯¼5ï¼šå½’ä¸€åŒ–Routeråˆ†æ•°$\boldsymbol{p}$</strong></p>
<p>å¯¹äºä»»æ„Routerè¾“å‡º$\boldsymbol{\rho}$ï¼Œå®šä¹‰å½’ä¸€åŒ–ç‰ˆæœ¬ï¼š</p>
<p>$$
p_i = \frac{\rho_i}{\sum_{j=1}^{n} \rho_j}
$$</p>
<p>æ˜¾ç„¶$\sum_{i=1}^{n} p_i = 1$ï¼Œ$\boldsymbol{p}$å½¢æˆä¸€ä¸ªæ¦‚ç‡åˆ†å¸ƒã€‚</p>
<p><strong>æ¨å¯¼6ï¼šTop-Kç¦»æ•£åˆ†å¸ƒ$\boldsymbol{f}$</strong></p>
<p>å®šä¹‰Top-Kåçš„ç¦»æ•£åˆ†å¸ƒï¼š</p>
<p>$$
f_i = \begin{cases}
\frac{1}{k}, & i \in \mathop{\text{argtop}}_k \boldsymbol{\rho} \\
0, & i \notin \mathop{\text{argtop}}_k \boldsymbol{\rho}
\end{cases}
$$</p>
<p>éªŒè¯å½’ä¸€åŒ–ï¼š$\sum_{i=1}^{n} f_i = k \cdot \frac{1}{k} = 1$ âœ“</p>
<p><strong>æ¨å¯¼7ï¼šå…¨å±€è´Ÿè½½åˆ†å¸ƒ</strong></p>
<p>å¯¹æ‰€æœ‰æ ·æœ¬çš„æ‰€æœ‰Tokenæ±‚å¹³å‡ï¼Œå¾—åˆ°æœŸæœ›è´Ÿè½½åˆ†å¸ƒï¼š</p>
<p>$$
\boldsymbol{F} = \mathbb{E}_{\text{tokens}}[\boldsymbol{f}], \quad \boldsymbol{P} = \mathbb{E}_{\text{tokens}}[\boldsymbol{p}]
$$</p>
<p>å…¶ä¸­$\boldsymbol{P}$æ˜¯$\boldsymbol{F}$çš„å…‰æ»‘è¿‘ä¼¼ï¼Œå› ä¸ºï¼š</p>
<p>$$
\lim_{\tau \to 0} \boldsymbol{P}(\boldsymbol{\rho}/\tau) = \boldsymbol{F}(\boldsymbol{\rho})
$$</p>
<h4 id="22">2.2 è´Ÿè½½ä¸å‡è¡¡çš„ä»£ä»·</h4>
<p><strong>æ¨å¯¼8ï¼šDead Expertçš„å‚æ•°æµªè´¹</strong></p>
<p>å¦‚æœä¸“å®¶$i$çš„è´Ÿè½½$F_i \approx 0$ï¼Œåˆ™è¯¥ä¸“å®¶çš„å‚æ•°$\boldsymbol{\theta}_i$å‡ ä¹ä¸å‚ä¸è®­ç»ƒï¼š</p>
<p>$$
\frac{\partial \mathcal{L}}{\partial \boldsymbol{\theta}_i} = \mathbb{E}\left[\frac{\partial \mathcal{L}}{\partial \boldsymbol{e}_i} \frac{\partial \boldsymbol{e}_i}{\partial \boldsymbol{\theta}_i}\right] \approx 0 \quad \text{å½“} \quad F_i \to 0
$$</p>
<p>è®¾æ¨¡å‹æ€»å‚æ•°ä¸º$M$ï¼Œè‹¥$m$ä¸ªä¸“å®¶å¤„äºDeadçŠ¶æ€ï¼Œåˆ™æœ‰æ•ˆå‚æ•°é‡é™ä¸ºï¼š</p>
<p>$$
M_{\text{eff}} = M - m \cdot |\boldsymbol{\theta}_i| \ll M
$$</p>
<p><strong>æ¨å¯¼9ï¼šToken Dropçš„æŸå¤±</strong></p>
<p>å½“æŸä¸ªä¸“å®¶è´Ÿè½½è¿‡é«˜æ—¶ï¼Œä¼šå‘ç”ŸToken Dropã€‚è®¾ä¸“å®¶$i$çš„å®¹é‡ä¸º$C_i$ï¼Œä½†åˆ†é…çš„Tokenæ•°ä¸º$T_i &gt; C_i$ï¼Œåˆ™ä¸¢å¼ƒæ¯”ä¾‹ä¸ºï¼š</p>
<p>$$
\text{Drop Rate}_i = \frac{T_i - C_i}{T_i} = 1 - \frac{C_i}{T_i}
$$</p>
<p>ä¸¢å¼ƒTokenä¼šå¯¼è‡´ä¿¡æ¯æŸå¤±ï¼Œå½±å“æ¨¡å‹æ€§èƒ½ã€‚</p>
<h3 id="3-aux-loss">3. è¾…åŠ©æŸå¤±ï¼ˆAux Lossï¼‰çš„æ•°å­¦æ¨å¯¼</h3>
<h4 id="31-aux-loss">3.1 æ ‡å‡†Aux Lossçš„å½¢å¼</h4>
<p><strong>æ¨å¯¼10ï¼šGShard Aux Loss</strong></p>
<p>GShardæå‡ºçš„è¾…åŠ©æŸå¤±ä¸ºï¼š</p>
<p>$$
\mathcal{L}_{\text{aux}} = n \sum_{i=1}^{n} F_i P_i
$$</p>
<p>æˆ–ä¸å¸¦ç³»æ•°$n$çš„ç‰ˆæœ¬ï¼ˆæœ¬æ–‡é‡‡ç”¨ï¼‰ï¼š</p>
<p>$$
\mathcal{L}_{\text{aux}} = \sum_{i=1}^{n} F_i P_i = \boldsymbol{F} \cdot \boldsymbol{P}
$$</p>
<p><strong>æ¨å¯¼11ï¼šä¸ºä»€ä¹ˆè¿™ä¸ªå½¢å¼èƒ½ä¿ƒè¿›å‡è¡¡ï¼Ÿ</strong></p>
<p>å®šä¹‰å‡åŒ€åˆ†å¸ƒ$\boldsymbol{Q} = (\frac{1}{n}, \frac{1}{n}, \ldots, \frac{1}{n})$ã€‚å¦‚æœ$\boldsymbol{F} = \boldsymbol{Q}$ï¼ˆå®Œå…¨å‡è¡¡ï¼‰ï¼Œåˆ™ï¼š</p>
<p>$$
\mathcal{L}_{\text{aux}} = \sum_{i=1}^{n} \frac{1}{n} P_i = \frac{1}{n} \sum_{i=1}^{n} P_i = \frac{1}{n}
$$</p>
<p>ä½†è¿™ä¸æ˜¯æœ€å°å€¼ï¼è€ƒè™‘æç«¯ä¸å‡è¡¡æƒ…å†µï¼Œå¦‚$F_1 = 1, F_i = 0 (i&gt;1)$ï¼Œæ­¤æ—¶ï¼š</p>
<p>$$
\mathcal{L}_{\text{aux}} = P_1 \leq 1
$$</p>
<p>æ‰€ä»¥$\mathcal{L}_{\text{aux}}$æœ¬èº«ä¸æ˜¯æ ‡å‡†çš„"è¶Šå°è¶Šå¥½"çš„æŸå¤±ã€‚</p>
<h4 id="32-steaux-loss">3.2 é€šè¿‡ç›´é€šä¼°è®¡å™¨ï¼ˆSTEï¼‰ç†è§£Aux Loss</h4>
<p><strong>æ¨å¯¼12ï¼šåŸºäºå‡æ–¹è¯¯å·®çš„çœŸå®æŸå¤±</strong></p>
<p>æ›´è‡ªç„¶çš„è´Ÿè½½å‡è¡¡æŸå¤±åº”è¯¥æ˜¯ï¼š</p>
<p>$$
\mathcal{L}_{\text{true}} = \frac{1}{2} \sum_{i=1}^{n} (F_i - Q_i)^2 = \frac{1}{2} \sum_{i=1}^{n} \left(F_i - \frac{1}{n}\right)^2
$$</p>
<p>è¿™ç¡®å®æ˜¯"è¶Šå°è¶Šå¥½"çš„æŸå¤±ï¼Œæœ€å°å€¼ä¸º0ï¼ˆå½“$\boldsymbol{F} = \boldsymbol{Q}$æ—¶ï¼‰ã€‚</p>
<p><strong>æ¨å¯¼13ï¼šSTEæ›¿æ¢$\boldsymbol{F} \to \boldsymbol{P}$</strong></p>
<p>ç”±äº$\boldsymbol{F}$åŒ…å«ä¸å¯å¾®çš„$\text{argtop}_k$æ“ä½œï¼Œæˆ‘ä»¬ç”¨STEæŠ€å·§ï¼š</p>
<p>$$
\tilde{F}_i = P_i + \text{sg}[F_i - P_i]
$$</p>
<p>å…¶ä¸­$\text{sg}[\cdot]$æ˜¯stop gradientç®—å­ï¼š
- å‰å‘ä¼ æ’­ï¼š$\text{sg}[x] = x$
- åå‘ä¼ æ’­ï¼š$\frac{\partial \text{sg}[x]}{\partial x} = 0$</p>
<p>å°†$F_i$æ›¿æ¢ä¸º$\tilde{F}_i$ï¼š</p>
<p>$$
\mathcal{L}_{\text{ste}} = \frac{1}{2} \sum_{i=1}^{n} \left(P_i + \text{sg}[F_i - P_i] - \frac{1}{n}\right)^2
$$</p>
<p><strong>æ¨å¯¼14ï¼šæ¢¯åº¦æ¨å¯¼</strong></p>
<p>è®¡ç®—$\mathcal{L}_{\text{ste}}$å…³äº$\boldsymbol{\theta}$çš„æ¢¯åº¦ï¼š</p>
<p>$$
\begin{aligned}
\nabla_{\boldsymbol{\theta}} \mathcal{L}_{\text{ste}} &= \sum_{i=1}^{n} \left(P_i + \text{sg}[F_i - P_i] - \frac{1}{n}\right) \nabla_{\boldsymbol{\theta}} (P_i + \text{sg}[F_i - P_i]) \\
&= \sum_{i=1}^{n} \left(P_i + \text{sg}[F_i - P_i] - \frac{1}{n}\right) \nabla_{\boldsymbol{\theta}} P_i \\
&= \sum_{i=1}^{n} \left(F_i - \frac{1}{n}\right) \nabla_{\boldsymbol{\theta}} P_i
\end{aligned}
$$</p>
<p>åœ¨ç¬¬äºŒæ­¥æˆ‘ä»¬ç”¨äº†$\nabla_{\boldsymbol{\theta}} \text{sg}[x] = 0$ã€‚</p>
<p><strong>æ¨å¯¼15ï¼šç®€åŒ–ä¸ºç‚¹ç§¯å½¢å¼</strong></p>
<p>ç»§ç»­æ¨å¯¼ï¼š</p>
<p>$$
\begin{aligned}
\nabla_{\boldsymbol{\theta}} \mathcal{L}_{\text{ste}} &= \sum_{i=1}^{n} F_i \nabla_{\boldsymbol{\theta}} P_i - \frac{1}{n} \sum_{i=1}^{n} \nabla_{\boldsymbol{\theta}} P_i \\
&= \sum_{i=1}^{n} F_i \nabla_{\boldsymbol{\theta}} P_i - \frac{1}{n} \nabla_{\boldsymbol{\theta}} \left(\sum_{i=1}^{n} P_i\right) \\
&= \sum_{i=1}^{n} F_i \nabla_{\boldsymbol{\theta}} P_i \quad (\text{å› ä¸º} \sum_{i=1}^{n} P_i = 1) \\
&= \nabla_{\boldsymbol{\theta}} \sum_{i=1}^{n} F_i P_i
\end{aligned}
$$</p>
<p>è¿™è¯æ˜äº†$\mathcal{L}<em i="1">{\text{aux}} = \sum</em> F_i P_i$çš„æ¢¯åº¦ç­‰ä»·æ€§ï¼}^{n</p>
<h3 id="4">4. å‡åŒ€åˆ†å¸ƒçš„ç†è®ºåˆ†æ</h3>
<h4 id="41">4.1 å‡åŒ€åˆ†å¸ƒçš„ä¿¡æ¯è®ºæ„ä¹‰</h4>
<p><strong>æ¨å¯¼16ï¼šç†µä¸å‡åŒ€åˆ†å¸ƒ</strong></p>
<p>åˆ†å¸ƒ$\boldsymbol{F}$çš„ç†µå®šä¹‰ä¸ºï¼š</p>
<p>$$
H(\boldsymbol{F}) = -\sum_{i=1}^{n} F_i \log F_i
$$</p>
<p>å¯¹äºå›ºå®šçš„$n$ï¼Œç†µåœ¨å‡åŒ€åˆ†å¸ƒæ—¶è¾¾åˆ°æœ€å¤§ï¼š</p>
<p>$$
H(\boldsymbol{Q}) = -\sum_{i=1}^{n} \frac{1}{n} \log \frac{1}{n} = \log n
$$</p>
<p><strong>æ¨å¯¼17ï¼šç†µæœ€å¤§æ€§çš„è¯æ˜</strong></p>
<p>ä½¿ç”¨æ‹‰æ ¼æœ—æ—¥ä¹˜æ•°æ³•ï¼Œè¦æœ€å¤§åŒ–$H(\boldsymbol{F})$çº¦æŸäº$\sum_{i=1}^{n} F_i = 1$ï¼š</p>
<p>$$
\mathcal{L} = -\sum_{i=1}^{n} F_i \log F_i + \lambda \left(\sum_{i=1}^{n} F_i - 1\right)
$$</p>
<p>å¯¹$F_i$æ±‚åå¯¼å¹¶ä»¤å…¶ä¸ºé›¶ï¼š</p>
<p>$$
\frac{\partial \mathcal{L}}{\partial F_i} = -\log F_i - 1 + \lambda = 0
$$</p>
<p>å¾—åˆ°$\log F_i = \lambda - 1$ï¼Œå³$F_i = e^{\lambda - 1}$å¯¹æ‰€æœ‰$i$éƒ½ç›¸åŒã€‚ç»“åˆçº¦æŸæ¡ä»¶$\sum_{i=1}^{n} F_i = 1$ï¼Œå¾—åˆ°$F_i = \frac{1}{n}$ã€‚</p>
<p><strong>æ¨å¯¼18ï¼šKLæ•£åº¦ä¸å‡åŒ€åˆ†å¸ƒ</strong></p>
<p>ä»å½“å‰åˆ†å¸ƒ$\boldsymbol{F}$åˆ°ç›®æ ‡å‡åŒ€åˆ†å¸ƒ$\boldsymbol{Q}$çš„KLæ•£åº¦ï¼š</p>
<p>$$
D_{KL}(\boldsymbol{F} \| \boldsymbol{Q}) = \sum_{i=1}^{n} F_i \log \frac{F_i}{Q_i} = \sum_{i=1}^{n} F_i \log(n F_i)
$$</p>
<p>å±•å¼€ï¼š</p>
<p>$$
D_{KL}(\boldsymbol{F} \| \boldsymbol{Q}) = \log n + \sum_{i=1}^{n} F_i \log F_i = \log n - H(\boldsymbol{F})
$$</p>
<p>æ‰€ä»¥æœ€å¤§åŒ–ç†µç­‰ä»·äºæœ€å°åŒ–KLæ•£åº¦ã€‚</p>
<h4 id="42">4.2 å‡åŒ€åˆ†å¸ƒçš„å®¹é‡åˆ©ç”¨</h4>
<p><strong>æ¨å¯¼19ï¼šæœ‰æ•ˆå®¹é‡åˆ†æ</strong></p>
<p>å‡è®¾æ¯ä¸ªä¸“å®¶å®¹é‡ä¸º$C$ï¼Œæ€»å®¹é‡$C_{\text{total}} = nC$ã€‚åœ¨åˆ†å¸ƒ$\boldsymbol{F}$ä¸‹ï¼ŒæœŸæœ›åˆ©ç”¨çš„å®¹é‡ä¸ºï¼š</p>
<p>$$
C_{\text{used}} = \sum_{i=1}^{n} \min(F_i \cdot T, C)
$$</p>
<p>å…¶ä¸­$T$æ˜¯æ€»Tokenæ•°ã€‚å½“$\boldsymbol{F}$å‡åŒ€æ—¶ï¼Œ$F_i = \frac{1}{n}$ï¼Œå¦‚æœ$\frac{T}{n} \leq C$ï¼Œåˆ™ï¼š</p>
<p>$$
C_{\text{used}} = \sum_{i=1}^{n} \frac{T}{n} = T
$$</p>
<p>æ‰€æœ‰Tokenéƒ½è¢«å¤„ç†ï¼Œæ— Dropã€‚</p>
<p><strong>æ¨å¯¼20ï¼šä¸å‡åŒ€åˆ†å¸ƒçš„å®¹é‡æŸå¤±</strong></p>
<p>å‡è®¾åˆ†å¸ƒä¸º$(F_1, F_2, \ldots, F_n) = (0.5, 0.5, 0, \ldots, 0)$ï¼ˆä¸¤ä¸ªä¸“å®¶åˆ†æ‹…æ‰€æœ‰è´Ÿè½½ï¼‰ã€‚è®¾$C = \frac{T}{n}$ï¼Œåˆ™ï¼š</p>
<p>$$
C_{\text{used}} = 2 \cdot \min(0.5T, C) = 2C = \frac{2T}{n}
$$</p>
<p>æµªè´¹äº†$\frac{n-2}{n}$çš„å®¹é‡ï¼å½“$n$å¾ˆå¤§æ—¶ï¼Œè¿™æ˜¯å·¨å¤§çš„æµªè´¹ã€‚</p>
<h3 id="5">5. ç†µæ­£åˆ™åŒ–çš„ç†è®ºåˆ†æ</h3>
<h4 id="51-aux-loss">5.1 åŸºäºç†µçš„Aux Loss</h4>
<p><strong>æ¨å¯¼21ï¼šç†µæ­£åˆ™åŒ–æŸå¤±</strong></p>
<p>å¦ä¸€ç§ä¿ƒè¿›å‡è¡¡çš„æ–¹å¼æ˜¯ç›´æ¥æœ€å¤§åŒ–ç†µï¼ˆæˆ–æœ€å°åŒ–è´Ÿç†µï¼‰ï¼š</p>
<p>$$
\mathcal{L}_{\text{entropy}} = -H(\boldsymbol{F}) = \sum_{i=1}^{n} F_i \log F_i
$$</p>
<p>ä½¿ç”¨STEæŠ€å·§ï¼š</p>
<p>$$
\mathcal{L}_{\text{entropy-ste}} = \sum_{i=1}^{n} (P_i + \text{sg}[F_i - P_i]) \log(P_i + \text{sg}[F_i - P_i])
$$</p>
<p><strong>æ¨å¯¼22ï¼šç†µæŸå¤±çš„æ¢¯åº¦</strong></p>
<p>è®¡ç®—æ¢¯åº¦ï¼š</p>
<p>$$
\begin{aligned}
\nabla_{\boldsymbol{\theta}} \mathcal{L}_{\text{entropy-ste}} &= \sum_{i=1}^{n} \nabla_{\boldsymbol{\theta}} [(P_i + \text{sg}[F_i - P_i]) \log(P_i + \text{sg}[F_i - P_i])] \\
&= \sum_{i=1}^{n} (\log(P_i + \text{sg}[F_i - P_i]) + 1) \nabla_{\boldsymbol{\theta}} P_i \\
&= \sum_{i=1}^{n} (\log F_i + 1) \nabla_{\boldsymbol{\theta}} P_i
\end{aligned}
$$</p>
<p><strong>æ¨å¯¼23ï¼šæ¢¯åº¦ç®€åŒ–</strong></p>
<p>åˆ©ç”¨$\sum_{i=1}^{n} \nabla_{\boldsymbol{\theta}} P_i = 0$ï¼š</p>
<p>$$
\begin{aligned}
\nabla_{\boldsymbol{\theta}} \mathcal{L}_{\text{entropy-ste}} &= \sum_{i=1}^{n} \log F_i \nabla_{\boldsymbol{\theta}} P_i + \sum_{i=1}^{n} \nabla_{\boldsymbol{\theta}} P_i \\
&= \sum_{i=1}^{n} \log F_i \nabla_{\boldsymbol{\theta}} P_i \\
&= \nabla_{\boldsymbol{\theta}} \sum_{i=1}^{n} P_i \log F_i
\end{aligned}
$$</p>
<p>æ‰€ä»¥å¯ä»¥ä½¿ç”¨ç®€åŒ–å½¢å¼ï¼š</p>
<p>$$
\mathcal{L}_{\text{entropy-simple}} = \sum_{i=1}^{n} P_i \log F_i
$$</p>
<h4 id="52">5.2 ç†µæ­£åˆ™ä¸ç‚¹ç§¯å½¢å¼çš„å…³ç³»</h4>
<p><strong>æ¨å¯¼24ï¼šæ³°å‹’å±•å¼€åˆ†æ</strong></p>
<p>åœ¨$\boldsymbol{F} \approx \boldsymbol{Q}$é™„è¿‘ï¼Œå¯¹$F_i = \frac{1}{n} + \epsilon_i$å±•å¼€ï¼š</p>
<p>$$
\log F_i = \log\left(\frac{1}{n} + \epsilon_i\right) = \log \frac{1}{n} + \log\left(1 + n\epsilon_i\right) \approx \log \frac{1}{n} + n\epsilon_i
$$</p>
<p>ä»£å…¥ç†µæŸå¤±ï¼š</p>
<p>$$
\begin{aligned}
\mathcal{L}_{\text{entropy-simple}} &= \sum_{i=1}^{n} P_i \log F_i \\
&\approx \sum_{i=1}^{n} P_i \left(\log \frac{1}{n} + n\epsilon_i\right) \\
&= -\log n + n \sum_{i=1}^{n} P_i \epsilon_i
\end{aligned}
$$</p>
<p>è€Œç‚¹ç§¯å½¢å¼åœ¨åŒæ ·çš„å±•å¼€ä¸‹ï¼š</p>
<p>$$
\sum_{i=1}^{n} F_i P_i = \sum_{i=1}^{n} \left(\frac{1}{n} + \epsilon_i\right) P_i = \frac{1}{n} + \sum_{i=1}^{n} \epsilon_i P_i
$$</p>
<p>ä¸¤è€…åœ¨ä¸€é˜¶è¿‘ä¼¼ä¸‹æœ¬è´¨ç›¸åŒï¼</p>
<h3 id="6">6. ä¸åŒå¹³è¡¡ç­–ç•¥çš„æ•°å­¦å¯¹æ¯”</h3>
<h4 id="61-l2">6.1 L2æ­£åˆ™åŒ–ç­–ç•¥</h4>
<p><strong>æ¨å¯¼25ï¼šL2è·ç¦»æŸå¤±</strong></p>
<p>$$
\mathcal{L}_{L2} = \frac{1}{2} \|\boldsymbol{F} - \boldsymbol{Q}\|^2 = \frac{1}{2} \sum_{i=1}^{n} \left(F_i - \frac{1}{n}\right)^2
$$</p>
<p>å±•å¼€ï¼š</p>
<p>$$
\mathcal{L}_{L2} = \frac{1}{2} \sum_{i=1}^{n} F_i^2 - \frac{1}{n} \sum_{i=1}^{n} F_i + \frac{1}{2n}
$$</p>
<p>ç”±äº$\sum_{i=1}^{n} F_i = 1$ï¼Œç®€åŒ–ä¸ºï¼š</p>
<p>$$
\mathcal{L}_{L2} = \frac{1}{2} \sum_{i=1}^{n} F_i^2 - \frac{1}{n} + \frac{1}{2n} = \frac{1}{2} \sum_{i=1}^{n} F_i^2 - \frac{1}{2n}
$$</p>
<p><strong>æ¨å¯¼26ï¼šL2æŸå¤±ä¸ç‚¹ç§¯å½¢å¼çš„å…³ç³»</strong></p>
<p>æ³¨æ„åˆ°ï¼š</p>
<p>$$
\sum_{i=1}^{n} F_i^2 = \sum_{i=1}^{n} F_i \cdot F_i
$$</p>
<p>å¦‚æœ$\boldsymbol{P} \approx \boldsymbol{F}$ï¼Œåˆ™ï¼š</p>
<p>$$
\mathcal{L}_{L2} \approx \frac{1}{2} \sum_{i=1}^{n} F_i P_i - \frac{1}{2n}
$$</p>
<p>ç›¸å·®ä¸€ä¸ªå¸¸æ•°é¡¹ï¼</p>
<h4 id="62-l1">6.2 L1æ­£åˆ™åŒ–ç­–ç•¥</h4>
<p><strong>æ¨å¯¼27ï¼šL1è·ç¦»æŸå¤±</strong></p>
<p>$$
\mathcal{L}_{L1} = \|\boldsymbol{F} - \boldsymbol{Q}\|_1 = \sum_{i=1}^{n} \left|F_i - \frac{1}{n}\right|
$$</p>
<p>è¿™ä¸ªæŸå¤±å¯¹ç¦»ç¾¤ä¸“å®¶ï¼ˆ$F_i$è¿œç¦»$\frac{1}{n}$ï¼‰çš„æƒ©ç½šæ›´å¼ºã€‚</p>
<p><strong>æ¨å¯¼28ï¼šL1çš„æ¬¡æ¢¯åº¦</strong></p>
<p>L1æŸå¤±çš„æ¬¡æ¢¯åº¦ä¸ºï¼š</p>
<p>$$
\partial \mathcal{L}_{L1} = \sum_{i=1}^{n} \text{sign}\left(F_i - \frac{1}{n}\right) \nabla_{\boldsymbol{\theta}} P_i
$$</p>
<p>å…¶ä¸­$\text{sign}(x) = \begin{cases} 1, &amp; x &gt; 0 \ [-1, 1], &amp; x = 0 \ -1, &amp; x &lt; 0 \end{cases}$</p>
<h4 id="63">6.3 æœ€å¤§è´Ÿè½½æœ€å°åŒ–</h4>
<p><strong>æ¨å¯¼29ï¼šMinimaxç›®æ ‡</strong></p>
<p>å¦ä¸€ç§ç­–ç•¥æ˜¯æœ€å°åŒ–æœ€å¤§è´Ÿè½½ï¼š</p>
<p>$$
\mathcal{L}_{\max} = \max_{i=1,\ldots,n} F_i
$$</p>
<p>è¿™ç›´æ¥é’ˆå¯¹"æœ€ç¹å¿™"çš„ä¸“å®¶ã€‚å¯ä»¥ç”¨å…‰æ»‘è¿‘ä¼¼ï¼š</p>
<p>$$
\mathcal{L}_{\max-soft} = \text{LogSumExp}(\boldsymbol{F}) = \log \sum_{i=1}^{n} e^{F_i}
$$</p>
<p>å½“æ¸©åº¦ç³»æ•°å¾ˆå¤§æ—¶ï¼Œè¿™æ¥è¿‘$\max F_i$ã€‚</p>
<h3 id="7">7. æ”¶æ•›æ€§ä¸ç¨³å®šæ€§åˆ†æ</h3>
<h4 id="71-aux-loss">7.1 Aux Lossçš„æ”¶æ•›æ€§</h4>
<p><strong>æ¨å¯¼30ï¼šæ¢¯åº¦ä¸‹é™æ›´æ–°</strong></p>
<p>è®¾æ€»æŸå¤±ä¸ºï¼š</p>
<p>$$
\mathcal{L}_{\text{total}} = \mathcal{L}_{\text{task}} + \alpha \mathcal{L}_{\text{aux}}
$$</p>
<p>å…¶ä¸­$\alpha$æ˜¯Aux Lossçš„æƒé‡ã€‚æ¢¯åº¦ä¸‹é™æ›´æ–°ï¼š</p>
<p>$$
\boldsymbol{\theta}_{t+1} = \boldsymbol{\theta}_t - \eta \nabla_{\boldsymbol{\theta}} \mathcal{L}_{\text{total}}
$$</p>
<p><strong>æ¨å¯¼31ï¼šæ”¶æ•›æ¡ä»¶åˆ†æ</strong></p>
<p>å‡è®¾$\mathcal{L}_{\text{task}}$æ˜¯$L$-å…‰æ»‘çš„ï¼Œå³ï¼š</p>
<p>$$
\|\nabla \mathcal{L}_{\text{task}}(\boldsymbol{\theta}_1) - \nabla \mathcal{L}_{\text{task}}(\boldsymbol{\theta}_2)\| \leq L \|\boldsymbol{\theta}_1 - \boldsymbol{\theta}_2\|
$$</p>
<p>é‚£ä¹ˆåœ¨å­¦ä¹ ç‡$\eta \leq \frac{1}{L}$ä¸‹ï¼Œæ¢¯åº¦ä¸‹é™æ”¶æ•›ã€‚</p>
<p>å¯¹äºAux Lossé¡¹$\alpha \sum_{i=1}^{n} F_i P_i$ï¼Œå…¶æ¢¯åº¦ä¸ºï¼š</p>
<p>$$
\alpha \sum_{i=1}^{n} F_i \nabla_{\boldsymbol{\theta}} P_i
$$</p>
<p>ç”±äº$P_i = \frac{e^{\rho_i}}{\sum_j e^{\rho_j}}$æ˜¯Softmaxï¼Œå…¶Jacobianæœ‰ç•Œï¼Œå› æ­¤Aux Lossä¹Ÿæ˜¯å…‰æ»‘çš„ã€‚</p>
<p><strong>æ¨å¯¼32ï¼šç¨³å®šæ€§åˆ†æâ€”â€”æ–¹å·®ç•Œ</strong></p>
<p>è´Ÿè½½åˆ†å¸ƒçš„æ–¹å·®å®šä¹‰ä¸ºï¼š</p>
<p>$$
\text{Var}(\boldsymbol{F}) = \sum_{i=1}^{n} \left(F_i - \frac{1}{n}\right)^2 = \sum_{i=1}^{n} F_i^2 - \frac{1}{n}
$$</p>
<p>æœ€å°åŒ–Aux Loss $\sum_{i=1}^{n} F_i P_i$æ—¶ï¼Œå¦‚æœ$\boldsymbol{P} \approx \boldsymbol{F}$ï¼Œåˆ™ç›¸å½“äºæœ€å°åŒ–$\sum_{i=1}^{n} F_i^2$ï¼Œå³å‡å°æ–¹å·®ã€‚</p>
<p><strong>æ¨å¯¼33ï¼šLyapunovç¨³å®šæ€§</strong></p>
<p>å®šä¹‰Lyapunovå‡½æ•°ï¼š</p>
<p>$$
V(\boldsymbol{F}) = \frac{1}{2} \|\boldsymbol{F} - \boldsymbol{Q}\|^2
$$</p>
<p>å…¶æ—¶é—´å¯¼æ•°ï¼ˆæ²¿æ¢¯åº¦æµï¼‰ï¼š</p>
<p>$$
\frac{dV}{dt} = (\boldsymbol{F} - \boldsymbol{Q})^T \frac{d\boldsymbol{F}}{dt}
$$</p>
<p>å¦‚æœä¼˜åŒ–æ­£ç¡®è¿›è¡Œï¼Œ$\frac{d\boldsymbol{F}}{dt}$åº”è¯¥æŒ‡å‘å‡å°$V$çš„æ–¹å‘ï¼Œå³ï¼š</p>
<p>$$
\frac{dV}{dt} < 0 \quad \text{å½“} \quad \boldsymbol{F} \neq \boldsymbol{Q}
$$</p>
<p>è¿™ä¿è¯äº†ç³»ç»Ÿæ”¶æ•›åˆ°å‡åŒ€åˆ†å¸ƒã€‚</p>
<h4 id="72">7.2 åŠ¨æ€ç¨³å®šæ€§</h4>
<p><strong>æ¨å¯¼34ï¼šè´Ÿè½½æ³¢åŠ¨åˆ†æ</strong></p>
<p>åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œè´Ÿè½½$F_i^{(t)}$åœ¨æ—¶é—´æ­¥$t$å¯èƒ½æœ‰æ³¢åŠ¨ã€‚å®šä¹‰æ³¢åŠ¨å¹…åº¦ï¼š</p>
<p>$$
\Delta F_i^{(t)} = F_i^{(t)} - F_i^{(t-1)}
$$</p>
<p>æ€»æ³¢åŠ¨ä¸ºï¼š</p>
<p>$$
\Omega^{(t)} = \sum_{i=1}^{n} |\Delta F_i^{(t)}|
$$</p>
<p>ç¨³å®šçš„è®­ç»ƒåº”è¯¥æœ‰$\Omega^{(t)} \to 0$å½“$t \to \infty$ã€‚</p>
<p><strong>æ¨å¯¼35ï¼šæŒ‡æ•°ç§»åŠ¨å¹³å‡çš„ç¨³å®šæ•ˆæœ</strong></p>
<p>ä¸ºäº†å‡å°‘æ³¢åŠ¨ï¼Œå¯ä»¥ä½¿ç”¨EMAæ›´æ–°$\boldsymbol{F}$ï¼š</p>
<p>$$
\boldsymbol{F}^{(t)} = \beta \boldsymbol{F}^{(t-1)} + (1-\beta) \boldsymbol{f}^{(t)}
$$</p>
<p>å…¶ä¸­$\boldsymbol{f}^{(t)}$æ˜¯ç¬¬$t$æ­¥çš„ç¬æ—¶è´Ÿè½½ï¼Œ$\beta \in [0, 1)$æ˜¯åŠ¨é‡ç³»æ•°ã€‚</p>
<p>è¿™ä¸ªEMAçš„æ–¹å·®ä¸ºï¼š</p>
<p>$$
\text{Var}(\boldsymbol{F}^{(t)}) = (1-\beta)^2 \sum_{s=0}^{t} \beta^{2s} \text{Var}(\boldsymbol{f}^{(t-s)})
$$</p>
<p>å½“$t$è¶³å¤Ÿå¤§æ—¶ï¼Œç¨³æ€æ–¹å·®ä¸ºï¼š</p>
<p>$$
\text{Var}(\boldsymbol{F}^{(\infty)}) = \frac{1-\beta}{1+\beta} \text{Var}(\boldsymbol{f})
$$</p>
<p>$\beta$è¶Šå¤§ï¼Œæ–¹å·®è¶Šå°ï¼Œè¶Šç¨³å®šã€‚</p>
<h3 id="8">8. å®éªŒç»“æœçš„ç†è®ºè§£é‡Š</h3>
<h4 id="81-aux-loss">8.1 Aux Lossæƒé‡çš„å½±å“</h4>
<p><strong>æ¨å¯¼36ï¼šæƒé‡$\alpha$çš„æƒè¡¡</strong></p>
<p>æ€»æŸå¤±ä¸ºï¼š</p>
<p>$$
\mathcal{L} = \mathcal{L}_{\text{task}} + \alpha \mathcal{L}_{\text{aux}}
$$</p>
<p>è¿‡å°çš„$\alpha$ï¼šè´Ÿè½½ä¸å‡è¡¡ï¼Œ$\boldsymbol{F}$åç¦»$\boldsymbol{Q}$
è¿‡å¤§çš„$\alpha$ï¼šè¿‡åº¦å¼ºè°ƒå‡è¡¡ï¼Œç‰ºç‰²ä»»åŠ¡æ€§èƒ½</p>
<p>æœ€ä¼˜$\alpha^*$åº”å¹³è¡¡ä¸¤è€…ï¼š</p>
<p>$$
\alpha^* = \arg\min_{\alpha} \mathbb{E}[\mathcal{L}_{\text{task}}(\alpha)] + \lambda \|\boldsymbol{F}(\alpha) - \boldsymbol{Q}\|^2
$$</p>
<p>å…¶ä¸­$\lambda$æ˜¯è¶…å‚æ•°ï¼Œæ§åˆ¶å¯¹å‡è¡¡çš„é‡è§†ç¨‹åº¦ã€‚</p>
<p><strong>æ¨å¯¼37ï¼šå¸•ç´¯æ‰˜å‰æ²¿åˆ†æ</strong></p>
<p>å®šä¹‰ä¸¤ä¸ªç›®æ ‡ï¼š
- $J_1 = \mathcal{L}_{\text{task}}$ï¼ˆä»»åŠ¡æ€§èƒ½ï¼Œè¶Šå°è¶Šå¥½ï¼‰
- $J_2 = |\boldsymbol{F} - \boldsymbol{Q}|^2$ï¼ˆè´Ÿè½½æ–¹å·®ï¼Œè¶Šå°è¶Šå¥½ï¼‰</p>
<p>å¸•ç´¯æ‰˜æœ€ä¼˜è§£æ»¡è¶³ï¼šä¸å­˜åœ¨å…¶ä»–è§£èƒ½åŒæ—¶æ”¹å–„$J_1$å’Œ$J_2$ã€‚</p>
<p>ä¸åŒçš„$\alpha$å¯¹åº”å¸•ç´¯æ‰˜å‰æ²¿ä¸Šçš„ä¸åŒç‚¹ã€‚</p>
<h4 id="82">8.2 è®­ç»ƒåŠ¨æ€çš„ç†è®ºé¢„æµ‹</h4>
<p><strong>æ¨å¯¼38ï¼šæ—©æœŸè®­ç»ƒé˜¶æ®µ</strong></p>
<p>åˆå§‹æ—¶ï¼ŒRouteræƒé‡æ¥è¿‘éšæœºï¼Œ$\boldsymbol{P}^{(0)} \approx \boldsymbol{Q}$ï¼ˆè¿‘ä¼¼å‡åŒ€ï¼‰ã€‚æ­¤æ—¶ï¼š</p>
<p>$$
\mathcal{L}_{\text{aux}}^{(0)} = \sum_{i=1}^{n} F_i^{(0)} P_i^{(0)} \approx \sum_{i=1}^{n} F_i^{(0)} \cdot \frac{1}{n} = \frac{1}{n}
$$</p>
<p>éšç€è®­ç»ƒï¼ŒRouterå¼€å§‹ä¸“é—¨åŒ–ï¼Œ$\boldsymbol{P}$åç¦»å‡åŒ€ï¼Œå¦‚æœæ²¡æœ‰Aux Lossï¼Œ$\boldsymbol{F}$ä¹Ÿä¼šåç¦»ã€‚</p>
<p><strong>æ¨å¯¼39ï¼šä¸­æœŸè®­ç»ƒé˜¶æ®µ</strong></p>
<p>Aux Losså¼€å§‹å‘æŒ¥ä½œç”¨ï¼Œå°†$\boldsymbol{F}$æ‹‰å‘$\boldsymbol{Q}$ã€‚æ­¤æ—¶å­˜åœ¨ç«äº‰ï¼š
- ä»»åŠ¡æŸå¤±å¸Œæœ›Routerä¸“é—¨åŒ–
- Aux Losså¸Œæœ›Routerå‡åŒ€åŒ–</p>
<p>å¹³è¡¡ç‚¹å–å†³äº$\alpha$ã€‚</p>
<p><strong>æ¨å¯¼40ï¼šåæœŸè®­ç»ƒé˜¶æ®µ</strong></p>
<p>å½“æ¨¡å‹æ¥è¿‘æ”¶æ•›ï¼Œ$\boldsymbol{F}$åº”è¯¥ç¨³å®šåœ¨æ¥è¿‘$\boldsymbol{Q}$çš„ä½ç½®ã€‚æ­¤æ—¶Aux Lossçš„æ¢¯åº¦ï¼š</p>
<p>$$
\nabla_{\boldsymbol{\theta}} \mathcal{L}_{\text{aux}} = \sum_{i=1}^{n} F_i \nabla P_i \approx \frac{1}{n} \sum_{i=1}^{n} \nabla P_i = 0
$$</p>
<p>Aux Lossçš„å½±å“å‡å¼±ï¼Œæ¨¡å‹ä¸»è¦ä¼˜åŒ–ä»»åŠ¡æŸå¤±ã€‚</p>
<h3 id="9">9. æ€»ç»“ä¸æ‰©å±•</h3>
<p>é€šè¿‡ä»¥ä¸Š40ä¸ªè¯¦ç»†æ¨å¯¼ï¼Œæˆ‘ä»¬ä»æ•°å­¦è§’åº¦æ·±å…¥ç†è§£äº†MoEè´Ÿè½½å‡è¡¡é—®é¢˜ï¼š</p>
<ol>
<li><strong>MoEæ¶æ„</strong>ï¼šå»ºç«‹äº†ä¸¥æ ¼çš„æ•°å­¦å®šä¹‰ï¼ŒåŒ…æ‹¬æ ‡å‡†MoEå’Œå‡ ä½•MoE</li>
<li><strong>è´Ÿè½½é—®é¢˜</strong>ï¼šé‡åŒ–äº†è´Ÿè½½ä¸å‡è¡¡çš„ä»£ä»·ï¼ˆDead Expertã€Token Dropï¼‰</li>
<li><strong>Aux Lossè®¾è®¡</strong>ï¼šé€šè¿‡STEæŠ€å·§æ¨å¯¼äº†æ ‡å‡†Aux Lossçš„æ¢¯åº¦ç­‰ä»·æ€§</li>
<li><strong>å‡åŒ€åˆ†å¸ƒ</strong>ï¼šä»ä¿¡æ¯è®ºï¼ˆç†µï¼‰å’Œå®¹é‡åˆ©ç”¨è§’åº¦è¯æ˜äº†å‡åŒ€åˆ†å¸ƒçš„å¿…è¦æ€§</li>
<li><strong>ç†µæ­£åˆ™åŒ–</strong>ï¼šå±•ç¤ºäº†åŸºäºç†µçš„Aux Lossä¸ç‚¹ç§¯å½¢å¼çš„è”ç³»</li>
<li><strong>ç­–ç•¥å¯¹æ¯”</strong>ï¼šæ¯”è¾ƒäº†L1ã€L2ã€ç†µã€Minimaxç­‰ä¸åŒå¹³è¡¡ç­–ç•¥</li>
<li><strong>æ”¶æ•›æ€§</strong>ï¼šåˆ†æäº†Aux Lossçš„æ”¶æ•›æ¡ä»¶å’ŒLyapunovç¨³å®šæ€§</li>
<li><strong>å®éªŒç†è®º</strong>ï¼šè§£é‡Šäº†Aux Lossæƒé‡ã€è®­ç»ƒåŠ¨æ€ç­‰å®éªŒç°è±¡</li>
</ol>
<p>è¿™äº›æ¨å¯¼ä¸ºç†è§£å’Œæ”¹è¿›MoEè´Ÿè½½å‡è¡¡æä¾›äº†åšå®çš„ç†è®ºåŸºç¡€ã€‚</p>
<hr />
<h3 id="1">ç¬¬1éƒ¨åˆ†ï¼šæ ¸å¿ƒç†è®ºã€å…¬ç†ä¸å†å²åŸºç¡€</h3>
<h4 id="11">1.1 è´Ÿè½½å‡è¡¡é—®é¢˜çš„ç†è®ºèµ·æº</h4>
<div class="theorem-box">

**å¤šæ¥æºèåˆ**ï¼š

è´Ÿè½½å‡è¡¡é—®é¢˜ä¸æ˜¯MoEç‰¹æœ‰çš„ï¼Œå®ƒæºäºå¤šä¸ªç»å…¸é¢†åŸŸï¼š

- **å¹¶è¡Œè®¡ç®—** (1980s)ï¼šå¤šå¤„ç†å™¨ç³»ç»Ÿçš„ä»»åŠ¡åˆ†é…
- **èµ„æºè°ƒåº¦** (1990s)ï¼šæ“ä½œç³»ç»Ÿä¸­çš„è¿›ç¨‹è°ƒåº¦
- **åˆ†å¸ƒå¼ç³»ç»Ÿ** (2000s)ï¼šäº‘è®¡ç®—ä¸­çš„è´Ÿè½½å‡è¡¡å™¨
- **é›†æˆå­¦ä¹ ** (1990s)ï¼šBagging/Boostingä¸­çš„æ ·æœ¬åˆ†é…

</div>

<p><strong>MoEç‰¹æœ‰çš„æŒ‘æˆ˜</strong>ï¼š</p>
<p>ä¸ä¼ ç»Ÿè´Ÿè½½å‡è¡¡ä¸åŒï¼ŒMoEçš„è´Ÿè½½å‡è¡¡å…·æœ‰ä»¥ä¸‹ç‰¹æ®Šæ€§ï¼š</p>
<ol>
<li><strong>åŠ¨æ€æ€§</strong>ï¼šRouteræ˜¯å¯å­¦ä¹ çš„ï¼Œè´Ÿè½½åˆ†å¸ƒä¼šéšè®­ç»ƒåŠ¨æ€å˜åŒ–</li>
<li><strong>è€¦åˆæ€§</strong>ï¼šè´Ÿè½½å‡è¡¡ä¸æ¨¡å‹æ€§èƒ½ç›¸äº’å½±å“ï¼ˆä¸èƒ½ä¸ºäº†å‡è¡¡ç‰ºç‰²æ€§èƒ½ï¼‰</li>
<li><strong>ç¦»æ•£æ€§</strong>ï¼šTop-kæ“ä½œæ˜¯ä¸å¯å¾®çš„ï¼Œéœ€è¦ç‰¹æ®Šå¤„ç†</li>
</ol>
<p><strong>å…³é”®é‡Œç¨‹ç¢‘</strong>ï¼š</p>
<ol>
<li><strong>2017 - Shazeerç­‰äººï¼ˆGoogleï¼‰</strong>ï¼šé¦–æ¬¡åœ¨MoEä¸­å‘ç°ä¸¥é‡çš„è´Ÿè½½ä¸å‡è¡¡é—®é¢˜</li>
<li><strong>2020 - GShard</strong>ï¼šæå‡ºç»å…¸çš„è¾…åŠ©æŸå¤±$\mathcal{L}<em i="i">{\text{aux}} = n \sum</em> F_i P_i$</li>
<li><strong>2021 - Switch Transformer</strong>ï¼šç®€åŒ–ä¸ºTop-1ä½†æ›´å¼ºè°ƒè´Ÿè½½å‡è¡¡ï¼Œå¼•å…¥Expert Capacity</li>
<li><strong>2022 - ST-MoE</strong>ï¼šæå‡ºRouter Z-lossï¼Œä»logitså±‚é¢æ­£åˆ™åŒ–</li>
<li><strong>2024 - DeepSeek-V3</strong>ï¼šåŠ¨æ€å®¹é‡è°ƒæ•´ï¼Œå°†Tokenä¸¢å¼ƒç‡é™è‡³&lt;3%</li>
</ol>
<h4 id="12">1.2 è´Ÿè½½å‡è¡¡çš„æ•°å­¦å…¬ç†</h4>
<div class="theorem-box">

### å…¬ç†1ï¼šå®¹é‡å®ˆæ’å®šå¾‹

**è¡¨è¿°**ï¼šåœ¨å›ºå®šç¡¬ä»¶èµ„æºä¸‹ï¼Œæ€»è®¡ç®—å®¹é‡æ˜¯å®ˆæ’çš„ã€‚

$$\sum_{i=1}^{n} C_i = C_{\text{total}} = \text{const}$$

å…¶ä¸­$C_i$æ˜¯Expert $i$çš„å®¹é‡ï¼ˆå¯å¤„ç†çš„Tokenæ•°ï¼‰ã€‚

**æ¨è®º**ï¼šè¦æœ€å¤§åŒ–åˆ©ç”¨ç‡ï¼Œåº”ä½¿æ‰€æœ‰Expertçš„è´Ÿè½½æ¥è¿‘å…¶å®¹é‡ä¸Šé™ã€‚

</div>

<div class="theorem-box">

### å…¬ç†2ï¼šæ¢¯åº¦ç¨€ç–æ€§åŸç†

**è¡¨è¿°**ï¼šæœªè¢«é€‰ä¸­çš„Expertæ— æ³•è·å¾—æ¢¯åº¦æ›´æ–°ã€‚

$$\frac{\partial \mathcal{L}}{\partial \boldsymbol{\theta}_i} = 0 \quad \text{å½“Expert } i \text{ æœªè¢«ä»»ä½•Tokené€‰æ‹©æ—¶}$$

**æ¨è®º**ï¼šé•¿æœŸæœªè¢«é€‰ä¸­çš„Expertå°†æˆä¸ºDead Expertï¼Œå‚æ•°åœæ­¢å­¦ä¹ ã€‚

</div>

<div class="theorem-box">

### å…¬ç†3ï¼šRich-Get-Richeræ•ˆåº”

**è¡¨è¿°**ï¼šè¡¨ç°å¥½çš„Expertä¼šè¢«æ›´é¢‘ç¹é€‰æ‹©ï¼Œå½¢æˆæ­£åé¦ˆå¾ªç¯ã€‚

è®¾$F_i^{(t)}$æ˜¯æ—¶é—´$t$æ—¶Expert $i$çš„è´Ÿè½½ï¼Œ$Q_i^{(t)}$æ˜¯å…¶æ€§èƒ½è´¨é‡ï¼Œåˆ™ï¼š

$$F_i^{(t+1)} \propto F_i^{(t)} \cdot Q_i^{(t)}$$

**æ¨è®º**ï¼šæ— çº¦æŸçš„MoEè®­ç»ƒä¼šè‡ªç„¶åœ°å¯¼è‡´è´Ÿè½½é›†ä¸­åŒ–ã€‚

</div>

<h4 id="13">1.3 è®¾è®¡å“²å­¦</h4>
<p>è´Ÿè½½å‡è¡¡çš„æ ¸å¿ƒå“²å­¦æ˜¯<strong>"å…¬å¹³æ€§ä¸æ•ˆç‡çš„æƒè¡¡"</strong>ï¼š</p>
<p><strong>å…¬å¹³æ€§ï¼ˆFairnessï¼‰</strong>ï¼š
- æ¯ä¸ªExpertåº”è¯¥æœ‰å…¬å¹³çš„å­¦ä¹ æœºä¼š
- ç±»æ¯”ï¼šå¦‚åŒå­¦ç”Ÿåˆ†ç»„ï¼Œæ¯ç»„åº”æœ‰ç›¸ä¼¼çš„å­¦ä¹ èµ„æº
- ç›®æ ‡ï¼š$F_i \approx \frac{1}{n}, \forall i$</p>
<p><strong>æ•ˆç‡æ€§ï¼ˆEfficiencyï¼‰</strong>ï¼š
- åº”è¯¥è®©"æ“…é•¿"çš„Expertå¤„ç†æ›´å¤šä»»åŠ¡
- ç±»æ¯”ï¼šå¦‚åŒä¸“å®¶å’¨è¯¢ï¼Œæ‰¾æœ€åˆé€‚çš„ä¸“å®¶
- ç›®æ ‡ï¼š$\sum_{i} F_i Q_i$æœ€å¤§åŒ–ï¼ˆ$Q_i$æ˜¯è´¨é‡ï¼‰</p>
<p><strong>æƒè¡¡ç‚¹</strong>ï¼š
- å®Œå…¨å…¬å¹³ï¼ˆå‡åŒ€åˆ†å¸ƒï¼‰ï¼šå¯èƒ½ç‰ºç‰²æ€§èƒ½
- å®Œå…¨æ•ˆç‡ï¼ˆé›†ä¸­åˆ†å¸ƒï¼‰ï¼šèµ„æºæµªè´¹ï¼Œéƒ¨åˆ†Expertæ— ç”¨</p>
<p><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼šé€šè¿‡Aux Losså®ç°"è½¯çº¦æŸ"å‡è¡¡</p>
<hr />
<h3 id="3">ç¬¬3éƒ¨åˆ†ï¼šæ•°å­¦ç›´è§‰ã€å¤šè§’åº¦è§£é‡Šä¸ç±»æ¯”</h3>
<h4 id="31">3.1 ç”Ÿæ´»åŒ–ç±»æ¯”</h4>
<div class="intuition-box">

### ğŸ§  ç›´è§‰ç†è§£1ï¼šé¤å…çš„æœåŠ¡å‘˜åˆ†é…

**åœºæ™¯**ï¼šä¸€å®¶é¤å…æœ‰8ä¸ªæœåŠ¡å‘˜ï¼ˆExpertï¼‰ï¼Œé¡¾å®¢ï¼ˆTokenï¼‰éœ€è¦è¢«åˆ†é…ç»™æœåŠ¡å‘˜ã€‚

**æ— è´Ÿè½½å‡è¡¡**ï¼š
- é¡¾å®¢è‡ªç”±é€‰æ‹©æœåŠ¡å‘˜
- ç»“æœï¼šé¢œå€¼é«˜/æœåŠ¡å¥½çš„æœåŠ¡å‘˜1ã€2è¢«ç–¯ç‹‚æ’é˜Ÿ
- æœåŠ¡å‘˜3-8å‡ ä¹æ— äººé—®æ´¥
- **é—®é¢˜**ï¼š
  - æœåŠ¡å‘˜1ã€2ç´¯æ­»ï¼Œå¤„ç†ä¸è¿‡æ¥ï¼Œé¡¾å®¢æ’é•¿é˜Ÿ
  - æœåŠ¡å‘˜3-8é—²ç½®ï¼Œæµªè´¹äººåŠ›æˆæœ¬
  - æœåŠ¡å‘˜3-8å¾—ä¸åˆ°é”»ç‚¼ï¼ŒæŠ€èƒ½é€€åŒ–

**æœ‰è´Ÿè½½å‡è¡¡ï¼ˆAux Lossï¼‰**ï¼š
- é¤å…ç»ç†ï¼ˆAux Lossï¼‰å¼ºåˆ¶è¦æ±‚ï¼šæ¯ä¸ªæœåŠ¡å‘˜æ¥å¾…çš„é¡¾å®¢æ•°åº”è¯¥æ¥è¿‘
- å¦‚æœæŸæœåŠ¡å‘˜è´Ÿè½½è¿‡é«˜ï¼Œç»™ç»ç†æ‰£åˆ†ï¼ˆå¢åŠ æŸå¤±ï¼‰
- **æ•ˆæœ**ï¼š
  - æ‰€æœ‰æœåŠ¡å‘˜éƒ½æœ‰å·¥ä½œï¼Œéƒ½èƒ½å¾—åˆ°é”»ç‚¼
  - é¡¾å®¢ç­‰å¾…æ—¶é—´å‡å°‘
  - äººåŠ›èµ„æºåˆ©ç”¨ç‡æå‡

**å…³é”®**ï¼šå¹³è¡¡"é¡¾å®¢æ»¡æ„åº¦"ï¼ˆä»»åŠ¡æ€§èƒ½ï¼‰å’Œ"è´Ÿè½½å‡åŒ€"ï¼ˆèµ„æºåˆ©ç”¨ï¼‰

</div>

<div class="intuition-box">

### ğŸ§  ç›´è§‰ç†è§£2ï¼šæ°´æ¡¶è£…æ°´çš„æ¯”å–»

**åœºæ™¯**ï¼šæœ‰$n$ä¸ªæ°´æ¡¶ï¼ˆExpertï¼‰ï¼Œè¦è£…$T$å‡æ°´ï¼ˆTokenï¼‰ã€‚

**æ— è´Ÿè½½å‡è¡¡**ï¼š
- æ°´ï¼ˆTokenï¼‰è‡ªç”±æµå‘æ¡¶ï¼ˆé€šè¿‡Routerï¼‰
- æŸäº›æ¡¶ç‰¹åˆ«"å¸å¼•"æ°´ï¼ˆRouteråå¥½ï¼‰
- ç»“æœï¼šéƒ¨åˆ†æ¡¶è£…æ»¡æº¢å‡ºï¼ˆToken Dropï¼‰ï¼Œéƒ¨åˆ†æ¡¶ç©ºç€

**è´Ÿè½½å‡è¡¡çš„ç›®æ ‡**ï¼š
- è®©æ‰€æœ‰æ¡¶çš„æ°´ä½æ¥è¿‘ï¼š$h_i \approx \frac{T}{n}$
- **æ–¹æ³•1ï¼ˆç¡¬çº¦æŸï¼‰**ï¼šæ¯ä¸ªæ¡¶è®¾ç½®å®¹é‡ä¸Šé™$C$ï¼Œè¶…å‡ºå°±æº¢å‡º
  - é—®é¢˜ï¼šæº¢å‡ºçš„æ°´æµªè´¹äº†ï¼ˆToken DropæŸå¤±ä¿¡æ¯ï¼‰
- **æ–¹æ³•2ï¼ˆè½¯çº¦æŸï¼ŒAux Lossï¼‰**ï¼šç»™"æ°´ä½ä¸å‡"å¢åŠ æƒ©ç½š
  - ä¼˜åŒ–å™¨ä¼šè°ƒæ•´Routerï¼Œä½¿æ°´æ›´å‡åŒ€åœ°åˆ†é…
  - æ²¡æœ‰ç¡¬æ€§æº¢å‡ºï¼Œä½†é€šè¿‡æ¢¯åº¦å¼•å¯¼

**æ•°å­¦è¡¨è¾¾**ï¼š
$$\text{Variance}(\{h_i\}) = \sum_{i=1}^{n} (h_i - \bar{h})^2 \to \min$$

</div>

<div class="intuition-box">

### ğŸ§  ç›´è§‰ç†è§£3ï¼šé©¬å¤ªæ•ˆåº”çš„æŠ‘åˆ¶

**é©¬å¤ªæ•ˆåº”**ï¼š"å¯Œè€…æ„ˆå¯Œï¼Œç©·è€…æ„ˆç©·"

åœ¨MoEä¸­ä½“ç°ä¸ºï¼š
- Expert $i$è¡¨ç°å¥½ â†’ Routeræ›´å€¾å‘é€‰å®ƒ â†’ è·å¾—æ›´å¤šè®­ç»ƒæ•°æ® â†’ è¿›ä¸€æ­¥å˜å¥½
- Expert $j$è¡¨ç°å·® â†’ Routerå¾ˆå°‘é€‰å®ƒ â†’ ç¼ºä¹è®­ç»ƒ â†’ è¿›ä¸€æ­¥å˜å·® â†’ æˆä¸ºDead Expert

**Aux Lossçš„ä½œç”¨**ï¼š
- ç±»ä¼¼"è´¢å¯Œå†åˆ†é…"æ”¿ç­–
- ç»™è´Ÿè½½é«˜çš„Expertå¢åŠ "ç¨æ”¶"ï¼ˆæŸå¤±ï¼‰
- é¼“åŠ±Routeré€‰æ‹©è´Ÿè½½ä½çš„Expert
- æœ€ç»ˆè¾¾åˆ°"å…±åŒå¯Œè£•"ï¼ˆå‡åŒ€åˆ†å¸ƒï¼‰

**ç±»æ¯”**ï¼š
- æ— è°ƒæ§çš„å¸‚åœºç»æµ â†’ è´Ÿè½½ä¸å‡è¡¡
- æœ‰ç¦åˆ©æ”¿ç­–çš„ç»æµ â†’ è´Ÿè½½å‡è¡¡ï¼ˆAux Lossï¼‰

</div>

<h4 id="32">3.2 å‡ ä½•æ„ä¹‰</h4>
<p><strong>å‡ ä½•è§†è§’1ï¼šåˆ†å¸ƒç©ºé—´ä¸­çš„è·ç¦»</strong></p>
<div class="intuition-box">

å°†è´Ÿè½½åˆ†å¸ƒ$\boldsymbol{F} = (F_1, \ldots, F_n)$è§†ä¸º$n$ç»´ç©ºé—´ä¸­çš„ç‚¹ï¼Œæ»¡è¶³ï¼š

$$\sum_{i=1}^{n} F_i = 1, \quad F_i \geq 0$$

è¿™æ˜¯$n$ç»´å•çº¯å½¢ï¼ˆSimplexï¼‰$\Delta^{n-1}$ã€‚

**ç›®æ ‡å‡åŒ€åˆ†å¸ƒ**ï¼š
$$\boldsymbol{Q} = \left(\frac{1}{n}, \ldots, \frac{1}{n}\right)$$

è¿™æ˜¯å•çº¯å½¢çš„**ä¸­å¿ƒç‚¹**ï¼ˆè´¨å¿ƒï¼‰ã€‚

**è´Ÿè½½å‡è¡¡**ï¼š
- å°±æ˜¯å°†å½“å‰åˆ†å¸ƒ$\boldsymbol{F}$æ‹‰å‘ä¸­å¿ƒç‚¹$\boldsymbol{Q}$
- Aux Loss $\|\boldsymbol{F} - \boldsymbol{Q}\|^2$æ˜¯æ¬§æ°è·ç¦»
- ç†µæ­£åˆ™åŒ–$-H(\boldsymbol{F})$æ˜¯å¦ä¸€ç§"è·ç¦»"ï¼ˆKLæ•£åº¦ï¼‰

**å¯è§†åŒ–**ï¼ˆ$n=3$æƒ…å†µï¼‰ï¼š
- å•çº¯å½¢æ˜¯ä¸€ä¸ªä¸‰è§’å½¢ï¼ˆå¹³é¢ï¼‰
- é¡¶ç‚¹$(1, 0, 0), (0, 1, 0), (0, 0, 1)$ï¼šæç«¯ä¸å‡è¡¡
- ä¸­å¿ƒç‚¹$(\frac{1}{3}, \frac{1}{3}, \frac{1}{3})$ï¼šå®Œå…¨å‡è¡¡
- Aux Lossçš„æ¢¯åº¦æŒ‡å‘ä¸­å¿ƒ

</div>

<p><strong>å‡ ä½•è§†è§’2ï¼šå‘é‡åœºä¸å¸å¼•å­</strong></p>
<div class="intuition-box">

å°†è´Ÿè½½æ¼”åŒ–è§†ä¸ºåŠ¨åŠ›ç³»ç»Ÿï¼š

$$\frac{d\boldsymbol{F}}{dt} = -\nabla_{\boldsymbol{F}} \mathcal{L}_{\text{aux}}$$

**æ— Aux Loss**ï¼š
- å‘é‡åœºå¯èƒ½æœ‰å¤šä¸ªä¸åŠ¨ç‚¹ï¼ˆå¸å¼•å­ï¼‰
- éƒ¨åˆ†å¸å¼•å­åœ¨å•çº¯å½¢çš„é¡¶ç‚¹é™„è¿‘ï¼ˆæç«¯ä¸å‡è¡¡ï¼‰

**æœ‰Aux Loss**ï¼š
- æ·»åŠ ä¸€ä¸ªæŒ‡å‘ä¸­å¿ƒ$\boldsymbol{Q}$çš„åŠ›åœº
- ä¸­å¿ƒç‚¹æˆä¸ºå…¨å±€å¸å¼•å­
- æ‰€æœ‰è½¨è¿¹æœ€ç»ˆæ”¶æ•›åˆ°ä¸­å¿ƒ

**ç±»æ¯”**ï¼š
- æ— Aux Loss = é‡åŠ›åœºï¼Œç‰©ä½“å¯èƒ½è½åˆ°å„ç§ä½æ´¼å¤„
- æœ‰Aux Loss = é¢å¤–åŠ ä¸€ä¸ª"ç£åŠ›"ï¼ŒæŠŠæ‰€æœ‰ç‰©ä½“å¸å‘ä¸­å¿ƒ

</div>

<h4 id="33">3.3 å¤šè§’åº¦ç†è§£</h4>
<p><strong>ğŸ“Š æ¦‚ç‡è®ºè§†è§’</strong></p>
<div class="intuition-box">

**ç†µä¸ä¸ç¡®å®šæ€§**ï¼š

Shannonç†µå®šä¹‰ï¼š
$$H(\boldsymbol{F}) = -\sum_{i=1}^{n} F_i \log F_i$$

- ç†µè¡¡é‡åˆ†å¸ƒçš„"ä¸ç¡®å®šæ€§"æˆ–"éšæœºæ€§"
- å‡åŒ€åˆ†å¸ƒ$\boldsymbol{Q}$çš„ç†µæœ€å¤§ï¼š$H(\boldsymbol{Q}) = \log n$
- æç«¯åˆ†å¸ƒï¼ˆå¦‚$(1, 0, \ldots, 0)$ï¼‰çš„ç†µæœ€å°ï¼š$H = 0$

**è´Ÿè½½å‡è¡¡ = ç†µæœ€å¤§åŒ–**ï¼š
- ç›®æ ‡ï¼š$H(\boldsymbol{F}) \to \max$
- ç­‰ä»·äºæœ€å°åŒ–$-H(\boldsymbol{F})$
- Aux Loss $\sum_{i} P_i \log F_i$è¿‘ä¼¼ç†µæ­£åˆ™åŒ–

**ç›´è§‰**ï¼šå‡åŒ€åˆ†å¸ƒæ„å‘³ç€"æœ€ä¸ç¡®å®š"ï¼Œå³æ‰€æœ‰Expertè¢«é€‰ä¸­çš„æ¦‚ç‡æ¥è¿‘ã€‚

</div>

<p><strong>ğŸ“¡ ä¿¡æ¯è®ºè§†è§’</strong></p>
<div class="intuition-box">

**KLæ•£åº¦**ï¼š

ä»å½“å‰åˆ†å¸ƒ$\boldsymbol{F}$åˆ°ç›®æ ‡å‡åŒ€åˆ†å¸ƒ$\boldsymbol{Q}$çš„KLæ•£åº¦ï¼š

$$D_{KL}(\boldsymbol{F} \| \boldsymbol{Q}) = \sum_{i=1}^{n} F_i \log \frac{F_i}{Q_i} = \sum_{i=1}^{n} F_i \log(n F_i) = \log n - H(\boldsymbol{F})$$

**æœ€å°åŒ–KLæ•£åº¦**ï¼š
- KLæ•£åº¦è¡¡é‡ä¸¤ä¸ªåˆ†å¸ƒçš„"å·®å¼‚"
- $D_{KL}(\boldsymbol{F} \| \boldsymbol{Q}) = 0$å½“ä¸”ä»…å½“$\boldsymbol{F} = \boldsymbol{Q}$
- æœ€å°åŒ–KLç­‰ä»·äºæœ€å¤§åŒ–ç†µ

**ä¿¡æ¯ç¼–ç è§£é‡Š**ï¼š
- å¦‚æœç”¨$\boldsymbol{Q}$çš„ç¼–ç æ–¹æ¡ˆå»ç¼–ç æœä»$\boldsymbol{F}$çš„æ•°æ®
- KLæ•£åº¦æ˜¯é¢å¤–çš„å¹³å‡ç¼–ç é•¿åº¦
- å‡åŒ€åˆ†å¸ƒæ˜¯"æœ€ç»æµ"çš„ç¼–ç 

</div>

<p><strong>ğŸ¯ ä¼˜åŒ–è§†è§’</strong></p>
<div class="intuition-box">

**æ‹‰æ ¼æœ—æ—¥ä¹˜æ•°æ³•**ï¼š

è´Ÿè½½å‡è¡¡å¯ä»¥çœ‹ä½œçº¦æŸä¼˜åŒ–ï¼š

$$\min_{\boldsymbol{\theta}} \mathcal{L}_{\text{task}}(\boldsymbol{\theta}) \quad \text{s.t.} \quad \|\boldsymbol{F}(\boldsymbol{\theta}) - \boldsymbol{Q}\|^2 \leq \epsilon$$

ç”¨æ‹‰æ ¼æœ—æ—¥ä¹˜æ•°æ³•è½¬åŒ–ä¸ºæ— çº¦æŸï¼š

$$\min_{\boldsymbol{\theta}} \mathcal{L}_{\text{task}}(\boldsymbol{\theta}) + \lambda \|\boldsymbol{F}(\boldsymbol{\theta}) - \boldsymbol{Q}\|^2$$

å…¶ä¸­$\lambda$æ˜¯æ‹‰æ ¼æœ—æ—¥ä¹˜å­ï¼ˆå¯¹åº”Aux Lossçš„æƒé‡$\alpha$ï¼‰ã€‚

**ç›´è§‰**ï¼š
- Aux Lossæ˜¯"è½¯çº¦æŸ"
- $\alpha$æ§åˆ¶çº¦æŸçš„"ç¡¬åº¦"
- $\alpha \to \infty$ï¼šç¡¬çº¦æŸï¼Œå¼ºåˆ¶$\boldsymbol{F} = \boldsymbol{Q}$
- $\alpha \to 0$ï¼šæ— çº¦æŸï¼Œå…è®¸ä»»æ„åˆ†å¸ƒ

</div>

<p><strong>ğŸ”„ åšå¼ˆè®ºè§†è§’</strong></p>
<div class="intuition-box">

**Nashå‡è¡¡**ï¼š

å°†MoEè§†ä¸º$n$ä¸ªExpertä¹‹é—´çš„åšå¼ˆï¼š
- æ¯ä¸ªExpertå¸Œæœ›æœ€å¤§åŒ–è‡ªå·±çš„è´Ÿè½½ï¼ˆè·å¾—æ›´å¤šè®­ç»ƒï¼‰
- ä½†æ€»è´Ÿè½½å—é™ï¼š$\sum_{i} F_i = 1$

**æ— Aux Loss**ï¼š
- ç«äº‰æ€§åšå¼ˆï¼Œå¼ºè€…èƒœå‡º
- Nashå‡è¡¡å¯èƒ½åœ¨æç«¯ç‚¹ï¼ˆæŸExpertå æ®å¤§éƒ¨åˆ†è´Ÿè½½ï¼‰

**æœ‰Aux Loss**ï¼š
- å¼•å…¥"åˆä½œæ¿€åŠ±"
- Nashå‡è¡¡ç§»å‘å‡åŒ€åˆ†å¸ƒ
- ç±»ä¼¼"å…¬å…±èµ„æºç®¡ç†"é—®é¢˜ä¸­çš„åè°ƒæœºåˆ¶

</div>

<hr />
<h3 id="4_1">ç¬¬4éƒ¨åˆ†ï¼šæ‰¹åˆ¤æ€§æ¯”è¾ƒä¸ä¼˜åŒ–</h3>
<h4 id="41_1">4.1 ä¸»æµè´Ÿè½½å‡è¡¡æ–¹æ³•å¯¹æ¯”è¡¨</h4>
<table>
<thead>
<tr>
<th>æ–¹æ³•</th>
<th>æ ¸å¿ƒæ€æƒ³</th>
<th>ä¼˜ç‚¹</th>
<th><strong>ç¼ºé™·</strong></th>
<th><strong>ä¼˜åŒ–æ–¹å‘</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>GShard Aux Loss</strong></td>
<td>$\mathcal{L}_{\text{aux}} = \sum F_i P_i$</td>
<td>âœ… ç®€å•æœ‰æ•ˆ<br>âœ… æ¢¯åº¦ç¨³å®š<br>âœ… å¹¿æ³›éªŒè¯</td>
<td>âŒ <strong>ä¸æ˜¯çœŸæ­£çš„æŸå¤±</strong>ï¼ˆéå•è°ƒï¼‰<br>âŒ è¶…å‚$\alpha$æ•æ„Ÿ<br>âŒ å¯èƒ½è¿‡åº¦å‡è¡¡</td>
<td>âœ… è‡ªé€‚åº”$\alpha$<br>âœ… ç»“åˆç†µæ­£åˆ™<br>âœ… åˆ†å±‚å¹³è¡¡</td>
</tr>
<tr>
<td><strong>Switch Transformer Capacity</strong></td>
<td>ç¡¬å®¹é‡é™åˆ¶$C_i$ + Token Drop</td>
<td>âœ… ä¸¥æ ¼æ§åˆ¶è´Ÿè½½<br>âœ… é¿å…OOM</td>
<td>âŒ <strong>Tokenä¸¢å¼ƒæŸå¤±ä¿¡æ¯</strong><br>âŒ å®¹é‡è®¾ç½®å›°éš¾<br>âŒ ä¸¢å¼ƒç‡5%-15%</td>
<td>âœ… åŠ¨æ€å®¹é‡<br>âœ… æº¢å‡ºé‡è·¯ç”±<br>âœ… è½¯å®¹é‡çº¦æŸ</td>
</tr>
<tr>
<td><strong>ç†µæ­£åˆ™åŒ–</strong></td>
<td>$\mathcal{L}_{\text{entropy}} = -H(\boldsymbol{F})$</td>
<td>âœ… ç†è®ºä¼˜é›…<br>âœ… ä¿¡æ¯è®ºä¿è¯</td>
<td>âŒ <strong>è®¡ç®—å¤æ‚</strong>ï¼ˆéœ€EMA $\boldsymbol{F}$ï¼‰<br>âŒ ä¸GShardæ¢¯åº¦ç›¸ä¼¼<br>âŒ å®é™…å¢ç›Šæœ‰é™</td>
<td>âœ… ç®€åŒ–è¿‘ä¼¼<br>âœ… ä¸Aux Lossç»“åˆ<br>âœ… å±‚æ¬¡ç†µ</td>
</tr>
<tr>
<td><strong>Router Z-Loss (ST-MoE)</strong></td>
<td>æ­£åˆ™åŒ–Router logits</td>
<td>âœ… ç›´æ¥çº¦æŸRouter<br>âœ… æ•°å€¼ç¨³å®šæ€§å¥½</td>
<td>âŒ <strong>ä¸ç›´æ¥ä¼˜åŒ–è´Ÿè½½</strong><br>âŒ éœ€é¢å¤–è¶…å‚<br>âŒ ç†è®ºä¸å¦‚Aux Lossæ¸…æ™°</td>
<td>âœ… ä¸Aux Lossè”åˆ<br>âœ… è‡ªé€‚åº”æƒé‡<br>âœ… åˆ†ææœ€ä¼˜logitsåˆ†å¸ƒ</td>
</tr>
<tr>
<td><strong>Expert Dropout</strong></td>
<td>è®­ç»ƒæ—¶éšæœºä¸¢å¼ƒExpert</td>
<td>âœ… å‡å°‘ä¾èµ–æ€§<br>âœ… æå‡æ³›åŒ–</td>
<td>âŒ <strong>ç ´åè´Ÿè½½ç»Ÿè®¡</strong><br>âŒ è®­ç»ƒä¸ç¨³å®š<br>âŒ ä¸Top-kå†²çª</td>
<td>âœ… è‡ªé€‚åº”ä¸¢å¼ƒç‡<br>âœ… åªåœ¨æ¨ç†æ—¶dropout<br>âœ… ç»“æ„åŒ–dropout</td>
</tr>
</tbody>
</table>
<h4 id="42-gshard-aux-loss-">4.2 GShard Aux Loss - æ‰¹åˆ¤æ€§åˆ†æ</h4>
<div class="analysis-box">

### **æ ¸å¿ƒç¼ºé™·**

**ç¼ºé™·1ï¼šéå•è°ƒæ€§ï¼ˆNot a True Lossï¼‰**

**é—®é¢˜æè¿°**ï¼š
- æ ‡å‡†æŸå¤±å‡½æ•°åº”è¯¥"è¶Šå°è¶Šå¥½"ï¼Œä¸”æœ€å°å€¼å¯¹åº”æœ€ä¼˜è§£
- ä½†$\mathcal{L}_{\text{aux}} = \sum_{i} F_i P_i$ä¸æ»¡è¶³è¿™ä¸€æ€§è´¨

**æ•°å­¦è¯æ˜**ï¼š

è®¾$\boldsymbol{F} = \boldsymbol{Q} = (\frac{1}{n}, \ldots, \frac{1}{n})$ï¼ˆå®Œå…¨å‡è¡¡ï¼‰ï¼Œåˆ™ï¼š

$$\mathcal{L}_{\text{aux}} = \sum_{i=1}^{n} \frac{1}{n} \cdot \frac{1}{n} = \frac{1}{n}$$

ä½†è€ƒè™‘$\boldsymbol{F} = (1, 0, \ldots, 0)$ï¼ˆæç«¯ä¸å‡è¡¡ï¼‰ï¼Œ$\boldsymbol{P} = (0, \frac{1}{n-1}, \ldots, \frac{1}{n-1})$ï¼š

$$\mathcal{L}_{\text{aux}} = 1 \cdot 0 + 0 \cdot \frac{1}{n-1} + \cdots = 0 < \frac{1}{n}$$

æç«¯ä¸å‡è¡¡çš„æŸå¤±åè€Œæ›´å°ï¼

**æ ¹æœ¬åŸå› **ï¼š
- $\mathcal{L}_{\text{aux}}$åªä¿è¯äº†æ¢¯åº¦ç­‰ä»·æ€§
- å…¶æ•°å€¼æœ¬èº«æ— æ„ä¹‰
- è¿™æ˜¯STEæŠ€å·§çš„å‰¯ä½œç”¨

**å®šé‡å½±å“**ï¼š
- æ— æ³•ç”¨æŸå¤±å€¼ç›‘æ§å‡è¡¡ç¨‹åº¦
- éœ€è¦é¢å¤–è·Ÿè¸ª$\boldsymbol{F}$çš„ç»Ÿè®¡é‡ï¼ˆå¦‚æ–¹å·®ï¼‰
- è°ƒè¯•æ—¶å®¹æ˜“è¯¯è§£

---

**ç¼ºé™·2ï¼šè¶…å‚æ•°$\alpha$æ•æ„Ÿ**

**é—®é¢˜æè¿°**ï¼š
- Aux Lossæƒé‡$\alpha$éœ€è¦ç²¾å¿ƒè°ƒä¼˜
- ä¸åŒæ¨¡å‹ã€æ•°æ®é›†ã€$n$å€¼éœ€è¦ä¸åŒçš„$\alpha$
- æ²¡æœ‰ç†è®ºæŒ‡å¯¼å¦‚ä½•é€‰æ‹©$\alpha$

**å®éªŒæ•°æ®**ï¼ˆæ–‡çŒ®æŠ¥å‘Šï¼‰ï¼š

| æ¨¡å‹è§„æ¨¡ | æœ€ä¼˜$\alpha$ | æ€§èƒ½ä¸‹é™ï¼ˆ$\alpha$åç¦»50%æ—¶ï¼‰ |
|---------|-------------|----------------------------|
| å°æ¨¡å‹ï¼ˆ<1Bï¼‰ | 0.01-0.05 | 5%-10% |
| ä¸­æ¨¡å‹ï¼ˆ1-10Bï¼‰ | 0.001-0.01 | 3%-8% |
| å¤§æ¨¡å‹ï¼ˆ>10Bï¼‰ | 0.0001-0.001 | 2%-5% |

**æ ¹æœ¬åŸå› **ï¼š
- $\mathcal{L}_{\text{task}}$å’Œ$\mathcal{L}_{\text{aux}}$çš„é‡çº²ä¸åŒ
- éšè®­ç»ƒåŠ¨æ€å˜åŒ–
- æ•°æ®åˆ†å¸ƒå½±å“

**ä¼˜åŒ–æ–¹å‘**ï¼š
$$\alpha(t) = \alpha_0 \cdot \exp(-\beta t) + \alpha_{\min}$$

åŠ¨æ€è¡°å‡ï¼šåˆæœŸå¼ºå‡è¡¡ï¼ŒåæœŸå¼±å‡è¡¡ã€‚

---

**ç¼ºé™·3ï¼šè¿‡åº¦å‡è¡¡ç‰ºç‰²æ€§èƒ½**

**é—®é¢˜æè¿°**ï¼š
- è¿‡å¤§çš„$\alpha$ä¼šå¼ºåˆ¶Routerå‡åŒ€åŒ–
- ç‰ºç‰²"Expertä¸“é—¨åŒ–"çš„ä¼˜åŠ¿
- ç±»ä¼¼æŠŠæ‰€æœ‰Expertå˜æˆåŒè´¨åŒ–æ¨¡å‹

**ç†è®ºåˆ†æ**ï¼š

å½“$\alpha \to \infty$æ—¶ï¼Œä¼˜åŒ–é—®é¢˜é€€åŒ–ä¸ºï¼š

$$\min_{\boldsymbol{\theta}} \|\boldsymbol{F} - \boldsymbol{Q}\|^2$$

å®Œå…¨å¿½ç•¥ä»»åŠ¡æŸå¤±ï¼æ­¤æ—¶ï¼š
- æ‰€æœ‰Tokenå¹³å‡åˆ†é…åˆ°æ¯ä¸ªExpert
- Routerå¤±å»é€‰æ‹©èƒ½åŠ›
- MoEé€€åŒ–ä¸ºDenseæ¨¡å‹çš„è¿‘ä¼¼

**å®šé‡å½±å“**ï¼ˆSwitch Transformerè®ºæ–‡ï¼‰ï¼š
- $\alpha = 0$ï¼šè´Ÿè½½æ–¹å·®45%ï¼Œä»»åŠ¡æ€§èƒ½100%ï¼ˆåŸºå‡†ï¼‰
- $\alpha = 0.01$ï¼šè´Ÿè½½æ–¹å·®12%ï¼Œä»»åŠ¡æ€§èƒ½99.5%
- $\alpha = 0.1$ï¼šè´Ÿè½½æ–¹å·®3%ï¼Œä»»åŠ¡æ€§èƒ½95%

**ç”œç‚¹åŒº**ï¼š$\alpha \in [0.001, 0.01]$

---

### **ä¼˜åŒ–æ–¹å‘**

**ä¼˜åŒ–1ï¼šè‡ªé€‚åº”æƒé‡è°ƒæ•´**

**ç­–ç•¥**ï¼šæ ¹æ®å½“å‰è´Ÿè½½æ–¹å·®åŠ¨æ€è°ƒæ•´$\alpha$

$$\alpha(t) = \begin{cases}
\alpha_{\text{high}}, & \text{Var}(\boldsymbol{F}^{(t)}) > \tau_{\text{high}} \\
\alpha_{\text{low}}, & \text{Var}(\boldsymbol{F}^{(t)}) < \tau_{\text{low}} \\
\alpha_{\text{mid}}, & \text{otherwise}
\end{cases}$$

**å…¬å¼**ï¼ˆå¹³æ»‘ç‰ˆæœ¬ï¼‰ï¼š

$$\alpha(t) = \alpha_{\min} + (\alpha_{\max} - \alpha_{\min}) \cdot \sigma\left(\frac{\text{Var}(\boldsymbol{F}^{(t)}) - \tau}{\gamma}\right)$$

å…¶ä¸­$\sigma(\cdot)$æ˜¯Sigmoidï¼Œ$\tau$æ˜¯ç›®æ ‡æ–¹å·®ï¼Œ$\gamma$æ§åˆ¶å¹³æ»‘åº¦ã€‚

**æ•ˆæœ**ï¼š
- è´Ÿè½½æ–¹å·®ç¨³å®šåœ¨ç›®æ ‡å€¼$\tau$é™„è¿‘
- è‡ªåŠ¨å¹³è¡¡æ€§èƒ½ä¸å‡è¡¡
- å‡å°‘è¶…å‚è°ƒä¼˜è´Ÿæ‹…

---

**ä¼˜åŒ–2ï¼šç»“åˆç†µæ­£åˆ™åŒ–**

**ç­–ç•¥**ï¼šåŒæ—¶ä½¿ç”¨Aux Losså’Œç†µæ­£åˆ™

$$\mathcal{L}_{\text{total}} = \mathcal{L}_{\text{task}} + \alpha_1 \sum_{i} F_i P_i + \alpha_2 \cdot (-H(\boldsymbol{F}))$$

**ç›´è§‰**ï¼š
- Aux Lossï¼šæ‹‰å‘å‡åŒ€åˆ†å¸ƒï¼ˆæ¢¯åº¦è§†è§’ï¼‰
- ç†µæ­£åˆ™ï¼šæœ€å¤§åŒ–ä¸ç¡®å®šæ€§ï¼ˆä¿¡æ¯è®ºè§†è§’ï¼‰
- ä¸¤è€…äº’è¡¥ï¼Œè”åˆä¼˜åŒ–æ•ˆæœæ›´å¥½

**å®éªŒæ•ˆæœ**ï¼ˆåˆæ­¥ç»“æœï¼‰ï¼š
- è´Ÿè½½æ–¹å·®é™ä½10%-15%ï¼ˆvs å•ç‹¬Aux Lossï¼‰
- è®­ç»ƒç¨³å®šæ€§æå‡
- å¯¹$\alpha_1, \alpha_2$ä¸æ•æ„Ÿï¼ˆåªè¦æ¯”ä¾‹åˆç†ï¼‰

---

**ä¼˜åŒ–3ï¼šåˆ†å±‚è´Ÿè½½å‡è¡¡**

**é—®é¢˜**ï¼šä¸åŒå±‚çš„MoEå¯èƒ½æœ‰ä¸åŒçš„è´Ÿè½½æ¨¡å¼

**ç­–ç•¥**ï¼šæ¯å±‚ç‹¬ç«‹è®¡ç®—Aux Lossï¼Œå¹¶ä½¿ç”¨å±‚ç‰¹å®šçš„æƒé‡

$$\mathcal{L}_{\text{aux}}^{(\ell)} = \sum_{i=1}^{n} F_i^{(\ell)} P_i^{(\ell)}$$

$$\mathcal{L}_{\text{total}} = \mathcal{L}_{\text{task}} + \sum_{\ell=1}^{L} \alpha^{(\ell)} \mathcal{L}_{\text{aux}}^{(\ell)}$$

**è§‚å¯Ÿ**ï¼ˆDeepSeek-V3ç»éªŒï¼‰ï¼š
- æµ…å±‚MoEéœ€è¦æ›´å¼ºå‡è¡¡ï¼ˆ$\alpha^{(1)} = 0.01$ï¼‰
- æ·±å±‚MoEå¯ä»¥æ›´ä¸“é—¨åŒ–ï¼ˆ$\alpha^{(L)} = 0.001$ï¼‰

**æ•ˆæœ**ï¼š
- æ¯å±‚è¾¾åˆ°æœ€ä¼˜å¹³è¡¡
- æ•´ä½“æ€§èƒ½æå‡2%-3%

</div>

<h4 id="43-expert-capacity-">4.3 Expert Capacityæœºåˆ¶ - æ‰¹åˆ¤æ€§åˆ†æ</h4>
<div class="analysis-box">

### **æ ¸å¿ƒç¼ºé™·**

**ç¼ºé™·1ï¼šToken Dropå¯¼è‡´ä¿¡æ¯æŸå¤±**

**é—®é¢˜**ï¼šå½“Expertè´Ÿè½½è¶…è¿‡å®¹é‡$C_i$æ—¶ï¼Œè¶…å‡ºçš„Tokenè¢«ä¸¢å¼ƒ

**å®šé‡å½±å“**ï¼š

å‡è®¾Expert 1çš„å®¹é‡$C_1 = 100$ï¼Œä½†è¢«åˆ†é…äº†150ä¸ªTokenï¼Œåˆ™ï¼š

$$\text{Drop Rate}_1 = \frac{150 - 100}{150} = 33.3\%$$

è¿™33.3%çš„Tokenå®Œå…¨æ²¡æœ‰ç»è¿‡MoEå¤„ç†ï¼

**æ•°å­¦åˆ†æ**ï¼š

è®¾ä¸¢å¼ƒçš„Tokené›†åˆä¸º$\mathcal{D}$ï¼Œåˆ™è¿™äº›Tokençš„æ¢¯åº¦ï¼š

$$\frac{\partial \mathcal{L}}{\partial \boldsymbol{e}_i(\boldsymbol{x}_j)} = 0, \quad \forall j \in \mathcal{D}$$

**ç´¯ç§¯æ•ˆåº”**ï¼š
- å‡è®¾æ¯å±‚ä¸¢å¼ƒ5%
- 24å±‚Transformerï¼š$(1-0.05)^{24} = 0.29$
- åªæœ‰29%çš„Tokenå®Œæ•´ç»è¿‡æ‰€æœ‰å±‚ï¼

**ä¼˜åŒ–æ–¹å‘**ï¼š
- æº¢å‡ºé‡è·¯ç”±ï¼šå°†è¶…å‡ºTokenåˆ†é…ç»™æ¬¡ä¼˜Expert
- åŠ¨æ€å®¹é‡ï¼šæ ¹æ®å®æ—¶è´Ÿè½½è°ƒæ•´$C_i$
- è½¯å®¹é‡ï¼šç”¨Sigmoidå¹³æ»‘ä»£æ›¿ç¡¬æˆªæ–­

---

**ç¼ºé™·2ï¼šå®¹é‡è®¾ç½®å›°éš¾**

**é—®é¢˜**ï¼šå®¹é‡å› å­ï¼ˆCapacity Factorï¼‰$c_f$çš„é€‰æ‹©æ˜¯ç»éªŒæ€§çš„

æ ‡å‡†å…¬å¼ï¼š

$$C_i = c_f \cdot \frac{T \cdot k}{n}$$

å…¶ä¸­$T$æ˜¯æ€»Tokenæ•°ï¼Œ$k$æ˜¯Top-kçš„$k$ã€‚

**å…¸å‹è®¾ç½®**ï¼š
- Switch Transformerï¼š$c_f = 1.25$ï¼ˆå…è®¸25% bufferï¼‰
- GShardï¼š$c_f = 2.0$ï¼ˆ100% bufferï¼‰
- Mixtralï¼š$c_f = 1.5$

**é—®é¢˜**ï¼š
- $c_f$å¤ªå°ï¼šToken Dropä¸¥é‡
- $c_f$å¤ªå¤§ï¼šå†…å­˜æµªè´¹ï¼Œæ— æ³•åˆ©ç”¨

**å®éªŒæ•°æ®**ï¼š

| $c_f$ | Token Drop Rate | å†…å­˜å ç”¨ï¼ˆvs $c_f=1$ï¼‰ | æ€§èƒ½ |
|-------|----------------|----------------------|------|
| 1.0 | 25% | 100% | 85% |
| 1.25 | 8% | 125% | 95% |
| 1.5 | 2% | 150% | 98% |
| 2.0 | <1% | 200% | 99% |

**ä¼˜åŒ–æ–¹å‘**ï¼š
- è‡ªé€‚åº”å®¹é‡ï¼š$C_i^{(t)} = \text{EMA}(N_i^{(t-k:t)}) \cdot 1.2$
- åŸºäºæ–¹å·®çš„å®¹é‡ï¼š$C_i = \mu_i + 3\sigma_i$ï¼ˆ3-sigmaè§„åˆ™ï¼‰

</div>

<h4 id="44-router-z-loss-">4.4 Router Z-Loss - æ‰¹åˆ¤æ€§åˆ†æ</h4>
<div class="analysis-box">

### **æ ¸å¿ƒç¼ºé™·**

**ç¼ºé™·1ï¼šé—´æ¥ä¼˜åŒ–è´Ÿè½½**

**é—®é¢˜**ï¼šZ-Lossçº¦æŸRouterçš„logitsï¼Œä½†ä¸ç›´æ¥ä¼˜åŒ–è´Ÿè½½åˆ†å¸ƒ$\boldsymbol{F}$

**å…¬å¼**ï¼š

$$\mathcal{L}_{z} = \frac{1}{B} \sum_{b=1}^{B} \left(\log \sum_{i=1}^{n} e^{z_i^{(b)}}\right)^2$$

å…¶ä¸­$z_i^{(b)}$æ˜¯ç¬¬$b$ä¸ªTokenå¯¹Expert $i$çš„logitã€‚

**ç›´è§‰**ï¼šæƒ©ç½šlogitsçš„"å°ºåº¦"è¿‡å¤§

**é—®é¢˜**ï¼š
- ä¸è´Ÿè½½å‡è¡¡çš„å…³ç³»ä¸ç›´æ¥
- å¯èƒ½å­˜åœ¨$\mathcal{L}_z$å°ä½†è´Ÿè½½ä»ä¸å‡çš„æƒ…å†µ

**å®éªŒè§‚å¯Ÿ**ï¼ˆST-MoEè®ºæ–‡ï¼‰ï¼š
- å•ç‹¬ä½¿ç”¨Z-Lossï¼šè´Ÿè½½æ–¹å·®é™ä½30%
- å•ç‹¬ä½¿ç”¨Aux Lossï¼šè´Ÿè½½æ–¹å·®é™ä½60%
- ä¸¤è€…ç»“åˆï¼šè´Ÿè½½æ–¹å·®é™ä½70%

**ç»“è®º**ï¼šZ-Lossæ˜¯è¾…åŠ©æ‰‹æ®µï¼Œä¸èƒ½æ›¿ä»£Aux Loss

---

**ç¼ºé™·2ï¼šç†è®ºä¸æ¸…æ™°**

**é—®é¢˜**ï¼šä¸ºä»€ä¹ˆæœ€å°åŒ–$\left(\log \sum_{i} e^{z_i}\right)^2$èƒ½ä¿ƒè¿›å‡è¡¡ï¼Ÿ

**è®ºæ–‡ç»™å‡ºçš„ç›´è§‰**ï¼š
- é˜²æ­¢æŸäº›logitsè¿‡å¤§
- ç¨³å®šSoftmaxçš„æ•°å€¼è®¡ç®—

**ä½†ç¼ºä¹ä¸¥æ ¼è¯æ˜**ï¼š
- æœ€ä¼˜çš„logitsåˆ†å¸ƒæ˜¯ä»€ä¹ˆï¼Ÿ
- ä¸å‡åŒ€åˆ†å¸ƒ$\boldsymbol{Q}$çš„å…³ç³»ï¼Ÿ
- ä¸Aux Lossçš„ç†è®ºè”ç³»ï¼Ÿ

**ä¼˜åŒ–æ–¹å‘**ï¼š
- æ¨å¯¼Z-Lossä¸è´Ÿè½½æ–¹å·®çš„ç†è®ºå…³ç³»
- å¯»æ‰¾æœ€ä¼˜logitsçš„é—­å¼è§£
- ä¸Aux Lossçš„è”åˆä¼˜åŒ–ç†è®º

</div>

<hr />
<h3 id="5_1">ç¬¬5éƒ¨åˆ†ï¼šå­¦ä¹ è·¯çº¿å›¾ä¸æœªæ¥å±•æœ›</h3>
<h4 id="51">5.1 å­¦ä¹ è·¯çº¿å›¾</h4>
<p><strong>å¿…å¤‡å‰ç½®çŸ¥è¯†</strong></p>
<p><strong>æ•°å­¦åŸºç¡€</strong>ï¼š
- <strong>æ¦‚ç‡è®º</strong>ï¼šæœŸæœ›ã€æ–¹å·®ã€ç†µã€KLæ•£åº¦
- <strong>ä¼˜åŒ–ç†è®º</strong>ï¼šæ‹‰æ ¼æœ—æ—¥ä¹˜æ•°ã€çº¦æŸä¼˜åŒ–ã€æ¢¯åº¦ä¸‹é™
- <strong>çº¿æ€§ä»£æ•°</strong>ï¼šå•çº¯å½¢ã€å‘é‡ç©ºé—´ã€èŒƒæ•°</p>
<p><strong>æœºå™¨å­¦ä¹ åŸºç¡€</strong>ï¼š
- <strong>æ·±åº¦å­¦ä¹ </strong>ï¼šåå‘ä¼ æ’­ã€Softmaxã€æ¢¯åº¦ä¼°è®¡
- <strong>æ­£åˆ™åŒ–æŠ€æœ¯</strong>ï¼šL1/L2æ­£åˆ™ã€Dropoutã€Early Stopping
- <strong>è‡ªåŠ¨å¾®åˆ†</strong>ï¼šStop Gradientã€Straight-Through Estimator</p>
<p><strong>æ¨èå­¦ä¹ é¡ºåº</strong>ï¼š</p>
<ol>
<li><strong>ç†è§£è´Ÿè½½ä¸å‡è¡¡çš„é—®é¢˜</strong>ï¼ˆæœ¬æ–‡"éœ€æ±‚åˆ†æ"éƒ¨åˆ†ï¼‰</li>
<li><strong>æŒæ¡åŸºæœ¬Aux Loss</strong>ï¼ˆGShardå…¬å¼ï¼‰</li>
<li><strong>å­¦ä¹ STEæŠ€å·§</strong>ï¼ˆç†è§£æ¢¯åº¦ç­‰ä»·æ€§ï¼‰</li>
<li><strong>æ¢ç´¢å…¶ä»–æ–¹æ³•</strong>ï¼ˆç†µæ­£åˆ™ã€Expert Capacityï¼‰</li>
<li><strong>å®è·µè°ƒä¼˜</strong>ï¼ˆ$\alpha$é€‰æ‹©ã€å®¹é‡è®¾ç½®ï¼‰</li>
</ol>
<hr />
<p><strong>æ ¸å¿ƒè®ºæ–‡åˆ—è¡¨ï¼ˆæŒ‰æ—¶é—´é¡ºåºï¼‰</strong></p>
<p><strong>ç†è®ºå¥ åŸº</strong>ï¼š
1. Jordan &amp; Jacobs (1994) - "Hierarchical Mixtures of Experts"ï¼šæœ€æ—©æåˆ°Expertç«äº‰é—®é¢˜
2. Bengio et al. (2013) - "Estimating Gradients Through Stochastic Neurons"ï¼šSTEæŠ€å·§çš„ç†è®º</p>
<p><strong>MoEè´Ÿè½½å‡è¡¡</strong>ï¼š
3. Shazeer et al. (2017) - "Sparsely-Gated MoE"ï¼šé¦–æ¬¡ç³»ç»ŸæŠ¥å‘Šè´Ÿè½½ä¸å‡è¡¡ â­
4. Lepikhin et al. (2020) - "GShard"ï¼šæå‡ºç»å…¸Aux Losså…¬å¼ â­â­â­
5. Fedus et al. (2021) - "Switch Transformers"ï¼šExpert Capacityæœºåˆ¶ â­â­
6. Zoph et al. (2022) - "ST-MoE"ï¼šRouter Z-Loss â­</p>
<p><strong>æœ€æ–°è¿›å±•</strong>ï¼š
7. Liu et al. (2024) - "DeepSeek-V3"ï¼šåŠ¨æ€å®¹é‡ã€Tokenä¸¢å¼ƒç‡&lt;3% â­â­
8. Dai et al. (2024) - "Compressed Routing"ï¼šä»å‹ç¼©è§†è§’ç†è§£è´Ÿè½½å‡è¡¡</p>
<hr />
<h4 id="52_1">5.2 ç ”ç©¶ç©ºç™½ä¸æœªæ¥æ–¹å‘</h4>
<h4 id="1-aux-loss"><strong>æ–¹å‘1ï¼šç†è®ºå±‚é¢ - Aux Lossçš„æœ€ä¼˜æ€§</strong></h4>
<p><strong>ç ”ç©¶ç©ºç™½</strong>ï¼š
- å½“å‰Aux Loss $\sum F_i P_i$æ˜¯ç»éªŒæ€§çš„
- ç¼ºä¹"è¿™æ˜¯æœ€ä¼˜Aux Loss"çš„ç†è®ºè¯æ˜
- ä¸æ¸…æ¥šæ˜¯å¦å­˜åœ¨æ›´å¥½çš„æŸå¤±å‡½æ•°</p>
<p><strong>å…·ä½“ç ”ç©¶é—®é¢˜</strong>ï¼š</p>
<ol>
<li><strong>é—®é¢˜</strong>ï¼šä»€ä¹ˆæ˜¯è´Ÿè½½å‡è¡¡çš„æœ€ä¼˜æŸå¤±å‡½æ•°ï¼Ÿ</li>
<li><strong>æŒ‘æˆ˜</strong>ï¼šéœ€è¦åŒæ—¶è€ƒè™‘ï¼š<ul>
<li>ä»»åŠ¡æ€§èƒ½ï¼ˆä¸èƒ½ä¸ºå‡è¡¡ç‰ºç‰²å¤ªå¤šï¼‰</li>
<li>è´Ÿè½½æ–¹å·®ï¼ˆå°½é‡å‡åŒ€ï¼‰</li>
<li>è®¡ç®—æ•ˆç‡ï¼ˆæŸå¤±å‡½æ•°æœ¬èº«ä¸èƒ½å¤ªå¤æ‚ï¼‰</li>
</ul>
</li>
<li><strong>æ½œåœ¨æ–¹æ³•</strong>ï¼š<ul>
<li>å»ºç«‹å¤šç›®æ ‡ä¼˜åŒ–æ¡†æ¶</li>
<li>æ¨å¯¼å¸•ç´¯æ‰˜æœ€ä¼˜è§£</li>
<li>è¯æ˜æŸç§æŸå¤±åœ¨ç‰¹å®šæ„ä¹‰ä¸‹æœ€ä¼˜</li>
</ul>
</li>
<li>
<p><strong>æ½œåœ¨æ„ä¹‰</strong>ï¼šæŒ‡å¯¼Aux Lossè®¾è®¡ï¼Œæ›¿ä»£ç»éªŒå…¬å¼</p>
</li>
<li>
<p><strong>é—®é¢˜</strong>ï¼šAux Lossæƒé‡$\alpha$çš„ç†è®ºæœ€ä¼˜å€¼ï¼Ÿ</p>
</li>
<li><strong>å·²çŸ¥</strong>ï¼š$\alpha$éœ€è¦æ‰‹å·¥è°ƒä¼˜</li>
<li><strong>æœªçŸ¥</strong>ï¼šæ˜¯å¦å­˜åœ¨å…¬å¼$\alpha^* = f(n, k, d, \ldots)$ï¼Ÿ</li>
<li>
<p><strong>æ½œåœ¨æ„ä¹‰</strong>ï¼šè‡ªåŠ¨åŒ–è¶…å‚æ•°è®¾ç½®</p>
</li>
<li>
<p><strong>é—®é¢˜</strong>ï¼šSTEæ˜¯å¦æ˜¯æœ€å¥½çš„æ¢¯åº¦ä¼°è®¡ï¼Ÿ</p>
</li>
<li><strong>ç°çŠ¶</strong>ï¼šSTEå¿½ç•¥Top-kçš„æ¢¯åº¦</li>
<li><strong>æ¢ç´¢æ–¹å‘</strong>ï¼š<ul>
<li>æ˜¯å¦å­˜åœ¨æ— åæ¢¯åº¦ä¼°è®¡ï¼Ÿ</li>
<li>Gumbel-Softmaxç­‰è¿ç»­æ¾å¼›æ–¹æ³•çš„é€‚ç”¨æ€§ï¼Ÿ</li>
<li>é«˜é˜¶æ¢¯åº¦ä¼°è®¡ï¼ˆå¦‚REINFORCE with baselineï¼‰</li>
</ul>
</li>
</ol>
<p><strong>ä¼˜åŒ–æ–¹å‘</strong>ï¼š
- å‘å±•è´Ÿè½½å‡è¡¡çš„å˜åˆ†æ¨æ–­ç†è®º
- å€Ÿé‰´åšå¼ˆè®ºçš„å‡è¡¡æ¦‚å¿µ
- ä½¿ç”¨å…ƒå­¦ä¹ ï¼ˆMeta-Learningï¼‰è‡ªåŠ¨å­¦ä¹ $\alpha$</p>
<p><strong>é‡åŒ–ç›®æ ‡</strong>ï¼š
- è¯æ˜æŸç§Aux Lossåœ¨PACæ„ä¹‰ä¸‹æœ€ä¼˜
- æ¨å¯¼$\alpha^*$çš„é—­å¼è§£æˆ–ä¸Šä¸‹ç•Œ
- è®¾è®¡æ— åæ¢¯åº¦ä¼°è®¡å™¨ï¼Œæ–¹å·®é™ä½50%</p>
<hr />
<h4 id="2-token-drop"><strong>æ–¹å‘2ï¼šæ•ˆç‡å±‚é¢ - é›¶Token Dropçš„è´Ÿè½½å‡è¡¡</strong></h4>
<p><strong>ç ”ç©¶ç©ºç™½</strong>ï¼š
- å½“å‰æœ€å¥½çš„ç³»ç»Ÿï¼ˆDeepSeek-V3ï¼‰ä»æœ‰~3% Token Drop
- Token Dropå¯¼è‡´ä¿¡æ¯æŸå¤±ï¼Œå½±å“æ€§èƒ½
- å¦‚ä½•å®Œå…¨æ¶ˆé™¤Token Dropï¼Ÿ</p>
<p><strong>å…·ä½“ç ”ç©¶é—®é¢˜</strong>ï¼š</p>
<ol>
<li><strong>é—®é¢˜</strong>ï¼šåŠ¨æ€å®¹é‡è°ƒæ•´çš„æœ€ä¼˜ç­–ç•¥ï¼Ÿ</li>
<li><strong>ç°æœ‰æ–¹æ¡ˆ</strong>ï¼šEMAã€å›ºå®šbuffer</li>
<li><strong>ä¼˜åŒ–æ–¹å‘</strong>ï¼š<ul>
<li>é¢„æµ‹æ€§å®¹é‡ï¼šæ ¹æ®å‰å‡ æ­¥çš„è´Ÿè½½é¢„æµ‹ä¸‹ä¸€æ­¥</li>
<li>å¼ºåŒ–å­¦ä¹ ä¼˜åŒ–å®¹é‡åˆ†é…ç­–ç•¥</li>
<li>åŸºäºTokenéš¾åº¦çš„è‡ªé€‚åº”å®¹é‡</li>
</ul>
</li>
<li>
<p><strong>é‡åŒ–ç›®æ ‡</strong>ï¼šToken Dropç‡ä»3%é™è‡³&lt;0.5%</p>
</li>
<li>
<p><strong>é—®é¢˜</strong>ï¼šæº¢å‡ºé‡è·¯ç”±ï¼ˆOverflow Reroutingï¼‰ï¼Ÿ</p>
</li>
<li><strong>æ€è·¯</strong>ï¼šå½“Expert $i$æ»¡è½½æ—¶ï¼Œå°†æº¢å‡ºTokenè·¯ç”±åˆ°æ¬¡ä¼˜Expert</li>
<li><strong>æŒ‘æˆ˜</strong>ï¼š<ul>
<li>å¦‚ä½•é«˜æ•ˆé€‰æ‹©æ¬¡ä¼˜Expertï¼Ÿ</li>
<li>é‡è·¯ç”±æ˜¯å¦å½±å“è®­ç»ƒç¨³å®šæ€§ï¼Ÿ</li>
<li>å¦‚ä½•åœ¨åå‘ä¼ æ’­ä¸­å¤„ç†ï¼Ÿ</li>
</ul>
</li>
<li>
<p><strong>æ½œåœ¨æ–¹æ³•</strong>ï¼š</p>
<ul>
<li>Top-k with backupï¼šé¢„å…ˆè®¡ç®—Top-$(k+m)$ï¼Œå‰$k$ä¸ªæ»¡äº†ç”¨å$m$ä¸ª</li>
<li>è½¯è·¯ç”±ï¼šç”¨Softmaxæƒé‡ä»£æ›¿ç¡¬Top-k</li>
<li>å±‚æ¬¡åŒ–è·¯ç”±ï¼šå…ˆé€‰Expertç»„ï¼Œç»„å†…å†é€‰å…·ä½“Expert</li>
</ul>
</li>
<li>
<p><strong>é—®é¢˜</strong>ï¼šå¹¶è¡ŒåŒ–å‹å¥½çš„è´Ÿè½½å‡è¡¡ï¼Ÿ</p>
</li>
<li><strong>ç°çŠ¶</strong>ï¼šAll-to-Allé€šä¿¡æ˜¯ç“¶é¢ˆ</li>
<li><strong>ä¼˜åŒ–æ–¹å‘</strong>ï¼š<ul>
<li>å±€éƒ¨è´Ÿè½½å‡è¡¡ï¼ˆåªåœ¨GPUå†…å‡è¡¡ï¼Œå‡å°‘è·¨GPUé€šä¿¡ï¼‰</li>
<li>å±‚æ¬¡åŒ–å‡è¡¡ï¼ˆå…ˆå…¨å±€å‡è¡¡Expertç»„ï¼Œå†å±€éƒ¨å‡è¡¡ç»„å†…Expertï¼‰</li>
<li>å¼‚æ­¥å‡è¡¡ï¼ˆè´Ÿè½½ç»Ÿè®¡ä¸æ¨¡å‹è®­ç»ƒå¼‚æ­¥ï¼‰</li>
</ul>
</li>
</ol>
<p><strong>ä¼˜åŒ–æ–¹å‘</strong>ï¼š
- å¼€å‘ä¸“ç”¨ç¡¬ä»¶ï¼ˆç±»ä¼¼TPUçš„All-to-AllåŠ é€Ÿå™¨ï¼‰
- ç ”ç©¶è¿‘ä¼¼è´Ÿè½½å‡è¡¡ï¼ˆç‰ºç‰²å°‘é‡å‡åŒ€æ€§æ¢å–é€Ÿåº¦ï¼‰
- æ¢ç´¢éTop-kçš„ç¨€ç–æ¿€æ´»æ–¹å¼</p>
<p><strong>é‡åŒ–ç›®æ ‡</strong>ï¼š
- Token Dropç‡ï¼š&lt;0.5%
- é€šä¿¡æ—¶é—´å æ¯”ï¼šä»20%é™è‡³&lt;10%
- è´Ÿè½½æ–¹å·®ï¼š&lt;5%ï¼ˆæ ‡å‡†å·®/å‡å€¼ï¼‰</p>
<hr />
<h4 id="3-"><strong>æ–¹å‘3ï¼šåº”ç”¨å±‚é¢ - ä»»åŠ¡ç‰¹å®šçš„è´Ÿè½½ç­–ç•¥</strong></h4>
<p><strong>ç ”ç©¶ç©ºç™½</strong>ï¼š
- å½“å‰è´Ÿè½½å‡è¡¡æ˜¯"ä¸€åˆ€åˆ‡"ï¼ˆæ‰€æœ‰ä»»åŠ¡éƒ½è¿½æ±‚å‡åŒ€ï¼‰
- æŸäº›ä»»åŠ¡å¯èƒ½å—ç›Šäºä¸å‡åŒ€åˆ†å¸ƒ
- ç¼ºä¹ä»»åŠ¡è‡ªé€‚åº”çš„è´Ÿè½½ç­–ç•¥</p>
<p><strong>å…·ä½“ç ”ç©¶é—®é¢˜</strong>ï¼š</p>
<ol>
<li><strong>é—®é¢˜</strong>ï¼šä»€ä¹ˆæ—¶å€™åº”è¯¥ä¸å‡è¡¡ï¼Ÿ</li>
<li><strong>è§‚å¯Ÿ</strong>ï¼š<ul>
<li>å¤šè¯­è¨€æ¨¡å‹ï¼šé«˜èµ„æºè¯­è¨€vsä½èµ„æºè¯­è¨€</li>
<li>å¤šæ¨¡æ€æ¨¡å‹ï¼šå›¾åƒvsæ–‡æœ¬</li>
<li>ä»£ç ç”Ÿæˆï¼šä¸åŒç¼–ç¨‹è¯­è¨€</li>
</ul>
</li>
<li><strong>å‡è®¾</strong>ï¼šæŸäº›"ä¸»æµ"ä»»åŠ¡åº”è¯¥åˆ†é…æ›´å¤šExpert</li>
<li>
<p><strong>ç ”ç©¶</strong>ï¼š</p>
<ul>
<li>åˆ†æä»»åŠ¡éš¾åº¦ä¸æœ€ä¼˜è´Ÿè½½åˆ†å¸ƒçš„å…³ç³»</li>
<li>è®¾è®¡ä»»åŠ¡æ„ŸçŸ¥çš„ç›®æ ‡åˆ†å¸ƒ$\boldsymbol{Q}$ï¼ˆä¸ä¸€å®šå‡åŒ€ï¼‰</li>
<li>ç†è®ºï¼šä½•æ—¶å‡åŒ€æœ€ä¼˜ï¼Ÿä½•æ—¶ä¸å‡åŒ€æ›´å¥½ï¼Ÿ</li>
</ul>
</li>
<li>
<p><strong>é—®é¢˜</strong>ï¼šå¦‚ä½•å®ç°åˆ†å±‚è´Ÿè½½ç­–ç•¥ï¼Ÿ</p>
</li>
<li><strong>è®¾è®¡</strong>ï¼š<ul>
<li>å®è§‚å±‚é¢ï¼šä»»åŠ¡ç»„ä¹‹é—´å‡è¡¡ï¼ˆå¦‚ä¸­æ–‡vsè‹±æ–‡ï¼‰</li>
<li>å¾®è§‚å±‚é¢ï¼šä»»åŠ¡ç»„å†…å¯ä»¥ä¸å‡ï¼ˆå¦‚æŸäº›Expertä¸“ç²¾è¯—æ­Œï¼ŒæŸäº›ä¸“ç²¾æ–°é—»ï¼‰</li>
</ul>
</li>
<li>
<p><strong>æŒ‘æˆ˜</strong>ï¼šå¦‚ä½•å®šä¹‰"ä»»åŠ¡ç»„"ï¼Ÿå¦‚ä½•å­¦ä¹ ç»„ç»“æ„ï¼Ÿ</p>
</li>
<li>
<p><strong>é—®é¢˜</strong>ï¼šç”¨æˆ·å¯æ§çš„è´Ÿè½½åå¥½ï¼Ÿ</p>
</li>
<li><strong>åœºæ™¯</strong>ï¼šç”¨æˆ·å¸Œæœ›æŸäº›Expertæ›´å¼ºï¼ˆå¦‚æå‡æ•°å­¦èƒ½åŠ›ï¼‰</li>
<li><strong>æ–¹æ³•</strong>ï¼š<ul>
<li>å…è®¸ç”¨æˆ·æŒ‡å®šç›®æ ‡åˆ†å¸ƒ$\boldsymbol{Q}_{\text{user}}$</li>
<li>Fine-tuningæ—¶åªè°ƒæ•´éƒ¨åˆ†Expertçš„è´Ÿè½½</li>
<li>RLHFä¸­çš„Expertçº§å¥–åŠ±</li>
</ul>
</li>
</ol>
<p><strong>ä¼˜åŒ–æ–¹å‘</strong>ï¼š
- å¼€å‘"è´Ÿè½½ç­–ç•¥åº“"ï¼ˆä¸åŒä»»åŠ¡çš„æœ€ä¼˜è´Ÿè½½æ¨¡å¼ï¼‰
- å…ƒå­¦ä¹ è‡ªåŠ¨å‘ç°ä»»åŠ¡çš„æœ€ä¼˜è´Ÿè½½åˆ†å¸ƒ
- ç”¨æˆ·äº¤äº’å¼è´Ÿè½½è°ƒæ•´å·¥å…·</p>
<p><strong>é‡åŒ–ç›®æ ‡</strong>ï¼š
- åœ¨å¤šè¯­è¨€ä»»åŠ¡ä¸Šï¼Œä»»åŠ¡è‡ªé€‚åº”è´Ÿè½½æ¯”å‡åŒ€è´Ÿè½½æ€§èƒ½æå‡5%-10%
- Fine-tuningåªè°ƒæ•´20%çš„Expertè´Ÿè½½ï¼Œè¾¾åˆ°95%çš„å…¨è°ƒæ•´æ•ˆæœ
- ç”¨æˆ·æ»¡æ„åº¦è°ƒæŸ¥ï¼šå¯æ§è´Ÿè½½æ¯”å›ºå®šè´Ÿè½½æ»¡æ„åº¦é«˜30%</p>
<hr />
<h4 id="4-"><strong>æ–¹å‘4ï¼šé²æ£’æ€§å±‚é¢ - è´Ÿè½½å‡è¡¡çš„ç¨³å®šæ€§</strong></h4>
<p><strong>ç ”ç©¶ç©ºç™½</strong>ï¼š
- è®­ç»ƒè¿‡ç¨‹ä¸­è´Ÿè½½åˆ†å¸ƒå¯èƒ½å‰§çƒˆæ³¢åŠ¨
- æŸäº›Expertå¯èƒ½çªç„¶"å´©æºƒ"ï¼ˆè´Ÿè½½è·³å˜ï¼‰
- ç¼ºä¹è´Ÿè½½æ¼”åŒ–çš„ç†è®ºåˆ†æ</p>
<p><strong>å…·ä½“ç ”ç©¶é—®é¢˜</strong>ï¼š</p>
<ol>
<li><strong>é—®é¢˜</strong>ï¼šè´Ÿè½½åˆ†å¸ƒçš„æ¼”åŒ–è½¨è¿¹ï¼Ÿ</li>
<li><strong>è§‚å¯Ÿ</strong>ï¼šè®­ç»ƒåˆæœŸè´Ÿè½½å‡åŒ€ï¼Œä¸­æœŸå¼€å§‹åˆ†åŒ–ï¼ŒåæœŸè¶‹äºç¨³å®š</li>
<li><strong>ç ”ç©¶</strong>ï¼š<ul>
<li>å»ºç«‹è´Ÿè½½æ¼”åŒ–çš„åŠ¨åŠ›å­¦æ¨¡å‹</li>
<li>åˆ†æå¹³è¡¡ç‚¹ï¼ˆç¨³æ€ï¼‰çš„å­˜åœ¨æ€§å’Œç¨³å®šæ€§</li>
<li>é¢„æµ‹è´Ÿè½½åˆ†å¸ƒçš„é•¿æœŸè¡Œä¸º</li>
</ul>
</li>
<li>
<p><strong>å·¥å…·</strong>ï¼šå¸¸å¾®åˆ†æ–¹ç¨‹ï¼ˆODEï¼‰ã€åŠ¨åŠ›ç³»ç»Ÿç†è®º</p>
</li>
<li>
<p><strong>é—®é¢˜</strong>ï¼šå¦‚ä½•é˜²æ­¢Expertå´©æºƒï¼Ÿ</p>
</li>
<li><strong>å´©æºƒç°è±¡</strong>ï¼šæŸExpertçš„è´Ÿè½½çªç„¶ä»30%è·Œè‡³0%</li>
<li><strong>åŸå› </strong>ï¼š<ul>
<li>Routerå‚æ•°çš„çªå˜</li>
<li>æ¢¯åº¦çˆ†ç‚¸/æ¶ˆå¤±</li>
<li>BatchNormç»Ÿè®¡é‡çš„åç§»</li>
</ul>
</li>
<li>
<p><strong>é˜²å¾¡æ–¹æ³•</strong>ï¼š</p>
<ul>
<li>Expertçº§åˆ«çš„Gradient Clipping</li>
<li>Routerå‚æ•°çš„EMAæ›´æ–°</li>
<li>è´Ÿè½½å˜åŒ–ç‡çš„ç›‘æ§å’Œé™åˆ¶</li>
</ul>
</li>
<li>
<p><strong>é—®é¢˜</strong>ï¼šåˆ†å¸ƒå¼è®­ç»ƒä¸­çš„è´Ÿè½½åŒæ­¥ï¼Ÿ</p>
</li>
<li><strong>é—®é¢˜</strong>ï¼šä¸åŒGPUä¸Šçš„è´Ÿè½½ç»Ÿè®¡å¯èƒ½ä¸ä¸€è‡´</li>
<li><strong>ä¼˜åŒ–æ–¹å‘</strong>ï¼š<ul>
<li>å…¨å±€è´Ÿè½½ç»Ÿè®¡ï¼ˆAll-Reduce $\boldsymbol{F}$ï¼‰</li>
<li>å±€éƒ¨è´Ÿè½½å‡è¡¡ + å‘¨æœŸæ€§å…¨å±€åŒæ­¥</li>
<li>å±‚æ¬¡åŒ–è´Ÿè½½å‡è¡¡ï¼ˆGPUå†… â†’ èŠ‚ç‚¹å†… â†’ è·¨èŠ‚ç‚¹ï¼‰</li>
</ul>
</li>
</ol>
<p><strong>ä¼˜åŒ–æ–¹å‘</strong>ï¼š
- å‘å±•è´Ÿè½½æ¼”åŒ–çš„ç†è®ºåˆ†æå·¥å…·
- è®¾è®¡é²æ£’çš„Aux Lossï¼ˆå¯¹å‚æ•°æ‰°åŠ¨ä¸æ•æ„Ÿï¼‰
- æ¢ç´¢è´Ÿè½½åˆ†å¸ƒçš„ä¸å˜é‡ï¼ˆconservation lawsï¼‰</p>
<p><strong>é‡åŒ–ç›®æ ‡</strong>ï¼š
- è´Ÿè½½æ³¢åŠ¨ï¼šç›¸é‚»æ­¥çš„$|\boldsymbol{F}^{(t)} - \boldsymbol{F}^{(t-1)}|_1 &lt; 0.05$
- Expertå´©æºƒç‡ï¼š&lt;1%ï¼ˆè®­ç»ƒè¿‡ç¨‹ä¸­ï¼‰
- åˆ†å¸ƒå¼ä¸€è‡´æ€§ï¼šä¸åŒGPUä¸Šçš„è´Ÿè½½æ–¹å·®&lt;10%</p>
<hr />
<h4 id="5-"><strong>æ–¹å‘5ï¼šæ–°å‹æ¶æ„ - è½¯è´Ÿè½½å‡è¡¡</strong></h4>
<p><strong>ç ”ç©¶ç©ºç™½</strong>ï¼š
- å½“å‰æ–¹æ³•éƒ½æ˜¯"ç¡¬è´Ÿè½½å‡è¡¡"ï¼ˆå¼ºåˆ¶å‡åŒ€æˆ–å®¹é‡é™åˆ¶ï¼‰
- ç¼ºä¹"è½¯å‡è¡¡"æ–¹æ³•ï¼ˆè‡ªç„¶æ¶Œç°çš„å‡è¡¡ï¼‰
- èƒ½å¦è®¾è®¡å†…åœ¨å‡è¡¡çš„MoEæ¶æ„ï¼Ÿ</p>
<p><strong>å…·ä½“ç ”ç©¶é—®é¢˜</strong>ï¼š</p>
<ol>
<li><strong>é—®é¢˜</strong>ï¼šæ— éœ€Aux Lossçš„è‡ªç„¶å‡è¡¡ï¼Ÿ</li>
<li><strong>æ€è·¯</strong>ï¼šä¿®æ”¹MoEæ¶æ„ï¼Œä½¿å…¶è‡ªç„¶å€¾å‘äºå‡è¡¡</li>
<li><strong>æ–¹æ³•</strong>ï¼š<ul>
<li><strong>ç«äº‰æ€§Router</strong>ï¼šExpertä¹‹é—´ç›¸äº’æŠ‘åˆ¶
   $$\rho_i = \text{ReLU}\left(z_i - \alpha \sum_{j \neq i} z_j\right)$$</li>
<li><strong>è‡ªå½’ä¸€åŒ–Router</strong>ï¼šæ¯ä¸ªTokençš„æ€»æƒé‡å›ºå®š
   $$\sum_{i} \rho_i(\boldsymbol{x}) = C, \quad \forall \boldsymbol{x}$$</li>
<li><strong>åŸºäºæ³¨æ„åŠ›çš„å‡è¡¡</strong>ï¼šExpertç›¸äº’"æ„ŸçŸ¥"è´Ÿè½½
   $$\rho_i = f(z_i, \boldsymbol{F}_{-i})$$</li>
</ul>
</li>
<li>
<p><strong>æŒ‘æˆ˜</strong>ï¼šå¦‚ä½•ä¿è¯æ”¶æ•›åˆ°å‡åŒ€ï¼Ÿ</p>
</li>
<li>
<p><strong>é—®é¢˜</strong>ï¼šå¯å­¦ä¹ çš„ç›®æ ‡åˆ†å¸ƒï¼Ÿ</p>
</li>
<li><strong>é—®é¢˜</strong>ï¼šä¸ºä»€ä¹ˆç›®æ ‡ä¸€å®šæ˜¯å‡åŒ€åˆ†å¸ƒ$\boldsymbol{Q} = (\frac{1}{n}, \ldots, \frac{1}{n})$ï¼Ÿ</li>
<li><strong>æ€è·¯</strong>ï¼šè®©æ¨¡å‹å­¦ä¹ æœ€ä¼˜çš„ç›®æ ‡åˆ†å¸ƒ$\boldsymbol{Q}^*$</li>
<li><strong>æ–¹æ³•</strong>ï¼š<ul>
<li>å°†$\boldsymbol{Q}$å‚æ•°åŒ–ï¼š$\boldsymbol{Q}(\boldsymbol{\phi})$</li>
<li>è”åˆä¼˜åŒ–$\boldsymbol{\theta}$å’Œ$\boldsymbol{\phi}$</li>
<li>çº¦æŸï¼š$\sum_{i} Q_i = 1, Q_i \geq 0$</li>
</ul>
</li>
<li>
<p><strong>ä¼˜ç‚¹</strong>ï¼šè‡ªåŠ¨é€‚åº”ä»»åŠ¡</p>
</li>
<li>
<p><strong>é—®é¢˜</strong>ï¼šåˆ†æ•°é˜¶è´Ÿè½½å‡è¡¡ï¼Ÿ</p>
</li>
<li><strong>çµæ„Ÿ</strong>ï¼šåˆ†æ•°é˜¶å¾®ç§¯åˆ†åœ¨é•¿ç¨‹ä¾èµ–å»ºæ¨¡ä¸­çš„åº”ç”¨</li>
<li><strong>æ€è·¯</strong>ï¼šè´Ÿè½½æ¼”åŒ–ä¸æ˜¯ä¸€é˜¶æ¢¯åº¦æµï¼Œè€Œæ˜¯åˆ†æ•°é˜¶
       $$\frac{d^{\gamma} \boldsymbol{F}}{dt^{\gamma}} = -\nabla \mathcal{L}_{\text{aux}}, \quad 0 < \gamma < 1$$</li>
<li><strong>æ„ä¹‰</strong>ï¼šæ•æ‰è´Ÿè½½çš„"è®°å¿†æ•ˆåº”"ï¼Œæ›´å¹³æ»‘çš„æ¼”åŒ–</li>
</ol>
<p><strong>ä¼˜åŒ–æ–¹å‘</strong>ï¼š
- å€Ÿé‰´ç”Ÿç‰©ç¥ç»ç½‘ç»œçš„homeostaticæœºåˆ¶
- æ¢ç´¢è‡ªç»„ç»‡ï¼ˆself-organizationï¼‰ç†è®º
- ç ”ç©¶æ··æ²Œç†è®ºåœ¨è´Ÿè½½æ¼”åŒ–ä¸­çš„åº”ç”¨</p>
<p><strong>é‡åŒ–ç›®æ ‡</strong>ï¼š
- æ— Aux Lossæƒ…å†µä¸‹ï¼Œè´Ÿè½½æ–¹å·®&lt;15%ï¼ˆvs å½“å‰45%ï¼‰
- å¯å­¦ä¹ $\boldsymbol{Q}^*$ä½¿æ€§èƒ½æå‡3%-5%
- åˆ†æ•°é˜¶æ¨¡å‹ä½¿è´Ÿè½½æ¼”åŒ–æ›´å¹³æ»‘ï¼ˆæ³¢åŠ¨é™ä½30%ï¼‰</p>
<hr />
<h4 id="_7"><strong>æ½œåœ¨åº”ç”¨åœºæ™¯</strong></h4>
<p><strong>è¶…å¤§è§„æ¨¡MoE</strong>ï¼š
- åƒäº¿ç”šè‡³ä¸‡äº¿å‚æ•°MoE
- è´Ÿè½½å‡è¡¡æ˜¯è®­ç»ƒæˆåŠŸçš„å…³é”®
- éœ€è¦æé«˜æ•ˆç‡çš„å‡è¡¡ç­–ç•¥</p>
<p><strong>è”é‚¦å­¦ä¹ MoE</strong>ï¼š
- ä¸åŒè®¾å¤‡è®­ç»ƒä¸åŒExpert
- è´Ÿè½½åˆ†å¸ƒåæ˜ è®¾å¤‡å¼‚æ„æ€§
- éœ€è¦è€ƒè™‘éšç§çš„è´Ÿè½½å‡è¡¡</p>
<p><strong>åœ¨çº¿å­¦ä¹ MoE</strong>ï¼š
- æ•°æ®æµå¼åˆ°è¾¾
- è´Ÿè½½åˆ†å¸ƒåŠ¨æ€å˜åŒ–
- éœ€è¦è‡ªé€‚åº”è´Ÿè½½ç­–ç•¥</p>
<p><strong>å¤šä»»åŠ¡MoE</strong>ï¼š
- ä¸åŒä»»åŠ¡å…±äº«Expertæ± 
- è´Ÿè½½åæ˜ ä»»åŠ¡ä¼˜å…ˆçº§
- éœ€è¦å…¬å¹³æ€§ä¸æ•ˆç‡çš„æƒè¡¡</p>
<hr />
<h3 id="_8">æ€»ç»“</h3>
<p>æœ¬æ–‡æ·±å…¥åˆ†æäº†MoEçš„è´Ÿè½½å‡è¡¡é—®é¢˜ï¼š</p>
<p><strong>æ ¸å¿ƒè¦ç‚¹</strong>ï¼š
1. è´Ÿè½½ä¸å‡å¯¼è‡´Dead Expertå’ŒToken Drop
2. Aux Lossé€šè¿‡STEæŠ€å·§å®ç°æ¢¯åº¦ç­‰ä»·
3. å‡åŒ€åˆ†å¸ƒä»ç†µã€å®¹é‡ç­‰è§’åº¦æ˜¯æœ€ä¼˜çš„
4. ç°æœ‰æ–¹æ³•å„æœ‰ä¼˜ç¼ºç‚¹ï¼Œéœ€è¦è”åˆä½¿ç”¨
5. è´Ÿè½½å‡è¡¡ä¸ä»»åŠ¡æ€§èƒ½éœ€è¦æƒè¡¡</p>
<p><strong>æœªæ¥å€¼å¾—å…³æ³¨</strong>ï¼š
- ç†è®ºï¼šæœ€ä¼˜Aux Lossã€$\alpha$çš„ç†è®ºå€¼
- æ•ˆç‡ï¼šé›¶Token Dropã€å¹¶è¡ŒåŒ–å‹å¥½
- åº”ç”¨ï¼šä»»åŠ¡è‡ªé€‚åº”ã€ç”¨æˆ·å¯æ§
- é²æ£’æ€§ï¼šè´Ÿè½½æ¼”åŒ–ç¨³å®šæ€§ã€åˆ†å¸ƒå¼ä¸€è‡´æ€§
- æ–°æ¶æ„ï¼šè½¯å‡è¡¡ã€å¯å­¦ä¹ ç›®æ ‡åˆ†å¸ƒ</p>
        </div>
    </div>
</body>
</html>