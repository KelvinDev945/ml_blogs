<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>如何划分一个跟测试集更接近的验证集？</title>
    <style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    line-height: 1.6; color: #333; max-width: 900px; margin: 0 auto; padding: 20px; background: #f5f5f5;
}
.container { background: white; padding: 40px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
header { border-bottom: 2px solid #e0e0e0; padding-bottom: 20px; margin-bottom: 30px; }
h1 { color: #2c3e50; margin-bottom: 10px; font-size: 2em; }
.meta { color: #666; font-size: 0.9em; margin-bottom: 20px; }
.content { margin-top: 30px; overflow-wrap: break-word; }
.content h2 { color: #34495e; margin-top: 30px; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
.content p { margin-bottom: 15px; }
.content pre { background: #f8f8f8; padding: 15px; border-radius: 5px; overflow-x: auto; border-left: 3px solid #3498db; margin: 15px 0; }
.content code { background: #f8f8f8; padding: 2px 5px; border-radius: 3px; font-family: monospace; font-size: 0.9em; }
.content blockquote { border-left: 4px solid #3498db; padding-left: 20px; margin: 20px 0; color: #555; font-style: italic; }
.content table { border-collapse: collapse; width: 100%; margin: 20px 0; }
.content th, .content td { border: 1px solid #ddd; padding: 10px; text-align: left; }
.back-link { display: inline-block; margin-bottom: 20px; color: #3498db; text-decoration: none; font-weight: 500; }
</style>
    
<script>
    window.MathJax = {
        tex: {
            inlineMath: [['$', '$'], ['\(', '\)']],
            displayMath: [['$$', '$$'], ['\[', '\]']],
            processEscapes: true
        }
    };
</script>
<script id="MathJax-script" async src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>

</head>
<body>
    <div class="container">
        <a href="../index.html" class="back-link">← 返回首页</a>
        <header>
            <h1>如何划分一个跟测试集更接近的验证集？</h1>
            <div class="meta">📅 最后更新: 2025-12-31 | 📄 大小: 7.3 KB</div>
        </header>
        <div class="content">
            <p><strong>原文链接</strong>: <a href="https://spaces.ac.cn/archives/7805">https://spaces.ac.cn/archives/7805</a></p>
<p><strong>发布日期</strong>: </p>
<hr />
<p>不管是打比赛、做实验还是搞工程，我们经常会遇到训练集与测试集分布不一致的情况。一般来说我们会从训练集中划分出来一个验证集，通过这个验证集来调整一些超参数（参考<a href="/archives/4638">《训练集、验证集和测试集的意义》</a>），比如控制模型的训练轮数以防止过拟合。然而，如果验证集本身跟测试集差别比较大，那么验证集上很好的模型也不代表在测试集上很好，因此如何让划分出来验证集跟测试集的分布差异更小一些，是一个值得研究的题目。</p>
<h2 id="_1">两种情况</h2>
<p>首先，明确一下，本文所考虑的，是能给拿到测试集数据本身、但不知道测试集标签的场景。如果是那种提交模型封闭评测的场景，我们完全看不到测试集的，那就没什么办法了。为什么会出现测试集跟训练集分布不一致的现象呢？主要有两种情况。</p>
<p>第一种是<strong>标签</strong> 的分布不一致。也就是说，如果只看输入$x$，那么分布基本上是差不多的，但是对应的$y$分布不一样，典型的例子就是信息抽取任务，训练集往往是通过“远程监督 + 人工粗标”的方式构建的，量很大，但是里边可能错漏比较多，而测试集可能是通过“人工反复精标”构建的，错漏很少。这种情况下就无法通过划分数据的方式构建一个更好的验证集了。</p>
<p>第二种是<strong>输入</strong> 的分布不一致。说白了就是$x$的分布不一致，但是$y$的标注情况基本上是正确的。比如分类问题中，训练集的类别分布跟测试集的类别分布可能不一样；又或者在阅读理解问题中，训练集的事实类/非事实类题型比例跟测试集不一样，等等。这种情况下我们可以适当调整采样策略，使得验证集跟测试集分布更一致些，从而验证集的结果能够更好反映测试集的结果。</p>
<h2 id="_2">判别器</h2>
<p>为了达到我们的目的，我们让 <em>训练集的标签为0，测试集的标签为1</em> ，训练一个二分类判别器$D(x)$：<br />
\begin{equation}-\mathbb{E}<em q_x_="q(x)" x_sim="x\sim">{x\sim p(x)}[\log (1 - D(x))] - \mathbb{E}</em>}[\log D(x)]\end{equation<br />
其中$p(x)$代表了训练集的分布，$q(x)$则是测试集的分布。要注意的是，我们不是要将训练集和测试集直接混合起来采样训练，而是分别从训练集和测试集采样同样多的样本来组成每一个batch，也就是说需要过采样到类别均衡。</p>
<p>可能有读者担心过拟合问题，即判别器彻底地训练集和测试集分开了。事实上，在训练判别器的时候，我们应该也要像普通监督训练一样，划分个验证集出来，通过验证集决定训练的epoch数，这样就不会严重过拟合了；或者像网上有些案例一样，直接用逻辑回归做判别器，因为逻辑回归足够简单，过拟合风险也更小了。</p>
<p>跟GAN的判别器类似，不难推导$D(x)$的理论最优解是<br />
\begin{equation}D(x) = \frac{q(x)}{p(x)+q(x)}\label{eq:d}\end{equation}<br />
也就是说，判别器训练完后，可以认为它就等于测试集分布的相对大小。</p>
<h2 id="_3">重要性采样</h2>
<p>优化模型也好，算指标也好，其实我们是希望在测试集上进行，也就是说，对于给定目标$f(x)$（比如模型的loss），我们希望算的是<br />
\begin{equation}\mathbb{E}<em p_x_="p(x)" x_sim="x\sim">{x\sim q(x)}[f(x)] = \int q(x) f(x) dx\end{equation}<br />
但是要算目标$f(x)$通常要知道$x$的真实标签，但对于测试集来说我们不知道它的标签，所以不能直接算。不过我们知道训练集的标签，于是我们可以解决它来做重要性采样：<br />
\begin{equation}\int q(x) f(x) dx=\int p(x)\frac{q(x)}{p(x)} f(x) dx=\mathbb{E}</em>}\left[\frac{q(x)}{p(x)} f(x)\right]\end{equation<br />
根据公式$\eqref{eq:d}$，我们知道$\frac{q(x)}{p(x)}=\frac{D(x)}{1-D(x)}$，所以最终变成<br />
\begin{equation}\mathbb{E}<em p_x_="p(x)" x_sim="x\sim">{x\sim q(x)}[f(x)] = \mathbb{E}</em>}\left[\frac{D(x)}{1-D(x)} f(x)\right]\label{eq:w}\end{equation<br />
说白了，重要性采样的思想就是从训练集里边“挑出”那些跟测试集相近的样本，赋予更高的权重。</p>
<h2 id="_4">最终策略</h2>
<p>从公式$\eqref{eq:w}$，我们可以得到两个策略：</p>
<p>第一是直接按照公式加权，也就是说，还是按随机打乱的方式划分训练集和验证集，但是给每个样本配上权重$w(x)=\frac{D(x)}{1-D(x)}$。值得指出的是，类似的做法有些选手做比赛时已经用过了，只不过流传的权重是$D(x)$，当然哪个好我没法断言，只是从理论推导的角度来看应该是$\frac{D(x)}{1-D(x)}$更加合理一些。</p>
<p>另一个策略就是实际地把对应的验证集采样出来。这也不难，假设训练集的所有样本为$x_1,x_2,\dots,x_N$，我们把权重归一化<br />
\begin{equation}p_i = \frac{w(x_i)}{\sum\limits_{i=1}^N w(x_i)}\end{equation}<br />
然后按照$p_1,p_2,\dots,p_N$为分布做独立重复采样，直到采样到指定数目即可。注意需要做 <em>有放回</em> 的独立重复采样，因此同一个样本可能被采样多次，在验证集里边也要保留多次，不能去重，去重后分布就不一致了。</p>
<h2 id="_5">文末小结</h2>
<p>本文从训练判别器的角度来比较训练集和测试集的差异，并且结合重要性采样，我们可以得到一个跟测试集更接近的验证集，或者对训练样本进行加权，从而使得训练集的优化过程和测试集差异性更小。</p>
<p><em><strong>转载到请包括本文地址：</strong><a href="https://spaces.ac.cn/archives/7805">https://spaces.ac.cn/archives/7805</a></em></p>
<p><em><strong>更详细的转载事宜请参考：</strong></em><a href="https://spaces.ac.cn/archives/6508#%E6%96%87%E7%AB%A0%E5%A6%82%E4%BD%95%E8%BD%AC%E8%BD%BD/%E5%BC%95%E7%94%A8" title="《科学空间FAQ》">《科学空间FAQ》</a></p>
<p><strong>如果您还有什么疑惑或建议，欢迎在下方评论区继续讨论。</strong></p>
<p><strong>如果您觉得本文还不错，欢迎分享/打赏本文。打赏并非要从中获得收益，而是希望知道科学空间获得了多少读者的真心关注。当然，如果你无视它，也不会影响你的阅读。再次表示欢迎和感谢！</strong></p>
<p>打赏</p>
<p><img alt="科学空间" src="https://spaces.ac.cn/usr/themes/geekg/payment/wx.png" /></p>
<p>微信打赏</p>
<p><img alt="科学空间" src="https://spaces.ac.cn/usr/themes/geekg/payment/zfb.png" /></p>
<p>支付宝打赏</p>
<p>因为网站后台对打赏并无记录，因此欢迎在打赏时候备注留言。你还可以<a href="http://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&amp;email=tN7d1drY3drrx8H0xcWa19vZ"><strong>点击这里</strong></a>或在下方评论区留言来告知你的建议或需求。</p>
<p><strong>如果您需要引用本文，请参考：</strong></p>
<p>苏剑林. (Oct. 16, 2020). 《如何划分一个跟测试集更接近的验证集？ 》[Blog post]. Retrieved from <a href="https://spaces.ac.cn/archives/7805">https://spaces.ac.cn/archives/7805</a></p>
<p>@online{kexuefm-7805,<br />
title={如何划分一个跟测试集更接近的验证集？},<br />
author={苏剑林},<br />
year={2020},<br />
month={Oct},<br />
url={\url{https://spaces.ac.cn/archives/7805}},<br />
} </p>
<hr />
<h2 id="_6">公式推导与注释</h2>
<p>TODO: 添加详细的数学公式推导和注释</p>
        </div>
    </div>
</body>
</html>