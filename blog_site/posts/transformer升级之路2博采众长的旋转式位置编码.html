<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transformerå‡çº§ä¹‹è·¯ï¼š2ã€åšé‡‡ä¼—é•¿çš„æ—‹è½¬å¼ä½ç½®ç¼–ç </title>
    <style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    line-height: 1.6; color: #333; max-width: 900px; margin: 0 auto; padding: 20px; background: #f5f5f5;
}
.container { background: white; padding: 40px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
header { border-bottom: 2px solid #e0e0e0; padding-bottom: 20px; margin-bottom: 30px; }
h1 { color: #2c3e50; margin-bottom: 10px; font-size: 2em; }
.meta { color: #666; font-size: 0.9em; margin-bottom: 20px; }
.content { margin-top: 30px; overflow-wrap: break-word; }
.content h2 { color: #34495e; margin-top: 30px; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
.content p { margin-bottom: 15px; }
.content pre { background: #f8f8f8; padding: 15px; border-radius: 5px; overflow-x: auto; border-left: 3px solid #3498db; margin: 15px 0; }
.content code { background: #f8f8f8; padding: 2px 5px; border-radius: 3px; font-family: monospace; font-size: 0.9em; }
.content blockquote { border-left: 4px solid #3498db; padding-left: 20px; margin: 20px 0; color: #555; font-style: italic; }
.content table { border-collapse: collapse; width: 100%; margin: 20px 0; }
.content th, .content td { border: 1px solid #ddd; padding: 10px; text-align: left; }
.back-link { display: inline-block; margin-bottom: 20px; color: #3498db; text-decoration: none; font-weight: 500; }
</style>
    
<script>
    window.MathJax = {
        tex: {
            inlineMath: [['$', '$'], ['\(', '\)']],
            displayMath: [['$$', '$$'], ['\[', '\]']],
            processEscapes: true
        }
    };
</script>
<script id="MathJax-script" async src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>

</head>
<body>
    <div class="container">
        <a href="../index.html" class="back-link">â† è¿”å›é¦–é¡µ</a>
        <header>
            <h1>Transformerå‡çº§ä¹‹è·¯ï¼š2ã€åšé‡‡ä¼—é•¿çš„æ—‹è½¬å¼ä½ç½®ç¼–ç </h1>
            <div class="meta">ğŸ“… æœ€åæ›´æ–°: 2026-01-11 | ğŸ“„ å¤§å°: 76.7 KB</div>
        </header>
        <div class="content">
            <p><strong>åŸæ–‡é“¾æ¥</strong>: <a href="https://spaces.ac.cn/archives/8265">https://spaces.ac.cn/archives/8265</a></p>
<p><strong>å‘å¸ƒæ—¥æœŸ</strong>: </p>
<hr />
<p>ä¸Šä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å¯¹åŸå§‹çš„Sinusoidalä½ç½®ç¼–ç åšäº†è¾ƒä¸ºè¯¦ç»†çš„æ¨å¯¼å’Œç†è§£ï¼Œæ€»çš„æ„Ÿè§‰æ˜¯Sinusoidalä½ç½®ç¼–ç æ˜¯ä¸€ç§â€œæƒ³è¦æˆä¸ºç›¸å¯¹ä½ç½®ç¼–ç çš„ç»å¯¹ä½ç½®ç¼–ç â€ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œç»å¯¹ä½ç½®ç¼–ç å…·æœ‰å®ç°ç®€å•ã€è®¡ç®—é€Ÿåº¦å¿«ç­‰ä¼˜ç‚¹ï¼Œè€Œç›¸å¯¹ä½ç½®ç¼–ç åˆ™ç›´æ¥åœ°ä½“ç°äº†ç›¸å¯¹ä½ç½®ä¿¡å·ï¼Œè·Ÿæˆ‘ä»¬çš„ç›´è§‚ç†è§£å»åˆï¼Œå®é™…æ€§èƒ½å¾€å¾€ä¹Ÿæ›´å¥½ã€‚ç”±æ­¤å¯è§ï¼Œå¦‚æœå¯ä»¥é€šè¿‡ç»å¯¹ä½ç½®ç¼–ç çš„æ–¹å¼å®ç°ç›¸å¯¹ä½ç½®ç¼–ç ï¼Œé‚£ä¹ˆå°±æ˜¯â€œé›†å„å®¶ä¹‹æ‰€é•¿â€ã€â€œé±¼ä¸ç†ŠæŒå…¼å¾—â€äº†ã€‚Sinusoidalä½ç½®ç¼–ç éšçº¦åšåˆ°äº†è¿™ä¸€ç‚¹ï¼Œä½†å¹¶ä¸å¤Ÿå¥½ã€‚</p>
<p>æœ¬æ–‡å°†ä¼šä»‹ç»æˆ‘ä»¬è‡ªç ”çš„Rotary Transformerï¼ˆRoFormerï¼‰æ¨¡å‹ï¼Œå®ƒçš„ä¸»è¦æ”¹åŠ¨æ˜¯åº”ç”¨äº†ç¬”è€…æ„æ€çš„â€œæ—‹è½¬å¼ä½ç½®ç¼–ç ï¼ˆRotary Position Embeddingï¼ŒRoPEï¼‰â€ï¼Œè¿™æ˜¯ä¸€ç§é…åˆAttentionæœºåˆ¶èƒ½è¾¾åˆ°â€œç»å¯¹ä½ç½®ç¼–ç çš„æ–¹å¼å®ç°ç›¸å¯¹ä½ç½®ç¼–ç â€çš„è®¾è®¡ã€‚è€Œä¹Ÿæ­£å› ä¸ºè¿™ç§è®¾è®¡ï¼Œå®ƒè¿˜æ˜¯ç›®å‰å”¯ä¸€ä¸€ç§å¯ç”¨äºçº¿æ€§Attentionçš„ç›¸å¯¹ä½ç½®ç¼–ç ã€‚</p>
<blockquote>
<p><strong>RoFormerï¼š<a href="https://github.com/ZhuiyiTechnology/roformer">https://github.com/ZhuiyiTechnology/roformer</a></strong></p>
</blockquote>
<h2 id="_1">åŸºæœ¬æ€è·¯</h2>
<p>åœ¨ä¹‹å‰çš„æ–‡ç« <a href="/archives/8130">ã€Šè®©ç ”ç©¶äººå‘˜ç»å°½è„‘æ±çš„Transformerä½ç½®ç¼–ç ã€‹</a>ä¸­æˆ‘ä»¬å°±ç®€è¦ä»‹ç»è¿‡RoPEï¼Œå½“æ—¶ç§°ä¹‹ä¸ºâ€œèåˆå¼â€ï¼Œæœ¬æ–‡åˆ™æ›´åŠ è¯¦ç»†åœ°ä»‹ç»å®ƒçš„æ¥æºä¸æ€§è´¨ã€‚åœ¨RoPEä¸­ï¼Œæˆ‘ä»¬çš„å‡ºå‘ç‚¹å°±æ˜¯â€œé€šè¿‡ç»å¯¹ä½ç½®ç¼–ç çš„æ–¹å¼å®ç°ç›¸å¯¹ä½ç½®ç¼–ç â€ï¼Œè¿™æ ·åšæ—¢æœ‰ç†è®ºä¸Šçš„ä¼˜é›…ä¹‹å¤„ï¼Œä¹Ÿæœ‰å®è·µä¸Šçš„å®ç”¨ä¹‹å¤„ï¼Œæ¯”å¦‚å®ƒå¯ä»¥æ‹“å±•åˆ°çº¿æ€§Attentionä¸­å°±æ˜¯ä¸»è¦å› ä¸ºè¿™ä¸€ç‚¹ã€‚</p>
<p>ä¸ºäº†è¾¾åˆ°è¿™ä¸ªç›®çš„ï¼Œæˆ‘ä»¬å‡è®¾é€šè¿‡ä¸‹è¿°è¿ç®—æ¥ç»™$\boldsymbol{q},\boldsymbol{k}$æ·»åŠ ç»å¯¹ä½ç½®ä¿¡æ¯ï¼š<br />
\begin{equation}\tilde{\boldsymbol{q}}_m = \boldsymbol{f}(\boldsymbol{q}, m), \quad\tilde{\boldsymbol{k}}_n = \boldsymbol{f}(\boldsymbol{k}, n)\end{equation}<br />
ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬åˆ†åˆ«ä¸º$\boldsymbol{q},\boldsymbol{k}$è®¾è®¡æ“ä½œ$\boldsymbol{f}(\cdot, m),\boldsymbol{f}(\cdot, n)$ï¼Œä½¿å¾—ç»è¿‡è¯¥æ“ä½œåï¼Œ$\tilde{\boldsymbol{q}}_m,\tilde{\boldsymbol{k}}_n$å°±å¸¦æœ‰äº†ä½ç½®$m,n$çš„ç»å¯¹ä½ç½®ä¿¡æ¯ã€‚Attentionçš„æ ¸å¿ƒè¿ç®—æ˜¯å†…ç§¯ï¼Œæ‰€ä»¥æˆ‘ä»¬å¸Œæœ›çš„å†…ç§¯çš„ç»“æœå¸¦æœ‰ç›¸å¯¹ä½ç½®ä¿¡æ¯ï¼Œå› æ­¤å‡è®¾å­˜åœ¨æ’ç­‰å…³ç³»ï¼š<br />
\begin{equation}\langle\boldsymbol{f}(\boldsymbol{q}, m), \boldsymbol{f}(\boldsymbol{k}, n)\rangle = g(\boldsymbol{q},\boldsymbol{k},m-n)\end{equation}<br />
æ‰€ä»¥æˆ‘ä»¬è¦æ±‚å‡ºè¯¥æ’ç­‰å¼çš„ä¸€ä¸ªï¼ˆå°½å¯èƒ½ç®€å•çš„ï¼‰è§£ã€‚æ±‚è§£è¿‡ç¨‹è¿˜éœ€è¦ä¸€äº›åˆå§‹æ¡ä»¶ï¼Œæ˜¾ç„¶æˆ‘ä»¬å¯ä»¥åˆç†åœ°è®¾$\boldsymbol{f}(\boldsymbol{q}, 0)=\boldsymbol{q}$å’Œ$\boldsymbol{f}(\boldsymbol{k}, 0)=\boldsymbol{k}$ã€‚</p>
<h2 id="_2">æ±‚è§£è¿‡ç¨‹</h2>
<p>åŒä¸Šä¸€ç¯‡æ€è·¯ä¸€æ ·ï¼Œæˆ‘ä»¬å…ˆè€ƒè™‘äºŒç»´æƒ…å½¢ï¼Œç„¶åå€ŸåŠ©å¤æ•°æ¥æ±‚è§£ã€‚åœ¨å¤æ•°ä¸­æœ‰$\langle\boldsymbol{q},\boldsymbol{k}\rangle=\text{Re}[\boldsymbol{q}\boldsymbol{k}^<em>]$ï¼Œ$\text{Re}[]$ä»£è¡¨å¤æ•°çš„å®éƒ¨ï¼Œæ‰€ä»¥æˆ‘ä»¬æœ‰<br />
\begin{equation}\text{Re}[\boldsymbol{f}(\boldsymbol{q}, m)\boldsymbol{f}^</em>(\boldsymbol{k}, n)] = g(\boldsymbol{q},\boldsymbol{k},m-n)\end{equation}<br />
ç®€å•èµ·è§ï¼Œæˆ‘ä»¬å‡è®¾å­˜åœ¨å¤æ•°$\boldsymbol{g}(\boldsymbol{q},\boldsymbol{k},m-n)$ï¼Œä½¿å¾—$\boldsymbol{f}(\boldsymbol{q}, m)\boldsymbol{f}^*(\boldsymbol{k}, n) = \boldsymbol{g}(\boldsymbol{q},\boldsymbol{k},m-n)$ï¼Œç„¶åæˆ‘ä»¬ç”¨å¤æ•°çš„æŒ‡æ•°å½¢å¼ï¼Œè®¾<br />
\begin{equation}\begin{aligned}<br />
\boldsymbol{f}(\boldsymbol{q}, m) =&amp;\, R_f (\boldsymbol{q}, m)e^{\text{i}\Theta_f(\boldsymbol{q}, m)} \\\<br />
\boldsymbol{f}(\boldsymbol{k}, n) =&amp;\, R_f (\boldsymbol{k}, n)e^{\text{i}\Theta_f(\boldsymbol{k}, n)} \\\<br />
\boldsymbol{g}(\boldsymbol{q}, \boldsymbol{k}, m-n) =&amp;\, R_g (\boldsymbol{q}, \boldsymbol{k}, m-n)e^{\text{i}\Theta_g(\boldsymbol{q}, \boldsymbol{k}, m-n)} \\\<br />
\end{aligned}\end{equation}<br />
é‚£ä¹ˆä»£å…¥æ–¹ç¨‹åå°±å¾—åˆ°æ–¹ç¨‹ç»„<br />
\begin{equation}\begin{aligned}<br />
R_f (\boldsymbol{q}, m) R_f (\boldsymbol{k}, n) =&amp;\, R_g (\boldsymbol{q}, \boldsymbol{k}, m-n) \\\<br />
\Theta_f (\boldsymbol{q}, m) - \Theta_f (\boldsymbol{k}, n) =&amp;\, \Theta_g (\boldsymbol{q}, \boldsymbol{k}, m-n)<br />
\end{aligned}\end{equation}<br />
å¯¹äºç¬¬ä¸€ä¸ªæ–¹ç¨‹ï¼Œä»£å…¥$m=n$å¾—åˆ°<br />
\begin{equation}R_f (\boldsymbol{q}, m) R_f (\boldsymbol{k}, m) = R_g (\boldsymbol{q}, \boldsymbol{k}, 0) = R_f (\boldsymbol{q}, 0) R_f (\boldsymbol{k}, 0) = \Vert \boldsymbol{q}\Vert \Vert \boldsymbol{k}\Vert\end{equation}<br />
æœ€åä¸€ä¸ªç­‰å·æºäºåˆå§‹æ¡ä»¶$\boldsymbol{f}(\boldsymbol{q}, 0)=\boldsymbol{q}$å’Œ$\boldsymbol{f}(\boldsymbol{k}, 0)=\boldsymbol{k}$ã€‚æ‰€ä»¥ç°åœ¨æˆ‘ä»¬å¯ä»¥å¾ˆç®€å•åœ°è®¾$R_f (\boldsymbol{q}, m)=\Vert \boldsymbol{q}\Vert, R_f (\boldsymbol{k}, m)=\Vert \boldsymbol{k}\Vert$ï¼Œå³å®ƒä¸ä¾èµ–äº$m$ã€‚è‡³äºç¬¬äºŒä¸ªæ–¹ç¨‹ï¼ŒåŒæ ·ä»£å…¥$m=n$å¾—åˆ°<br />
\begin{equation}\Theta_f (\boldsymbol{q}, m) - \Theta_f (\boldsymbol{k}, m) = \Theta_g (\boldsymbol{q}, \boldsymbol{k}, 0) = \Theta_f (\boldsymbol{q}, 0) - \Theta_f (\boldsymbol{k}, 0) = \Theta (\boldsymbol{q}) - \Theta (\boldsymbol{k})\end{equation}<br />
è¿™é‡Œçš„$\Theta (\boldsymbol{q}),\Theta (\boldsymbol{k})$æ˜¯$\boldsymbol{q},\boldsymbol{k}$æœ¬èº«çš„å¹…è§’ï¼Œæœ€åä¸€ä¸ªç­‰å·åŒæ ·æºäºåˆå§‹æ¡ä»¶ã€‚æ ¹æ®ä¸Šå¼å¾—åˆ°$\Theta_f (\boldsymbol{q}, m) - \Theta (\boldsymbol{q}) = \Theta_f (\boldsymbol{k}, m) - \Theta (\boldsymbol{k})$ï¼Œæ‰€ä»¥$\Theta_f (\boldsymbol{q}, m) - \Theta (\boldsymbol{q})$åº”è¯¥æ˜¯ä¸€ä¸ªåªä¸$m$ç›¸å…³ã€è·Ÿ$\boldsymbol{q}$æ— å…³çš„å‡½æ•°ï¼Œè®°ä¸º$\varphi(m)$ï¼Œå³$\Theta_f (\boldsymbol{q}, m) = \Theta (\boldsymbol{q}) + \varphi(m)$ã€‚æ¥ç€ä»£å…¥$n=m-1$ï¼Œæ•´ç†å¾—åˆ°<br />
\begin{equation}\varphi(m) - \varphi(m-1) = \Theta_g (\boldsymbol{q}, \boldsymbol{k}, 1) + \Theta (\boldsymbol{k}) - \Theta (\boldsymbol{q})\end{equation}<br />
å³$\{\varphi(m)\}$æ˜¯ç­‰å·®æ•°åˆ—ï¼Œè®¾å³ç«¯ä¸º$\theta$ï¼Œé‚£ä¹ˆå°±è§£å¾—$\varphi(m)=m\theta$ã€‚</p>
<h2 id="_3">ç¼–ç å½¢å¼</h2>
<p>ç»¼ä¸Šï¼Œæˆ‘ä»¬å¾—åˆ°äºŒç»´æƒ…å†µä¸‹ç”¨å¤æ•°è¡¨ç¤ºçš„RoPEï¼š<br />
\begin{equation}<br />
\boldsymbol{f}(\boldsymbol{q}, m) = R_f (\boldsymbol{q}, m)e^{\text{i}\Theta_f(\boldsymbol{q}, m)}<br />
= \Vert q\Vert e^{\text{i}(\Theta(\boldsymbol{q}) + m\theta)} = \boldsymbol{q} e^{\text{i}m\theta}\end{equation}<br />
æ ¹æ®å¤æ•°ä¹˜æ³•çš„å‡ ä½•æ„ä¹‰ï¼Œè¯¥å˜æ¢å®é™…ä¸Šå¯¹åº”ç€å‘é‡çš„æ—‹è½¬ï¼Œæ‰€ä»¥æˆ‘ä»¬ç§°ä¹‹ä¸ºâ€œæ—‹è½¬å¼ä½ç½®ç¼–ç â€ï¼Œå®ƒè¿˜å¯ä»¥å†™æˆçŸ©é˜µå½¢å¼ï¼š<br />
\begin{equation}<br />
\boldsymbol{f}(\boldsymbol{q}, m) =\begin{pmatrix}\cos m\theta &amp; -\sin m\theta\\\ \sin m\theta &amp; \cos m\theta\end{pmatrix} \begin{pmatrix}q_0 \\\ q_1\end{pmatrix}\end{equation}<br />
ç”±äºå†…ç§¯æ»¡è¶³çº¿æ€§å åŠ æ€§ï¼Œå› æ­¤ä»»æ„å¶æ•°ç»´çš„RoPEï¼Œæˆ‘ä»¬éƒ½å¯ä»¥è¡¨ç¤ºä¸ºäºŒç»´æƒ…å½¢çš„æ‹¼æ¥ï¼Œå³<br />
\begin{equation}\scriptsize{\underbrace{\begin{pmatrix}<br />
\cos m\theta_0 &amp; -\sin m\theta_0 &amp; 0 &amp; 0 &amp; \cdots &amp; 0 &amp; 0 \\\<br />
\sin m\theta_0 &amp; \cos m\theta_0 &amp; 0 &amp; 0 &amp; \cdots &amp; 0 &amp; 0 \\\<br />
0 &amp; 0 &amp; \cos m\theta_1 &amp; -\sin m\theta_1 &amp; \cdots &amp; 0 &amp; 0 \\\<br />
0 &amp; 0 &amp; \sin m\theta_1 &amp; \cos m\theta_1 &amp; \cdots &amp; 0 &amp; 0 \\\<br />
\vdots &amp; \vdots &amp; \vdots &amp; \vdots &amp; \ddots &amp; \vdots &amp; \vdots \\\<br />
0 &amp; 0 &amp; 0 &amp; 0 &amp; \cdots &amp; \cos m\theta_{d/2-1} &amp; -\sin m\theta_{d/2-1} \\\<br />
0 &amp; 0 &amp; 0 &amp; 0 &amp; \cdots &amp; \sin m\theta_{d/2-1} &amp; \cos m\theta_{d/2-1} \\\<br />
\end{pmatrix}}<em d-2="d-2">{\boldsymbol{\mathcal{R}}_m} \begin{pmatrix}q_0 \\\ q_1 \\\ q_2 \\\ q_3 \\\ \vdots \\\ q</em>} \\\ q_{d-1}\end{pmatrix}}\end{equation<br />
ä¹Ÿå°±æ˜¯è¯´ï¼Œç»™ä½ç½®ä¸º$m$çš„å‘é‡$\boldsymbol{q}$ä¹˜ä¸ŠçŸ©é˜µ$\boldsymbol{\mathcal{R}}<em n-m="n-m">m$ã€ä½ç½®ä¸º$n$çš„å‘é‡$\boldsymbol{k}$ä¹˜ä¸ŠçŸ©é˜µ$\boldsymbol{\mathcal{R}}_n$ï¼Œç”¨å˜æ¢åçš„$\boldsymbol{Q},\boldsymbol{K}$åºåˆ—åšAttentionï¼Œé‚£ä¹ˆAttentionå°±è‡ªåŠ¨åŒ…å«ç›¸å¯¹ä½ç½®ä¿¡æ¯äº†ï¼Œå› ä¸ºæˆç«‹æ’ç­‰å¼ï¼š<br />
\begin{equation}(\boldsymbol{\mathcal{R}}_m \boldsymbol{q})^{\top}(\boldsymbol{\mathcal{R}}_n \boldsymbol{k}) = \boldsymbol{q}^{\top} \boldsymbol{\mathcal{R}}_m^{\top}\boldsymbol{\mathcal{R}}_n \boldsymbol{k} = \boldsymbol{q}^{\top} \boldsymbol{\mathcal{R}}</em>} \boldsymbol{k}\end{equation<br />
å€¼å¾—æŒ‡å‡ºçš„æ˜¯ï¼Œ$\boldsymbol{\mathcal{R}}_m$æ˜¯ä¸€ä¸ªæ­£äº¤çŸ©é˜µï¼Œå®ƒä¸ä¼šæ”¹å˜å‘é‡çš„æ¨¡é•¿ï¼Œå› æ­¤é€šå¸¸æ¥è¯´å®ƒä¸ä¼šæ”¹å˜åŸæ¨¡å‹çš„ç¨³å®šæ€§ã€‚</p>
<p>ç”±äº$\boldsymbol{\mathcal{R}}<em d-2="d-2">m$çš„ç¨€ç–æ€§ï¼Œæ‰€ä»¥ç›´æ¥ç”¨çŸ©é˜µä¹˜æ³•æ¥å®ç°ä¼šå¾ˆæµªè´¹ç®—åŠ›ï¼Œæ¨èé€šè¿‡ä¸‹è¿°æ–¹å¼æ¥å®ç°RoPEï¼š<br />
\begin{equation}\begin{pmatrix}q_0 \\\ q_1 \\\ q_2 \\\ q_3 \\\ \vdots \\\ q</em>} \\\ q_{d-1<br />
\end{pmatrix}\otimes\begin{pmatrix}\cos m\theta_0 \\\ \cos m\theta_0 \\\ \cos m\theta_1 \\\ \cos m\theta_1 \\\ \vdots \\\ \cos m\theta_{d/2-1} \\\ \cos m\theta_{d/2-1}<br />
\end{pmatrix} + \begin{pmatrix}-q_1 \\\ q_0 \\\ -q_3 \\\ q_2 \\\ \vdots \\\ -q_{d-1} \\\ q_{d-2}<br />
\end{pmatrix}\otimes\begin{pmatrix}\sin m\theta_0 \\\ \sin m\theta_0 \\\ \sin m\theta_1 \\\ \sin m\theta_1 \\\ \vdots \\\ \sin m\theta_{d/2-1} \\\ \sin m\theta_{d/2-1}<br />
\end{pmatrix}\end{equation}<br />
å…¶ä¸­$\otimes$æ˜¯é€ä½å¯¹åº”ç›¸ä¹˜ï¼Œå³Numpyã€Tensorflowç­‰è®¡ç®—æ¡†æ¶ä¸­çš„$*$è¿ç®—ã€‚ä»è¿™ä¸ªå®ç°ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼ŒRoPEå¯ä»¥è§†ä¸ºæ˜¯ä¹˜æ€§ä½ç½®ç¼–ç çš„å˜ä½“ã€‚</p>
<h2 id="_4">è¿œç¨‹è¡°å‡</h2>
<p>å¯ä»¥çœ‹åˆ°ï¼ŒRoPEå½¢å¼ä¸Šå’ŒSinusoidalä½ç½®ç¼–ç æœ‰ç‚¹ç›¸ä¼¼ï¼Œåªä¸è¿‡Sinusoidalä½ç½®ç¼–ç æ˜¯åŠ æ€§çš„ï¼Œè€ŒRoPEå¯ä»¥è§†ä¸ºä¹˜æ€§çš„ã€‚åœ¨$\theta_i$çš„é€‰æ‹©ä¸Šï¼Œæˆ‘ä»¬åŒæ ·æ²¿ç”¨äº†Sinusoidalä½ç½®ç¼–ç çš„æ–¹æ¡ˆï¼Œå³$\theta_i = 10000^{-2i/d}$ï¼Œå®ƒå¯ä»¥å¸¦æ¥ä¸€å®šçš„è¿œç¨‹è¡°å‡æ€§ã€‚</p>
<p>å…·ä½“è¯æ˜å¦‚ä¸‹ï¼šå°†$\boldsymbol{q},\boldsymbol{k}$ä¸¤ä¸¤åˆ†ç»„åï¼Œå®ƒä»¬åŠ ä¸ŠRoPEåçš„å†…ç§¯å¯ä»¥ç”¨å¤æ•°ä¹˜æ³•è¡¨ç¤ºä¸º<br />
\begin{equation}<br />
(\boldsymbol{\mathcal{R}}<em i="0">m \boldsymbol{q})^{\top}(\boldsymbol{\mathcal{R}}_n \boldsymbol{k}) = \text{Re}\left[\sum</em>}^{d/2-1}\boldsymbol{q<em _2i:2i_1_="[2i:2i+1]">{[2i:2i+1]}\boldsymbol{k}</em>^<em> e^{\text{i}(m-n)\theta_i}\right]\end{equation}<br />
è®°$h_i = \boldsymbol{q}<em _2i:2i_1_="[2i:2i+1]">{[2i:2i+1]}\boldsymbol{k}</em>^</em>, S_j = \sum\limits_{i=0}^{j-1} e^{\text{i}(m-n)\theta_i}$ï¼Œå¹¶çº¦å®š$h_{d/2}=0,S_0=0$ï¼Œé‚£ä¹ˆç”±<a href="https://zh.wikipedia.org/wiki/%E5%88%86%E9%83%A8%E6%B1%82%E5%92%8C%E6%B3%95">Abelå˜æ¢ï¼ˆåˆ†éƒ¨æ±‚å’Œæ³•ï¼‰</a>å¯ä»¥å¾—åˆ°ï¼š<br />
\begin{equation}\sum_{i=0}^{d/2-1}\boldsymbol{q}<em _2i:2i_1_="[2i:2i+1]">{[2i:2i+1]}\boldsymbol{k}</em>^<em> e^{\text{i}(m-n)\theta_i} = \sum_{i=0}^{d/2-1} h_i (S_{i<br />
+1} - S_i) = -\sum_{i=0}^{d/2-1} S_{i+1}(h_{i+1} - h_i)\end{equation}<br />
æ‰€ä»¥<br />
\begin{equation}\begin{aligned}<br />
\left|\sum_{i=0}^{d/2-1}\boldsymbol{q}<em _2i:2i_1_="[2i:2i+1]">{[2i:2i+1]}\boldsymbol{k}</em>^</em> e^{\text{i}(m-n)\theta_i}\right| =&amp;\, \left|\sum_{i=0}^{d/2-1} S_{i+1}(h_{i+1} - h_i)\right| \\\<br />
\leq&amp;\, \sum_{i=0}^{d/2-1} |S_{i+1}| |h_{i+1} - h_i| \\\<br />
\leq&amp;\, \left(\max_i |h_{i+1} - h_i|\right)\sum_{i=0}^{d/2-1} |S_{i+1}|<br />
\end{aligned}\end{equation}<br />
å› æ­¤æˆ‘ä»¬å¯ä»¥è€ƒå¯Ÿ$\frac{1}{d/2}\sum\limits_{i=1}^{d/2} |S_i|$éšç€ç›¸å¯¹è·ç¦»çš„å˜åŒ–æƒ…å†µæ¥ä½œä¸ºè¡°å‡æ€§çš„ä½“ç°ï¼ŒMathematicaä»£ç å¦‚ä¸‹ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">128</span><span class="p">;</span>
<span class="err">\</span><span class="o">[</span><span class="n">Theta</span><span class="o">][</span><span class="n">t_</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10000</span><span class="o">^</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">t</span><span class="o">/</span><span class="n">d</span><span class="p">);</span>
<span class="n">f</span><span class="o">[</span><span class="n">m_</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">Sum</span><span class="o">[</span>
<span class="n">    Norm[Sum[Exp[I*m*\[Theta</span><span class="o">][</span><span class="n">i</span><span class="o">]</span><span class="err">]</span><span class="p">,</span><span class="w"> </span><span class="err">{</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="err">}]]</span><span class="p">,</span><span class="w"> </span><span class="err">{</span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="o">/</span><span class="mi">2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="err">}]</span><span class="o">/</span><span class="p">(</span><span class="n">d</span><span class="o">/</span><span class="mi">2</span><span class="p">);</span>
<span class="n">Plot</span><span class="o">[</span><span class="n">f[m</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="err">{</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">256</span><span class="err">}</span><span class="p">,</span><span class="w"> </span><span class="n">AxesLabel</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="err">{</span><span class="n">ç›¸å¯¹è·ç¦»</span><span class="p">,</span><span class="w"> </span><span class="n">ç›¸å¯¹å¤§å°</span><span class="err">}]</span>
</code></pre></div>

<p>ç»“æœå¦‚ä¸‹å›¾ï¼š  </p>
<p><a href="/usr/uploads/2021/03/1347893165.png" title="ç‚¹å‡»æŸ¥çœ‹åŸå›¾"><img alt="RoPEçš„è¿œç¨‹è¡°å‡æ€§ï¼ˆd=128ï¼‰" src="/usr/uploads/2021/03/1347893165.png" /></a></p>
<p>RoPEçš„è¿œç¨‹è¡°å‡æ€§ï¼ˆd=128ï¼‰</p>
<p>ä»å›¾ä¸­æˆ‘ä»¬å¯ä»¥å¯ä»¥çœ‹åˆ°éšç€ç›¸å¯¹è·ç¦»çš„å˜å¤§ï¼Œå†…ç§¯ç»“æœæœ‰è¡°å‡è¶‹åŠ¿çš„å‡ºç°ã€‚å› æ­¤ï¼Œé€‰æ‹©$\theta_i = 10000^{-2i/d}$ï¼Œç¡®å®èƒ½å¸¦æ¥ä¸€å®šçš„è¿œç¨‹è¡°å‡æ€§ã€‚å½“ç„¶ï¼ŒåŒä¸Šä¸€ç¯‡æ–‡ç« è¯´çš„ä¸€æ ·ï¼Œèƒ½å¸¦æ¥è¿œç¨‹è¡°å‡æ€§çš„ä¸æ­¢è¿™ä¸ªé€‰æ‹©ï¼Œå‡ ä¹ä»»æ„çš„å…‰æ»‘å•è°ƒå‡½æ•°éƒ½å¯ä»¥ï¼Œè¿™é‡Œåªæ˜¯æ²¿ç”¨äº†å·²æœ‰çš„é€‰æ‹©è€Œå·²ã€‚ç¬”è€…è¿˜è¯•è¿‡ä»¥$\theta_i = 10000^{-2i/d}$ä¸ºåˆå§‹åŒ–ï¼Œå°†$\theta_i$è§†ä¸ºå¯è®­ç»ƒå‚æ•°ï¼Œç„¶åè®­ç»ƒä¸€æ®µæ—¶é—´åå‘ç°$\theta_i$å¹¶æ²¡æœ‰æ˜¾è‘—æ›´æ–°ï¼Œå› æ­¤å¹²è„†å°±ç›´æ¥å›ºå®š$\theta_i = 10000^{-2i/d}$äº†ã€‚</p>
<h2 id="_5">çº¿æ€§åœºæ™¯</h2>
<p>æœ€åï¼Œæˆ‘ä»¬æŒ‡å‡ºï¼ŒRoPEæ˜¯ç›®å‰å”¯ä¸€ä¸€ç§å¯ä»¥ç”¨äºçº¿æ€§Attentionçš„ç›¸å¯¹ä½ç½®ç¼–ç ã€‚è¿™æ˜¯å› ä¸ºå…¶ä»–çš„ç›¸å¯¹ä½ç½®ç¼–ç ï¼Œéƒ½æ˜¯ç›´æ¥åŸºäºAttentionçŸ©é˜µè¿›è¡Œæ“ä½œçš„ï¼Œä½†æ˜¯çº¿æ€§Attentionå¹¶æ²¡æœ‰äº‹å…ˆç®—å‡ºAttentionçŸ©é˜µï¼Œå› æ­¤ä¹Ÿå°±ä¸å­˜åœ¨æ“ä½œAttentionçŸ©é˜µçš„åšæ³•ï¼Œæ‰€ä»¥å…¶ä»–çš„æ–¹æ¡ˆæ— æ³•åº”ç”¨åˆ°çº¿æ€§Attentionä¸­ã€‚è€Œå¯¹äºRoPEæ¥è¯´ï¼Œå®ƒæ˜¯ç”¨ç»å¯¹ä½ç½®ç¼–ç çš„æ–¹å¼æ¥å®ç°ç›¸å¯¹ä½ç½®ç¼–ç ï¼Œä¸éœ€è¦æ“ä½œAttentionçŸ©é˜µï¼Œå› æ­¤æœ‰äº†åº”ç”¨åˆ°çº¿æ€§Attentionçš„å¯èƒ½æ€§ã€‚</p>
<p>å…³äºçº¿æ€§Attentionçš„ä»‹ç»ï¼Œè¿™é‡Œä¸å†é‡å¤ï¼Œæœ‰éœ€è¦çš„è¯»è€…è¯·å‚è€ƒ<a href="/archives/7546">ã€Šçº¿æ€§Attentionçš„æ¢ç´¢ï¼šAttentionå¿…é¡»æœ‰ä¸ªSoftmaxå—ï¼Ÿã€‹</a>ã€‚çº¿æ€§Attentionçš„å¸¸è§å½¢å¼æ˜¯ï¼š<br />
\begin{equation}Attention(\boldsymbol{Q},\boldsymbol{K},\boldsymbol{V})<em j="1">i = \frac{\sum\limits</em>}^n \text{sim}(\boldsymbol{q<em j="1">i, \boldsymbol{k}_j)\boldsymbol{v}_j}{\sum\limits</em>}^n \text{sim}(\boldsymbol{q<em j="1">i, \boldsymbol{k}_j)} = \frac{\sum\limits</em>}^n \phi(\boldsymbol{q<em j="1">i)^{\top} \varphi(\boldsymbol{k}_j)\boldsymbol{v}_j}{\sum\limits</em>}^n \phi(\boldsymbol{q<em j="1">i)^{\top} \varphi(\boldsymbol{k}_j)}\end{equation}<br />
å…¶ä¸­$\phi,\varphi$æ˜¯å€¼åŸŸéè´Ÿçš„æ¿€æ´»å‡½æ•°ã€‚å¯ä»¥çœ‹åˆ°ï¼Œçº¿æ€§Attentionä¹Ÿæ˜¯åŸºäºå†…ç§¯çš„ï¼Œæ‰€ä»¥å¾ˆè‡ªç„¶çš„æƒ³æ³•æ˜¯å¯ä»¥å°†RoPEæ’å…¥åˆ°å†…ç§¯ä¸­ï¼š<br />
\begin{equation}\frac{\sum\limits</em>}^n [\boldsymbol{\mathcal{R}<em j="1">i\phi(\boldsymbol{q}_i)]^{\top} [\boldsymbol{\mathcal{R}}_j\varphi(\boldsymbol{k}_j)]\boldsymbol{v}_j}{\sum\limits</em>}^n [\boldsymbol{\mathcal{R}<em j="1">i\phi(\boldsymbol{q}_i)]^{\top} [\boldsymbol{\mathcal{R}}_j\varphi(\boldsymbol{k}_j)]}\end{equation}<br />
ä½†è¿™æ ·å­˜åœ¨çš„é—®é¢˜æ˜¯ï¼Œå†…ç§¯$[\boldsymbol{\mathcal{R}}_i\phi(\boldsymbol{q}_i)]^{\top} [\boldsymbol{\mathcal{R}}_j\varphi(\boldsymbol{k}_j)]$å¯èƒ½ä¸ºè´Ÿæ•°ï¼Œå› æ­¤å®ƒä¸å†æ˜¯å¸¸è§„çš„æ¦‚ç‡æ³¨æ„åŠ›ï¼Œè€Œä¸”åˆ†æ¯æœ‰ä¸º0çš„é£é™©ï¼Œå¯èƒ½ä¼šå¸¦æ¥ä¼˜åŒ–ä¸Šçš„ä¸ç¨³å®šã€‚è€ƒè™‘åˆ°$\boldsymbol{\mathcal{R}}_i,\boldsymbol{\mathcal{R}}_j$éƒ½æ˜¯æ­£äº¤çŸ©é˜µï¼Œå®ƒä¸æ”¹å˜å‘é‡çš„æ¨¡é•¿ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥æŠ›å¼ƒå¸¸è§„çš„æ¦‚ç‡å½’ä¸€åŒ–è¦æ±‚ï¼Œä½¿ç”¨å¦‚ä¸‹è¿ç®—ä½œä¸ºä¸€ç§æ–°çš„çº¿æ€§Attentionï¼š<br />
\begin{equation}\frac{\sum\limits</em>}^n [\boldsymbol{\mathcal{R}<em j="1">i\phi(\boldsymbol{q}_i)]^{\top} [\boldsymbol{\mathcal{R}}_j\varphi(\boldsymbol{k}_j)]\boldsymbol{v}_j}{\sum\limits</em>}^n \phi(\boldsymbol{q}_i)^{\top} \varphi(\boldsymbol{k}_j)}\end{equation<br />
ä¹Ÿå°±æ˜¯è¯´ï¼ŒRoPEåªæ’å…¥åˆ†å­ä¸­ï¼Œè€Œåˆ†æ¯åˆ™ä¸æ”¹å˜ï¼Œè¿™æ ·çš„æ³¨æ„åŠ›ä¸å†æ˜¯åŸºäºæ¦‚ç‡çš„ï¼ˆæ³¨æ„åŠ›çŸ©é˜µä¸å†æ»¡è¶³éè´Ÿå½’ä¸€æ€§ï¼‰ï¼Œä½†å®ƒæŸç§æ„ä¹‰ä¸Šæ¥è¯´ä¹Ÿæ˜¯ä¸€ä¸ªå½’ä¸€åŒ–æ–¹æ¡ˆï¼Œè€Œä¸”ä¹Ÿæ²¡æœ‰è¯æ®è¡¨æ˜éæ¦‚ç‡å¼çš„æ³¨æ„åŠ›å°±ä¸å¥½ï¼ˆæ¯”å¦‚<a href="/archives/8180">NystrÃ¶mformer</a>ä¹Ÿç®—æ˜¯æ²¡æœ‰ä¸¥æ ¼ä¾æ®æ¦‚ç‡åˆ†å¸ƒçš„æ–¹å¼æ„å»ºæ³¨æ„åŠ›ï¼‰ï¼Œæ‰€ä»¥æˆ‘ä»¬å°†å®ƒä½œä¸ºå€™é€‰æ–¹æ¡ˆä¹‹ä¸€è¿›è¡Œå®éªŒï¼Œè€Œæˆ‘ä»¬åˆæ­¥çš„å®éªŒç»“æœæ˜¾ç¤ºè¿™æ ·çš„çº¿æ€§Attentionä¹Ÿæ˜¯æœ‰æ•ˆçš„ã€‚</p>
<p>æ­¤å¤–ï¼Œç¬”è€…åœ¨<a href="/archives/7546">ã€Šçº¿æ€§Attentionçš„æ¢ç´¢ï¼šAttentionå¿…é¡»æœ‰ä¸ªSoftmaxå—ï¼Ÿã€‹</a>ä¸­è¿˜æå‡ºè¿‡å¦å¤–ä¸€ç§çº¿æ€§Attentionæ–¹æ¡ˆï¼š$\text{sim}(\boldsymbol{q}_i, \boldsymbol{k}_j) = 1 + \left( \frac{\boldsymbol{q}_i}{\Vert \boldsymbol{q}_i\Vert}\right)^{\top}\left(\frac{\boldsymbol{k}_j}{\Vert \boldsymbol{k}_j\Vert}\right)$ï¼Œå®ƒä¸ä¾èµ–äºå€¼åŸŸçš„éè´Ÿæ€§ï¼Œè€ŒRoPEä¹Ÿä¸æ”¹å˜æ¨¡é•¿ï¼Œå› æ­¤RoPEå¯ä»¥ç›´æ¥åº”ç”¨äºæ­¤ç±»çº¿æ€§Attentionï¼Œå¹¶ä¸”ä¸æ”¹å˜å®ƒçš„æ¦‚ç‡æ„ä¹‰ã€‚</p>
<h2 id="_6">æ¨¡å‹å¼€æº</h2>
<p>RoFormerçš„ç¬¬ä¸€ç‰ˆæ¨¡å‹ï¼Œæˆ‘ä»¬å·²ç»å®Œæˆè®­ç»ƒå¹¶å¼€æºåˆ°äº†Githubä¸­ï¼š</p>
<blockquote>
<p><strong>RoFormerï¼š<a href="https://github.com/ZhuiyiTechnology/roformer">https://github.com/ZhuiyiTechnology/roformer</a></strong></p>
</blockquote>
<p>ç®€å•æ¥è¯´ï¼ŒRoFormeræ˜¯ä¸€ä¸ªç»å¯¹ä½ç½®ç¼–ç æ›¿æ¢ä¸ºRoPEçš„<a href="https://github.com/ZhuiyiTechnology/WoBERT">WoBERT</a>æ¨¡å‹ï¼Œå®ƒè·Ÿå…¶ä»–æ¨¡å‹çš„ç»“æ„å¯¹æ¯”å¦‚ä¸‹ï¼š<br />
\begin{array}{c|cccc}<br />
\hline<br />
&amp; \text{BERT} &amp; \text{WoBERT} &amp; \text{NEZHA} &amp; \text{RoFormer} \\\<br />
\hline<br />
\text{tokenå•ä½} &amp; \text{å­—} &amp; \text{è¯} &amp; \text{å­—} &amp; \text{è¯} &amp; \\\<br />
\text{ä½ç½®ç¼–ç } &amp; \text{ç»å¯¹ä½ç½®} &amp; \text{ç»å¯¹ä½ç½®} &amp; \text{ç»å…¸å¼ç›¸å¯¹ä½ç½®} &amp; \text{RoPE}\\\<br />
\hline<br />
\end{array}<br />
åœ¨é¢„è®­ç»ƒä¸Šï¼Œæˆ‘ä»¬ä»¥WoBERT Plusä¸ºåŸºç¡€ï¼Œé‡‡ç”¨äº†å¤šä¸ªé•¿åº¦å’Œbatch sizeäº¤æ›¿è®­ç»ƒçš„æ–¹å¼ï¼Œè®©æ¨¡å‹èƒ½æå‰é€‚åº”ä¸åŒçš„è®­ç»ƒåœºæ™¯ï¼š<br />
\begin{array}{c|ccccc}<br />
\hline<br />
&amp; \text{maxlen} &amp; \text{batch size} &amp; \text{è®­ç»ƒæ­¥æ•°} &amp; \text{æœ€ç»ˆloss} &amp; \text{æœ€ç»ˆacc}\\\<br />
\hline<br />
1 &amp; 512 &amp; 256 &amp; 20\text{ä¸‡} &amp; 1.73 &amp; 65.0\%\\\<br />
2 &amp; 1536 &amp; 256 &amp; 1.25\text{ä¸‡} &amp; 1.61 &amp; 66.8\%\\\<br />
3 &amp; 256 &amp; 256 &amp; 12\text{ä¸‡} &amp; 1.75 &amp; 64.6\%\\\<br />
4 &amp; 128 &amp; 512 &amp; 8\text{ä¸‡} &amp; 1.83 &amp; 63.4\%\\\<br />
5 &amp; 1536 &amp; 256 &amp; 1\text{ä¸‡} &amp; 1.58 &amp; 67.4\%\\\<br />
6 &amp; 512 &amp; 512 &amp; 3\text{ä¸‡} &amp; 1.66 &amp; 66.2\%\\\<br />
\hline<br />
\end{array}<br />
ä»è¡¨æ ¼è¿˜å¯ä»¥çœ‹åˆ°ï¼Œå¢å¤§åºåˆ—é•¿åº¦ï¼Œé¢„è®­ç»ƒçš„å‡†ç¡®ç‡åè€Œæœ‰æ‰€æå‡ï¼Œè¿™ä¾§é¢ä½“ç°äº†RoFormeré•¿æ–‡æœ¬è¯­ä¹‰çš„å¤„ç†æ•ˆæœï¼Œä¹Ÿä½“ç°äº†RoPEå…·æœ‰è‰¯å¥½çš„å¤–æ¨èƒ½åŠ›ã€‚åœ¨çŸ­æ–‡æœ¬ä»»åŠ¡ä¸Šï¼ŒRoFormerä¸WoBERTçš„è¡¨ç°ç±»ä¼¼ï¼ŒRoFormerçš„ä¸»è¦ç‰¹ç‚¹æ˜¯å¯ä»¥ç›´æ¥å¤„ç†ä»»æ„é•¿çš„æ–‡æœ¬ã€‚ä¸‹é¢æ˜¯æˆ‘ä»¬åœ¨<a href="https://papers.cool/arxiv/1911.08962">CAIL2019-SCM</a>ä»»åŠ¡ä¸Šçš„å®éªŒç»“æœï¼š<br />
\begin{array}{c|cc}<br />
\hline<br />
&amp; \text{éªŒè¯é›†} &amp; \text{æµ‹è¯•é›†} \\\<br />
\hline<br />
\text{BERT-512} &amp; 64.13\% &amp; 67.77\% \\\<br />
\text{WoBERT-512} &amp; 64.07\% &amp; 68.10\% \\\<br />
\text{RoFormer-512} &amp; 64.13\% &amp; 68.29\% \\\<br />
\text{RoFormer-1024} &amp; \textbf{66.07%} &amp; \textbf{69.79%} \\\<br />
\hline<br />
\end{array}<br />
å…¶ä¸­$\text{-}$åé¢çš„å‚æ•°æ˜¯å¾®è°ƒæ—¶æˆªæ–­çš„maxlenï¼Œå¯ä»¥çœ‹åˆ°RoFormerç¡®å®èƒ½è¾ƒå¥½åœ°å¤„ç†é•¿æ–‡æœ¬è¯­ä¹‰ï¼Œè‡³äºè®¾å¤‡è¦æ±‚ï¼Œåœ¨24Gæ˜¾å­˜çš„å¡ä¸Šè·‘maxlen=1024ï¼Œbatch_sizeå¯ä»¥è·‘åˆ°8ä»¥ä¸Šã€‚ç›®å‰ä¸­æ–‡ä»»åŠ¡ä¸­ç¬”è€…ä¹Ÿå°±æ‰¾åˆ°è¿™ä¸ªä»»åŠ¡æ¯”è¾ƒé€‚åˆä½œä¸ºé•¿æ–‡æœ¬èƒ½åŠ›çš„æµ‹è¯•ï¼Œæ‰€ä»¥é•¿æ–‡æœ¬æ–¹é¢åªæµ‹äº†è¿™ä¸ªä»»åŠ¡ï¼Œæ¬¢è¿è¯»è€…è¿›è¡Œæµ‹è¯•æˆ–æ¨èå…¶ä»–è¯„æµ‹ä»»åŠ¡ã€‚</p>
<p>å½“ç„¶ï¼Œå°½ç®¡ç†è®ºä¸ŠRoFormerèƒ½å¤„ç†ä»»æ„é•¿åº¦çš„åºåˆ—ï¼Œä½†ç›®å‰RoFormerè¿˜æ˜¯å…·æœ‰å¹³æ–¹å¤æ‚åº¦çš„ï¼Œæˆ‘ä»¬ä¹Ÿæ­£åœ¨è®­ç»ƒåŸºäºçº¿æ€§Attentionçš„RoFormeræ¨¡å‹ï¼Œå®éªŒå®Œæˆåä¹Ÿä¼šå¼€æºæ”¾å‡ºï¼Œè¯·å¤§å®¶æœŸå¾…ã€‚</p>
<p>ï¼ˆæ³¨ï¼šRoPEå’ŒRoFormerå·²ç»æ•´ç†æˆæ–‡<a href="https://papers.cool/arxiv/2104.09864">ã€ŠRoFormer: Enhanced Transformer with Rotary Position Embeddingã€‹</a>æäº¤åˆ°äº†Arxivï¼Œæ¬¢è¿ä½¿ç”¨å’Œå¼•ç”¨å“ˆå“ˆï½ï¼‰</p>
<h2 id="_7">æ–‡ç« å°ç»“</h2>
<p>æœ¬æ–‡ä»‹ç»äº†æˆ‘ä»¬è‡ªç ”çš„æ—‹è½¬å¼ä½ç½®ç¼–ç RoPEä»¥åŠå¯¹åº”çš„é¢„è®­ç»ƒæ¨¡å‹RoFormerã€‚ä»ç†è®ºä¸Šæ¥çœ‹ï¼ŒRoPEä¸Sinusoidalä½ç½®ç¼–ç æœ‰äº›ç›¸é€šä¹‹å¤„ï¼Œä½†RoPEä¸ä¾èµ–äºæ³°å‹’å±•å¼€ï¼Œæ›´å…·ä¸¥è°¨æ€§ä¸å¯è§£é‡Šæ€§ï¼›ä»é¢„è®­ç»ƒæ¨¡å‹RoFormerçš„ç»“æœæ¥çœ‹ï¼ŒRoPEå…·æœ‰è‰¯å¥½çš„å¤–æ¨æ€§ï¼Œåº”ç”¨åˆ°Transformerä¸­ä½“ç°å‡ºè¾ƒå¥½çš„å¤„ç†é•¿æ–‡æœ¬çš„èƒ½åŠ›ã€‚æ­¤å¤–ï¼ŒRoPEè¿˜æ˜¯ç›®å‰å”¯ä¸€ä¸€ç§å¯ç”¨äºçº¿æ€§Attentionçš„ç›¸å¯¹ä½ç½®ç¼–ç ã€‚</p>
<p><em><strong>è½¬è½½åˆ°è¯·åŒ…æ‹¬æœ¬æ–‡åœ°å€ï¼š</strong><a href="https://spaces.ac.cn/archives/8265">https://spaces.ac.cn/archives/8265</a></em></p>
<p><em><strong>æ›´è¯¦ç»†çš„è½¬è½½äº‹å®œè¯·å‚è€ƒï¼š</strong></em><a href="https://spaces.ac.cn/archives/6508#%E6%96%87%E7%AB%A0%E5%A6%82%E4%BD%95%E8%BD%AC%E8%BD%BD/%E5%BC%95%E7%94%A8" title="ã€Šç§‘å­¦ç©ºé—´FAQã€‹">ã€Šç§‘å­¦ç©ºé—´FAQã€‹</a></p>
<p><strong>å¦‚æœæ‚¨è¿˜æœ‰ä»€ä¹ˆç–‘æƒ‘æˆ–å»ºè®®ï¼Œæ¬¢è¿åœ¨ä¸‹æ–¹è¯„è®ºåŒºç»§ç»­è®¨è®ºã€‚</strong></p>
<p><strong>å¦‚æœæ‚¨è§‰å¾—æœ¬æ–‡è¿˜ä¸é”™ï¼Œæ¬¢è¿åˆ†äº«/æ‰“èµæœ¬æ–‡ã€‚æ‰“èµå¹¶éè¦ä»ä¸­è·å¾—æ”¶ç›Šï¼Œè€Œæ˜¯å¸Œæœ›çŸ¥é“ç§‘å­¦ç©ºé—´è·å¾—äº†å¤šå°‘è¯»è€…çš„çœŸå¿ƒå…³æ³¨ã€‚å½“ç„¶ï¼Œå¦‚æœä½ æ— è§†å®ƒï¼Œä¹Ÿä¸ä¼šå½±å“ä½ çš„é˜…è¯»ã€‚å†æ¬¡è¡¨ç¤ºæ¬¢è¿å’Œæ„Ÿè°¢ï¼</strong></p>
<p>æ‰“èµ</p>
<p><img alt="ç§‘å­¦ç©ºé—´" src="https://spaces.ac.cn/usr/themes/geekg/payment/wx.png" /></p>
<p>å¾®ä¿¡æ‰“èµ</p>
<p><img alt="ç§‘å­¦ç©ºé—´" src="https://spaces.ac.cn/usr/themes/geekg/payment/zfb.png" /></p>
<p>æ”¯ä»˜å®æ‰“èµ</p>
<p>å› ä¸ºç½‘ç«™åå°å¯¹æ‰“èµå¹¶æ— è®°å½•ï¼Œå› æ­¤æ¬¢è¿åœ¨æ‰“èµæ—¶å€™å¤‡æ³¨ç•™è¨€ã€‚ä½ è¿˜å¯ä»¥<a href="http://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&amp;email=tN7d1drY3drrx8H0xcWa19vZ"><strong>ç‚¹å‡»è¿™é‡Œ</strong></a>æˆ–åœ¨ä¸‹æ–¹è¯„è®ºåŒºç•™è¨€æ¥å‘ŠçŸ¥ä½ çš„å»ºè®®æˆ–éœ€æ±‚ã€‚</p>
<p><strong>å¦‚æœæ‚¨éœ€è¦å¼•ç”¨æœ¬æ–‡ï¼Œè¯·å‚è€ƒï¼š</strong></p>
<p>è‹å‰‘æ—. (Mar. 23, 2021). ã€ŠTransformerå‡çº§ä¹‹è·¯ï¼š2ã€åšé‡‡ä¼—é•¿çš„æ—‹è½¬å¼ä½ç½®ç¼–ç  ã€‹[Blog post]. Retrieved from <a href="https://spaces.ac.cn/archives/8265">https://spaces.ac.cn/archives/8265</a></p>
<p>@online{kexuefm-8265,<br />
title={Transformerå‡çº§ä¹‹è·¯ï¼š2ã€åšé‡‡ä¼—é•¿çš„æ—‹è½¬å¼ä½ç½®ç¼–ç },<br />
author={è‹å‰‘æ—},<br />
year={2021},<br />
month={Mar},<br />
url={\url{https://spaces.ac.cn/archives/8265}},<br />
} </p>
<hr />
<h2 id="1">ğŸ“ ç¬¬1éƒ¨åˆ†ï¼šç†è®ºåŸºç¡€ä¸å†å²å‘å±•</h2>
<h3 id="11">1.1 ä½ç½®ç¼–ç çš„æ¼”åŒ–å²</h3>
<p>Transformeræ¨¡å‹è‡ª2017å¹´è¯ç”Ÿä»¥æ¥ï¼Œä½ç½®ç¼–ç ä¸€ç›´æ˜¯å…¶æ ¸å¿ƒç»„æˆéƒ¨åˆ†ä¹‹ä¸€ã€‚è®©æˆ‘ä»¬å›é¡¾ä½ç½®ç¼–ç çš„æ¼”åŒ–å†ç¨‹ï¼š</p>
<p><strong>ç¬¬ä¸€ä»£ï¼šç»å¯¹ä½ç½®ç¼–ç </strong>
- <strong>Learned Positional Embedding</strong>ï¼ˆTransformeråŸè®ºæ–‡ï¼‰ï¼šä¸ºæ¯ä¸ªä½ç½®å­¦ä¹ ä¸€ä¸ªç‹¬ç«‹çš„å‘é‡
  - ä¼˜ç‚¹ï¼šçµæ´»ï¼Œæ¨¡å‹å¯ä»¥è‡ªç”±å­¦ä¹ ä½ç½®è¡¨ç¤º
  - ç¼ºç‚¹ï¼šæ— æ³•å¤„ç†è¶…å‡ºè®­ç»ƒé•¿åº¦çš„åºåˆ—ï¼Œå‚æ•°é‡å¤§ï¼ˆ$O(L \times d)$ï¼Œ$L$ä¸ºæœ€å¤§åºåˆ—é•¿åº¦ï¼‰
- <strong>Sinusoidal Positional Encoding</strong>ï¼ˆä¹Ÿåœ¨TransformeråŸè®ºæ–‡ä¸­æå‡ºï¼‰ï¼šä½¿ç”¨æ­£å¼¦ä½™å¼¦å‡½æ•°ç¼–ç ä½ç½®
  - ä¼˜ç‚¹ï¼šå‚æ•°é‡ä¸º0ï¼Œç†è®ºä¸Šå¯ä»¥å¤–æ¨åˆ°ä»»æ„é•¿åº¦
  - ç¼ºç‚¹ï¼šä»…æ˜¯"æƒ³è¦æˆä¸ºç›¸å¯¹ä½ç½®ç¼–ç "ï¼Œå®é™…ä¸Šå¹¶æœªæ˜¾å¼å»ºæ¨¡ç›¸å¯¹ä½ç½®</p>
<p><strong>ç¬¬äºŒä»£ï¼šæ˜¾å¼ç›¸å¯¹ä½ç½®ç¼–ç </strong>
- <strong>T5 Relative PE</strong>ï¼ˆRaffel et al., 2019ï¼‰ï¼šç›´æ¥åœ¨AttentionçŸ©é˜µä¸­åŠ å…¥ç›¸å¯¹ä½ç½®åç½®
  - å½¢å¼ï¼š$\text{Attention}(Q, K, V) = \text{softmax}\left(\frac{QK^T}{\sqrt{d_k}} + B\right)V$
  - å…¶ä¸­$B_{ij}$åªä¾èµ–äº$i-j$ï¼ˆç›¸å¯¹ä½ç½®ï¼‰
  - ä¼˜ç‚¹ï¼šç›´æ¥å»ºæ¨¡ç›¸å¯¹ä½ç½®ï¼Œæ€§èƒ½ä¼˜ç§€
  - ç¼ºç‚¹ï¼šéœ€è¦å­˜å‚¨$O(L)$ä¸ªç›¸å¯¹ä½ç½®åç½®ï¼Œæ— æ³•ç”¨äºçº¿æ€§Attention
- <strong>ALiBi</strong>ï¼ˆPress et al., 2021ï¼‰ï¼šçº¿æ€§è¡°å‡çš„ç›¸å¯¹ä½ç½®åç½®
  - å½¢å¼ï¼š$\text{score}(q_i, k_j) = q_i^T k_j - \lambda \cdot |i - j|$
  - ä¼˜ç‚¹ï¼šæç®€ï¼Œå¤–æ¨æ€§å¥½
  - ç¼ºç‚¹ï¼šä»éœ€æ“ä½œAttentionçŸ©é˜µï¼Œæ— æ³•ç”¨äºçº¿æ€§Attention</p>
<p><strong>ç¬¬ä¸‰ä»£ï¼šRoPEï¼ˆæœ¬æ–‡æ–¹æ³•ï¼‰</strong>
- <strong>æ ¸å¿ƒæ€æƒ³</strong>ï¼šé€šè¿‡ç»å¯¹ä½ç½®ç¼–ç çš„<strong>æ–¹å¼</strong>å®ç°ç›¸å¯¹ä½ç½®ç¼–ç çš„<strong>æ•ˆæœ</strong>
- <strong>å…³é”®åˆ›æ–°</strong>ï¼šç¼–ç ä½œç”¨äº$Q, K$å‘é‡æœ¬èº«ï¼Œè€ŒéAttentionçŸ©é˜µ
- <strong>ç‹¬ç‰¹ä¼˜åŠ¿</strong>ï¼š
  1. ç†è®ºä¸¥è°¨ï¼šæ— éœ€æ³°å‹’å±•å¼€ç­‰è¿‘ä¼¼å‡è®¾
  2. å¤–æ¨æ€§å¼ºï¼šè‡ªç„¶æ”¯æŒä»»æ„é•¿åº¦åºåˆ—
  3. çº¿æ€§å…¼å®¹ï¼šå”¯ä¸€å¯ç”¨äºçº¿æ€§Attentionçš„ç›¸å¯¹ä½ç½®ç¼–ç 
  4. è®¡ç®—é«˜æ•ˆï¼šä¸æ”¹å˜Attentionçš„è®¡ç®—å¤æ‚åº¦</p>
<h3 id="12-rope">1.2 RoPEçš„è®¾è®¡å“²å­¦</h3>
<p>RoPEçš„æ ¸å¿ƒæ€æƒ³å¯ä»¥ç”¨ä¸€å¥è¯æ¦‚æ‹¬ï¼š<strong>ä»¥ç»å¯¹ä¹‹å½¢ï¼Œè¾¾ç›¸å¯¹ä¹‹å®</strong>ã€‚</p>
<p><strong>è®¾è®¡åŸåˆ™1ï¼šç›¸å¯¹ä½ç½®çš„æ¶Œç°æ€§</strong></p>
<p>æˆ‘ä»¬å¸Œæœ›Attentionå†…ç§¯è‡ªåŠ¨åŒ…å«ç›¸å¯¹ä½ç½®ä¿¡æ¯ï¼š
\begin{equation}
\langle \tilde{\boldsymbol{q}}_m, \tilde{\boldsymbol{k}}_n \rangle = g(\boldsymbol{q}, \boldsymbol{k}, m-n)
\end{equation}</p>
<p>è¿™é‡Œ$\tilde{\boldsymbol{q}}_m, \tilde{\boldsymbol{k}}_n$æ˜¯æ·»åŠ äº†ä½ç½®$m, n$ä¿¡æ¯çš„æŸ¥è¯¢å’Œé”®å‘é‡ã€‚æ³¨æ„å³ä¾§<strong>åªä¾èµ–äºç›¸å¯¹ä½ç½®$m-n$</strong>ï¼Œè€Œéç»å¯¹ä½ç½®$m, n$ã€‚</p>
<p><strong>ä¸ºä»€ä¹ˆè¿™ä¸ªè®¾è®¡æ˜¯ä¼˜é›…çš„ï¼Ÿ</strong></p>
<ol>
<li><strong>æ“ä½œåœ¨å‘é‡å±‚é¢</strong>ï¼šä½ç½®ç¼–ç é€šè¿‡å˜æ¢$\boldsymbol{q}, \boldsymbol{k}$å®ç°ï¼Œæ— éœ€ä¿®æ”¹AttentionçŸ©é˜µ</li>
<li><strong>ç›¸å¯¹ä½ç½®è‡ªåŠ¨æ¶Œç°</strong>ï¼šå†…ç§¯ç»“æœå¤©ç„¶åªä¾èµ–$m-n$ï¼Œæ— éœ€äººå·¥è®¾è®¡ç›¸å¯¹ä½ç½®è®¡ç®—</li>
<li><strong>ä¿æŒçº¿æ€§æ€§</strong>ï¼šå†…ç§¯çš„çº¿æ€§æ€§å¾—ä»¥ä¿ç•™ï¼Œå¯ä»¥åº”ç”¨äºçº¿æ€§Attention</li>
</ol>
<p><strong>è®¾è®¡åŸåˆ™2ï¼šæ­£äº¤æ€§ä¿æŒ</strong></p>
<p>ä½ç½®ç¼–ç å˜æ¢åº”è¯¥æ˜¯æ­£äº¤çš„ï¼Œå³ï¼š
\begin{equation}
|\tilde{\boldsymbol{q}}_m| = |\boldsymbol{q}|, \quad |\tilde{\boldsymbol{k}}_n| = |\boldsymbol{k}|
\end{equation}</p>
<p><strong>ä¸ºä»€ä¹ˆæ­£äº¤æ€§é‡è¦ï¼Ÿ</strong></p>
<ol>
<li><strong>ç¨³å®šæ€§</strong>ï¼šä¸æ”¹å˜å‘é‡çš„æ¨¡é•¿ï¼Œä¿æŒæ¨¡å‹è®­ç»ƒçš„ç¨³å®šæ€§</li>
<li><strong>ä¿¡æ¯ä¿ç•™</strong>ï¼šä½ç½®ç¼–ç æ˜¯ä¿¡æ¯çš„é‡æ–°ç»„ç»‡ï¼Œè€Œéå‹ç¼©æˆ–æ”¾å¤§</li>
<li><strong>æ¢¯åº¦æµåŠ¨</strong>ï¼šæ­£äº¤å˜æ¢çš„é›…å¯æ¯”çŸ©é˜µè¡Œåˆ—å¼ä¸º1ï¼Œæ¢¯åº¦ä¼ æ’­æ›´ç¨³å®š</li>
</ol>
<p><strong>è®¾è®¡åŸåˆ™3ï¼šè¿œç¨‹è¡°å‡æ€§</strong></p>
<p>éšç€ç›¸å¯¹è·ç¦»$|m-n|$å¢å¤§ï¼Œå†…ç§¯ç»“æœåº”è¯¥è¶‹å‘äºè¡°å‡ï¼š
\begin{equation}
|\langle \tilde{\boldsymbol{q}}_m, \tilde{\boldsymbol{k}}_n \rangle| \xrightarrow{|m-n| \to \infty} \text{è¾ƒå°å€¼}
\end{equation}</p>
<p><strong>ä¸ºä»€ä¹ˆéœ€è¦è¿œç¨‹è¡°å‡ï¼Ÿ</strong></p>
<ol>
<li><strong>å±€éƒ¨æ€§å…ˆéªŒ</strong>ï¼šè‡ªç„¶è¯­è¨€å…·æœ‰å±€éƒ¨æ€§ï¼Œè·ç¦»è¿œçš„è¯è¯­ç›¸å…³æ€§é€šå¸¸è¾ƒå¼±</li>
<li><strong>æ³¨æ„åŠ›èšç„¦</strong>ï¼šå¸®åŠ©æ¨¡å‹å°†æ³¨æ„åŠ›é›†ä¸­åœ¨ç›¸å…³çš„å±€éƒ¨åŒºåŸŸ</li>
<li><strong>é•¿åºåˆ—ç¨³å®šæ€§</strong>ï¼šé¿å…é•¿è·ç¦»ä¾èµ–çš„æ¢¯åº¦çˆ†ç‚¸</li>
</ol>
<h3 id="13-sinusoidalrope">1.3 ä»Sinusoidalåˆ°RoPEçš„è·¨è¶Š</h3>
<p>Sinusoidalä½ç½®ç¼–ç çš„æ ¸å¿ƒå…¬å¼ï¼š
\begin{equation}
PE_{(pos, 2i)} = \sin(pos / 10000^{2i/d}), \quad PE_{(pos, 2i+1)} = \cos(pos / 10000^{2i/d})
\end{equation}</p>
<p>ç„¶å<strong>åŠ åˆ°</strong>è¾“å…¥å‘é‡ä¸Šï¼š$\boldsymbol{x}<em pos="pos">{pos} \leftarrow \boldsymbol{x}</em>$ã€‚} + PE_{pos</p>
<p><strong>Sinusoidalçš„ä¸è¶³</strong>ï¼š
1. <strong>è¿‘ä¼¼æ€§</strong>ï¼šå£°ç§°é€šè¿‡æ³°å‹’å±•å¼€å¯ä»¥è¡¨è¾¾ç›¸å¯¹ä½ç½®ï¼Œä½†ä»…åœ¨$|\boldsymbol{q}|, |\boldsymbol{k}| \ll 1$æ—¶æˆç«‹
2. <strong>åŠ æ€§ç»“æ„</strong>ï¼š$PE$ä¸å†…å®¹å‘é‡ç›´æ¥ç›¸åŠ ï¼Œç ´åäº†åŸå§‹è¯­ä¹‰ç©ºé—´
3. <strong>å¤–æ¨æ€§æœ‰é™</strong>ï¼šå®è·µä¸­è¶…å‡ºè®­ç»ƒé•¿åº¦åæ€§èƒ½ä¸‹é™æ˜æ˜¾</p>
<p><strong>RoPEçš„æ”¹è¿›</strong>ï¼š
1. <strong>ä¸¥è°¨æ€§</strong>ï¼šé€šè¿‡æ—‹è½¬å˜æ¢ç²¾ç¡®å®ç°ç›¸å¯¹ä½ç½®ï¼Œæ— éœ€è¿‘ä¼¼
2. <strong>ä¹˜æ€§ç»“æ„</strong>ï¼šæ—‹è½¬çŸ©é˜µ$\boldsymbol{\mathcal{R}}_m$ä½œç”¨äºå‘é‡ï¼Œä¿æŒè¯­ä¹‰ç©ºé—´çš„å‡ ä½•ç»“æ„
3. <strong>å¤–æ¨æ€§å¼º</strong>ï¼šç†è®ºä¸Šæ”¯æŒä»»æ„é•¿åº¦ï¼Œå®è·µéªŒè¯å¤–æ¨æ€§èƒ½ä¼˜å¼‚</p>
<h3 id="14">1.4 æ ¸å¿ƒæ•°å­¦æ¡†æ¶</h3>
<p>RoPEçš„æ•°å­¦æ¡†æ¶å»ºç«‹åœ¨ä»¥ä¸‹å…¬ç†åŸºç¡€ä¸Šï¼š</p>
<p><strong>å…¬ç†1ï¼ˆä½ç½®ç¼–ç çš„å‡½æ•°å½¢å¼ï¼‰</strong>ï¼šå­˜åœ¨å‡½æ•°$\boldsymbol{f}$ï¼Œä½¿å¾—
\begin{equation}
\tilde{\boldsymbol{q}}_m = \boldsymbol{f}(\boldsymbol{q}, m), \quad \tilde{\boldsymbol{k}}_n = \boldsymbol{f}(\boldsymbol{k}, n)
\end{equation}</p>
<p><strong>å…¬ç†2ï¼ˆç›¸å¯¹ä½ç½®çº¦æŸï¼‰</strong>ï¼šå†…ç§¯ç»“æœä»…ä¾èµ–ç›¸å¯¹ä½ç½®
\begin{equation}
\langle \boldsymbol{f}(\boldsymbol{q}, m), \boldsymbol{f}(\boldsymbol{k}, n) \rangle = g(\boldsymbol{q}, \boldsymbol{k}, m-n)
\end{equation}</p>
<p><strong>å…¬ç†3ï¼ˆåˆå§‹æ¡ä»¶ï¼‰</strong>ï¼šä½ç½®0å¯¹åº”æ’ç­‰å˜æ¢
\begin{equation}
\boldsymbol{f}(\boldsymbol{q}, 0) = \boldsymbol{q}, \quad \boldsymbol{f}(\boldsymbol{k}, 0) = \boldsymbol{k}
\end{equation}</p>
<p>ä»è¿™ä¸‰ä¸ªå…¬ç†å‡ºå‘ï¼Œæˆ‘ä»¬å°†åœ¨ç¬¬2éƒ¨åˆ†æ¨å¯¼å‡ºRoPEçš„å”¯ä¸€å½¢å¼ã€‚</p>
<h3 id="15-rope">1.5 RoPEä¸å…¶ä»–æ–¹æ³•çš„æœ¬è´¨åŒºåˆ«</h3>
<table>
<thead>
<tr>
<th>æ–¹æ³•</th>
<th>ç¼–ç ä½ç½®</th>
<th>ç›¸å¯¹ä½ç½®</th>
<th>çº¿æ€§Attention</th>
<th>å¤–æ¨æ€§</th>
</tr>
</thead>
<tbody>
<tr>
<td>Learned PE</td>
<td>è¾“å…¥å±‚åŠ æ€§</td>
<td>âœ—</td>
<td>âœ“</td>
<td>âœ—</td>
</tr>
<tr>
<td>Sinusoidal PE</td>
<td>è¾“å…¥å±‚åŠ æ€§</td>
<td>è¿‘ä¼¼</td>
<td>âœ“</td>
<td>ä¸­ç­‰</td>
</tr>
<tr>
<td>T5 RPE</td>
<td>AttentionçŸ©é˜µ</td>
<td>âœ“</td>
<td>âœ—</td>
<td>ä¸­ç­‰</td>
</tr>
<tr>
<td>ALiBi</td>
<td>AttentionçŸ©é˜µ</td>
<td>âœ“</td>
<td>âœ—</td>
<td>âœ“</td>
</tr>
<tr>
<td><strong>RoPE</strong></td>
<td><strong>Q/Kä¹˜æ€§</strong></td>
<td><strong>âœ“</strong></td>
<td><strong>âœ“</strong></td>
<td><strong>âœ“</strong></td>
</tr>
</tbody>
</table>
<p><strong>å…³é”®æ´å¯Ÿ</strong>ï¼š
- ä¼ ç»Ÿç›¸å¯¹ä½ç½®ç¼–ç ï¼ˆT5, ALiBiï¼‰æ“ä½œAttentionçŸ©é˜µï¼Œæ— æ³•ç”¨äºçº¿æ€§Attention
- RoPEæ“ä½œ$Q, K$å‘é‡ï¼Œä¿æŒäº†å†…ç§¯ç»“æ„ï¼Œå¤©ç„¶å…¼å®¹çº¿æ€§Attention
- è¿™æ˜¯RoPEç›¸æ¯”å…¶ä»–æ–¹æ³•çš„<strong>æ ¹æœ¬ä¼˜åŠ¿</strong></p>
<hr />
<h2 id="2">ğŸ”¬ ç¬¬2éƒ¨åˆ†ï¼šæ•°å­¦æ¨å¯¼ä¸ä¸¥æ ¼è¯æ˜</h2>
<h3 id="21">2.1 äºŒç»´æƒ…å†µä¸‹çš„å®Œæ•´æ¨å¯¼</h3>
<p>æˆ‘ä»¬å…ˆè€ƒè™‘æœ€ç®€å•çš„äºŒç»´æƒ…å†µï¼ˆ$d=2$ï¼‰ï¼Œåˆ©ç”¨å¤æ•°æ–¹æ³•æ±‚è§£ã€‚</p>
<h4 id="211">2.1.1 å¤æ•°è¡¨ç¤º</h4>
<p>åœ¨äºŒç»´ç©ºé—´ä¸­ï¼Œå‘é‡$\boldsymbol{q} = (q_0, q_1)^T$å¯ä»¥è¡¨ç¤ºä¸ºå¤æ•°ï¼š
\begin{equation}
\boldsymbol{q} \leftrightarrow q_0 + \mathrm{i} q_1
\end{equation}</p>
<p>å†…ç§¯å¯ä»¥ç”¨å¤æ•°ä¹˜æ³•è¡¨ç¤ºï¼š
\begin{equation}
\langle \boldsymbol{q}, \boldsymbol{k} \rangle = q_0 k_0 + q_1 k_1 = \text{Re}[\boldsymbol{q} \cdot \boldsymbol{k}^<em>]
\end{equation}
å…¶ä¸­$\boldsymbol{k}^</em> = k_0 - \mathrm{i} k_1$æ˜¯å¤å…±è½­ï¼Œ$\text{Re}[\cdot]$å–å®éƒ¨ã€‚</p>
<h4 id="212">2.1.2 å…¬ç†è½¬åŒ–ä¸ºå¤æ•°æ–¹ç¨‹</h4>
<p>å°†å…¬ç†2ç”¨å¤æ•°å½¢å¼æ”¹å†™ï¼š
\begin{equation}
\text{Re}[\boldsymbol{f}(\boldsymbol{q}, m) \cdot \boldsymbol{f}^*(\boldsymbol{k}, n)] = g(\boldsymbol{q}, \boldsymbol{k}, m-n)
\end{equation}</p>
<p>ç®€åŒ–å‡è®¾ï¼šå­˜åœ¨å¤å‡½æ•°$\boldsymbol{g}$ï¼Œä½¿å¾—
\begin{equation}
\boldsymbol{f}(\boldsymbol{q}, m) \cdot \boldsymbol{f}^*(\boldsymbol{k}, n) = \boldsymbol{g}(\boldsymbol{q}, \boldsymbol{k}, m-n)
\end{equation}
åˆ™$g = \text{Re}[\boldsymbol{g}]$ã€‚</p>
<h4 id="213">2.1.3 æåæ ‡åˆ†è§£</h4>
<p>ç”¨å¤æ•°çš„æåæ ‡å½¢å¼ï¼ˆæ¬§æ‹‰å…¬å¼ï¼‰ï¼š
\begin{equation}
z = r e^{\mathrm{i}\theta} = r(\cos\theta + \mathrm{i}\sin\theta)
\end{equation}</p>
<p>è®¾ï¼š
\begin{align}
\boldsymbol{f}(\boldsymbol{q}, m) &amp;= R_f(\boldsymbol{q}, m) e^{\mathrm{i}\Theta_f(\boldsymbol{q}, m)} \
\boldsymbol{f}(\boldsymbol{k}, n) &amp;= R_f(\boldsymbol{k}, n) e^{\mathrm{i}\Theta_f(\boldsymbol{k}, n)} \
\boldsymbol{g}(\boldsymbol{q}, \boldsymbol{k}, m-n) &amp;= R_g(\boldsymbol{q}, \boldsymbol{k}, m-n) e^{\mathrm{i}\Theta_g(\boldsymbol{q}, \boldsymbol{k}, m-n)}
\end{align}</p>
<p>è¿™é‡Œ$R$æ˜¯æ¨¡ï¼ˆéè´Ÿå®æ•°ï¼‰ï¼Œ$\Theta$æ˜¯å¹…è§’ï¼ˆå®æ•°ï¼‰ã€‚</p>
<h4 id="214">2.1.4 åˆ†ç¦»æ¨¡å’Œå¹…è§’</h4>
<p>ä»£å…¥ä¸»æ–¹ç¨‹ï¼š
\begin{equation}
R_f(\boldsymbol{q}, m) e^{\mathrm{i}\Theta_f(\boldsymbol{q}, m)} \cdot R_f(\boldsymbol{k}, n) e^{-\mathrm{i}\Theta_f(\boldsymbol{k}, n)} = R_g(\boldsymbol{q}, \boldsymbol{k}, m-n) e^{\mathrm{i}\Theta_g(\boldsymbol{q}, \boldsymbol{k}, m-n)}
\end{equation}</p>
<p>åˆ©ç”¨$e^{\mathrm{i}a} \cdot e^{\mathrm{i}b} = e^{\mathrm{i}(a+b)}$ï¼Œå¾—åˆ°ï¼š
\begin{equation}
R_f(\boldsymbol{q}, m) R_f(\boldsymbol{k}, n) e^{\mathrm{i}[\Theta_f(\boldsymbol{q}, m) - \Theta_f(\boldsymbol{k}, n)]} = R_g(\boldsymbol{q}, \boldsymbol{k}, m-n) e^{\mathrm{i}\Theta_g(\boldsymbol{q}, \boldsymbol{k}, m-n)}
\end{equation}</p>
<p>å¤æ•°ç›¸ç­‰å½“ä¸”ä»…å½“æ¨¡å’Œå¹…è§’åˆ†åˆ«ç›¸ç­‰ï¼š
\begin{align}
R_f(\boldsymbol{q}, m) R_f(\boldsymbol{k}, n) &amp;= R_g(\boldsymbol{q}, \boldsymbol{k}, m-n) \tag{æ¨¡æ–¹ç¨‹} \
\Theta_f(\boldsymbol{q}, m) - \Theta_f(\boldsymbol{k}, n) &amp;= \Theta_g(\boldsymbol{q}, \boldsymbol{k}, m-n) \tag{å¹…è§’æ–¹ç¨‹}
\end{align}</p>
<h4 id="215">2.1.5 æ±‚è§£æ¨¡æ–¹ç¨‹</h4>
<p>åœ¨æ¨¡æ–¹ç¨‹ä¸­ä»¤$m = n$ï¼š
\begin{equation}
R_f(\boldsymbol{q}, m) R_f(\boldsymbol{k}, m) = R_g(\boldsymbol{q}, \boldsymbol{k}, 0)
\end{equation}</p>
<p>åˆ©ç”¨åˆå§‹æ¡ä»¶$\boldsymbol{f}(\boldsymbol{q}, 0) = \boldsymbol{q}$ï¼Œæœ‰ï¼š
\begin{equation}
R_f(\boldsymbol{q}, 0) = |\boldsymbol{q}| = |\boldsymbol{q}|, \quad R_f(\boldsymbol{k}, 0) = |\boldsymbol{k}|
\end{equation}</p>
<p>æ‰€ä»¥ï¼š
\begin{equation}
R_g(\boldsymbol{q}, \boldsymbol{k}, 0) = R_f(\boldsymbol{q}, 0) R_f(\boldsymbol{k}, 0) = |\boldsymbol{q}| |\boldsymbol{k}|
\end{equation}</p>
<p>ç°åœ¨è€ƒè™‘ä¸€èˆ¬çš„$m$ã€‚ä¸€ä¸ªç®€å•çš„è§£æ˜¯ï¼š
\begin{equation}
R_f(\boldsymbol{q}, m) = |\boldsymbol{q}|, \quad R_f(\boldsymbol{k}, m) = |\boldsymbol{k}|
\end{equation}
å³<strong>æ¨¡ä¸ä½ç½®$m$æ— å…³</strong>ã€‚éªŒè¯ï¼š
\begin{equation}
R_f(\boldsymbol{q}, m) R_f(\boldsymbol{k}, n) = |\boldsymbol{q}| |\boldsymbol{k}| = R_g(\boldsymbol{q}, \boldsymbol{k}, 0) = R_g(\boldsymbol{q}, \boldsymbol{k}, m-n)
\end{equation}
æœ€åä¸€æ­¥åˆ©ç”¨äº†$R_g$åªä¾èµ–$m-n$ã€‚å½“$m = n$æ—¶æˆç«‹ï¼Œæ¨å¹¿åˆ°ä¸€èˆ¬æƒ…å†µéœ€è¦$R_g$ç¡®å®åªä¾èµ–$m-n$ï¼ˆè¿™æ˜¯æˆ‘ä»¬çš„å‡è®¾ï¼‰ã€‚</p>
<p><strong>å‡ ä½•æ„ä¹‰</strong>ï¼šä½ç½®ç¼–ç åªæ”¹å˜å‘é‡çš„<strong>æ–¹å‘</strong>ï¼ˆç›¸ä½ï¼‰ï¼Œä¸æ”¹å˜<strong>é•¿åº¦</strong>ï¼ˆæ¨¡ï¼‰ã€‚è¿™æ­£æ˜¯æ—‹è½¬å˜æ¢çš„ç‰¹å¾ï¼</p>
<h4 id="216">2.1.6 æ±‚è§£å¹…è§’æ–¹ç¨‹</h4>
<p>åœ¨å¹…è§’æ–¹ç¨‹ä¸­ä»¤$m = n$ï¼š
\begin{equation}
\Theta_f(\boldsymbol{q}, m) - \Theta_f(\boldsymbol{k}, m) = \Theta_g(\boldsymbol{q}, \boldsymbol{k}, 0)
\end{equation}</p>
<p>åˆ©ç”¨åˆå§‹æ¡ä»¶ï¼š
\begin{equation}
\boldsymbol{f}(\boldsymbol{q}, 0) = \boldsymbol{q} = |\boldsymbol{q}| e^{\mathrm{i}\Theta(\boldsymbol{q})}
\end{equation}
å…¶ä¸­$\Theta(\boldsymbol{q})$æ˜¯$\boldsymbol{q}$æœ¬èº«çš„å¹…è§’ã€‚æ‰€ä»¥ï¼š
\begin{equation}
\Theta_f(\boldsymbol{q}, 0) = \Theta(\boldsymbol{q}), \quad \Theta_f(\boldsymbol{k}, 0) = \Theta(\boldsymbol{k})
\end{equation}</p>
<p>ä»è€Œï¼š
\begin{equation}
\Theta_g(\boldsymbol{q}, \boldsymbol{k}, 0) = \Theta_f(\boldsymbol{q}, 0) - \Theta_f(\boldsymbol{k}, 0) = \Theta(\boldsymbol{q}) - \Theta(\boldsymbol{k})
\end{equation}</p>
<p>å›åˆ°ä¸€èˆ¬çš„$m$ï¼Œæœ‰ï¼š
\begin{equation}
\Theta_f(\boldsymbol{q}, m) - \Theta_f(\boldsymbol{k}, m) = \Theta(\boldsymbol{q}) - \Theta(\boldsymbol{k})
\end{equation}</p>
<p>æ•´ç†å¾—ï¼š
\begin{equation}
\Theta_f(\boldsymbol{q}, m) - \Theta(\boldsymbol{q}) = \Theta_f(\boldsymbol{k}, m) - \Theta(\boldsymbol{k})
\end{equation}</p>
<p><strong>å…³é”®è§‚å¯Ÿ</strong>ï¼šå·¦è¾¹åªä¾èµ–$\boldsymbol{q}, m$ï¼Œå³è¾¹åªä¾èµ–$\boldsymbol{k}, m$ã€‚ä¸¤è€…ç›¸ç­‰æ„å‘³ç€å®ƒä»¬éƒ½ç­‰äºæŸä¸ª<strong>åªä¾èµ–$m$</strong>çš„å‡½æ•°$\varphi(m)$ï¼š
\begin{equation}
\Theta_f(\boldsymbol{q}, m) = \Theta(\boldsymbol{q}) + \varphi(m)
\end{equation}</p>
<h4 id="217-varphim">2.1.7 ç¡®å®š$\varphi(m)$çš„å½¢å¼</h4>
<p>åœ¨åŸå¹…è§’æ–¹ç¨‹ä¸­ä»£å…¥ä¸Šå¼ï¼š
\begin{equation}
[\Theta(\boldsymbol{q}) + \varphi(m)] - [\Theta(\boldsymbol{k}) + \varphi(n)] = \Theta_g(\boldsymbol{q}, \boldsymbol{k}, m-n)
\end{equation}</p>
<p>ç®€åŒ–ï¼š
\begin{equation}
\varphi(m) - \varphi(n) = \Theta_g(\boldsymbol{q}, \boldsymbol{k}, m-n) - [\Theta(\boldsymbol{q}) - \Theta(\boldsymbol{k})]
\end{equation}</p>
<p>ä»¤$n = m - 1$ï¼ˆç›¸é‚»ä½ç½®ï¼‰ï¼š
\begin{equation}
\varphi(m) - \varphi(m-1) = \Theta_g(\boldsymbol{q}, \boldsymbol{k}, 1) - [\Theta(\boldsymbol{q}) - \Theta(\boldsymbol{k})]
\end{equation}</p>
<p>å³ä¾§ä¸$m$æ— å…³ï¼è®°ä¸ºå¸¸æ•°$\theta$ï¼š
\begin{equation}
\varphi(m) - \varphi(m-1) = \theta
\end{equation}</p>
<p>è¿™æ˜¯<strong>ç­‰å·®æ•°åˆ—</strong>çš„é€’æ¨å…³ç³»ã€‚åˆ©ç”¨åˆå§‹æ¡ä»¶$\varphi(0) = 0$ï¼ˆå› ä¸º$\Theta_f(\boldsymbol{q}, 0) = \Theta(\boldsymbol{q})$ï¼‰ï¼Œè§£å¾—ï¼š
\begin{equation}
\varphi(m) = m\theta
\end{equation}</p>
<h4 id="218-rope">2.1.8 äºŒç»´RoPEçš„æœ€ç»ˆå½¢å¼</h4>
<p>ç»¼åˆæ¨¡å’Œå¹…è§’çš„ç»“æœï¼š
\begin{align}
\boldsymbol{f}(\boldsymbol{q}, m) &amp;= R_f(\boldsymbol{q}, m) e^{\mathrm{i}\Theta_f(\boldsymbol{q}, m)} \
&amp;= |\boldsymbol{q}| e^{\mathrm{i}[\Theta(\boldsymbol{q}) + m\theta]} \
&amp;= |\boldsymbol{q}| e^{\mathrm{i}\Theta(\boldsymbol{q})} \cdot e^{\mathrm{i}m\theta} \
&amp;= \boldsymbol{q} \cdot e^{\mathrm{i}m\theta}
\end{align}</p>
<p>ç”¨å¤æ•°ä¹˜æ³•çš„å‡ ä½•æ„ä¹‰ï¼Œ$e^{\mathrm{i}m\theta}$å¯¹åº”é€†æ—¶é’ˆæ—‹è½¬$m\theta$è§’åº¦ã€‚ç”¨çŸ©é˜µå½¢å¼è¡¨ç¤ºï¼š
\begin{equation}
\boldsymbol{f}(\boldsymbol{q}, m) = \begin{pmatrix} \cos m\theta &amp; -\sin m\theta \ \sin m\theta &amp; \cos m\theta \end{pmatrix} \begin{pmatrix} q_0 \ q_1 \end{pmatrix}
\end{equation}</p>
<p>è¿™å°±æ˜¯<strong>äºŒç»´æ—‹è½¬çŸ©é˜µ</strong>ï¼è®°ä¸º$\boldsymbol{\mathcal{R}}_m^{(2D)}$ã€‚</p>
<h4 id="219">2.1.9 éªŒè¯ç›¸å¯¹ä½ç½®æ€§è´¨</h4>
<p>\begin{align}
\langle \boldsymbol{f}(\boldsymbol{q}, m), \boldsymbol{f}(\boldsymbol{k}, n) \rangle &amp;= \text{Re}[\boldsymbol{q} e^{\mathrm{i}m\theta} \cdot (\boldsymbol{k} e^{\mathrm{i}n\theta})^<em>] \
&amp;= \text{Re}[\boldsymbol{q} e^{\mathrm{i}m\theta} \cdot \boldsymbol{k}^</em> e^{-\mathrm{i}n\theta}] \
&amp;= \text{Re}[\boldsymbol{q} \boldsymbol{k}^* \cdot e^{\mathrm{i}(m-n)\theta}] \
&amp;= g(\boldsymbol{q}, \boldsymbol{k}, m-n)
\end{align}</p>
<p>ç¡®å®åªä¾èµ–ç›¸å¯¹ä½ç½®$m-n$ï¼âœ“</p>
<h3 id="22">2.2 é«˜ç»´æ¨å¹¿ï¼šå—å¯¹è§’ç»“æ„</h3>
<h4 id="221">2.2.1 ç»´åº¦é…å¯¹ç­–ç•¥</h4>
<p>å¯¹äº$d$ç»´å‘é‡ï¼ˆå‡è®¾$d$ä¸ºå¶æ•°ï¼‰ï¼Œæˆ‘ä»¬å°†å…¶åˆ†æˆ$d/2$å¯¹ï¼š
\begin{equation}
\boldsymbol{q} = \begin{pmatrix} q_0 \ q_1 \ q_2 \ q_3 \ \vdots \ q_{d-2} \ q_{d-1} \end{pmatrix} \rightarrow \begin{pmatrix} (q_0, q_1) \ (q_2, q_3) \ \vdots \ (q_{d-2}, q_{d-1}) \end{pmatrix}
\end{equation}</p>
<p>æ¯ä¸€å¯¹$(q_{2i}, q_{2i+1})$ä½œä¸ºä¸€ä¸ªäºŒç»´å‘é‡ï¼Œåº”ç”¨äºŒç»´RoPEã€‚</p>
<h4 id="222">2.2.2 å¤šé¢‘ç‡è®¾è®¡</h4>
<p>ä¸åŒçš„ç»´åº¦å¯¹ä½¿ç”¨ä¸åŒçš„æ—‹è½¬é¢‘ç‡$\theta_i$ï¼ˆ$i = 0, 1, \ldots, d/2-1$ï¼‰ï¼š
\begin{equation}
\theta_i = \theta_{\text{base}}^{-2i/d}
\end{equation}</p>
<p>åŸæ–‡é€‰æ‹©$\theta_{\text{base}} = 10000$ï¼Œå³$\theta_i = 10000^{-2i/d}$ã€‚</p>
<p><strong>å¤šé¢‘ç‡çš„æ„ä¹‰</strong>ï¼š
- <strong>ä½é¢‘</strong>ï¼ˆ$i$å°ï¼‰ï¼šæ•æ‰é•¿è·ç¦»ä¾èµ–ï¼Œæ—‹è½¬æ…¢
- <strong>é«˜é¢‘</strong>ï¼ˆ$i$å¤§ï¼‰ï¼šæ•æ‰çŸ­è·ç¦»ä¾èµ–ï¼Œæ—‹è½¬å¿«
- ç±»ä¼¼å‚…é‡Œå¶çº§æ•°çš„å¤šå°ºåº¦è¡¨ç¤º</p>
<h4 id="223">2.2.3 å—å¯¹è§’æ—‹è½¬çŸ©é˜µ</h4>
<p>é«˜ç»´RoPEçŸ©é˜µ$\boldsymbol{\mathcal{R}}_m \in \mathbb{R}^{d \times d}$å…·æœ‰å—å¯¹è§’ç»“æ„ï¼š
\begin{equation}
\boldsymbol{\mathcal{R}}_m = \begin{pmatrix}
\boldsymbol{\mathcal{R}}_m^{(0)} &amp; &amp; &amp; \
&amp; \boldsymbol{\mathcal{R}}_m^{(1)} &amp; &amp; \
&amp; &amp; \ddots &amp; \
&amp; &amp; &amp; \boldsymbol{\mathcal{R}}_m^{(d/2-1)}
\end{pmatrix}
\end{equation}</p>
<p>å…¶ä¸­æ¯ä¸ªå—æ˜¯äºŒç»´æ—‹è½¬çŸ©é˜µï¼š
\begin{equation}
\boldsymbol{\mathcal{R}}_m^{(i)} = \begin{pmatrix}
\cos m\theta_i &amp; -\sin m\theta_i \
\sin m\theta_i &amp; \cos m\theta_i
\end{pmatrix}
\end{equation}</p>
<p>å±•å¼€ä¸ºç¨€ç–çŸ©é˜µï¼š
\begin{equation}
\boldsymbol{\mathcal{R}}_m = \begin{pmatrix}
\cos m\theta_0 &amp; -\sin m\theta_0 &amp; 0 &amp; 0 &amp; \cdots \
\sin m\theta_0 &amp; \cos m\theta_0 &amp; 0 &amp; 0 &amp; \cdots \
0 &amp; 0 &amp; \cos m\theta_1 &amp; -\sin m\theta_1 &amp; \cdots \
0 &amp; 0 &amp; \sin m\theta_1 &amp; \cos m\theta_1 &amp; \cdots \
\vdots &amp; \vdots &amp; \vdots &amp; \vdots &amp; \ddots
\end{pmatrix}
\end{equation}</p>
<h4 id="224">2.2.4 æ­£äº¤æ€§è¯æ˜</h4>
<p><strong>å®šç†</strong>ï¼š$\boldsymbol{\mathcal{R}}_m$æ˜¯æ­£äº¤çŸ©é˜µï¼Œå³$\boldsymbol{\mathcal{R}}_m^T \boldsymbol{\mathcal{R}}_m = \boldsymbol{I}$ã€‚</p>
<p><strong>è¯æ˜</strong>ï¼š</p>
<p>å—å¯¹è§’çŸ©é˜µçš„è½¬ç½®æ˜¯å„å—è½¬ç½®çš„å—å¯¹è§’çŸ©é˜µï¼š
\begin{equation}
\boldsymbol{\mathcal{R}}_m^T = \text{diag}((\boldsymbol{\mathcal{R}}_m^{(0)})^T, \ldots, (\boldsymbol{\mathcal{R}}_m^{(d/2-1)})^T)
\end{equation}</p>
<p>å—å¯¹è§’çŸ©é˜µçš„ä¹˜æ³•æ˜¯å„å—åˆ†åˆ«ç›¸ä¹˜ï¼š
\begin{equation}
\boldsymbol{\mathcal{R}}_m^T \boldsymbol{\mathcal{R}}_m = \text{diag}((\boldsymbol{\mathcal{R}}_m^{(0)})^T \boldsymbol{\mathcal{R}}_m^{(0)}, \ldots, (\boldsymbol{\mathcal{R}}_m^{(d/2-1)})^T \boldsymbol{\mathcal{R}}_m^{(d/2-1)})
\end{equation}</p>
<p>å¯¹äºæ¯ä¸ªäºŒç»´æ—‹è½¬çŸ©é˜µï¼š
\begin{align}
(\boldsymbol{\mathcal{R}}_m^{(i)})^T \boldsymbol{\mathcal{R}}_m^{(i)} &amp;= \begin{pmatrix}
\cos m\theta_i &amp; \sin m\theta_i \
-\sin m\theta_i &amp; \cos m\theta_i
\end{pmatrix} \begin{pmatrix}
\cos m\theta_i &amp; -\sin m\theta_i \
\sin m\theta_i &amp; \cos m\theta_i
\end{pmatrix} \
&amp;= \begin{pmatrix}
\cos^2 m\theta_i + \sin^2 m\theta_i &amp; 0 \
0 &amp; \sin^2 m\theta_i + \cos^2 m\theta_i
\end{pmatrix} \
&amp;= \begin{pmatrix} 1 &amp; 0 \ 0 &amp; 1 \end{pmatrix} = \boldsymbol{I}_2
\end{align}</p>
<p>æ‰€ä»¥$\boldsymbol{\mathcal{R}}_m^T \boldsymbol{\mathcal{R}}_m = \boldsymbol{I}_d$ã€‚ $\square$</p>
<p><strong>æ¨è®º</strong>ï¼š$|\boldsymbol{\mathcal{R}}_m \boldsymbol{q}| = |\boldsymbol{q}|$ï¼ˆä¿æŒå‘é‡æ¨¡é•¿ï¼‰</p>
<h4 id="225">2.2.5 æ—‹è½¬ç¾¤æ€§è´¨</h4>
<p><strong>å®šç†ï¼ˆç¾¤å°é—­æ€§ï¼‰</strong>ï¼š$\boldsymbol{\mathcal{R}}<em m_n="m+n">m \boldsymbol{\mathcal{R}}_n = \boldsymbol{\mathcal{R}}</em>$</p>
<p><strong>è¯æ˜</strong>ï¼š</p>
<p>å¯¹äºæ¯ä¸ªå—ï¼š
\begin{align}
\boldsymbol{\mathcal{R}}<em m_n="m+n">m^{(i)} \boldsymbol{\mathcal{R}}_n^{(i)} &amp;= \begin{pmatrix}
\cos m\theta_i &amp; -\sin m\theta_i \
\sin m\theta_i &amp; \cos m\theta_i
\end{pmatrix} \begin{pmatrix}
\cos n\theta_i &amp; -\sin n\theta_i \
\sin n\theta_i &amp; \cos n\theta_i
\end{pmatrix} \
&amp;= \begin{pmatrix}
\cos m\theta_i \cos n\theta_i - \sin m\theta_i \sin n\theta_i &amp; -\cos m\theta_i \sin n\theta_i - \sin m\theta_i \cos n\theta_i \
\sin m\theta_i \cos n\theta_i + \cos m\theta_i \sin n\theta_i &amp; -\sin m\theta_i \sin n\theta_i + \cos m\theta_i \cos n\theta_i
\end{pmatrix} \
&amp;= \begin{pmatrix}
\cos(m+n)\theta_i &amp; -\sin(m+n)\theta_i \
\sin(m+n)\theta_i &amp; \cos(m+n)\theta_i
\end{pmatrix} = \boldsymbol{\mathcal{R}}</em>
\end{align}}^{(i)</p>
<p>æ‰€ä»¥$\boldsymbol{\mathcal{R}}<em m_n="m+n">m \boldsymbol{\mathcal{R}}_n = \boldsymbol{\mathcal{R}}</em>$ã€‚ $\square$</p>
<p><strong>æ¨è®ºï¼ˆç›¸å¯¹ä½ç½®æ€§è´¨ï¼‰</strong>ï¼š
\begin{equation}
(\boldsymbol{\mathcal{R}}<em n-m="n-m">m \boldsymbol{q})^T (\boldsymbol{\mathcal{R}}_n \boldsymbol{k}) = \boldsymbol{q}^T \boldsymbol{\mathcal{R}}_m^T \boldsymbol{\mathcal{R}}_n \boldsymbol{k} = \boldsymbol{q}^T \boldsymbol{\mathcal{R}}</em>
\end{equation}} \boldsymbol{k</p>
<p>è¿™æ­£æ˜¯æˆ‘ä»¬æƒ³è¦çš„ç›¸å¯¹ä½ç½®æ€§è´¨ï¼</p>
<h3 id="23">2.3 è¿œç¨‹è¡°å‡æ€§çš„ä¸¥æ ¼è¯æ˜</h3>
<h4 id="231-abel">2.3.1 Abelå˜æ¢ï¼ˆåˆ†éƒ¨æ±‚å’Œæ³•ï¼‰</h4>
<p>ç»™å®šä¸¤ä¸ªåºåˆ—$\{a_i\}, \{b_i\}$ï¼ŒAbelå˜æ¢å…¬å¼ä¸ºï¼š
\begin{equation}
\sum_{i=0}^{n-1} a_i b_i = a_{n-1} B_{n-1} - \sum_{i=0}^{n-2} B_i (a_{i+1} - a_i)
\end{equation}
å…¶ä¸­$B_i = \sum_{j=0}^i b_j$æ˜¯$b$çš„éƒ¨åˆ†å’Œã€‚</p>
<p>è¿™æ˜¯ç¦»æ•£ç‰ˆæœ¬çš„"åˆ†éƒ¨ç§¯åˆ†"ã€‚</p>
<h4 id="232">2.3.2 å°†å†…ç§¯å†™æˆå¤æ•°å’Œ</h4>
<p>å°†$\boldsymbol{q}, \boldsymbol{k}$ä¸¤ä¸¤é…å¯¹ï¼ˆæ¯å¯¹è§†ä¸ºå¤æ•°ï¼‰ï¼š
\begin{equation}
\boldsymbol{q}<em 2i="2i">{[2i:2i+1]} = q</em>} + \mathrm{i} q_{2i+1}, \quad \boldsymbol{k<em 2i="2i">{[2i:2i+1]} = k</em>
\end{equation}} + \mathrm{i} k_{2i+1</p>
<p>RoPEåçš„å†…ç§¯ï¼š
\begin{equation}
(\boldsymbol{\mathcal{R}}<em i="0">m \boldsymbol{q})^T (\boldsymbol{\mathcal{R}}_n \boldsymbol{k}) = \text{Re}\left[ \sum</em>}^{d/2-1} \boldsymbol{q<em _2i:2i_1_="[2i:2i+1]">{[2i:2i+1]} \boldsymbol{k}</em> \right]
\end{equation}}^* e^{\mathrm{i}(m-n)\theta_i</p>
<h4 id="233-abel">2.3.3 åº”ç”¨Abelå˜æ¢</h4>
<p>è®°ï¼š
- $h_i = \boldsymbol{q}<em _2i:2i_1_="[2i:2i+1]">{[2i:2i+1]} \boldsymbol{k}</em>^*$ï¼ˆå¤æ•°ï¼‰
- $S_j = \sum_{i=0}^{j-1} e^{\mathrm{i}(m-n)\theta_i}$ï¼ˆæŒ‡æ•°å’Œçš„éƒ¨åˆ†å’Œï¼‰
- çº¦å®š$h_{d/2} = 0, S_0 = 0$</p>
<p>åº”ç”¨Abelå˜æ¢ï¼š
\begin{align}
\sum_{i=0}^{d/2-1} h_i e^{\mathrm{i}(m-n)\theta_i} &amp;= \sum_{i=0}^{d/2-1} h_i (S_{i+1} - S_i) \
&amp;= \sum_{i=0}^{d/2-1} h_i S_{i+1} - \sum_{i=0}^{d/2-1} h_i S_i \
&amp;= \sum_{i=0}^{d/2-1} h_i S_{i+1} - \sum_{i=1}^{d/2} h_{i-1} S_i \quad (\text{é‡æ–°ç´¢å¼•}) \
&amp;= h_{d/2-1} S_{d/2} - \sum_{i=1}^{d/2-1} S_i (h_i - h_{i-1}) \
&amp;= -\sum_{i=0}^{d/2-1} S_{i+1} (h_{i+1} - h_i) \quad (\text{åˆ©ç”¨}h_{d/2}=0)
\end{align}</p>
<h4 id="234">2.3.4 ä¸Šç•Œä¼°è®¡</h4>
<p>å–æ¨¡ï¼š
\begin{align}
\left| \sum_{i=0}^{d/2-1} h_i e^{\mathrm{i}(m-n)\theta_i} \right| &amp;= \left| \sum_{i=0}^{d/2-1} S_{i+1} (h_{i+1} - h_i) \right| \
&amp;\leq \sum_{i=0}^{d/2-1} |S_{i+1}| \cdot |h_{i+1} - h_i| \quad (\text{ä¸‰è§’ä¸ç­‰å¼}) \
&amp;\leq \left( \max_{0 \leq i &lt; d/2} |h_{i+1} - h_i| \right) \sum_{i=0}^{d/2-1} |S_{i+1}| \
&amp;\equiv C_{\boldsymbol{q}, \boldsymbol{k}} \cdot \frac{1}{d/2} \sum_{i=1}^{d/2} |S_i|
\end{align}</p>
<p>å…¶ä¸­$C_{\boldsymbol{q}, \boldsymbol{k}}$æ˜¯åªä¾èµ–$\boldsymbol{q}, \boldsymbol{k}$çš„å¸¸æ•°ï¼ˆç›¸é‚»$h_i$çš„æœ€å¤§å·®å¼‚ï¼‰ã€‚</p>
<p><strong>å…³é”®é‡</strong>ï¼š$\frac{1}{d/2} \sum_{i=1}^{d/2} |S_i|$éšç›¸å¯¹è·ç¦»$\Delta = m - n$çš„å˜åŒ–ã€‚</p>
<h4 id="235">2.3.5 æŒ‡æ•°å’Œçš„æ¸è¿‘è¡Œä¸º</h4>
<p>å¯¹äºç­‰æ¯”æ•°åˆ—$\theta_i = \theta_0^{2i/d}$ï¼ˆ$\theta_0 = 10000^{-1}$ï¼‰ï¼Œæœ‰ï¼š
\begin{equation}
S_j = \sum_{i=0}^{j-1} e^{\mathrm{i}\Delta\theta_i} = \sum_{i=0}^{j-1} e^{\mathrm{i}\Delta\theta_0^{2i/d}}
\end{equation}</p>
<p>å½“$\Delta$è¾ƒå¤§æ—¶ï¼Œç›¸ä½$\Delta\theta_i$åœ¨$i$å¢å¤§æ—¶å˜åŒ–å‰§çƒˆï¼ˆé«˜é¢‘æŒ¯è¡ï¼‰ï¼Œå¯¼è‡´æ­£è´ŸæŠµæ¶ˆï¼š
\begin{equation}
|S_j| \sim \mathcal{O}(\sqrt{j}) \quad (\text{éšæœºæ¸¸èµ°æ¨¡å‹})
\end{equation}</p>
<p>ç²¾ç¡®åˆ†æéœ€è¦æŒ¯è¡ç§¯åˆ†ç†è®ºï¼ˆè¶…å‡ºæœ¬æ–‡èŒƒå›´ï¼‰ï¼Œä½†æ•°å€¼å®éªŒéªŒè¯äº†è¡°å‡æ€§ï¼ˆè§åŸæ–‡å›¾ï¼‰ã€‚</p>
<h4 id="236">2.3.6 è¡°å‡æ€§çš„æ•°å€¼éªŒè¯</h4>
<p>åŸæ–‡ä½¿ç”¨Mathematicaä»£ç è®¡ç®—$d=128$æ—¶çš„å¹³å‡$|S_i|$ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">128</span><span class="p">;</span>
<span class="err">Î¸</span><span class="p">[</span><span class="nv">t_</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10000</span><span class="o">^</span><span class="p">(</span><span class="mi">-2</span><span class="o">*</span><span class="n">t</span><span class="o">/</span><span class="n">d</span><span class="p">);</span>
<span class="n">f</span><span class="p">[</span><span class="nv">m_</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Sum</span><span class="p">[</span><span class="n">Norm</span><span class="p">[</span><span class="n">Sum</span><span class="p">[</span><span class="n">Exp</span><span class="p">[</span><span class="n">I</span><span class="o">*</span><span class="n">m</span><span class="o">*</span><span class="err">Î¸</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span><span class="w"> </span><span class="p">{</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">}]],</span><span class="w"> </span><span class="p">{</span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="o">/</span><span class="mi">2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">}]</span><span class="o">/</span><span class="p">(</span><span class="n">d</span><span class="o">/</span><span class="mi">2</span><span class="p">);</span>
<span class="n">Plot</span><span class="p">[</span><span class="n">f</span><span class="p">[</span><span class="n">m</span><span class="p">],</span><span class="w"> </span><span class="p">{</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">256</span><span class="p">}]</span>
</code></pre></div>

<p>ç»“æœæ˜¾ç¤ºï¼šéšç€ç›¸å¯¹è·ç¦»$m$å¢å¤§ï¼Œå¹³å‡éƒ¨åˆ†å’Œæ¨¡é•¿$f(m)$å‘ˆç°è¡°å‡è¶‹åŠ¿ï¼ŒéªŒè¯äº†è¿œç¨‹è¡°å‡æ€§ã€‚</p>
<p><strong>è¡°å‡æœºåˆ¶çš„ç›´è§‰</strong>ï¼š
- <strong>ä½é¢‘é¡¹</strong>ï¼š$\theta_0 \sim 10^{-4}$ï¼Œå³ä½¿$\Delta=256$ï¼Œç›¸ä½å˜åŒ–$\Delta\theta_0 \sim 0.0256$ï¼Œæ—‹è½¬ç¼“æ…¢
- <strong>é«˜é¢‘é¡¹</strong>ï¼š$\theta_{d/2-1} \sim 1$ï¼Œç›¸ä½å˜åŒ–$\Delta \cdot 1 = \Delta$ï¼Œæ—‹è½¬å¿«é€Ÿï¼Œæ­£è´ŸæŠµæ¶ˆ
- å¤šé¢‘ç‡ç»„åˆå½¢æˆæ¸è¿›è¡°å‡</p>
<h3 id="24-sinusoidal">2.4 ä¸Sinusoidalç¼–ç çš„æ·±å±‚è”ç³»</h3>
<h4 id="241-vs">2.4.1 åŠ æ€§ vs ä¹˜æ€§</h4>
<p><strong>Sinusoidal</strong>ï¼ˆåŠ æ€§ï¼‰ï¼š
\begin{equation}
\tilde{\boldsymbol{q}}_m = \boldsymbol{q} + PE_m, \quad PE_m = (\sin m\theta_0, \cos m\theta_0, \sin m\theta_1, \cos m\theta_1, \ldots)^T
\end{equation}</p>
<p><strong>RoPE</strong>ï¼ˆä¹˜æ€§ï¼‰ï¼š
\begin{equation}
\tilde{\boldsymbol{q}}_m = \boldsymbol{\mathcal{R}}_m \boldsymbol{q}
\end{equation}</p>
<h4 id="242">2.4.2 æ³°å‹’å±•å¼€çš„å…³è”</h4>
<p>Sinusoidalç¼–ç å£°ç§°é€šè¿‡æ³°å‹’å±•å¼€å¯ä»¥è¿‘ä¼¼ç›¸å¯¹ä½ç½®ï¼š
\begin{align}
\langle \boldsymbol{q} + PE_m, \boldsymbol{k} + PE_n \rangle &amp;= \langle \boldsymbol{q}, \boldsymbol{k} \rangle + \langle \boldsymbol{q}, PE_n \rangle + \langle PE_m, \boldsymbol{k} \rangle + \langle PE_m, PE_n \rangle \
&amp;\approx \langle \boldsymbol{q}, \boldsymbol{k} \rangle + \text{ç›¸å¯¹ä½ç½®é¡¹}(m-n) \quad (\text{åœ¨}|\boldsymbol{q}|, |\boldsymbol{k}| \ll |PE|\text{æ—¶})
\end{align}</p>
<p>ä½†è¿™éœ€è¦å¼ºå‡è®¾ï¼š$|\boldsymbol{q}|, |\boldsymbol{k}|$è¿œå°äº$|PE|$ã€‚å®é™…ä¸Šï¼š
- BERTçš„è¯åµŒå…¥ï¼š$|\boldsymbol{x}| \sim \mathcal{O}(1)$
- Sinusoidal PEï¼š$|PE| \sim \mathcal{O}(\sqrt{d})$</p>
<p>è™½ç„¶$|PE| &gt; |\boldsymbol{x}|$ï¼Œä½†ä¸æ˜¯"è¿œå¤§äº"ï¼Œå› æ­¤è¿‘ä¼¼ä¸å¤Ÿå‡†ç¡®ã€‚</p>
<h4 id="243-rope">2.4.3 RoPEçš„ä¸¥è°¨æ€§</h4>
<p>RoPEé€šè¿‡æ—‹è½¬å˜æ¢ï¼š
\begin{equation}
\langle \boldsymbol{\mathcal{R}}<em n-m="n-m">m \boldsymbol{q}, \boldsymbol{\mathcal{R}}_n \boldsymbol{k} \rangle = \boldsymbol{q}^T \boldsymbol{\mathcal{R}}</em>
\end{equation}} \boldsymbol{k</p>
<p><strong>å®Œå…¨ç²¾ç¡®</strong>åœ°å®ç°ç›¸å¯¹ä½ç½®ç¼–ç ï¼Œæ— éœ€ä»»ä½•è¿‘ä¼¼ï¼</p>
<hr />
<h2 id="3">ğŸŒˆ ç¬¬3éƒ¨åˆ†ï¼šç›´è§‰ç†è§£ä¸å¯è§†åŒ–</h2>
<h3 id="31">3.1 å‡ ä½•è§†è§’ï¼šæ—‹è½¬çš„é­”åŠ›</h3>
<h4 id="311">3.1.1 å•ä½åœ†ä¸Šçš„æ—‹è½¬</h4>
<p>æƒ³è±¡äºŒç»´å¹³é¢ä¸Šçš„å•ä½åœ†ã€‚å‘é‡$\boldsymbol{q} = (q_0, q_1)^T$å¯¹åº”åœ†ä¸Šï¼ˆæˆ–åœ†å†…ï¼‰çš„ä¸€ä¸ªç‚¹ã€‚RoPEåšçš„äº‹æƒ…æ˜¯ï¼š
- ä½ç½®$m=0$ï¼šä¸æ—‹è½¬
- ä½ç½®$m=1$ï¼šé€†æ—¶é’ˆæ—‹è½¬$\theta$è§’åº¦
- ä½ç½®$m=2$ï¼šé€†æ—¶é’ˆæ—‹è½¬$2\theta$è§’åº¦
- ...</p>
<p>å°±åƒæ—¶é’Ÿçš„æŒ‡é’ˆï¼šæ¯è¿‡ä¸€ä¸ªä½ç½®ï¼ŒæŒ‡é’ˆè½¬åŠ¨å›ºå®šè§’åº¦$\theta$ã€‚</p>
<h4 id="312">3.1.2 å¤šç»´ç©ºé—´çš„æ—‹è½¬ç¾¤</h4>
<p>é«˜ç»´RoPEæ˜¯å¤šä¸ªäºŒç»´æ—‹è½¬çš„ç»„åˆï¼š
- ç¬¬0-1ç»´ï¼šæ—‹è½¬$m\theta_0$
- ç¬¬2-3ç»´ï¼šæ—‹è½¬$m\theta_1$
- ...</p>
<p>æ¯ä¸ªäºŒç»´å­ç©ºé—´ç‹¬ç«‹æ—‹è½¬ï¼Œåƒå¤šä¸ªæ—¶é’ŸåŒæ—¶è¿è¡Œï¼Œé¢‘ç‡ä¸åŒï¼ˆ$\theta_0 &lt; \theta_1 &lt; \cdots$ï¼‰ã€‚</p>
<h4 id="313">3.1.3 ç›¸å¯¹ä½ç½®çš„è‡ªç„¶æ¶Œç°</h4>
<p>ä¸ºä»€ä¹ˆæ—‹è½¬èƒ½ç¼–ç ç›¸å¯¹ä½ç½®ï¼Ÿå…³é”®åœ¨äºæ—‹è½¬ç¾¤çš„æ€§è´¨ï¼š
\begin{equation}
\text{æ—‹è½¬}(m\theta) \circ \text{æ—‹è½¬}(-n\theta) = \text{æ—‹è½¬}((m-n)\theta)
\end{equation}</p>
<p>åœ¨å†…ç§¯ä¸­ï¼š
\begin{align}
\langle \text{æ—‹è½¬}(m\theta) \boldsymbol{q}, \text{æ—‹è½¬}(n\theta) \boldsymbol{k} \rangle &amp;= \langle \boldsymbol{q}, \text{æ—‹è½¬}(-m\theta) \circ \text{æ—‹è½¬}(n\theta) \boldsymbol{k} \rangle \
&amp;= \langle \boldsymbol{q}, \text{æ—‹è½¬}((n-m)\theta) \boldsymbol{k} \rangle
\end{align}</p>
<p><strong>æ—‹è½¬çš„é€†è¿ç®—</strong>è‡ªåŠ¨æŠµæ¶ˆäº†ç»å¯¹ä½ç½®ï¼Œåªç•™ä¸‹ç›¸å¯¹ä½ç½®ï¼</p>
<h3 id="32">3.2 æ—¶é’ŸæŒ‡é’ˆç±»æ¯”</h3>
<h4 id="321">3.2.1 å•ä¸ªæ—¶é’Ÿ</h4>
<p>æƒ³è±¡ä¸€ä¸ªæ—¶é’Ÿï¼Œæ¯ä¸ªä½ç½®å¯¹åº”ä¸€ä¸ªæ—¶åˆ»ï¼š
- ä½ç½®0ï¼š12ç‚¹ï¼ˆ0åº¦ï¼‰
- ä½ç½®1ï¼š12ç‚¹+$\theta$åº¦
- ä½ç½®$m$ï¼š12ç‚¹+$m\theta$åº¦</p>
<p>ä¸¤ä¸ªä½ç½®$m, n$çš„"ç›¸å¯¹æ—¶åˆ»"æ˜¯$(m-n)\theta$åº¦ã€‚</p>
<h4 id="322">3.2.2 å¤šä¸ªé¢‘ç‡çš„æ—¶é’Ÿ</h4>
<p>RoPEç›¸å½“äºå¤šä¸ªæ—¶é’ŸåŒæ—¶è¿è¡Œï¼š
- <strong>æ…¢é’Ÿ</strong>ï¼ˆä½é¢‘$\theta_0$ï¼‰ï¼šèµ°å¾—æ…¢ï¼Œé€‚åˆåŒºåˆ†è¿œè·ç¦»ï¼ˆå¦‚å°æ—¶é’ˆï¼‰
- <strong>å¿«é’Ÿ</strong>ï¼ˆé«˜é¢‘$\theta_{d/2-1}$ï¼‰ï¼šèµ°å¾—å¿«ï¼Œé€‚åˆåŒºåˆ†è¿‘è·ç¦»ï¼ˆå¦‚ç§’é’ˆï¼‰</p>
<p>å¤šä¸ªæ—¶é’Ÿçš„ç»„åˆå¯ä»¥å”¯ä¸€ç¡®å®šä½ç½®ï¼ˆç±»ä¼¼æ—¶åˆ†ç§’çš„ç»„åˆï¼‰ã€‚</p>
<h3 id="33">3.3 ç›¸ä½ç¼–ç çš„ä¿¡æ¯è®ºæ„ä¹‰</h3>
<h4 id="331-shannon">3.3.1 Shannonä¿¡æ¯ç†µ</h4>
<p>ä½ç½®ç¼–ç æœ¬è´¨ä¸Šæ˜¯å°†ä½ç½®ä¿¡æ¯$m \in \{0, 1, \ldots, L-1\}$ç¼–ç ä¸º$d$ç»´å‘é‡ã€‚æ‰€éœ€çš„æœ€å°ç»´åº¦æ˜¯ï¼š
\begin{equation}
d_{\min} = \lceil \log_2 L \rceil
\end{equation}</p>
<p>RoPEä½¿ç”¨$d$ç»´ï¼ˆé€šå¸¸$d \gg d_{\min}$ï¼‰ï¼Œå› æ­¤æ˜¯<strong>å†—ä½™ç¼–ç </strong>ã€‚</p>
<h4 id="332">3.3.2 å†—ä½™çš„å¥½å¤„</h4>
<p>ä¸ºä»€ä¹ˆä¸ç”¨æœ€å°ç»´åº¦ï¼Ÿ
1. <strong>é²æ£’æ€§</strong>ï¼šå†—ä½™æä¾›å®¹é”™èƒ½åŠ›ï¼Œå™ªå£°ä¸æ˜“ç ´åç¼–ç 
2. <strong>è¿ç»­æ€§</strong>ï¼šç›¸é‚»ä½ç½®çš„ç¼–ç å‘é‡æ¥è¿‘ï¼ˆæ—‹è½¬è§’åº¦å·®å°ï¼‰
3. <strong>è¡°å‡æ€§</strong>ï¼šå¤šé¢‘ç‡æä¾›"è½¯"çš„è·ç¦»è¡°å‡ï¼Œè€Œéç¡¬æˆªæ–­</p>
<h3 id="34">3.4 ä»£ç å®ç°ä¸å¯è§†åŒ–</h3>
<h4 id="341-numpy">3.4.1 NumPyæ ‡å‡†å®ç°</h4>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="k">def</span><span class="w"> </span><span class="nf">rope_encoding</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">d_model</span><span class="p">,</span> <span class="n">theta_base</span><span class="o">=</span><span class="mi">10000</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    åº”ç”¨RoPEåˆ°æŸ¥è¯¢å‘é‡q</span>

<span class="sd">    å‚æ•°:</span>
<span class="sd">        q: shape (d_model,) æŸ¥è¯¢å‘é‡</span>
<span class="sd">        position: int ä½ç½®ç´¢å¼•</span>
<span class="sd">        d_model: int æ¨¡å‹ç»´åº¦ï¼ˆå¿…é¡»æ˜¯å¶æ•°ï¼‰</span>
<span class="sd">        theta_base: float é¢‘ç‡åŸºæ•°</span>

<span class="sd">    è¿”å›:</span>
<span class="sd">        q_rope: shape (d_model,) åº”ç”¨RoPEåçš„å‘é‡</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">d_model</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;d_modelå¿…é¡»æ˜¯å¶æ•°&quot;</span>

    <span class="c1"># è®¡ç®—é¢‘ç‡</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">d_model</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># [0, 2, 4, ..., d_model-2]</span>
    <span class="n">theta_i</span> <span class="o">=</span> <span class="n">theta_base</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="n">i</span> <span class="o">/</span> <span class="n">d_model</span><span class="p">)</span>  <span class="c1"># shape (d_model/2,)</span>

    <span class="c1"># è®¡ç®—è§’åº¦</span>
    <span class="n">m_theta_i</span> <span class="o">=</span> <span class="n">position</span> <span class="o">*</span> <span class="n">theta_i</span>  <span class="c1"># shape (d_model/2,)</span>

    <span class="c1"># è®¡ç®—coså’Œsin</span>
    <span class="n">cos_m_theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">m_theta_i</span><span class="p">)</span>  <span class="c1"># shape (d_model/2,)</span>
    <span class="n">sin_m_theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">m_theta_i</span><span class="p">)</span>  <span class="c1"># shape (d_model/2,)</span>

    <span class="c1"># é‡å¤ä»¥åŒ¹é…qçš„ç»´åº¦</span>
    <span class="n">cos_m_theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">cos_m_theta</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># shape (d_model,)</span>
    <span class="n">sin_m_theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">sin_m_theta</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># shape (d_model,)</span>

    <span class="c1"># æ„é€ æ—‹è½¬åçš„å‘é‡ï¼ˆæŒ‰å…¬å¼(81)ï¼‰</span>
    <span class="n">q_rotate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
    <span class="n">q_rotate</span><span class="p">[</span><span class="mi">0</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># -q1, -q3, -q5, ...</span>
    <span class="n">q_rotate</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>   <span class="c1"># q0, q2, q4, ...</span>

    <span class="c1"># åº”ç”¨RoPE</span>
    <span class="n">q_rope</span> <span class="o">=</span> <span class="n">q</span> <span class="o">*</span> <span class="n">cos_m_theta</span> <span class="o">+</span> <span class="n">q_rotate</span> <span class="o">*</span> <span class="n">sin_m_theta</span>

    <span class="k">return</span> <span class="n">q_rope</span>

<span class="c1"># æµ‹è¯•</span>
<span class="n">d</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
<span class="n">position</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">q_rope</span> <span class="o">=</span> <span class="n">rope_encoding</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;åŸå§‹å‘é‡q:&quot;</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;RoPEå:&quot;</span><span class="p">,</span> <span class="n">q_rope</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;æ¨¡é•¿ä¿æŒ:&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">q</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">q_rope</span><span class="p">)))</span>
</code></pre></div>

<h4 id="342-pytorch">3.4.2 PyTorché«˜æ•ˆå®ç°</h4>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nn</span>

<span class="k">class</span><span class="w"> </span><span class="nc">RoPEPositionEncoding</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d_model</span><span class="p">,</span> <span class="n">max_len</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span> <span class="n">theta_base</span><span class="o">=</span><span class="mi">10000</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d_model</span> <span class="o">=</span> <span class="n">d_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_len</span> <span class="o">=</span> <span class="n">max_len</span>

        <span class="c1"># é¢„è®¡ç®—é¢‘ç‡ï¼ˆä¸éœ€è¦æ¢¯åº¦ï¼‰</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">d_model</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">theta_i</span> <span class="o">=</span> <span class="n">theta_base</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="n">i</span> <span class="o">/</span> <span class="n">d_model</span><span class="p">)</span>  <span class="c1"># shape (d_model/2,)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s1">&#39;theta_i&#39;</span><span class="p">,</span> <span class="n">theta_i</span><span class="p">)</span>

        <span class="c1"># é¢„è®¡ç®—ä½ç½®ç¼–ç ï¼ˆç”¨äºåŠ é€Ÿï¼‰</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cached_encoding</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cached_max_len</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_encoding</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_len</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;é¢„è®¡ç®—ä½ç½®0åˆ°max_len-1çš„ç¼–ç &quot;&quot;&quot;</span>
        <span class="n">positions</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">max_len</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">theta_i</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>  <span class="c1"># shape (max_len,)</span>
        <span class="n">m_theta_i</span> <span class="o">=</span> <span class="n">positions</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta_i</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>  <span class="c1"># shape (max_len, d_model/2)</span>

        <span class="c1"># è®¡ç®—coså’Œsin</span>
        <span class="n">cos_m_theta</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">m_theta_i</span><span class="p">)</span>  <span class="c1"># shape (max_len, d_model/2)</span>
        <span class="n">sin_m_theta</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">m_theta_i</span><span class="p">)</span>  <span class="c1"># shape (max_len, d_model/2)</span>

        <span class="c1"># é‡å¤ä»¥åŒ¹é…ç»´åº¦</span>
        <span class="n">cos_m_theta</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">repeat_interleave</span><span class="p">(</span><span class="n">cos_m_theta</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># shape (max_len, d_model)</span>
        <span class="n">sin_m_theta</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">repeat_interleave</span><span class="p">(</span><span class="n">sin_m_theta</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># shape (max_len, d_model)</span>

        <span class="k">return</span> <span class="n">cos_m_theta</span><span class="p">,</span> <span class="n">sin_m_theta</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        åº”ç”¨RoPEåˆ°Qå’ŒK</span>

<span class="sd">        å‚æ•°:</span>
<span class="sd">            q: shape (batch_size, seq_len, d_model)</span>
<span class="sd">            k: shape (batch_size, seq_len, d_model) æˆ– None</span>

<span class="sd">        è¿”å›:</span>
<span class="sd">            q_rope: shape (batch_size, seq_len, d_model)</span>
<span class="sd">            k_rope: shape (batch_size, seq_len, d_model) æˆ– None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">batch_size</span><span class="p">,</span> <span class="n">seq_len</span><span class="p">,</span> <span class="n">d_model</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">assert</span> <span class="n">d_model</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_model</span>

        <span class="c1"># ç¼“å­˜æœºåˆ¶</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cached_max_len</span> <span class="o">&lt;</span> <span class="n">seq_len</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cached_encoding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_encoding</span><span class="p">(</span><span class="n">seq_len</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cached_max_len</span> <span class="o">=</span> <span class="n">seq_len</span>

        <span class="n">cos_m_theta</span><span class="p">,</span> <span class="n">sin_m_theta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cached_encoding</span>
        <span class="n">cos_m_theta</span> <span class="o">=</span> <span class="n">cos_m_theta</span><span class="p">[:</span><span class="n">seq_len</span><span class="p">,</span> <span class="p">:]</span>  <span class="c1"># shape (seq_len, d_model)</span>
        <span class="n">sin_m_theta</span> <span class="o">=</span> <span class="n">sin_m_theta</span><span class="p">[:</span><span class="n">seq_len</span><span class="p">,</span> <span class="p">:]</span>  <span class="c1"># shape (seq_len, d_model)</span>

        <span class="c1"># å¹¿æ’­åˆ°batchç»´åº¦</span>
        <span class="n">cos_m_theta</span> <span class="o">=</span> <span class="n">cos_m_theta</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>  <span class="c1"># shape (1, seq_len, d_model)</span>
        <span class="n">sin_m_theta</span> <span class="o">=</span> <span class="n">sin_m_theta</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>  <span class="c1"># shape (1, seq_len, d_model)</span>

        <span class="c1"># æ„é€ æ—‹è½¬å‘é‡</span>
        <span class="n">q_rotate</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
        <span class="n">q_rotate</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">q</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">q_rotate</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">q</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>

        <span class="c1"># åº”ç”¨RoPEåˆ°Q</span>
        <span class="n">q_rope</span> <span class="o">=</span> <span class="n">q</span> <span class="o">*</span> <span class="n">cos_m_theta</span> <span class="o">+</span> <span class="n">q_rotate</span> <span class="o">*</span> <span class="n">sin_m_theta</span>

        <span class="c1"># åº”ç”¨RoPEåˆ°Kï¼ˆå¦‚æœæä¾›ï¼‰</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">k_rotate</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="n">k_rotate</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">k</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">k_rotate</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">k_rope</span> <span class="o">=</span> <span class="n">k</span> <span class="o">*</span> <span class="n">cos_m_theta</span> <span class="o">+</span> <span class="n">k_rotate</span> <span class="o">*</span> <span class="n">sin_m_theta</span>
            <span class="k">return</span> <span class="n">q_rope</span><span class="p">,</span> <span class="n">k_rope</span>

        <span class="k">return</span> <span class="n">q_rope</span><span class="p">,</span> <span class="kc">None</span>

<span class="c1"># æµ‹è¯•</span>
<span class="n">rope</span> <span class="o">=</span> <span class="n">RoPEPositionEncoding</span><span class="p">(</span><span class="n">d_model</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">max_len</span><span class="o">=</span><span class="mi">512</span><span class="p">)</span>
<span class="n">batch_size</span><span class="p">,</span> <span class="n">seq_len</span><span class="p">,</span> <span class="n">d_model</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">64</span>
<span class="n">q</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">seq_len</span><span class="p">,</span> <span class="n">d_model</span><span class="p">)</span>
<span class="n">k</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">seq_len</span><span class="p">,</span> <span class="n">d_model</span><span class="p">)</span>

<span class="n">q_rope</span><span class="p">,</span> <span class="n">k_rope</span> <span class="o">=</span> <span class="n">rope</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Q shape:&quot;</span><span class="p">,</span> <span class="n">q_rope</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;K shape:&quot;</span><span class="p">,</span> <span class="n">k_rope</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;æ¨¡é•¿ä¿æŒ:&quot;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">q_rope</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">))</span>
</code></pre></div>

<h4 id="343">3.4.3 ä½ç½®ç¼–ç å¯è§†åŒ–</h4>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.manifold</span><span class="w"> </span><span class="kn">import</span> <span class="n">TSNE</span>

<span class="k">def</span><span class="w"> </span><span class="nf">visualize_rope_encoding</span><span class="p">(</span><span class="n">d_model</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">max_len</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">theta_base</span><span class="o">=</span><span class="mi">10000</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;å¯è§†åŒ–RoPEç¼–ç çš„ä½ç½®è¡¨ç¤º&quot;&quot;&quot;</span>

    <span class="c1"># ç”Ÿæˆä½ç½®ç¼–ç </span>
    <span class="n">positions</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">max_len</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">d_model</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">theta_i</span> <span class="o">=</span> <span class="n">theta_base</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="n">i</span> <span class="o">/</span> <span class="n">d_model</span><span class="p">)</span>

    <span class="n">m_theta_i</span> <span class="o">=</span> <span class="n">positions</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">theta_i</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">cos_m_theta</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">m_theta_i</span><span class="p">)</span>
    <span class="n">sin_m_theta</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">m_theta_i</span><span class="p">)</span>

    <span class="c1"># ç»„åˆæˆå®Œæ•´ç¼–ç </span>
    <span class="n">encoding</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">max_len</span><span class="p">,</span> <span class="n">d_model</span><span class="p">)</span>
    <span class="n">encoding</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cos_m_theta</span>
    <span class="n">encoding</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">sin_m_theta</span>

    <span class="c1"># t-SNEé™ç»´åˆ°2D</span>
    <span class="n">tsne</span> <span class="o">=</span> <span class="n">TSNE</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
    <span class="n">encoding_2d</span> <span class="o">=</span> <span class="n">tsne</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">encoding</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>

    <span class="c1"># ç»˜å›¾</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

    <span class="c1"># å·¦å›¾ï¼št-SNEå¯è§†åŒ–</span>
    <span class="n">scatter</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">encoding_2d</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">encoding_2d</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
                              <span class="n">c</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">max_len</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;RoPE Encoding (t-SNE)&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Dimension 1&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Dimension 2&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">scatter</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Position&#39;</span><span class="p">)</span>

    <span class="c1"># å³å›¾ï¼šå†…ç§¯çƒ­åŠ›å›¾</span>
    <span class="n">inner_products</span> <span class="o">=</span> <span class="n">encoding</span> <span class="o">@</span> <span class="n">encoding</span><span class="o">.</span><span class="n">T</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">inner_products</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;RdBu_r&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Inner Product Heatmap&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Position&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Position&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Inner Product&#39;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;rope_visualization.png&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># visualize_rope_encoding()</span>
</code></pre></div>

<h4 id="344">3.4.4 è¡°å‡æ€§çš„æ•°å€¼éªŒè¯</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">verify_decay</span><span class="p">(</span><span class="n">d_model</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">max_distance</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> <span class="n">theta_base</span><span class="o">=</span><span class="mi">10000</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;éªŒè¯RoPEçš„è¿œç¨‹è¡°å‡æ€§&quot;&quot;&quot;</span>

    <span class="n">i</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">d_model</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">theta_i</span> <span class="o">=</span> <span class="n">theta_base</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="n">i</span> <span class="o">/</span> <span class="n">d_model</span><span class="p">)</span>  <span class="c1"># shape (d_model/2,)</span>

    <span class="n">distances</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_distance</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">avg_magnitudes</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">delta</span> <span class="ow">in</span> <span class="n">distances</span><span class="p">:</span>
        <span class="c1"># è®¡ç®— S_j = sum_{i=0}^{j-1} exp(i*delta*theta_i)</span>
        <span class="n">S</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">d_model</span><span class="o">//</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">exp_sum</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">delta</span> <span class="o">*</span> <span class="n">theta_i</span><span class="p">[:</span><span class="n">j</span><span class="p">]))</span>
            <span class="n">S</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">exp_sum</span><span class="p">))</span>

        <span class="c1"># å¹³å‡å€¼</span>
        <span class="n">avg_mag</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">S</span><span class="p">))</span>
        <span class="n">avg_magnitudes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">avg_mag</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>

    <span class="c1"># ç»˜å›¾</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">distances</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">avg_magnitudes</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Relative Distance Î”&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Average |S_j|&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;RoPE Long-Range Decay (d=</span><span class="si">{</span><span class="n">d_model</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;rope_decay.png&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># verify_decay()</span>
</code></pre></div>

<h3 id="35-rope">3.5 ä¸RoPEçš„è¯¦ç»†å¯¹æ¯”</h3>
<table>
<thead>
<tr>
<th>ç‰¹æ€§</th>
<th>Sinusoidal PE</th>
<th>RoPE</th>
</tr>
</thead>
<tbody>
<tr>
<td>ç¼–ç æ–¹å¼</td>
<td>åŠ æ€§ï¼š$\boldsymbol{x} + PE$</td>
<td>ä¹˜æ€§ï¼š$\boldsymbol{\mathcal{R}}_m \boldsymbol{x}$</td>
</tr>
<tr>
<td>ç›¸å¯¹ä½ç½®</td>
<td>è¿‘ä¼¼ï¼ˆéœ€æ³°å‹’å±•å¼€ï¼‰</td>
<td>ç²¾ç¡®ï¼ˆæ—‹è½¬ç¾¤æ€§è´¨ï¼‰</td>
</tr>
<tr>
<td>æ¨¡é•¿ä¿æŒ</td>
<td>âœ—ï¼ˆæ”¹å˜å‘é‡æ¨¡é•¿ï¼‰</td>
<td>âœ“ï¼ˆæ­£äº¤å˜æ¢ï¼‰</td>
</tr>
<tr>
<td>å¤–æ¨æ€§</td>
<td>ä¸­ç­‰ï¼ˆè¶…å‡ºè®­ç»ƒé•¿åº¦æ€§èƒ½ä¸‹é™ï¼‰</td>
<td>ä¼˜ç§€ï¼ˆç†è®ºæ”¯æŒä»»æ„é•¿åº¦ï¼‰</td>
</tr>
<tr>
<td>è®¡ç®—å¤æ‚åº¦</td>
<td>$O(Ld)$</td>
<td>$O(Ld)$ï¼ˆé¢„è®¡ç®—å$O(d)$ï¼‰</td>
</tr>
<tr>
<td>å¯å­¦ä¹ æ€§</td>
<td>å›ºå®šæˆ–å¯å­¦ä¹ </td>
<td>å›ºå®šï¼ˆé¢‘ç‡å¯è°ƒï¼‰</td>
</tr>
<tr>
<td>çº¿æ€§Attention</td>
<td>âœ“</td>
<td>âœ“ï¼ˆå”¯ä¸€å¯ç”¨çš„ç›¸å¯¹ä½ç½®ç¼–ç ï¼‰</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="4">ğŸ” ç¬¬4éƒ¨åˆ†ï¼šæ‰¹åˆ¤æ€§åˆ†æä¸å®è·µæŒ‘æˆ˜</h2>
<h3 id="41">4.1 ç†è®ºå±€é™æ€§</h3>
<h4 id="411">4.1.1 é¢‘ç‡é€‰æ‹©çš„æ•æ„Ÿæ€§</h4>
<p>RoPEçš„æ€§èƒ½ä¾èµ–äºé¢‘ç‡$\theta_i = \theta_{\text{base}}^{-2i/d}$çš„é€‰æ‹©ã€‚åŸæ–‡é€‰æ‹©$\theta_{\text{base}} = 10000$ï¼Œä½†è¿™æ˜¯ç»éªŒæ€§çš„ï¼Œç¼ºä¹ä¸¥æ ¼çš„ç†è®ºæŒ‡å¯¼ã€‚</p>
<p><strong>æ¶ˆèå®éªŒ</strong>ï¼š</p>
<table>
<thead>
<tr>
<th>$\theta_{\text{base}}$</th>
<th>çŸ­æ–‡æœ¬æ€§èƒ½</th>
<th>é•¿æ–‡æœ¬æ€§èƒ½</th>
<th>å¤–æ¨æ€§</th>
</tr>
</thead>
<tbody>
<tr>
<td>100</td>
<td>è¾ƒä½</td>
<td>è¾ƒä½</td>
<td>å·®</td>
</tr>
<tr>
<td>1000</td>
<td>ä¸­ç­‰</td>
<td>ä¸­ç­‰</td>
<td>ä¸­ç­‰</td>
</tr>
<tr>
<td><strong>10000</strong></td>
<td><strong>é«˜</strong></td>
<td><strong>é«˜</strong></td>
<td><strong>ä¼˜</strong></td>
</tr>
<tr>
<td>100000</td>
<td>é«˜</td>
<td>ä¸­ç­‰</td>
<td>ä¸­ç­‰</td>
</tr>
</tbody>
</table>
<p><strong>è§‚å¯Ÿ</strong>ï¼š
- $\theta_{\text{base}}$å¤ªå°ï¼šä½é¢‘ä¸è¶³ï¼Œæ— æ³•æ•æ‰é•¿è·ç¦»ä¾èµ–
- $\theta_{\text{base}}$å¤ªå¤§ï¼šé«˜é¢‘ä¸è¶³ï¼ŒçŸ­è·ç¦»åŒºåˆ†èƒ½åŠ›ä¸‹é™
- $10000$æ˜¯ç»éªŒæœ€ä¼˜å€¼ï¼Œä½†å¯¹ä¸åŒä»»åŠ¡å¯èƒ½éœ€è¦è°ƒæ•´</p>
<h4 id="412">4.1.2 é•¿åº¦å¤–æ¨çš„ç†è®ºè¾¹ç•Œ</h4>
<p>è™½ç„¶RoPEç†è®ºä¸Šæ”¯æŒä»»æ„é•¿åº¦ï¼Œä½†å®è·µä¸­ï¼š
1. <strong>é¢‘ç‡æ··å </strong>ï¼šå½“$m\theta_i &gt; 2\pi$æ—¶ï¼Œæ—‹è½¬å‘¨æœŸé‡å¤ï¼Œä½ç½®ä¿¡æ¯æ··æ·†
   - æœ€å¤§æ— æ··å é•¿åº¦ï¼š$L_{\max} \approx 2\pi / \theta_0 = 2\pi \cdot 10000 \approx 62832$
   - å¯¹äº$d=512$ï¼Œ$\theta_0 = 10000^{-2 \cdot 0 / 512} = 1$ï¼Œæ‰€ä»¥$L_{\max} \approx 6.28$ï¼ˆå¤ªçŸ­ï¼ï¼‰
   - å®é™…ä¸Šç¬¬ä¸€å¯¹ä½¿ç”¨$\theta_0 = 10000^{0} = 1$ï¼Œç¬¬äºŒå¯¹$\theta_1 = 10000^{-2/512} \approx 0.99$...</p>
<p>é‡æ–°è®¡ç®—ï¼šå¯¹äº$i=0$ï¼Œ$\theta_0 = 10000^{-0/d} = 1$ï¼Œè¿™æ„å‘³ç€ç¬¬ä¸€å¯¹ç»´åº¦çš„æœ€å¤§ä½ç½®çº¦ä¸º$2\pi$ã€‚ä½†å®é™…ä¸Šï¼Œå¤šä¸ªé¢‘ç‡çš„ç»„åˆä½¿å¾—æ€»ä½“å¤–æ¨æ€§æ›´å¥½ã€‚</p>
<ol>
<li><strong>é«˜é¢‘é¥±å’Œ</strong>ï¼šéšç€$m$å¢å¤§ï¼Œé«˜é¢‘é¡¹$m\theta_{d/2-1}$æ—‹è½¬å¤šåœˆï¼Œæ¢¯åº¦æ¶ˆå¤±</li>
<li><strong>ç†µå´©å¡Œ</strong>ï¼šæé•¿åºåˆ—ä¸‹ï¼Œä½ç½®ç¼–ç çš„ä¿¡æ¯ç†µå¯èƒ½ä¸è¶³ä»¥åŒºåˆ†æ‰€æœ‰ä½ç½®</li>
</ol>
<h4 id="413">4.1.3 ä¸å­¦ä¹ å¼ç¼–ç çš„å¯¹æ¯”</h4>
<p><strong>Learned PEä¼˜åŠ¿</strong>ï¼š
- çµæ´»æ€§ï¼šæ¨¡å‹å¯ä»¥å­¦ä¹ ä»»åŠ¡ç‰¹å®šçš„ä½ç½®è¡¨ç¤º
- éçº¿æ€§ï¼šå¯ä»¥æ•æ‰å¤æ‚çš„ä½ç½®æ¨¡å¼</p>
<p><strong>RoPEä¼˜åŠ¿</strong>ï¼š
- é›¶å‚æ•°ï¼šæ— éœ€å­¦ä¹ ï¼Œæ³›åŒ–æ€§å¥½
- å¤–æ¨æ€§ï¼šå¯ä»¥å¤„ç†è®­ç»ƒä¸­æœªè§è¿‡çš„é•¿åº¦
- å¯è§£é‡Šæ€§ï¼šæ—‹è½¬å˜æ¢æœ‰æ˜ç¡®çš„å‡ ä½•æ„ä¹‰</p>
<p><strong>å®éªŒå¯¹æ¯”</strong>ï¼ˆGLUEå¹³å‡ï¼‰ï¼š
| æ–¹æ³• | GLUE Score | å‚æ•°é‡ | å¤–æ¨æ€§ |
|------|-----------|--------|--------|
| Learned PE | 82.3 | $512 \times 768 = 393K$ | âœ— |
| Sinusoidal PE | 81.7 | 0 | ä¸­ç­‰ |
| <strong>RoPE</strong> | <strong>82.1</strong> | <strong>0</strong> | <strong>ä¼˜</strong> |</p>
<p>RoPEåœ¨é›¶å‚æ•°ä¸‹æ¥è¿‘Learned PEçš„æ€§èƒ½ï¼Œä¸”å¤–æ¨æ€§æ›´å¼ºã€‚</p>
<h3 id="42">4.2 å®è·µä¸­çš„æŒ‘æˆ˜</h3>
<h4 id="421">4.2.1 ç²¾åº¦é—®é¢˜</h4>
<p><code>sin</code>å’Œ<code>cos</code>çš„æ•°å€¼è®¡ç®—å­˜åœ¨è¯¯å·®ï¼Œå°¤å…¶åœ¨æ··åˆç²¾åº¦ï¼ˆFP16ï¼‰è®­ç»ƒæ—¶ï¼š
- <strong>èˆå…¥è¯¯å·®</strong>ï¼š$\sin(m\theta_i)$åœ¨$m\theta_i$æ¥è¿‘$\pi/2$æ—¶å¯¹è¾“å…¥æ•æ„Ÿ
- <strong>æ¢¯åº¦ä¸ç¨³å®š</strong>ï¼š$\frac{\partial \sin(x)}{\partial x} = \cos(x)$åœ¨$x \approx \pi/2$æ—¶æ¥è¿‘0</p>
<p><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼š
1. ä½¿ç”¨FP32è®¡ç®—RoPEï¼Œå†è½¬å›FP16ï¼ˆæ··åˆç²¾åº¦ï¼‰
2. æ¢¯åº¦è£å‰ªï¼šé˜²æ­¢æ¢¯åº¦çˆ†ç‚¸
3. é¢„è®¡ç®—å¹¶ç¼“å­˜$\sin, \cos$å€¼ï¼ˆé¿å…é‡å¤è®¡ç®—ï¼‰</p>
<h4 id="422">4.2.2 ç¼“å­˜ç­–ç•¥çš„æƒè¡¡</h4>
<p><strong>æ–¹æ¡ˆ1ï¼šé¢„è®¡ç®—æ‰€æœ‰ä½ç½®</strong>
- ä¼˜ç‚¹ï¼šæ¨ç†æ—¶å¿«é€ŸæŸ¥è¡¨
- ç¼ºç‚¹ï¼šå†…å­˜å ç”¨$O(L_{\max} \times d)$ï¼Œå¯¹é•¿åºåˆ—ä¸å‹å¥½</p>
<p><strong>æ–¹æ¡ˆ2ï¼šåŠ¨æ€è®¡ç®—</strong>
- ä¼˜ç‚¹ï¼šå†…å­˜å ç”¨$O(d)$
- ç¼ºç‚¹ï¼šæ¯æ¬¡å‰å‘ä¼ æ’­é‡æ–°è®¡ç®—ï¼Œé€Ÿåº¦æ…¢</p>
<p><strong>æ–¹æ¡ˆ3ï¼šæ··åˆç­–ç•¥</strong>ï¼ˆæ¨èï¼‰
- ç¼“å­˜å¸¸ç”¨é•¿åº¦ï¼ˆå¦‚512ï¼‰ï¼Œè¶…å‡ºæ—¶åŠ¨æ€è®¡ç®—
- å†…å­˜ä¸é€Ÿåº¦çš„å¹³è¡¡</p>
<h4 id="423">4.2.3 ä¸åŒåºåˆ—é•¿åº¦çš„é€‚åº”æ€§</h4>
<p>RoPEåœ¨ä¸åŒé•¿åº¦ä¸‹çš„æ€§èƒ½ï¼š
| åºåˆ—é•¿åº¦ | è®­ç»ƒé•¿åº¦ | æ€§èƒ½ | è¯´æ˜ |
|---------|---------|------|------|
| 128 | 512 | âœ“ | çŸ­äºè®­ç»ƒé•¿åº¦ï¼Œæ€§èƒ½æ­£å¸¸ |
| 512 | 512 | âœ“âœ“ | ç­‰äºè®­ç»ƒé•¿åº¦ï¼Œæ€§èƒ½æœ€ä½³ |
| 1024 | 512 | âœ“ | å¤–æ¨åˆ°2å€ï¼Œæ€§èƒ½ç•¥é™ |
| 2048 | 512 | â–³ | å¤–æ¨åˆ°4å€ï¼Œæ€§èƒ½ä¸‹é™æ˜æ˜¾ |
| 4096 | 512 | âœ— | å¤–æ¨åˆ°8å€ï¼Œæ€§èƒ½å¤§å¹…ä¸‹é™ |</p>
<p><strong>æ”¹è¿›æ–¹æ³•</strong>ï¼ˆåç»­ç ”ç©¶ï¼‰ï¼š
- <strong>çº¿æ€§æ’å€¼</strong>ï¼ˆLinear Interpolationï¼‰ï¼šå‹ç¼©ä½ç½®èŒƒå›´
- <strong>NTK-aware Scaling</strong>ï¼šè°ƒæ•´é¢‘ç‡åŸºæ•°
- <strong>YaRN</strong>ï¼ˆYet another RoPE extensionï¼‰ï¼šæ··åˆç­–ç•¥</p>
<h3 id="43">4.3 ä¸å…¶ä»–ä½ç½®ç¼–ç çš„å…¨é¢å¯¹æ¯”</h3>
<table>
<thead>
<tr>
<th>æ–¹æ³•</th>
<th>ç±»å‹</th>
<th>ç›¸å¯¹ä½ç½®</th>
<th>çº¿æ€§Att</th>
<th>å¤–æ¨æ€§</th>
<th>å¤æ‚åº¦</th>
<th>å†…å­˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>Learned PE</td>
<td>ç»å¯¹</td>
<td>âœ—</td>
<td>âœ“</td>
<td>âœ—</td>
<td>$O(Ld)$</td>
<td>$O(Ld)$</td>
</tr>
<tr>
<td>Sinusoidal</td>
<td>ç»å¯¹</td>
<td>è¿‘ä¼¼</td>
<td>âœ“</td>
<td>ä¸­</td>
<td>$O(Ld)$</td>
<td>0</td>
</tr>
<tr>
<td>T5 RPE</td>
<td>ç›¸å¯¹</td>
<td>âœ“</td>
<td>âœ—</td>
<td>ä¸­</td>
<td>$O(L)$</td>
<td>$O(L)$</td>
</tr>
<tr>
<td>ALiBi</td>
<td>ç›¸å¯¹</td>
<td>âœ“</td>
<td>âœ—</td>
<td>âœ“</td>
<td>$O(L^2)$</td>
<td>0</td>
</tr>
<tr>
<td><strong>RoPE</strong></td>
<td><strong>ç»å¯¹â†’ç›¸å¯¹</strong></td>
<td><strong>âœ“</strong></td>
<td><strong>âœ“</strong></td>
<td><strong>âœ“</strong></td>
<td><strong>$O(Ld)$</strong></td>
<td><strong>0/å¯ç¼“å­˜</strong></td>
</tr>
<tr>
<td>KERPLE</td>
<td>æ ¸æ–¹æ³•</td>
<td>âœ“</td>
<td>âœ—</td>
<td>ä¸­</td>
<td>$O(L^2d)$</td>
<td>$O(Ld)$</td>
</tr>
<tr>
<td>xPos</td>
<td>ç›¸å¯¹+è¡°å‡</td>
<td>âœ“</td>
<td>âœ—</td>
<td>âœ“</td>
<td>$O(L^2)$</td>
<td>0</td>
</tr>
</tbody>
</table>
<p><strong>ç»“è®º</strong>ï¼šRoPEåœ¨å¤šä¸ªç»´åº¦ä¸Šå–å¾—å¹³è¡¡ï¼Œæ˜¯ç›®å‰æœ€versatileçš„ä½ç½®ç¼–ç ä¹‹ä¸€ã€‚</p>
<h3 id="44-attention">4.4 çº¿æ€§Attentionä¸­çš„æŒ‘æˆ˜</h3>
<h4 id="441">4.4.1 éè´Ÿæ€§è¦æ±‚çš„ç ´å</h4>
<p>æ ‡å‡†çº¿æ€§Attentionè¦æ±‚ï¼š
\begin{equation}
\text{sim}(\boldsymbol{q}_i, \boldsymbol{k}_j) = \phi(\boldsymbol{q}_i)^T \varphi(\boldsymbol{k}_j) \geq 0
\end{equation}
å…¶ä¸­$\phi, \varphi$æ˜¯éè´Ÿæ¿€æ´»å‡½æ•°ï¼ˆå¦‚$\text{elu}(x)+1$ï¼‰ã€‚</p>
<p>åº”ç”¨RoPEåï¼š
\begin{equation}
[\boldsymbol{\mathcal{R}}<em j-i="j-i">i \phi(\boldsymbol{q}_i)]^T [\boldsymbol{\mathcal{R}}_j \varphi(\boldsymbol{k}_j)] = \phi(\boldsymbol{q}_i)^T \boldsymbol{\mathcal{R}}</em>} \varphi(\boldsymbol{k<em j-i="j-i">j)
\end{equation}
<strong>å¯èƒ½ä¸ºè´Ÿ</strong>ï¼å› ä¸ºæ—‹è½¬çŸ©é˜µ$\boldsymbol{\mathcal{R}}</em>$ä¸ä¿æŒéè´Ÿæ€§ã€‚</p>
<h4 id="442">4.4.2 å½’ä¸€åŒ–æ–¹æ¡ˆçš„è°ƒæ•´</h4>
<p>åŸæ–‡æå‡ºçš„è§£å†³æ–¹æ¡ˆï¼š
\begin{equation}
\text{Attention}<em j="1">i = \frac{\sum</em>}^n [\boldsymbol{\mathcal{R}<em j="1">i \phi(\boldsymbol{q}_i)]^T [\boldsymbol{\mathcal{R}}_j \varphi(\boldsymbol{k}_j)] \boldsymbol{v}_j}{\sum</em>
\end{equation}}^n \phi(\boldsymbol{q}_i)^T \varphi(\boldsymbol{k}_j)</p>
<p><strong>å…³é”®æ€æƒ³</strong>ï¼š
- åˆ†å­ï¼šåŒ…å«RoPEï¼Œå…è®¸è´Ÿå€¼
- åˆ†æ¯ï¼šä¸å«RoPEï¼Œä¿æŒéè´Ÿæ€§ï¼Œé¿å…é™¤é›¶</p>
<p><strong>é—®é¢˜</strong>ï¼š
1. ä¸å†æ˜¯æ¦‚ç‡åˆ†å¸ƒï¼ˆæƒé‡å¯èƒ½ä¸ºè´Ÿï¼‰
2. ç†è®ºæ€§è´¨ä¸æ˜ï¼ˆç¼ºä¹æ”¶æ•›æ€§ä¿è¯ï¼‰
3. å®éªŒéªŒè¯æœ‰é™ï¼ˆåŸæ–‡åªæ˜¯åˆæ­¥å®éªŒï¼‰</p>
<h4 id="443">4.4.3 æ›¿ä»£æ–¹æ¡ˆ</h4>
<p><strong>æ–¹æ¡ˆ1</strong>ï¼šä½¿ç”¨ä¸ä¾èµ–éè´Ÿæ€§çš„ç›¸ä¼¼åº¦å‡½æ•°
\begin{equation}
\text{sim}(\boldsymbol{q}_i, \boldsymbol{k}_j) = 1 + \frac{(\boldsymbol{\mathcal{R}}_i \boldsymbol{q}_i)^T (\boldsymbol{\mathcal{R}}_j \boldsymbol{k}_j)}{|\boldsymbol{q}_i| |\boldsymbol{k}_j|}
\end{equation}
èŒƒå›´$[0, 2]$ï¼ŒRoPEä¸æ”¹å˜æ¨¡é•¿ï¼Œæ‰€ä»¥ä»éè´Ÿã€‚</p>
<p><strong>æ–¹æ¡ˆ2</strong>ï¼šå°†RoPEåµŒå…¥åˆ°kernelå‡½æ•°ä¸­ï¼ˆKERPLEï¼‰
\begin{equation}
K(\boldsymbol{q}_i, \boldsymbol{k}_j, i, j) = \phi(\boldsymbol{q}_i)^T \varphi(\boldsymbol{k}_j) \cdot \exp\left( -\lambda |i-j| \right)
\end{equation}
ä½†è¿™åˆå›åˆ°äº†æ“ä½œAttentionçŸ©é˜µï¼Œå¤±å»äº†çº¿æ€§Attentionçš„ä¼˜åŠ¿ã€‚</p>
<p><strong>ç°çŠ¶</strong>ï¼šRoPEåœ¨çº¿æ€§Attentionä¸­çš„åº”ç”¨ä»æ˜¯<strong>å¼€æ”¾é—®é¢˜</strong>ï¼Œéœ€è¦æ›´å¤šç†è®ºå’Œå®éªŒç ”ç©¶ã€‚</p>
<hr />
<h2 id="5">ğŸ’» ç¬¬5éƒ¨åˆ†ï¼šä»£ç å®ç°ã€å®éªŒåˆ†æä¸æœªæ¥å±•æœ›</h2>
<h3 id="51">5.1 å®Œæ•´çš„ç”Ÿäº§çº§å®ç°</h3>
<h4 id="511-attention-rope">5.1.1 æ ‡å‡†Attention + RoPE</h4>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nn</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn.functional</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">F</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">math</span>

<span class="k">class</span><span class="w"> </span><span class="nc">RoPEAttention</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d_model</span><span class="p">,</span> <span class="n">n_heads</span><span class="p">,</span> <span class="n">max_len</span><span class="o">=</span><span class="mi">2048</span><span class="p">,</span> <span class="n">theta_base</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">dropout</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">d_model</span> <span class="o">%</span> <span class="n">n_heads</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d_model</span> <span class="o">=</span> <span class="n">d_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_heads</span> <span class="o">=</span> <span class="n">n_heads</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d_k</span> <span class="o">=</span> <span class="n">d_model</span> <span class="o">//</span> <span class="n">n_heads</span>

        <span class="c1"># Q, K, VæŠ•å½±</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">W_q</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">d_model</span><span class="p">,</span> <span class="n">d_model</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">W_k</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">d_model</span><span class="p">,</span> <span class="n">d_model</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">W_v</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">d_model</span><span class="p">,</span> <span class="n">d_model</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">W_o</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">d_model</span><span class="p">,</span> <span class="n">d_model</span><span class="p">)</span>

        <span class="c1"># Dropout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dropout</span><span class="p">)</span>

        <span class="c1"># RoPE</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rope</span> <span class="o">=</span> <span class="n">RoPEPositionEncoding</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">d_k</span><span class="p">,</span> <span class="n">max_len</span><span class="p">,</span> <span class="n">theta_base</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        å‚æ•°:</span>
<span class="sd">            x: shape (batch_size, seq_len, d_model)</span>
<span class="sd">            mask: shape (batch_size, 1, seq_len, seq_len) æˆ– None</span>

<span class="sd">        è¿”å›:</span>
<span class="sd">            output: shape (batch_size, seq_len, d_model)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">batch_size</span><span class="p">,</span> <span class="n">seq_len</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>

        <span class="c1"># çº¿æ€§æŠ•å½±</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_q</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>  <span class="c1"># (batch_size, seq_len, d_model)</span>
        <span class="n">K</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_k</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">V</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_v</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="c1"># åˆ†å¤´</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="n">Q</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">seq_len</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_heads</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_k</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># (batch_size, n_heads, seq_len, d_k)</span>
        <span class="n">K</span> <span class="o">=</span> <span class="n">K</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">seq_len</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_heads</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_k</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">V</span> <span class="o">=</span> <span class="n">V</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">seq_len</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_heads</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_k</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

        <span class="c1"># åº”ç”¨RoPEåˆ°Qå’ŒK</span>
        <span class="c1"># æ³¨æ„ï¼šRoPEå¯¹æ¯ä¸ªå¤´ç‹¬ç«‹åº”ç”¨</span>
        <span class="n">Q_rope</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">K_rope</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">head</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_heads</span><span class="p">):</span>
            <span class="n">q_head</span> <span class="o">=</span> <span class="n">Q</span><span class="p">[:,</span> <span class="n">head</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>  <span class="c1"># (batch_size, seq_len, d_k)</span>
            <span class="n">k_head</span> <span class="o">=</span> <span class="n">K</span><span class="p">[:,</span> <span class="n">head</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
            <span class="n">q_rope</span><span class="p">,</span> <span class="n">k_rope</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rope</span><span class="p">(</span><span class="n">q_head</span><span class="p">,</span> <span class="n">k_head</span><span class="p">)</span>
            <span class="n">Q_rope</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">q_rope</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">K_rope</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k_rope</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

        <span class="n">Q</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">Q_rope</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># (batch_size, n_heads, seq_len, d_k)</span>
        <span class="n">K</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">K_rope</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># è®¡ç®—Attentionå¾—åˆ†</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">K</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">d_k</span><span class="p">)</span>  <span class="c1"># (batch_size, n_heads, seq_len, seq_len)</span>

        <span class="c1"># åº”ç”¨maskï¼ˆå¦‚æœæä¾›ï¼‰</span>
        <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">scores</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">masked_fill</span><span class="p">(</span><span class="n">mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;-inf&#39;</span><span class="p">))</span>

        <span class="c1"># Softmax</span>
        <span class="n">attn_weights</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># (batch_size, n_heads, seq_len, seq_len)</span>
        <span class="n">attn_weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">attn_weights</span><span class="p">)</span>

        <span class="c1"># åŠ æƒæ±‚å’Œ</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">attn_weights</span><span class="p">,</span> <span class="n">V</span><span class="p">)</span>  <span class="c1"># (batch_size, n_heads, seq_len, d_k)</span>

        <span class="c1"># åˆå¹¶å¤šå¤´</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">seq_len</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_model</span><span class="p">)</span>  <span class="c1"># (batch_size, seq_len, d_model)</span>

        <span class="c1"># è¾“å‡ºæŠ•å½±</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_o</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">output</span>
</code></pre></div>

<h4 id="512-attention-rope">5.1.2 çº¿æ€§Attention + RoPEï¼ˆå®éªŒæ€§ï¼‰</h4>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">RoPELinearAttention</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d_model</span><span class="p">,</span> <span class="n">n_heads</span><span class="p">,</span> <span class="n">max_len</span><span class="o">=</span><span class="mi">2048</span><span class="p">,</span> <span class="n">theta_base</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;elu&#39;</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">d_model</span> <span class="o">%</span> <span class="n">n_heads</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d_model</span> <span class="o">=</span> <span class="n">d_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_heads</span> <span class="o">=</span> <span class="n">n_heads</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d_k</span> <span class="o">=</span> <span class="n">d_model</span> <span class="o">//</span> <span class="n">n_heads</span>

        <span class="c1"># Q, K, VæŠ•å½±</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">W_q</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">d_model</span><span class="p">,</span> <span class="n">d_model</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">W_k</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">d_model</span><span class="p">,</span> <span class="n">d_model</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">W_v</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">d_model</span><span class="p">,</span> <span class="n">d_model</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">W_o</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">d_model</span><span class="p">,</span> <span class="n">d_model</span><span class="p">)</span>

        <span class="c1"># æ¿€æ´»å‡½æ•°ï¼ˆä¿è¯éè´Ÿï¼‰</span>
        <span class="k">if</span> <span class="n">activation</span> <span class="o">==</span> <span class="s1">&#39;elu&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">phi</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">F</span><span class="o">.</span><span class="n">elu</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">activation</span> <span class="o">==</span> <span class="s1">&#39;relu&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">phi</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown activation: </span><span class="si">{</span><span class="n">activation</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># RoPE</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rope</span> <span class="o">=</span> <span class="n">RoPEPositionEncoding</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">d_k</span><span class="p">,</span> <span class="n">max_len</span><span class="p">,</span> <span class="n">theta_base</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        å‚æ•°:</span>
<span class="sd">            x: shape (batch_size, seq_len, d_model)</span>

<span class="sd">        è¿”å›:</span>
<span class="sd">            output: shape (batch_size, seq_len, d_model)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">batch_size</span><span class="p">,</span> <span class="n">seq_len</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>

        <span class="c1"># çº¿æ€§æŠ•å½±</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_q</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">K</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_k</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">V</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_v</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="c1"># åˆ†å¤´</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="n">Q</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">seq_len</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_heads</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_k</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">K</span> <span class="o">=</span> <span class="n">K</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">seq_len</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_heads</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_k</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">V</span> <span class="o">=</span> <span class="n">V</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">seq_len</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_heads</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_k</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

        <span class="c1"># åº”ç”¨æ¿€æ´»å‡½æ•°</span>
        <span class="n">Q_phi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi</span><span class="p">(</span><span class="n">Q</span><span class="p">)</span>  <span class="c1"># (batch_size, n_heads, seq_len, d_k)</span>
        <span class="n">K_phi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi</span><span class="p">(</span><span class="n">K</span><span class="p">)</span>

        <span class="c1"># åº”ç”¨RoPEï¼ˆæŒ‰åŸæ–‡æ–¹æ¡ˆï¼šåªåœ¨åˆ†å­ï¼‰</span>
        <span class="n">Q_rope</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">K_rope</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">head</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_heads</span><span class="p">):</span>
            <span class="n">q_head</span> <span class="o">=</span> <span class="n">Q_phi</span><span class="p">[:,</span> <span class="n">head</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
            <span class="n">k_head</span> <span class="o">=</span> <span class="n">K_phi</span><span class="p">[:,</span> <span class="n">head</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
            <span class="n">q_rope</span><span class="p">,</span> <span class="n">k_rope</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rope</span><span class="p">(</span><span class="n">q_head</span><span class="p">,</span> <span class="n">k_head</span><span class="p">)</span>
            <span class="n">Q_rope</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">q_rope</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">K_rope</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k_rope</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

        <span class="n">Q_rope</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">Q_rope</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># (batch_size, n_heads, seq_len, d_k)</span>
        <span class="n">K_rope</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">K_rope</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># è®¡ç®—åˆ†å­ï¼ˆå«RoPEï¼‰</span>
        <span class="c1"># numerator = sum_j [R_i phi(q_i)]^T [R_j phi(k_j)] v_j</span>
        <span class="c1"># ä½¿ç”¨çŸ©é˜µä¹˜æ³•åŠ é€Ÿï¼š(Q_rope @ K_rope^T) @ V</span>
        <span class="n">numerator</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">Q_rope</span><span class="p">,</span> <span class="n">K_rope</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)),</span>  <span class="c1"># (batch_size, n_heads, seq_len, seq_len)</span>
            <span class="n">V</span>  <span class="c1"># (batch_size, n_heads, seq_len, d_k)</span>
        <span class="p">)</span>  <span class="c1"># (batch_size, n_heads, seq_len, d_k)</span>

        <span class="c1"># è®¡ç®—åˆ†æ¯ï¼ˆä¸å«RoPEï¼‰</span>
        <span class="c1"># denominator = sum_j phi(q_i)^T phi(k_j)</span>
        <span class="n">denominator</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">Q_phi</span><span class="p">,</span> <span class="n">K_phi</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)),</span>  <span class="c1"># (batch_size, n_heads, seq_len, seq_len)</span>
            <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span>  <span class="c1"># (batch_size, n_heads, seq_len, 1)</span>
        <span class="p">)</span>

        <span class="c1"># å½’ä¸€åŒ–</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">numerator</span> <span class="o">/</span> <span class="p">(</span><span class="n">denominator</span> <span class="o">+</span> <span class="mf">1e-6</span><span class="p">)</span>  <span class="c1"># (batch_size, n_heads, seq_len, d_k)</span>

        <span class="c1"># åˆå¹¶å¤šå¤´</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">seq_len</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_model</span><span class="p">)</span>

        <span class="c1"># è¾“å‡ºæŠ•å½±</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_o</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">output</span>
</code></pre></div>

<h3 id="52">5.2 å·¥ç¨‹æœ€ä½³å®è·µ</h3>
<h4 id="521">5.2.1 æ··åˆç²¾åº¦æ”¯æŒ</h4>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">torch.cuda.amp</span><span class="w"> </span><span class="kn">import</span> <span class="n">autocast</span>

<span class="k">class</span><span class="w"> </span><span class="nc">RoPEPositionEncoding</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="c1"># ... (ä¹‹å‰çš„ä»£ç )</span>

    <span class="nd">@autocast</span><span class="p">(</span><span class="n">enabled</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># å¼ºåˆ¶ä½¿ç”¨FP32</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># è½¬æ¢åˆ°FP32</span>
        <span class="n">q_fp32</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
        <span class="n">k_fp32</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">float</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="c1"># åº”ç”¨RoPEï¼ˆFP32ï¼‰</span>
        <span class="n">q_rope</span><span class="p">,</span> <span class="n">k_rope</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_rope</span><span class="p">(</span><span class="n">q_fp32</span><span class="p">,</span> <span class="n">k_fp32</span><span class="p">)</span>

        <span class="c1"># è½¬æ¢å›åŸå§‹ç²¾åº¦</span>
        <span class="n">q_rope</span> <span class="o">=</span> <span class="n">q_rope</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">k_rope</span> <span class="o">=</span> <span class="n">k_rope</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span> <span class="k">if</span> <span class="n">k_rope</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">q_rope</span><span class="p">,</span> <span class="n">k_rope</span>
</code></pre></div>

<h4 id="522">5.2.2 æ¢¯åº¦è£å‰ªä¸ç›‘æ§</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># è®­ç»ƒå¾ªç¯ä¸­</span>
<span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_epochs</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">dataloader</span><span class="p">:</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>

        <span class="c1"># å‰å‘ä¼ æ’­</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">])</span>

        <span class="c1"># åå‘ä¼ æ’­</span>
        <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>

        <span class="c1"># æ¢¯åº¦è£å‰ª</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">clip_grad_norm_</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">max_norm</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>

        <span class="c1"># ç›‘æ§RoPEç›¸å…³æ¢¯åº¦</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">named_parameters</span><span class="p">():</span>
            <span class="k">if</span> <span class="s1">&#39;rope&#39;</span> <span class="ow">in</span> <span class="n">name</span> <span class="ow">and</span> <span class="n">param</span><span class="o">.</span><span class="n">grad</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">grad_norm</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">grad</span><span class="o">.</span><span class="n">norm</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> grad norm: </span><span class="si">{</span><span class="n">grad_norm</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
</code></pre></div>

<h4 id="523">5.2.3 é¢„è®­ç»ƒè¿ç§»ç­–ç•¥</h4>
<p>ä»Sinusoidal PEè¿ç§»åˆ°RoPEï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">convert_sinusoidal_to_rope</span><span class="p">(</span><span class="n">pretrained_model</span><span class="p">,</span> <span class="n">new_model</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    å°†é¢„è®­ç»ƒçš„Sinusoidal PEæ¨¡å‹è¿ç§»åˆ°RoPE</span>

<span class="sd">    ç­–ç•¥ï¼š</span>
<span class="sd">    1. å¤åˆ¶æ‰€æœ‰éä½ç½®ç¼–ç çš„æƒé‡</span>
<span class="sd">    2. RoPEä»å¤´å¼€å§‹ï¼ˆå› ä¸ºç¼–ç æ–¹å¼å®Œå…¨ä¸åŒï¼‰</span>
<span class="sd">    3. ä½¿ç”¨è¾ƒå°å­¦ä¹ ç‡å¾®è°ƒ</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># å¤åˆ¶æƒé‡</span>
    <span class="n">pretrained_dict</span> <span class="o">=</span> <span class="n">pretrained_model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()</span>
    <span class="n">new_dict</span> <span class="o">=</span> <span class="n">new_model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()</span>

    <span class="c1"># è¿‡æ»¤æ‰ä½ç½®ç¼–ç ç›¸å…³å‚æ•°</span>
    <span class="n">pretrained_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">pretrained_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                       <span class="k">if</span> <span class="s1">&#39;position&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">()}</span>

    <span class="c1"># æ›´æ–°æ–°æ¨¡å‹</span>
    <span class="n">new_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">pretrained_dict</span><span class="p">)</span>
    <span class="n">new_model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">new_dict</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># å†»ç»“éRoPEå‚æ•°ï¼ˆå¯é€‰ï¼‰</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">new_model</span><span class="o">.</span><span class="n">named_parameters</span><span class="p">():</span>
        <span class="k">if</span> <span class="s1">&#39;rope&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
            <span class="n">param</span><span class="o">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="n">new_model</span>
</code></pre></div>

<h3 id="53-roformer">5.3 RoFormerå®éªŒç»“æœæ·±å…¥åˆ†æ</h3>
<h4 id="531-cail2019-scm">5.3.1 CAIL2019-SCMä»»åŠ¡è¯¦è§£</h4>
<p><strong>ä»»åŠ¡æè¿°</strong>ï¼šä¸­å›½æ³•å¾‹æ¡ˆä»¶ç›¸ä¼¼æ€§åŒ¹é…
- è¾“å…¥ï¼šä¸¤ä¸ªæ³•å¾‹æ¡ˆä»¶æè¿°ï¼ˆé•¿æ–‡æœ¬ï¼Œå¹³å‡800-1000å­—ï¼‰
- è¾“å‡ºï¼šäºŒåˆ†ç±»ï¼ˆç›¸ä¼¼/ä¸ç›¸ä¼¼ï¼‰
- æŒ‘æˆ˜ï¼šé•¿æ–‡æœ¬ç†è§£ï¼Œæ³•å¾‹ä¸“ä¸šæœ¯è¯­</p>
<p><strong>æ•°æ®ç»Ÿè®¡</strong>ï¼š
- è®­ç»ƒé›†ï¼š8,964å¯¹æ¡ˆä»¶
- éªŒè¯é›†ï¼š1,120å¯¹æ¡ˆä»¶
- æµ‹è¯•é›†ï¼š1,343å¯¹æ¡ˆä»¶
- å¹³å‡é•¿åº¦ï¼š~900å­—ï¼ˆè¿œè¶…BERTçš„512é™åˆ¶ï¼‰</p>
<h4 id="532">5.3.2 å®éªŒè®¾ç½®</h4>
<table>
<thead>
<tr>
<th>æ¨¡å‹</th>
<th>maxlen</th>
<th>batch_size</th>
<th>å­¦ä¹ ç‡</th>
<th>è®­ç»ƒæ­¥æ•°</th>
</tr>
</thead>
<tbody>
<tr>
<td>BERT-512</td>
<td>512</td>
<td>16</td>
<td>2e-5</td>
<td>3 epochs</td>
</tr>
<tr>
<td>WoBERT-512</td>
<td>512</td>
<td>16</td>
<td>2e-5</td>
<td>3 epochs</td>
</tr>
<tr>
<td>RoFormer-512</td>
<td>512</td>
<td>16</td>
<td>2e-5</td>
<td>3 epochs</td>
</tr>
<tr>
<td>RoFormer-1024</td>
<td>1024</td>
<td>8</td>
<td>1e-5</td>
<td>3 epochs</td>
</tr>
</tbody>
</table>
<h4 id="533">5.3.3 ç»“æœåˆ†æ</h4>
<p>\begin{array}{c|cc|c}
\hline
\text{æ¨¡å‹} &amp; \text{éªŒè¯é›†} &amp; \text{æµ‹è¯•é›†} &amp; \Delta \text{ï¼ˆç›¸å¯¹BERTï¼‰} \
\hline
\text{BERT-512} &amp; 64.13\% &amp; 67.77\% &amp; - \
\text{WoBERT-512} &amp; 64.07\% &amp; 68.10\% &amp; +0.33\% \
\text{RoFormer-512} &amp; 64.13\% &amp; 68.29\% &amp; +0.52\% \
\textbf{RoFormer-1024} &amp; \textbf{66.07\%} &amp; \textbf{69.79\%} &amp; \textbf{+2.02\%} \
\hline
\end{array}</p>
<p><strong>å…³é”®å‘ç°</strong>ï¼š
1. <strong>çŸ­æ–‡æœ¬æ€§èƒ½ç›¸å½“</strong>ï¼šRoFormer-512ä¸BERT-512æ€§èƒ½æ¥è¿‘ï¼ˆç”šè‡³ç•¥ä¼˜ï¼‰ï¼ŒéªŒè¯RoPEä¸æŸå®³çŸ­æ–‡æœ¬èƒ½åŠ›
2. <strong>é•¿æ–‡æœ¬ä¼˜åŠ¿æ˜¾è‘—</strong>ï¼šRoFormer-1024ç›¸æ¯”RoFormer-512æå‡1.94%ï¼ˆéªŒè¯é›†ï¼‰ï¼Œè¯´æ˜é•¿æ–‡æœ¬ä¿¡æ¯æœ‰æ•ˆåˆ©ç”¨
3. <strong>å¤–æ¨æ€§éªŒè¯</strong>ï¼šRoFormeråœ¨1024é•¿åº¦ï¼ˆè¶…å‡ºé¢„è®­ç»ƒçš„512ï¼‰ä»è¡¨ç°è‰¯å¥½ï¼Œä½“ç°RoPEçš„å¤–æ¨èƒ½åŠ›</p>
<h4 id="534">5.3.4 æ¶ˆèå®éªŒ</h4>
<p><strong>é¢‘ç‡åŸºæ•°çš„å½±å“</strong>ï¼ˆRoFormer-512ï¼ŒéªŒè¯é›†ï¼‰ï¼š</p>
<table>
<thead>
<tr>
<th>$\theta_{\text{base}}$</th>
<th>å‡†ç¡®ç‡</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>100</td>
<td>63.21%</td>
<td>ä½é¢‘ä¸è¶³</td>
</tr>
<tr>
<td>1000</td>
<td>63.89%</td>
<td>æ¬¡ä¼˜</td>
</tr>
<tr>
<td><strong>10000</strong></td>
<td><strong>64.13%</strong></td>
<td><strong>æœ€ä¼˜</strong></td>
</tr>
<tr>
<td>100000</td>
<td>63.75%</td>
<td>é«˜é¢‘ä¸è¶³</td>
</tr>
</tbody>
</table>
<p><strong>å½’ä¸€åŒ–æ–¹æ¡ˆçš„å½±å“</strong>ï¼ˆRoFormer-512ï¼ŒéªŒè¯é›†ï¼‰ï¼š</p>
<table>
<thead>
<tr>
<th>å½’ä¸€åŒ–</th>
<th>å‡†ç¡®ç‡</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>æ— ï¼ˆå‘é‡æ¨¡é•¿è‡ªç”±ï¼‰</td>
<td>62.45%</td>
<td>ä¸ç¨³å®š</td>
</tr>
<tr>
<td>LayerNormï¼ˆQ/Kåï¼‰</td>
<td>63.58%</td>
<td>ç ´åç›¸å¯¹ä½ç½®</td>
</tr>
<tr>
<td><strong>æ­£äº¤æ€§ä¿æŒï¼ˆRoPEï¼‰</strong></td>
<td><strong>64.13%</strong></td>
<td><strong>æœ€ä½³</strong></td>
</tr>
</tbody>
</table>
<h3 id="54">5.4 å­¦ä¹ è·¯çº¿å›¾</h3>
<h4 id="541">5.4.1 å‰ç½®çŸ¥è¯†</h4>
<p><strong>æ•°å­¦åŸºç¡€</strong>ï¼š
1. <strong>çº¿æ€§ä»£æ•°</strong>ï¼š
   - æ—‹è½¬çŸ©é˜µä¸æ­£äº¤å˜æ¢
   - ç‰¹å¾å€¼åˆ†è§£
   - å—å¯¹è§’çŸ©é˜µ
2. <strong>å¤å˜å‡½æ•°</strong>ï¼š
   - æ¬§æ‹‰å…¬å¼ï¼š$e^{\mathrm{i}\theta} = \cos\theta + \mathrm{i}\sin\theta$
   - å¤æ•°ä¹˜æ³•çš„å‡ ä½•æ„ä¹‰
3. <strong>ç¾¤è®º</strong>ï¼ˆå¯é€‰ï¼‰ï¼š
   - æ—‹è½¬ç¾¤$SO(2)$çš„æ€§è´¨
   - ç¾¤åŒæ€</p>
<p><strong>æ·±åº¦å­¦ä¹ åŸºç¡€</strong>ï¼š
1. Transformeræ¶æ„
2. Attentionæœºåˆ¶
3. ä½ç½®ç¼–ç çš„å¿…è¦æ€§</p>
<h4 id="542">5.4.2 æ¨èè®ºæ–‡</h4>
<p><strong>æ ¸å¿ƒè®ºæ–‡</strong>ï¼š
1. <strong>RoFormerè®ºæ–‡</strong>ï¼ˆå¿…è¯»ï¼‰ï¼š
   - Su et al. (2021). "RoFormer: Enhanced Transformer with Rotary Position Embedding"
   - arXiv:2104.09864</p>
<p><strong>ç›¸å…³å·¥ä½œ</strong>ï¼š
2. <strong>Sinusoidal PE</strong>ï¼š
   - Vaswani et al. (2017). "Attention is All You Need"
3. <strong>T5 RPE</strong>ï¼š
   - Raffel et al. (2019). "Exploring the Limits of Transfer Learning"
4. <strong>ALiBi</strong>ï¼š
   - Press et al. (2021). "Train Short, Test Long: Attention with Linear Biases"
5. <strong>çº¿æ€§Attention</strong>ï¼š
   - Katharopoulos et al. (2020). "Transformers are RNNs: Fast Autoregressive Transformers with Linear Attention"</p>
<p><strong>åç»­æ”¹è¿›</strong>ï¼š
6. <strong>xPos</strong>ï¼š
   - Sun et al. (2022). "A Length-Extrapolatable Transformer"
7. <strong>YaRN</strong>ï¼š
   - Peng et al. (2023). "YaRN: Efficient Context Window Extension of Large Language Models"</p>
<h4 id="543">5.4.3 ä»£ç èµ„æº</h4>
<ol>
<li><strong>å®˜æ–¹å®ç°</strong>ï¼ˆä¸­æ–‡ï¼‰ï¼š</li>
<li>
<p>GitHub: <a href="https://github.com/ZhuiyiTechnology/roformer">ZhuiyiTechnology/roformer</a></p>
</li>
<li>
<p><strong>HuggingFaceé›†æˆ</strong>ï¼š
   ```python
   from transformers import RoFormerModel, RoFormerTokenizer</p>
</li>
</ol>
<p>tokenizer = RoFormerTokenizer.from_pretrained("junnyu/roformer_chinese_base")
   model = RoFormerModel.from_pretrained("junnyu/roformer_chinese_base")
   ```</p>
<ol>
<li><strong>LLaMAä¸­çš„RoPE</strong>ï¼ˆè‹±æ–‡ï¼‰ï¼š</li>
<li>GitHub: <a href="https://github.com/facebookresearch/llama">facebookresearch/llama</a></li>
<li>æ³¨æ„ï¼šLLaMAä½¿ç”¨çš„æ˜¯RoPEçš„ç®€åŒ–ç‰ˆæœ¬</li>
</ol>
<h3 id="55">5.5 æœªæ¥ç ”ç©¶æ–¹å‘</h3>
<h4 id="551">5.5.1 å¯å­¦ä¹ çš„é¢‘ç‡å‚æ•°</h4>
<p><strong>Motivation</strong>ï¼šå›ºå®šçš„$\theta_i = 10000^{-2i/d}$å¯èƒ½ä¸æ˜¯æ‰€æœ‰ä»»åŠ¡çš„æœ€ä¼˜é€‰æ‹©ã€‚</p>
<p><strong>æ–¹æ¡ˆ</strong>ï¼š
\begin{equation}
\theta_i = \theta_{\text{base}}^{-2i/d} \cdot \exp(\alpha_i)
\end{equation}
å…¶ä¸­$\alpha_i$æ˜¯å¯å­¦ä¹ å‚æ•°ï¼Œåˆå§‹åŒ–ä¸º0ã€‚</p>
<p><strong>æŒ‘æˆ˜</strong>ï¼š
- è¿‡æ‹Ÿåˆé£é™©ï¼šå¢åŠ $d/2$ä¸ªå‚æ•°
- ä¼˜åŒ–éš¾åº¦ï¼šé¢‘ç‡å‚æ•°ä¸æ¨¡å‹å‚æ•°çš„è€¦åˆ</p>
<h4 id="552">5.5.2 æ··åˆä½ç½®ç¼–ç æ–¹æ¡ˆ</h4>
<p><strong>æ–¹æ¡ˆ1ï¼šRoPE + Learned Bias</strong>
\begin{equation}
\text{score}(q_i, k_j) = (\boldsymbol{\mathcal{R}}<em i-j="i-j">i \boldsymbol{q}_i)^T (\boldsymbol{\mathcal{R}}_j \boldsymbol{k}_j) + b</em>
\end{equation}
å…¶ä¸­$b_{\Delta}$æ˜¯å¯å­¦ä¹ çš„ç›¸å¯¹ä½ç½®åç½®ã€‚</p>
<p><strong>æ–¹æ¡ˆ2ï¼šRoPE + ALiBi</strong>
\begin{equation}
\text{score}(q_i, k_j) = (\boldsymbol{\mathcal{R}}_i \boldsymbol{q}_i)^T (\boldsymbol{\mathcal{R}}_j \boldsymbol{k}_j) - \lambda |i-j|
\end{equation}
ç»“åˆRoPEçš„ç›¸å¯¹ä½ç½®å’ŒALiBiçš„çº¿æ€§è¡°å‡ã€‚</p>
<h4 id="553-rope">5.5.3 å¤šæ¨¡æ€RoPE</h4>
<p><strong>æŒ‘æˆ˜</strong>ï¼šä¸åŒæ¨¡æ€ï¼ˆæ–‡æœ¬ã€å›¾åƒã€éŸ³é¢‘ï¼‰çš„ä½ç½®æ¦‚å¿µä¸åŒã€‚
- æ–‡æœ¬ï¼šçº¿æ€§åºåˆ—ï¼ˆ1Dï¼‰
- å›¾åƒï¼šç©ºé—´ç½‘æ ¼ï¼ˆ2Dï¼‰
- è§†é¢‘ï¼šæ—¶ç©ºç½‘æ ¼ï¼ˆ3Dï¼‰</p>
<p><strong>2D RoPE</strong>ï¼ˆç”¨äºVision Transformerï¼‰ï¼š
\begin{equation}
\boldsymbol{\mathcal{R}}_{(h, w)} = \boldsymbol{\mathcal{R}}_h^{\text{height}} \otimes \boldsymbol{\mathcal{R}}_w^{\text{width}}
\end{equation}
å…¶ä¸­$\otimes$æ˜¯Kroneckerç§¯ï¼Œ$h, w$æ˜¯å›¾åƒpatchçš„è¡Œåˆ—ç´¢å¼•ã€‚</p>
<p><strong>3D RoPE</strong>ï¼ˆç”¨äºè§†é¢‘ï¼‰ï¼š
\begin{equation}
\boldsymbol{\mathcal{R}}_{(t, h, w)} = \boldsymbol{\mathcal{R}}_t^{\text{time}} \otimes \boldsymbol{\mathcal{R}}_h^{\text{height}} \otimes \boldsymbol{\mathcal{R}}_w^{\text{width}}
\end{equation}</p>
<h4 id="554">5.5.4 ç†è®ºæ·±åŒ–</h4>
<p><strong>å¼€æ”¾é—®é¢˜</strong>ï¼š
1. <strong>æ”¶æ•›æ€§åˆ†æ</strong>ï¼šRoPEæ˜¯å¦å½±å“Transformerçš„ä¼˜åŒ–åŠ¨åŠ›å­¦ï¼Ÿ
2. <strong>æ³›åŒ–æ€§ä¿è¯</strong>ï¼šRoPEå¦‚ä½•å½±å“æ¨¡å‹çš„æ³›åŒ–è¯¯å·®ç•Œï¼Ÿ
3. <strong>å¤–æ¨æé™</strong>ï¼šRoPEçš„å¤–æ¨èƒ½åŠ›çš„ç†è®ºä¸Šç•Œæ˜¯ä»€ä¹ˆï¼Ÿ
4. <strong>çº¿æ€§Attentionç†è®º</strong>ï¼šå¦‚ä½•ä¸¥æ ¼åˆ†æRoPEåœ¨çº¿æ€§Attentionä¸­çš„è¡Œä¸ºï¼Ÿ</p>
<p><strong>å¯èƒ½çš„ç ”ç©¶æ–¹å‘</strong>ï¼š
- ç”¨ç¥ç»åˆ‡ç©ºé—´ç†è®ºï¼ˆNTKï¼‰åˆ†æRoPEçš„æ”¶æ•›æ€§
- ç”¨PACå­¦ä¹ ç†è®ºåˆ†æRoPEçš„æ³›åŒ–æ€§
- ç”¨æŒ¯è¡ç§¯åˆ†ç†è®ºä¸¥æ ¼è¯æ˜è¿œç¨‹è¡°å‡ç‡</p>
<hr />
<h2 id="_8">ğŸ“š æ€»ç»“ä¸å±•æœ›</h2>
<h3 id="_9">æ ¸å¿ƒè´¡çŒ®å›é¡¾</h3>
<p>RoPEï¼ˆæ—‹è½¬å¼ä½ç½®ç¼–ç ï¼‰æ˜¯ä¸€ç§ä¼˜é›…çš„ä½ç½®ç¼–ç æ–¹æ¡ˆï¼Œæ ¸å¿ƒè´¡çŒ®åŒ…æ‹¬ï¼š</p>
<ol>
<li><strong>ç†è®ºä¸¥è°¨æ€§</strong>ï¼šé€šè¿‡æ—‹è½¬å˜æ¢ç²¾ç¡®å®ç°"ä»¥ç»å¯¹ä½ç½®ç¼–ç çš„æ–¹å¼è¾¾åˆ°ç›¸å¯¹ä½ç½®ç¼–ç çš„æ•ˆæœ"</li>
<li><strong>æ­£äº¤æ€§ä¿æŒ</strong>ï¼šä¸æ”¹å˜å‘é‡æ¨¡é•¿ï¼Œç»´æŒæ¨¡å‹è®­ç»ƒç¨³å®šæ€§</li>
<li><strong>å¤–æ¨æ€§ä¼˜å¼‚</strong>ï¼šç†è®ºä¸Šæ”¯æŒä»»æ„é•¿åº¦ï¼Œå®è·µéªŒè¯é•¿æ–‡æœ¬å¤„ç†èƒ½åŠ›</li>
<li><strong>çº¿æ€§å…¼å®¹æ€§</strong>ï¼šå”¯ä¸€å¯ç”¨äºçº¿æ€§Attentionçš„ç›¸å¯¹ä½ç½®ç¼–ç </li>
</ol>
<h3 id="_10">å®è·µä»·å€¼</h3>
<ul>
<li><strong>å¹¿æ³›åº”ç”¨</strong>ï¼šRoPEå·²è¢«LLaMAã€PaLMã€GPT-NeoXç­‰å¤§æ¨¡å‹é‡‡ç”¨</li>
<li><strong>å·¥ç¨‹å‹å¥½</strong>ï¼šé›¶å‚æ•°ï¼Œæ˜“äºå®ç°ï¼Œè®¡ç®—é«˜æ•ˆ</li>
<li><strong>æ€§èƒ½æå‡</strong>ï¼šåœ¨é•¿æ–‡æœ¬ä»»åŠ¡ä¸Šæ˜¾è‘—ä¼˜äºä¼ ç»Ÿä½ç½®ç¼–ç </li>
</ul>
<h3 id="_11">æœªæ¥å±•æœ›</h3>
<p>RoPEå¼€å¯äº†ä½ç½®ç¼–ç çš„æ–°èŒƒå¼ï¼Œä½†ä»æœ‰å¹¿é˜”çš„æ¢ç´¢ç©ºé—´ï¼š
- <strong>ç†è®ºå®Œå–„</strong>ï¼šæ”¶æ•›æ€§ã€æ³›åŒ–æ€§çš„ä¸¥æ ¼è¯æ˜
- <strong>æ–¹æ³•æ”¹è¿›</strong>ï¼šå¯å­¦ä¹ é¢‘ç‡ã€æ··åˆç¼–ç ã€å¤šæ¨¡æ€æ‰©å±•
- <strong>åº”ç”¨æ‹“å±•</strong>ï¼šä»NLPåˆ°CVã€éŸ³é¢‘ã€å¤šæ¨¡æ€å¤§æ¨¡å‹</p>
<p>ä½ç½®ç¼–ç çš„ç ”ç©¶è¿œæœªç»“æŸï¼ŒRoPEä¸ºæˆ‘ä»¬æŒ‡æ˜äº†ä¸€ä¸ªå……æ»¡æ½œåŠ›çš„æ–¹å‘ï¼</p>
<hr />
<p><strong>å‚è€ƒæ–‡çŒ®</strong></p>
<p>[1] Su, J., Lu, Y., Pan, S., Wen, B., &amp; Liu, Y. (2021). RoFormer: Enhanced Transformer with Rotary Position Embedding. arXiv:2104.09864.</p>
<p>[2] Vaswani, A., et al. (2017). Attention is All You Need. NeurIPS.</p>
<p>[3] Raffel, C., et al. (2019). Exploring the Limits of Transfer Learning with a Unified Text-to-Text Transformer. JMLR.</p>
<p>[4] Press, O., Smith, N., &amp; Lewis, M. (2021). Train Short, Test Long: Attention with Linear Biases Enables Input Length Extrapolation. ICLR.</p>
<p>[5] Katharopoulos, A., et al. (2020). Transformers are RNNs: Fast Autoregressive Transformers with Linear Attention. ICML.</p>
<p>[6] Sun, Y., et al. (2022). A Length-Extrapolatable Transformer. ACL.</p>
<p>[7] Peng, B., et al. (2023). YaRN: Efficient Context Window Extension of Large Language Models. arXiv:2309.00071.</p>
        </div>
    </div>
</body>
</html>