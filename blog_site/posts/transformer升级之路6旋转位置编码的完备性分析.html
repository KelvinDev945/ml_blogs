<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transformerå‡çº§ä¹‹è·¯ï¼š6ã€æ—‹è½¬ä½ç½®ç¼–ç çš„å®Œå¤‡æ€§åˆ†æ</title>
    <style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    line-height: 1.6; color: #333; max-width: 900px; margin: 0 auto; padding: 20px; background: #f5f5f5;
}
.container { background: white; padding: 40px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
header { border-bottom: 2px solid #e0e0e0; padding-bottom: 20px; margin-bottom: 30px; }
h1 { color: #2c3e50; margin-bottom: 10px; font-size: 2em; }
.meta { color: #666; font-size: 0.9em; margin-bottom: 20px; }
.content { margin-top: 30px; overflow-wrap: break-word; }
.content h2 { color: #34495e; margin-top: 30px; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
.content p { margin-bottom: 15px; }
.content pre { background: #f8f8f8; padding: 15px; border-radius: 5px; overflow-x: auto; border-left: 3px solid #3498db; margin: 15px 0; }
.content code { background: #f8f8f8; padding: 2px 5px; border-radius: 3px; font-family: monospace; font-size: 0.9em; }
.content blockquote { border-left: 4px solid #3498db; padding-left: 20px; margin: 20px 0; color: #555; font-style: italic; }
.content table { border-collapse: collapse; width: 100%; margin: 20px 0; }
.content th, .content td { border: 1px solid #ddd; padding: 10px; text-align: left; }
.back-link { display: inline-block; margin-bottom: 20px; color: #3498db; text-decoration: none; font-weight: 500; }
</style>
    
<script>
    window.MathJax = {
        tex: {
            inlineMath: [['$', '$'], ['\(', '\)']],
            displayMath: [['$$', '$$'], ['\[', '\]']],
            processEscapes: true
        }
    };
</script>
<script id="MathJax-script" async src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>

</head>
<body>
    <div class="container">
        <a href="../index.html" class="back-link">â† è¿”å›é¦–é¡µ</a>
        <header>
            <h1>Transformerå‡çº§ä¹‹è·¯ï¼š6ã€æ—‹è½¬ä½ç½®ç¼–ç çš„å®Œå¤‡æ€§åˆ†æ</h1>
            <div class="meta">ğŸ“… æœ€åæ›´æ–°: 2025-11-26 | ğŸ“„ å¤§å°: 34.7 KB</div>
        </header>
        <div class="content">
            <p><strong>åŸæ–‡é“¾æ¥</strong>: <a href="https://spaces.ac.cn/archives/9403">https://spaces.ac.cn/archives/9403</a></p>
<p><strong>å‘å¸ƒæ—¥æœŸ</strong>: </p>
<hr />
<p>åœ¨å»å¹´çš„æ–‡ç« <a href="/archives/8265">ã€ŠTransformerå‡çº§ä¹‹è·¯ï¼š2ã€åšé‡‡ä¼—é•¿çš„æ—‹è½¬å¼ä½ç½®ç¼–ç ã€‹</a>ä¸­ï¼Œç¬”è€…æå‡ºäº†æ—‹è½¬ä½ç½®ç¼–ç ï¼ˆRoPEï¼‰ï¼Œå½“æ—¶çš„å‡ºå‘ç‚¹åªæ˜¯è§‰å¾—ç”¨ç»å¯¹ä½ç½®æ¥å®ç°ç›¸å¯¹ä½ç½®æ˜¯ä¸€ä»¶â€œå¾ˆå¥½ç©çš„äº‹æƒ…â€ï¼Œå¹¶æ²¡æ–™åˆ°å…¶å®é™…æ•ˆæœè¿˜ç›¸å½“ä¸é”™ï¼Œå¹¶ä¸ºå¤§å®¶æ‰€æ¥å—ï¼Œä¸å¾—ä¸è¯´è¿™çœŸæ˜¯ä¸€ä¸ªæ„å¤–ä¹‹å–œã€‚åæ¥ï¼Œåœ¨<a href="/archives/8397">ã€ŠTransformerå‡çº§ä¹‹è·¯ï¼š4ã€äºŒç»´ä½ç½®çš„æ—‹è½¬å¼ä½ç½®ç¼–ç ã€‹</a>ä¸­ï¼Œç¬”è€…è®¨è®ºäº†äºŒç»´å½¢å¼çš„RoPEï¼Œå¹¶ç ”ç©¶äº†ç”¨çŸ©é˜µæŒ‡æ•°è¡¨ç¤ºçš„RoPEçš„ä¸€èˆ¬è§£ã€‚</p>
<p>æ—¢ç„¶æœ‰äº†ä¸€èˆ¬è§£ï¼Œé‚£ä¹ˆè‡ªç„¶å°±ä¼šå¼•å‡ºä¸€ä¸ªé—®é¢˜ï¼šæˆ‘ä»¬å¸¸ç”¨çš„RoPEï¼Œåªæ˜¯ä¸€ä¸ªä»¥äºŒç»´æ—‹è½¬çŸ©é˜µä¸ºåŸºæœ¬å•å…ƒçš„åˆ†å—å¯¹è§’çŸ©é˜µï¼Œå¦‚æœæ¢æˆä¸€èˆ¬è§£ï¼Œç†è®ºä¸Šæ•ˆæœä¼šä¸ä¼šæ›´å¥½å‘¢ï¼Ÿæœ¬æ–‡å°±æ¥å›ç­”è¿™ä¸ªé—®é¢˜ã€‚</p>
<h2 id="_1">æŒ‡æ•°é€šè§£</h2>
<p>åœ¨<a href="/archives/8397">ã€ŠTransformerå‡çº§ä¹‹è·¯ï¼š4ã€äºŒç»´ä½ç½®çš„æ—‹è½¬å¼ä½ç½®ç¼–ç ã€‹</a>ä¸­ï¼Œæˆ‘ä»¬å°†RoPEæŠ½è±¡åœ°å®šä¹‰ä¸ºä»»æ„æ»¡è¶³ä¸‹å¼çš„æ–¹é˜µ<br />
\begin{equation}\boldsymbol{\mathcal{R}}<em n-m="n-m">m^{\top}\boldsymbol{\mathcal{R}}_n=\boldsymbol{\mathcal{R}}</em>}\label{eq:re}\end{equation<br />
ç„¶åï¼Œæˆ‘ä»¬æ¢è®¨äº†å¦‚ä¸‹çŸ©é˜µæŒ‡æ•°å½¢å¼çš„è§£<br />
\begin{equation}\boldsymbol{\mathcal{R}}_n=\exp n\boldsymbol{B}\end{equation}<br />
è¿™é‡Œçš„çŸ©é˜µæŒ‡æ•°ï¼Œä¸æ˜¯åƒSoftmaxé‚£æ ·çš„æ¿€æ´»å‡½æ•°å¼çš„element-wiseè¿ç®—ï¼Œè€Œæ˜¯æŒ‰ç…§æ³°å‹’çº§æ•°å®šä¹‰çš„â€œ<a href="https://en.wikipedia.org/wiki/Matrix_exponential">Matrix Exponential</a>â€ã€‚æ ¹æ®â€œ<a href="https://en.wikipedia.org/wiki/Baker%E2%80%93Campbell%E2%80%93Hausdorff_formula">Bakerâ€“Campbellâ€“Hausdorffå…¬å¼</a>â€ï¼Œæˆ‘ä»¬æœ‰<br />
\begin{equation}\begin{aligned}<br />
\boldsymbol{\mathcal{R}}_m^{\top}\boldsymbol{\mathcal{R}}_n=&amp;\,\big(\exp m\boldsymbol{B}\big)^{\top}\big(\exp n\boldsymbol{B}\big) = \big(\exp m\boldsymbol{B}^{\top}\big)\big(\exp n\boldsymbol{B}\big) \\\<br />
=&amp;\,\exp\left(m\boldsymbol{B}^{\top} + n\boldsymbol{B} + \frac{1}{2}mn\left[\boldsymbol{B}^{\top}, \boldsymbol{B}\right]+\cdots\right)<br />
\end{aligned}\end{equation}<br />
è¿™é‡Œ$\left[\boldsymbol{A}, \boldsymbol{B}\right]=\boldsymbol{A}\boldsymbol{B}-\boldsymbol{B}\boldsymbol{A}$ï¼Œ$\cdots$çœç•¥çš„éƒ½æ˜¯$m,n$çš„ä¸‰æ¬¡æˆ–ä¸‰æ¬¡ä»¥ä¸Šçš„é¡¹ã€‚æŒ‰ç…§å¼$\eqref{eq:re}$ï¼Œé‚£ä¹ˆä¸Šå¼æŒ‡æ•°éƒ¨åˆ†åº”è¯¥ç­‰äº$(n-m)\boldsymbol{B}$ï¼Œè¿™å°±æ¨å‡º<br />
\begin{equation}\boldsymbol{B}^{\top} = - \boldsymbol{B}\end{equation}<br />
å³è¦æ±‚$\boldsymbol{B}$æ˜¯åå¯¹ç§°çŸ©é˜µã€‚</p>
<h2 id="_2">æ­£äº¤é€šè§£</h2>
<p>è¿›ä¸€æ­¥åœ°ï¼Œæˆ‘ä»¬æœ‰$(\exp \boldsymbol{B})^{\top}(\exp \boldsymbol{B})=\exp(\boldsymbol{B}-\boldsymbol{B}) = \boldsymbol{I}$å’Œ$\exp n\boldsymbol{B} = \left(\exp\boldsymbol{B}\right)^n$ï¼Œå‰è€…è¯´æ˜$\exp\boldsymbol{B}$æ˜¯æ­£äº¤çŸ©é˜µï¼Œåè€…åˆ™å¯ç¤ºæˆ‘ä»¬è¿™æ˜¯ä¸æ˜¯å¯ä»¥æ¨å¹¿åˆ°ä»»æ„æ­£äº¤çŸ©é˜µï¼Ÿä¸éš¾éªŒè¯ï¼Œç­”æ¡ˆæ˜¯è‚¯å®šçš„ï¼Œæˆ‘ä»¬æœ‰ç»“è®ºï¼š</p>
<blockquote>
<p>å¯¹äºä»»æ„æ­£äº¤çŸ©é˜µ$\boldsymbol{O}$ï¼Œ$\boldsymbol{\mathcal{R}}_n=\boldsymbol{O}^n$æ˜¯æ»¡è¶³å¼$\eqref{eq:re}$çš„è§£ã€‚</p>
</blockquote>
<p>å€¼å¾—æŒ‡å‡ºçš„æ˜¯ï¼Œåœ¨å®æ•°åŸŸå†…ï¼Œå¹¶éæ‰€æœ‰æ­£äº¤çŸ©é˜µèƒ½å†™æˆ$\exp\boldsymbol{B}$çš„å½¢å¼ï¼Œæ‰€ä»¥$\boldsymbol{O}^n$å®é™…ä¸Šæ¯”çŸ©é˜µæŒ‡æ•°å½¢å¼æ›´å®½æ³›ã€‚ä»<a href="/archives/6377">ã€Šæ’ç­‰å¼ det(exp(A)) = exp(Tr(A)) èµæã€‹</a>å¯çŸ¥$\det(\exp(\boldsymbol{A})) = \exp(\text{Tr}(\boldsymbol{A})) &gt; 0$ï¼Œæ‰€ä»¥èƒ½å†™æˆçŸ©é˜µæŒ‡æ•°å½¢å¼çš„æ­£äº¤çŸ©é˜µè¡Œåˆ—å¼å¿…ç„¶å¤§äº0ï¼ˆå³ç­‰äº1ï¼‰ï¼Œäº‹å®ä¸Šè¿™ä¸ªç»“æœåè¿‡æ¥ä¹Ÿæˆç«‹ï¼Œå³è¡Œåˆ—å¼ç­‰äº1çš„æ­£äº¤çŸ©é˜µï¼Œå¿…ç„¶å¯ä»¥å†™æˆ$\exp\boldsymbol{B}$çš„å½¢å¼ï¼Œå…¶ä¸­$\boldsymbol{B}$æ˜¯åå¯¹ç§°çŸ©é˜µã€‚ï¼ˆå‚è€ƒ<a href="https://math.stackexchange.com/questions/2467531/why-can-any-orthogonal-matrix-be-written-as-o-ea">ã€ŠWhy can any orthogonal matrix be written as O=e^Aã€‹</a>ï¼‰ã€‚</p>
<p>å¯¹äº$\det(\boldsymbol{O}) = -1$çš„æ­£äº¤çŸ©é˜µï¼Œæˆ‘ä»¬æœ‰$\boldsymbol{O}=\boldsymbol{O}<em>+ \boldsymbol{I}</em>-$ï¼Œå…¶ä¸­$\boldsymbol{I}<em>-$æ˜¯å¯¹è§’çº¿æœ‰ä¸€ä¸ª-1ã€å‰©ä¸‹éƒ½æ˜¯1çš„å¯¹è§’é˜µï¼Œ$\boldsymbol{O}</em>+$æ˜¯$\det(\boldsymbol{O}<em>+) = 1$çš„æ­£äº¤çŸ©é˜µï¼Œå®ƒå¯ä»¥å†™æˆ$\exp\boldsymbol{B}$çš„å½¢å¼ï¼Œæ­¤æ—¶$\boldsymbol{O}^n = (\boldsymbol{O}</em>+ \boldsymbol{I}<em>-)^n = \boldsymbol{I}</em>-^n\exp n\boldsymbol{B}$ã€‚è¿™ä¹Ÿå°±æ˜¯è¯´ï¼Œå³ä¾¿å¯¹äº$\det(\boldsymbol{O}) = -1$çš„$\boldsymbol{O}^n$ï¼Œä¹Ÿåªæ˜¯$\exp n\boldsymbol{B}$çš„ç®€å•å˜æ¢ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥æˆ‘ä»¬ä¸»è¦ç ”ç©¶$\exp n\boldsymbol{B}$å½¢å¼çš„è§£ã€‚</p>
<h2 id="_3">å®Œå¤‡åˆ†æ</h2>
<p>ä¼—æ‰€å‘¨çŸ¥ï¼Œæˆ‘ä»¬å¹³æ—¶æ‰€ç”¨çš„RoPEä½ç½®ç¼–ç ï¼Œæ˜¯å¦‚ä¸‹å½¢å¼çš„åˆ†å—å¯¹è§’çŸ©é˜µï¼š<br />
\begin{equation}\scriptsize{\left(\begin{array}{cc:cc:cc:cc}<br />
\cos n\theta_0 &amp; -\sin n\theta_0 &amp; 0 &amp; 0 &amp; \cdots &amp; \cdots &amp; 0 &amp; 0 \\\<br />
\sin n\theta_0 &amp; \cos n\theta_0 &amp; 0 &amp; 0 &amp; \cdots &amp; \cdots &amp; 0 &amp; 0 \\\<br />
\hdashline<br />
0 &amp; 0 &amp; \cos n\theta_1 &amp; -\sin n\theta_1 &amp; \cdots &amp; \cdots &amp; 0 &amp; 0 \\\<br />
0 &amp; 0 &amp; \sin n\theta_1 &amp; \cos n\theta_1 &amp; \cdots &amp; \cdots &amp; 0 &amp; 0 \\\<br />
\hdashline<br />
\vdots &amp; \vdots &amp; \vdots &amp; \vdots &amp; \ddots &amp; \ddots &amp; \vdots &amp; \vdots \\\<br />
\vdots &amp; \vdots &amp; \vdots &amp; \vdots &amp; \ddots &amp; \ddots &amp; \vdots &amp; \vdots \\\<br />
\hdashline<br />
0 &amp; 0 &amp; 0 &amp; 0 &amp; \cdots &amp; \cdots &amp; \cos n\theta_{d/2-1} &amp; -\sin n\theta_{d/2-1} \\\<br />
0 &amp; 0 &amp; 0 &amp; 0 &amp; \cdots &amp; \cdots &amp; \sin n\theta_{d/2-1} &amp; \cos n\theta_{d/2-1} \\\<br />
\end{array}\right)}\end{equation}<br />
å®ƒå¯ä»¥ç®€å†™æˆ<br />
\begin{equation}\begin{pmatrix}<br />
\boldsymbol{R}<em n_theta_1="n\theta_1">{n\theta_0} &amp; \boldsymbol{0} &amp; \cdots &amp; \boldsymbol{0} \\\<br />
\boldsymbol{0} &amp; \boldsymbol{R}</em> \\\} &amp; \cdots &amp; \boldsymbol{0<br />
\vdots &amp; \vdots &amp; \ddots &amp; \vdots \\\<br />
\boldsymbol{0} &amp; \boldsymbol{0} &amp; \cdots &amp; \boldsymbol{R}<em d_2-1="d/2-1">{n\theta</em> \\\}<br />
\end{pmatrix} = \exp n\begin{pmatrix}<br />
\boldsymbol{J}<em _theta_1="\theta_1">{\theta_0} &amp; \boldsymbol{0} &amp; \cdots &amp; \boldsymbol{0} \\\<br />
\boldsymbol{0} &amp; \boldsymbol{J}</em> \\\} &amp; \cdots &amp; \boldsymbol{0<br />
\vdots &amp; \vdots &amp; \ddots &amp; \vdots \\\<br />
\boldsymbol{0} &amp; \boldsymbol{0} &amp; \cdots &amp; \boldsymbol{J}<em d_2-1="d/2-1">{\theta</em> \\\}<br />
\end{pmatrix}\end{equation}<br />
å…¶ä¸­<br />
\begin{equation}\boldsymbol{R}<em _theta="\theta">{\theta} = \begin{pmatrix} \cos\theta &amp; -\sin\theta \\\ \sin\theta &amp; \cos\theta \end{pmatrix},\quad \boldsymbol{J}</em>} = \begin{pmatrix} 0 &amp; -\theta \\\ \theta &amp; 0\end{pmatrix}\end{equation<br />
è¿™ç§é€‰æ‹©å¯ä»¥è¯´æ˜¯æœ€ç®€å•çš„ä¸€ç§ï¼Œå…¶æœ¬è´¨åŸå› å¯ä»¥è¯´æ˜¯ä¸ºäº†é™ä½è®¡ç®—é‡ã€‚é‚£ä¹ˆï¼Œæ‰€è°“å®Œå¤‡æ€§é—®é¢˜ï¼Œå°±æ˜¯è¦å›ç­”ï¼šå¦‚ä¸Šçš„åˆ†å—å¯¹è§’çŸ©é˜µçš„ç‰¹ä¾‹ï¼Œç›¸æ¯”å…¨å‚æ•°$\exp n\boldsymbol{B}$ï¼Œæ˜¯å¦æœ‰èƒ½åŠ›ä¸Šçš„ç¼ºå¤±ï¼Ÿæ¢å¥è¯è¯´ï¼Œå¦‚æœä¸è€ƒè™‘è®¡ç®—é‡ï¼Œå°†$\boldsymbol{B}$æ›¿æ¢ä¸ºä¸€èˆ¬çš„åå¯¹ç§°çŸ©é˜µï¼Œæ•ˆæœæ˜¯å¦å¯èƒ½ä¼šæœ‰æå‡ï¼Ÿ</p>
<p>å›ç­”è¿™ä¸ªé—®é¢˜ä¸å›°éš¾ï¼Œäº‹å®ä¸Šï¼Œå¯¹äºä»»æ„å¶æ•°é˜¶åå¯¹ç§°çŸ©é˜µï¼Œå®ƒéƒ½å¯ä»¥å¯¹è§’åŒ–ä¸ºåˆ†å—å¯¹è§’çŸ©é˜µ<br />
\begin{equation}\boldsymbol{\Lambda} = \begin{pmatrix}<br />
\boldsymbol{J}<em _theta_1="\theta_1">{\theta_0} &amp; \boldsymbol{0} &amp; \cdots &amp; \boldsymbol{0} \\\<br />
\boldsymbol{0} &amp; \boldsymbol{J}</em> \\\} &amp; \cdots &amp; \boldsymbol{0<br />
\vdots &amp; \vdots &amp; \ddots &amp; \vdots \\\<br />
\boldsymbol{0} &amp; \boldsymbol{0} &amp; \cdots &amp; \boldsymbol{J}<em d_2-1="d/2-1">{\theta</em> \\\}<br />
\end{pmatrix}\end{equation}<br />
è¯¥ç»“è®ºå¯ä»¥å‚è€ƒ<a href="https://en.wikipedia.org/wiki/Skew-symmetric_matrix#Spectral_theory">Skew-symmetric matrix</a>ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå­˜åœ¨å¯é€†çŸ©é˜µ$\boldsymbol{P}$ï¼Œä½¿å¾—$\boldsymbol{B}=\boldsymbol{P}\boldsymbol{\Lambda}\boldsymbol{P}^{-1}$ï¼Œäºæ˜¯<br />
\begin{equation}\exp n\boldsymbol{B} = \exp \left(n\boldsymbol{P}\boldsymbol{\Lambda}\boldsymbol{P}^{-1}\right) = \boldsymbol{P}(\exp n\boldsymbol{\Lambda})\boldsymbol{P}^{-1}\end{equation}<br />
ä¹Ÿå°±æ˜¯è¯´ï¼Œä»»æ„çš„$\exp n\boldsymbol{B}$ä¸åˆ†å—å¯¹è§’çš„$\exp n\boldsymbol{\Lambda}$ï¼Œä»…ä»…ç›¸å·®ä¸€ä¸ªç›¸ä¼¼å˜æ¢ï¼Œè€Œæˆ‘ä»¬åœ¨Self Attentionä¸­åº”ç”¨RoPEæ—¶ï¼Œæ˜¯<br />
\begin{equation}\boldsymbol{q}^{\top}\big(\exp (n-m)\boldsymbol{B}\big)\boldsymbol{k} = \big(\boldsymbol{P}^{\top}\boldsymbol{q}\big)^{\top}\big(\exp (n-m)\boldsymbol{\Lambda}\big)\big(\boldsymbol{P}^{-1}\boldsymbol{k}\big)\end{equation}<br />
ç”±äº$\boldsymbol{q},\boldsymbol{k}$ä¸€èˆ¬éƒ½æ˜¯è¾“å…¥$\boldsymbol{x}$ç»è¿‡æŸä¸ªå¯å­¦ä¹ çš„çº¿æ€§å˜æ¢è€Œæ¥ï¼Œ$\boldsymbol{P}^{\top},\boldsymbol{P}^{-1}$åŸåˆ™ä¸Šéƒ½å¯ä»¥å¸æ”¶åˆ°çº¿æ€§å˜æ¢çš„è®­ç»ƒå‚æ•°ä¸­ï¼Œå› æ­¤ç›´æ¥è®¾ä¸º$\boldsymbol{q}^{\top}\big(\exp (n-m)\boldsymbol{\Lambda}\big)\boldsymbol{k}$ç†è®ºä¸Šä¸ä¼šæŸå¤±ä¸€èˆ¬æ€§ã€‚</p>
<p>æ‰€ä»¥ï¼Œå¯¹äºSelf Attentionæ¥è¯´ï¼Œé—®é¢˜çš„ç­”æ¡ˆæ˜¯å¦å®šçš„ã€‚ä¸è¿‡ï¼Œå¦‚æœæ˜¯<a href="çº¿æ€§Attentionçš„æ¢ç´¢ï¼šAttentionå¿…é¡»æœ‰ä¸ªSoftmaxå—ï¼Ÿ">çº¿æ€§Attention</a>ï¼Œç­”æ¡ˆä¼šæœ‰å°‘è®¸åŒºåˆ«ï¼Œå› ä¸ºçº¿æ€§Attentionçš„$\boldsymbol{q},\boldsymbol{k}$åŠ äº†ä¸ªæ¿€æ´»å‡½æ•°ï¼š<br />
\begin{equation}\phi(\boldsymbol{q})^{\top}\big(\exp (n-m)\boldsymbol{B}\big)\varphi(\boldsymbol{k}) = \big(\boldsymbol{P}^{\top}\phi(\boldsymbol{q})\big)^{\top}\big(\exp (n-m)\boldsymbol{\Lambda}\big)\big(\boldsymbol{P}^{-1}\varphi(\boldsymbol{k})\big)\end{equation}<br />
è¿™å°±å¯¼è‡´äº†$\boldsymbol{P}^{\top},\boldsymbol{P}^{-1}$ä¸ä¸€å®šèƒ½å¸æ”¶åˆ°çº¿æ€§å˜æ¢çš„è®­ç»ƒå‚æ•°ä¸­ï¼Œå› æ­¤å¯¹çº¿æ€§Attentionè¡¥ä¸Šä¸¤ä¸ªå‚æ•°çŸ©é˜µï¼Œæ˜¯æœ‰å¯èƒ½å¸¦æ¥æå‡çš„ã€‚</p>
<h2 id="_4">æ–‡ç« å°ç»“</h2>
<p>æœ¬æ–‡ç®€å•åˆ†æäº†RoPEçš„å®Œå¤‡æ€§é—®é¢˜ï¼Œè¡¨æ˜å¯¹äºSelf Attentionæ¥è¯´ï¼Œç›®å‰çš„åˆ†å—å¯¹è§’å‹RoPEä¸ä¼šæŸå¤±ä¸€èˆ¬æ€§ã€‚</p>
<p><em><strong>è½¬è½½åˆ°è¯·åŒ…æ‹¬æœ¬æ–‡åœ°å€ï¼š</strong><a href="https://spaces.ac.cn/archives/9403">https://spaces.ac.cn/archives/9403</a></em></p>
<p><em><strong>æ›´è¯¦ç»†çš„è½¬è½½äº‹å®œè¯·å‚è€ƒï¼š</strong></em><a href="https://spaces.ac.cn/archives/6508#%E6%96%87%E7%AB%A0%E5%A6%82%E4%BD%95%E8%BD%AC%E8%BD%BD/%E5%BC%95%E7%94%A8" title="ã€Šç§‘å­¦ç©ºé—´FAQã€‹">ã€Šç§‘å­¦ç©ºé—´FAQã€‹</a></p>
<p><strong>å¦‚æœæ‚¨è¿˜æœ‰ä»€ä¹ˆç–‘æƒ‘æˆ–å»ºè®®ï¼Œæ¬¢è¿åœ¨ä¸‹æ–¹è¯„è®ºåŒºç»§ç»­è®¨è®ºã€‚</strong></p>
<p><strong>å¦‚æœæ‚¨è§‰å¾—æœ¬æ–‡è¿˜ä¸é”™ï¼Œæ¬¢è¿åˆ†äº«/æ‰“èµæœ¬æ–‡ã€‚æ‰“èµå¹¶éè¦ä»ä¸­è·å¾—æ”¶ç›Šï¼Œè€Œæ˜¯å¸Œæœ›çŸ¥é“ç§‘å­¦ç©ºé—´è·å¾—äº†å¤šå°‘è¯»è€…çš„çœŸå¿ƒå…³æ³¨ã€‚å½“ç„¶ï¼Œå¦‚æœä½ æ— è§†å®ƒï¼Œä¹Ÿä¸ä¼šå½±å“ä½ çš„é˜…è¯»ã€‚å†æ¬¡è¡¨ç¤ºæ¬¢è¿å’Œæ„Ÿè°¢ï¼</strong></p>
<p>æ‰“èµ</p>
<p><img alt="ç§‘å­¦ç©ºé—´" src="https://spaces.ac.cn/usr/themes/geekg/payment/wx.png" /></p>
<p>å¾®ä¿¡æ‰“èµ</p>
<p><img alt="ç§‘å­¦ç©ºé—´" src="https://spaces.ac.cn/usr/themes/geekg/payment/zfb.png" /></p>
<p>æ”¯ä»˜å®æ‰“èµ</p>
<p>å› ä¸ºç½‘ç«™åå°å¯¹æ‰“èµå¹¶æ— è®°å½•ï¼Œå› æ­¤æ¬¢è¿åœ¨æ‰“èµæ—¶å€™å¤‡æ³¨ç•™è¨€ã€‚ä½ è¿˜å¯ä»¥<a href="http://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&amp;email=tN7d1drY3drrx8H0xcWa19vZ"><strong>ç‚¹å‡»è¿™é‡Œ</strong></a>æˆ–åœ¨ä¸‹æ–¹è¯„è®ºåŒºç•™è¨€æ¥å‘ŠçŸ¥ä½ çš„å»ºè®®æˆ–éœ€æ±‚ã€‚</p>
<p><strong>å¦‚æœæ‚¨éœ€è¦å¼•ç”¨æœ¬æ–‡ï¼Œè¯·å‚è€ƒï¼š</strong></p>
<p>è‹å‰‘æ—. (Dec. 28, 2022). ã€ŠTransformerå‡çº§ä¹‹è·¯ï¼š6ã€æ—‹è½¬ä½ç½®ç¼–ç çš„å®Œå¤‡æ€§åˆ†æ ã€‹[Blog post]. Retrieved from <a href="https://spaces.ac.cn/archives/9403">https://spaces.ac.cn/archives/9403</a></p>
<p>@online{kexuefm-9403,<br />
title={Transformerå‡çº§ä¹‹è·¯ï¼š6ã€æ—‹è½¬ä½ç½®ç¼–ç çš„å®Œå¤‡æ€§åˆ†æ},<br />
author={è‹å‰‘æ—},<br />
year={2022},<br />
month={Dec},<br />
url={\url{https://spaces.ac.cn/archives/9403}},<br />
} </p>
<hr />
<h2 id="_5">å…¬å¼æ¨å¯¼ä¸æ³¨é‡Š</h2>
<h3 id="1-rope">1. RoPEçš„æ—‹è½¬çŸ©é˜µè¡¨ç¤ºä¸å¤æ•°å½¢å¼</h3>
<h4 id="11">1.1 äºŒç»´æ—‹è½¬çŸ©é˜µçš„åŸºæœ¬æ€§è´¨</h4>
<p>äºŒç»´æ—‹è½¬çŸ©é˜µçš„æ ‡å‡†å½¢å¼ä¸ºï¼š</p>
<p>$$\boldsymbol{R}_{\theta} = \begin{pmatrix} \cos\theta & -\sin\theta \\ \sin\theta & \cos\theta \end{pmatrix}$$</p>
<p><strong>æ€§è´¨1ï¼ˆæ—‹è½¬çŸ©é˜µçš„æ­£äº¤æ€§ï¼‰</strong>ï¼šæ—‹è½¬çŸ©é˜µæ»¡è¶³ $\boldsymbol{R}<em _theta="\theta">{\theta}^{\top}\boldsymbol{R}</em>$} = \boldsymbol{I</p>
<p>è¯æ˜ï¼š
$$\boldsymbol{R}_{\theta}^{\top}\boldsymbol{R}_{\theta} = \begin{pmatrix} \cos\theta & \sin\theta \\ -\sin\theta & \cos\theta \end{pmatrix}\begin{pmatrix} \cos\theta & -\sin\theta \\ \sin\theta & \cos\theta \end{pmatrix} = \begin{pmatrix} \cos^2\theta + \sin^2\theta & -\cos\theta\sin\theta + \sin\theta\cos\theta \\ -\sin\theta\cos\theta + \cos\theta\sin\theta & \sin^2\theta + \cos^2\theta \end{pmatrix} = \begin{pmatrix} 1 & 0 \\ 0 & 1 \end{pmatrix}$$</p>
<p><strong>æ€§è´¨2ï¼ˆæ—‹è½¬çŸ©é˜µçš„è¡Œåˆ—å¼ï¼‰</strong>ï¼š$\det(\boldsymbol{R}_{\theta}) = 1$</p>
<p>è¯æ˜ï¼š
$$\det(\boldsymbol{R}_{\theta}) = \cos\theta \cdot \cos\theta - (-\sin\theta) \cdot \sin\theta = \cos^2\theta + \sin^2\theta = 1$$</p>
<p><strong>æ€§è´¨3ï¼ˆæ—‹è½¬çŸ©é˜µçš„å¤åˆï¼‰</strong>ï¼š$\boldsymbol{R}<em _theta_2="\theta_2">{\theta_1}\boldsymbol{R}</em>$} = \boldsymbol{R}_{\theta_1 + \theta_2</p>
<p>è¯æ˜ï¼š
$$\begin{aligned}
\boldsymbol{R}_{\theta_1}\boldsymbol{R}_{\theta_2} &= \begin{pmatrix} \cos\theta_1 & -\sin\theta_1 \\ \sin\theta_1 & \cos\theta_1 \end{pmatrix}\begin{pmatrix} \cos\theta_2 & -\sin\theta_2 \\ \sin\theta_2 & \cos\theta_2 \end{pmatrix} \\
&= \begin{pmatrix} \cos\theta_1\cos\theta_2 - \sin\theta_1\sin\theta_2 & -\cos\theta_1\sin\theta_2 - \sin\theta_1\cos\theta_2 \\ \sin\theta_1\cos\theta_2 + \cos\theta_1\sin\theta_2 & -\sin\theta_1\sin\theta_2 + \cos\theta_1\cos\theta_2 \end{pmatrix} \\
&= \begin{pmatrix} \cos(\theta_1+\theta_2) & -\sin(\theta_1+\theta_2) \\ \sin(\theta_1+\theta_2) & \cos(\theta_1+\theta_2) \end{pmatrix} = \boldsymbol{R}_{\theta_1+\theta_2}
\end{aligned}$$</p>
<h4 id="12">1.2 å¤æ•°å½¢å¼çš„æ—‹è½¬è¡¨ç¤º</h4>
<p>å°†äºŒç»´å‘é‡ $(x, y)$ è¡¨ç¤ºä¸ºå¤æ•° $z = x + iy$ï¼Œåˆ™æ—‹è½¬æ“ä½œå¯ä»¥è¡¨ç¤ºä¸ºå¤æ•°ä¹˜æ³•ï¼š</p>
<p>$$z' = e^{i\theta} z = (\cos\theta + i\sin\theta)(x + iy)$$</p>
<p>å±•å¼€å¾—ï¼š
$$z' = (\cos\theta \cdot x - \sin\theta \cdot y) + i(\sin\theta \cdot x + \cos\theta \cdot y)$$</p>
<p>è¿™å¯¹åº”äºçŸ©é˜µå½¢å¼ï¼š
$$\begin{pmatrix} x' \\ y' \end{pmatrix} = \begin{pmatrix} \cos\theta & -\sin\theta \\ \sin\theta & \cos\theta \end{pmatrix}\begin{pmatrix} x \\ y \end{pmatrix}$$</p>
<p><strong>å®šç†1ï¼ˆå¤æ•°æ—‹è½¬çš„ç­‰ä»·æ€§ï¼‰</strong>ï¼šå¤æ•°ä¹˜ä»¥ $e^{i\theta}$ ç­‰ä»·äºå¯¹åº”äºŒç»´å‘é‡åº”ç”¨æ—‹è½¬çŸ©é˜µ $\boldsymbol{R}_{\theta}$ã€‚</p>
<h4 id="13-rope">1.3 RoPEçš„ä½ç½®ç¼–ç å½¢å¼</h4>
<p>å¯¹äºä½ç½® $m$ çš„å‘é‡ $\boldsymbol{q}_m \in \mathbb{R}^d$ï¼ˆå‡è®¾ $d$ ä¸ºå¶æ•°ï¼‰ï¼ŒRoPEå°†å…¶åˆ†ä¸º $d/2$ ä¸ªäºŒç»´å—ï¼š</p>
<p>$$\boldsymbol{q}_m = \begin{pmatrix} q_m^{(1)} \\ q_m^{(2)} \\ \vdots \\ q_m^{(d-1)} \\ q_m^{(d)} \end{pmatrix} \rightarrow \begin{pmatrix} q_m^{(1)} \\ q_m^{(2)} \\ \hdashline q_m^{(3)} \\ q_m^{(4)} \\ \hdashline \vdots \\ \vdots \\ \hdashline q_m^{(d-1)} \\ q_m^{(d)} \end{pmatrix}$$</p>
<p>å¯¹ç¬¬ $i$ ä¸ªäºŒç»´å—ï¼ˆ$i = 0, 1, \ldots, d/2-1$ï¼‰ï¼Œåº”ç”¨æ—‹è½¬è§’åº¦ $\theta_i$ï¼š</p>
<p>$$\begin{pmatrix} q_m^{(2i+1)} \\ q_m^{(2i+2)} \end{pmatrix} \rightarrow \begin{pmatrix} \cos(m\theta_i) & -\sin(m\theta_i) \\ \sin(m\theta_i) & \cos(m\theta_i) \end{pmatrix}\begin{pmatrix} q_m^{(2i+1)} \\ q_m^{(2i+2)} \end{pmatrix}$$</p>
<p>å…¶ä¸­æ—‹è½¬è§’åº¦æŒ‰å‡ ä½•çº§æ•°é€’å‡ï¼š
$$\theta_i = \theta_{\text{base}}^{-2i/d}, \quad \theta_{\text{base}} = 10000$$</p>
<h4 id="14-rope">1.4 å¤æ•°å½¢å¼çš„RoPE</h4>
<p>å°†æ¯ä¸ªäºŒç»´å—è¡¨ç¤ºä¸ºå¤æ•°ï¼š
$$z_m^{(i)} = q_m^{(2i+1)} + i q_m^{(2i+2)}$$</p>
<p>åˆ™RoPEæ“ä½œä¸ºï¼š
$$z_m^{(i)} \rightarrow e^{im\theta_i} z_m^{(i)}$$</p>
<p>å®Œæ•´çš„RoPEç¼–ç å‘é‡å¯è¡¨ç¤ºä¸ºï¼š
$$\text{RoPE}(\boldsymbol{q}_m) = \begin{pmatrix} \text{Re}(e^{im\theta_0} z_m^{(0)}) \\ \text{Im}(e^{im\theta_0} z_m^{(0)}) \\ \text{Re}(e^{im\theta_1} z_m^{(1)}) \\ \text{Im}(e^{im\theta_1} z_m^{(1)}) \\ \vdots \\ \text{Re}(e^{im\theta_{d/2-1}} z_m^{(d/2-1)}) \\ \text{Im}(e^{im\theta_{d/2-1}} z_m^{(d/2-1)}) \end{pmatrix}$$</p>
<h3 id="2">2. ç›¸å¯¹ä½ç½®ç¼–ç çš„ç­‰ä»·æ€§</h3>
<h4 id="21">2.1 è‡ªæ³¨æ„åŠ›ä¸­çš„ç›¸å¯¹ä½ç½®</h4>
<p>åœ¨è‡ªæ³¨æ„åŠ›æœºåˆ¶ä¸­ï¼ŒQueryå‘é‡ $\boldsymbol{q}_m$ å’Œ Keyå‘é‡ $\boldsymbol{k}_n$ çš„ç‚¹ç§¯ä¸ºï¼š</p>
<p>$$\text{score}(m, n) = \boldsymbol{q}_m^{\top} \boldsymbol{k}_n$$</p>
<p>åº”ç”¨RoPEåï¼š
$$\text{score}_{\text{RoPE}}(m, n) = (\boldsymbol{\mathcal{R}}_m \boldsymbol{q}_m)^{\top} (\boldsymbol{\mathcal{R}}_n \boldsymbol{k}_n)$$</p>
<p>å…¶ä¸­ $\boldsymbol{\mathcal{R}}_m$ æ˜¯åˆ†å—å¯¹è§’çŸ©é˜µï¼š
$$\boldsymbol{\mathcal{R}}_m = \begin{pmatrix} \boldsymbol{R}_{m\theta_0} & \boldsymbol{0} & \cdots & \boldsymbol{0} \\ \boldsymbol{0} & \boldsymbol{R}_{m\theta_1} & \cdots & \boldsymbol{0} \\ \vdots & \vdots & \ddots & \vdots \\ \boldsymbol{0} & \boldsymbol{0} & \cdots & \boldsymbol{R}_{m\theta_{d/2-1}} \end{pmatrix}$$</p>
<h4 id="22">2.2 ç›¸å¯¹ä½ç½®çš„æ¨å¯¼</h4>
<p>åˆ©ç”¨æ—‹è½¬çŸ©é˜µçš„æ­£äº¤æ€§ $\boldsymbol{R}<em -_theta="-\theta">{\theta}^{\top} = \boldsymbol{R}</em>$ï¼š</p>
<p>$$\begin{aligned}
\text{score}_{\text{RoPE}}(m, n) &= (\boldsymbol{\mathcal{R}}_m \boldsymbol{q}_m)^{\top} (\boldsymbol{\mathcal{R}}_n \boldsymbol{k}_n) \\
&= \boldsymbol{q}_m^{\top} \boldsymbol{\mathcal{R}}_m^{\top} \boldsymbol{\mathcal{R}}_n \boldsymbol{k}_n
\end{aligned}$$</p>
<p>ç”±äºæ—‹è½¬çŸ©é˜µçš„å¤åˆæ€§è´¨ï¼š
$$\boldsymbol{\mathcal{R}}_m^{\top} \boldsymbol{\mathcal{R}}_n = \boldsymbol{\mathcal{R}}_{-m} \boldsymbol{\mathcal{R}}_n = \boldsymbol{\mathcal{R}}_{n-m}$$</p>
<p>å› æ­¤ï¼š
$$\text{score}_{\text{RoPE}}(m, n) = \boldsymbol{q}_m^{\top} \boldsymbol{\mathcal{R}}_{n-m} \boldsymbol{k}_n$$</p>
<p><strong>å®šç†2ï¼ˆRoPEçš„ç›¸å¯¹ä½ç½®ç¼–ç æ€§è´¨ï¼‰</strong>ï¼šRoPEç¼–ç çš„æ³¨æ„åŠ›å¾—åˆ†ä»…ä¾èµ–äºç›¸å¯¹ä½ç½® $n-m$ï¼Œè€Œä¸ä¾èµ–äºç»å¯¹ä½ç½® $m$ å’Œ $n$ã€‚</p>
<h4 id="23">2.3 å¤æ•°å½¢å¼çš„ç›¸å¯¹ä½ç½®</h4>
<p>å¯¹äºç¬¬ $i$ ä¸ªäºŒç»´å—ï¼Œå¤æ•°å½¢å¼ä¸ºï¼š
$$\text{score}^{(i)}(m, n) = \text{Re}((e^{im\theta_i} z_m^{(i)})^* (e^{in\theta_i} w_n^{(i)}))$$</p>
<p>å…¶ä¸­ $z_m^{(i)}$ å’Œ $w_n^{(i)}$ åˆ†åˆ«æ˜¯Queryå’ŒKeyçš„å¤æ•°è¡¨ç¤ºï¼Œ$*$ è¡¨ç¤ºå…±è½­ã€‚</p>
<p>åˆ©ç”¨ $(e^{i\alpha}z)^<em> = e^{-i\alpha}z^</em>$ï¼š
$$\begin{aligned}
\text{score}^{(i)}(m, n) &= \text{Re}(e^{-im\theta_i} (z_m^{(i)})^* e^{in\theta_i} w_n^{(i)}) \\
&= \text{Re}(e^{i(n-m)\theta_i} (z_m^{(i)})^* w_n^{(i)})
\end{aligned}$$</p>
<p>è¿™æ˜ç¡®æ˜¾ç¤ºäº†ä»…ä¾èµ–äºç›¸å¯¹ä½ç½® $n-m$ã€‚</p>
<h3 id="3">3. æ—‹è½¬ä½ç½®ç¼–ç çš„å®Œå¤‡æ€§å®šç†</h3>
<h4 id="31">3.1 åå¯¹ç§°çŸ©é˜µçš„åˆ†è§£å®šç†</h4>
<p><strong>å®šç†3ï¼ˆå¶æ•°é˜¶åå¯¹ç§°çŸ©é˜µçš„æ ‡å‡†å½¢ï¼‰</strong>ï¼šä»»æ„ $d$ é˜¶åå¯¹ç§°çŸ©é˜µ $\boldsymbol{B}$ï¼ˆ$d$ ä¸ºå¶æ•°ï¼‰ï¼Œå­˜åœ¨æ­£äº¤çŸ©é˜µ $\boldsymbol{P}$ ä½¿å¾—ï¼š</p>
<p>$$\boldsymbol{B} = \boldsymbol{P} \boldsymbol{\Lambda} \boldsymbol{P}^{\top}$$</p>
<p>å…¶ä¸­ $\boldsymbol{\Lambda}$ æ˜¯åˆ†å—å¯¹è§’çŸ©é˜µï¼š
$$\boldsymbol{\Lambda} = \begin{pmatrix} \boldsymbol{J}_{\theta_0} & \boldsymbol{0} & \cdots & \boldsymbol{0} \\ \boldsymbol{0} & \boldsymbol{J}_{\theta_1} & \cdots & \boldsymbol{0} \\ \vdots & \vdots & \ddots & \vdots \\ \boldsymbol{0} & \boldsymbol{0} & \cdots & \boldsymbol{J}_{\theta_{d/2-1}} \end{pmatrix}$$</p>
<p>ä¸” $\boldsymbol{J}_{\theta} = \begin{pmatrix} 0 &amp; -\theta \ \theta &amp; 0 \end{pmatrix}$ã€‚</p>
<p><strong>è¯æ˜æ€è·¯</strong>ï¼šåå¯¹ç§°çŸ©é˜µçš„ç‰¹å¾å€¼æˆå…±è½­å¯¹å‡ºç°ï¼Œå³å¦‚æœ $\lambda$ æ˜¯ç‰¹å¾å€¼ï¼Œåˆ™ $-\lambda$ ä¹Ÿæ˜¯ç‰¹å¾å€¼ã€‚å¯¹äºåå¯¹ç§°çŸ©é˜µï¼Œç‰¹å¾å€¼éƒ½æ˜¯çº¯è™šæ•°ï¼Œè®°ä¸º $\pm i\theta_j$ã€‚é€šè¿‡Schuråˆ†è§£å’Œé€‚å½“çš„åŸºå˜æ¢ï¼Œå¯ä»¥å°†çŸ©é˜µåŒ–ä¸ºä¸Šè¿°åˆ†å—å¯¹è§’å½¢å¼ã€‚</p>
<h4 id="32">3.2 çŸ©é˜µæŒ‡æ•°çš„æ€§è´¨</h4>
<p>å¯¹äºåå¯¹ç§°çŸ©é˜µ $\boldsymbol{B}$ï¼ŒçŸ©é˜µæŒ‡æ•° $\exp(\boldsymbol{B})$ å®šä¹‰ä¸ºæ³°å‹’çº§æ•°ï¼š</p>
<p>$$\exp(\boldsymbol{B}) = \sum_{k=0}^{\infty} \frac{\boldsymbol{B}^k}{k!} = \boldsymbol{I} + \boldsymbol{B} + \frac{\boldsymbol{B}^2}{2!} + \frac{\boldsymbol{B}^3}{3!} + \cdots$$</p>
<p><strong>æ€§è´¨4ï¼ˆçŸ©é˜µæŒ‡æ•°çš„æ­£äº¤æ€§ï¼‰</strong>ï¼šè‹¥ $\boldsymbol{B}^{\top} = -\boldsymbol{B}$ï¼Œåˆ™ $\exp(\boldsymbol{B})$ æ˜¯æ­£äº¤çŸ©é˜µã€‚</p>
<p>è¯æ˜ï¼š
$$\begin{aligned}
(\exp(\boldsymbol{B}))^{\top} \exp(\boldsymbol{B}) &= \exp(\boldsymbol{B}^{\top}) \exp(\boldsymbol{B}) \\
&= \exp(-\boldsymbol{B}) \exp(\boldsymbol{B}) \\
&= \exp(-\boldsymbol{B} + \boldsymbol{B}) = \exp(\boldsymbol{0}) = \boldsymbol{I}
\end{aligned}$$</p>
<p>æ³¨ï¼šè¿™é‡Œä½¿ç”¨äº† $\exp(\boldsymbol{A})\exp(\boldsymbol{B}) = \exp(\boldsymbol{A} + \boldsymbol{B})$ å½“ $\boldsymbol{A}\boldsymbol{B} = \boldsymbol{B}\boldsymbol{A}$ æ—¶æˆç«‹ï¼Œè€Œ $\boldsymbol{B}$ ä¸å…¶è½¬ç½®å¿…ç„¶äº¤æ¢ã€‚</p>
<p><strong>æ€§è´¨5ï¼ˆåˆ†å—å¯¹è§’çŸ©é˜µçš„æŒ‡æ•°ï¼‰</strong>ï¼š
$$\exp\begin{pmatrix} \boldsymbol{A} & \boldsymbol{0} \\ \boldsymbol{0} & \boldsymbol{B} \end{pmatrix} = \begin{pmatrix} \exp(\boldsymbol{A}) & \boldsymbol{0} \\ \boldsymbol{0} & \exp(\boldsymbol{B}) \end{pmatrix}$$</p>
<p>å¯¹äº $\boldsymbol{J}_{\theta} = \begin{pmatrix} 0 &amp; -\theta \ \theta &amp; 0 \end{pmatrix}$ï¼Œè®¡ç®—å…¶çŸ©é˜µæŒ‡æ•°ï¼š</p>
<p>$$\boldsymbol{J}_{\theta}^2 = \begin{pmatrix} 0 & -\theta \\ \theta & 0 \end{pmatrix}\begin{pmatrix} 0 & -\theta \\ \theta & 0 \end{pmatrix} = \begin{pmatrix} -\theta^2 & 0 \\ 0 & -\theta^2 \end{pmatrix} = -\theta^2 \boldsymbol{I}$$</p>
<p>å› æ­¤ï¼š
$$\boldsymbol{J}_{\theta}^{2k} = (-1)^k \theta^{2k} \boldsymbol{I}, \quad \boldsymbol{J}_{\theta}^{2k+1} = (-1)^k \theta^{2k} \boldsymbol{J}_{\theta}$$</p>
<p>ä»£å…¥æ³°å‹’çº§æ•°ï¼š
$$\begin{aligned}
\exp(\boldsymbol{J}_{\theta}) &= \sum_{k=0}^{\infty} \frac{\boldsymbol{J}_{\theta}^k}{k!} \\
&= \sum_{k=0}^{\infty} \frac{\boldsymbol{J}_{\theta}^{2k}}{(2k)!} + \sum_{k=0}^{\infty} \frac{\boldsymbol{J}_{\theta}^{2k+1}}{(2k+1)!} \\
&= \boldsymbol{I} \sum_{k=0}^{\infty} \frac{(-1)^k \theta^{2k}}{(2k)!} + \boldsymbol{J}_{\theta} \sum_{k=0}^{\infty} \frac{(-1)^k \theta^{2k}}{(2k+1)!} \\
&= \boldsymbol{I} \cos\theta + \boldsymbol{J}_{\theta} \frac{\sin\theta}{\theta}
\end{aligned}$$</p>
<p>å…·ä½“å±•å¼€ï¼š
$$\exp(\boldsymbol{J}_{\theta}) = \begin{pmatrix} \cos\theta & -\sin\theta \\ \sin\theta & \cos\theta \end{pmatrix} = \boldsymbol{R}_{\theta}$$</p>
<h4 id="33">3.3 å®Œå¤‡æ€§å®šç†çš„è¯æ˜</h4>
<p><strong>å®šç†4ï¼ˆRoPEçš„å®Œå¤‡æ€§å®šç†ï¼‰</strong>ï¼šå¯¹äºSelf Attentionï¼Œåˆ†å—å¯¹è§’å½¢å¼çš„RoPEç¼–ç ä¸ä¸€èˆ¬çš„åå¯¹ç§°çŸ©é˜µæŒ‡æ•°å½¢å¼ $\exp(n\boldsymbol{B})$ åœ¨è¡¨è¾¾èƒ½åŠ›ä¸Šæ˜¯ç­‰ä»·çš„ã€‚</p>
<p><strong>è¯æ˜</strong>ï¼š</p>
<p>è®¾ $\boldsymbol{B}$ æ˜¯ä»»æ„ $d$ é˜¶åå¯¹ç§°çŸ©é˜µï¼Œç”±å®šç†3ï¼Œå­˜åœ¨æ­£äº¤çŸ©é˜µ $\boldsymbol{P}$ ä½¿å¾—ï¼š
$$\boldsymbol{B} = \boldsymbol{P} \boldsymbol{\Lambda} \boldsymbol{P}^{\top}$$</p>
<p>å› æ­¤ï¼š
$$\exp(n\boldsymbol{B}) = \exp(n\boldsymbol{P}\boldsymbol{\Lambda}\boldsymbol{P}^{\top})$$</p>
<p>åˆ©ç”¨çŸ©é˜µæŒ‡æ•°çš„ç›¸ä¼¼ä¸å˜æ€§è´¨ $\exp(\boldsymbol{P}\boldsymbol{A}\boldsymbol{P}^{-1}) = \boldsymbol{P}\exp(\boldsymbol{A})\boldsymbol{P}^{-1}$ï¼ˆå¯¹äºæ­£äº¤çŸ©é˜µ $\boldsymbol{P}^{-1} = \boldsymbol{P}^{\top}$ï¼‰ï¼š</p>
<p>$$\exp(n\boldsymbol{B}) = \boldsymbol{P} \exp(n\boldsymbol{\Lambda}) \boldsymbol{P}^{\top}$$</p>
<p>åœ¨Self Attentionä¸­çš„åº”ç”¨ï¼š
$$\begin{aligned}
\boldsymbol{q}_m^{\top} \exp((n-m)\boldsymbol{B}) \boldsymbol{k}_n &= \boldsymbol{q}_m^{\top} \boldsymbol{P} \exp((n-m)\boldsymbol{\Lambda}) \boldsymbol{P}^{\top} \boldsymbol{k}_n \\
&= (\boldsymbol{P}^{\top}\boldsymbol{q}_m)^{\top} \exp((n-m)\boldsymbol{\Lambda}) (\boldsymbol{P}^{\top}\boldsymbol{k}_n)
\end{aligned}$$</p>
<p>è®¾ $\tilde{\boldsymbol{q}}_m = \boldsymbol{P}^{\top}\boldsymbol{q}_m$ï¼Œ$\tilde{\boldsymbol{k}}_n = \boldsymbol{P}^{\top}\boldsymbol{k}_n$ã€‚</p>
<p>åœ¨ç¥ç»ç½‘ç»œä¸­ï¼Œ$\boldsymbol{q}_m$ å’Œ $\boldsymbol{k}_n$ é€šå¸¸æ˜¯è¾“å…¥ $\boldsymbol{x}$ ç»è¿‡çº¿æ€§å˜æ¢å¾—åˆ°ï¼š
$$\boldsymbol{q}_m = \boldsymbol{W}_Q \boldsymbol{x}_m, \quad \boldsymbol{k}_n = \boldsymbol{W}_K \boldsymbol{x}_n$$</p>
<p>åˆ™ï¼š
$$\tilde{\boldsymbol{q}}_m = \boldsymbol{P}^{\top}\boldsymbol{W}_Q \boldsymbol{x}_m = \tilde{\boldsymbol{W}}_Q \boldsymbol{x}_m, \quad \tilde{\boldsymbol{k}}_n = \boldsymbol{P}^{\top}\boldsymbol{W}_K \boldsymbol{x}_n = \tilde{\boldsymbol{W}}_K \boldsymbol{x}_n$$</p>
<p>å…¶ä¸­ $\tilde{\boldsymbol{W}}_Q = \boldsymbol{P}^{\top}\boldsymbol{W}_Q$ï¼Œ$\tilde{\boldsymbol{W}}_K = \boldsymbol{P}^{\top}\boldsymbol{W}_K$ã€‚</p>
<p>ç”±äº $\boldsymbol{W}_Q$ å’Œ $\boldsymbol{W}_K$ æ˜¯å¯è®­ç»ƒå‚æ•°ï¼Œ$\boldsymbol{P}^{\top}$ å¯ä»¥è¢«å¸æ”¶åˆ°è¿™äº›å‚æ•°ä¸­ã€‚å› æ­¤ï¼Œä½¿ç”¨ä¸€èˆ¬çš„ $\exp(n\boldsymbol{B})$ ä¸ä½¿ç”¨åˆ†å—å¯¹è§’çš„ $\exp(n\boldsymbol{\Lambda})$ åœ¨è¡¨è¾¾èƒ½åŠ›ä¸Šæ˜¯ç­‰ä»·çš„ã€‚</p>
<p><strong>æ¨è®º</strong>ï¼šè¿™æ„å‘³ç€æˆ‘ä»¬ä¸éœ€è¦ä½¿ç”¨æ›´å¤æ‚çš„å…¨å‚æ•°åå¯¹ç§°çŸ©é˜µå½¢å¼ï¼Œç®€å•çš„åˆ†å—å¯¹è§’RoPEå·²ç»å…·æœ‰å®Œå¤‡çš„è¡¨è¾¾èƒ½åŠ›ã€‚</p>
<h3 id="4">4. æ­£äº¤æ€§è´¨ä¸èŒƒæ•°ä¿æŒ</h3>
<h4 id="41-rope">4.1 RoPEå˜æ¢çš„ç­‰è·æ€§</h4>
<p><strong>å®šç†5ï¼ˆRoPEçš„ç­‰è·æ€§ï¼‰</strong>ï¼šRoPEå˜æ¢ä¿æŒå‘é‡çš„æ¬§å‡ é‡Œå¾—èŒƒæ•°ã€‚</p>
<p>è¯æ˜ï¼šå¯¹äºå‘é‡ $\boldsymbol{v}$ï¼Œåº”ç”¨RoPEå˜æ¢åä¸º $\boldsymbol{\mathcal{R}}_m \boldsymbol{v}$ï¼Œå…¶èŒƒæ•°ä¸ºï¼š</p>
<p>$$\|\boldsymbol{\mathcal{R}}_m \boldsymbol{v}\|^2 = (\boldsymbol{\mathcal{R}}_m \boldsymbol{v})^{\top} (\boldsymbol{\mathcal{R}}_m \boldsymbol{v}) = \boldsymbol{v}^{\top} \boldsymbol{\mathcal{R}}_m^{\top} \boldsymbol{\mathcal{R}}_m \boldsymbol{v}$$</p>
<p>ç”±äº $\boldsymbol{\mathcal{R}}_m$ æ˜¯æ­£äº¤çŸ©é˜µï¼Œ$\boldsymbol{\mathcal{R}}_m^{\top} \boldsymbol{\mathcal{R}}_m = \boldsymbol{I}$ï¼š</p>
<p>$$\|\boldsymbol{\mathcal{R}}_m \boldsymbol{v}\|^2 = \boldsymbol{v}^{\top} \boldsymbol{v} = \|\boldsymbol{v}\|^2$$</p>
<p>è¿™è¡¨æ˜RoPEå˜æ¢ä¸æ”¹å˜å‘é‡çš„é•¿åº¦ã€‚</p>
<h4 id="42">4.2 å†…ç§¯çš„å˜åŒ–</h4>
<p>å¯¹äºä¸¤ä¸ªå‘é‡ $\boldsymbol{u}$ å’Œ $\boldsymbol{v}$ï¼Œåº”ç”¨ä¸åŒçš„RoPEå˜æ¢åçš„å†…ç§¯ï¼š</p>
<p>$$\langle \boldsymbol{\mathcal{R}}_m \boldsymbol{u}, \boldsymbol{\mathcal{R}}_n \boldsymbol{v} \rangle = \boldsymbol{u}^{\top} \boldsymbol{\mathcal{R}}_m^{\top} \boldsymbol{\mathcal{R}}_n \boldsymbol{v} = \boldsymbol{u}^{\top} \boldsymbol{\mathcal{R}}_{n-m} \boldsymbol{v}$$</p>
<p>è¿™ä¸ªå†…ç§¯ä»…ä¾èµ–äºç›¸å¯¹ä½ç½® $n-m$ å’ŒåŸå§‹å‘é‡ $\boldsymbol{u}$ã€$\boldsymbol{v}$ã€‚</p>
<h4 id="43">4.3 è§’åº¦çš„ä¿æŒ</h4>
<p>å¯¹äºåŒä¸€ä½ç½®çš„ä¸¤ä¸ªå‘é‡ $\boldsymbol{u}$ å’Œ $\boldsymbol{v}$ï¼Œåº”ç”¨ç›¸åŒçš„RoPEå˜æ¢åï¼š</p>
<p>$$\cos\angle(\boldsymbol{\mathcal{R}}_m \boldsymbol{u}, \boldsymbol{\mathcal{R}}_m \boldsymbol{v}) = \frac{\langle \boldsymbol{\mathcal{R}}_m \boldsymbol{u}, \boldsymbol{\mathcal{R}}_m \boldsymbol{v} \rangle}{\|\boldsymbol{\mathcal{R}}_m \boldsymbol{u}\| \|\boldsymbol{\mathcal{R}}_m \boldsymbol{v}\|}$$</p>
<p>ç”±äºRoPEçš„æ­£äº¤æ€§ï¼š
$$\langle \boldsymbol{\mathcal{R}}_m \boldsymbol{u}, \boldsymbol{\mathcal{R}}_m \boldsymbol{v} \rangle = \boldsymbol{u}^{\top} \boldsymbol{\mathcal{R}}_m^{\top} \boldsymbol{\mathcal{R}}_m \boldsymbol{v} = \boldsymbol{u}^{\top} \boldsymbol{v} = \langle \boldsymbol{u}, \boldsymbol{v} \rangle$$</p>
<p>ä¸”ï¼š
$$\|\boldsymbol{\mathcal{R}}_m \boldsymbol{u}\| = \|\boldsymbol{u}\|, \quad \|\boldsymbol{\mathcal{R}}_m \boldsymbol{v}\| = \|\boldsymbol{v}\|$$</p>
<p>å› æ­¤ï¼š
$$\cos\angle(\boldsymbol{\mathcal{R}}_m \boldsymbol{u}, \boldsymbol{\mathcal{R}}_m \boldsymbol{v}) = \frac{\langle \boldsymbol{u}, \boldsymbol{v} \rangle}{\|\boldsymbol{u}\| \|\boldsymbol{v}\|} = \cos\angle(\boldsymbol{u}, \boldsymbol{v})$$</p>
<p><strong>å®šç†6ï¼ˆè§’åº¦ä¿æŒæ€§ï¼‰</strong>ï¼šåœ¨åŒä¸€ä½ç½®ï¼ŒRoPEå˜æ¢ä¿æŒå‘é‡ä¹‹é—´çš„å¤¹è§’ä¸å˜ã€‚</p>
<h3 id="5">5. å¤šç»´æ¨å¹¿ä¸ç»´åº¦åˆ†è§£</h3>
<h4 id="51">5.1 é«˜ç»´æ—‹è½¬çš„åˆ†è§£</h4>
<p>å¯¹äº $d$ ç»´ç©ºé—´ï¼ˆ$d$ ä¸ºå¶æ•°ï¼‰ï¼Œä»»æ„æ—‹è½¬å¯ä»¥åˆ†è§£ä¸º $d/2$ ä¸ªäºŒç»´å¹³é¢ä¸Šçš„æ—‹è½¬ã€‚</p>
<p>è®¾ $d = 2k$ï¼Œåˆ™ $d$ ç»´å‘é‡å¯ä»¥çœ‹ä½œ $k$ ä¸ªäºŒç»´å‘é‡çš„æ‹¼æ¥ï¼š
$$\boldsymbol{v} = \begin{pmatrix} \boldsymbol{v}_0 \\ \boldsymbol{v}_1 \\ \vdots \\ \boldsymbol{v}_{k-1} \end{pmatrix}, \quad \boldsymbol{v}_i \in \mathbb{R}^2$$</p>
<p>RoPEå˜æ¢ä¸ºï¼š
$$\boldsymbol{\mathcal{R}}_m \boldsymbol{v} = \begin{pmatrix} \boldsymbol{R}_{m\theta_0} \boldsymbol{v}_0 \\ \boldsymbol{R}_{m\theta_1} \boldsymbol{v}_1 \\ \vdots \\ \boldsymbol{R}_{m\theta_{k-1}} \boldsymbol{v}_{k-1} \end{pmatrix}$$</p>
<h4 id="52">5.2 é¢‘ç‡çš„é€‰æ‹©</h4>
<p>æ—‹è½¬é¢‘ç‡ $\theta_i$ çš„é€‰æ‹©éµå¾ªå‡ ä½•çº§æ•°ï¼š
$$\theta_i = \theta_{\text{base}}^{-2i/d}$$</p>
<p>è¿™ç§é€‰æ‹©çš„ä¼˜ç‚¹ï¼š
1. <strong>å¤šå°ºåº¦è¡¨ç¤º</strong>ï¼šä¸åŒçš„é¢‘ç‡èƒ½å¤Ÿç¼–ç ä¸åŒå°ºåº¦çš„ä½ç½®ä¿¡æ¯
2. <strong>å®¹é‡å……åˆ†</strong>ï¼šä»é«˜é¢‘åˆ°ä½é¢‘è¦†ç›–äº†å¹¿æ³›çš„é¢‘ç‡èŒƒå›´
3. <strong>å¹³æ»‘è¿‡æ¸¡</strong>ï¼šå‡ ä½•çº§æ•°ä¿è¯äº†é¢‘ç‡çš„å¹³æ»‘é€’å‡</p>
<p>å¯¹äºåŸºç¡€é¢‘ç‡ $\theta_{\text{base}} = 10000$ï¼Œç¬¬ $i$ ä¸ªç»´åº¦å¯¹çš„å‘¨æœŸä¸ºï¼š
$$T_i = \frac{2\pi}{\theta_i} = 2\pi \cdot 10000^{2i/d}$$</p>
<p>å½“ $i = 0$ æ—¶ï¼Œ$T_0 = 2\pi$ï¼Œå‘¨æœŸæœ€çŸ­ï¼›
å½“ $i = d/2-1$ æ—¶ï¼Œ$T_{d/2-1} = 2\pi \cdot 10000$ï¼Œå‘¨æœŸæœ€é•¿ã€‚</p>
<h4 id="53">5.3 ç»´åº¦å¯¹çš„ç‹¬ç«‹æ€§</h4>
<p><strong>å®šç†7ï¼ˆç»´åº¦å¯¹çš„æ­£äº¤æ€§ï¼‰</strong>ï¼šä¸åŒç»´åº¦å¯¹çš„æ—‹è½¬æ“ä½œæ˜¯ç›¸äº’ç‹¬ç«‹çš„ã€‚</p>
<p>è¯æ˜ï¼šç”±äº $\boldsymbol{\mathcal{R}}_m$ æ˜¯åˆ†å—å¯¹è§’çŸ©é˜µï¼Œä¸åŒå—ä¹‹é—´æ²¡æœ‰è€¦åˆï¼š</p>
<p>$$\boldsymbol{\mathcal{R}}_m = \begin{pmatrix} \boldsymbol{R}_{m\theta_0} & & & \\ & \boldsymbol{R}_{m\theta_1} & & \\ & & \ddots & \\ & & & \boldsymbol{R}_{m\theta_{d/2-1}} \end{pmatrix}$$</p>
<p>å¯¹äºç»´åº¦å¯¹ $i$ å’Œ $j$ï¼ˆ$i \neq j$ï¼‰ï¼Œå®ƒä»¬çš„å˜æ¢äº’ä¸å½±å“ï¼š
$$\frac{\partial (\boldsymbol{\mathcal{R}}_m \boldsymbol{v})_{2i:2i+2}}{\partial \boldsymbol{v}_{2j:2j+2}} = \boldsymbol{0}$$</p>
<p>è¿™ç§ç‹¬ç«‹æ€§ä½¿å¾—æ¨¡å‹å¯ä»¥åœ¨ä¸åŒé¢‘ç‡å°ºåº¦ä¸Šç‹¬ç«‹å­¦ä¹ ä½ç½®ä¿¡æ¯ã€‚</p>
<h3 id="6">6. ä¸å…¶ä»–ä½ç½®ç¼–ç çš„å¯¹æ¯”åˆ†æ</h3>
<h4 id="61-sinusoidal">6.1 ä¸Sinusoidalä½ç½®ç¼–ç çš„å¯¹æ¯”</h4>
<p><strong>Sinusoidalç¼–ç </strong>ï¼š
$$\begin{aligned}
PE(m, 2i) &= \sin(m / 10000^{2i/d}) \\
PE(m, 2i+1) &= \cos(m / 10000^{2i/d})
\end{aligned}$$</p>
<p>è¿™æ˜¯ä¸€ç§ç»å¯¹ä½ç½®ç¼–ç ï¼Œç›´æ¥åŠ åœ¨è¾“å…¥å‘é‡ä¸Šï¼š
$$\boldsymbol{x}_m' = \boldsymbol{x}_m + PE(m)$$</p>
<p><strong>ç›¸å¯¹ä½ç½®çš„å®ç°</strong>ï¼šSinusoidalç¼–ç å¯ä»¥é€šè¿‡ä¸‰è§’æ’ç­‰å¼å®ç°ç›¸å¯¹ä½ç½®ï¼š
$$\begin{aligned}
PE(m, 2i) \cdot PE(n, 2i) + PE(m, 2i+1) \cdot PE(n, 2i+1)
&= \sin(m\omega_i)\sin(n\omega_i) + \cos(m\omega_i)\cos(n\omega_i) \\
&= \cos((m-n)\omega_i)
\end{aligned}$$</p>
<p>å…¶ä¸­ $\omega_i = 1/10000^{2i/d}$ã€‚</p>
<p><strong>ä¸RoPEçš„åŒºåˆ«</strong>ï¼š
1. <strong>ä½œç”¨æ–¹å¼</strong>ï¼šSinusoidalæ˜¯åŠ æ³•ï¼ŒRoPEæ˜¯æ—‹è½¬ï¼ˆä¹˜æ³•ï¼‰
2. <strong>ç›¸å¯¹ä½ç½®</strong>ï¼šSinusoidaléœ€è¦é€šè¿‡ç‚¹ç§¯é—´æ¥è·å¾—ï¼ŒRoPEç›´æ¥å»ºæ¨¡
3. <strong>èŒƒæ•°ä¿æŒ</strong>ï¼šRoPEä¿æŒèŒƒæ•°ï¼ŒSinusoidalæ”¹å˜èŒƒæ•°</p>
<h4 id="62">6.2 ä¸å¯è®­ç»ƒä½ç½®ç¼–ç çš„å¯¹æ¯”</h4>
<p><strong>å¯è®­ç»ƒä½ç½®ç¼–ç </strong>ï¼š
$$PE(m) = \boldsymbol{E}_m \in \mathbb{R}^d$$</p>
<p>å…¶ä¸­ $\boldsymbol{E}_m$ æ˜¯å¯å­¦ä¹ çš„å‚æ•°çŸ©é˜µçš„ç¬¬ $m$ è¡Œã€‚</p>
<p><strong>ä¼˜ç¼ºç‚¹å¯¹æ¯”</strong>ï¼š</p>
<table>
<thead>
<tr>
<th>ç‰¹æ€§</th>
<th>å¯è®­ç»ƒä½ç½®ç¼–ç </th>
<th>RoPE</th>
</tr>
</thead>
<tbody>
<tr>
<td>å‚æ•°é‡</td>
<td>$O(L \cdot d)$ï¼ˆ$L$ ä¸ºæœ€å¤§é•¿åº¦ï¼‰</td>
<td>æ— å‚æ•°</td>
</tr>
<tr>
<td>å¤–æ¨èƒ½åŠ›</td>
<td>å·®ï¼ˆæœªè§è¿‡çš„ä½ç½®æ— ç¼–ç ï¼‰</td>
<td>å¥½ï¼ˆå‡½æ•°å¼å®šä¹‰ï¼‰</td>
</tr>
<tr>
<td>ç›¸å¯¹ä½ç½®</td>
<td>éœ€è¦é¢å¤–è®¾è®¡</td>
<td>å¤©ç„¶æ”¯æŒ</td>
</tr>
<tr>
<td>çµæ´»æ€§</td>
<td>é«˜ï¼ˆå®Œå…¨å¯å­¦ä¹ ï¼‰</td>
<td>ä½ï¼ˆå›ºå®šå‡½æ•°å½¢å¼ï¼‰</td>
</tr>
</tbody>
</table>
<h4 id="63-rpe">6.3 ä¸ç›¸å¯¹ä½ç½®ç¼–ç ï¼ˆRPEï¼‰çš„å¯¹æ¯”</h4>
<p><strong>ç›¸å¯¹ä½ç½®ç¼–ç ï¼ˆRelative Position Encodingï¼‰</strong>ï¼š
$$\text{score}(m, n) = \boldsymbol{q}_m^{\top} \boldsymbol{k}_n + \boldsymbol{q}_m^{\top} \boldsymbol{r}_{m-n}$$</p>
<p>å…¶ä¸­ $\boldsymbol{r}_{m-n}$ æ˜¯å¯è®­ç»ƒçš„ç›¸å¯¹ä½ç½®åµŒå…¥ã€‚</p>
<p><strong>Shawç­‰äººçš„æ–¹æ³•</strong>ï¼š
$$\text{score}(m, n) = \boldsymbol{q}_m^{\top} \boldsymbol{k}_n + \boldsymbol{q}_m^{\top} \boldsymbol{W}_K^{\top} \boldsymbol{r}_{m-n}^K$$</p>
<p><strong>ä¸RoPEçš„åŒºåˆ«</strong>ï¼š
1. <strong>å®ç°æ–¹å¼</strong>ï¼šRPEæ˜¯åŠ æ³•åç½®ï¼ŒRoPEæ˜¯æ—‹è½¬å˜æ¢
2. <strong>å‚æ•°æ•ˆç‡</strong>ï¼šRPEéœ€è¦å­˜å‚¨ç›¸å¯¹ä½ç½®åµŒå…¥ï¼ŒRoPEæ— å‚æ•°
3. <strong>è®¡ç®—æ•ˆç‡</strong>ï¼šRoPEå¯ä»¥é¢„å…ˆè®¡ç®—æ—‹è½¬çŸ©é˜µï¼Œæ•ˆç‡æ›´é«˜</p>
<h4 id="64">6.4 å®šé‡å¯¹æ¯”åˆ†æ</h4>
<p>è®¾åºåˆ—é•¿åº¦ä¸º $L$ï¼Œéšè—ç»´åº¦ä¸º $d$ï¼Œåˆ™ï¼š</p>
<p><strong>ç©ºé—´å¤æ‚åº¦</strong>ï¼š
- Sinusoidalï¼š$O(1)$ï¼ˆæ— å‚æ•°ï¼‰
- å¯è®­ç»ƒç»å¯¹ä½ç½®ï¼š$O(Ld)$
- ç›¸å¯¹ä½ç½®ç¼–ç ï¼ˆRPEï¼‰ï¼š$O(L^2 d)$ æˆ– $O(Ld)$ï¼ˆæˆªæ–­ç‰ˆæœ¬ï¼‰
- RoPEï¼š$O(1)$ï¼ˆæ— å‚æ•°ï¼Œé¢„è®¡ç®—æ—‹è½¬çŸ©é˜µä¸º $O(d)$ï¼‰</p>
<p><strong>æ—¶é—´å¤æ‚åº¦ï¼ˆæ¯ä¸ªä½ç½®å¯¹ï¼‰</strong>ï¼š
- Sinusoidalï¼š$O(d)$ï¼ˆåŠ æ³•ï¼‰
- å¯è®­ç»ƒç»å¯¹ä½ç½®ï¼š$O(d)$ï¼ˆåŠ æ³•ï¼‰
- ç›¸å¯¹ä½ç½®ç¼–ç ï¼š$O(d)$ï¼ˆåŠ æ³•åç½®ï¼‰
- RoPEï¼š$O(d)$ï¼ˆæ—‹è½¬ï¼Œå¯é¢„è®¡ç®—ï¼‰</p>
<p><strong>å¤–æ¨æ€§èƒ½</strong>ï¼š
- Sinusoidalï¼šä¸­ç­‰ï¼ˆå‡½æ•°å¼ä½†é«˜é¢‘æŒ¯è¡ï¼‰
- å¯è®­ç»ƒç»å¯¹ä½ç½®ï¼šå·®ï¼ˆéœ€è¦é‡æ–°è®­ç»ƒï¼‰
- ç›¸å¯¹ä½ç½®ç¼–ç ï¼šä¸­ç­‰ï¼ˆéœ€è¦å¤–æ¨æ–°çš„ç›¸å¯¹ä½ç½®ï¼‰
- RoPEï¼šå¥½ï¼ˆå¤©ç„¶æ”¯æŒä»»æ„é•¿åº¦ï¼‰</p>
<h3 id="7-baker-campbell-hausdorff">7. ç†è®ºæ·±åŒ–ï¼šBaker-Campbell-Hausdorffå…¬å¼</h3>
<h4 id="71-bch">7.1 BCHå…¬å¼çš„è¡¨è¿°</h4>
<p>å¯¹äºçŸ©é˜µ $\boldsymbol{A}$ å’Œ $\boldsymbol{B}$ï¼ŒBaker-Campbell-Hausdorffå…¬å¼ç»™å‡ºï¼š</p>
<p>$$\log(\exp(\boldsymbol{A})\exp(\boldsymbol{B})) = \boldsymbol{A} + \boldsymbol{B} + \frac{1}{2}[\boldsymbol{A}, \boldsymbol{B}] + \frac{1}{12}[\boldsymbol{A}, [\boldsymbol{A}, \boldsymbol{B}]] - \frac{1}{12}[\boldsymbol{B}, [\boldsymbol{A}, \boldsymbol{B}]] + \cdots$$</p>
<p>å…¶ä¸­ $[\boldsymbol{A}, \boldsymbol{B}] = \boldsymbol{A}\boldsymbol{B} - \boldsymbol{B}\boldsymbol{A}$ æ˜¯çŸ©é˜µçš„Lieæ‹¬å·ã€‚</p>
<h4 id="72-rope">7.2 åº”ç”¨äºRoPEçš„éªŒè¯</h4>
<p>å¯¹äºRoPEï¼Œæˆ‘ä»¬éœ€è¦éªŒè¯ï¼š
$$\exp(m\boldsymbol{B})^{\top} \exp(n\boldsymbol{B}) = \exp((n-m)\boldsymbol{B})$$</p>
<p>ç”±äº $\boldsymbol{B}$ æ˜¯åå¯¹ç§°çŸ©é˜µï¼ˆ$\boldsymbol{B}^{\top} = -\boldsymbol{B}$ï¼‰ï¼Œæˆ‘ä»¬æœ‰ï¼š
$$\exp(m\boldsymbol{B})^{\top} = \exp(m\boldsymbol{B}^{\top}) = \exp(-m\boldsymbol{B})$$</p>
<p>åº”ç”¨BCHå…¬å¼ï¼š
$$\begin{aligned}
\log(\exp(-m\boldsymbol{B})\exp(n\boldsymbol{B})) &= -m\boldsymbol{B} + n\boldsymbol{B} + \frac{1}{2}[-m\boldsymbol{B}, n\boldsymbol{B}] + \cdots \\
&= (n-m)\boldsymbol{B} + \frac{-mn}{2}[\boldsymbol{B}, \boldsymbol{B}] + \cdots
\end{aligned}$$</p>
<p>ç”±äº $[\boldsymbol{B}, \boldsymbol{B}] = \boldsymbol{B}\boldsymbol{B} - \boldsymbol{B}\boldsymbol{B} = \boldsymbol{0}$ï¼Œæ‰€æœ‰é«˜é˜¶é¡¹éƒ½ä¸ºé›¶ï¼š</p>
<p>$$\log(\exp(-m\boldsymbol{B})\exp(n\boldsymbol{B})) = (n-m)\boldsymbol{B}$$</p>
<p>å› æ­¤ï¼š
$$\exp(-m\boldsymbol{B})\exp(n\boldsymbol{B}) = \exp((n-m)\boldsymbol{B})$$</p>
<p>è¿™è¯æ˜äº†RoPEçš„ç›¸å¯¹ä½ç½®æ€§è´¨ã€‚</p>
<h4 id="73-lie">7.3 åå¯¹ç§°çŸ©é˜µçš„Lieä»£æ•°ç»“æ„</h4>
<p>åå¯¹ç§°çŸ©é˜µæ„æˆä¸€ä¸ªLieä»£æ•° $\mathfrak{so}(d)$ï¼ˆspecial orthogonal Lie algebraï¼‰ï¼š</p>
<p><strong>å°é—­æ€§</strong>ï¼šå¯¹äºåå¯¹ç§°çŸ©é˜µ $\boldsymbol{A}, \boldsymbol{B}$ï¼Œ$[\boldsymbol{A}, \boldsymbol{B}]$ ä»æ˜¯åå¯¹ç§°çŸ©é˜µã€‚</p>
<p>è¯æ˜ï¼š
$$\begin{aligned}
[\boldsymbol{A}, \boldsymbol{B}]^{\top} &= (\boldsymbol{A}\boldsymbol{B} - \boldsymbol{B}\boldsymbol{A})^{\top} \\
&= \boldsymbol{B}^{\top}\boldsymbol{A}^{\top} - \boldsymbol{A}^{\top}\boldsymbol{B}^{\top} \\
&= (-\boldsymbol{B})(-\boldsymbol{A}) - (-\boldsymbol{A})(-\boldsymbol{B}) \\
&= \boldsymbol{B}\boldsymbol{A} - \boldsymbol{A}\boldsymbol{B} \\
&= -[\boldsymbol{A}, \boldsymbol{B}]
\end{aligned}$$</p>
<p><strong>ç»´åº¦</strong>ï¼š$d$ ç»´ç©ºé—´çš„åå¯¹ç§°çŸ©é˜µæœ‰ $\binom{d}{2} = \frac{d(d-1)}{2}$ ä¸ªè‡ªç”±åº¦ã€‚</p>
<p>å¯¹äº $d = 2$ï¼Œåªæœ‰1ä¸ªè‡ªç”±åº¦ï¼›å¯¹äº $d = 4$ï¼Œæœ‰6ä¸ªè‡ªç”±åº¦ã€‚</p>
<h3 id="8">8. æ•°å€¼ç¨³å®šæ€§åˆ†æ</h3>
<h4 id="81">8.1 æµ®ç‚¹ç²¾åº¦çš„å½±å“</h4>
<p>åœ¨å®é™…è®¡ç®—ä¸­ï¼Œæ—‹è½¬çŸ©é˜µçš„è®¡ç®—æ¶‰åŠä¸‰è§’å‡½æ•°ï¼š
$$\boldsymbol{R}_{\theta} = \begin{pmatrix} \cos\theta & -\sin\theta \\ \sin\theta & \cos\theta \end{pmatrix}$$</p>
<p>å¯¹äºå¤§çš„ä½ç½®ç´¢å¼• $m$ å’Œå°çš„é¢‘ç‡ $\theta_i$ï¼Œ$m\theta_i$ å¯èƒ½éå¸¸å¤§ï¼Œå¯¼è‡´ï¼š
1. æµ®ç‚¹æ•°ç²¾åº¦æŸå¤±
2. å‘¨æœŸæ€§æ··å </p>
<p><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼šé€šè¿‡æ¨¡è¿ç®—å½’çº¦åˆ° $[0, 2\pi)$ï¼š
$$m\theta_i \leftarrow (m\theta_i) \mod 2\pi$$</p>
<h4 id="82">8.2 æ­£äº¤æ€§çš„æ•°å€¼ä¿æŒ</h4>
<p>ç†è®ºä¸Š $\boldsymbol{\mathcal{R}}_m$ æ˜¯æ­£äº¤çŸ©é˜µï¼Œä½†æ•°å€¼è®¡ç®—å¯èƒ½å¯¼è‡´åç¦»ï¼š
$$\|\boldsymbol{\mathcal{R}}_m^{\top}\boldsymbol{\mathcal{R}}_m - \boldsymbol{I}\|_F = \epsilon$$</p>
<p>å…¶ä¸­ $\epsilon$ æ˜¯æ•°å€¼è¯¯å·®ã€‚</p>
<p><strong>è¯¯å·®ç´¯ç§¯</strong>ï¼šåœ¨é•¿åºåˆ—ä¸­ï¼Œå¤šæ¬¡çŸ©é˜µä¹˜æ³•å¯èƒ½ç´¯ç§¯è¯¯å·®ã€‚</p>
<p><strong>ç¼“è§£æªæ–½</strong>ï¼š
1. ä½¿ç”¨æ›´é«˜ç²¾åº¦ï¼ˆå¦‚float64ï¼‰è®¡ç®—æ—‹è½¬çŸ©é˜µ
2. é¢„è®¡ç®—å¹¶ç¼“å­˜æ—‹è½¬çŸ©é˜µ
3. å®šæœŸé‡æ–°æ­£äº¤åŒ–ï¼ˆGram-Schmidtè¿‡ç¨‹ï¼‰</p>
<h4 id="83">8.3 å¤æ•°å®ç°çš„ä¼˜åŠ¿</h4>
<p>ä½¿ç”¨å¤æ•°è¡¨ç¤ºå¯ä»¥é¿å…æ˜¾å¼æ„é€ æ—‹è½¬çŸ©é˜µï¼š
$$z' = e^{i\theta} z$$</p>
<p>å¤æ•°ä¹˜æ³•æ¯”çŸ©é˜µä¹˜æ³•æ›´é«˜æ•ˆï¼Œä¸”æ•°å€¼ç¨³å®šæ€§æ›´å¥½ï¼š
- çŸ©é˜µä¹˜æ³•ï¼š$O(4)$ æ¬¡æµ®ç‚¹è¿ç®—ï¼ˆ2Ã—2çŸ©é˜µï¼‰
- å¤æ•°ä¹˜æ³•ï¼š$O(3)$ æ¬¡æµ®ç‚¹è¿ç®—ï¼ˆä¼˜åŒ–çš„å¤æ•°ä¹˜æ³•ï¼‰</p>
<h3 id="9">9. æ€»ç»“ä¸å±•æœ›</h3>
<h4 id="91">9.1 ä¸»è¦ç»“è®ºæ±‡æ€»</h4>
<ol>
<li><strong>å®Œå¤‡æ€§</strong>ï¼šåˆ†å—å¯¹è§’RoPEä¸å…¨å‚æ•°åå¯¹ç§°çŸ©é˜µæŒ‡æ•°åœ¨Self Attentionä¸­ç­‰ä»·</li>
<li><strong>æ­£äº¤æ€§</strong>ï¼šRoPEä¿æŒå‘é‡èŒƒæ•°å’Œè§’åº¦ï¼Œæ˜¯ç­‰è·å˜æ¢</li>
<li><strong>ç›¸å¯¹ä½ç½®</strong>ï¼šRoPEå¤©ç„¶å®ç°ç›¸å¯¹ä½ç½®ç¼–ç ï¼Œä»…ä¾èµ– $n-m$</li>
<li><strong>å‚æ•°æ•ˆç‡</strong>ï¼šRoPEæ— éœ€ä»»ä½•å¯è®­ç»ƒå‚æ•°</li>
<li><strong>è®¡ç®—æ•ˆç‡</strong>ï¼šé€šè¿‡é¢„è®¡ç®—å¯é«˜æ•ˆå®ç°</li>
</ol>
<h4 id="92">9.2 ç†è®ºæ„ä¹‰</h4>
<ul>
<li>è¯æ˜äº†ç®€å•çš„åˆ†å—å¯¹è§’ç»“æ„å…·æœ‰å®Œå¤‡çš„è¡¨è¾¾èƒ½åŠ›</li>
<li>ä¸éœ€è¦æ›´å¤æ‚çš„è®¾è®¡å°±èƒ½è¾¾åˆ°ç†è®ºä¸Šçš„æœ€ä¼˜</li>
<li>ä¸ºä½ç½®ç¼–ç çš„è®¾è®¡æä¾›äº†ç†è®ºæŒ‡å¯¼</li>
</ul>
<h4 id="93">9.3 å®è·µä»·å€¼</h4>
<ul>
<li>é™ä½äº†å®ç°å¤æ‚åº¦</li>
<li>æé«˜äº†è®¡ç®—æ•ˆç‡</li>
<li>ä¿è¯äº†æ•°å€¼ç¨³å®šæ€§</li>
</ul>
<p>æœ¬æ–‡é€šè¿‡ä¸¥æ ¼çš„æ•°å­¦æ¨å¯¼ï¼Œè¯æ˜äº†RoPEçš„å®Œå¤‡æ€§ï¼Œè¡¨æ˜å½“å‰çš„åˆ†å—å¯¹è§’è®¾è®¡å·²ç»æ˜¯ç†è®ºæœ€ä¼˜çš„é€‰æ‹©ï¼Œä¸éœ€è¦è¿›ä¸€æ­¥å¤æ‚åŒ–ã€‚è¿™ä¸ºRoPEåœ¨å®è·µä¸­çš„å¹¿æ³›åº”ç”¨æä¾›äº†åšå®çš„ç†è®ºåŸºç¡€ã€‚</p>
        </div>
    </div>
</body>
</html>