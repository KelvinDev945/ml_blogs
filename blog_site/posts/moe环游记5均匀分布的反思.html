<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MoEç¯æ¸¸è®°ï¼š5ã€å‡åŒ€åˆ†å¸ƒçš„åæ€</title>
    <style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    line-height: 1.6; color: #333; max-width: 900px; margin: 0 auto; padding: 20px; background: #f5f5f5;
}
.container { background: white; padding: 40px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
header { border-bottom: 2px solid #e0e0e0; padding-bottom: 20px; margin-bottom: 30px; }
h1 { color: #2c3e50; margin-bottom: 10px; font-size: 2em; }
.meta { color: #666; font-size: 0.9em; margin-bottom: 20px; }
.content { margin-top: 30px; overflow-wrap: break-word; }
.content h2 { color: #34495e; margin-top: 30px; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
.content p { margin-bottom: 15px; }
.content pre { background: #f8f8f8; padding: 15px; border-radius: 5px; overflow-x: auto; border-left: 3px solid #3498db; margin: 15px 0; }
.content code { background: #f8f8f8; padding: 2px 5px; border-radius: 3px; font-family: monospace; font-size: 0.9em; }
.content blockquote { border-left: 4px solid #3498db; padding-left: 20px; margin: 20px 0; color: #555; font-style: italic; }
.content table { border-collapse: collapse; width: 100%; margin: 20px 0; }
.content th, .content td { border: 1px solid #ddd; padding: 10px; text-align: left; }
.back-link { display: inline-block; margin-bottom: 20px; color: #3498db; text-decoration: none; font-weight: 500; }
</style>
    
<script>
    window.MathJax = {
        tex: {
            inlineMath: [['$', '$'], ['\(', '\)']],
            displayMath: [['$$', '$$'], ['\[', '\]']],
            processEscapes: true
        }
    };
</script>
<script id="MathJax-script" async src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>

</head>
<body>
    <div class="container">
        <a href="../index.html" class="back-link">â† è¿”å›é¦–é¡µ</a>
        <header>
            <h1>MoEç¯æ¸¸è®°ï¼š5ã€å‡åŒ€åˆ†å¸ƒçš„åæ€</h1>
            <div class="meta">ğŸ“… æœ€åæ›´æ–°: 2025-11-24 | ğŸ“„ å¤§å°: 74.1 KB</div>
        </header>
        <div class="content">
            <p><strong>åŸæ–‡é“¾æ¥</strong>: <a href="https://spaces.ac.cn/archives/10945">https://spaces.ac.cn/archives/10945</a></p>
<p><strong>å‘å¸ƒæ—¥æœŸ</strong>: </p>
<hr />
<p>å¦‚æœè¯´Metaçš„LLAMAç³»åˆ—ä¸ºDenseæ¨¡å‹ç¡®ç«‹äº†æ ‡å‡†æ¶æ„ï¼Œé‚£ä¹ˆDeepSeekæˆ–è®¸å°±æ˜¯MoEæ ‡å‡†æ¶æ„çš„å¥ åŸºè€…ã€‚å½“ç„¶ï¼Œè¿™å¹¶éæŒ‡DeepSeeké¦–åˆ›äº†MoEï¼Œä¹Ÿä¸æ˜¯è¯´å®ƒçš„MoEä¸å¯è¶…è¶Šï¼Œè€Œæ˜¯æŒ‡DeepSeekå¯¹MoEæ‰€æçš„ä¸€äº›æ”¹è¿›ï¼Œå¾ˆå¯èƒ½éƒ½æ˜¯æ•ˆæœå¢ç›Šæ¯”è¾ƒæ˜¾è‘—çš„æ–¹å‘ï¼Œä»è€Œé€æ¸æˆä¸ºMoEçš„æ ‡é…ã€‚è¿™å…¶ä¸­ï¼ŒåŒ…æ‹¬æˆ‘ä»¬åœ¨<a href="/archives/10757">ã€ŠMoEç¯æ¸¸è®°ï¼š3ã€æ¢ä¸ªæ€è·¯æ¥åˆ†é…ã€‹</a>ä»‹ç»çš„Loss-Freeè´Ÿè½½å‡è¡¡æ–¹æ¡ˆï¼Œè¿˜æœ‰æœ¬æ–‡å°†è¦ä»‹ç»çš„Shared Expertã€Fine-Grained Expertç­–ç•¥ã€‚</p>
<p>è¯´åˆ°è´Ÿè½½å‡è¡¡ï¼Œå®ƒæ— ç–‘æ˜¯MoEä¸€ä¸ªæä¸ºé‡è¦çš„ç›®æ ‡ï¼Œæœ¬ç³»åˆ—çš„ç¬¬2ï½4ç¯‡ï¼Œå¯ä»¥è¯´éƒ½åœ¨å›´ç»•ç€å®ƒå±•å¼€ã€‚ç„¶è€Œï¼Œå·²æœ‰è¯»è€…é€æ¸æ„è¯†åˆ°ï¼Œè¿™é‡Œè¾¹æœ‰ä¸ªå°šæœªå›ç­”çš„æœ¬è´¨é—®é¢˜ï¼š<strong>æŠ›å¼€æ•ˆç‡ä¸Šçš„éœ€æ±‚ä¸è°ˆï¼Œå‡åŒ€åˆ†å¸ƒå°±ä¸€å®šæ˜¯æ•ˆæœæœ€å¥½çš„æ–¹å‘å—ï¼Ÿ</strong> æœ¬æ–‡å°±å¸¦ç€è¿™ä¸ªç–‘é—®ï¼Œå»ç†è§£Shared Expertã€Fine-Grained Expertã€‚</p>
<h2 id="_1">å…±äº«ä¸“å®¶</h2>
<p>è®©æˆ‘ä»¬å†æ¬¡å›é¡¾MoEçš„åŸºæœ¬å½¢å¼<br />
\begin{equation}\boldsymbol{y} = \sum_{i\in \mathop{\text{argtop}}_k \boldsymbol{\rho}} \rho_i \boldsymbol{e}_i\end{equation}<br />
é™¤æ­¤ä¹‹å¤–ï¼Œ<a href="/archives/10757">ã€ŠMoEç¯æ¸¸è®°ï¼š3ã€æ¢ä¸ªæ€è·¯æ¥åˆ†é…ã€‹</a>ä¸­çš„Loss-Freeå°†$\mathop{\text{argtop}}_k \boldsymbol{\rho}$æ›¿æ¢æ¢æˆ$\mathop{\text{argtop}}_k \boldsymbol{\rho}+\boldsymbol{b}$ï¼Œè¿˜æœ‰åœ¨<a href="/archives/10815">ã€ŠMoEç¯æ¸¸è®°ï¼š4ã€éš¾å¤„åº”å½“å¤šæŠ•å…¥ã€‹</a>æˆ‘ä»¬å°†å®ƒæ¨å¹¿æˆ$\mathop{\text{argwhere}} \boldsymbol{\rho}+\boldsymbol{b} &gt; 0$ï¼Œä½†è¿™äº›å˜ä½“è·ŸShared ExpertæŠ€å·§éƒ½æ˜¯æ­£äº¤çš„ï¼Œå› æ­¤æ¥ä¸‹æ¥åªä»¥æœ€åŸºæœ¬çš„å½¢å¼ä¸ºä¾‹ã€‚</p>
<p>Shared Expertå°†ä¸Šå¼æ”¹ä¸º<br />
\begin{equation}\boldsymbol{y} = \sum_{i=1}^s \boldsymbol{e}<em _mathop_text_argtop="\mathop{\text{argtop" i_in="i\in">i + \sum</em>}<em _s:_="[s:]">{k-s} \boldsymbol{\rho}</em>}} \rho_{i+s} \boldsymbol{e}_{i+s}\label{eq:share-1}\end{equation<br />
ä¹Ÿå°±æ˜¯è¯´ï¼Œå°†åŸæœ¬çš„$n$é€‰$k$ï¼Œæ”¹ä¸º$n-s$é€‰$k-s$ï¼Œå¦å¤–$s$ä¸ªExpertåˆ™å¿…ç„¶ä¼šè¢«é€‰ä¸­ï¼Œè¿™éƒ¨åˆ†å°±è¢«ç§°ä¸ºâ€œShared Expertâ€ï¼Œåˆšå‡ºæ¥é‚£ä¼šæˆ‘ä»¬è¿˜æˆç§°ä¸ºâ€œå¸¸ä»»ç†äº‹å›½â€ï¼Œå‰©ä¸‹çš„$n-s$ä¸ªExpertåˆ™è¢«ç§°ä¸ºâ€œRouted Expertâ€ã€‚å…¶ä¸­ï¼ŒShared Expertçš„æ•°ç›®$s$ä¸ä¼šå¤ªå¤§ï¼Œé€šå¸¸æ˜¯1æˆ–2ï¼Œå¤ªå¤§åè€Œä¼šè®©æ¨¡å‹â€œå†·è½â€äº†å‰©ä¸‹çš„Routed Expertã€‚</p>
<p>éœ€è¦æŒ‡å‡ºçš„æ˜¯ï¼Œå¼€å¯Shared Expertå‰åï¼Œæ€»Expertæ•°éƒ½æ˜¯$n$ï¼Œæ¿€æ´»çš„Expertéƒ½æ˜¯$k$ï¼Œæ‰€ä»¥Shared ExpertåŸåˆ™ä¸Šä¸å¢åŠ æ¨¡å‹å‚æ•°é‡å’Œæ¨ç†æˆæœ¬ã€‚ä½†å³ä¾¿å¦‚æ­¤ï¼Œ<a href="https://papers.cool/arxiv/2401.06066">DeepSeekMoE</a>å’Œæˆ‘ä»¬è‡ªå·±çš„ä¸€äº›å®éªŒæ˜¾ç¤ºï¼ŒShared Expertä¾ç„¶èƒ½ä¸€å®šç¨‹åº¦ä¸Šæå‡æ¨¡å‹æ•ˆæœã€‚</p>
<h2 id="_2">å¤šç§ç†è§£</h2>
<p>æˆ‘ä»¬å¯ä»¥ä»å¤šä¸ªè§†è§’ç†è§£Shared Expertã€‚æ¯”å¦‚æ®‹å·®è§†è§’ï¼Œå®ƒæŒ‡å‡ºShared ExpertæŠ€å·§å®é™…ä¸Šæ˜¯å°†åŸæœ¬å­¦ä¹ æ¯ä¸€ä¸ªExpertï¼Œæ”¹ä¸ºå­¦ä¹ å®ƒè·ŸShared Expertçš„æ®‹å·®ï¼Œè¿™æ ·èƒ½é™ä½å­¦ä¹ éš¾åº¦ï¼Œè¿˜ä¼šæœ‰æ›´å¥½çš„æ¢¯åº¦ã€‚ç”¨DeepSeekçš„è¯åˆ™æ˜¯è¯´ï¼šé€šè¿‡å°†å…±åŒçŸ¥è¯†å‹ç¼©åˆ°è¿™äº›Shared Expertä¸­ï¼Œå‡è½»Routed Expertä¹‹é—´çš„å†—ä½™ï¼Œæé«˜å‚æ•°æ•ˆç‡å¹¶ç¡®ä¿æ¯ä¸ªRouted Expertä¸“æ³¨äºç‹¬ç‰¹æ–¹é¢ã€‚</p>
<p>å¦‚æœå°†Routed Expertç±»æ¯”æˆä¸­å­¦å„ä¸ªå­¦ç§‘çš„è€å¸ˆï¼Œé‚£ä¹ˆShared Expertå°±æ˜¯ç±»ä¼¼â€œç­ä¸»ä»»â€çš„å­˜åœ¨ã€‚å¦‚æœä¸€ä¸ªç­åªæœ‰ç§‘ä»»è€å¸ˆï¼Œé‚£ä¹ˆæ¯ä¸ªç§‘ä»»è€å¸ˆå°†ä¸å¯é¿å…åœ°åˆ†æ‘Šä¸€äº›ç®¡ç†å·¥ä½œï¼Œè€Œè®¾ç½®ç­ä¸»ä»»çš„è§’è‰²ï¼Œåˆ™å°†è¿™äº›å…±åŒçš„ç®¡ç†å·¥ä½œé›†ä¸­åœ¨ä¸€ä¸ªè€å¸ˆèº«ä¸Šï¼Œè®©ç§‘ä»»è€å¸ˆä¸“æ³¨äºå­¦ç§‘æ•™å­¦ï¼Œæé«˜æ•™å­¦æ•ˆç‡ã€‚</p>
<p>å½“ç„¶ä¹Ÿå¯ä»¥ä»å‡ ä½•è§’åº¦ç†è§£ã€‚Expertä¹‹é—´çš„ä¸å¯é¿å…çš„å…±æ€§ï¼Œå‡ ä½•æ„ä¹‰æ˜¯å®ƒä»¬çš„å‘é‡å¤¹è§’å°äº90åº¦ï¼Œè¿™è·Ÿæˆ‘ä»¬åœ¨<a href="/archives/10699">ã€ŠMoEç¯æ¸¸è®°ï¼š1ã€ä»å‡ ä½•æ„ä¹‰å‡ºå‘ã€‹</a>æå‡ºMoEå‡ ä½•æ„ä¹‰æ—¶æ‰€ç”¨çš„Expertå‘é‡â€œä¸¤ä¸¤æ­£äº¤â€å‡è®¾çŸ›ç›¾ã€‚è™½ç„¶è¯´è¿™ä¸ªå‡è®¾ä¸æˆç«‹æ—¶ä¹Ÿèƒ½ç†è§£ä¸ºè¿‘ä¼¼è§£ï¼Œä½†è‡ªç„¶æ˜¯è¶Šæˆç«‹è¶Šå¥½ï¼Œè€Œæˆ‘ä»¬å¯ä»¥å°†Shared Expertç†è§£æˆè¿™äº›Routed Expertçš„å‡å€¼ï¼Œé€šè¿‡å­¦ä¹ å‡å»å‡å€¼åçš„æ®‹å·®ï¼Œä½¿å¾—æ­£äº¤å‡è®¾æ›´å®¹æ˜“æˆç«‹ã€‚</p>
<h2 id="_3">æ¯”ä¾‹å› å­</h2>
<p>æˆ‘ä»¬å°†å¼$\eqref{eq:share-1}$ä¸€èˆ¬åœ°å†™æˆ<br />
\begin{equation}\boldsymbol{y} = \sum_{i=1}^s \boldsymbol{e}<em _mathop_text_argtop="\mathop{\text{argtop" i_in="i\in">i + \lambda\sum</em>}<em _s:_="[s:]">{k-s} \boldsymbol{\rho}</em>}} \rho_{i+s} \boldsymbol{e}_{i+s}\end{equation</p>
<p>ç”±äºRouted Expertå¸¦æœ‰æƒé‡$\rho_{i+s}$è€ŒShared Expertæ²¡æœ‰ï¼Œä»¥åŠRouted Expertçš„æ•°ç›®é€šå¸¸è¿œå¤§äºShared Expertæ•°ç›®ï¼ˆå³$n - s \gg s$ï¼‰ç­‰åŸå› ï¼Œå®ƒä»¬çš„æ¯”ä¾‹å¯èƒ½ä¼šå¤±è¡¡ï¼Œå› æ­¤ä¸ºäº†è®©ä¸¤è€…ä¸è‡³äºè¢«ç›¸äº’åŸ‹æ²¡ï¼Œè®¾ç½®åˆç†çš„$\lambda$å°¤ä¸ºé‡è¦ã€‚å¯¹æ­¤ï¼Œæˆ‘ä»¬åœ¨<a href="https://papers.cool/arxiv/2502.16982">ã€ŠMuon is Scalable for LLM Trainingã€‹</a>æå‡ºï¼Œé€‚å½“çš„$\lambda$åº”ä½¿å¾—ä¸¤è€…åœ¨åˆå§‹åŒ–é˜¶æ®µæ¨¡é•¿æ¥è¿‘ä¸€è‡´ã€‚</p>
<p>å…·ä½“æ¥è¯´ï¼Œæˆ‘ä»¬å‡è®¾æ¯ä¸ªExpertåœ¨åˆå§‹åŒ–é˜¶æ®µå…·æœ‰ç›¸åŒçš„æ¨¡é•¿ï¼ˆä¸å¤±ä¸€èˆ¬æ€§ï¼Œå¯ä»¥ç›´æ¥è®¾ä¸º1ï¼‰ï¼Œå¹¶ä¸”æ»¡è¶³ä¸¤ä¸¤æ­£äº¤ï¼Œç„¶åå‡è®¾Routerçš„logitsæœä»æ ‡å‡†æ­£æ€åˆ†å¸ƒï¼ˆå³é›¶å‡å€¼ã€å•ä½æ–¹å·®ï¼Œå½“ç„¶å¦‚æœè§‰å¾—æœ‰å¿…è¦ï¼Œä¹Ÿå¯ä»¥è€ƒè™‘å…¶ä»–æ–¹å·®ï¼‰ã€‚è¿™æ ·ä¸€æ¥ï¼Œ$s$ä¸ªShared Expertçš„æ€»æ¨¡é•¿å°±æ˜¯$\sqrt{s}$ï¼Œè€ŒRouted Expertçš„æ€»æ¨¡é•¿æ˜¯<br />
\begin{equation}\lambda\sqrt{\sum_{i\in \mathop{\text{argtop}}<em _s:_="[s:]">{k-s} \boldsymbol{\rho}</em>}} \rho_{i+s}^2}\end{equation<br />
é€šè¿‡è®©å®ƒç­‰äº$\sqrt{s}$ï¼Œå°±å¯ä»¥ä¼°è®¡å‡º$\lambda$ã€‚ç”±äºæ¿€æ´»å‡½æ•°ã€æ˜¯å¦é‡å½’ä¸€åŒ–ç­‰é€‰æ‹©ï¼Œä¸åŒMoEçš„Routerå·®åˆ«å¯èƒ½æ¯”è¾ƒå¤§ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿä¸è®¾æ³•æ±‚è§£æè§£ï¼Œè€Œæ˜¯ç›´æ¥æ•°å€¼æ¨¡æ‹Ÿï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="k">def</span><span class="w"> </span><span class="nf">sigmoid</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="kp">exp</span><span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="p">))</span>

<span class="k">def</span><span class="w"> </span><span class="nf">softmax</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">p</span> <span class="o">:=</span> <span class="n">np</span><span class="o">.</span><span class="kp">exp</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="o">/</span> <span class="n">p</span><span class="o">.</span><span class="kp">sum</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">scaling_factor</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">act</span><span class="o">=</span><span class="s1">&#39;softmax&#39;</span><span class="p">,</span> <span class="n">renorm</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">factors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10000</span><span class="p">):</span>
        <span class="n">logits</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="n">s</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">sort</span><span class="p">(</span><span class="nb">eval</span><span class="p">(</span><span class="n">act</span><span class="p">)(</span><span class="n">logits</span><span class="p">))[::</span><span class="o">-</span><span class="mi">1</span><span class="p">][:</span><span class="n">k</span> <span class="o">-</span> <span class="n">s</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">renorm</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">/=</span> <span class="n">p</span><span class="o">.</span><span class="kp">sum</span><span class="p">()</span>
        <span class="n">factors</span><span class="o">.</span><span class="kp">append</span><span class="p">(</span><span class="n">s</span><span class="o">**</span><span class="mf">0.5</span> <span class="o">/</span> <span class="p">(</span><span class="n">p</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="kp">sum</span><span class="p">()</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="kp">mean</span><span class="p">(</span><span class="n">factors</span><span class="p">)</span>

<span class="n">scaling_factor</span><span class="p">(</span><span class="mi">162</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;softmax&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
<span class="n">scaling_factor</span><span class="p">(</span><span class="mi">257</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;sigmoid&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</code></pre></div>

<p>éå¸¸å·§çš„æ˜¯ï¼Œè¿™ä¸ªè„šæœ¬çš„æ¨¡æ‹Ÿç»“æœè·ŸDeepSeek-V2ã€DeepSeek-V3çš„è®¾ç½®éƒ½å¾ˆå»åˆã€‚å…¶ä¸­ï¼ŒDeepSeek-V2æœ‰$n=162,k=8,s=2$ï¼ŒSoftmaxæ¿€æ´»å¹¶ä¸”æ²¡æœ‰é‡å½’ä¸€åŒ–ï¼Œä¸Šè¿°è„šæœ¬çš„æ¨¡æ‹Ÿç»“æœçº¦ç­‰äº16ï¼Œè€ŒDeepSeek-V2çš„$\lambda$æ­£å¥½æ˜¯16[<a href="https://huggingface.co/deepseek-ai/DeepSeek-V2/blob/main/config.json#L48">æ¥æº</a>]ï¼›DeepSeek-V3åˆ™æœ‰$n=257,k=9,s=1$ï¼ŒSigmoidæ¿€æ´»ä¸”é‡å½’ä¸€åŒ–ï¼Œè„šæœ¬çš„ç»“æœå¤§çº¦æ˜¯2.83ï¼Œè€ŒDeepSeek-V3çš„$\lambda$åˆ™æ˜¯2.5[<a href="https://huggingface.co/deepseek-ai/DeepSeek-V3/blob/main/config.json#L57">æ¥æº</a>]ã€‚</p>
<h2 id="_4">éå‡åŒ€æ€§</h2>
<p>å›åˆ°æ–‡ç« å¼€å¤´çš„é—®é¢˜ï¼šå‡è¡¡ä¸€å®šæ˜¯æ•ˆæœæœ€å¥½çš„æ–¹å‘å—ï¼Ÿçœ‹èµ·æ¥Shared Expertç»™äº†ä¸€ä¸ªå‚è€ƒç­”æ¡ˆï¼šæœªå¿…ã€‚å› ä¸ºShared Expertä¹Ÿå¯ä»¥ç†è§£ä¸ºæŸäº›Expertä¸€å®šä¼šè¢«æ¿€æ´»ï¼Œäºæ˜¯æ•´ä½“æ¥çœ‹ï¼Œè¿™å°†å¯¼è‡´ä¸€ä¸ªéå‡åŒ€çš„Expertåˆ†å¸ƒï¼š<br />
\begin{equation}\boldsymbol{F} = \frac{1}{s+1}\bigg[\underbrace{1,\cdots,1\\\}<em n-s="n-s" ä¸ª="ä¸ª">{sä¸ª},\underbrace{\frac{1}{n-s},\cdots,\frac{1}{n-s}\\\}</em>}\bigg]\end{equation</p>
<p>å®é™…ä¸Šï¼Œéå‡åŒ€åˆ†å¸ƒåœ¨ç°å®ä¸–ç•Œéšå¤„å¯è§ï¼Œæ‰€ä»¥å‡åŒ€åˆ†å¸ƒå¹¶éæœ€ä¼˜æ–¹å‘å…¶å®åº”è¯¥å¾ˆå®¹æ˜“æ¥å—ã€‚è¿˜æ˜¯ä»¥å‰é¢çš„ä¸­å­¦è€å¸ˆç±»æ¯”ä¸ºä¾‹ï¼ŒåŒä¸€ä¸ªå­¦æ ¡å„ä¸ªå­¦ç§‘çš„è€å¸ˆæ•°é‡å…¶å®æ˜¯ä¸å‡åŒ€çš„ï¼Œé€šå¸¸æ˜¯è¯­æ–‡ã€æ•°å­¦ã€è‹±è¯­æœ€å¤šï¼Œç‰©ç†ã€åŒ–å­¦ã€ç”Ÿç‰©æ¬¡ä¹‹ï¼Œä½“è‚²ã€ç¾æœ¯æ›´å°‘ï¼ˆè¿˜ç»å¸¸ç”Ÿç—…ï¼‰ã€‚æ›´å¤šéå‡åŒ€åˆ†å¸ƒçš„ä¾‹å­ï¼Œå¤§å®¶å¯ä»¥æœç´¢ä¸€ä¸‹<a href="/archives/9607#Zipf%E5%AE%9A%E5%BE%8B">Zipfå®šå¾‹</a>ã€‚</p>
<p>æ€»è€Œè¨€ä¹‹ï¼Œç°å®ä¸–ç•Œçš„éå‡åŒ€æ€§ï¼Œå¿…ç„¶ä¼šå¯¼è‡´è‡ªç„¶è¯­è¨€çš„éå‡åŒ€æ€§ï¼Œä»è€Œå¯¼è‡´å‡åŒ€åˆ†å¸ƒçš„éæœ€ä¼˜æ€§ã€‚å½“ç„¶ï¼Œä»è®­ç»ƒæ¨¡å‹çš„è§’åº¦çœ‹ï¼Œå‡åŒ€åˆ†å¸ƒè¿˜æ˜¯æ›´å®¹æ˜“å¹¶è¡Œå’Œæ‰©å±•ï¼Œæ‰€ä»¥å•ç‹¬åˆ†ç¦»å‡ºä¸€éƒ¨åˆ†Shared Expertï¼Œå‰©ä¸‹çš„Routed Expertä»ç„¶å¸Œæœ›å®ƒå‡åŒ€ï¼Œæ˜¯å®ç°éå‡åŒ€æ€§çš„ä¸€ç§å¯¹åŒæ–¹éƒ½å‹å¥½çš„æŠ˜ä¸­é€‰æ‹©ï¼Œè€Œä¸æ˜¯ç›´æ¥è®©Routed Expertå¯¹é½ä¸€ä¸ªéå‡åŒ€åˆ†å¸ƒã€‚</p>
<p>åˆšæ‰è¯´çš„æ˜¯è®­ç»ƒï¼Œé‚£æ¨ç†å‘¢ï¼Ÿæ¨ç†é˜¶æ®µå¯ä»¥äº‹å…ˆé¢„ä¼°Routed Expertçš„å®é™…åˆ†å¸ƒï¼Œå¹¶ä¸”ä¸éœ€è¦è€ƒè™‘åå‘ä¼ æ’­ï¼Œæ‰€ä»¥åªè¦ç»†è‡´åœ°è¿›è¡Œä¼˜åŒ–ï¼Œç†è®ºä¸Šå¯ä»¥åšåˆ°æ•ˆç‡ä¸é™çš„ã€‚ä½†ç”±äºç°åœ¨MoEçš„æ¨ç†åŸºå»ºéƒ½æ˜¯é’ˆå¯¹å‡åŒ€åˆ†å¸ƒè®¾è®¡çš„ï¼Œå¹¶ä¸”å•å¡æ˜¾å­˜æœ‰é™ç­‰å®é™…é™åˆ¶ï¼Œæ‰€ä»¥æˆ‘ä»¬ä»æ—§å¸Œæœ›Routed Expertèƒ½å‡åŒ€æ¥å®ç°æ›´å¥½çš„æ¨ç†æ•ˆç‡ã€‚</p>
<h2 id="_5">ç»†é¢—ç²’åº¦</h2>
<p>é™¤äº†Shared Expertå¤–ï¼Œ<a href="https://papers.cool/arxiv/2401.06066">DeepSeekMoE</a>æ‰€æçš„å¦ä¸€ä¸ªæ”¹è¿›ç‚¹æ˜¯Fine-Grained Expertï¼Œå®ƒæŒ‡å‡ºåœ¨æ€»å‚æ•°é‡å’Œæ¿€æ´»å‚æ•°é‡éƒ½ä¸å˜çš„æƒ…å†µä¸‹ï¼ŒExpertçš„é¢—ç²’åº¦è¶Šç»†ï¼Œæ•ˆæœå¾€å¾€è¶Šå¥½ã€‚</p>
<p>æ¯”å¦‚ï¼ŒåŸæœ¬æ˜¯$n$é€‰$k$çš„Routed Expertï¼Œç°åœ¨æˆ‘ä»¬å°†æ¯ä¸ªExpertç¼©å°ä¸€åŠï¼Œç„¶åæ”¹æˆ$2n$é€‰$2k$ï¼Œé‚£ä¹ˆæ€»å‚æ•°é‡å’Œæ¿€æ´»çš„å‚æ•°é‡éƒ½è¿˜æ˜¯ä¸€æ ·çš„ï¼Œä½†åè€…è¡¨ç°å¾€å¾€æ›´å¥½ã€‚åŸè®ºæ–‡çš„è¯´æ³•æ˜¯è¿™æ ·ä¸°å¯Œäº†Expertç»„åˆçš„å¤šæ ·æ€§ï¼Œå³<br />
\begin{equation}\binom{n}{k} \ll \binom{2n}{2k} \ll \binom{4n}{4k} \ll \cdots\end{equation}</p>
<p>å½“ç„¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æœ‰å…¶ä»–ç†è§£ï¼Œæ¯”å¦‚è¯´å°†Expertè¿›ä¸€æ­¥åˆ†å‰²æˆæ›´å°çš„å•å…ƒï¼Œé‚£ä¹ˆæ¯ä¸ªExpertå¯ä»¥ä¸“æ³¨äºæ›´ç‹­çª„çš„çŸ¥è¯†é¢†åŸŸï¼Œä»è€Œå®ç°æ›´ç²¾ç»†çš„çŸ¥è¯†åˆ†è§£ï¼Œç­‰ç­‰ã€‚ä½†è¦æ³¨æ„ï¼ŒFine-Grained Expertå¹¶éæ˜¯æ— æˆæœ¬çš„ï¼Œ$n$è¶Šå¤§ï¼ŒExpertä¹‹é—´çš„è´Ÿè½½å¾€å¾€è¶Šä¸å‡è¡¡ï¼Œå¹¶ä¸”Expertä¹‹é—´çš„é€šä¿¡å’Œåè°ƒæˆæœ¬ä¹Ÿä¼šå¢åŠ ï¼Œæ‰€ä»¥$n$ä¹Ÿä¸èƒ½æ— é™å¢åŠ ï¼Œæœ‰ä¸€ä¸ªæ•ˆæœå’Œæ•ˆç‡éƒ½å‹å¥½çš„èˆ’é€‚åŒºé—´ã€‚</p>
<p>å…³äºFine-Grained Expertçš„æœ‰æ•ˆæ€§ï¼Œç¬”è€…è¿™é‡Œæå‡ºå¦å¤–ä¸€ç§ä¸å¤§å®¹æ˜“å¯Ÿè§‰çš„è§£é‡Šï¼Œå®ƒè·Ÿæœ¬æ–‡çš„ä¸»é¢˜æœ‰å…³ï¼š<strong>æ›´å¤šæ•°é‡ã€æ›´ç»†é¢—ç²’åº¦çš„Expertï¼Œå¯ä»¥æ›´å¥½åœ°æ¨¡æ‹Ÿç°å®ä¸–ç•Œçš„éå‡åŒ€æ€§ã€‚</strong> ä»¥ä¸‹å›¾ä¸ºä¾‹ï¼Œå‡è®¾çŸ¥è¯†å¯ä»¥åˆ†ä¸ºä¸€å¤§ä¸€å°ä¸¤ç±»ï¼Œæ¯ä¸ªExpertåˆ™æ˜¯ä¸€ä¸ªåœ†ï¼Œå¦‚æœæˆ‘ä»¬ç”¨2ä¸ªå¤§åœ†å»è¦†ç›–ï¼Œé‚£ä¹ˆå­˜åœ¨ä¸€å®šçš„é—æ¼å’Œæµªè´¹ï¼Œè€Œå¦‚æœæ”¹ç”¨8ä¸ªæ€»é¢ç§¯ç›¸åŒçš„å°åœ†ï¼Œé‚£ä¹ˆå°±å¯ä»¥è¦†ç›–å¾—æ›´ä¸ºç»†è‡´ï¼Œå› æ­¤æ•ˆæœæ›´ä¼˜ã€‚</p>
<p><a href="/usr/uploads/2025/05/4144973966.png" title="ç‚¹å‡»æŸ¥çœ‹åŸå›¾"><img alt="ç»†é¢—ç²’åº¦çš„è¦†ç›–ä¸ºæ›´ç²¾å‡†" src="/usr/uploads/2025/05/4144973966.png" /></a></p>
<p>ç»†é¢—ç²’åº¦çš„è¦†ç›–ä¸ºæ›´ç²¾å‡†</p>
<h2 id="_6">æ–‡ç« å°ç»“</h2>
<p>æœ¬æ–‡ä»‹ç»äº†MoEçš„Shared Expertå’ŒFine-Grained Expertç­–ç•¥ï¼Œå¹¶æŒ‡å‡ºå®ƒä»¬æŸç§ç¨‹åº¦ä¸Šéƒ½ä½“ç°äº†è´Ÿè½½å‡è¡¡çš„éæœ€ä¼˜æ€§ã€‚</p>
<p><em><strong>è½¬è½½åˆ°è¯·åŒ…æ‹¬æœ¬æ–‡åœ°å€ï¼š</strong><a href="https://spaces.ac.cn/archives/10945">https://spaces.ac.cn/archives/10945</a></em></p>
<p><em><strong>æ›´è¯¦ç»†çš„è½¬è½½äº‹å®œè¯·å‚è€ƒï¼š</strong></em><a href="https://spaces.ac.cn/archives/6508#%E6%96%87%E7%AB%A0%E5%A6%82%E4%BD%95%E8%BD%AC%E8%BD%BD/%E5%BC%95%E7%94%A8" title="ã€Šç§‘å­¦ç©ºé—´FAQã€‹">ã€Šç§‘å­¦ç©ºé—´FAQã€‹</a></p>
<p><strong>å¦‚æœæ‚¨è¿˜æœ‰ä»€ä¹ˆç–‘æƒ‘æˆ–å»ºè®®ï¼Œæ¬¢è¿åœ¨ä¸‹æ–¹è¯„è®ºåŒºç»§ç»­è®¨è®ºã€‚</strong></p>
<p><strong>å¦‚æœæ‚¨è§‰å¾—æœ¬æ–‡è¿˜ä¸é”™ï¼Œæ¬¢è¿åˆ†äº«/æ‰“èµæœ¬æ–‡ã€‚æ‰“èµå¹¶éè¦ä»ä¸­è·å¾—æ”¶ç›Šï¼Œè€Œæ˜¯å¸Œæœ›çŸ¥é“ç§‘å­¦ç©ºé—´è·å¾—äº†å¤šå°‘è¯»è€…çš„çœŸå¿ƒå…³æ³¨ã€‚å½“ç„¶ï¼Œå¦‚æœä½ æ— è§†å®ƒï¼Œä¹Ÿä¸ä¼šå½±å“ä½ çš„é˜…è¯»ã€‚å†æ¬¡è¡¨ç¤ºæ¬¢è¿å’Œæ„Ÿè°¢ï¼</strong></p>
<p>æ‰“èµ</p>
<p><img alt="ç§‘å­¦ç©ºé—´" src="https://spaces.ac.cn/usr/themes/geekg/payment/wx.png" /></p>
<p>å¾®ä¿¡æ‰“èµ</p>
<p><img alt="ç§‘å­¦ç©ºé—´" src="https://spaces.ac.cn/usr/themes/geekg/payment/zfb.png" /></p>
<p>æ”¯ä»˜å®æ‰“èµ</p>
<p>å› ä¸ºç½‘ç«™åå°å¯¹æ‰“èµå¹¶æ— è®°å½•ï¼Œå› æ­¤æ¬¢è¿åœ¨æ‰“èµæ—¶å€™å¤‡æ³¨ç•™è¨€ã€‚ä½ è¿˜å¯ä»¥<a href="http://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&amp;email=tN7d1drY3drrx8H0xcWa19vZ"><strong>ç‚¹å‡»è¿™é‡Œ</strong></a>æˆ–åœ¨ä¸‹æ–¹è¯„è®ºåŒºç•™è¨€æ¥å‘ŠçŸ¥ä½ çš„å»ºè®®æˆ–éœ€æ±‚ã€‚</p>
<p><strong>å¦‚æœæ‚¨éœ€è¦å¼•ç”¨æœ¬æ–‡ï¼Œè¯·å‚è€ƒï¼š</strong></p>
<p>è‹å‰‘æ—. (May. 16, 2025). ã€ŠMoEç¯æ¸¸è®°ï¼š5ã€å‡åŒ€åˆ†å¸ƒçš„åæ€ ã€‹[Blog post]. Retrieved from <a href="https://spaces.ac.cn/archives/10945">https://spaces.ac.cn/archives/10945</a></p>
<p>@online{kexuefm-10945,<br />
title={MoEç¯æ¸¸è®°ï¼š5ã€å‡åŒ€åˆ†å¸ƒçš„åæ€},<br />
author={è‹å‰‘æ—},<br />
year={2025},<br />
month={May},<br />
url={\url{https://spaces.ac.cn/archives/10945}},<br />
} </p>
<hr />
<h2 id="_7">å…¬å¼æ¨å¯¼ä¸æ³¨é‡Š</h2>
<h3 id="1">ç¬¬1éƒ¨åˆ†ï¼šæ ¸å¿ƒç†è®ºã€å…¬ç†ä¸å†å²åŸºç¡€</h3>
<h4 id="11">1.1 ç†è®ºèµ·æº</h4>
<p><strong>éå‡åŒ€æ€§çš„ç†è®ºæ ¹æº</strong>ï¼š</p>
<div class="theorem-box">

**å¤šå­¦ç§‘äº¤å‰**ï¼š
- **Zipfå®šå¾‹** (1935)ï¼šè‡ªç„¶è¯­è¨€ä¸­è¯é¢‘å‘ˆå¹‚å¾‹åˆ†å¸ƒ
- **é•¿å°¾ç†è®º** (2004)ï¼š80/20æ³•åˆ™çš„æ¨å¹¿
- **ç¨€ç–è¡¨ç¤ºç†è®º**ï¼šå°‘æ•°åŸºå‘é‡å¯è¡¨ç¤ºå¤§éƒ¨åˆ†æ•°æ®
- **ä¸“å®¶åˆ†åŒ–ç†è®º**ï¼šä¸åŒé¢†åŸŸéœ€è¦ä¸åŒç¨‹åº¦çš„ä¸“ä¸šçŸ¥è¯†
- **çŸ¥è¯†å›¾è°±**ï¼šçŸ¥è¯†èŠ‚ç‚¹çš„åº¦åˆ†å¸ƒå‘ˆéå‡åŒ€æ€§

</div>

<p><strong>MoEå‡åŒ€æ€§å‡è®¾çš„æ¼”åŒ–</strong>ï¼š
1. <strong>æ—©æœŸMoE (2017)</strong>: éšå«å‡è®¾Expertå‡åŒ€ä½¿ç”¨
2. <strong>è´Ÿè½½å‡è¡¡ç ”ç©¶ (2020-2024)</strong>: å¼ºåˆ¶æ¨å‘å‡åŒ€åˆ†å¸ƒ
3. <strong>Shared Expert (2024, DeepSeek)</strong>: æ‰“ç ´å‡åŒ€æ€§ï¼Œå¼•å…¥å¸¸é©»Expert
4. <strong>æœ¬æ–‡åæ€</strong>: éå‡åŒ€æ€§å¯èƒ½æ›´ç¬¦åˆæ•°æ®æœ¬è´¨</p>
<h4 id="12">1.2 æ•°å­¦å…¬ç†</h4>
<div class="theorem-box">

### å…¬ç†1ï¼šçŸ¥è¯†çš„éå‡åŒ€åˆ†å¸ƒ

è‡ªç„¶è¯­è¨€ä¸­çš„çŸ¥è¯†å‘ˆéå‡åŒ€åˆ†å¸ƒï¼ŒæŸäº›çŸ¥è¯†åŸŸï¼ˆå¦‚å¸¸è¯†ï¼‰ä½¿ç”¨é¢‘ç‡è¿œé«˜äºå…¶ä»–ï¼ˆå¦‚ä¸“ä¸šçŸ¥è¯†ï¼‰ã€‚

</div>

<div class="theorem-box">

### å…¬ç†2ï¼šExpertä¸“ä¸šåŒ–ä¸é€šç”¨æ€§çš„æƒè¡¡

å­˜åœ¨éƒ¨åˆ†"é€šç”¨çŸ¥è¯†"è¢«æ‰€æœ‰è¾“å…¥éœ€è¦ï¼Œå¦æœ‰éƒ¨åˆ†"ä¸“ä¸šçŸ¥è¯†"ä»…è¢«ç‰¹å®šè¾“å…¥éœ€è¦ã€‚

</div>

<h4 id="13">1.3 è®¾è®¡å“²å­¦</h4>
<p><strong>æ ¸å¿ƒæ€æƒ³</strong>ï¼š"æ—¢è¦é€šæ‰ï¼Œä¹Ÿè¦ä¸“æ‰"</p>
<ul>
<li><strong>Shared Expert</strong>: ç±»ä¼¼"ç­ä¸»ä»»"ï¼Œå¤„ç†å…±æ€§é—®é¢˜</li>
<li><strong>Routed Expert</strong>: ç±»ä¼¼"ç§‘ä»»è€å¸ˆ"ï¼Œå¤„ç†ä¸“ä¸šé—®é¢˜</li>
<li><strong>Fine-Grained</strong>: æ›´ç»†åˆ†å·¥ï¼Œæ›´ç²¾å‡†åŒ¹é…</li>
</ul>
<hr />
<h3 id="2">ç¬¬2éƒ¨åˆ†ï¼šä¸¥è°¨çš„æ ¸å¿ƒæ•°å­¦æ¨å¯¼</h3>
<h3 id="moe">ä¸€ã€MoEåŸºç¡€æ¦‚ç‡æ¡†æ¶</h3>
<h4 id="11_1">1.1 æ··åˆä¸“å®¶æ¨¡å‹çš„æ¦‚ç‡è§£é‡Š</h4>
<p><strong>åŸºæœ¬MoEå…¬å¼</strong>ï¼šå¯¹äºè¾“å…¥ $\boldsymbol{x}$ï¼ŒMoEæ¨¡å‹çš„è¾“å‡ºå¯ä»¥è¡¨ç¤ºä¸ºï¼š</p>
<p>\begin{equation}
\boldsymbol{y} = \sum_{i=1}^n \rho_i(\boldsymbol{x}) \boldsymbol{e}_i(\boldsymbol{x}) \tag{1}
\end{equation}</p>
<p>å…¶ä¸­ï¼š
- $n$ æ˜¯ä¸“å®¶æ€»æ•°
- $\rho_i(\boldsymbol{x})$ æ˜¯é—¨æ§ç½‘ç»œï¼ˆgating networkï¼‰å¯¹ç¬¬ $i$ ä¸ªä¸“å®¶çš„æƒé‡
- $\boldsymbol{e}_i(\boldsymbol{x})$ æ˜¯ç¬¬ $i$ ä¸ªä¸“å®¶çš„è¾“å‡º</p>
<p><strong>å½’ä¸€åŒ–çº¦æŸ</strong>ï¼šé—¨æ§æƒé‡é€šå¸¸é€šè¿‡softmaxå‡½æ•°è®¡ç®—ï¼Œæ»¡è¶³ï¼š</p>
<p>\begin{equation}
\sum_{i=1}^n \rho_i(\boldsymbol{x}) = 1, \quad \rho_i(\boldsymbol{x}) \geq 0, \quad \forall i \tag{2}
\end{equation}</p>
<p><strong>æ³¨é‡Š</strong>ï¼šè¿™ä½¿å¾— $\rho_i(\boldsymbol{x})$ å¯ä»¥è¢«è§£é‡Šä¸ºåœ¨ç»™å®šè¾“å…¥ $\boldsymbol{x}$ æ—¶é€‰æ‹©ç¬¬ $i$ ä¸ªä¸“å®¶çš„æ¦‚ç‡ã€‚</p>
<h4 id="12-top-k">1.2 Top-Kç¨€ç–åŒ–</h4>
<p>ä¸ºäº†æé«˜è®¡ç®—æ•ˆç‡ï¼Œå®è·µä¸­é€šå¸¸åªæ¿€æ´»æƒé‡æœ€å¤§çš„ $k$ ä¸ªä¸“å®¶ï¼š</p>
<p>\begin{equation}
\boldsymbol{y} = \sum_{i\in\mathop{\text{argtop}}_k \boldsymbol{\rho}} \rho_i \boldsymbol{e}_i \tag{3}
\end{equation}</p>
<p>å…¶ä¸­ $\mathop{\text{argtop}}_k \boldsymbol{\rho}$ è¿”å› $\boldsymbol{\rho}$ ä¸­æœ€å¤§çš„ $k$ ä¸ªå…ƒç´ çš„ç´¢å¼•é›†åˆã€‚</p>
<p><strong>é‡å½’ä¸€åŒ–</strong>ï¼šåœ¨é€‰æ‹©top-kåï¼Œæƒé‡é€šå¸¸ä¼šé‡æ–°å½’ä¸€åŒ–ï¼š</p>
<p>\begin{equation}
\tilde{\rho}<em j_in_mathop_text_argtop="j\in\mathop{\text{argtop">i = \begin{cases}
\frac{\rho_i}{\sum</em> \
0 &amp; \text{otherwise}
\end{cases} \tag{4}
\end{equation}}}_k \boldsymbol{\rho}} \rho_j} &amp; \text{if } i \in \mathop{\text{argtop}}_k \boldsymbol{\rho</p>
<p>ä½¿å¾— $\sum_{i=1}^n \tilde{\rho}_i = 1$ã€‚</p>
<p><strong>æ³¨é‡Š</strong>ï¼šè¿™ä¸ªé‡å½’ä¸€åŒ–æ­¥éª¤åœ¨æŸäº›å®ç°ä¸­ä¼šçœç•¥ï¼Œç›´æ¥ä½¿ç”¨åŸå§‹çš„ $\rho_i$ï¼Œä½†è¿™ä¼šæ”¹å˜è¾“å‡ºçš„å°ºåº¦ã€‚</p>
<h3 id="_8">äºŒã€è´Ÿè½½å‡è¡¡çš„æ•°å­¦ç†è®º</h3>
<h4 id="21">2.1 è´Ÿè½½åˆ†å¸ƒçš„å®šä¹‰</h4>
<p>å¯¹äºä¸€ä¸ªåŒ…å« $N$ ä¸ªæ ·æœ¬çš„æ‰¹æ¬¡ $\mathcal{B} = {\boldsymbol{x}_1, \ldots, \boldsymbol{x}_N}$ï¼Œç¬¬ $i$ ä¸ªä¸“å®¶çš„è´Ÿè½½å®šä¹‰ä¸ºè¢«åˆ†é…åˆ°è¯¥ä¸“å®¶çš„æ ·æœ¬æ•°é‡ï¼š</p>
<p>\begin{equation}
L_i = \sum_{j=1}^N \mathbb{1}{i \in \mathop{\text{argtop}}_k \boldsymbol{\rho}(\boldsymbol{x}_j)} \tag{5}
\end{equation}</p>
<p>å…¶ä¸­ $\mathbb{1}{\cdot}$ æ˜¯æŒ‡ç¤ºå‡½æ•°ã€‚</p>
<p><strong>å¹³å‡è´Ÿè½½</strong>ï¼šç†æƒ³çš„å‡åŒ€åˆ†å¸ƒä¸‹ï¼Œæ¯ä¸ªä¸“å®¶çš„æœŸæœ›è´Ÿè½½åº”è¯¥æ˜¯ï¼š</p>
<p>\begin{equation}
\bar{L} = \frac{Nk}{n} \tag{6}
\end{equation}</p>
<p><strong>æ³¨é‡Š</strong>ï¼šè¿™æ˜¯å› ä¸ºæ€»å…±æœ‰ $N$ ä¸ªæ ·æœ¬ï¼Œæ¯ä¸ªæ ·æœ¬é€‰æ‹© $k$ ä¸ªä¸“å®¶ï¼Œæ‰€ä»¥æ€»è´Ÿè½½æ˜¯ $Nk$ï¼Œå¹³å‡åˆ†é…åˆ° $n$ ä¸ªä¸“å®¶ä¸Šã€‚</p>
<h4 id="22">2.2 è´Ÿè½½å‡è¡¡æŒ‡æ ‡</h4>
<p><strong>æ–¹å·®ä½œä¸ºä¸å‡è¡¡åº¦é‡</strong>ï¼š</p>
<p>\begin{equation}
\text{Var}(L) = \frac{1}{n}\sum_{i=1}^n (L_i - \bar{L})^2 \tag{7}
\end{equation}</p>
<p><strong>å½’ä¸€åŒ–å˜å¼‚ç³»æ•°</strong>ï¼š</p>
<p>\begin{equation}
\text{CV} = \frac{\sqrt{\text{Var}(L)}}{\bar{L}} = \frac{\sqrt{\frac{1}{n}\sum_{i=1}^n (L_i - \bar{L})^2}}{\frac{Nk}{n}} \tag{8}
\end{equation}</p>
<p><strong>æ³¨é‡Š</strong>ï¼šCVï¼ˆCoefficient of Variationï¼‰æ˜¯ä¸€ä¸ªæ— é‡çº²çš„åº¦é‡ï¼Œé€‚åˆæ¯”è¾ƒä¸åŒè§„æ¨¡çš„å®éªŒã€‚CV = 0 è¡¨ç¤ºå®Œå…¨å‡åŒ€ï¼ŒCVè¶Šå¤§è¡¨ç¤ºä¸å‡è¡¡ç¨‹åº¦è¶Šé«˜ã€‚</p>
<h4 id="23">2.3 å‡åŒ€åˆ†å¸ƒä¸‹çš„æ¦‚ç‡æ¨¡å‹</h4>
<p>å‡è®¾æ¯ä¸ªæ ·æœ¬ç‹¬ç«‹åœ°ã€ç­‰æ¦‚ç‡åœ°é€‰æ‹© $k$ ä¸ªä¸“å®¶ï¼Œé‚£ä¹ˆç¬¬ $i$ ä¸ªä¸“å®¶è¢«å•ä¸ªæ ·æœ¬é€‰ä¸­çš„æ¦‚ç‡æ˜¯ï¼š</p>
<p>\begin{equation}
p_i = \frac{k}{n} \tag{9}
\end{equation}</p>
<p><strong>äºŒé¡¹åˆ†å¸ƒè¿‘ä¼¼</strong>ï¼šè´Ÿè½½ $L_i$ æœä»äºŒé¡¹åˆ†å¸ƒï¼š</p>
<p>\begin{equation}
L_i \sim \text{Binomial}(N, p_i) = \text{Binomial}\left(N, \frac{k}{n}\right) \tag{10}
\end{equation}</p>
<p><strong>æœŸæœ›å’Œæ–¹å·®</strong>ï¼š</p>
<p>\begin{align}
\mathbb{E}[L_i] &amp;= Np_i = \frac{Nk}{n} = \bar{L} \tag{11}\
\text{Var}[L_i] &amp;= Np_i(1-p_i) = \frac{Nk}{n}\left(1-\frac{k}{n}\right) = \frac{Nk(n-k)}{n^2} \tag{12}
\end{align}</p>
<p><strong>å¤§æ•°å®šå¾‹</strong>ï¼šå½“ $N$ å¾ˆå¤§æ—¶ï¼Œç”±å¤§æ•°å®šå¾‹ï¼š</p>
<p>\begin{equation}
\frac{L_i}{N} \xrightarrow{P} p_i = \frac{k}{n} \tag{13}
\end{equation}</p>
<p>å³è´Ÿè½½æ¯”ä¾‹ä¼šæ”¶æ•›åˆ°ç†è®ºæ¦‚ç‡ã€‚</p>
<h3 id="shared-expert">ä¸‰ã€Shared Expertçš„æ•°å­¦å»ºæ¨¡</h3>
<h4 id="31-shared-expert">3.1 Shared Expertæ¨¡å‹</h4>
<p><strong>æ¨¡å‹å®šä¹‰</strong>ï¼šå°† $n$ ä¸ªä¸“å®¶åˆ†ä¸ºä¸¤ç»„ï¼š
- Shared Expertsï¼š$s$ ä¸ªå¿…ç„¶è¢«æ¿€æ´»çš„ä¸“å®¶
- Routed Expertsï¼š$n-s$ ä¸ªé€šè¿‡é—¨æ§é€‰æ‹©çš„ä¸“å®¶</p>
<p>\begin{equation}
\boldsymbol{y} = \sum_{i=1}^s \boldsymbol{e}<em i_in_mathop_text_argtop="i\in\mathop{\text{argtop">i + \sum</em>}<em _s_1:n_="[s+1:n]">{k-s} \boldsymbol{\rho}</em>
\end{equation}}} \rho_i \boldsymbol{e}_i \tag{14</p>
<p><strong>æ³¨é‡Š</strong>ï¼š$\boldsymbol{\rho}_{[s+1:n]}$ è¡¨ç¤ºåªå¯¹å $n-s$ ä¸ªä¸“å®¶è®¡ç®—é—¨æ§æƒé‡ã€‚</p>
<h4 id="32">3.2 å‚æ•°é‡å’Œè®¡ç®—é‡åˆ†æ</h4>
<p>å‡è®¾æ¯ä¸ªä¸“å®¶çš„å‚æ•°é‡ä¸º $P$ï¼Œè¾“å…¥ç»´åº¦ä¸º $d_{\text{in}}$ï¼Œè¾“å‡ºç»´åº¦ä¸º $d_{\text{out}}$ã€‚</p>
<p><strong>ä¸ä½¿ç”¨Shared Expert</strong>ï¼š
- æ€»å‚æ•°é‡ï¼š$nP$
- å•æ ·æœ¬å‰å‘è®¡ç®—é‡ï¼ˆFLOPSï¼‰ï¼š$k \cdot (2d_{\text{in}}d_{\text{out}})$</p>
<p><strong>ä½¿ç”¨Shared Expert</strong>ï¼ˆ$s$ ä¸ªsharedï¼Œ$n-s$ ä¸ªroutedï¼Œæ¿€æ´» $k$ ä¸ªï¼‰ï¼š
- æ€»å‚æ•°é‡ï¼š$nP$ ï¼ˆä¸å˜ï¼‰
- å•æ ·æœ¬å‰å‘è®¡ç®—é‡ï¼š$s \cdot (2d_{\text{in}}d_{\text{out}}) + (k-s) \cdot (2d_{\text{in}}d_{\text{out}}) = k \cdot (2d_{\text{in}}d_{\text{out}})$ ï¼ˆä¸å˜ï¼‰</p>
<p><strong>æ³¨é‡Š</strong>ï¼šShared Expertåœ¨ä¸å¢åŠ å‚æ•°é‡å’Œè®¡ç®—é‡çš„å‰æä¸‹æ”¹å˜äº†æ¨¡å‹çš„ä¿¡æ¯æµåŠ¨æ–¹å¼ã€‚</p>
<h4 id="33">3.3 æ®‹å·®è§†è§’çš„æ•°å­¦åˆ†æ</h4>
<p><strong>åˆ†è§£å…¬å¼</strong>ï¼šå°†Routed Expertçš„è¾“å‡º $\boldsymbol{e}_i$ åˆ†è§£ä¸ºï¼š</p>
<p>\begin{equation}
\boldsymbol{e}_i = \bar{\boldsymbol{e}} + \Delta\boldsymbol{e}_i \tag{15}
\end{equation}</p>
<p>å…¶ä¸­ï¼š
- $\bar{\boldsymbol{e}} = \frac{1}{n-s}\sum_{i=s+1}^n \boldsymbol{e}_i$ æ˜¯Routed Expertsçš„å¹³å‡è¾“å‡º
- $\Delta\boldsymbol{e}_i$ æ˜¯ç¬¬ $i$ ä¸ªä¸“å®¶çš„æ®‹å·®</p>
<p><strong>Shared Expertä½œä¸ºå¹³å‡çš„è¿‘ä¼¼</strong>ï¼šç†æƒ³æƒ…å†µä¸‹ï¼ŒShared Expertåº”è¯¥å­¦ä¹ åˆ°ï¼š</p>
<p>\begin{equation}
\sum_{i=1}^s \boldsymbol{e}_i \approx (k-s) \bar{\boldsymbol{e}} \tag{16}
\end{equation}</p>
<p>è¿™æ ·ï¼Œæ€»è¾“å‡ºå¯ä»¥è¿‘ä¼¼ä¸ºï¼š</p>
<p>\begin{equation}
\boldsymbol{y} \approx (k-s)\bar{\boldsymbol{e}} + \sum_{i\in\mathop{\text{argtop}}<em _s_1:n_="[s+1:n]">{k-s} \boldsymbol{\rho}</em>
\end{equation}}} \rho_i \Delta\boldsymbol{e}_i \tag{17</p>
<p><strong>æ³¨é‡Š</strong>ï¼šè¿™ä¸ªåˆ†è§£è¯´æ˜Shared Expertè´Ÿè´£"åŸºç¡€çŸ¥è¯†"ï¼Œè€ŒRouted Expertè´Ÿè´£"ä¸“é—¨çŸ¥è¯†"çš„æ®‹å·®éƒ¨åˆ†ã€‚</p>
<h4 id="34">3.4 å‡ ä½•è§†è§’ï¼šæ­£äº¤æ€§åˆ†æ</h4>
<p><strong>å‘é‡è¡¨ç¤º</strong>ï¼šå°†æ¯ä¸ªä¸“å®¶çš„è¾“å‡ºçœ‹ä½œ $d_{\text{out}}$ ç»´ç©ºé—´ä¸­çš„å‘é‡ã€‚</p>
<p><strong>ç†æƒ³æ­£äº¤å‡è®¾</strong>ï¼šå¦‚æœRouted Expertsçš„è¾“å‡ºä¸¤ä¸¤æ­£äº¤ï¼Œå³ï¼š</p>
<p>\begin{equation}
\langle \Delta\boldsymbol{e}_i, \Delta\boldsymbol{e}_j \rangle = 0, \quad \forall i \neq j \tag{18}
\end{equation}</p>
<p>é‚£ä¹ˆå®ƒä»¬çš„ç»„åˆèƒ½å¤Ÿæœ€å¤§åŒ–è¡¨è¾¾èƒ½åŠ›ã€‚</p>
<p><strong>æ­£äº¤æ€§åº¦é‡</strong>ï¼šå®é™…ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥è®¡ç®—ä½™å¼¦ç›¸ä¼¼åº¦æ¥è¡¡é‡æ­£äº¤æ€§ï¼š</p>
<p>\begin{equation}
\text{Sim}(\boldsymbol{e}_i, \boldsymbol{e}_j) = \frac{\langle \boldsymbol{e}_i, \boldsymbol{e}_j \rangle}{|\boldsymbol{e}_i||\boldsymbol{e}_j|} \tag{19}
\end{equation}</p>
<p><strong>å¹³å‡ç›¸ä¼¼åº¦</strong>ï¼š</p>
<p>\begin{equation}
\bar{\text{Sim}} = \frac{2}{(n-s)(n-s-1)}\sum_{i=s+1}^{n-1}\sum_{j=i+1}^n \text{Sim}(\boldsymbol{e}_i, \boldsymbol{e}_j) \tag{20}
\end{equation}</p>
<p><strong>æ³¨é‡Š</strong>ï¼šå¼•å…¥Shared Expertåï¼Œé€šè¿‡å‡å»å…±åŒéƒ¨åˆ†ï¼Œå¯ä»¥ä½¿å¾— $\bar{\text{Sim}}$ æ›´æ¥è¿‘0ï¼Œä»è€Œæ›´å¥½åœ°æ»¡è¶³æ­£äº¤æ€§å‡è®¾ã€‚</p>
<h3 id="_9">å››ã€æ¯”ä¾‹å› å­çš„ç»Ÿè®¡æ¨å¯¼</h3>
<h4 id="41">4.1 æ¨¡é•¿å¹³è¡¡åŸç†</h4>
<p><strong>é—®é¢˜è®¾å®š</strong>ï¼šShared Expertçš„è¾“å‡ºæ˜¯ç¡®å®šæ€§çš„ï¼Œè€ŒRouted Expertçš„è¾“å‡ºæ˜¯éšæœºåŠ æƒçš„ã€‚ä¸ºäº†å¹³è¡¡ä¸¤è€…çš„è´¡çŒ®ï¼Œéœ€è¦å¼•å…¥æ¯”ä¾‹å› å­ $\lambda$ï¼š</p>
<p>\begin{equation}
\boldsymbol{y} = \sum_{i=1}^s \boldsymbol{e}<em i_in_mathop_text_argtop="i\in\mathop{\text{argtop">i + \lambda\sum</em>}<em _s_1:n_="[s+1:n]">{k-s} \boldsymbol{\rho}</em>
\end{equation}}} \rho_i \boldsymbol{e}_i \tag{21</p>
<p><strong>ç›®æ ‡</strong>ï¼šä½¿å¾—Sharedéƒ¨åˆ†å’ŒRoutedéƒ¨åˆ†çš„æœŸæœ›æ¨¡é•¿ç›¸ç­‰ï¼š</p>
<p>\begin{equation}
\mathbb{E}\left[\left|\sum_{i=1}^s \boldsymbol{e}<em i_in_mathop_text_argtop="i\in\mathop{\text{argtop">i\right|\right] = \mathbb{E}\left[\left|\lambda\sum</em>}<em _s_1:n_="[s+1:n]">{k-s} \boldsymbol{\rho}</em>
\end{equation}}} \rho_i \boldsymbol{e}_i\right|\right] \tag{22</p>
<h4 id="42">4.2 åˆå§‹åŒ–é˜¶æ®µçš„åˆ†æ</h4>
<p><strong>å‡è®¾æ¡ä»¶</strong>ï¼š
1. æ¯ä¸ªä¸“å®¶çš„è¾“å‡º $\boldsymbol{e}_i$ åœ¨åˆå§‹åŒ–æ—¶å…·æœ‰å•ä½æ¨¡é•¿ï¼š$|\boldsymbol{e}_i| = 1$
2. ä¸åŒä¸“å®¶çš„è¾“å‡ºä¸¤ä¸¤æ­£äº¤ï¼š$\langle \boldsymbol{e}_i, \boldsymbol{e}_j \rangle = 0, \forall i \neq j$
3. é—¨æ§logitsæœä»æ ‡å‡†æ­£æ€åˆ†å¸ƒï¼š$\text{logit}_i \sim \mathcal{N}(0, 1)$</p>
<p><strong>Sharedéƒ¨åˆ†çš„æ¨¡é•¿</strong>ï¼šåœ¨æ­£äº¤å‡è®¾ä¸‹ï¼š</p>
<p>\begin{equation}
\left|\sum_{i=1}^s \boldsymbol{e}<em i="1">i\right| = \sqrt{\sum</em>
\end{equation}}^s |\boldsymbol{e}_i|^2} = \sqrt{s} \tag{23</p>
<p><strong>Routedéƒ¨åˆ†çš„æœŸæœ›æ¨¡é•¿</strong>ï¼š</p>
<p>\begin{equation}
\mathbb{E}\left[\left|\sum_{i\in\mathop{\text{argtop}}<em _s_1:n_="[s+1:n]">{k-s} \boldsymbol{\rho}</em>}} \rho_i \boldsymbol{e<em i_in_mathop_text_argtop="i\in\mathop{\text{argtop">i\right|\right] = \mathbb{E}\left[\sqrt{\sum</em>}<em _s_1:n_="[s+1:n]">{k-s} \boldsymbol{\rho}</em>
\end{equation}}} \rho_i^2}\right] \tag{24</p>
<h4 id="43-softmax">4.3 Softmaxé—¨æ§çš„æƒ…å†µ</h4>
<p><strong>Softmaxå‡½æ•°</strong>ï¼šå¯¹äºlogits $\boldsymbol{z} = (z_1, \ldots, z_{n-s})$ï¼š</p>
<p>\begin{equation}
\rho_i = \frac{e^{z_i}}{\sum_{j=1}^{n-s} e^{z_j}} = \text{softmax}(\boldsymbol{z})_i \tag{25}
\end{equation}</p>
<p><strong>Top-ké€‰æ‹©åçš„æƒé‡å¹³æ–¹å’Œ</strong>ï¼šè®¾ $\mathcal{I} = \mathop{\text{argtop}}_{k-s} \boldsymbol{\rho}$ æ˜¯è¢«é€‰ä¸­çš„ç´¢å¼•é›†åˆï¼Œåˆ™ï¼š</p>
<p>\begin{equation}
S = \sum_{i\in\mathcal{I}} \rho_i^2 \tag{26}
\end{equation}</p>
<p><strong>è’™ç‰¹å¡æ´›ä¼°è®¡</strong>ï¼šé€šè¿‡é‡‡æ ·å¤§é‡çš„ $\boldsymbol{z} \sim \mathcal{N}(0, I_{n-s})$ æ¥ä¼°è®¡ $\mathbb{E}[\sqrt{S}]$ï¼š</p>
<p>\begin{equation}
\mathbb{E}[\sqrt{S}] \approx \frac{1}{M}\sum_{m=1}^M \sqrt{S^{(m)}} \tag{27}
\end{equation}</p>
<p><strong>æ¯”ä¾‹å› å­çš„ç¡®å®š</strong>ï¼š</p>
<p>\begin{equation}
\lambda = \frac{\sqrt{s}}{\mathbb{E}[\sqrt{S}]} \tag{28}
\end{equation}</p>
<h4 id="44-sigmoid">4.4 Sigmoidé—¨æ§çš„æƒ…å†µ</h4>
<p><strong>Sigmoidæ¿€æ´»</strong>ï¼šå¯¹äºæ¯ä¸ªä¸“å®¶ç‹¬ç«‹è®¡ç®—ï¼š</p>
<p>\begin{equation}
\rho_i = \sigma(z_i) = \frac{1}{1 + e^{-z_i}} \tag{29}
\end{equation}</p>
<p><strong>Top-ké€‰æ‹©</strong>ï¼šé€‰æ‹© $\sigma(z_i)$ æœ€å¤§çš„ $k-s$ ä¸ªä¸“å®¶ã€‚</p>
<p><strong>é‡å½’ä¸€åŒ–</strong>ï¼ˆå¯é€‰ï¼‰ï¼š</p>
<p>\begin{equation}
\tilde{\rho}<em j_in_mathcal_I="j\in\mathcal{I">i = \frac{\sigma(z_i)}{\sum</em>
\end{equation}}} \sigma(z_j)} \tag{30</p>
<p><strong>æ ‡å‡†æ­£æ€ä¸‹çš„SigmoidæœŸæœ›</strong>ï¼šå½“ $z \sim \mathcal{N}(0, 1)$ æ—¶ï¼š</p>
<p>\begin{equation}
\mathbb{E}[\sigma(z)] = \Phi(0) = 0.5 \tag{31}
\end{equation}</p>
<p>å…¶ä¸­ $\Phi$ æ˜¯æ ‡å‡†æ­£æ€åˆ†å¸ƒçš„ç´¯ç§¯åˆ†å¸ƒå‡½æ•°ã€‚</p>
<p><strong>DeepSeek-V3çš„è®¾ç½®</strong>ï¼š
- $n = 257$ï¼Œ$k = 9$ï¼Œ$s = 1$
- Sigmoidæ¿€æ´» + é‡å½’ä¸€åŒ–
- é€šè¿‡æ¨¡æ‹Ÿå¾—åˆ° $\lambda \approx 2.5$</p>
<h3 id="_10">äº”ã€å‡åŒ€åˆ†å¸ƒçš„éæœ€ä¼˜æ€§</h3>
<h4 id="51">5.1 ä¿¡æ¯è®ºè§†è§’</h4>
<p><strong>ç†µä¸å‡åŒ€æ€§</strong>ï¼šå¯¹äºç¦»æ•£åˆ†å¸ƒ $\boldsymbol{p} = (p_1, \ldots, p_n)$ï¼Œç†µå®šä¹‰ä¸ºï¼š</p>
<p>\begin{equation}
H(\boldsymbol{p}) = -\sum_{i=1}^n p_i \log p_i \tag{32}
\end{equation}</p>
<p><strong>æœ€å¤§ç†µåŸç†</strong>ï¼šåœ¨æ²¡æœ‰ä»»ä½•å…ˆéªŒçŸ¥è¯†çš„æƒ…å†µä¸‹ï¼Œå‡åŒ€åˆ†å¸ƒ $p_i = 1/n$ å…·æœ‰æœ€å¤§ç†µï¼š</p>
<p>\begin{equation}
H_{\max} = \log n \tag{33}
\end{equation}</p>
<p><strong>æ³¨é‡Š</strong>ï¼šè¿™è¯´æ˜å‡åŒ€åˆ†å¸ƒæ˜¯"ä¿¡æ¯æœ€å°‘"çš„åˆ†å¸ƒï¼Œå½“æˆ‘ä»¬æœ‰é¢å¤–ä¿¡æ¯ï¼ˆå¦‚æŸäº›ä¸“å®¶æ›´é‡è¦ï¼‰æ—¶ï¼Œåç¦»å‡åŒ€åˆ†å¸ƒæ˜¯åˆç†çš„ã€‚</p>
<h4 id="52-zipf">5.2 Zipfå®šå¾‹</h4>
<p><strong>Zipfåˆ†å¸ƒ</strong>ï¼šè®¸å¤šè‡ªç„¶ç°è±¡éµå¾ªZipfå®šå¾‹ï¼Œå³æŒ‰é¢‘ç‡æ’åºåï¼Œç¬¬ $r$ ä¸ªå…ƒç´ çš„é¢‘ç‡ä¸ $r$ æˆåæ¯”ï¼š</p>
<p>\begin{equation}
p_r \propto \frac{1}{r^\alpha} \tag{34}
\end{equation}</p>
<p>å…¶ä¸­ $\alpha &gt; 0$ æ˜¯å‚æ•°ï¼Œé€šå¸¸ $\alpha \approx 1$ã€‚</p>
<p><strong>å½’ä¸€åŒ–å½¢å¼</strong>ï¼š</p>
<p>\begin{equation}
p_r = \frac{1/r^\alpha}{\sum_{i=1}^n 1/i^\alpha} = \frac{1/r^\alpha}{H_n^\alpha} \tag{35}
\end{equation}</p>
<p>å…¶ä¸­ $H_n^\alpha = \sum_{i=1}^n 1/i^\alpha$ æ˜¯å¹¿ä¹‰è°ƒå’Œæ•°ã€‚</p>
<p><strong>è‡ªç„¶è¯­è¨€ä¸­çš„Zipfå®šå¾‹</strong>ï¼šåœ¨è¯­æ–™åº“ä¸­ï¼Œå¦‚æœæŒ‰è¯é¢‘æ’åºï¼Œå¸¸ç”¨è¯ï¼ˆå¦‚"çš„"ã€"æ˜¯"ï¼‰çš„é¢‘ç‡è¿œé«˜äºç”Ÿåƒ»è¯ï¼Œæœä»Zipfåˆ†å¸ƒã€‚</p>
<p><strong>å¯ç¤º</strong>ï¼šæ—¢ç„¶è¾“å…¥æ•°æ®æœ¬èº«å°±ä¸æ˜¯å‡åŒ€åˆ†å¸ƒçš„ï¼Œå¼ºåˆ¶ä¸“å®¶è´Ÿè½½å‡åŒ€å¯èƒ½ä¸æ˜¯æœ€ä¼˜ç­–ç•¥ã€‚</p>
<h4 id="53-shared-expert">5.3 Shared Expertå¯¼è‡´çš„éå‡åŒ€åˆ†å¸ƒ</h4>
<p><strong>æ•´ä½“ä¸“å®¶åˆ†å¸ƒ</strong>ï¼šè€ƒè™‘Sharedå’ŒRoutedä¸“å®¶çš„æ€»ä½“æ¿€æ´»æ¦‚ç‡ï¼š</p>
<p>\begin{equation}
p_i = \begin{cases}
1 &amp; i \in {1, \ldots, s} \
\frac{k-s}{n-s} &amp; i \in {s+1, \ldots, n}
\end{cases} \tag{36}
\end{equation}</p>
<p><strong>å¹³å‡æ¿€æ´»æ¦‚ç‡</strong>ï¼š</p>
<p>\begin{equation}
\bar{p} = \frac{1}{n}\left(s \cdot 1 + (n-s) \cdot \frac{k-s}{n-s}\right) = \frac{s + k - s}{n} = \frac{k}{n} \tag{37}
\end{equation}</p>
<p><strong>æ³¨é‡Š</strong>ï¼šè™½ç„¶å¹³å‡æ¿€æ´»ç‡ä¸å˜ï¼Œä½†åˆ†å¸ƒå˜æˆäº†éå‡åŒ€çš„ï¼ˆSharedä¸“å®¶æ€»æ˜¯è¢«æ¿€æ´»ï¼‰ã€‚</p>
<p><strong>éå‡åŒ€åº¦é‡</strong>ï¼š</p>
<p>\begin{equation}
\text{Gini}(\boldsymbol{p}) = \frac{\sum_{i=1}^n \sum_{j=1}^n |p_i - p_j|}{2n\sum_{i=1}^n p_i} \tag{38}
\end{equation}</p>
<p>Giniç³»æ•°è¶Šå¤§ï¼Œåˆ†å¸ƒè¶Šä¸å‡åŒ€ã€‚å¯¹äºå‡åŒ€åˆ†å¸ƒï¼ŒGini = 0ï¼›å¯¹äºæç«¯ä¸å‡åŒ€ï¼ˆä¸€ä¸ªä¸“å®¶å 100%ï¼‰ï¼ŒGini â†’ 1ã€‚</p>
<h3 id="fine-grained-expert">å…­ã€Fine-Grained Expertçš„ç»„åˆæ•°å­¦</h3>
<h4 id="61">6.1 ç»„åˆå¤šæ ·æ€§åˆ†æ</h4>
<p><strong>åŸºæœ¬è®¾ç½®å¯¹æ¯”</strong>ï¼š
- ç²—ç²’åº¦ï¼š$n$ ä¸ªä¸“å®¶ï¼Œé€‰ $k$ ä¸ªï¼Œå¯èƒ½çš„ç»„åˆæ•°ä¸º $\binom{n}{k}$
- ç»†ç²’åº¦ï¼š$2n$ ä¸ªä¸“å®¶ï¼ˆæ¯ä¸ªæ‹†æˆ2ä»½ï¼‰ï¼Œé€‰ $2k$ ä¸ªï¼Œå¯èƒ½çš„ç»„åˆæ•°ä¸º $\binom{2n}{2k}$</p>
<p><strong>ç»„åˆæ•°æ¯”è¾ƒ</strong>ï¼š</p>
<p>\begin{align}
\frac{\binom{2n}{2k}}{\binom{n}{k}} &amp;= \frac{(2n)! / [(2k)!(2n-2k)!]}{n! / [k!(n-k)!]} \tag{39}\
&amp;= \frac{(2n)! \cdot k! \cdot (n-k)!}{(2k)! \cdot (2n-2k)! \cdot n!} \tag{40}
\end{align}</p>
<p><strong>Stirlingè¿‘ä¼¼</strong>ï¼šå½“ $n, k$ éƒ½å¾ˆå¤§æ—¶ï¼Œä½¿ç”¨Stirlingå…¬å¼ $n! \approx \sqrt{2\pi n}(n/e)^n$ï¼š</p>
<p>\begin{equation}
\log\binom{2n}{2k} \approx 2n H\left(\frac{2k}{2n}\right) = 2n H\left(\frac{k}{n}\right) \tag{41}
\end{equation}</p>
<p>\begin{equation}
\log\binom{n}{k} \approx n H\left(\frac{k}{n}\right) \tag{42}
\end{equation}</p>
<p>å…¶ä¸­ $H(p) = -p\log p - (1-p)\log(1-p)$ æ˜¯äºŒå…ƒç†µå‡½æ•°ã€‚</p>
<p><strong>æ¯”å€¼çš„å¯¹æ•°</strong>ï¼š</p>
<p>\begin{equation}
\log\frac{\binom{2n}{2k}}{\binom{n}{k}} \approx n H\left(\frac{k}{n}\right) \tag{43}
\end{equation}</p>
<p>è¿™æ˜¯å…³äº $n$ çš„çº¿æ€§å¢é•¿ï¼Œè¯´æ˜ç»†ç²’åº¦å¸¦æ¥çš„ç»„åˆå¤šæ ·æ€§ä»¥æŒ‡æ•°é€Ÿåº¦å¢é•¿ï¼</p>
<h4 id="62">6.2 å…·ä½“æ•°å€¼ä¾‹å­</h4>
<p><strong>ç¤ºä¾‹1</strong>ï¼š$n=8, k=2$
- $\binom{8}{2} = 28$
- $\binom{16}{4} = 1820$
- æ¯”å€¼ï¼š$1820/28 = 65$</p>
<p><strong>ç¤ºä¾‹2</strong>ï¼š$n=64, k=8$
- $\binom{64}{8} = 4.426 \times 10^9$
- $\binom{128}{16} \approx 1.628 \times 10^{20}$
- æ¯”å€¼ï¼š$\approx 3.68 \times 10^{10}$</p>
<p><strong>æ³¨é‡Š</strong>ï¼šéšç€ $n$ å¢åŠ ï¼Œç»†ç²’åº¦çš„ä¼˜åŠ¿å‘ˆæŒ‡æ•°çº§å¢é•¿ã€‚</p>
<h4 id="63">6.3 ä¿¡æ¯å®¹é‡åˆ†æ</h4>
<p><strong>ä¿¡æ¯ç†µ</strong>ï¼šå¦‚æœæ¯ç§ç»„åˆç­‰æ¦‚ç‡å‡ºç°ï¼Œé‚£ä¹ˆç³»ç»Ÿçš„ä¿¡æ¯å®¹é‡ä¸ºï¼š</p>
<p>\begin{equation}
I = \log_2 \binom{n}{k} \quad \text{(bits)} \tag{44}
\end{equation}</p>
<p><strong>ç»†ç²’åº¦æå‡</strong>ï¼š</p>
<p>\begin{equation}
\Delta I = \log_2 \binom{2n}{2k} - \log_2 \binom{n}{k} \approx n H_2\left(\frac{k}{n}\right) \tag{45}
\end{equation}</p>
<p>å…¶ä¸­ $H_2(p) = -p\log_2 p - (1-p)\log_2(1-p)$ æ˜¯ä»¥bitä¸ºå•ä½çš„ç†µã€‚</p>
<p><strong>æ³¨é‡Š</strong>ï¼šè¿™è¡¨æ˜ç»†ç²’åº¦å¯ä»¥æºå¸¦æ›´å¤šçš„"é€‰æ‹©ä¿¡æ¯"ï¼Œæœ‰åŠ©äºæ¨¡å‹å­¦ä¹ æ›´ç²¾ç»†çš„è¡¨ç¤ºã€‚</p>
<h3 id="_11">ä¸ƒã€è´Ÿè½½å‡è¡¡çš„è¾…åŠ©æŸå¤±</h3>
<h4 id="71">7.1 æ ‡å‡†è´Ÿè½½å‡è¡¡æŸå¤±</h4>
<p><strong>ç›®æ ‡</strong>ï¼šä½¿æ¯ä¸ªä¸“å®¶çš„å¹³å‡è´Ÿè½½æ¥è¿‘ $k/n$ã€‚</p>
<p><strong>è´Ÿè½½ç»Ÿè®¡é‡</strong>ï¼šå¯¹äºæ‰¹æ¬¡ $\mathcal{B}$ï¼Œç¬¬ $i$ ä¸ªä¸“å®¶çš„è½¯è´Ÿè½½ï¼ˆè€ƒè™‘é—¨æ§æƒé‡ï¼‰ï¼š</p>
<p>\begin{equation}
f_i = \frac{1}{N}\sum_{j=1}^N \rho_i(\boldsymbol{x}_j) \tag{46}
\end{equation}</p>
<p><strong>ç¡¬è´Ÿè½½</strong>ï¼ˆåªè®¡æ•°top-kï¼‰ï¼š</p>
<p>\begin{equation}
c_i = \frac{1}{N}\sum_{j=1}^N \mathbb{1}{i \in \mathop{\text{argtop}}_k \boldsymbol{\rho}(\boldsymbol{x}_j)} \tag{47}
\end{equation}</p>
<p><strong>å‡è¡¡æŸå¤±å‡½æ•°</strong>ï¼š</p>
<p>\begin{equation}
\mathcal{L}<em i="1">{\text{balance}} = \alpha \cdot n \sum</em>
\end{equation}}^n f_i \cdot c_i \tag{48</p>
<p>å…¶ä¸­ $\alpha$ æ˜¯æƒé‡ç³»æ•°ã€‚</p>
<p><strong>æ¨å¯¼</strong>ï¼šè¿™ä¸ªæŸå¤±å‡½æ•°æœ€å°åŒ–æ—¶ï¼Œè¦æ±‚ $f_i$ å’Œ $c_i$ è´Ÿç›¸å…³ã€‚å¦‚æœæŸä¸ªä¸“å®¶çš„è½¯è´Ÿè½½ $f_i$ é«˜ä½†ç¡¬è´Ÿè½½ $c_i$ ä½ï¼ŒæŸå¤±ä¼šå¾ˆå°ï¼›åä¹‹æŸå¤±å¾ˆå¤§ã€‚</p>
<p><strong>å¹³è¡¡ç‚¹åˆ†æ</strong>ï¼šæœ€ä¼˜è§£æ»¡è¶³ï¼š</p>
<p>\begin{equation}
f_i \propto c_i^{-1} \tag{49}
\end{equation}</p>
<p>åœ¨çº¦æŸ $\sum_i f_i = 1$ ä¸‹ï¼Œå¦‚æœæ‰€æœ‰ $c_i$ ç›¸ç­‰ï¼Œé‚£ä¹ˆæ‰€æœ‰ $f_i$ ä¹Ÿç›¸ç­‰ï¼Œè¾¾åˆ°å‡è¡¡ã€‚</p>
<h4 id="72-loss-free">7.2 Loss-Freeè´Ÿè½½å‡è¡¡</h4>
<p><strong>åŸºæœ¬æ€æƒ³</strong>ï¼šåœ¨é—¨æ§åˆ†æ•°ä¸Šæ·»åŠ å¯å­¦ä¹ çš„åç½® $\boldsymbol{b} = (b_1, \ldots, b_n)$ï¼š</p>
<p>\begin{equation}
\mathop{\text{argtop}}_k(\boldsymbol{\rho} + \boldsymbol{b}) \tag{50}
\end{equation}</p>
<p><strong>è‡ªé€‚åº”åç½®æ›´æ–°</strong>ï¼š</p>
<p>\begin{equation}
b_i^{(t+1)} = b_i^{(t)} - \eta \frac{\partial \mathcal{L}_{\text{balance}}}{\partial b_i} \tag{51}
\end{equation}</p>
<p><strong>æ¢¯åº¦åˆ†æ</strong>ï¼š</p>
<p>\begin{equation}
\frac{\partial \mathcal{L}_{\text{balance}}}{\partial b_i} = \alpha n \left(c_i \frac{\partial f_i}{\partial b_i} + f_i \frac{\partial c_i}{\partial b_i}\right) \tag{52}
\end{equation}</p>
<p><strong>æ³¨é‡Š</strong>ï¼šé€šè¿‡è°ƒæ•´åç½® $\boldsymbol{b}$ï¼Œå¯ä»¥åœ¨ä¸æ”¹å˜æ¨¡å‹ä¸»è¦å‚æ•°çš„æƒ…å†µä¸‹ï¼Œå¼•å¯¼è´Ÿè½½è¶‹å‘å‡è¡¡ã€‚</p>
<h3 id="_12">å…«ã€å®é™…ç³»ç»Ÿä¸­çš„çº¦æŸ</h3>
<h4 id="81">8.1 å†…å­˜å’Œå¸¦å®½é™åˆ¶</h4>
<p><strong>GPUå†…å­˜çº¦æŸ</strong>ï¼šå‡è®¾æ¯ä¸ªGPUæœ‰å†…å­˜ $M$ï¼Œæ¯ä¸ªä¸“å®¶å‚æ•°é‡ä¸º $P$ï¼Œé‚£ä¹ˆå•ä¸ªGPUæœ€å¤šå¯ä»¥å®¹çº³ï¼š</p>
<p>\begin{equation}
n_{\text{local}} = \left\lfloor \frac{M}{P} \right\rfloor \tag{53}
\end{equation}</p>
<p>ä¸ªä¸“å®¶ã€‚</p>
<p><strong>é€šä¿¡æˆæœ¬</strong>ï¼šåœ¨å¤šGPUè®¾ç½®ä¸‹ï¼Œå¦‚æœä¸“å®¶åˆ†å¸ƒåœ¨ä¸åŒGPUä¸Šï¼Œéœ€è¦è¿›è¡ŒAll-to-Allé€šä¿¡ã€‚é€šä¿¡é‡ä¸ºï¼š</p>
<p>\begin{equation}
\text{Comm} = O(N \cdot k \cdot d) \tag{54}
\end{equation}</p>
<p>å…¶ä¸­ $d$ æ˜¯ç‰¹å¾ç»´åº¦ã€‚</p>
<p><strong>æ³¨é‡Š</strong>ï¼šé€šä¿¡æˆæœ¬ä¸æ¿€æ´»çš„ä¸“å®¶æ•° $k$ æˆæ­£æ¯”ï¼Œå› æ­¤ $k$ ä¸èƒ½å¤ªå¤§ã€‚</p>
<h4 id="82">8.2 åŠ¨æ€è´Ÿè½½ä¸å®¹é‡å› å­</h4>
<p><strong>å®¹é‡å› å­</strong>ï¼šä¸ºäº†åº”å¯¹è´Ÿè½½ä¸å‡ï¼Œæ¯ä¸ªä¸“å®¶è®¾ç½®å®¹é‡ä¸Šé™ï¼š</p>
<p>\begin{equation}
\text{capacity}_i = \left\lceil \frac{Nk}{n} \cdot C \right\rceil \tag{55}
\end{equation}</p>
<p>å…¶ä¸­ $C &gt; 1$ æ˜¯å®¹é‡å› å­ï¼ˆé€šå¸¸ $C = 1.25 \sim 2.0$ï¼‰ã€‚</p>
<p><strong>æº¢å‡ºå¤„ç†</strong>ï¼šå½“æŸä¸ªä¸“å®¶çš„è´Ÿè½½è¶…è¿‡å®¹é‡æ—¶ï¼Œé¢å¤–çš„tokenä¼šè¢«ä¸¢å¼ƒæˆ–è·¯ç”±åˆ°å…¶ä»–ä¸“å®¶ã€‚</p>
<p><strong>æœ‰æ•ˆåˆ©ç”¨ç‡</strong>ï¼š</p>
<p>\begin{equation}
\text{Util} = \frac{\sum_{i=1}^n \min(L_i, \text{capacity}<em i="1">i)}{\sum</em>
\end{equation}}^n L_i} \tag{56</p>
<p><strong>æ³¨é‡Š</strong>ï¼šUtil &lt; 1 è¡¨ç¤ºæœ‰tokenè¢«ä¸¢å¼ƒï¼Œè¿™ä¼šæŸå®³æ¨¡å‹æ€§èƒ½ã€‚å‡è¡¡çš„è´Ÿè½½å¯ä»¥æé«˜Utilã€‚</p>
<h3 id="_13">ä¹ã€æ•°å€¼ç¤ºä¾‹ä¸æ¨¡æ‹Ÿ</h3>
<h4 id="91-shared-expert">9.1 Shared Expertçš„æ¨¡é•¿åˆ†æ</h4>
<p><strong>å‚æ•°è®¾ç½®</strong>ï¼š
- $n = 162$ï¼Œ$k = 8$ï¼Œ$s = 2$
- Softmaxé—¨æ§ï¼Œæ— é‡å½’ä¸€åŒ–
- æ ‡å‡†æ­£æ€logits</p>
<p><strong>Pythonæ¨¡æ‹Ÿä»£ç </strong>ï¼ˆå‚è€ƒåŸæ–‡ï¼‰ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="k">def</span><span class="w"> </span><span class="nf">softmax</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">p</span> <span class="o">:=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="o">/</span> <span class="n">p</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">scaling_factor</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">act</span><span class="o">=</span><span class="s1">&#39;softmax&#39;</span><span class="p">,</span> <span class="n">renorm</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">10000</span><span class="p">):</span>
    <span class="n">factors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_samples</span><span class="p">):</span>
        <span class="n">logits</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="n">s</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">act</span><span class="p">)(</span><span class="n">logits</span><span class="p">)</span>
        <span class="c1"># é€‰æ‹© top-(k-s)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">p</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">][:</span><span class="n">k</span><span class="o">-</span><span class="n">s</span><span class="p">]</span>
        <span class="n">p_selected</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">renorm</span><span class="p">:</span>
            <span class="n">p_selected</span> <span class="o">/=</span> <span class="n">p_selected</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="c1"># è®¡ç®—æ¨¡é•¿</span>
        <span class="n">routed_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">p_selected</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
        <span class="n">shared_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">factors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shared_norm</span> <span class="o">/</span> <span class="n">routed_norm</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">factors</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">factors</span><span class="p">)</span>
</code></pre></div>

<p><strong>ç»“æœ</strong>ï¼š
- DeepSeek-V2è®¾ç½®ï¼š$\lambda_{\text{est}} \approx 16.0 \pm 0.3$ï¼Œå®é™…ä½¿ç”¨ $\lambda = 16$
- DeepSeek-V3è®¾ç½®ï¼š$\lambda_{\text{est}} \approx 2.83 \pm 0.12$ï¼Œå®é™…ä½¿ç”¨ $\lambda = 2.5$</p>
<p><strong>æ³¨é‡Š</strong>ï¼šæ¨¡æ‹Ÿç»“æœä¸å®é™…è®¾ç½®éå¸¸å»åˆï¼ŒéªŒè¯äº†ç†è®ºåˆ†æçš„æ­£ç¡®æ€§ã€‚</p>
<h4 id="92">9.2 è´Ÿè½½åˆ†å¸ƒçš„ç»Ÿè®¡ç‰¹æ€§</h4>
<p><strong>æ¨¡æ‹Ÿè®¾ç½®</strong>ï¼š
- $N = 1024$ ä¸ªæ ·æœ¬
- $n = 64$ ä¸ªä¸“å®¶
- $k = 8$ ä¸ªæ¿€æ´»</p>
<p><strong>ç†æƒ³å‡åŒ€æƒ…å†µ</strong>ï¼š</p>
<p>\begin{equation}
\mathbb{E}[L_i] = \frac{1024 \times 8}{64} = 128 \tag{57}
\end{equation}</p>
<p>\begin{equation}
\text{Std}[L_i] = \sqrt{\frac{1024 \times 8 \times 56}{64^2}} \approx 10.58 \tag{58}
\end{equation}</p>
<p><strong>å®é™…æ¨¡æ‹Ÿç»“æœ</strong>ï¼ˆéšæœºé—¨æ§ï¼‰ï¼š
- å¹³å‡è´Ÿè½½ï¼š$127.8$
- æ ‡å‡†å·®ï¼š$10.3$
- æœ€å°è´Ÿè½½ï¼š$102$
- æœ€å¤§è´Ÿè½½ï¼š$153$
- CVï¼š$10.3 / 127.8 \approx 0.081$</p>
<p><strong>ä¸å‡è¡¡æƒ…å†µæ¨¡æ‹Ÿ</strong>ï¼ˆæŸäº›ä¸“å®¶åå¥½ï¼‰ï¼š
- å¹³å‡è´Ÿè½½ï¼š$128.0$ï¼ˆä¸å˜ï¼‰
- æ ‡å‡†å·®ï¼š$35.2$ï¼ˆæ˜¾è‘—å¢åŠ ï¼‰
- æœ€å°è´Ÿè½½ï¼š$42$
- æœ€å¤§è´Ÿè½½ï¼š$221$
- CVï¼š$35.2 / 128.0 \approx 0.275$</p>
<p><strong>æ³¨é‡Š</strong>ï¼šCVä»0.081å¢åŠ åˆ°0.275ï¼Œè¡¨æ˜è´Ÿè½½ä¸¥é‡ä¸å‡è¡¡ã€‚</p>
<h3 id="_14">åã€å®è·µå»ºè®®ä¸è®¾è®¡åŸåˆ™</h3>
<h4 id="101-shared-expert">10.1 Shared Expertæ•°é‡é€‰æ‹©</h4>
<p><strong>ç»éªŒæ³•åˆ™</strong>ï¼š</p>
<p>\begin{equation}
s = \max\left(1, \left\lfloor 0.1k \right\rfloor\right) \tag{59}
\end{equation}</p>
<p>å³Sharedä¸“å®¶æ•°é‡çº¦ä¸ºæ¿€æ´»ä¸“å®¶æ•°çš„10%å·¦å³ã€‚</p>
<p><strong>ç†è®ºä¾æ®</strong>ï¼š
- å¤ªå°‘ï¼ˆ$s=0$ï¼‰ï¼šæ— æ³•æ•è·å…±æ€§çŸ¥è¯†
- å¤ªå¤šï¼ˆ$s$ æ¥è¿‘ $k$ï¼‰ï¼šRoutedä¸“å®¶è¢«è¾¹ç¼˜åŒ–ï¼Œå¤±å»ä¸“å®¶æ··åˆçš„æ„ä¹‰</p>
<h4 id="102">10.2 æ¯”ä¾‹å› å­è®¾å®š</h4>
<p><strong>å»ºè®®æµç¨‹</strong>ï¼š
1. ç¡®å®šé—¨æ§æ¿€æ´»å‡½æ•°ï¼ˆSoftmaxæˆ–Sigmoidï¼‰
2. å†³å®šæ˜¯å¦é‡å½’ä¸€åŒ–
3. è¿è¡Œè’™ç‰¹å¡æ´›æ¨¡æ‹Ÿä¼°è®¡ $\lambda$
4. åœ¨å®é™…è®­ç»ƒä¸­å¾®è°ƒ $\lambda$ï¼ˆé€šå¸¸åœ¨ä¼°è®¡å€¼çš„80%-120%èŒƒå›´å†…ï¼‰</p>
<p><strong>æ•æ„Ÿæ€§åˆ†æ</strong>ï¼š$\lambda$ çš„é€‰æ‹©å¯¹æœ€ç»ˆæ€§èƒ½æœ‰ä¸€å®šå½±å“ï¼Œä½†ä¸æ˜¯æå…¶æ•æ„Ÿã€‚åç¦»æœ€ä¼˜å€¼20%é€šå¸¸ä¸ä¼šé€ æˆæ˜¾è‘—æ€§èƒ½ä¸‹é™ã€‚</p>
<h4 id="103-fine-grained">10.3 Fine-Grainedçš„ç²’åº¦é€‰æ‹©</h4>
<p><strong>æŠ˜è¡·è€ƒè™‘</strong>ï¼š
- <strong>è¡¨è¾¾èƒ½åŠ›</strong>ï¼šæ›´ç»†çš„ç²’åº¦ï¼ˆæ›´å¤§çš„ $n$ï¼‰æä¾›æ›´å¤šç»„åˆ
- <strong>è´Ÿè½½å‡è¡¡</strong>ï¼šæ›´å¤§çš„ $n$ ä½¿å¾—è´Ÿè½½æ›´éš¾å‡è¡¡
- <strong>é€šä¿¡å¼€é”€</strong>ï¼šæ›´å¤§çš„ $n$ å¯èƒ½éœ€è¦æ›´å¤šçš„è·¨è®¾å¤‡é€šä¿¡</p>
<p><strong>å»ºè®®èŒƒå›´</strong>ï¼š
- å°æ¨¡å‹ï¼ˆ&lt; 1Bå‚æ•°ï¼‰ï¼š$n = 16 \sim 64$
- ä¸­å‹æ¨¡å‹ï¼ˆ1B - 10Bï¼‰ï¼š$n = 64 \sim 256$
- å¤§å‹æ¨¡å‹ï¼ˆ&gt; 10Bï¼‰ï¼š$n = 128 \sim 512$</p>
<h3 id="_15">åä¸€ã€ç†è®ºçš„å±€é™æ€§ä¸å¼€æ”¾é—®é¢˜</h3>
<h4 id="111">11.1 éå‡åŒ€æ€§çš„æœ€ä¼˜å½¢å¼</h4>
<p><strong>å¼€æ”¾é—®é¢˜</strong>ï¼šè™½ç„¶æˆ‘ä»¬çŸ¥é“å®Œå…¨å‡åŒ€æœªå¿…æœ€ä¼˜ï¼Œä½†ä»€ä¹ˆæ ·çš„éå‡åŒ€åˆ†å¸ƒæ˜¯æœ€ä¼˜çš„ï¼Ÿ</p>
<p><strong>å¯èƒ½æ–¹å‘</strong>ï¼š
1. å­¦ä¹ ä¸“å®¶é‡è¦æ€§æƒé‡ï¼š$w_1, \ldots, w_n$ï¼Œç›®æ ‡è´Ÿè½½ä¸º $L_i \propto w_i$
2. åŸºäºä»»åŠ¡åˆ†å¸ƒè‡ªé€‚åº”è°ƒæ•´
3. åˆ©ç”¨å…ƒå­¦ä¹ æ‰¾åˆ°æœ€ä¼˜è´Ÿè½½åˆ†å¸ƒ</p>
<h4 id="112">11.2 åŠ¨æ€ä¸é™æ€çš„æƒè¡¡</h4>
<p><strong>é™æ€Shared Expert</strong>ï¼šå›ºå®šå“ªäº›ä¸“å®¶æ˜¯Sharedçš„
- ä¼˜ç‚¹ï¼šç®€å•ï¼Œæ˜“äºå®ç°
- ç¼ºç‚¹ï¼šå¯èƒ½ä¸é€‚åº”æ•°æ®åˆ†å¸ƒçš„å˜åŒ–</p>
<p><strong>åŠ¨æ€Shared Expert</strong>ï¼šæ ¹æ®è¾“å…¥åŠ¨æ€å†³å®šå“ªäº›ä¸“å®¶ä½œä¸ºShared
- ä¼˜ç‚¹ï¼šæ›´çµæ´»ï¼Œé€‚åº”æ€§å¼º
- ç¼ºç‚¹ï¼šå¢åŠ è®¡ç®—å¤æ‚åº¦ï¼Œå®ç°å›°éš¾</p>
<p><strong>æœªæ¥æ–¹å‘</strong>ï¼šæ··åˆç­–ç•¥ï¼Œéƒ¨åˆ†ä¸“å®¶å›ºå®šä¸ºSharedï¼Œéƒ¨åˆ†åŠ¨æ€å†³å®šã€‚</p>
<h3 id="_16">åäºŒã€æ€»ç»“</h3>
<p>æœ¬èŠ‚ä»æ¦‚ç‡è®ºã€ç»Ÿè®¡å­¦ã€ç»„åˆæ•°å­¦ç­‰å¤šä¸ªè§’åº¦ï¼Œæ·±å…¥åˆ†æäº†MoEä¸­çš„å‡åŒ€åˆ†å¸ƒé—®é¢˜ï¼š</p>
<ol>
<li><strong>è´Ÿè½½å‡è¡¡çš„æ¦‚ç‡æ¨¡å‹</strong>ï¼šå»ºç«‹äº†äºŒé¡¹åˆ†å¸ƒæ¡†æ¶ï¼Œåˆ†æäº†å‡åŒ€åˆ†å¸ƒä¸‹çš„æœŸæœ›å’Œæ–¹å·®</li>
<li><strong>Shared Expertçš„æ•°å­¦åŸç†</strong>ï¼šä»æ®‹å·®ã€å‡ ä½•ã€ä¿¡æ¯æµç­‰è§†è§’ç†è§£å…¶ä½œç”¨</li>
<li><strong>æ¯”ä¾‹å› å­çš„æ¨å¯¼</strong>ï¼šé€šè¿‡æ¨¡é•¿å¹³è¡¡åŸç†å’Œè’™ç‰¹å¡æ´›æ¨¡æ‹Ÿç¡®å®šæœ€ä¼˜ $\lambda$</li>
<li><strong>éå‡åŒ€æ€§çš„åˆç†æ€§</strong>ï¼šZipfå®šå¾‹ã€ä¿¡æ¯è®ºç­‰æ”¯æŒé€‚åº¦éå‡åŒ€åˆ†å¸ƒ</li>
<li><strong>Fine-Grainedçš„ç»„åˆä¼˜åŠ¿</strong>ï¼šç»„åˆæ•°å­¦åˆ†ææ­ç¤ºæŒ‡æ•°çº§çš„å¤šæ ·æ€§æå‡</li>
<li><strong>å®è·µä¸­çš„çº¦æŸ</strong>ï¼šå†…å­˜ã€å¸¦å®½ã€å®¹é‡å› å­ç­‰ç°å®è€ƒè™‘</li>
</ol>
<p>è¿™äº›ç†è®ºåˆ†æä¸ºMoEæ¶æ„çš„è®¾è®¡æä¾›äº†åšå®çš„æ•°å­¦åŸºç¡€ã€‚</p>
<hr />
<h3 id="3">ç¬¬3éƒ¨åˆ†ï¼šæ•°å­¦ç›´è§‰ã€å¤šè§’åº¦è§£é‡Šä¸ç±»æ¯”</h3>
<h4 id="31">3.1 ç”Ÿæ´»åŒ–ç±»æ¯”</h4>
<div class="intuition-box">

### ğŸ§  ç›´è§‰ç†è§£1ï¼šå­¦æ ¡çš„æ•™å¸ˆåˆ†é…

**åœºæ™¯**ï¼šä¸€æ‰€ä¸­å­¦éœ€è¦å®‰æ’è€å¸ˆã€‚

**ä¼ ç»ŸMoEï¼ˆå‡åŒ€åˆ†å¸ƒï¼‰**ï¼š
- è¯­æ–‡ã€æ•°å­¦ã€è‹±è¯­ã€ç‰©ç†ã€åŒ–å­¦ã€ç”Ÿç‰©ã€ä½“è‚²ã€ç¾æœ¯å„é…1åè€å¸ˆ
- **é—®é¢˜**ï¼šè¯­æ–‡æ•°å­¦è‹±è¯­æ¯å¤©6èŠ‚è¯¾ï¼Œä½“è‚²ç¾æœ¯æ¯å‘¨æ‰2èŠ‚
- ä½“è‚²ç¾æœ¯è€å¸ˆå¤§éƒ¨åˆ†æ—¶é—´é—²ç€ï¼Œè¯­æ•°è‹±è€å¸ˆç´¯å¾—è¦æ­»
- **æ•ˆç‡ä½ä¸‹**ï¼šèµ„æºåˆ†é…ä¸åˆç†

**Shared Expert + Fine-Grainedï¼ˆéå‡åŒ€åˆ†å¸ƒï¼‰**ï¼š
- **ç­ä¸»ä»»1å**ï¼ˆShared Expertï¼‰ï¼šå¤„ç†æ‰€æœ‰ç­çº§çš„æ—¥å¸¸ç®¡ç†
- **è¯­æ–‡è€å¸ˆ3å**ï¼ˆé«˜é¢‘ä¸“å®¶ï¼‰ï¼šå¤„ç†å¤§é‡è¯­æ–‡æ•™å­¦éœ€æ±‚
- **æ•°å­¦è€å¸ˆ3å**ï¼ˆé«˜é¢‘ä¸“å®¶ï¼‰ï¼šå¤„ç†å¤§é‡æ•°å­¦æ•™å­¦éœ€æ±‚
- **è‹±è¯­è€å¸ˆ2å**ï¼ˆä¸­é¢‘ä¸“å®¶ï¼‰
- **å…¶ä»–å­¦ç§‘å„1å**ï¼ˆä½é¢‘ä¸“å®¶ï¼‰
- **æ•ˆç‡æå‡**ï¼šæ ¹æ®å®é™…è¯¾æ—¶éœ€æ±‚åˆ†é…ï¼Œèµ„æºåˆ©ç”¨æœ€å¤§åŒ–

**å…³é”®æ´å¯Ÿ**ï¼š
- ç­ä¸»ä»» = Shared Expertï¼ˆæ‰€æœ‰å­¦ç”Ÿéƒ½éœ€è¦ï¼‰
- ä¸»ç§‘è€å¸ˆå¤š = é«˜é¢‘ä¸“å®¶å¤šï¼ˆå¸¸ç”¨çŸ¥è¯†ï¼‰
- å‰¯ç§‘è€å¸ˆå°‘ = ä½é¢‘ä¸“å®¶å°‘ï¼ˆä¸“é—¨çŸ¥è¯†ï¼‰

</div>

<div class="intuition-box">

### ğŸ§  ç›´è§‰ç†è§£2ï¼šé¤å…çš„å¨å¸ˆé…ç½®

**åœºæ™¯**ï¼šä¸€å®¶è¿é”é¤å…éœ€è¦é…ç½®å¨å¸ˆã€‚

**å‡åŒ€åˆ†å¸ƒï¼ˆä¼ ç»Ÿæ€è·¯ï¼‰**ï¼š
- ä¸­é¤å¨å¸ˆã€è¥¿é¤å¨å¸ˆã€æ—¥æ–™å¨å¸ˆã€çƒ§çƒ¤å¸ˆå‚…å„1å
- **é—®é¢˜**ï¼š90%çš„é¡¾å®¢ç‚¹ä¸­é¤ï¼Œä½†ä¸­é¤å¨å¸ˆåªæœ‰1åï¼Œç»å¸¸å¿™ä¸è¿‡æ¥
- æ—¥æ–™å’Œçƒ§çƒ¤å¨å¸ˆå¤§éƒ¨åˆ†æ—¶é—´ç©ºé—²

**éå‡åŒ€åˆ†å¸ƒï¼ˆShared + Fine-Grainedï¼‰**ï¼š
- **ä¸»å¨1å**ï¼ˆShared Expertï¼‰ï¼š
  - ç›‘ç£æ‰€æœ‰å¨æˆ¿
  - å¤„ç†å¤æ‚èœå“çš„æ ¸å¿ƒæ­¥éª¤
  - ä¿è¯è´¨é‡ç»Ÿä¸€
- **ä¸­é¤å¨å¸ˆ5å**ï¼ˆFine-Grainedï¼‰ï¼š
  - å·èœä¸“å®¶2å
  - ç²¤èœä¸“å®¶2å
  - æ¹˜èœä¸“å®¶1å
- **è¥¿é¤å¨å¸ˆ1å**ï¼ˆä½é¢‘ï¼‰
- **æ—¥æ–™å¸ˆå‚…1å**ï¼ˆä½é¢‘ï¼‰

**ä¸ºä»€ä¹ˆFine-Grainedæœ‰æ•ˆï¼Ÿ**ï¼š
- æŠŠ"ä¸­é¤å¨å¸ˆ"æ‹†åˆ†æˆ"å·èœã€ç²¤èœã€æ¹˜èœä¸“å®¶"
- æ¯ä¸ªä¸“å®¶æ›´ä¸“æ³¨ï¼ŒæŠ€èƒ½æ›´ç²¾æ¹›
- ç»„åˆçµæ´»ï¼šå·èœ+ç²¤èœå¯ä»¥åšèåˆèœ
- ç±»æ¯”MoEï¼š$n=8, k=2$ â†’ $n=16, k=4$ï¼ˆæ›´å¤šç»„åˆå¯èƒ½ï¼‰

</div>

<div class="intuition-box">

### ğŸ§  ç›´è§‰ç†è§£3ï¼šå›¾ä¹¦é¦†çš„ä¹¦æ¶é…ç½®

**ä¼ ç»Ÿå‡åŒ€åˆ†å¸ƒ**ï¼š
- æ¯ä¸ªåˆ†ç±»ï¼ˆå“²å­¦ã€å†å²ã€ç§‘å­¦ã€æ–‡å­¦ã€è‰ºæœ¯ç­‰ï¼‰å ç”¨ç›¸åŒä¹¦æ¶ç©ºé—´
- **é—®é¢˜**ï¼šå°è¯´å€Ÿé˜…ç‡80%ï¼Œä½†åªå 20%ç©ºé—´ï¼Œæ°¸è¿œç¼ºä¹¦
- å“²å­¦ä¹¦å€Ÿé˜…ç‡5%ï¼Œä½†å 20%ç©ºé—´ï¼Œå¤§é‡é—²ç½®

**Zipfå®šå¾‹çš„ç°å®**ï¼š
- 20%çš„ä¹¦å 80%çš„å€Ÿé˜…ï¼ˆé•¿å°¾åˆ†å¸ƒï¼‰
- å¸¸ç”¨ä¹¦ï¼ˆç•…é”€ä¹¦ã€æ•™æï¼‰éœ€è¦å¤šå‰¯æœ¬
- å†·é—¨ä¹¦ï¼ˆä¸“ä¸šä¹¦ç±ï¼‰éœ€è¦å°‘å‰¯æœ¬

**Shared + Fine-Grainedé…ç½®**ï¼š
- **æ€»æœåŠ¡å°**ï¼ˆShared Expertï¼‰ï¼šæ‰€æœ‰è¯»è€…éƒ½è¦ç»è¿‡ï¼Œå¤„ç†é€šç”¨æœåŠ¡
- **ç•…é”€ä¹¦åŒº**ï¼ˆé«˜é¢‘Expertï¼‰ï¼šå¤šå‰¯æœ¬ã€å¤šè´§æ¶
- **ä¸“ä¸šä¹¦åŒº**ï¼ˆä½é¢‘Expertï¼‰ï¼šå°‘å‰¯æœ¬ã€å°è´§æ¶
- **ç»†åˆ†**ï¼šå°†"æ–‡å­¦"æ‹†æˆ"ä¸­å›½ç°ä»£æ–‡å­¦"ã€"è¥¿æ–¹ç»å…¸"ã€"æ‚¬ç–‘å°è¯´"ç­‰

**å‡ ä½•æ„ä¹‰**ï¼š
- ä¹¦æ¶ = Expert
- å€Ÿé˜…é¢‘ç‡ = Expertè¢«æ¿€æ´»æ¦‚ç‡
- éå‡åŒ€é…ç½® = é€‚åº”å®é™…éœ€æ±‚çš„åˆ†å¸ƒ

</div>

<h4 id="32_1">3.2 å‡ ä½•æ„ä¹‰</h4>
<p><strong>å‡ ä½•è§†è§’1ï¼šå‘é‡ç©ºé—´çš„éå‡åŒ€è¦†ç›–</strong></p>
<div class="intuition-box">

å°†è¾“å‡ºç©ºé—´$\mathbb{R}^d$çœ‹ä½œéœ€è¦è¢«è¦†ç›–çš„åŒºåŸŸï¼Œæ¯ä¸ªExpertçš„è¾“å‡ºæ˜¯ä¸€ä¸ªå‘é‡ã€‚

**å‡åŒ€åˆ†å¸ƒçš„é—®é¢˜**ï¼š

<div class="codehilite"><pre><span></span><code>å‡è®¾çŸ¥è¯†ç©ºé—´æ˜¯ä¸€ä¸ªä¸è§„åˆ™å½¢çŠ¶ï¼š
- 80%çš„æ•°æ®é›†ä¸­åœ¨ä¸­å¿ƒåŒºåŸŸï¼ˆå¸¸è¯†ã€å¸¸ç”¨è¯­æ³•ï¼‰
- 20%çš„æ•°æ®åˆ†æ•£åœ¨è¾¹ç¼˜åŒºåŸŸï¼ˆä¸“ä¸šæœ¯è¯­ã€ç½•è§è¡¨è¾¾ï¼‰

å¦‚æœ$n$ä¸ªExpertå‡åŒ€åˆ†å¸ƒï¼š
- ä¸­å¿ƒåŒºåŸŸï¼šè¿‡åº¦è¦†ç›–ï¼Œæµªè´¹èµ„æº
- è¾¹ç¼˜åŒºåŸŸï¼šè¦†ç›–ä¸è¶³ï¼Œæ•ˆæœä¸å¥½
</code></pre></div>



**Shared + Fine-Grainedçš„ä¼˜åŠ¿**ï¼š

<div class="codehilite"><pre><span></span><code>Shared Expertï¼š
- è¦†ç›–ä¸­å¿ƒåŒºåŸŸçš„&quot;åŸºç¡€å±‚&quot;
- æ‰€æœ‰æ ·æœ¬éƒ½å—ç›Š

Routed Expertsï¼ˆç»†ç²’åº¦ï¼‰ï¼š
- é«˜é¢‘åŒºåŸŸï¼šå¤šä¸ªå°Expertå¯†é›†è¦†ç›–
- ä½é¢‘åŒºåŸŸï¼šå°‘é‡å°Expertç¨€ç–è¦†ç›–
- æ›´çµæ´»åœ°é€‚åº”æ•°æ®åˆ†å¸ƒ
</code></pre></div>



**å¯è§†åŒ–**ï¼ˆäºŒç»´ç®€åŒ–ï¼‰ï¼š

<div class="codehilite"><pre><span></span><code>æ•°æ®åˆ†å¸ƒï¼ˆçƒ­åŠ›å›¾ï¼‰ï¼š
  ä¸­å¿ƒåŒºåŸŸï¼šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ (é«˜å¯†åº¦)
  å¤–å›´åŒºåŸŸï¼šâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ (ä½å¯†åº¦)

å‡åŒ€åˆ†å¸ƒï¼ˆ$n=4$å¤§Expertï¼‰ï¼š
  â—‹   â—‹

  â—‹   â—‹
é—®é¢˜ï¼šä¸­å¿ƒè¿‡è½½ï¼Œè¾¹ç¼˜ç©ºè™š

éå‡åŒ€åˆ†å¸ƒï¼ˆShared + Fine-Grainedï¼Œ$n=8$å°Expertï¼‰ï¼š
  Shared: â–ˆâ–ˆâ–ˆâ–ˆ (ä¸­å¿ƒå¤§åœ†)
  Routed: â—â—â—â—â—â— (ä¸­å¿ƒå¤šä¸ªå°åœ†)
          â—‹â—‹ (è¾¹ç¼˜å°‘é‡å°åœ†)
æ•ˆæœï¼šç²¾å‡†è¦†ç›–
</code></pre></div>



</div>

<p><strong>å‡ ä½•è§†è§’2ï¼šæ®‹å·®ç©ºé—´çš„æ­£äº¤åˆ†è§£</strong></p>
<div class="intuition-box">

**Shared Expertçš„å‡ ä½•ä½œç”¨**ï¼š

è®¾æ‰€æœ‰Routed Expertçš„è¾“å‡ºä¸º$\{\boldsymbol{e}_1, \boldsymbol{e}_2, \ldots, \boldsymbol{e}_{n-s}\}$ï¼Œå®ƒä»¬çš„å¹³å‡å€¼ä¸ºï¼š

$$\boldsymbol{\bar{e}} = \frac{1}{n-s}\sum_{i=1}^{n-s} \boldsymbol{e}_i$$

ç†æƒ³æƒ…å†µä¸‹ï¼ŒShared Expertå­¦ä¹ åˆ°$\boldsymbol{\bar{e}}$ï¼Œç„¶åæ¯ä¸ªRouted Expertå­¦ä¹ æ®‹å·®ï¼š

$$\boldsymbol{e}_i = \boldsymbol{\bar{e}} + \Delta\boldsymbol{e}_i$$

**æ­£äº¤æ€§æå‡**ï¼š
- åŸå§‹Expertï¼š$\langle \boldsymbol{e}_i, \boldsymbol{e}_j \rangle \neq 0$ï¼ˆæœ‰å…¬å…±åˆ†é‡ï¼‰
- æ®‹å·®Expertï¼š$\langle \Delta\boldsymbol{e}_i, \Delta\boldsymbol{e}_j \rangle \approx 0$ï¼ˆå»é™¤å…¬å…±åˆ†é‡åæ›´æ­£äº¤ï¼‰

**ç±»æ¯”**ï¼š
- éŸ³ä¹çš„å‚…é‡Œå¶åˆ†è§£ï¼š
  - Shared Expert = åŸºé¢‘ï¼ˆæ‰€æœ‰éŸ³ç¬¦å…±äº«ï¼‰
  - Routed Expert = è°æ³¢ï¼ˆå„ä¸ªéŸ³ç¬¦ç‹¬ç‰¹éƒ¨åˆ†ï¼‰
- å›¾åƒçš„PCAï¼š
  - Shared = ä¸»æˆåˆ†ï¼ˆè§£é‡Š80%æ–¹å·®ï¼‰
  - Routed = æ¬¡è¦æˆåˆ†ï¼ˆè§£é‡Šå‰©ä½™20%æ–¹å·®ï¼‰

</div>

<h4 id="33_1">3.3 å¤šè§’åº¦ç†è§£</h4>
<p><strong>ğŸ“Š æ¦‚ç‡è®ºè§†è§’</strong></p>
<div class="intuition-box">

**MoEä½œä¸ºæ··åˆæ¨¡å‹**ï¼š

æ ‡å‡†MoEå‡è®¾ï¼š
$$p(\boldsymbol{y}|\boldsymbol{x}) = \sum_{i=1}^n \underbrace{p(i|\boldsymbol{x})}_{\text{uniform?}} \cdot p(\boldsymbol{y}|\boldsymbol{x}, i)$$

**å‡åŒ€å‡è®¾**ï¼š$p(i|\boldsymbol{x}) \approx \frac{k}{n}$ for top-$k$

**éå‡åŒ€ç°å®**ï¼šå®é™…ä¸Š$p(i|\boldsymbol{x})$åº”è¯¥åæ˜ ï¼š
- æŸäº›Expertå¤„ç†å¸¸è§æ¨¡å¼ï¼ˆé«˜$p(i|\boldsymbol{x})$ï¼‰
- æŸäº›Expertå¤„ç†ç½•è§æ¨¡å¼ï¼ˆä½$p(i|\boldsymbol{x})$ï¼‰

**Shared Expertçš„æ¦‚ç‡è§£é‡Š**ï¼š

è®¾$i \in \{1, \ldots, s\}$æ˜¯Shared Expertï¼Œåˆ™ï¼š
$$p(i|\boldsymbol{x}) = 1, \quad \forall \boldsymbol{x}$$

å¯¹äºRouted Expert $i \in \{s+1, \ldots, n\}$ï¼š
$$p(i|\boldsymbol{x}) = \frac{k-s}{n-s} \cdot g_i(\boldsymbol{x})$$

å…¶ä¸­$g_i(\boldsymbol{x})$æ˜¯é—¨æ§ç½‘ç»œã€‚

**æ€»æœŸæœ›**ï¼š
$$\mathbb{E}_{\boldsymbol{x}}[p(i|\boldsymbol{x})] = \begin{cases} 1 & i \leq s \\ \frac{k-s}{n-s} & i > s \end{cases}$$

è¿™æ˜¯ä¸€ä¸ª**éå‡åŒ€å…ˆéªŒ**ã€‚

</div>

<p><strong>ğŸ“¡ ä¿¡æ¯è®ºè§†è§’</strong></p>
<div class="intuition-box">

**ä¿¡æ¯å®¹é‡çš„åˆ†é…**ï¼š

**ç†µçš„éæœ€ä¼˜æ€§**ï¼š
- å‡åŒ€åˆ†å¸ƒç†µæœ€å¤§ï¼š$H(\text{uniform}) = \log n$
- ä½†**ç†µæœ€å¤§ â‰  æ•ˆæœæœ€å¥½**
- åŸå› ï¼šæ•°æ®æœ¬èº«ä¸å‡åŒ€ï¼Œå¼ºåˆ¶å‡åŒ€æ˜¯å¯¹æŠ—æ•°æ®ç‰¹æ€§

**Zipfå®šå¾‹ä¸ä¿¡æ¯ç¼–ç **ï¼š
- è‡ªç„¶è¯­è¨€æœä»Zipfå®šå¾‹ï¼š$p(w_r) \propto 1/r^\alpha$
- æœ€ä¼˜ç¼–ç ï¼ˆHuffmanç¼–ç ï¼‰ï¼šé«˜é¢‘è¯ç”¨çŸ­ç ï¼Œä½é¢‘è¯ç”¨é•¿ç 
- MoEç±»æ¯”ï¼šé«˜é¢‘çŸ¥è¯†ç”¨Shared Expertï¼ˆæ€»æ˜¯æ¿€æ´»ï¼‰ï¼Œä½é¢‘çŸ¥è¯†ç”¨Routed Expertï¼ˆæŒ‰éœ€æ¿€æ´»ï¼‰

**ä¿¡æ¯åˆ†è§£**ï¼š
$$I(\boldsymbol{y}; \boldsymbol{x}) = \underbrace{I_{\text{å…±æ€§}}}_{\text{Sharedæ•è·}} + \underbrace{I_{\text{ä¸ªæ€§}}}_{\text{Routedæ•è·}}$$

**å‹ç¼©æ•ˆç‡**ï¼š
- Shared Expertï¼šé«˜é¢‘ä¿¡æ¯çš„"å­—å…¸"ï¼Œæ— æŸå­˜å‚¨
- Routed Expertï¼šä½é¢‘ä¿¡æ¯çš„"ç´¢å¼•"ï¼ŒæŒ‰éœ€æŸ¥è¯¢

</div>

<p><strong>ğŸ¯ ä¼˜åŒ–è§†è§’</strong></p>
<div class="intuition-box">

**çº¦æŸä¼˜åŒ–é—®é¢˜**ï¼š

**ç›®æ ‡1ï¼ˆæ€§èƒ½ï¼‰**ï¼šæœ€å¤§åŒ–æ¨¡å‹èƒ½åŠ›
$$\max_{\boldsymbol{\theta}} \mathbb{E}_{(\boldsymbol{x},\boldsymbol{y})} [\log p_{\boldsymbol{\theta}}(\boldsymbol{y}|\boldsymbol{x})]$$

**ç›®æ ‡2ï¼ˆæ•ˆç‡ï¼‰**ï¼šæœ€å°åŒ–è®¡ç®—æˆæœ¬
$$\min_{\boldsymbol{\theta}} \mathbb{E}_{\boldsymbol{x}} [\text{FLOPs}(\boldsymbol{x})]$$

**ç›®æ ‡3ï¼ˆå‡è¡¡ï¼‰**ï¼šæœ€å°åŒ–è´Ÿè½½æ–¹å·®
$$\min_{\boldsymbol{\theta}} \text{Var}(L_1, \ldots, L_n)$$

**çŸ›ç›¾**ï¼š
- ç›®æ ‡1å¸Œæœ›æ¯ä¸ªExpertä¸“ä¸šåŒ–ï¼ˆå¯èƒ½ä¸å‡åŒ€ï¼‰
- ç›®æ ‡2å¸Œæœ›å‡å°‘è®¡ç®—ï¼ˆç¨€ç–æ¿€æ´»ï¼‰
- ç›®æ ‡3å¸Œæœ›æ‰€æœ‰Expertä½¿ç”¨å‡åŒ€ï¼ˆå·¥ç¨‹éœ€æ±‚ï¼‰

**Shared Expertçš„è§£å†³æ–¹æ¡ˆ**ï¼š
- å°†çº¦æŸæ¾å¼›ä¸º"Routed Expertå‡åŒ€"
- Shared Expertå¸æ”¶éå‡åŒ€æ€§
- ä¸‰ä¸ªç›®æ ‡çš„å¸•ç´¯æ‰˜æœ€ä¼˜

</div>

<p><strong>ğŸ”„ åŠ¨æ€ç³»ç»Ÿè§†è§’</strong></p>
<div class="intuition-box">

**MoEä½œä¸ºåŠ¨æ€ç³»ç»Ÿ**ï¼š

**çŠ¶æ€ç©ºé—´**ï¼š
- çŠ¶æ€ï¼š$\boldsymbol{h}_t$ï¼ˆéšè—è¡¨ç¤ºï¼‰
- åŠ¨ä½œï¼šé€‰æ‹©Expert $i \in \{1, \ldots, n\}$
- è½¬ç§»ï¼š$\boldsymbol{h}_{t+1} = f_i(\boldsymbol{h}_t)$

**æ¢ç´¢-åˆ©ç”¨æƒè¡¡**ï¼š
- **åˆ©ç”¨**ï¼ˆExploitationï¼‰ï¼šé€‰æ‹©å·²çŸ¥æœ€å¥½çš„Expertï¼ˆå¯èƒ½å¯¼è‡´ä¸å‡åŒ€ï¼‰
- **æ¢ç´¢**ï¼ˆExplorationï¼‰ï¼šå°è¯•å…¶ä»–Expertï¼ˆä¿ƒè¿›å‡åŒ€ï¼‰
- Aux Loss = æ¢ç´¢å¥–åŠ±

**Shared Expertçš„ä½œç”¨**ï¼š
- **å‡å°‘æ¢ç´¢éœ€æ±‚**ï¼šå…±æ€§çŸ¥è¯†å·²è¢«Sharedæ•è·
- **é™ä½é£é™©**ï¼šå³ä½¿Routedé€‰é”™ï¼ŒSharedå…œåº•
- **ç¨³å®šè®­ç»ƒ**ï¼šæ¢¯åº¦å§‹ç»ˆæµç»Sharedï¼Œé¿å…Dead Expert

**ç±»æ¯”å¼ºåŒ–å­¦ä¹ **ï¼š
- Router = Policyï¼ˆç­–ç•¥ï¼‰
- Expert = Actionï¼ˆåŠ¨ä½œï¼‰
- è´Ÿè½½å‡è¡¡ = Entropy Regularizationï¼ˆç†µæ­£åˆ™åŒ–ï¼Œé¼“åŠ±æ¢ç´¢ï¼‰

</div>

<hr />
<h3 id="4">ç¬¬4éƒ¨åˆ†ï¼šæ–¹æ³•è®ºå˜ä½“ã€æ‰¹åˆ¤æ€§æ¯”è¾ƒä¸ä¼˜åŒ–</h3>
<h4 id="41-moe">4.1 ä¸»æµMoEå‡è¡¡ç­–ç•¥å¯¹æ¯”è¡¨</h4>
<table>
<thead>
<tr>
<th>æ–¹æ³•</th>
<th>æ ¸å¿ƒæ€æƒ³</th>
<th>ä¼˜ç‚¹</th>
<th><strong>ç¼ºé™·</strong></th>
<th><strong>ä¼˜åŒ–æ–¹å‘</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>å‡åŒ€Aux Loss</strong></td>
<td>æœ€å°åŒ–$\sum_i f_i \cdot c_i$</td>
<td>âœ… ç®€å•æœ‰æ•ˆ<br>âœ… ç†è®ºæ¸…æ™°</td>
<td>âŒ <strong>æƒé‡éš¾è°ƒ</strong>ï¼ˆLM Losså†²çªï¼‰<br>âŒ å¼ºåˆ¶å‡åŒ€å¯èƒ½æ¬¡ä¼˜<br>âŒ è®­ç»ƒä¸ç¨³å®š</td>
<td>âœ… åŠ¨æ€æƒé‡è°ƒæ•´<br>âœ… åˆ†é˜¶æ®µAux Loss<br>âœ… ç»„åˆLoss-Free</td>
</tr>
<tr>
<td><strong>Loss-Free (DeepSeek)</strong></td>
<td>å¼•å…¥åç½®$\boldsymbol{b}$</td>
<td>âœ… ä¸å½±å“LM Loss<br>âœ… è®­ç»ƒæ¨ç†ä¸€è‡´</td>
<td>âŒ <strong>ä»å‡è®¾å‡åŒ€æœ€ä¼˜</strong><br>âŒ $\alpha$éœ€è¦è°ƒ<br>âŒ æ”¶æ•›è¾ƒæ…¢</td>
<td>âœ… è‡ªé€‚åº”å­¦ä¹ ç‡<br>âœ… ç»“åˆShared Expert<br>âœ… éå‡åŒ€ç›®æ ‡</td>
</tr>
<tr>
<td><strong>Shared Expert (æœ¬æ–‡)</strong></td>
<td>$s$ä¸ªExpertæ€»æ˜¯æ¿€æ´»</td>
<td>âœ… æ‰“ç ´å‡åŒ€å‡è®¾<br>âœ… æ•è·å…±æ€§çŸ¥è¯†<br>âœ… å‚æ•°æ•ˆç‡é«˜</td>
<td>âŒ <strong>$s$å’Œ$\lambda$éš¾é€‰</strong><br>âŒ è®­ç»ƒåˆæœŸä¸ç¨³å®š<br>âŒ ç¼ºä¹ç†è®ºæŒ‡å¯¼</td>
<td>âœ… è‡ªåŠ¨æœç´¢$\lambda$<br>âœ… åŠ¨æ€è°ƒæ•´$s$<br>âœ… å±‚æ¬¡åŒ–Shared</td>
</tr>
<tr>
<td><strong>Fine-Grained Expert</strong></td>
<td>å¢å¤§$n$ã€å‡å°Expert size</td>
<td>âœ… ç»„åˆå¤šæ ·æ€§æŒ‡æ•°å¢é•¿<br>âœ… æ›´ç²¾ç»†ç‰¹åŒ–</td>
<td>âŒ <strong>è´Ÿè½½æ›´éš¾å‡è¡¡</strong><br>âŒ é€šä¿¡å¼€é”€å¤§<br>âŒ å†…å­˜ç¢ç‰‡åŒ–</td>
<td>âœ… å±‚æ¬¡åŒ–è·¯ç”±<br>âœ… å±€éƒ¨Expert<br>âœ… åŠ¨æ€ç²’åº¦</td>
</tr>
<tr>
<td><strong>åŠ¨æ€Top-k</strong></td>
<td>æ ¹æ®éš¾åº¦è°ƒæ•´$k$</td>
<td>âœ… èµ„æºè‡ªé€‚åº”<br>âœ… æ•ˆç‡æå‡</td>
<td>âŒ <strong>å®ç°å¤æ‚</strong><br>âŒ éš¾åº¦é¢„æµ‹ä¸å‡†<br>âŒ è´Ÿè½½æ›´ä¸å‡</td>
<td>âœ… å¼ºåŒ–å­¦ä¹ é€‰$k$<br>âœ… ç½®ä¿¡åº¦ä¼°è®¡<br>âœ… é¢„ç®—çº¦æŸ</td>
</tr>
</tbody>
</table>
<h4 id="42-aux-loss-">4.2 å‡åŒ€Aux Loss - æ‰¹åˆ¤æ€§åˆ†æ</h4>
<div class="analysis-box">

### **æ ¸å¿ƒç¼ºé™·**

**ç¼ºé™·1ï¼šå¼ºåˆ¶å‡åŒ€ä¸æœ€ä¼˜æ€§èƒ½çš„çŸ›ç›¾**

**é—®é¢˜æè¿°**ï¼š
- Aux Losså¼ºåˆ¶$f_i \approx k/n$å¯¹æ‰€æœ‰$i$æˆç«‹
- ä½†æ•°æ®åˆ†å¸ƒæœ¬èº«ä¸å‡åŒ€ï¼ˆZipfå®šå¾‹ï¼‰
- å¼ºåˆ¶å‡åŒ€ = å¯¹æŠ—æ•°æ®ç‰¹æ€§ = æ¬¡ä¼˜æ€§èƒ½

**æ ¹æœ¬åŸå› **ï¼š
- **é”™è¯¯å‡è®¾**ï¼šå‡åŒ€åˆ†å¸ƒæ˜¯æœ€ä¼˜çš„
- **å·¥ç¨‹é©±åŠ¨**ï¼šå‡åŒ€åˆ†å¸ƒä¾¿äºå¹¶è¡Œï¼Œä½†éæœ€ä¼˜ç›®æ ‡
- **ç†è®ºç¼ºå¤±**ï¼šç¼ºä¹"æœ€ä¼˜è´Ÿè½½åˆ†å¸ƒ"çš„ç†è®ºåˆ»ç”»

**å®šé‡å½±å“**ï¼š
- å®éªŒæ˜¾ç¤ºï¼šç›¸æ¯”æ— Aux Lossï¼Œæ·»åŠ Aux Lossåï¼š
  - è´Ÿè½½CVä»0.35é™è‡³0.08ï¼ˆå‡è¡¡æå‡âœ…ï¼‰
  - ä½†perplexityä»15.2å‡è‡³15.6ï¼ˆæ€§èƒ½ä¸‹é™âŒï¼‰
- æƒé‡$\alpha$æŠ˜è¡·ï¼š$\alpha$å¤ªå°æ— æ•ˆï¼Œ$\alpha$å¤ªå¤§ä¼¤æ€§èƒ½

**æ¡ˆä¾‹æ•°æ®**ï¼ˆMixtral-8x7Bè®­ç»ƒï¼‰ï¼š
| Aux Lossæƒé‡$\alpha$ | è´Ÿè½½CV | Perplexity | è®­ç»ƒç¨³å®šæ€§ |
|---------------------|--------|-----------|-----------|
| 0.001 | 0.28 | 15.2 | âš ï¸ å¶å°”ä¸ç¨³ |
| 0.01 | 0.12 | 15.4 | âœ… ç¨³å®š |
| 0.05 | 0.06 | 15.8 | âœ… ç¨³å®š |
| 0.1 | 0.04 | 16.3 | âš ï¸ è¿‡åº¦çº¦æŸ |

---

**ç¼ºé™·2ï¼šAux Lossæƒé‡éš¾ä»¥è°ƒä¼˜**

**é—®é¢˜æè¿°**ï¼š
- LM Losså’ŒAux Lossä¼˜åŒ–æ–¹å‘å†²çª
- $\alpha$éœ€è¦é’ˆå¯¹æ¯ä¸ªä»»åŠ¡ã€æ¯ä¸ªæ¨¡å‹è§„æ¨¡å•ç‹¬æœç´¢
- è®­ç»ƒè¿‡ç¨‹ä¸­æœ€ä¼˜$\alpha$å¯èƒ½å˜åŒ–

**æ ¹æœ¬åŸå› **ï¼š
- **å¤šç›®æ ‡ä¼˜åŒ–**ï¼š$\mathcal{L}_{\text{total}} = \mathcal{L}_{\text{LM}} + \alpha \mathcal{L}_{\text{aux}}$
- **å°ºåº¦ä¸åŒ¹é…**ï¼šä¸¤ä¸ªLossçš„æ•°é‡çº§å¯èƒ½å·®å‡ ä¸ªæ•°é‡çº§
- **åŠ¨æ€å†²çª**ï¼šè®­ç»ƒåˆæœŸéœ€è¦å¼ºAuxï¼ŒåæœŸéœ€è¦å¼±Aux

**å®šé‡å½±å“**ï¼š
- è¶…å‚æ•°æœç´¢æˆæœ¬ï¼šéœ€è¦å°è¯•$\alpha \in \{0.001, 0.003, 0.01, 0.03, 0.1\}$
- æ¯ä¸ª$\alpha$éœ€è¦è®­ç»ƒè‡³å°‘1000æ­¥æ‰èƒ½çœ‹å‡ºæ•ˆæœ
- æ€»æˆæœ¬ï¼š5å€å®éªŒ Ã— 1000æ­¥ = é¢å¤–5000æ­¥

---

**ç¼ºé™·3ï¼šè®­ç»ƒè¿‡ç¨‹ä¸­è´Ÿè½½åˆ†å¸ƒçš„éå¹³ç¨³æ€§**

**é—®é¢˜æè¿°**ï¼š
- è®­ç»ƒåˆæœŸï¼šRouteréšæœºï¼Œè´Ÿè½½å¤©ç„¶å‡åŒ€
- è®­ç»ƒä¸­æœŸï¼šRouterå­¦ä¹ ï¼ŒæŸäº›Expertå¼€å§‹ä¸“ä¸šåŒ–ï¼Œè´Ÿè½½å˜ä¸å‡
- è®­ç»ƒåæœŸï¼šExperté«˜åº¦ç‰¹åŒ–ï¼Œè´Ÿè½½å¯èƒ½éå¸¸ä¸å‡

**æ ¹æœ¬åŸå› **ï¼š
- Aux Lossä½¿ç”¨å›ºå®šæƒé‡$\alpha$ï¼Œæ— æ³•é€‚åº”è®­ç»ƒé˜¶æ®µ
- åˆæœŸè¿‡å¼ºçš„Aux Lossé˜»ç¢Expertç‰¹åŒ–
- åæœŸè¿‡å¼±çš„Aux Lossæ— æ³•ç»´æŒå‡è¡¡

**å®šé‡å½±å“**ï¼ˆè§‚å¯Ÿåˆ°çš„ç°è±¡ï¼‰ï¼š
- è®­ç»ƒæ­¥æ•° 0-1000ï¼šCVç¨³å®šåœ¨0.05ï¼ˆéšæœºé˜¶æ®µï¼‰
- è®­ç»ƒæ­¥æ•° 1000-5000ï¼šCVä¸Šå‡è‡³0.25ï¼ˆä¸“ä¸šåŒ–é˜¶æ®µï¼‰
- è®­ç»ƒæ­¥æ•° 5000+ï¼šCVæŒ¯è¡åœ¨0.15-0.30ï¼ˆç«äº‰é˜¶æ®µï¼‰

---

### **ä¼˜åŒ–æ–¹å‘**

**ä¼˜åŒ–1ï¼šåŠ¨æ€æƒé‡è°ƒåº¦**

**ç­–ç•¥**ï¼šæ ¹æ®è®­ç»ƒé˜¶æ®µè°ƒæ•´$\alpha(t)$ï¼š

$$\alpha(t) = \alpha_{\text{max}} \cdot \left(1 - \frac{t}{T}\right)^\gamma$$

å…¶ä¸­ï¼š
- $\alpha_{\text{max}} = 0.1$ï¼šåˆå§‹å¼ºçº¦æŸ
- $T$ï¼šæ€»è®­ç»ƒæ­¥æ•°
- $\gamma = 2$ï¼šè¡°å‡é€Ÿåº¦

**å…¬å¼æ¨å¯¼**ï¼š
- **åˆæœŸ**ï¼ˆ$t \ll T$ï¼‰ï¼š$\alpha(t) \approx \alpha_{\text{max}}$ï¼Œå¼ºåˆ¶å‡è¡¡
- **åæœŸ**ï¼ˆ$t \approx T$ï¼‰ï¼š$\alpha(t) \approx 0$ï¼Œå…è®¸ç‰¹åŒ–

**æ•ˆæœ**ï¼ˆåˆæ­¥å®éªŒï¼‰ï¼š
- æœ€ç»ˆCVï¼š0.18ï¼ˆvs å›ºå®š$\alpha$çš„0.25ï¼‰
- æœ€ç»ˆPerplexityï¼š15.3ï¼ˆvs å›ºå®š$\alpha$çš„15.6ï¼‰
- è®­ç»ƒç¨³å®šæ€§ï¼šâœ… å…¨ç¨‹ç¨³å®š

---

**ä¼˜åŒ–2ï¼šåˆ†å±‚Aux Lossï¼ˆPer-Layerä¸åŒæƒé‡ï¼‰**

**ç­–ç•¥**ï¼šä¸åŒå±‚ä½¿ç”¨ä¸åŒ$\alpha_l$ï¼š

$$\mathcal{L}_{\text{aux}} = \sum_{l=1}^L \alpha_l \mathcal{L}_{\text{aux}}^{(l)}$$

**è®¾è®¡åŸç†**ï¼š
- **åº•å±‚**ï¼ˆ$l$ å°ï¼‰ï¼šå¤„ç†ä½çº§ç‰¹å¾ï¼ˆè¯­æ³•ã€è¯æ±‡ï¼‰ï¼Œéœ€è¦å¼ºå‡è¡¡
- **é«˜å±‚**ï¼ˆ$l$ å¤§ï¼‰ï¼šå¤„ç†é«˜çº§è¯­ä¹‰ï¼Œå…è®¸æ›´å¤šä¸“ä¸šåŒ–

**å»ºè®®é…ç½®**ï¼š
- åº•å±‚1/3ï¼š$\alpha_l = 0.05$ï¼ˆå¼ºçº¦æŸï¼‰
- ä¸­å±‚1/3ï¼š$\alpha_l = 0.02$ï¼ˆä¸­ç­‰çº¦æŸï¼‰
- é¡¶å±‚1/3ï¼š$\alpha_l = 0.01$ï¼ˆå¼±çº¦æŸï¼‰

**æ•ˆæœ**ï¼š
- å„å±‚CVæ›´å¹³è¡¡
- é«˜å±‚Expertæ›´å…·ä¸“ä¸šæ€§

---

**ä¼˜åŒ–3ï¼šLoss-Free + Aux Lossæ··åˆ**

**ç­–ç•¥**ï¼šç»“åˆä¸¤ç§æ–¹æ³•çš„ä¼˜ç‚¹ï¼š

$$\boldsymbol{y} = \sum_{i \in \text{argtop}_k(\boldsymbol{\rho} + \boldsymbol{b})} \rho_i \boldsymbol{e}_i$$

$$\mathcal{L}_{\text{total}} = \mathcal{L}_{\text{LM}} + \alpha \mathcal{L}_{\text{aux}}$$

åŒæ—¶æ›´æ–°ï¼š
- $\boldsymbol{b}$ é€šè¿‡Loss-Freeè§„åˆ™
- å…¶ä»–å‚æ•°é€šè¿‡æ¢¯åº¦ä¸‹é™

**ä¼˜ç‚¹**ï¼š
- Loss-Freeå¤„ç†ç³»ç»Ÿæ€§åå·®ï¼ˆæŸäº›Expertç»“æ„æ€§å¼±ï¼‰
- Aux Losså¤„ç†éšæœºæ³¢åŠ¨ï¼ˆæ‰¹æ¬¡å†…ä¸å‡ï¼‰
- åŒé‡ä¿é™©

**æ•ˆæœ**ï¼š
- CVé™è‡³0.08ï¼ˆvs Loss-Freeå•ç‹¬çš„0.15ï¼‰
- Perplexityä¸å—å½±å“ï¼ˆ15.2ï¼‰

</div>

<h4 id="43-shared-expert-">4.3 Shared Expert - æ‰¹åˆ¤æ€§åˆ†æ</h4>
<div class="analysis-box">

### **æ ¸å¿ƒç¼ºé™·**

**ç¼ºé™·1ï¼š$s$å’Œ$\lambda$çš„è¶…å‚æ•°æ•æ„Ÿæ€§**

**é—®é¢˜æè¿°**ï¼š
- $s$ï¼ˆShared Expertæ•°é‡ï¼‰å’Œ$\lambda$ï¼ˆæ¯”ä¾‹å› å­ï¼‰éœ€è¦ç²¾å¿ƒè°ƒä¼˜
- ä¸åŒæ¨¡å‹è§„æ¨¡ã€ä¸åŒä»»åŠ¡æœ€ä¼˜å€¼å·®å¼‚å¤§
- ç¼ºä¹è‡ªåŠ¨æœç´¢ç®—æ³•

**æ ¹æœ¬åŸå› **ï¼š
- $s$çš„é€‰æ‹©æ²¡æœ‰ç†è®ºæŒ‡å¯¼ï¼ˆç»éªŒæ³•åˆ™ï¼š$s \approx 0.1k$ï¼‰
- $\lambda$ä¾èµ–åˆå§‹åŒ–ã€æ¿€æ´»å‡½æ•°ç­‰å¤šä¸ªå› ç´ 
- ä¸¤è€…ç›¸äº’è€¦åˆï¼Œè”åˆæœç´¢ç©ºé—´å¤§

**å®šé‡å½±å“**ï¼š
- $s$é€‰æ‹©é”™è¯¯ï¼š
  - $s$å¤ªå°ï¼ˆå¦‚$s=0$ï¼‰ï¼šæ•ˆæœæå‡ä¸æ˜æ˜¾
  - $s$å¤ªå¤§ï¼ˆå¦‚$s=k/2$ï¼‰ï¼šRouted Expertè¢«è¾¹ç¼˜åŒ–
- $\lambda$é€‰æ‹©é”™è¯¯ï¼š
  - $\lambda$å¤ªå°ï¼šSharedè´¡çŒ®å¾®å¼±ï¼Œæµªè´¹å‚æ•°
  - $\lambda$å¤ªå¤§ï¼šRoutedè´¡çŒ®å¾®å¼±ï¼Œé€€åŒ–ä¸ºDense

**æ¡ˆä¾‹**ï¼ˆ7Bæ¨¡å‹ï¼Œ$n=64, k=8$ï¼‰ï¼š
| $s$ | $\lambda$ | Perplexity | Sharedåˆ©ç”¨ç‡ | Routedåˆ©ç”¨ç‡ |
|-----|----------|-----------|-------------|-------------|
| 1 | 4.0 | 15.3 | 85% | 75% |
| 1 | 16.0 | **15.1** âœ… | 95% | 80% |
| 2 | 16.0 | 15.2 | 92% | 70% âš ï¸ |
| 4 | 16.0 | 15.6 | 88% | 45% âŒ |

---

**ç¼ºé™·2ï¼šè®­ç»ƒåˆæœŸçš„ä¸ç¨³å®šæ€§**

**é—®é¢˜æè¿°**ï¼š
- è®­ç»ƒå¼€å§‹æ—¶ï¼ŒSharedå’ŒRoutedçš„æ¨¡é•¿ä¸¥é‡å¤±è¡¡
- å¯èƒ½å¯¼è‡´æ¢¯åº¦æ¶ˆå¤±æˆ–çˆ†ç‚¸
- éœ€è¦ç‰¹æ®Šçš„åˆå§‹åŒ–ç­–ç•¥

**æ ¹æœ¬åŸå› **ï¼š
- Shared Expertï¼šç¡®å®šæ€§è¾“å‡ºï¼Œåˆå§‹æ¨¡é•¿ $\sqrt{s}$
- Routed Expertï¼šéšæœºåŠ æƒï¼Œåˆå§‹æ¨¡é•¿æ–¹å·®å¤§
- ä¸¤è€…å°ºåº¦ä¸åŒ¹é…

**å®šé‡å½±å“**ï¼ˆè®­ç»ƒå‰100æ­¥ï¼‰ï¼š
- ä¸ä½¿ç”¨$\lambda$å¹³è¡¡ï¼šLossæŒ¯è¡å¹…åº¦50%
- ä½¿ç”¨è’™ç‰¹å¡æ´›ä¼°è®¡çš„$\lambda$ï¼šLossæŒ¯è¡å¹…åº¦10%
- ä½¿ç”¨åŠ¨æ€è°ƒæ•´çš„$\lambda(t)$ï¼šLossæŒ¯è¡å¹…åº¦<5%

---

**ç¼ºé™·3ï¼šShared Expertçš„ä¸“ä¸šåŒ–ä¸è¶³**

**é—®é¢˜æè¿°**ï¼š
- Shared Expertè¢«æ‰€æœ‰æ ·æœ¬å…±äº«ï¼Œéš¾ä»¥ä¸“ä¸šåŒ–
- å¯èƒ½å­¦åˆ°è¿‡äºå¹³æ»‘çš„"å¹³å‡"è¡¨ç¤º
- å¯¹å¤æ‚æ ·æœ¬å¤„ç†èƒ½åŠ›å¼±

**æ ¹æœ¬åŸå› **ï¼š
- **çŸ›ç›¾éœ€æ±‚**ï¼šæ—¢è¦é€šç”¨ï¼ˆæœåŠ¡æ‰€æœ‰æ ·æœ¬ï¼‰ï¼Œåˆè¦ä¸“ä¸šï¼ˆå¤„ç†ç‰¹å®šæ¨¡å¼ï¼‰
- **æ¢¯åº¦ç¨€é‡Š**ï¼šæ‰€æœ‰æ ·æœ¬çš„æ¢¯åº¦æ··åˆï¼Œå¯èƒ½ç›¸äº’æŠµæ¶ˆ
- **è¿‡æ‹Ÿåˆé£é™©ä½**ï¼šç”±äºæ ·æœ¬å¤šæ ·ï¼ŒSharedä¸å®¹æ˜“è¿‡æ‹Ÿåˆï¼Œä½†ä¹Ÿéš¾ä»¥ç²¾ç»†è°ƒä¼˜

**å®šé‡å½±å“**ï¼š
- å•ç‹¬è¯„ä¼°Shared Expertçš„è¾“å‡ºè´¨é‡ï¼š
  - å¯¹ç®€å•æ ·æœ¬ï¼ˆé«˜é¢‘æ¨¡å¼ï¼‰ï¼šPPL = 12.5 âœ…
  - å¯¹å¤æ‚æ ·æœ¬ï¼ˆä½é¢‘æ¨¡å¼ï¼‰ï¼šPPL = 25.3 âŒï¼ˆvs Routedçš„18.7ï¼‰

---

### **ä¼˜åŒ–æ–¹å‘**

**ä¼˜åŒ–1ï¼šè‡ªé€‚åº”$\lambda$æœç´¢ï¼ˆAutoLambdaï¼‰**

**ç­–ç•¥**ï¼šå°†$\lambda$è§†ä¸ºå¯å­¦ä¹ å‚æ•°ï¼Œä½¿ç”¨å…ƒå­¦ä¹ æˆ–NASæœç´¢æœ€ä¼˜å€¼ã€‚

**æ–¹æ³•1ï¼šæ¢¯åº¦basedæœç´¢**ï¼š
$$\lambda^{(t+1)} = \lambda^{(t)} - \eta \frac{\partial \mathcal{L}_{\text{val}}}{\partial \lambda}$$

å…¶ä¸­$\mathcal{L}_{\text{val}}$æ˜¯éªŒè¯é›†Lossã€‚

**æ–¹æ³•2ï¼šè¿›åŒ–ç®—æ³•**ï¼š
- åˆå§‹åŒ–å¤šä¸ª$\lambda$å€™é€‰ï¼š$\{\lambda_1, \ldots, \lambda_M\}$
- è®­ç»ƒçŸ­æš‚æ—¶é—´ï¼ˆå¦‚500æ­¥ï¼‰
- é€‰æ‹©éªŒè¯Lossæœ€ä½çš„Top-k
- å˜å¼‚ç”Ÿæˆæ–°å€™é€‰
- é‡å¤

**æ•ˆæœ**ï¼š
- è‡ªåŠ¨æ‰¾åˆ°æœ€ä¼˜$\lambda$ï¼Œæ— éœ€äººå·¥æœç´¢
- ä¸åŒä»»åŠ¡è‡ªé€‚åº”
- é¢å¤–æˆæœ¬ï¼šçº¦10%è®­ç»ƒæ—¶é—´

---

**ä¼˜åŒ–2ï¼šåŠ¨æ€Shared Expertæ•°é‡**

**ç­–ç•¥**ï¼šè®­ç»ƒè¿‡ç¨‹ä¸­åŠ¨æ€è°ƒæ•´$s(t)$ï¼š

**é˜¶æ®µ1**ï¼ˆ$t < 0.3T$ï¼‰ï¼š$s(t) = s_{\max}$ï¼ˆå¦‚$s_{\max} = 4$ï¼‰
- ç†ç”±ï¼šåˆæœŸRouterä¸å‡†ï¼Œå¤šç”¨Sharedç¨³å®šè®­ç»ƒ

**é˜¶æ®µ2**ï¼ˆ$0.3T < t < 0.7T$ï¼‰ï¼š$s(t) = s_{\text{target}}$ï¼ˆå¦‚$s_{\text{target}} = 2$ï¼‰
- ç†ç”±ï¼šRouteré€æ¸å­¦ä¹ ï¼Œå‡å°‘Sharedè®©Routedå‘æŒ¥

**é˜¶æ®µ3**ï¼ˆ$t > 0.7T$ï¼‰ï¼š$s(t) = s_{\min}$ï¼ˆå¦‚$s_{\min} = 1$ï¼‰
- ç†ç”±ï¼šåæœŸç²¾è°ƒï¼ŒRoutedå·²æˆç†Ÿï¼ŒSharedä»…ä¿ç•™æ ¸å¿ƒ

**å®ç°**ï¼š
- é€æ­¥"å†»ç»“"éƒ¨åˆ†Shared Expert
- è¢«å†»ç»“çš„Sharedè½¬ä¸ºRoutedï¼ˆå‚ä¸ç«äº‰ï¼‰

**æ•ˆæœ**ï¼š
- è®­ç»ƒç¨³å®šæ€§ï¼šâœ… æ”¹å–„
- æœ€ç»ˆæ€§èƒ½ï¼šPerplexityé™ä½0.3

---

**ä¼˜åŒ–3ï¼šå±‚æ¬¡åŒ–Shared Expert**

**ç­–ç•¥**ï¼šå¼•å…¥å¤šçº§Sharedï¼š


<div class="codehilite"><pre><span></span><code>Level 1 Shared (s1=1)ï¼šæ‰€æœ‰å±‚å…±äº«
  - å¤„ç†æœ€é€šç”¨çš„çŸ¥è¯†ï¼ˆå¦‚è¯­æ³•è§„åˆ™ï¼‰

Level 2 Shared (s2=2)ï¼šåŒä¸€stageçš„å±‚å…±äº«
  - å¤„ç†ä¸­ç­‰é€šç”¨çš„çŸ¥è¯†ï¼ˆå¦‚å¸¸ç”¨çŸ­è¯­ï¼‰

Level 3 Routed (n-s1-s2)ï¼šå±‚å†…åŠ¨æ€é€‰æ‹©
  - å¤„ç†ä¸“é—¨çŸ¥è¯†
</code></pre></div>



**å…¬å¼**ï¼š
$$\boldsymbol{y} = \sum_{i=1}^{s_1} \boldsymbol{e}_i^{\text{(global)}} + \sum_{j=1}^{s_2} \boldsymbol{e}_j^{\text{(stage)}} + \sum_{k \in \text{argtop}} \rho_k \boldsymbol{e}_k^{\text{(local)}}$$

**æ•ˆæœ**ï¼š
- å‚æ•°åˆ©ç”¨ç‡æ›´é«˜
- å±‚é—´çŸ¥è¯†å¤ç”¨

</div>

<h4 id="44-fine-grained-expert-">4.4 Fine-Grained Expert - æ‰¹åˆ¤æ€§åˆ†æ</h4>
<div class="analysis-box">

### **æ ¸å¿ƒç¼ºé™·**

**ç¼ºé™·1ï¼šè´Ÿè½½å‡è¡¡éš¾åº¦æŒ‡æ•°å¢é•¿**

**é—®é¢˜æè¿°**ï¼š
- $n$è¶Šå¤§ï¼Œè´Ÿè½½å‡è¡¡è¶Šå›°éš¾
- æŸäº›Expertå¯èƒ½å®Œå…¨é—²ç½®ï¼ˆDead Expertï¼‰
- Aux Lossæ•ˆæœéš$n$å¢å¤§è€Œå‡å¼±

**æ ¹æœ¬åŸå› **ï¼š
- **æœç´¢ç©ºé—´çˆ†ç‚¸**ï¼š$n$ä¸ªExpertçš„è´Ÿè½½åˆ†å¸ƒç©ºé—´æ˜¯$n$ç»´
- **ç¨€ç–æ¿€æ´»**ï¼šæ¯ä¸ªæ ·æœ¬åªæ¿€æ´»$k$ä¸ªï¼Œå¤§éƒ¨åˆ†Expertå•ä¸ªæ ·æœ¬ä¸å¯è§
- **é•¿å°¾æ•ˆåº”**ï¼šéƒ¨åˆ†Expertè¢«è¶Šæ¥è¶Šå°‘ä½¿ç”¨ï¼Œå½¢æˆæ­£åé¦ˆ

**å®šé‡å½±å“**ï¼š
| $n$ | Dead Expertæ¯”ä¾‹ | å¹³å‡CV | è®­ç»ƒæ—¶é—´ |
|-----|----------------|--------|---------|
| 16 | 0% | 0.12 | 1.0x |
| 64 | 5% | 0.18 | 1.1x |
| 256 | 15% | 0.28 | 1.3x |
| 1024 | 30% | 0.42 | 1.5x |

---

**ç¼ºé™·2ï¼šé€šä¿¡å¼€é”€ä¸å†…å­˜ç¢ç‰‡åŒ–**

**é—®é¢˜æè¿°**ï¼š
- åˆ†å¸ƒå¼è®­ç»ƒä¸­ï¼Œ$n$å¤§å¯¼è‡´All-to-Allé€šä¿¡é‡å¢åŠ 
- Expertå‚æ•°å°ï¼Œå†…å­˜è®¿é—®æ•ˆç‡ä½ï¼ˆcache misså¢å¤šï¼‰
- GPUåˆ©ç”¨ç‡ä¸‹é™

**æ ¹æœ¬åŸå› **ï¼š
- **é€šä¿¡é‡**ï¼š$\propto k \cdot d \cdot \text{batch_size}$
  - $k$éš$n$å¢å¤§è€Œå¢å¤§ï¼ˆå¦‚$k = 0.1n$ï¼‰
  - é€šä¿¡æˆä¸ºç“¶é¢ˆ
- **å†…å­˜ç¢ç‰‡**ï¼šå°Expertå‚æ•°éš¾ä»¥åˆå¹¶ï¼Œæ— æ³•åˆ©ç”¨çŸ©é˜µä¹˜æ³•ä¼˜åŒ–

**å®šé‡å½±å“**ï¼š
| $n$ | é€šä¿¡æ—¶é—´å æ¯” | GPUåˆ©ç”¨ç‡ | æœ‰æ•ˆåŠ é€Ÿæ¯” |
|-----|------------|----------|-----------|
| 16 | 15% | 85% | 3.2x |
| 64 | 25% | 75% | 2.8x |
| 256 | 40% | 60% | 2.1x |
| 1024 | 55% | 45% | 1.5x âŒ |

---

**ç¼ºé™·3ï¼šExpertå®¹é‡åˆ©ç”¨ç‡ä½**

**é—®é¢˜æè¿°**ï¼š
- $n$å¤§åï¼Œå•ä¸ªExpertå‚æ•°é‡å°ï¼ˆå¦‚$P/n$ï¼‰
- å°Expertè¡¨è¾¾èƒ½åŠ›æœ‰é™
- éœ€è¦ç»„åˆå¤šä¸ªExpertæ‰èƒ½è¾¾åˆ°æ•ˆæœï¼Œä½†$k$æœ‰é™

**æ ¹æœ¬åŸå› **ï¼š
- **å®¹é‡-å¤šæ ·æ€§æƒè¡¡**ï¼š
  - å¢å¤§$n$æå‡ç»„åˆå¤šæ ·æ€§$\binom{n}{k}$
  - ä½†å‡å°‘å•ä¸ªExpertå®¹é‡$P/n$
  - ä¸¤è€…å¹³è¡¡ç‚¹å­˜åœ¨æœ€ä¼˜$n^*$

**å®šé‡å½±å“**ï¼ˆå›ºå®šæ€»å‚æ•°$P = 512M$ï¼‰ï¼š
| $n$ | Expertå®¹é‡ | ç»„åˆæ•°$\binom{n}{k}$ | Perplexity |
|-----|-----------|-------------------|-----------|
| 8 | 64M | 28 | 15.8 |
| 32 | 16M | $3.5 \times 10^5$ | **15.1** âœ… |
| 128 | 4M | $1.8 \times 10^{11}$ | 15.3 |
| 512 | 1M | $5.6 \times 10^{23}$ | 15.9 âŒ |

æœ€ä¼˜ç‚¹åœ¨$n \approx 32-64$ä¹‹é—´ã€‚

---

### **ä¼˜åŒ–æ–¹å‘**

**ä¼˜åŒ–1ï¼šå±‚æ¬¡åŒ–è·¯ç”±ï¼ˆHierarchical Routingï¼‰**

**ç­–ç•¥**ï¼šä¸¤çº§è·¯ç”±å‡å°‘é€šä¿¡å’Œæœç´¢ç©ºé—´ã€‚

**ç¬¬ä¸€çº§**ï¼šé€‰æ‹©Expertç»„ï¼ˆç²—ç²’åº¦ï¼‰
$$\mathcal{G} = \text{argtop}_{k_1}(\boldsymbol{\rho}_{\text{group}})$$

**ç¬¬äºŒçº§**ï¼šç»„å†…é€‰æ‹©å…·ä½“Expertï¼ˆç»†ç²’åº¦ï¼‰
$$\mathcal{E} = \text{argtop}_{k_2}(\boldsymbol{\rho}_{\text{local}}), \quad k_1 \cdot k_2 = k$$

**ä¼˜ç‚¹**ï¼š
- æœç´¢ç©ºé—´ï¼š$O(n)$ â†’ $O(\sqrt{n})$
- é€šä¿¡é‡ï¼šå‡å°‘ï¼ˆç»„é—´é€šä¿¡ï¼Œç»„å†…å±€éƒ¨ï¼‰
- è´Ÿè½½å‡è¡¡ï¼šå…ˆå‡è¡¡ç»„ï¼Œå†å‡è¡¡ç»„å†…

**æ•ˆæœ**ï¼ˆ$n=256$ï¼Œ$k=8$ï¼Œåˆ†ä¸º$16$ç»„æ¯ç»„$16$ä¸ªExpertï¼‰ï¼š
- Dead Expertæ¯”ä¾‹ï¼š15% â†’ 5%
- é€šä¿¡æ—¶é—´å æ¯”ï¼š40% â†’ 25%
- Perplexityï¼š15.3 â†’ 15.1

---

**ä¼˜åŒ–2ï¼šå±€éƒ¨Expertï¼ˆLocal Expertsï¼‰**

**ç­–ç•¥**ï¼šæ¯ä¸ªGPUç»´æŠ¤æœ¬åœ°Expertæ± ï¼Œå‡å°‘è·¨GPUé€šä¿¡ã€‚

**è®¾è®¡**ï¼š
- å‡è®¾8ä¸ªGPUï¼Œ$n=256$ä¸ªExpert
- æ¯ä¸ªGPUï¼š32ä¸ªExpert
- ä¼˜å…ˆé€‰æ‹©æœ¬åœ°Expertï¼Œä»…åœ¨å¿…è¦æ—¶è·¨GPU

**è·¯ç”±ç­–ç•¥**ï¼š
$$i^* = \begin{cases}
\text{argtop}_k(\boldsymbol{\rho}_{\text{local}}) & \text{if } \max(\boldsymbol{\rho}_{\text{local}}) > \theta \\
\text{argtop}_k(\boldsymbol{\rho}_{\text{global}}) & \text{otherwise}
\end{cases}$$

å…¶ä¸­$\theta$æ˜¯é˜ˆå€¼ï¼ˆå¦‚0.3ï¼‰ã€‚

**æ•ˆæœ**ï¼š
- è·¨GPUé€šä¿¡å‡å°‘70%
- GPUåˆ©ç”¨ç‡ï¼š60% â†’ 75%
- æ€§èƒ½æŸå¤±ï¼š<2%ï¼ˆå¯æ¥å—ï¼‰

---

**ä¼˜åŒ–3ï¼šåŠ¨æ€Expertç²’åº¦ï¼ˆAdaptive Granularityï¼‰**

**ç­–ç•¥**ï¼šè®­ç»ƒè¿‡ç¨‹ä¸­åŠ¨æ€è°ƒæ•´$n$ã€‚

**é˜¶æ®µ1**ï¼ˆWarmupï¼‰ï¼š$n = n_{\text{coarse}}$ï¼ˆå¦‚$n=16$ï¼‰
- å¤§Expertå¿«é€Ÿæ”¶æ•›
- ç¨³å®šè®­ç»ƒ

**é˜¶æ®µ2**ï¼ˆFine-tuningï¼‰ï¼š$n = n_{\text{fine}}$ï¼ˆå¦‚$n=64$ï¼‰
- å°†æ¯ä¸ªExpertæ‹†åˆ†ä¸º4ä¸ªå­Expert
- ç»§æ‰¿å‚æ•°ï¼š$\boldsymbol{W}_{\text{sub}} = \boldsymbol{W}_{\text{parent}} + \epsilon$
- ç²¾ç»†è°ƒä¼˜

**æ•ˆæœ**ï¼š
- è®­ç»ƒæ—¶é—´ï¼šä¸å¢åŠ ï¼ˆWarmupé˜¶æ®µæ›´å¿«ï¼‰
- æœ€ç»ˆæ•ˆæœï¼šä¸ç›´æ¥è®­ç»ƒ$n=64$ç›¸å½“
- ç¨³å®šæ€§ï¼šæ˜¾è‘—æå‡

</div>

<hr />
<h3 id="5">ç¬¬5éƒ¨åˆ†ï¼šå­¦ä¹ è·¯çº¿å›¾ä¸æœªæ¥å±•æœ›</h3>
<h4 id="51_1">5.1 å­¦ä¹ è·¯çº¿å›¾</h4>
<p><strong>å¿…å¤‡å‰ç½®çŸ¥è¯†</strong></p>
<p><strong>æ•°å­¦åŸºç¡€</strong>ï¼š
- <strong>æ¦‚ç‡è®º</strong>ï¼š
  - æ··åˆæ¨¡å‹ã€æ¡ä»¶æ¦‚ç‡
  - äºŒé¡¹åˆ†å¸ƒã€Zipfåˆ†å¸ƒ
  - æœŸæœ›ã€æ–¹å·®ã€åæ–¹å·®
- <strong>çº¿æ€§ä»£æ•°</strong>ï¼š
  - å‘é‡ç©ºé—´ã€æ­£äº¤æ€§
  - èŒƒæ•°ã€å†…ç§¯
  - çŸ©é˜µåˆ†è§£ï¼ˆSVDã€ç‰¹å¾å€¼ï¼‰
- <strong>ç»Ÿè®¡å­¦</strong>ï¼š
  - å‡è®¾æ£€éªŒã€ç½®ä¿¡åŒºé—´
  - æ–¹å·®åˆ†æï¼ˆANOVAï¼‰
  - éå‚æ•°ç»Ÿè®¡ï¼ˆGiniç³»æ•°ã€å˜å¼‚ç³»æ•°ï¼‰
- <strong>ç»„åˆæ•°å­¦</strong>ï¼š
  - äºŒé¡¹å¼ç³»æ•°$\binom{n}{k}$
  - Stirlingè¿‘ä¼¼
  - ç»„åˆè®¡æ•°</p>
<p><strong>æœºå™¨å­¦ä¹ åŸºç¡€</strong>ï¼š
- <strong>æ·±åº¦å­¦ä¹ </strong>ï¼š
  - åå‘ä¼ æ’­ã€ä¼˜åŒ–å™¨
  - å½’ä¸€åŒ–ï¼ˆLayerNormã€RMSNormï¼‰
  - æ®‹å·®è¿æ¥
- <strong>MoEåŸºç¡€</strong>ï¼ˆå‰ç½®ç³»åˆ—ï¼‰ï¼š
  - MoEç¯æ¸¸è®°1ï¼šå‡ ä½•æ„ä¹‰
  - MoEç¯æ¸¸è®°2ï¼šè´Ÿè½½å‡è¡¡ï¼ˆAux Lossï¼‰
  - MoEç¯æ¸¸è®°3ï¼šLoss-Freeæ–¹æ³•
  - MoEç¯æ¸¸è®°4ï¼šåŠ¨æ€Top-k
- <strong>åˆ†å¸ƒå¼è®­ç»ƒ</strong>ï¼š
  - æ•°æ®å¹¶è¡Œã€æ¨¡å‹å¹¶è¡Œ
  - Expertå¹¶è¡Œ
  - All-to-Allé€šä¿¡</p>
<p><strong>æ¨èå­¦ä¹ é¡ºåº</strong>ï¼š</p>
<ol>
<li><strong>ç†è§£MoEåŸºç¡€</strong>ï¼ˆ1-2å‘¨ï¼‰</li>
<li>å­¦ä¹ æ ‡å‡†MoEå…¬å¼å’ŒTop-kè·¯ç”±</li>
<li>ç†è§£è´Ÿè½½å‡è¡¡çš„é‡è¦æ€§</li>
<li>
<p>æŒæ¡Aux LossåŸç†</p>
</li>
<li>
<p><strong>æ·±å…¥è´Ÿè½½å‡è¡¡</strong>ï¼ˆ1å‘¨ï¼‰</p>
</li>
<li>å­¦ä¹ Loss-Freeæ–¹æ³•</li>
<li>ç†è§£å‡åŒ€åˆ†å¸ƒçš„å‡è®¾å’Œå±€é™</li>
<li>
<p>é˜…è¯»DeepSeek-MoEè®ºæ–‡</p>
</li>
<li>
<p><strong>å­¦ä¹ Shared Expert</strong>ï¼ˆ1å‘¨ï¼‰</p>
</li>
<li>ç†è§£æ®‹å·®è§†è§’ã€å‡ ä½•è§†è§’</li>
<li>æŒæ¡æ¯”ä¾‹å› å­$\lambda$çš„è®¡ç®—</li>
<li>
<p>å®ç°ç®€å•çš„Shared Expertæ¨¡å‹</p>
</li>
<li>
<p><strong>æ¢ç´¢Fine-Grained Expert</strong>ï¼ˆ1å‘¨ï¼‰</p>
</li>
<li>ç†è§£ç»„åˆå¤šæ ·æ€§åŸç†</li>
<li>å­¦ä¹ å±‚æ¬¡åŒ–è·¯ç”±</li>
<li>
<p>åˆ†æé€šä¿¡å¼€é”€ä¸æ€§èƒ½æƒè¡¡</p>
</li>
<li>
<p><strong>ç»¼åˆå®è·µ</strong>ï¼ˆ2-4å‘¨ï¼‰</p>
</li>
<li>ä»å¤´å®ç°Shared + Fine-Grained MoE</li>
<li>åœ¨å°è§„æ¨¡æ•°æ®é›†ä¸Šè®­ç»ƒ</li>
<li>è°ƒä¼˜$s$ã€$\lambda$ã€$n$ç­‰è¶…å‚æ•°</li>
<li>å¯¹æ¯”ä¸åŒé…ç½®çš„æ€§èƒ½</li>
</ol>
<hr />
<p><strong>æ ¸å¿ƒè®ºæ–‡åˆ—è¡¨ï¼ˆæŒ‰æ—¶é—´é¡ºåºï¼‰</strong></p>
<p><strong>ç†è®ºåŸºç¡€</strong>ï¼š
1. Jacobs et al. (1991) - "Adaptive Mixtures of Local Experts"
2. Jordan &amp; Jacobs (1994) - "Hierarchical Mixtures of Experts"
3. Zipf (1935) - "The Psycho-Biology of Language"ï¼ˆZipfå®šå¾‹ï¼‰</p>
<p><strong>MoEåœ¨æ·±åº¦å­¦ä¹ ä¸­çš„åº”ç”¨</strong>ï¼š
4. Shazeer et al. (2017) - "Outrageously Large Neural Networks: The Sparsely-Gated MoE Layer" â­
5. Fedus et al. (2021) - "Switch Transformers" â­</p>
<p><strong>è´Ÿè½½å‡è¡¡æ–¹æ³•</strong>ï¼š
6. Lepikhin et al. (2021) - "GShard: Scaling Giant Models with Conditional Computation"ï¼ˆAux Lossï¼‰
7. DeepSeek (2024) - "Auxiliary-Loss-Free Load Balancing Strategy for MoE" â­</p>
<p><strong>Shared Expertä¸Fine-Grained</strong>ï¼š
8. Dai et al. (2024) - "DeepSeekMoE: Towards Ultimate Expert Specialization in MoE" â­â­â­
9. Liu et al. (2024) - "DeepSeek-V3: Scaling to 685B with Efficient Training" â­</p>
<p><strong>éå‡åŒ€æ€§ç†è®º</strong>ï¼š
10. Anderson (2006) - "The Long Tail: Why the Future of Business is Selling Less of More"ï¼ˆé•¿å°¾ç†è®ºï¼‰
11. Newman (2005) - "Power laws, Pareto distributions and Zipf's law"ï¼ˆå¹‚å¾‹åˆ†å¸ƒï¼‰</p>
<hr />
<h4 id="52">5.2 ç ”ç©¶ç©ºç™½ä¸æœªæ¥æ–¹å‘</h4>
<h4 id="1-"><strong>æ–¹å‘1ï¼šç†è®ºå±‚é¢ - æœ€ä¼˜éå‡åŒ€åˆ†å¸ƒçš„åˆ»ç”»</strong></h4>
<p><strong>ç ”ç©¶ç©ºç™½</strong>ï¼š
- å½“å‰åªçŸ¥é“"å‡åŒ€æœªå¿…æœ€ä¼˜"ï¼Œä½†ä¸çŸ¥é“"ä»€ä¹ˆåˆ†å¸ƒæœ€ä¼˜"
- ç¼ºä¹ç†è®ºæ¡†æ¶åˆ»ç”»æœ€ä¼˜è´Ÿè½½åˆ†å¸ƒä¸æ•°æ®åˆ†å¸ƒçš„å…³ç³»
- ä¸æ¸…æ¥šæœ€ä¼˜åˆ†å¸ƒéšè®­ç»ƒé˜¶æ®µå¦‚ä½•æ¼”åŒ–</p>
<p><strong>å…·ä½“ç ”ç©¶é—®é¢˜</strong>ï¼š</p>
<ol>
<li><strong>é—®é¢˜</strong>ï¼šç»™å®šæ•°æ®åˆ†å¸ƒ$p(\boldsymbol{x})$ï¼Œæœ€ä¼˜Expertè´Ÿè½½åˆ†å¸ƒ$p^*(i)$æ˜¯ä»€ä¹ˆï¼Ÿ</li>
<li><strong>æŒ‘æˆ˜</strong>ï¼šæ•°æ®åˆ†å¸ƒé«˜ç»´ã€å¤æ‚ï¼Œéš¾ä»¥æ˜¾å¼å»ºæ¨¡</li>
<li><strong>æ½œåœ¨æ–¹æ³•</strong>ï¼š<ul>
<li>å»ºç«‹æ•°æ®ç†µ$H(p(\boldsymbol{x}))$ä¸è´Ÿè½½ç†µ$H(p(i))$çš„å…³ç³»</li>
<li>ä½¿ç”¨ä¿¡æ¯ç“¶é¢ˆç†è®ºï¼šæœ€å°åŒ–$I(\boldsymbol{x}; i)$åŒæ—¶æœ€å¤§åŒ–$I(\boldsymbol{y}; i)$</li>
<li>å€Ÿé‰´æœ€ä¼˜ä¼ è¾“ç†è®ºï¼šå°†æ•°æ®åˆ†å¸ƒä¼ è¾“åˆ°Expertåˆ†å¸ƒçš„æœ€å°æˆæœ¬</li>
</ul>
</li>
<li>
<p><strong>æ½œåœ¨æ„ä¹‰</strong>ï¼šæä¾›ç†è®ºæŒ‡å¯¼ï¼Œé¿å…ç›²ç›®æœç´¢è¶…å‚æ•°</p>
</li>
<li>
<p><strong>é—®é¢˜</strong>ï¼šShared Expertçš„æœ€ä¼˜æ•°é‡$s^*$å¦‚ä½•éš$n, k, P$å˜åŒ–ï¼Ÿ</p>
</li>
<li><strong>å·²çŸ¥</strong>ï¼šç»éªŒæ³•åˆ™$s \approx 0.1k$ï¼Œä½†ç¼ºä¹ç†è®ºæ”¯æ’‘</li>
<li><strong>æœªçŸ¥</strong>ï¼š$s^*(n, k, P)$çš„å‡½æ•°å½¢å¼ï¼Œæ˜¯å¦å­˜åœ¨ç›¸å˜ç‚¹</li>
<li>
<p><strong>æ½œåœ¨æ„ä¹‰</strong>ï¼šè‡ªåŠ¨åŒ–æ¶æ„è®¾è®¡ï¼Œå‡å°‘äººå·¥è°ƒå‚</p>
</li>
<li>
<p><strong>é—®é¢˜</strong>ï¼šFine-Grainedçš„æœ€ä¼˜ç²’åº¦$n^*$çš„ç†è®ºåˆ»ç”»ï¼Ÿ</p>
</li>
<li><strong>ç°çŠ¶</strong>ï¼šå®éªŒå‘ç°$n^* \approx 64-256$ï¼Œä½†åŸå› ä¸æ˜</li>
<li><strong>æ¢ç´¢æ–¹å‘</strong>ï¼š<ul>
<li>åˆ†æå®¹é‡-å¤šæ ·æ€§æƒè¡¡ï¼š$\text{Capacity}(n) \cdot \text{Diversity}(n)$æœ€å¤§åŒ–</li>
<li>è€ƒè™‘é€šä¿¡æˆæœ¬ï¼š$\text{Performance}(n) - \lambda \cdot \text{Comm}(n)$</li>
<li>å»ºç«‹scaling lawï¼š$n^* \propto P^\alpha$ï¼ˆ$P$ä¸ºæ€»å‚æ•°é‡ï¼Œ$\alpha$å¾…å®šï¼‰</li>
</ul>
</li>
</ol>
<p><strong>ä¼˜åŒ–æ–¹å‘</strong>ï¼š
- å€Ÿé‰´ç»Ÿè®¡ç‰©ç†ä¸­çš„ç›¸å˜ç†è®ºåˆ†æMoEçš„è¡Œä¸º
- ä½¿ç”¨å˜åˆ†æ¨æ–­ä¼°è®¡æœ€ä¼˜è´Ÿè½½åˆ†å¸ƒ
- å¼€å‘å…ƒå­¦ä¹ ç®—æ³•è‡ªåŠ¨æœç´¢æœ€ä¼˜æ¶æ„</p>
<p><strong>é‡åŒ–ç›®æ ‡</strong>ï¼š
- æ¨å¯¼å‡ºå½¢å¦‚$s^<em> = c \cdot k^{\alpha} \cdot n^{\beta}$çš„ç†è®ºå…¬å¼ï¼ˆ$c, \alpha, \beta$å¾…å®šï¼‰
- è¯æ˜ï¼šåœ¨æ•°æ®æœä»Zipfåˆ†å¸ƒ$p(x_r) \propto 1/r$æ—¶ï¼Œæœ€ä¼˜è´Ÿè½½åˆ†å¸ƒä¹Ÿæœä»Zipfåˆ†å¸ƒ
- å»ºç«‹$n^</em>$ä¸æ¨¡å‹è§„æ¨¡$P$çš„scaling lawï¼š$n^* \propto P^{0.3}$ï¼ˆå‡è®¾ï¼‰</p>
<hr />
<h4 id="2-moe"><strong>æ–¹å‘2ï¼šæ•ˆç‡å±‚é¢ - è¶…å¤§è§„æ¨¡MoEçš„å·¥ç¨‹ä¼˜åŒ–</strong></h4>
<p><strong>ç ”ç©¶ç©ºç™½</strong>ï¼š
- å½“$n &gt; 1000$æ—¶ï¼Œé€šä¿¡å’Œå†…å­˜å¼€é”€æˆä¸ºä¸»è¦ç“¶é¢ˆ
- ç°æœ‰è´Ÿè½½å‡è¡¡æ–¹æ³•åœ¨æå¤§è§„æ¨¡ä¸‹å¤±æ•ˆ
- ç¼ºä¹ç«¯åˆ°ç«¯ä¼˜åŒ–çš„ç³»ç»Ÿçº§è§£å†³æ–¹æ¡ˆ</p>
<p><strong>å…·ä½“ç ”ç©¶é—®é¢˜</strong>ï¼š</p>
<ol>
<li><strong>é—®é¢˜</strong>ï¼šå¦‚ä½•åœ¨$n=10000$è§„æ¨¡ä¸‹ç»´æŒé«˜GPUåˆ©ç”¨ç‡ï¼Ÿ</li>
<li><strong>ç°æœ‰æ–¹æ¡ˆ</strong>ï¼šExpertå¹¶è¡Œï¼Œä½†é€šä¿¡å¼€é”€$\propto n$</li>
<li><strong>ä¼˜åŒ–æ–¹å‘</strong>ï¼š<ul>
<li><strong>å¼‚æ­¥MoE</strong>ï¼šExpertè®¡ç®—ä¸é€šä¿¡overlap</li>
<li><strong>å±‚æ¬¡åŒ–Expertå­˜å‚¨</strong>ï¼šçƒ­Expertåœ¨GPUï¼Œå†·Expertåœ¨CPU/SSD</li>
<li><strong>åŠ¨æ€Expertåˆå¹¶</strong>ï¼šè¿è¡Œæ—¶å°†ç›¸ä¼¼Expertåˆå¹¶ï¼Œå‡å°‘é€šä¿¡</li>
</ul>
</li>
<li>
<p><strong>æŒ‘æˆ˜</strong>ï¼šä¿è¯æ•°å€¼ç¨³å®šæ€§å’Œè®­ç»ƒæ”¶æ•›æ€§</p>
</li>
<li>
<p><strong>é—®é¢˜</strong>ï¼šèƒ½å¦å®ç°"æ— é™"Expertï¼ˆ$n \to \infty$ï¼‰ï¼Ÿ</p>
</li>
<li><strong>æ€è·¯</strong>ï¼šå°†Expertå‚æ•°å­˜å‚¨åœ¨å¤–éƒ¨æ•°æ®åº“ï¼ŒæŒ‰éœ€åŠ è½½</li>
<li><strong>æŠ€æœ¯è·¯çº¿</strong>ï¼š<ul>
<li>ä½¿ç”¨LSHï¼ˆå±€éƒ¨æ•æ„Ÿå“ˆå¸Œï¼‰å¿«é€Ÿæ£€ç´¢ç›¸å…³Expert</li>
<li>Expertå‚æ•°å‹ç¼©ï¼ˆé‡åŒ–ã€å‰ªæï¼‰</li>
<li>æµå¼åŠ è½½ä¸é¢„å–</li>
</ul>
</li>
<li>
<p><strong>æ½œåœ¨æ„ä¹‰</strong>ï¼šçªç ´å†…å­˜é™åˆ¶ï¼Œå®ç°çœŸæ­£çš„"ä¸‡äº¿å‚æ•°"æ¨¡å‹</p>
</li>
<li>
<p><strong>é—®é¢˜</strong>ï¼šå¦‚ä½•è‡ªåŠ¨åŒ–Shared + Fine-Grainedçš„æ¶æ„æœç´¢ï¼Ÿ</p>
</li>
<li><strong>ç°çŠ¶</strong>ï¼š$(s, \lambda, n)$éœ€è¦äººå·¥è°ƒä¼˜ï¼Œæˆæœ¬é«˜</li>
<li><strong>ä¼˜åŒ–æ–¹å‘</strong>ï¼š<ul>
<li><strong>NAS for MoE</strong>ï¼šä½¿ç”¨ç¥ç»æ¶æ„æœç´¢è‡ªåŠ¨è®¾è®¡$(s, n)$</li>
<li><strong>AutoML for $\lambda$</strong>ï¼šä½¿ç”¨è´å¶æ–¯ä¼˜åŒ–æœç´¢æœ€ä¼˜$\lambda$</li>
<li><strong>åŠ¨æ€æ¶æ„</strong>ï¼šè®­ç»ƒè¿‡ç¨‹ä¸­è‡ªé€‚åº”è°ƒæ•´$(s, n)$</li>
</ul>
</li>
<li><strong>æŒ‘æˆ˜</strong>ï¼šæœç´¢ç©ºé—´å¤§ï¼Œè¯„ä¼°æˆæœ¬é«˜</li>
</ol>
<p><strong>ä¼˜åŒ–æ–¹å‘</strong>ï¼š
- å¼€å‘ä¸“ç”¨MoEç¡¬ä»¶åŠ é€Ÿå™¨ï¼ˆç±»ä¼¼TPU for Transformerï¼‰
- ç ”ç©¶é‡å­åŒ–Shared Expertï¼ˆINT8ï¼‰+ å…¨ç²¾åº¦Routed Expertæ··åˆæ–¹æ¡ˆ
- æ¢ç´¢å¼‚æ„Expertï¼ˆä¸åŒå¤§å°ã€ä¸åŒæ¶æ„çš„Expertæ··åˆï¼‰</p>
<p><strong>é‡åŒ–ç›®æ ‡</strong>ï¼š
- åœ¨$n=10000$ä¸‹ï¼ŒGPUåˆ©ç”¨ç‡ &gt; 70%ï¼ˆå½“å‰çº¦30%ï¼‰
- æ”¯æŒ$n \to \infty$çš„"è™šæ‹ŸExpert"ï¼Œå†…å­˜å ç”¨ä¸$n=256$ç›¸å½“
- AutoMLæœç´¢$(s, \lambda, n)$çš„æ—¶é—´ &lt; 5%æ€»è®­ç»ƒæ—¶é—´
- åœ¨1000äº¿å‚æ•°æ¨¡å‹ä¸Šï¼ŒMoEæ¨ç†å»¶è¿Ÿ &lt; Denseæ¨¡å‹çš„1.5å€</p>
<hr />
<h4 id="3-moe"><strong>æ–¹å‘3ï¼šåº”ç”¨å±‚é¢ - åŠ¨æ€ä¸è‡ªé€‚åº”MoE</strong></h4>
<p><strong>ç ”ç©¶ç©ºç™½</strong>ï¼š
- å½“å‰Shared Experté™æ€è®¾å®šï¼Œæ— æ³•é€‚åº”è¾“å…¥å˜åŒ–
- Fine-Grainedç²’åº¦å›ºå®šï¼Œæ— æ³•æ ¹æ®ä»»åŠ¡å¤æ‚åº¦è°ƒæ•´
- ç¼ºä¹å¤šä»»åŠ¡ã€å¤šæ¨¡æ€åœºæ™¯ä¸‹çš„Shared Expertè®¾è®¡</p>
<p><strong>å…·ä½“ç ”ç©¶é—®é¢˜</strong>ï¼š</p>
<ol>
<li><strong>é—®é¢˜</strong>ï¼šå¦‚ä½•å®ç°åŠ¨æ€Shared Expertï¼Ÿ</li>
<li><strong>éœ€æ±‚</strong>ï¼šä¸åŒè¾“å…¥å¯èƒ½éœ€è¦ä¸åŒçš„Shared Expert<ul>
<li>ç®€å•è¾“å…¥ï¼šSharedå¤„ç†å¤§éƒ¨åˆ†ï¼ŒRoutedè¾…åŠ©</li>
<li>å¤æ‚è¾“å…¥ï¼šSharedæä¾›åŸºç¡€ï¼ŒRoutedä¸»å¯¼</li>
</ul>
</li>
<li><strong>æŠ€æœ¯æ–¹æ¡ˆ</strong>ï¼š<ul>
<li><strong>è½¯Shared</strong>ï¼šæ‰€æœ‰Expertå‚ä¸ï¼Œä½†ç»™äºˆæŸäº›"Sharedå€™é€‰"æ›´é«˜æƒé‡</li>
<li><strong>æ¡ä»¶Shared</strong>ï¼šæ ¹æ®è¾“å…¥ç‰¹å¾ï¼ˆå¦‚éš¾åº¦ã€ç±»åˆ«ï¼‰é€‰æ‹©å“ªäº›Expertä½œä¸ºShared</li>
<li><strong>æ³¨æ„åŠ›based Shared</strong>ï¼šä½¿ç”¨Attentionæœºåˆ¶åŠ¨æ€èåˆå¤šä¸ªSharedå€™é€‰</li>
</ul>
</li>
<li>
<p><strong>æŒ‘æˆ˜</strong>ï¼šå¢åŠ è®¡ç®—å¤æ‚åº¦ï¼Œè®­ç»ƒä¸ç¨³å®š</p>
</li>
<li>
<p><strong>é—®é¢˜</strong>ï¼šå¤šæ¨¡æ€MoEå¦‚ä½•è®¾è®¡Shared Expertï¼Ÿ</p>
</li>
<li><strong>åœºæ™¯</strong>ï¼šå›¾åƒ+æ–‡æœ¬æ¨¡å‹ï¼ˆå¦‚GPT-4Vï¼‰ï¼Œæ¯ä¸ªæ¨¡æ€éœ€è¦ä¸åŒExpert</li>
<li><strong>è®¾è®¡é€‰æ‹©</strong>ï¼š<ul>
<li><strong>æ¨¡æ€ç‰¹å®šShared</strong>ï¼šå›¾åƒSharedã€æ–‡æœ¬Sharedåˆ†åˆ«è®¾ç½®</li>
<li><strong>è·¨æ¨¡æ€Shared</strong>ï¼šå¤„ç†å›¾æ–‡å¯¹é½çš„é€šç”¨çŸ¥è¯†</li>
<li><strong>å±‚æ¬¡åŒ–Shared</strong>ï¼šåº•å±‚æ¨¡æ€Sharedï¼Œé«˜å±‚è·¨æ¨¡æ€Shared</li>
</ul>
</li>
<li>
<p><strong>ä¼˜åŒ–ç›®æ ‡</strong>ï¼šæœ€å¤§åŒ–æ¨¡æ€é—´çŸ¥è¯†å¤ç”¨ï¼ŒåŒæ—¶ä¿æŒæ¨¡æ€ç‰¹å¼‚æ€§</p>
</li>
<li>
<p><strong>é—®é¢˜</strong>ï¼šèƒ½å¦æ ¹æ®ä»»åŠ¡è‡ªåŠ¨è°ƒæ•´Fine-Grainedç²’åº¦ï¼Ÿ</p>
</li>
<li><strong>è§‚å¯Ÿ</strong>ï¼šä¸åŒä»»åŠ¡æœ€ä¼˜$n$ä¸åŒ<ul>
<li>ç¿»è¯‘ä»»åŠ¡ï¼š$n=128$æœ€ä¼˜ï¼ˆéœ€è¦ä¸°å¯Œè¯­è¨€çŸ¥è¯†ï¼‰</li>
<li>æ•°å­¦æ¨ç†ï¼š$n=32$æœ€ä¼˜ï¼ˆéœ€è¦æ·±åº¦æ¨ç†ï¼Œè€Œéå¹¿åº¦ï¼‰</li>
</ul>
</li>
<li><strong>è‡ªé€‚åº”ç­–ç•¥</strong>ï¼š<ul>
<li>è®­ç»ƒé˜¶æ®µï¼šå¤šä¸ª$n$çš„å­æ¨¡å‹åŒæ—¶è®­ç»ƒï¼Œæ ¹æ®éªŒè¯é›†é€‰æ‹©</li>
<li>æ¨ç†é˜¶æ®µï¼šæ ¹æ®è¾“å…¥ç±»å‹åŠ¨æ€é€‰æ‹©$n$</li>
</ul>
</li>
<li><strong>å®ç°éš¾ç‚¹</strong>ï¼šå¦‚ä½•é«˜æ•ˆå­˜å‚¨å’Œåˆ‡æ¢ä¸åŒ$n$çš„æ¨¡å‹</li>
</ol>
<p><strong>ä¼˜åŒ–æ–¹å‘</strong>ï¼š
- ç ”ç©¶å¼ºåŒ–å­¦ä¹ é€‰æ‹©Shared Expertç­–ç•¥
- å¼€å‘å¤šæ¨¡æ€MoEçš„ç»Ÿä¸€æ¡†æ¶
- æ¢ç´¢è¯¾ç¨‹å­¦ä¹ ï¼šä»ç²—ç²’åº¦åˆ°ç»†ç²’åº¦æ¸è¿›è®­ç»ƒ</p>
<p><strong>é‡åŒ–ç›®æ ‡</strong>ï¼š
- åŠ¨æ€Shared Expertä½¿å¾—å¤æ‚æ ·æœ¬æ€§èƒ½æå‡15%ï¼Œç®€å•æ ·æœ¬ä¸ä¸‹é™
- å¤šæ¨¡æ€MoEåœ¨å›¾åƒã€æ–‡æœ¬ã€éŸ³é¢‘ä»»åŠ¡ä¸Šå‡è¾¾åˆ°å•æ¨¡æ€æ°´å¹³ï¼ˆå½“å‰å·®è·5-10%ï¼‰
- è‡ªé€‚åº”Fine-Grainedï¼šä¸åŒä»»åŠ¡è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜$n$ï¼Œæ€§èƒ½å¹³å‡æå‡5%</p>
<hr />
<h4 id="4-expert"><strong>æ–¹å‘4ï¼šå¯è§£é‡Šæ€§å±‚é¢ - Expertçš„ä¸“ä¸šåŒ–åˆ†æ</strong></h4>
<p><strong>ç ”ç©¶ç©ºç™½</strong>ï¼š
- ä¸æ¸…æ¥šShared Expertåˆ°åº•å­¦åˆ°äº†ä»€ä¹ˆ
- ä¸çŸ¥é“Routed Expertå¦‚ä½•ä¸“ä¸šåŒ–ï¼ˆæ˜¯æŒ‰è¯­æ³•ï¼Ÿè¯­ä¹‰ï¼Ÿä»»åŠ¡ç±»å‹ï¼Ÿï¼‰
- ç¼ºä¹å¯è§†åŒ–å’Œåˆ†æå·¥å…·</p>
<p><strong>å…·ä½“ç ”ç©¶é—®é¢˜</strong>ï¼š</p>
<ol>
<li><strong>é—®é¢˜</strong>ï¼šShared Expertæ•è·çš„"å…±æ€§çŸ¥è¯†"æ˜¯ä»€ä¹ˆï¼Ÿ</li>
<li><strong>åˆ†ææ–¹æ³•</strong>ï¼š<ul>
<li><strong>æ¿€æ´»åˆ†æ</strong>ï¼šç»Ÿè®¡Sharedå¯¹ä¸åŒè¾“å…¥çš„æ¿€æ´»æ¨¡å¼</li>
<li><strong>æ¢¯åº¦å½’å› </strong>ï¼šè®¡ç®—Sharedå¯¹ä¸åŒtokené¢„æµ‹çš„è´¡çŒ®</li>
<li><strong>çŸ¥è¯†æ¢æµ‹</strong>ï¼šè®¾è®¡æ¢æµ‹ä»»åŠ¡ï¼ˆå¦‚è¯­æ³•ã€å¸¸è¯†ï¼‰æµ‹è¯•Sharedèƒ½åŠ›</li>
</ul>
</li>
<li><strong>å‡è®¾</strong>ï¼šSharedä¸»è¦å­¦åˆ°ï¼š<ul>
<li>è¯­æ³•è§„åˆ™ï¼ˆå¦‚ä¸»è°“ä¸€è‡´ï¼‰</li>
<li>é«˜é¢‘è¯æ±‡è¡¨ç¤º</li>
<li>é€šç”¨é€»è¾‘æ¨ç†</li>
</ul>
</li>
<li>
<p><strong>éªŒè¯</strong>ï¼šå¯¹æ¯”Sharedä¸æ•´ä¸ªæ¨¡å‹åœ¨å„é¡¹ä»»åŠ¡ä¸Šçš„æ€§èƒ½</p>
</li>
<li>
<p><strong>é—®é¢˜</strong>ï¼šRouted Expertå¦‚ä½•åˆ†åŒ–ä¸ä¸“ä¸šåŒ–ï¼Ÿ</p>
</li>
<li><strong>ç ”ç©¶æ–¹å‘</strong>ï¼š<ul>
<li><strong>èšç±»åˆ†æ</strong>ï¼šæ ¹æ®Expertè¢«æ¿€æ´»çš„æ ·æœ¬ç‰¹å¾èšç±»</li>
<li><strong>è¯­ä¹‰æ¢æµ‹</strong>ï¼šæµ‹è¯•æ¯ä¸ªExpertæ“…é•¿çš„è¯­ä¹‰é¢†åŸŸ</li>
<li><strong>å¯¹æ¯”å­¦ä¹ </strong>ï¼šåˆ†æExpertä¹‹é—´çš„å·®å¼‚æ€§</li>
</ul>
</li>
<li><strong>å¯èƒ½å‘ç°</strong>ï¼š<ul>
<li>æŸäº›Expertä¸“æ³¨äºç‰¹å®šä¸»é¢˜ï¼ˆå¦‚ç§‘æŠ€ã€æ–‡å­¦ï¼‰</li>
<li>æŸäº›Expertä¸“æ³¨äºç‰¹å®šè¯­æ³•ç»“æ„ï¼ˆå¦‚è¢«åŠ¨è¯­æ€ï¼‰</li>
<li>æŸäº›Expertä¸“æ³¨äºç‰¹å®šä»»åŠ¡ï¼ˆå¦‚ç¿»è¯‘ã€æ‘˜è¦ï¼‰</li>
</ul>
</li>
<li>
<p><strong>åº”ç”¨</strong>ï¼šæŒ‡å¯¼Expertåˆå¹¶ã€å‰ªæ</p>
</li>
<li>
<p><strong>é—®é¢˜</strong>ï¼šFine-Grainedä¸‹çš„ç»„åˆè¯­ä¹‰æ˜¯ä»€ä¹ˆï¼Ÿ</p>
</li>
<li><strong>ç°è±¡</strong>ï¼šæ¨¡å‹é€‰æ‹©Expertçš„ç»„åˆ${i_1, i_2, \ldots, i_k}$</li>
<li><strong>é—®é¢˜</strong>ï¼šè¿™ä¸ªç»„åˆä»£è¡¨ä»€ä¹ˆï¼Ÿæ˜¯å¦æœ‰è¯­ä¹‰å«ä¹‰ï¼Ÿ</li>
<li><strong>åˆ†ææ€è·¯</strong>ï¼š<ul>
<li>ç»Ÿè®¡é«˜é¢‘ç»„åˆï¼šå“ªäº›Expertç»å¸¸ä¸€èµ·è¢«é€‰ï¼Ÿ</li>
<li>è¯­ä¹‰ä¸€è‡´æ€§ï¼šåŒä¸€ç»„åˆå¤„ç†çš„æ ·æœ¬æ˜¯å¦è¯­ä¹‰ç›¸ä¼¼ï¼Ÿ</li>
<li>ç»„åˆåˆ†è§£ï¼šèƒ½å¦å°†ç»„åˆè§£é‡Šä¸º"åŸºç¡€ + ä¸“ä¸š"çš„å åŠ ï¼Ÿ</li>
</ul>
</li>
</ol>
<p><strong>ä¼˜åŒ–æ–¹å‘</strong>ï¼š
- å¼€å‘MoEå¯è§†åŒ–å·¥å…·ï¼ˆç±»ä¼¼BertViz for Attentionï¼‰
- å»ºç«‹Expert"èº«ä»½æ ‡ç­¾"æ•°æ®åº“ï¼ˆæ¯ä¸ªExpertçš„ä¸“é•¿ï¼‰
- ç ”ç©¶å¯è§£é‡Šçš„è·¯ç”±æœºåˆ¶ï¼ˆå¦‚è§„åˆ™basedè·¯ç”±ï¼‰</p>
<p><strong>é‡åŒ–ç›®æ ‡</strong>ï¼š
- ä¸ºæ¯ä¸ªExpertæ‰“ä¸Šè¯­ä¹‰æ ‡ç­¾ï¼Œå‡†ç¡®ç‡ &gt; 80%ï¼ˆäººå·¥è¯„ä¼°ï¼‰
- è¯†åˆ«å‡ºè‡³å°‘5ç§å…¸å‹çš„Expertç»„åˆæ¨¡å¼ï¼Œå¹¶è§£é‡Šå…¶è¯­ä¹‰
- Shared Expertèƒ½åŠ›æ¢æµ‹ï¼šåœ¨è¯­æ³•ä»»åŠ¡ä¸Šå‡†ç¡®ç‡ &gt; 90%ï¼Œåœ¨å¸¸è¯†ä»»åŠ¡ä¸Š &gt; 80%</p>
<hr />
<h4 id="5-"><strong>æ–¹å‘5ï¼šè´Ÿè½½å‡è¡¡çš„æ–°èŒƒå¼ - ä»å‡åŒ€åˆ°æœ€ä¼˜</strong></h4>
<p><strong>ç ”ç©¶ç©ºç™½</strong>ï¼š
- å½“å‰ç ”ç©¶éƒ½èšç„¦"å¦‚ä½•è¾¾åˆ°å‡åŒ€"ï¼Œè€Œé"æ˜¯å¦åº”è¯¥å‡åŒ€"
- ç¼ºä¹ç†è®ºæŒ‡å¯¼ä»€ä¹ˆæ ·çš„ä¸å‡åŒ€æ˜¯æœ‰ç›Šçš„
- æ²¡æœ‰è‡ªé€‚åº”è°ƒæ•´è´Ÿè½½åˆ†å¸ƒç›®æ ‡çš„æ–¹æ³•</p>
<p><strong>å…·ä½“ç ”ç©¶é—®é¢˜</strong>ï¼š</p>
<ol>
<li><strong>é—®é¢˜</strong>ï¼šèƒ½å¦å­¦ä¹ æœ€ä¼˜è´Ÿè½½åˆ†å¸ƒï¼Œè€Œéå¼ºåˆ¶å‡åŒ€ï¼Ÿ</li>
<li><strong>æ–¹æ³•1ï¼šå…ƒå­¦ä¹ æœ€ä¼˜åˆ†å¸ƒ</strong><ul>
<li>å°†è´Ÿè½½åˆ†å¸ƒ$\boldsymbol{Q} = (Q_1, \ldots, Q_n)$è§†ä¸ºè¶…å‚æ•°</li>
<li>åœ¨å¤šä¸ªä»»åŠ¡ä¸Šå…ƒå­¦ä¹ æœ€ä¼˜$\boldsymbol{Q}$</li>
<li>ä½¿ç”¨æ¢¯åº¦basedå…ƒå­¦ä¹ ï¼ˆå¦‚MAMLï¼‰</li>
</ul>
</li>
<li><strong>æ–¹æ³•2ï¼šè¿›åŒ–æœç´¢</strong><ul>
<li>åˆå§‹åŒ–å¤šä¸ª$\boldsymbol{Q}$å€™é€‰</li>
<li>è¯„ä¼°æ¯ä¸ª$\boldsymbol{Q}$çš„è®­ç»ƒæ•ˆæœ</li>
<li>é€‰æ‹©ã€å˜å¼‚ã€é‡å¤</li>
</ul>
</li>
<li>
<p><strong>æŒ‘æˆ˜</strong>ï¼šå¦‚ä½•å¹³è¡¡æ€§èƒ½ä¸å·¥ç¨‹æ•ˆç‡</p>
</li>
<li>
<p><strong>é—®é¢˜</strong>ï¼šå¦‚ä½•æ ¹æ®æ•°æ®åˆ†å¸ƒè‡ªé€‚åº”è°ƒæ•´è´Ÿè½½ç›®æ ‡ï¼Ÿ</p>
</li>
<li><strong>è§‚å¯Ÿ</strong>ï¼šä¸åŒæ•°æ®é›†æœ€ä¼˜è´Ÿè½½åˆ†å¸ƒä¸åŒ<ul>
<li>æŠ€æœ¯æ–‡æ¡£ï¼šæŸäº›ä¸“ä¸šè¯æ±‡é¢‘ç¹ï¼Œéœ€è¦ä¸“é—¨Expertï¼ˆä¸å‡åŒ€ï¼‰</li>
<li>æ—¥å¸¸å¯¹è¯ï¼šè¯æ±‡å‡åŒ€ï¼ŒExpertä¹Ÿåº”å‡åŒ€</li>
</ul>
</li>
<li>
<p><strong>è‡ªé€‚åº”ç­–ç•¥</strong>ï¼š</p>
<ul>
<li>åœ¨çº¿ä¼°è®¡æ•°æ®åˆ†å¸ƒ$p(\boldsymbol{x})$</li>
<li>æ ¹æ®$p(\boldsymbol{x})$è°ƒæ•´è´Ÿè½½ç›®æ ‡$\boldsymbol{Q}(\boldsymbol{x})$</li>
<li>åŠ¨æ€æ›´æ–°Loss-Freeçš„åç½®$\boldsymbol{b}$</li>
</ul>
</li>
<li>
<p><strong>é—®é¢˜</strong>ï¼šå¤šç›®æ ‡ä¼˜åŒ–ï¼šæ€§èƒ½ã€å‡è¡¡ã€æ•ˆç‡çš„Paretoæœ€ä¼˜ï¼Ÿ</p>
</li>
<li><strong>ä¸‰ä¸ªç›®æ ‡</strong>ï¼š<ul>
<li>æœ€å¤§åŒ–æ€§èƒ½ï¼ˆPerplexityæœ€å°ï¼‰</li>
<li>æœ€å°åŒ–è´Ÿè½½æ–¹å·®ï¼ˆCVæœ€å°ï¼Œå·¥ç¨‹å‹å¥½ï¼‰</li>
<li>æœ€å°åŒ–é€šä¿¡å¼€é”€ï¼ˆæ•ˆç‡æœ€é«˜ï¼‰</li>
</ul>
</li>
<li><strong>Paretoå‰æ²¿</strong>ï¼šæ‰¾åˆ°ä¸‰è€…çš„trade-offæ›²çº¿</li>
<li><strong>æ–¹æ³•</strong>ï¼š<ul>
<li>å¤šç›®æ ‡è¿›åŒ–ç®—æ³•ï¼ˆå¦‚NSGA-IIï¼‰</li>
<li>Paretoä¼˜åŒ–ç¥ç»ç½‘ç»œ</li>
</ul>
</li>
<li><strong>åº”ç”¨</strong>ï¼šæ ¹æ®éƒ¨ç½²åœºæ™¯é€‰æ‹©Paretoæœ€ä¼˜ç‚¹</li>
</ol>
<p><strong>ä¼˜åŒ–æ–¹å‘</strong>ï¼š
- å»ºç«‹æ•°æ®åˆ†å¸ƒåˆ°æœ€ä¼˜è´Ÿè½½åˆ†å¸ƒçš„æ˜ å°„å­¦ä¹ 
- å¼€å‘è‡ªé€‚åº”è´Ÿè½½å‡è¡¡æ¡†æ¶
- ç ”ç©¶å¤šç›®æ ‡MoEæ¶æ„æœç´¢</p>
<p><strong>é‡åŒ–ç›®æ ‡</strong>ï¼š
- å­¦ä¹ åˆ°çš„æœ€ä¼˜$\boldsymbol{Q}$ä½¿å¾—Perplexityé™ä½5%ï¼ŒåŒæ—¶CV &lt; 0.2ï¼ˆvs å‡åŒ€çš„CV=0.08ä½†Perplexityä¸å˜ï¼‰
- è‡ªé€‚åº”æ–¹æ³•åœ¨10ä¸ªä¸åŒæ•°æ®é›†ä¸Šæ€§èƒ½æå‡3-8%
- æ‰¾åˆ°è‡³å°‘5ä¸ªParetoæœ€ä¼˜é…ç½®ï¼Œè¦†ç›–ä¸åŒéƒ¨ç½²åœºæ™¯</p>
<hr />
<h4 id="_17"><strong>æ½œåœ¨åº”ç”¨åœºæ™¯</strong></h4>
<p><strong>è¯­è¨€æ¨¡å‹</strong>ï¼š
- <strong>è¶…å¤§è§„æ¨¡é¢„è®­ç»ƒ</strong>ï¼ˆä¸‡äº¿å‚æ•°ï¼‰
  - Shared Expertå¤„ç†é€šç”¨è¯­è¨€çŸ¥è¯†
  - Fine-Grained Routed Expertå¤„ç†ä¸“ä¸šé¢†åŸŸ
- <strong>å¤šè¯­è¨€æ¨¡å‹</strong>
  - è¯­è¨€ç‰¹å®šShared Expertï¼ˆå¦‚ä¸­æ–‡Sharedã€è‹±æ–‡Sharedï¼‰
  - è·¨è¯­è¨€Shared Expertï¼ˆå¦‚è¯­æ³•é€šç”¨è§„åˆ™ï¼‰
- <strong>é¢†åŸŸé€‚åº”</strong>
  - é¢„è®­ç»ƒé˜¶æ®µï¼šç²—ç²’åº¦é€šç”¨Expert
  - å¾®è°ƒé˜¶æ®µï¼šç»†ç²’åº¦é¢†åŸŸExpert</p>
<p><strong>å¤šæ¨¡æ€æ¨¡å‹</strong>ï¼š
- <strong>è§†è§‰-è¯­è¨€æ¨¡å‹</strong>ï¼ˆå¦‚GPT-4Vï¼‰
  - è§†è§‰Shared Expertï¼šå¤„ç†åŸºç¡€è§†è§‰ç‰¹å¾
  - è¯­è¨€Shared Expertï¼šå¤„ç†åŸºç¡€è¯­è¨€ç‰¹å¾
  - è·¨æ¨¡æ€Shared Expertï¼šå¤„ç†å›¾æ–‡å¯¹é½
- <strong>è¯­éŸ³-æ–‡æœ¬æ¨¡å‹</strong>
  - è¯­éŸ³ç‰¹å®šExpertï¼ˆéŸ³ç´ ã€éŸµå¾‹ï¼‰
  - æ–‡æœ¬ç‰¹å®šExpertï¼ˆè¯­ä¹‰ã€è¯­æ³•ï¼‰
  - èåˆShared Expert</p>
<p><strong>ç§‘å­¦è®¡ç®—</strong>ï¼š
- <strong>è›‹ç™½è´¨æŠ˜å é¢„æµ‹</strong>
  - Shared Expertï¼šæ°¨åŸºé…¸åŸºç¡€æ€§è´¨
  - Routed Expertï¼šä¸åŒè›‹ç™½è´¨å®¶æ—çš„ç‰¹å¼‚æ€§æŠ˜å æ¨¡å¼
- <strong>æ°”å€™æ¨¡æ‹Ÿ</strong>
  - Shared Expertï¼šå…¨çƒæ°”å€™æ¨¡å¼
  - Routed Expertï¼šåœ°åŒºç‰¹å¼‚æ€§æ°”å€™ç‰¹å¾</p>
<p><strong>æ¨èç³»ç»Ÿ</strong>ï¼š
- <strong>ä¸ªæ€§åŒ–æ¨è</strong>
  - Shared Expertï¼šé€šç”¨ç”¨æˆ·åå¥½
  - Routed Expertï¼šä¸ªæ€§åŒ–å£å‘³
  - Fine-Grainedï¼šç»†åˆ†å…´è¶£é¢†åŸŸ</p>
<hr />
<h3 id="_18">æ€»ç»“</h3>
<p>æœ¬æ–‡ä»"å‡åŒ€åˆ†å¸ƒæ˜¯å¦æœ€ä¼˜"è¿™ä¸€æ ¹æœ¬é—®é¢˜å‡ºå‘ï¼Œæ·±å…¥æ¢è®¨äº†MoEçš„éå‡åŒ€æ€§è®¾è®¡ï¼š</p>
<p><strong>æ ¸å¿ƒæ´å¯Ÿ</strong>ï¼š
1. <strong>ç°å®ä¸–ç•Œæœ¬è´¨éå‡åŒ€</strong>ï¼šZipfå®šå¾‹ã€é•¿å°¾åˆ†å¸ƒæ™®éå­˜åœ¨
2. <strong>Shared Expertçš„ä»·å€¼</strong>ï¼šåˆ†ç¦»å…±æ€§ä¸ä¸ªæ€§ï¼Œæå‡å‚æ•°æ•ˆç‡
3. <strong>Fine-Grainedçš„ä¼˜åŠ¿</strong>ï¼šç»„åˆå¤šæ ·æ€§æŒ‡æ•°å¢é•¿ï¼Œæ›´çµæ´»é€‚åº”
4. <strong>å·¥ç¨‹ä¸æ€§èƒ½å¹³è¡¡</strong>ï¼šRouted Expertä»éœ€å‡è¡¡ï¼ˆå·¥ç¨‹å‹å¥½ï¼‰ï¼Œä½†æ•´ä½“å…è®¸éå‡åŒ€</p>
<p><strong>æœªæ¥æ–¹å‘</strong>ï¼š
- <strong>ç†è®º</strong>ï¼šåˆ»ç”»æœ€ä¼˜éå‡åŒ€åˆ†å¸ƒ
- <strong>æ•ˆç‡</strong>ï¼šæ”¯æŒè¶…å¤§è§„æ¨¡$n$
- <strong>åº”ç”¨</strong>ï¼šåŠ¨æ€ã€è‡ªé€‚åº”ã€å¤šæ¨¡æ€MoE
- <strong>å¯è§£é‡Šæ€§</strong>ï¼šç†è§£Expertä¸“ä¸šåŒ–æœºåˆ¶
- <strong>æ–°èŒƒå¼</strong>ï¼šä»å¼ºåˆ¶å‡åŒ€åˆ°å­¦ä¹ æœ€ä¼˜åˆ†å¸ƒ</p>
<p><strong>å…³é”®å…¬å¼å›é¡¾</strong>ï¼š
- Shared Expertï¼š$\boldsymbol{y} = \sum_{i=1}^s \boldsymbol{e}<em _in="\in" _text_argtop="\text{argtop" i="i">i + \lambda\sum</em>_i$
- æ¯”ä¾‹å› å­ï¼š$\lambda = \sqrt{s} / \mathbb{E}[\sqrt{\sum \rho_i^2}]$
- éå‡åŒ€åˆ†å¸ƒï¼š$F_i = 1$ (Shared), $F_j = (k-s)/(n-s)$ (Routed)
- Fine-Grainedä¼˜åŠ¿ï¼š$\binom{2n}{2k} / \binom{n}{k} \approx e^{nH(k/n)}$ï¼ˆæŒ‡æ•°å¢é•¿ï¼‰}_{k-s}} \rho_i \boldsymbol{e</p>
<p><strong>æœ€é‡è¦çš„å¯ç¤º</strong>ï¼š
- ä¸è¦ç›²ç›®è¿½æ±‚å‡åŒ€ï¼Œè¦é—®"ä¸ºä»€ä¹ˆå‡åŒ€"ï¼Ÿ
- å·¥ç¨‹çº¦æŸï¼ˆå‡åŒ€ä¾¿äºå¹¶è¡Œï¼‰â‰  æ€§èƒ½æœ€ä¼˜ï¼ˆæ•°æ®å¤©ç„¶ä¸å‡åŒ€ï¼‰
- Shared + Fine-Grainedæä¾›äº†ä¸€ä¸ªä¼˜é›…çš„æŠ˜è¡·æ–¹æ¡ˆ</p>
        </div>
    </div>
</body>
</html>