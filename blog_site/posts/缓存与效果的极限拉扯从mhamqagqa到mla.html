<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¼“å­˜ä¸æ•ˆæœçš„æé™æ‹‰æ‰¯ï¼šä»MHAã€MQAã€GQAåˆ°MLA</title>
    <style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    line-height: 1.6; color: #333; max-width: 900px; margin: 0 auto; padding: 20px; background: #f5f5f5;
}
.container { background: white; padding: 40px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
header { border-bottom: 2px solid #e0e0e0; padding-bottom: 20px; margin-bottom: 30px; }
h1 { color: #2c3e50; margin-bottom: 10px; font-size: 2em; }
.meta { color: #666; font-size: 0.9em; margin-bottom: 20px; }
.content { margin-top: 30px; overflow-wrap: break-word; }
.content h2 { color: #34495e; margin-top: 30px; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
.content p { margin-bottom: 15px; }
.content pre { background: #f8f8f8; padding: 15px; border-radius: 5px; overflow-x: auto; border-left: 3px solid #3498db; margin: 15px 0; }
.content code { background: #f8f8f8; padding: 2px 5px; border-radius: 3px; font-family: monospace; font-size: 0.9em; }
.content blockquote { border-left: 4px solid #3498db; padding-left: 20px; margin: 20px 0; color: #555; font-style: italic; }
.content table { border-collapse: collapse; width: 100%; margin: 20px 0; }
.content th, .content td { border: 1px solid #ddd; padding: 10px; text-align: left; }
.back-link { display: inline-block; margin-bottom: 20px; color: #3498db; text-decoration: none; font-weight: 500; }
</style>
    
<script>
    window.MathJax = {
        tex: {
            inlineMath: [['$', '$'], ['\(', '\)']],
            displayMath: [['$$', '$$'], ['\[', '\]']],
            processEscapes: true
        }
    };
</script>
<script id="MathJax-script" async src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>

</head>
<body>
    <div class="container">
        <a href="../index.html" class="back-link">â† è¿”å›é¦–é¡µ</a>
        <header>
            <h1>ç¼“å­˜ä¸æ•ˆæœçš„æé™æ‹‰æ‰¯ï¼šä»MHAã€MQAã€GQAåˆ°MLA</h1>
            <div class="meta">ğŸ“… æœ€åæ›´æ–°: 2025-11-26 | ğŸ“„ å¤§å°: 51.3 KB</div>
        </header>
        <div class="content">
            <p><strong>åŸæ–‡é“¾æ¥</strong>: <a href="https://spaces.ac.cn/archives/10091">https://spaces.ac.cn/archives/10091</a></p>
<p><strong>å‘å¸ƒæ—¥æœŸ</strong>: </p>
<hr />
<p>å‰å‡ å¤©ï¼Œå¹»æ–¹å‘å¸ƒçš„<a href="https://papers.cool/arxiv/2405.04434">DeepSeek-V2</a>å¼•èµ·äº†å¤§å®¶çš„çƒ­çƒˆè®¨è®ºã€‚é¦–å…ˆï¼Œæœ€è®©äººå“—ç„¶çš„æ˜¯1å—é’±100ä¸‡tokençš„ä»·æ ¼ï¼Œæ™®éæ¯”ç°æœ‰çš„å„ç§ç«å“APIä¾¿å®œäº†ä¸¤ä¸ªæ•°é‡çº§ï¼Œä»¥è‡³äºæœ‰äººè°ƒä¾ƒâ€œè¿™ä¸ªä»·æ ¼å“ªæ€•å®ƒè¾“å‡ºä¹±ç ï¼Œæˆ‘ä¹Ÿä¼šè®¤ä¸ºè¿™ä¸ªä¹±ç æ˜¯ä¸€ç§è‰ºæœ¯â€ï¼›å…¶æ¬¡ï¼Œä»æ¨¡å‹çš„æŠ€æœ¯æŠ¥å‘Šçœ‹ï¼Œå¦‚æ­¤ä¾¿å®œçš„ä»·æ ¼èƒŒåçš„å…³é”®æŠ€æœ¯ä¹‹ä¸€æ˜¯å®ƒæ–°æå‡ºçš„MLAï¼ˆ<strong>M</strong> ulti-head <strong>L</strong> atent <strong>A</strong> ttentionï¼‰ï¼Œè¿™æ˜¯å¯¹GQAçš„æ”¹è¿›ï¼Œæ®è¯´èƒ½æ¯”GQAæ›´çœæ›´å¥½ï¼Œä¹Ÿå¼•èµ·äº†è¯»è€…çš„å¹¿æ³›å…³æ³¨ã€‚</p>
<p>æ¥ä¸‹æ¥ï¼Œæœ¬æ–‡å°†è·Ÿå¤§å®¶ä¸€èµ·æ¢³ç†ä¸€ä¸‹ä»MHAã€MQAã€GQAåˆ°MLAçš„æ¼”å˜å†ç¨‹ï¼Œå¹¶ç€é‡ä»‹ç»ä¸€ä¸‹MLAçš„è®¾è®¡æ€è·¯ã€‚</p>
<h2 id="mha">MHA</h2>
<p>MHAï¼ˆ<strong>M</strong> ulti-<strong>H</strong> ead <strong>A</strong> ttentionï¼‰ï¼Œä¹Ÿå°±æ˜¯å¤šå¤´æ³¨æ„åŠ›ï¼Œæ˜¯å¼€å±±ä¹‹ä½œ<a href="/archives/4765">ã€ŠAttention is all you needã€‹</a>æ‰€æå‡ºçš„ä¸€ç§Attentionå½¢å¼ï¼Œå¯ä»¥è¯´å®ƒæ˜¯å½“å‰ä¸»æµLLMçš„åŸºç¡€å·¥ä½œã€‚åœ¨æ•°å­¦ä¸Šï¼Œå¤šå¤´æ³¨æ„åŠ›MHAç­‰ä»·äºå¤šä¸ªç‹¬ç«‹çš„å•å¤´æ³¨æ„åŠ›çš„æ‹¼æ¥ï¼Œå‡è®¾è¾“å…¥çš„ï¼ˆè¡Œï¼‰å‘é‡åºåˆ—ä¸º$\boldsymbol{x}<em _leq="\leq" t="t">1,\boldsymbol{x}_2,\cdots,\boldsymbol{x}_l$ï¼Œå…¶ä¸­$\boldsymbol{x}_i\in\mathbb{R}^d$ï¼Œé‚£ä¹ˆMHAå¯ä»¥å½¢å¼åœ°è®°ä¸º<br />
\begin{equation}<br />
\begin{gathered}<br />
\boldsymbol{o}_t = \left[\boldsymbol{o}_t^{(1)}, \boldsymbol{o}_t^{(2)}, \cdots, \boldsymbol{o}_t^{(h)}\right] \\\[10pt]<br />
\boldsymbol{o}_t^{(s)} = Attention\left(\boldsymbol{q}_t^{(s)}, \boldsymbol{k}</em>}^{(s)} ,\boldsymbol{v<em i_leq="i\leq" t="t">{\leq t}^{(s)}\right)\triangleq\frac{\sum</em>}\exp\left(\boldsymbol{q<em i_leq="i\leq" t="t">t^{(s)} \boldsymbol{k}_i^{(s)}{}^{\top}\right)\boldsymbol{v}_i^{(s)}}{\sum</em> \\\[15pt]}\exp\left(\boldsymbol{q}_t^{(s)} \boldsymbol{k}_i^{(s)}{}^{\top}\right)<br />
\boldsymbol{q}_i^{(s)} = \boldsymbol{x}_i\boldsymbol{W}_q^{(s)}\in\mathbb{R}^{d_k},\quad \boldsymbol{W}_q^{(s)}\in\mathbb{R}^{d\times d_k}\\\<br />
\boldsymbol{k}_i^{(s)} = \boldsymbol{x}_i\boldsymbol{W}_k^{(s)}\in\mathbb{R}^{d_k},\quad \boldsymbol{W}_k^{(s)}\in\mathbb{R}^{d\times d_k} \\\<br />
\boldsymbol{v}_i^{(s)} = \boldsymbol{x}_i\boldsymbol{W}_v^{(s)}\in\mathbb{R}^{d_v},\quad \boldsymbol{W}_v^{(s)}\in\mathbb{R}^{d\times d_v}<br />
\end{gathered}<br />
\end{equation}<br />
ç®€å•èµ·è§ï¼Œè¿™é‡Œçœç•¥äº†AttentionçŸ©é˜µçš„ç¼©æ”¾å› å­ã€‚å®è·µä¸Šï¼Œå¸¸è§çš„è®¾ç½®æ˜¯$d_k = d_v = d / h$ï¼Œå¯¹äºLLAMA2-7bæœ‰$d=4096, h=32, d_k = d_v = 128$ï¼ŒLLAMA2-70båˆ™æ˜¯$d=8192,h=64, d_k = d_v = 128$</p>
<p>ç”±äºè¿™é‡Œåªè€ƒè™‘äº†ä¸»æµçš„è‡ªå›å½’LLMæ‰€ç”¨çš„Causal Attentionï¼Œå› æ­¤åœ¨token by tokené€’å½’ç”Ÿæˆæ—¶ï¼Œæ–°é¢„æµ‹å‡ºæ¥çš„ç¬¬$t+1$ä¸ªtokenï¼Œå¹¶ä¸ä¼šå½±å“åˆ°å·²ç»ç®—å¥½çš„$\boldsymbol{k}<em _leq="\leq" t="t">{\leq t}^{(s)} ,\boldsymbol{v}</em>$ï¼Œå› æ­¤è¿™éƒ¨åˆ†ç»“æœæˆ‘ä»¬å¯ä»¥ç¼“å­˜ä¸‹æ¥ä¾›åç»­ç”Ÿæˆè°ƒç”¨ï¼Œé¿å…ä¸å¿…è¦çš„é‡å¤è®¡ç®—ï¼Œè¿™å°±æ˜¯æ‰€è°“çš„KV Cacheã€‚}^{(s)</p>
<p>è€Œåé¢çš„MQAã€GQAã€MLAï¼Œéƒ½æ˜¯å›´ç»•â€œå¦‚ä½•å‡å°‘KV CacheåŒæ—¶å°½å¯èƒ½åœ°ä¿è¯æ•ˆæœâ€è¿™ä¸ªä¸»é¢˜å‘å±•è€Œæ¥çš„äº§ç‰©ã€‚</p>
<h2 id="_1">ç“¶é¢ˆ</h2>
<p>ä¸€ä¸ªè‡ªç„¶çš„é—®é¢˜æ˜¯ï¼šä¸ºä»€ä¹ˆé™ä½KV Cacheçš„å¤§å°å¦‚æ­¤é‡è¦ï¼Ÿ</p>
<p>ä¼—æ‰€å‘¨çŸ¥ï¼Œä¸€èˆ¬æƒ…å†µä¸‹LLMçš„æ¨ç†éƒ½æ˜¯åœ¨GPUä¸Šè¿›è¡Œï¼Œå•å¼ GPUçš„æ˜¾å­˜æ˜¯æœ‰é™çš„ï¼Œä¸€éƒ¨åˆ†æˆ‘ä»¬è¦ç”¨æ¥å­˜æ”¾æ¨¡å‹çš„å‚æ•°å’Œå‰å‘è®¡ç®—çš„æ¿€æ´»å€¼ï¼Œè¿™éƒ¨åˆ†ä¾èµ–äºæ¨¡å‹çš„ä½“é‡ï¼Œé€‰å®šæ¨¡å‹åå®ƒå°±æ˜¯ä¸ªå¸¸æ•°ï¼›å¦å¤–ä¸€éƒ¨åˆ†æˆ‘ä»¬è¦ç”¨æ¥å­˜æ”¾æ¨¡å‹çš„KV Cacheï¼Œè¿™éƒ¨åˆ†ä¸ä»…ä¾èµ–äºæ¨¡å‹çš„ä½“é‡ï¼Œè¿˜ä¾èµ–äºæ¨¡å‹çš„è¾“å…¥é•¿åº¦ï¼Œä¹Ÿå°±æ˜¯åœ¨æ¨ç†è¿‡ç¨‹ä¸­æ˜¯åŠ¨æ€å¢é•¿çš„ï¼Œå½“Contexté•¿åº¦è¶³å¤Ÿé•¿æ—¶ï¼Œå®ƒçš„å¤§å°å°±ä¼šå ä¸»å¯¼åœ°ä½ï¼Œå¯èƒ½è¶…å‡ºä¸€å¼ å¡ç”šè‡³ä¸€å°æœºï¼ˆ8å¼ å¡ï¼‰çš„æ€»æ˜¾å­˜é‡ã€‚</p>
<p>åœ¨GPUä¸Šéƒ¨ç½²æ¨¡å‹çš„åŸåˆ™æ˜¯ï¼šèƒ½ä¸€å¼ å¡éƒ¨ç½²çš„ï¼Œå°±ä¸è¦è·¨å¤šå¼ å¡ï¼›èƒ½ä¸€å°æœºéƒ¨ç½²çš„ï¼Œå°±ä¸è¦è·¨å¤šå°æœºã€‚è¿™æ˜¯å› ä¸ºâ€œå¡å†…é€šä¿¡å¸¦å®½ &gt; å¡é—´é€šä¿¡å¸¦å®½ &gt; æœºé—´é€šä¿¡å¸¦å®½â€ï¼Œç”±äºâ€œæœ¨æ¡¶æ•ˆåº”â€ï¼Œæ¨¡å‹éƒ¨ç½²æ—¶è·¨çš„è®¾å¤‡è¶Šå¤šï¼Œå—è®¾å¤‡é—´é€šä¿¡å¸¦å®½çš„çš„â€œæ‹–ç´¯â€å°±è¶Šå¤§ï¼Œäº‹å®ä¸Šå³ä¾¿æ˜¯å•å¡H100å†…SRAMä¸HBMçš„å¸¦å®½å·²ç»è¾¾åˆ°äº†3TB/sï¼Œä½†å¯¹äºShort Contextæ¥è¯´è¿™ä¸ªé€Ÿåº¦ä¾ç„¶è¿˜æ˜¯æ¨ç†çš„ç“¶é¢ˆï¼Œæ›´ä¸ç”¨è¯´æ›´æ…¢çš„å¡é—´ã€æœºé—´é€šä¿¡äº†ã€‚</p>
<p>æ‰€ä»¥ï¼Œå‡å°‘KV Cacheçš„ç›®çš„å°±æ˜¯è¦å®ç°åœ¨æ›´å°‘çš„è®¾å¤‡ä¸Šæ¨ç†æ›´é•¿çš„Contextï¼Œæˆ–è€…åœ¨ç›¸åŒçš„Contexté•¿åº¦ä¸‹è®©æ¨ç†çš„batch sizeæ›´å¤§ï¼Œä»è€Œå®ç°æ›´å¿«çš„æ¨ç†é€Ÿåº¦æˆ–è€…æ›´å¤§çš„ååæ€»é‡ã€‚å½“ç„¶ï¼Œæœ€ç»ˆç›®çš„éƒ½æ˜¯ä¸ºäº†å®ç°æ›´ä½çš„æ¨ç†æˆæœ¬ã€‚</p>
<p>è¦æƒ³æ›´è¯¦ç»†åœ°äº†è§£è¿™ä¸ªé—®é¢˜ï¼Œè¯»è€…å¯ä»¥è¿›ä¸€æ­¥é˜…è¯»<a href="https://papers.cool/arxiv/2205.14135">ã€ŠFlashAttention: Fast and Memory-Efficient Exact Attention with IO-Awarenessã€‹</a>ã€<a href="https://www.baseten.co/blog/llm-transformer-inference-guide/">ã€ŠA guide to LLM inference and performanceã€‹</a>ã€<a href="https://zeux.io/2024/03/15/llm-inference-sol/">ã€ŠLLM inference speed of lightã€‹</a>ç­‰æ–‡ç« ï¼Œè¿™é‡Œå°±ä¸ç»§ç»­å±•å¼€äº†ï¼ˆä¸»è¦æ˜¯ç¬”è€…æ°´å¹³ä¹Ÿæœ‰é™ï¼Œå”¯æè¯´å¤šé”™å¤šï¼‰ã€‚</p>
<h2 id="mqa">MQA</h2>
<p>MQAï¼Œå³â€œ<strong>M</strong> ulti-<strong>Q</strong> uery <strong>A</strong> ttentionâ€ï¼Œæ˜¯å‡å°‘KV Cacheçš„ä¸€æ¬¡éå¸¸æœ´ç´ çš„å°è¯•ï¼Œé¦–æ¬¡æå‡ºè‡ª<a href="https://papers.cool/arxiv/1911.02150">ã€ŠFast Transformer Decoding: One Write-Head is All You Needã€‹</a>ï¼Œè¿™å·²ç»æ˜¯2019å¹´çš„è®ºæ–‡äº†ï¼Œè¿™ä¹Ÿæ„å‘³ç€æ—©åœ¨LLMç«çƒ­ä¹‹å‰ï¼Œå‡å°‘KV Cacheå°±å·²ç»æ˜¯ç ”ç©¶äººå‘˜éå¸¸å…³æ³¨çš„ä¸€ä¸ªè¯¾é¢˜äº†ã€‚</p>
<p>MQAçš„æ€è·¯å¾ˆç®€å•ï¼Œç›´æ¥è®©æ‰€æœ‰Attention Headå…±äº«åŒä¸€ä¸ªKã€Vï¼Œç”¨å…¬å¼æ¥è¯´ï¼Œå°±æ˜¯å–æ¶ˆMHAæ‰€æœ‰çš„$\boldsymbol{k},\boldsymbol{v}$çš„ä¸Šæ ‡${}^{(s)}$ï¼š<br />
\begin{equation}\require{cancel}<br />
\begin{gathered}<br />
\boldsymbol{o}<em _leq="\leq" t="t">t = \left[\boldsymbol{o}_t^{(1)}, \boldsymbol{o}_t^{(2)}, \cdots, \boldsymbol{o}_t^{(h)}\right] \\\[10pt]<br />
\boldsymbol{o}_t^{(s)} = Attention\left(\boldsymbol{q}_t^{(s)}, \boldsymbol{k}</em>}^{\color{#ccc}{\smash{\bcancel{(s)}}}} ,\boldsymbol{v<em i_leq="i\leq" t="t">{\leq t}^{\color{#ccc}{\smash{\bcancel{(s)}}}}\right)\triangleq\frac{\sum</em>}\exp\left(\boldsymbol{q<em i_leq="i\leq" t="t">t^{(s)} \boldsymbol{k}_i^{\color{#ccc}{\smash{\bcancel{(s)}}}}{}^{\top}\right)\boldsymbol{v}_i^{\color{#ccc}{\smash{\bcancel{(s)}}}}}{\sum</em> \\\[15pt]}\exp\left(\boldsymbol{q}_t^{(s)} \boldsymbol{k}_i^{\color{#ccc}{\smash{\bcancel{(s)}}}}{}^{\top}\right)<br />
\boldsymbol{q}_i^{(s)} = \boldsymbol{x}_i\boldsymbol{W}_q^{(s)}\in\mathbb{R}^{d_k},\quad \boldsymbol{W}_q^{(s)}\in\mathbb{R}^{d\times d_k}\\\<br />
\boldsymbol{k}_i^{\color{#ccc}{\smash{\bcancel{(s)}}}} = \boldsymbol{x}_i\boldsymbol{W}_k^{\color{#ccc}{\smash{\bcancel{(s)}}}}\in\mathbb{R}^{d_k},\quad \boldsymbol{W}_k^{\color{#ccc}{\smash{\bcancel{(s)}}}}\in\mathbb{R}^{d\times d_k} \\\<br />
\boldsymbol{v}_i^{\color{#ccc}{\smash{\bcancel{(s)}}}} = \boldsymbol{x}_i\boldsymbol{W}_v^{\color{#ccc}{\smash{\bcancel{(s)}}}}\in\mathbb{R}^{d_v},\quad \boldsymbol{W}_v^{\color{#ccc}{\smash{\bcancel{(s)}}}}\in\mathbb{R}^{d\times d_v}<br />
\end{gathered}<br />
\end{equation}<br />
ä½¿ç”¨MQAçš„æ¨¡å‹åŒ…æ‹¬<a href="https://arxiv.org/pdf/2204.02311">PaLM</a>ã€<a href="https://papers.cool/arxiv/2305.06161">StarCoder</a>ã€<a href="https://papers.cool/arxiv/2312.11805">Gemini</a>ç­‰ã€‚å¾ˆæ˜æ˜¾ï¼ŒMQAç›´æ¥å°†KV Cacheå‡å°‘åˆ°äº†åŸæ¥çš„$1/h$ï¼Œè¿™æ˜¯éå¸¸å¯è§‚çš„ï¼Œå•ä»èŠ‚çœæ˜¾å­˜è§’åº¦çœ‹å·²ç»æ˜¯å¤©èŠ±æ¿äº†ã€‚</p>
<p>æ•ˆæœæ–¹é¢ï¼Œç›®å‰çœ‹æ¥å¤§éƒ¨åˆ†ä»»åŠ¡çš„æŸå¤±éƒ½æ¯”è¾ƒæœ‰é™ï¼Œä¸”MQAçš„æ”¯æŒè€…ç›¸ä¿¡è¿™éƒ¨åˆ†æŸå¤±å¯ä»¥é€šè¿‡è¿›ä¸€æ­¥è®­ç»ƒæ¥å¼¥è¡¥å›ã€‚æ­¤å¤–ï¼Œæ³¨æ„åˆ°MQAç”±äºå…±äº«äº†Kã€Vï¼Œå°†ä¼šå¯¼è‡´Attentionçš„å‚æ•°é‡å‡å°‘äº†å°†è¿‘ä¸€åŠï¼Œè€Œä¸ºäº†æ¨¡å‹æ€»å‚æ•°é‡çš„ä¸å˜ï¼Œé€šå¸¸ä¼šç›¸åº”åœ°å¢å¤§FFN/GLUçš„è§„æ¨¡ï¼Œè¿™ä¹Ÿèƒ½å¼¥è¡¥ä¸€éƒ¨åˆ†æ•ˆæœæŸå¤±ã€‚</p>
<h2 id="gqa">GQA</h2>
<p>ç„¶è€Œï¼Œä¹Ÿæœ‰äººæ‹…å¿ƒMQAå¯¹KV Cacheçš„å‹ç¼©å¤ªä¸¥é‡ï¼Œä»¥è‡³äºä¼šå½±å“æ¨¡å‹çš„å­¦ä¹ æ•ˆç‡ä»¥åŠæœ€ç»ˆæ•ˆæœã€‚ä¸ºæ­¤ï¼Œä¸€ä¸ªMHAä¸MQAä¹‹é—´çš„è¿‡æ¸¡ç‰ˆæœ¬GQAï¼ˆ<strong>G</strong> rouped-<strong>Q</strong> uery <strong>A</strong> ttentionï¼‰åº”è¿è€Œç”Ÿï¼Œå‡ºè‡ªè®ºæ–‡<a href="https://papers.cool/arxiv/2305.13245">ã€ŠGQA: Training Generalized Multi-Query Transformer Models from Multi-Head Checkpointsã€‹</a>ï¼Œæ˜¯å»å¹´çš„å·¥ä½œã€‚</p>
<p>äº‹åçœ‹æ¥ï¼ŒGQAçš„æ€æƒ³ä¹Ÿå¾ˆæœ´ç´ ï¼Œå®ƒå°±æ˜¯å°†æ‰€æœ‰Headåˆ†ä¸º$g$ä¸ªç»„ï¼ˆ$g$å¯ä»¥æ•´é™¤$h$ï¼‰ï¼Œæ¯ç»„å…±äº«åŒä¸€å¯¹Kã€Vï¼Œç”¨æ•°å­¦å…¬å¼è¡¨ç¤ºä¸º<br />
\begin{equation}<br />
\begin{gathered}<br />
\boldsymbol{o}<em _leq="\leq" t="t">t = \left[\boldsymbol{o}_t^{(1)}, \boldsymbol{o}_t^{(2)}, \cdots, \boldsymbol{o}_t^{(h)}\right] \\\[10pt]<br />
\boldsymbol{o}_t^{(s)} = Attention\left(\boldsymbol{q}_t^{(s)}, \boldsymbol{k}</em>}^{\color{red}{(\lceil sg/h\rceil)}} ,\boldsymbol{v<em i_leq="i\leq" t="t">{\leq t}^{\color{red}{(\lceil sg/h\rceil)}}\right)\triangleq\frac{\sum</em>}\exp\left(\boldsymbol{q<em i_leq="i\leq" t="t">t^{(s)} \boldsymbol{k}_i^{\color{red}{(\lceil sg/h\rceil)}}{}^{\top}\right)\boldsymbol{v}_i^{\color{red}{(\lceil sg/h\rceil)}}}{\sum</em> \\\[15pt]}\exp\left(\boldsymbol{q}_t^{(s)} \boldsymbol{k}_i^{\color{red}{(\lceil sg/h\rceil)}}{}^{\top}\right)<br />
\boldsymbol{q}_i^{(s)} = \boldsymbol{x}_i\boldsymbol{W}_q^{(s)}\in\mathbb{R}^{d_k},\quad \boldsymbol{W}_q^{(s)}\in\mathbb{R}^{d\times d_k}\\\<br />
\boldsymbol{k}_i^{\color{red}{(\lceil sg/h\rceil)}} = \boldsymbol{x}_i\boldsymbol{W}_k^{\color{red}{(\lceil sg/h\rceil)}}\in\mathbb{R}^{d_k},\quad \boldsymbol{W}_k^{\color{red}{(\lceil sg/h\rceil)}}\in\mathbb{R}^{d\times d_k} \\\<br />
\boldsymbol{v}_i^{\color{red}{(\lceil sg/h\rceil)}} = \boldsymbol{x}_i\boldsymbol{W}_v^{\color{red}{(\lceil sg/h\rceil)}}\in\mathbb{R}^{d_v},\quad \boldsymbol{W}_v^{\color{red}{(\lceil sg/h\rceil)}}\in\mathbb{R}^{d\times d_v}<br />
\end{gathered}<br />
\end{equation}<br />
è¿™é‡Œçš„$\lceil\cdot\rceil$æ˜¯ä¸Šå–æ•´ç¬¦å·ã€‚GQAæä¾›äº†MHAåˆ°MQAçš„è‡ªç„¶è¿‡æ¸¡ï¼Œå½“$g=h$æ—¶å°±æ˜¯MHAï¼Œ$g=1$æ—¶å°±æ˜¯MQAï¼Œå½“$1 &lt; g &lt; h$æ—¶ï¼Œå®ƒåªå°†KV Cacheå‹ç¼©åˆ°$g/h$ï¼Œå‹ç¼©ç‡ä¸å¦‚MQAï¼Œä½†åŒæ—¶ä¹Ÿæä¾›äº†æ›´å¤§çš„è‡ªç”±åº¦ï¼Œæ•ˆæœä¸Šæ›´æœ‰ä¿è¯ã€‚GQAæœ€çŸ¥åçš„ä½¿ç”¨è€…ï¼Œå¤§æ¦‚æ˜¯Metaå¼€æºçš„<a href="https://llama.meta.com/llama2/">LLAMA2-70B</a>ï¼Œä»¥åŠ<a href="https://llama.meta.com/llama3/">LLAMA3</a>å…¨ç³»åˆ—ï¼Œæ­¤å¤–ä½¿ç”¨GQAçš„æ¨¡å‹è¿˜æœ‰<a href="https://papers.cool/arxiv/2312.08688">TigerBot</a>ã€<a href="https://papers.cool/arxiv/2401.02954">DeepSeek-V1</a>ã€<a href="https://papers.cool/arxiv/2402.19173">StarCoder2</a>ã€<a href="https://papers.cool/arxiv/2403.04652">Yi</a>ã€<a href="https://github.com/THUDM/ChatGLM2-6B">ChatGLM2</a>ã€<a href="https://github.com/THUDM/ChatGLM3">ChatGLM3</a>ç­‰ï¼Œç›¸æ¯”ä½¿ç”¨MQAçš„æ¨¡å‹æ›´å¤šï¼ˆChatGLMè™½ç„¶åœ¨å®ƒçš„ä»‹ç»ä¸­è¯´è‡ªå·±æ˜¯MQAï¼Œä½†å®é™…æ˜¯$g=2$çš„GQAï¼‰ã€‚</p>
<p>åœ¨llama2/3-70Bä¸­ï¼ŒGQAçš„$g=8$ï¼Œå…¶ä»–ç”¨äº†GQAçš„åŒä½“é‡æ¨¡å‹åŸºæœ¬ä¸Šä¹Ÿä¿æŒäº†è¿™ä¸ªè®¾ç½®ï¼Œè¿™å¹¶éå¶ç„¶ï¼Œè€Œæ˜¯åŒæ ·å‡ºäºæ¨ç†æ•ˆç‡çš„è€ƒè™‘ã€‚æˆ‘ä»¬çŸ¥é“ï¼Œ70Bè¿™ä¸ªä½“é‡çš„æ¨¡å‹ï¼Œå¦‚æœä¸è¿›è¡Œæç«¯çš„é‡åŒ–ï¼Œé‚£ä¹ˆä¸å¯èƒ½éƒ¨ç½²åˆ°å•å¡ï¼ˆA100/H100 80Gï¼‰ä¸Šã€‚å•å¡ä¸è¡Œï¼Œé‚£ä¹ˆå°±èƒ½å•æœºäº†ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ä¸€å°æœºå¯ä»¥è£…8å¼ å¡ï¼Œåˆšæ‰æˆ‘ä»¬è¯´äº†ï¼ŒAttentionçš„æ¯ä¸ªHeadå®é™…ä¸Šæ˜¯ç‹¬ç«‹è¿ç®—ç„¶åæ‹¼æ¥èµ·æ¥çš„ï¼Œå½“$g=8$æ—¶ï¼Œæ­£å¥½å¯ä»¥æ¯å¼ å¡è´Ÿè´£è®¡ç®—ä¸€ç»„Kã€Vå¯¹åº”çš„Attention Headï¼Œè¿™æ ·å¯ä»¥åœ¨å°½å¯èƒ½ä¿è¯Kã€Vå¤šæ ·æ€§çš„åŒæ—¶æœ€å¤§ç¨‹åº¦ä¸Šå‡å°‘å¡é—´é€šä¿¡ã€‚</p>
<h2 id="mla">MLA</h2>
<p>æœ‰äº†MHAã€MQAã€GQAçš„é“ºå«ï¼Œæˆ‘ä»¬ç†è§£MLAï¼ˆ<strong>M</strong> ulti-head <strong>L</strong> atent <strong>A</strong> ttentionï¼‰å°±ç›¸å¯¹å®¹æ˜“ä¸€äº›äº†ã€‚DeepSeek-V2çš„æŠ€æœ¯æŠ¥å‘Šé‡Œæ˜¯ä»ä½ç§©æŠ•å½±çš„è§’åº¦å¼•å…¥MLAçš„ï¼Œä»¥è‡³äºæœ‰éƒ¨åˆ†è¯»è€…æå‡ºâ€œä¸ºä»€ä¹ˆLoRAæå‡ºè¿™ä¹ˆä¹…äº†ï¼Œç›´åˆ°MLAæ‰æå‡ºå¯¹KV Cacheä½ç§©åˆ†è§£çš„åšæ³•â€ä¹‹ç±»çš„ç–‘é—®ã€‚</p>
<p>ç„¶è€Œï¼Œç¬”è€…è®¤ä¸ºä½ç§©æŠ•å½±è¿™ä¸ªè§’åº¦å¹¶ä¸è´´è¿‘æœ¬è´¨ï¼Œå› ä¸ºè¦è¯´ä½ç§©æŠ•å½±çš„è¯ï¼Œäº‹å®ä¸Šåªè¦æˆ‘ä»¬å°†GQAçš„æ‰€æœ‰Kã€Vå åœ¨ä¸€èµ·ï¼Œå°±ä¼šå‘ç°GQAä¹Ÿç›¸å½“äºåœ¨åšä½ç§©æŠ•å½±ï¼š<br />
\begin{equation}\underbrace{\left[\boldsymbol{k}<em _boldsymbol_c="\boldsymbol{c">i^{(1)},\cdots,\boldsymbol{k}_i^{(g)},\boldsymbol{v}_i^{(1)},\cdots,\boldsymbol{v}_i^{(g)}\right]}</em><em _boldsymbol_W="\boldsymbol{W">i\in\mathbb{R}^{g(d_k+d_v)}} = \boldsymbol{x}_i \underbrace{\left[\boldsymbol{W}_k^{(1)},\cdots,\boldsymbol{W}_k^{(g)},\boldsymbol{W}_v^{(1)},\cdots,\boldsymbol{W}_v^{(g)}\right]}</em>}_c\in\mathbb{R}^{d\times g(d_k+d_v)}}\end{equation<br />
è¿™é‡Œæˆ‘ä»¬å°†æ‰€æœ‰$\boldsymbol{k}_i^{(s)},\boldsymbol{v}_i^{(s)}$æ‹¼åœ¨ä¸€èµ·è®°ä¸º$\boldsymbol{c}_i$ï¼Œç›¸åº”çš„æŠ•å½±çŸ©é˜µä¹Ÿæ‹¼åœ¨ä¸€èµ·è®°ä¸º$\boldsymbol{W}_c$ï¼Œæ³¨æ„åˆ°ä¸€èˆ¬éƒ½æœ‰$d_c = g(d_k+d_v) &lt; d$ï¼Œæ‰€ä»¥$\boldsymbol{x}_i$åˆ°$\boldsymbol{c}_i$çš„å˜æ¢å°±æ˜¯ä¸€ä¸ªä½ç§©æŠ•å½±ã€‚æ‰€ä»¥ï¼ŒMLAçš„æœ¬è´¨æ”¹è¿›ä¸æ˜¯ä½ç§©æŠ•å½±ï¼Œè€Œæ˜¯ä½ç§©æŠ•å½±ä¹‹åçš„å·¥ä½œã€‚</p>
<h3 id="part-1">Part 1</h3>
<p>GQAåœ¨æŠ•å½±ä¹‹ååšäº†ä»€ä¹ˆå‘¢ï¼Ÿé¦–å…ˆå®ƒå°†å‘é‡å¯¹åŠåˆ†ä¸ºä¸¤ä»½åˆ†åˆ«ä½œä¸ºKã€Vï¼Œç„¶åæ¯ä¸€ä»½åˆå‡åˆ†ä¸º$g$ä»½ï¼Œæ¯ä¸€ä»½å¤åˆ¶$h/g$æ¬¡ï¼Œä»¥æ­¤æ¥â€œå‡‘â€å¤Ÿ$h$ä¸ªAttention Headæ‰€éœ€è¦çš„Kã€Vã€‚æˆ‘ä»¬çŸ¥é“åˆ†å‰²ã€å¤åˆ¶éƒ½æ˜¯ç®€å•çš„çº¿æ€§å˜æ¢ï¼Œæ‰€ä»¥MLAçš„ç¬¬ä¸€ä¸ªæƒ³æ³•æ˜¯å°†è¿™äº›ç®€å•çš„çº¿æ€§å˜æ¢æ¢æˆä¸€èˆ¬çš„çº¿æ€§å˜æ¢ï¼Œä»¥å¢å¼ºæ¨¡å‹çš„èƒ½åŠ›ï¼š<br />
\begin{equation}<br />
\begin{gathered}<br />
\boldsymbol{o}<em _leq="\leq" t="t">t = \left[\boldsymbol{o}_t^{(1)}, \boldsymbol{o}_t^{(2)}, \cdots, \boldsymbol{o}_t^{(h)}\right] \\\[10pt]<br />
\boldsymbol{o}_t^{(s)} = Attention\left(\boldsymbol{q}_t^{(s)}, \boldsymbol{k}</em>}^{(s)} ,\boldsymbol{v<em i_leq="i\leq" t="t">{\leq t}^{(s)}\right)\triangleq\frac{\sum</em>}\exp\left(\boldsymbol{q<em i_leq="i\leq" t="t">t^{(s)} \boldsymbol{k}_i^{(s)}{}^{\top}\right)\boldsymbol{v}_i^{(s)}}{\sum</em> \\\[15pt]}\exp\left(\boldsymbol{q}_t^{(s)} \boldsymbol{k}_i^{(s)}{}^{\top}\right)<br />
\boldsymbol{q}_i^{(s)} = \boldsymbol{x}_i\boldsymbol{W}_q^{(s)}\in\mathbb{R}^{d_k},\quad \boldsymbol{W}_q^{(s)}\in\mathbb{R}^{d\times d_k}\\\<br />
\boldsymbol{k}_i^{(s)} = \boldsymbol{c}_i\boldsymbol{W}_k^{(s)}\in\mathbb{R}^{d_k},\quad \boldsymbol{W}_k^{(s)}\in\mathbb{R}^{d_c\times d_k} \\\<br />
\boldsymbol{v}_i^{(s)} = \boldsymbol{c}_i\boldsymbol{W}_v^{(s)}\in\mathbb{R}^{d_v},\quad \boldsymbol{W}_v^{(s)}\in\mathbb{R}^{d_c\times d_v} \\\[10pt]<br />
\boldsymbol{c}_i = \boldsymbol{x}_i \boldsymbol{W}_c\in\mathbb{R}^{d_c},\quad \boldsymbol{W}_c\in\mathbb{R}^{d\times d_c}<br />
\end{gathered}<br />
\end{equation}<br />
ç„¶è€Œï¼Œç†è®ºä¸Šè¿™æ ·æ˜¯èƒ½å¢åŠ æ¨¡å‹èƒ½åŠ›ï¼Œä½†åˆ«å¿˜äº†GQAçš„ä¸»è¦ç›®çš„æ˜¯å‡å°‘KV Cacheï¼Œå‡ºäºèŠ‚çœè®¡ç®—å’Œé€šä¿¡æˆæœ¬çš„è€ƒè™‘ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šç¼“å­˜çš„æ˜¯æŠ•å½±åçš„$\boldsymbol{k}_i, \boldsymbol{v}_i$è€Œä¸æ˜¯æŠ•å½±å‰çš„$\boldsymbol{c}_i$æˆ–$\boldsymbol{x}_i$ï¼Œè€ŒMLAçš„è¿™ä¸ªåšæ³•ï¼Œé€šè¿‡ä¸åŒçš„æŠ•å½±çŸ©é˜µå†æ¬¡è®©æ‰€æœ‰çš„Kã€V Headéƒ½å˜å¾—å„ä¸ç›¸åŒï¼Œé‚£ä¹ˆKV Cacheçš„å¤§å°å°±æ¢å¤æˆè·ŸMHAä¸€æ ·å¤§äº†ï¼Œè¿èƒŒäº†GQAçš„åˆè¡·ã€‚</p>
<p>å¯¹æ­¤ï¼ŒMLAå‘ç°ï¼Œæˆ‘ä»¬å¯ä»¥ç»“åˆDot-Attentionçš„å…·ä½“å½¢å¼ï¼Œé€šè¿‡ä¸€ä¸ªç®€å•ä½†ä¸å¤±å·§å¦™çš„æ’ç­‰å˜æ¢æ¥è§„é¿è¿™ä¸ªé—®é¢˜ã€‚é¦–å…ˆï¼Œåœ¨è®­ç»ƒé˜¶æ®µè¿˜æ˜¯ç…§å¸¸è¿›è¡Œï¼Œæ­¤æ—¶ä¼˜åŒ–ç©ºé—´ä¸å¤§ï¼›ç„¶åï¼Œåœ¨æ¨ç†é˜¶æ®µï¼Œæˆ‘ä»¬åˆ©ç”¨<br />
\begin{equation}\boldsymbol{q}_t^{(s)} \boldsymbol{k}_i^{(s)}{}^{\top} = \left(\boldsymbol{x}_t\boldsymbol{W}_q^{(s)}\right) \left(\boldsymbol{c}_i\boldsymbol{W}_k^{(s)}\right){}^{\top} = \boldsymbol{x}_t\left(\boldsymbol{W}_q^{(s)}\boldsymbol{W}_k^{(s)}{}^{\top}\right)\boldsymbol{c}_i^{\top} \end{equation}<br />
è¿™æ„å‘³ç€æ¨ç†é˜¶æ®µï¼Œæˆ‘ä»¬å¯ä»¥å°†$\boldsymbol{W}_q^{(s)}\boldsymbol{W}_k^{(s)}{}^{\top}$åˆå¹¶èµ·æ¥ä½œä¸ºQçš„æŠ•å½±çŸ©é˜µï¼Œé‚£ä¹ˆ$\boldsymbol{c}_i$åˆ™å–ä»£äº†åŸæœ¬çš„$\boldsymbol{k}_i$ï¼ŒåŒç†ï¼Œåœ¨$\boldsymbol{o}_t$åé¢æˆ‘ä»¬è¿˜æœ‰ä¸€ä¸ªæŠ•å½±çŸ©é˜µï¼Œäºæ˜¯$\boldsymbol{v}_i^{(s)} = \boldsymbol{c}_i\boldsymbol{W}_v^{(s)}$çš„$\boldsymbol{W}_v^{(s)}$ä¹Ÿå¯ä»¥å¸æ”¶åˆ°åé¢çš„æŠ•å½±çŸ©é˜µä¸­å»ï¼Œäºæ˜¯ç­‰æ•ˆåœ°$\boldsymbol{v}_i$ä¹Ÿå¯ä»¥ç”¨$\boldsymbol{c}_i$ä»£æ›¿ï¼Œä¹Ÿå°±æ˜¯è¯´æ­¤æ—¶KV Cacheåªéœ€è¦å­˜ä¸‹æ‰€æœ‰çš„$\boldsymbol{c}_i$å°±è¡Œï¼Œè€Œä¸è‡³äºå­˜ä¸‹æ‰€æœ‰çš„$\boldsymbol{k}_i^{(s)}$ã€$\boldsymbol{v}_i^{(s)}$ã€‚æ³¨æ„åˆ°$\boldsymbol{c}_i$è·Ÿ${}^{(s)}$æ— å…³ï¼Œä¹Ÿå°±æ˜¯è¯´æ˜¯æ‰€æœ‰å¤´å…±äº«çš„ï¼Œå³MLAåœ¨æ¨ç†é˜¶æ®µå®ƒå¯ä»¥æ’ç­‰å˜æ¢ä¸ºä¸€ä¸ªMQAã€‚</p>
<p>å†æ¬¡å¼ºè°ƒï¼Œæœ¬æ–‡çš„ä¸»é¢˜æ˜¯ä¸€ç›´éƒ½æ˜¯å‡å°‘KV Cacheï¼Œé‚£åˆ°ç›®å‰ä¸ºæ­¢ï¼ŒMLAåšåˆ°äº†ä»€ä¹ˆå‘¢ï¼Ÿç­”æ¡ˆæ˜¯é€šè¿‡ä¸åŒçš„æŠ•å½±çŸ©é˜µæ¥å¢å¼ºäº†GQAçš„èƒ½åŠ›ï¼Œå¹¶ä¸”æ¨ç†æ—¶å¯ä»¥ä¿æŒåŒæ ·å¤§å°çš„KV Cacheã€‚é‚£ä¹ˆåè¿‡æ¥ï¼Œå¦‚æœæˆ‘ä»¬åªéœ€è¦è·ŸGQAç›¸è¿‘çš„èƒ½åŠ›ï¼Œé‚£ä¹ˆæ˜¯ä¸æ˜¯å°±å¯ä»¥å†æ¬¡å‡å°‘KV Cacheäº†ï¼Ÿæ¢è¨€ä¹‹ï¼Œ$d_c$æ²¡å¿…è¦å–$g(d_k+d_v)$ï¼Œè€Œæ˜¯å–æ›´å°çš„å€¼ï¼ˆDeepSeek-V2å–äº†512ï¼‰ï¼Œä»è€Œè¿›ä¸€æ­¥å‹ç¼©KV Cacheï¼Œè¿™å°±æ˜¯MLAçš„æ ¸å¿ƒæ€æƒ³ã€‚</p>
<blockquote>
<p><strong>è¡¥å……è¯´æ˜ï¼š</strong></p>
<p>1ã€$\boldsymbol{W}_q^{(s)}\boldsymbol{W}_k^{(s)}{}^{\top}$åˆå¹¶æˆä¸€ä¸ªçŸ©é˜µçš„æ’ç­‰å˜æ¢ï¼Œç†è®ºä¸Šåªæœ‰åœ¨æ— é™ç²¾åº¦ä¸‹æ‰æˆç«‹ï¼Œå®é™…ä¸Šå¦‚æœæˆ‘ä»¬ä½¿ç”¨å•ç²¾åº¦å°¤å…¶æ˜¯BF16çš„è¯ï¼Œç»è¿‡å˜æ¢åçš„ç²¾åº¦æŸå¤±å¾€å¾€è¿˜æ˜¯æŒºæ˜æ˜¾çš„ï¼Œç»è¿‡å¤šå±‚ç´¯ç§¯åå¯èƒ½æ”¾å¤§åˆ°æ¯”è¾ƒå¯è§‚çš„ç¨‹åº¦ï¼›</p>
<p>2ã€å®é™…ä¸Šæˆ‘ä»¬ä¸€èˆ¬ä¸æŒ‰ç…§$\boldsymbol{x}_t\left(\boldsymbol{W}_q^{(s)}\boldsymbol{W}_k^{(s)}{}^{\top}\right)$æ¥è®¡ç®—Qï¼Œè€Œæ˜¯æŒ‰ç…§$\left(\boldsymbol{x}_t\boldsymbol{W}_q^{(s)}\right)\boldsymbol{W}_k^{(s)}{}^{\top}$æ¥è®¡ç®—ï¼Œè¿™æ ·è™½ç„¶æ˜¯ä¸²è¡Œçš„ï¼Œä½†åœ¨ä½ç§©å‡è®¾ä¸‹è®¡ç®—é‡æ›´å°‘ï¼Œå¹¶ä¸”ç†è®ºç²¾åº¦çš„æŸå¤±ä¹Ÿæ›´å°‘ï¼Œä¸è¿‡åœ¨æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬ä»æŒ‰ç…§$\boldsymbol{W}_q^{(s)}\boldsymbol{W}_k^{(s)}{}^{\top}$åˆå¹¶æˆä¸€ä¸ªçŸ©é˜µæ¥ä»‹ç»ã€‚</p>
</blockquote>
<h3 id="part-2">Part 2</h3>
<p>ä¸€åˆ‡ä¼¼ä¹éƒ½å¾ˆå®Œç¾ï¼Œçœ‹ä¸Šå»ä¸€ä¸ªåˆå¥½åˆçœçš„ç†æƒ³è®¾è®¡å°±è¦å‡ºç‚‰äº†ã€‚ä¸è¿‡åˆ«æ€¥ï¼Œå½“æˆ‘ä»¬å†æ·±å…¥æ€è€ƒä¸€ä¸‹å°±ä¼šå‘ç°ï¼Œåˆ°ç›®å‰ä¸ºæ­¢çš„MLAæœ‰ä¸€ä¸ªéš¾ä»¥ç»•å¼€çš„ç¼ºé™·â€”â€”ä¸å…¼å®¹<a href="/archives/8265">RoPEï¼ˆæ—‹è½¬ä½ç½®ç¼–ç ï¼‰</a>ã€‚</p>
<p>åˆšæ‰æˆ‘ä»¬è¯´äº†ï¼ŒMLAä¹‹æ‰€ä»¥èƒ½ä¿æŒè·ŸGQAä¸€æ ·å¤§å°çš„KV Cacheï¼Œå…¶å…³é”®ä¸€æ­¥æ˜¯â€œå°†$\boldsymbol{W}<em m-n="m-n">q^{(s)}\boldsymbol{W}_k^{(s)}{}^{\top}$åˆå¹¶æˆä¸€ä¸ªï¼ˆè·Ÿä½ç½®æ— å…³çš„ï¼‰çŸ©é˜µä½œä¸ºQçš„æŠ•å½±çŸ©é˜µâ€ï¼Œä½†å¦‚æœåŠ äº†RoPEçš„è¯ï¼Œè¿™ä¸€æ­¥å°±æ— æ³•å®ç°äº†ã€‚è¿™æ˜¯å› ä¸ºRoPEæ˜¯ä¸€ä¸ªè·Ÿä½ç½®ç›¸å…³çš„ã€$d_k\times d_k$çš„åˆ†å—å¯¹è§’çŸ©é˜µ$\boldsymbol{\mathcal{R}}_m$ï¼Œæ»¡è¶³$\boldsymbol{\mathcal{R}}_m\boldsymbol{\mathcal{R}}_n^{\top}=\boldsymbol{\mathcal{R}}</em>}$ï¼ŒMLAåŠ å…¥RoPEä¹‹åä¼šè®©$\boldsymbol{W<em t-i="t-i">q^{(s)}\boldsymbol{W}_k^{(s)}{}^{\top}$ä¹‹é—´å¤šæ’å…¥äº†ä¸€é¡¹$\boldsymbol{\mathcal{R}}</em>$ï¼š<br />
\begin{equation}<br />
\boldsymbol{q}<em t-i="t-i">i^{(s)} = \boldsymbol{x}_i\boldsymbol{W}_q^{(s)}\color{#3ce2f7}{\boldsymbol{\mathcal{R}}_i}\quad,\quad\boldsymbol{k}_i^{(s)} = \boldsymbol{c}_i\boldsymbol{W}_k^{(s)}\color{#3ce2f7}{\boldsymbol{\mathcal{R}}_i} \\\<br />
\boldsymbol{q}_t^{(s)} \boldsymbol{k}_i^{(s)}{}^{\top} = \left(\boldsymbol{x}_t\boldsymbol{W}_q^{(s)}\color{#3ce2f7}{\boldsymbol{\mathcal{R}}_t}\right) \left(\boldsymbol{c}_i\boldsymbol{W}_k^{(s)}\color{#3ce2f7}{\boldsymbol{\mathcal{R}}_i}\right){}^{\top} = \boldsymbol{x}_t\left(\boldsymbol{W}_q^{(s)}\color{#3ce2f7}{\boldsymbol{\mathcal{R}}</em>}}\boldsymbol{W<em t-i="t-i">k^{(s)}{}^{\top}\right)\boldsymbol{c}_i^{\top} \end{equation}<br />
è¿™é‡Œçš„$\boldsymbol{W}_q^{(s)}\color{#3ce2f7}{\boldsymbol{\mathcal{R}}</em>$å°±æ— æ³•åˆå¹¶ä¸ºä¸€ä¸ªå›ºå®šçš„æŠ•å½±çŸ©é˜µäº†ï¼ˆè·Ÿä½ç½®å·®$t-i$ç›¸å…³ï¼‰ï¼Œä»è€ŒMLAçš„æƒ³æ³•æ— æ³•ç»“åˆRoPEå®ç°ã€‚}}\boldsymbol{W}_k^{(s)}{}^{\top</p>
<p>å‰æ®µæ—¶é—´ï¼Œç¬”è€…ä¹Ÿå¾ˆè£å¹¸è·ŸDeepSeekå›¢é˜Ÿè®¨è®ºè¿‡è¿™ä¸ªé—®é¢˜ï¼Œä½†è¿™ä¸ªé—®é¢˜å¯ä»¥è¯´éå¸¸æœ¬è´¨ï¼Œæ‰€ä»¥å½“æ—¶ç¬”è€…å®é™…ä¸Šä¹Ÿæ²¡èƒ½æå‡ºä»€ä¹ˆæœ‰æ•ˆçš„å»ºè®®ã€‚æœ€ç®€å•çš„æ–¹å¼æ˜¯æ”¾å¼ƒRoPEï¼Œæ¢ç”¨å…¶ä»–åŸºäºAttention Biasçš„ä½ç½®ç¼–ç ï¼Œå¦‚<a href="/archives/9431#ALIBI">ALIBI</a>ï¼Œä½†DeepSeekçš„å®éªŒæ˜¾ç¤ºå®ƒæ˜æ˜¾ä¸å¦‚RoPEï¼ˆæ³¨æ„ï¼ŒMLAä¸æ˜¯ä¸èƒ½åŠ RoPEï¼Œè€Œæ˜¯åŠ äº†RoPEä¹‹åæ— æ³•ç”¨æ’ç­‰å˜æ¢æŠ€å·§æ¥å‡å°‘KV Cacheï¼‰ï¼Œç¬”è€…ä¹Ÿæè®®è¿‡æ¢<a href="/archives/9431#Sandwich">Sandwich</a>ï¼Œå®ƒä¸åƒALIBIå•è°ƒè¡°å‡åˆ°è´Ÿæ— ç©·ï¼Œä¼°è®¡æ•ˆæœä¼šå¥½äº›ï¼Œä½†æ„Ÿè§‰æ˜¯æ²»æ ‡ä¸æ²»æœ¬ã€‚è¿˜æœ‰ä¸€ä¸ªæŠ˜ä¸­çš„åŠæ³•æ˜¯å°†$\boldsymbol{q}<em m-n="m-n">i$çš„è¾“å…¥ä¹Ÿæ”¹ä¸º$\boldsymbol{c}_i$ï¼Œç„¶åRoPEåŠ åœ¨$\boldsymbol{c}_i$ä¹‹åï¼Œå³<br />
\begin{equation}\boldsymbol{q}_i^{(s)} = \boldsymbol{c}_i\color{#3ce2f7}{\boldsymbol{\mathcal{R}}_i}\boldsymbol{W}_q^{(s)},\quad\boldsymbol{k}_i^{(s)} = \boldsymbol{c}_i\color{#3ce2f7}{\boldsymbol{\mathcal{R}}_i}\boldsymbol{W}_k^{(s)}\end{equation}<br />
è¿™æ ·$\boldsymbol{\mathcal{R}}_i$å°±å¯ä»¥å¸æ”¶åˆ°$\boldsymbol{c}_i$ä¸­å»ï¼Œä½†è¿™æ ·å°±æ²¡æœ‰$\boldsymbol{\mathcal{R}}_m\boldsymbol{\mathcal{R}}_n^{\top}=\boldsymbol{\mathcal{R}}</em>$çš„è¿ç®—äº†ï¼Œæ­¤æ—¶çš„RoPEä¸å†æ˜¯é€šè¿‡ç»å¯¹ä½ç½®å®ç°ç›¸å¯¹ä½ç½®ï¼Œè€Œå•çº¯æ˜¯åœ¨Qã€Kä¸ŠåŠ ç»å¯¹ä½ç½®ï¼Œè®©æ¨¡å‹è‡ªå·±æƒ³åŠæ³•æç‚¼ç›¸å¯¹ä½ç½®ä¿¡æ¯ã€‚</p>
<p>æœ€åå‘å¸ƒçš„MLAï¼Œé‡‡å–äº†ä¸€ç§æ··åˆçš„æ–¹æ³•â€”â€”æ¯ä¸ªAttention Headçš„Qã€Kæ–°å¢$d_r$ä¸ªç»´åº¦ç”¨æ¥æ·»åŠ RoPEï¼Œå…¶ä¸­Kæ–°å¢çš„ç»´åº¦æ¯ä¸ªHeadå…±äº«ï¼š<br />
\begin{equation}<br />
\begin{gathered}<br />
\boldsymbol{o}<em _leq="\leq" t="t">t = \left[\boldsymbol{o}_t^{(1)}, \boldsymbol{o}_t^{(2)}, \cdots, \boldsymbol{o}_t^{(h)}\right] \\\[10pt]<br />
\boldsymbol{o}_t^{(s)} = Attention\left(\boldsymbol{q}_t^{(s)}, \boldsymbol{k}</em>}^{(s)} ,\boldsymbol{v<em i_leq="i\leq" t="t">{\leq t}^{(s)}\right)\triangleq\frac{\sum</em>}\exp\left(\boldsymbol{q<em i_leq="i\leq" t="t">t^{(s)} \boldsymbol{k}_i^{(s)}{}^{\top}\right)\boldsymbol{v}_i^{(s)}}{\sum</em>}\exp\left(\boldsymbol{q<em qc="qc">t^{(s)} \boldsymbol{k}_i^{(s)}{}^{\top}\right)} \\\[15pt]<br />
\boldsymbol{q}_i^{(s)} = \left[\boldsymbol{x}_i\boldsymbol{W}</em>}^{(s)}, \boldsymbol{x<em qr="qr">i\boldsymbol{W}</em>}^{(s)}\color{#3ce2f7}{\boldsymbol{\mathcal{R}<em qc="qc">i}\right]\in\mathbb{R}^{d_k + d_r},\quad \boldsymbol{W}</em>}^{(s)}\in\mathbb{R}^{d\times d_k},\boldsymbol{W<em kc="kc">{qr}^{(s)}\in\mathbb{R}^{d\times d_r}\\\<br />
\boldsymbol{k}_i^{(s)} = \left[\boldsymbol{c}_i\boldsymbol{W}</em>}^{(s)}, \boldsymbol{x<em kr="kr">i\boldsymbol{W}</em>}^{\color{#ccc}{\smash{\bcancel{(s)}}}}\color{#3ce2f7}{\boldsymbol{\mathcal{R}<em kc="kc">i}\right]\in\mathbb{R}^{d_k+d_r},\quad \boldsymbol{W}</em> \\\}^{(s)}\in\mathbb{R}^{d_c\times d_k}, \boldsymbol{W}_{kr}^{\color{#ccc}{\smash{\bcancel{(s)}}}}\in\mathbb{R}^{d\times d_r<br />
\boldsymbol{v}_i^{(s)} = \boldsymbol{c}_i\boldsymbol{W}_v^{(s)}\in\mathbb{R}^{d_v},\quad \boldsymbol{W}_v^{(s)}\in\mathbb{R}^{d_c\times d_v} \\\[10pt]<br />
\boldsymbol{c}_i = \boldsymbol{x}_i \boldsymbol{W}_c\in\mathbb{R}^{d_c},\quad \boldsymbol{W}_c\in\mathbb{R}^{d\times d_c}<br />
\end{gathered}<br />
\end{equation}<br />
è¿™æ ·ä¸€æ¥ï¼Œæ²¡æœ‰RoPEçš„ç»´åº¦å°±å¯ä»¥é‡å¤â€œPart 1â€çš„æ“ä½œï¼Œåœ¨æ¨ç†æ—¶KV Cacheåªéœ€è¦å­˜$\boldsymbol{c}_i$ï¼Œæ–°å¢çš„å¸¦RoPEçš„ç»´åº¦å°±å¯ä»¥ç”¨æ¥è¡¥å……ä½ç½®ä¿¡æ¯ï¼Œå¹¶ä¸”ç”±äºæ‰€æœ‰Headå…±äº«ï¼Œæ‰€ä»¥ä¹Ÿå°±åªæœ‰åœ¨K Cacheè¿™é‡Œå¢åŠ äº†$d_r$ä¸ªç»´åº¦ï¼ŒåŸè®ºæ–‡å–äº†$d_r = d_k / 2 = 64$ï¼Œç›¸æ¯”åŸæœ¬çš„$d_c=512$ï¼Œå¢åŠ çš„å¹…åº¦ä¸å¤§ã€‚</p>
<h3 id="part-3">Part 3</h3>
<p>æœ€åæœ‰ä¸€ä¸ªç»†èŠ‚ï¼Œå°±æ˜¯MLAçš„æœ€ç»ˆç‰ˆæœ¬ï¼Œè¿˜å°†Qçš„è¾“å…¥ä¹Ÿæ”¹ä¸ºäº†ä½ç§©æŠ•å½±å½¢å¼ï¼Œè¿™ä¸å‡å°‘KV Cacheæ— å…³ï¼Œä¸»è¦æ˜¯ä¸ºäº†å‡å°‘è®­ç»ƒæœŸé—´å‚æ•°é‡å’Œç›¸åº”çš„æ¢¯åº¦ï¼ˆåŸè®ºæ–‡è¯´çš„æ˜¯æ¿€æ´»å€¼ï¼Œä¸ªäººè¡¨ç¤ºä¸å¤§ç†è§£ï¼‰æ‰€å çš„æ˜¾å­˜ï¼š<br />
\begin{equation}<br />
\begin{gathered}<br />
\boldsymbol{o}<em _leq="\leq" t="t">t = \left[\boldsymbol{o}_t^{(1)}, \boldsymbol{o}_t^{(2)}, \cdots, \boldsymbol{o}_t^{(h)}\right] \\\[10pt]<br />
\boldsymbol{o}_t^{(s)} = Attention\left(\boldsymbol{q}_t^{(s)}, \boldsymbol{k}</em>}^{(s)} ,\boldsymbol{v<em i_leq="i\leq" t="t">{\leq t}^{(s)}\right)\triangleq\frac{\sum</em>}\exp\left(\boldsymbol{q<em i_leq="i\leq" t="t">t^{(s)} \boldsymbol{k}_i^{(s)}{}^{\top}\right)\boldsymbol{v}_i^{(s)}}{\sum</em>}\exp\left(\boldsymbol{q<em qc="qc">t^{(s)} \boldsymbol{k}_i^{(s)}{}^{\top}\right)} \\\[15pt]<br />
\boldsymbol{q}_i^{(s)} = \left[\boldsymbol{c}_i'\boldsymbol{W}</em>}^{(s)}, \boldsymbol{c<em qr="qr">i'\boldsymbol{W}</em>}^{(s)}\color{#3ce2f7}{\boldsymbol{\mathcal{R}<em qc="qc">i}\right]\in\mathbb{R}^{d_k + d_r},\quad \boldsymbol{W}</em>}^{(s)}\in\mathbb{R}^{d_c'\times d_k},\boldsymbol{W<em kc="kc">{qr}^{(s)}\in\mathbb{R}^{d_c'\times d_r}\\\<br />
\boldsymbol{k}_i^{(s)} = \left[\boldsymbol{c}_i\boldsymbol{W}</em>}^{(s)}, \boldsymbol{x<em kr="kr">i\boldsymbol{W}</em>}^{\color{#ccc}{\smash{\bcancel{(s)}}}}\color{#3ce2f7}{\boldsymbol{\mathcal{R}<em kc="kc">i}\right]\in\mathbb{R}^{d_k+d_r},\quad \boldsymbol{W}</em>}^{(s)}\in\mathbb{R}^{d_c\times d_k}, \boldsymbol{W<em _leq="\leq" t="t">{kr}^{\color{#ccc}{\smash{\bcancel{(s)}}}}\in\mathbb{R}^{d\times d_r} \\\<br />
\boldsymbol{v}_i^{(s)} = \boldsymbol{c}_i\boldsymbol{W}_v^{(s)}\in\mathbb{R}^{d_v},\quad \boldsymbol{W}_v^{(s)}\in\mathbb{R}^{d_c\times d_v} \\\[10pt]<br />
\boldsymbol{c}_i' = \boldsymbol{x}_i \boldsymbol{W}_c'\in\mathbb{R}^{d_c'},\quad \boldsymbol{W}_c'\in\mathbb{R}^{d\times d_c'} \\\<br />
\boldsymbol{c}_i = \boldsymbol{x}_i \boldsymbol{W}_c\in\mathbb{R}^{d_c},\quad \boldsymbol{W}_c\in\mathbb{R}^{d\times d_c} \\\<br />
\end{gathered}<br />
\label{eq:mla-mha}\end{equation}<br />
æ³¨æ„$\boldsymbol{k}_i^{(s)}$ä¸­çš„ç¬¬äºŒé¡¹ï¼Œå¸¦RoPEçš„éƒ¨åˆ†ï¼Œå…¶è¾“å…¥è¿˜æ˜¯$\boldsymbol{x}_i$è€Œä¸æ˜¯$\boldsymbol{c}_i$ï¼Œè¿™é‡Œä¿æŒäº†åŸè®ºæ–‡çš„è®¾ç½®ï¼Œä¸æ˜¯ç¬”è¯¯ï¼Œ$d_c'$åŸè®ºæ–‡çš„å–å€¼æ˜¯1536ï¼Œè·Ÿ$d_c=512$ä¸åŒã€‚åŒæ—¶ï¼Œæˆ‘ä»¬æŠŠå¸¦RoPEçš„MHAæ”¾åœ¨ä¸‹é¢ï¼Œæ–¹ä¾¿å¤§å®¶å¯¹æ¯”ï¼š<br />
\begin{equation}<br />
\begin{gathered}<br />
\boldsymbol{o}_t = \left[\boldsymbol{o}_t^{(1)}, \boldsymbol{o}_t^{(2)}, \cdots, \boldsymbol{o}_t^{(h)}\right] \\\[10pt]<br />
\boldsymbol{o}_t^{(s)} = Attention\left(\boldsymbol{q}_t^{(s)}, \boldsymbol{k}</em>}^{(s)} ,\boldsymbol{v<em i_leq="i\leq" t="t">{\leq t}^{(s)}\right)\triangleq\frac{\sum</em>}\exp\left(\boldsymbol{q<em i_leq="i\leq" t="t">t^{(s)} \boldsymbol{k}_i^{(s)}{}^{\top}\right)\boldsymbol{v}_i^{(s)}}{\sum</em> \\\[15pt]}\exp\left(\boldsymbol{q}_t^{(s)} \boldsymbol{k}_i^{(s)}{}^{\top}\right)<br />
\boldsymbol{q}_i^{(s)} = \boldsymbol{x}_i\boldsymbol{W}_q^{(s)}\color{#3ce2f7}{\boldsymbol{\mathcal{R}}_i}\in\mathbb{R}^{d_k},\quad \boldsymbol{W}_q^{(s)}\in\mathbb{R}^{d\times d_k}\\\<br />
\boldsymbol{k}_i^{(s)} = \boldsymbol{x}_i\boldsymbol{W}_k^{(s)}\color{#3ce2f7}{\boldsymbol{\mathcal{R}}_i}\in\mathbb{R}^{d_k},\quad \boldsymbol{W}_k^{(s)}\in\mathbb{R}^{d\times d_k} \\\<br />
\boldsymbol{v}_i^{(s)} = \boldsymbol{x}_i\boldsymbol{W}_v^{(s)}\in\mathbb{R}^{d_v},\quad \boldsymbol{W}_v^{(s)}\in\mathbb{R}^{d\times d_v}<br />
\end{gathered}<br />
\end{equation}<br />
å¯ä»¥å‘ç°ï¼Œå…¶å®åœ¨è®­ç»ƒé˜¶æ®µï¼Œé™¤äº†å¤šäº†ä¸€æ­¥ä½ç§©æŠ•å½±ä»¥åŠåªåœ¨éƒ¨åˆ†ç»´åº¦åŠ RoPEå¤–ï¼ŒMLAä¸Qã€Kçš„Head Sizeç”±$d_k$æ¢æˆ$d_k + d_r$çš„MHAåŸºæœ¬æ— å¼‚ã€‚</p>
<p>è§£ç é˜¶æ®µçš„MLAåˆ™æ”¹ä¸ºMQAå½¢å¼<br />
\begin{equation}<br />
\begin{gathered}<br />
\boldsymbol{o}<em _leq="\leq" t="t">t = \left[\boldsymbol{o}_t^{(1)}\boldsymbol{W}_v^{(1)}, \boldsymbol{o}_t^{(2)}\boldsymbol{W}_v^{(2)}, \cdots, \boldsymbol{o}_t^{(h)}\boldsymbol{W}_v^{(h)}\right] \\\[10pt]<br />
\boldsymbol{o}_t^{(s)} = Attention\left(\boldsymbol{q}_t^{(s)}, \boldsymbol{k}</em>}^{\color{#ccc}{\smash{\bcancel{(s)}}}} ,\boldsymbol{c<em i_leq="i\leq" t="t">{\leq t}\right)\triangleq\frac{\sum</em>}\exp\left(\boldsymbol{q<em i_leq="i\leq" t="t">t^{(s)} \boldsymbol{k}_i^{\color{#ccc}{\smash{\bcancel{(s)}}}}{}^{\top}\right)\boldsymbol{c}_i}{\sum</em>}\exp\left(\boldsymbol{q<em qc="qc">t^{(s)} \boldsymbol{k}_i^{\color{#ccc}{\smash{\bcancel{(s)}}}}{}^{\top}\right)} \\\[15pt]<br />
\boldsymbol{q}_i^{(s)} = \left[\boldsymbol{c}_i'\boldsymbol{W}</em>}^{(s)}\boldsymbol{W<em qr="qr">{kc}^{(s)}{}^{\top}, \boldsymbol{c}_i'\boldsymbol{W}</em>}^{(s)}\color{#3ce2f7}{\boldsymbol{\mathcal{R}<em kr="kr">i}\right]\in\mathbb{R}^{d_c + d_r}\\\<br />
\boldsymbol{k}_i^{\color{#ccc}{\smash{\bcancel{(s)}}}} = \left[\boldsymbol{c}_i, \boldsymbol{x}_i\boldsymbol{W}</em>}^{\color{#ccc}{\smash{\bcancel{(s)}}}}\color{#3ce2f7}{\boldsymbol{\mathcal{R}<em qc="qc">i}\right]\in\mathbb{R}^{d_c+d_r}\\\<br />
\boldsymbol{W}</em>}^{(s)}\in\mathbb{R}^{d_c'\times d_k},\boldsymbol{W<em qr="qr">{kc}^{(s)}\in\mathbb{R}^{d_c\times d_k},\boldsymbol{W}</em> \\\[10pt]}^{(s)}\in\mathbb{R}^{d_c'\times d_r},\boldsymbol{W}_{kr}^{\color{#ccc}{\smash{\bcancel{(s)}}}}\in\mathbb{R}^{d\times d_r<br />
\boldsymbol{c}_i' = \boldsymbol{x}_i \boldsymbol{W}_c'\in\mathbb{R}^{d_c'},\quad \boldsymbol{W}_c'\in\mathbb{R}^{d\times d_c'} \\\<br />
\boldsymbol{c}_i = \boldsymbol{x}_i \boldsymbol{W}_c\in\mathbb{R}^{d_c},\quad \boldsymbol{W}_c\in\mathbb{R}^{d\times d_c} \\\<br />
\end{gathered}<br />
\label{eq:mla-mqa}\end{equation}<br />
æ­¤æ—¶Qã€Kçš„Head Sizeå˜æˆäº†$d_c + d_r$ï¼ŒVçš„Head Size åˆ™å˜æˆäº†$d_c$ï¼ŒæŒ‰ç…§åŸè®ºæ–‡çš„è®¾ç½®ï¼Œè¿™æ˜¯$d_k$ã€$d_v$çš„4å€ã€‚æ‰€ä»¥å®é™…ä¸ŠMLAåœ¨è§£ç é˜¶æ®µåšçš„è¿™ä¸ªè½¬æ¢ï¼Œè™½ç„¶èƒ½æœ‰æ•ˆå‡å°‘KV Cacheï¼Œä½†å…¶è§£ç çš„è®¡ç®—é‡æ˜¯å¢åŠ çš„ã€‚</p>
<p>é‚£ä¸ºä»€ä¹ˆè¿˜èƒ½æé«˜æ¨ç†æ•ˆç‡å‘¢ï¼Ÿè¿™åˆå›åˆ°â€œç“¶é¢ˆâ€ä¸€èŠ‚æ‰€è®¨è®ºçš„é—®é¢˜äº†ï¼Œæˆ‘ä»¬å¯ä»¥å°†LLMçš„æ¨ç†åˆ†ä¸¤éƒ¨åˆ†ï¼šç¬¬ä¸€ä¸ªTokençš„ç”Ÿæˆï¼ˆPrefillï¼‰å’Œåç»­æ¯ä¸ªTokençš„ç”Ÿæˆï¼ˆGenerationï¼‰ï¼ŒPrefillé˜¶æ®µæ¶‰åŠåˆ°å¯¹è¾“å…¥æ‰€æœ‰Tokençš„å¹¶è¡Œè®¡ç®—ï¼Œç„¶åæŠŠå¯¹åº”çš„KV Cacheå­˜ä¸‹æ¥ï¼Œè¿™éƒ¨åˆ†å¯¹äºè®¡ç®—ã€å¸¦å®½å’Œæ˜¾å­˜éƒ½æ˜¯ç“¶é¢ˆï¼Œæˆ‘ä»¬å¯ä»¥ç”¨MLAçš„MHAå½¢å¼$\eqref{eq:mla-mha}$æ¥ç®—ï¼›ä½†æ˜¯Generationé˜¶æ®µç”±äºæ¯æ­¥åªè®¡ç®—ä¸€ä¸ªTokenï¼Œå®é™…ä¸Šå®ƒæ›´å¤šçš„æ˜¯å¸¦å®½ç“¶é¢ˆå’Œæ˜¾å­˜ç“¶é¢ˆï¼Œæ­¤æ—¶æˆ‘ä»¬å¯ä»¥ç”¨MLAçš„MQAå½¢å¼$\eqref{eq:mla-mqa}$æ¥ç®—ï¼Œä»è€Œæ˜æ˜¾æé«˜Generationçš„é€Ÿåº¦ã€‚</p>
<p>è¿˜æœ‰ä¸€ä¸ªç»†èŠ‚å……åˆ†ä½“ç°äº†è¿™ä¸ªç‰¹æ€§ã€‚ä¸€èˆ¬çš„LLMæ¶æ„å‚æ•°æ»¡è¶³$h \times d_k = d$ï¼Œå³num_heads * head_size = hidden_sizeï¼Œä½†DeepSeek-V2ä¸ä¸€æ ·ï¼Œå®ƒ$d_k=128,d=5120$ï¼Œä½†$h=128$ï¼Œæ˜¯ä¸€èˆ¬è®¾ç½®çš„3å€ï¼è¿™æ˜¯å› ä¸ºMLAçš„KV Cacheå¤§å°è·Ÿ$h$æ— å…³ï¼Œå¢å¤§$h$åªä¼šå¢åŠ è®¡ç®—é‡å’Œæå‡æ¨¡å‹èƒ½åŠ›ï¼Œä½†ä¸ä¼šå¢åŠ KV Cacheï¼Œæ‰€ä»¥ä¸ä¼šå¸¦æ¥é€Ÿåº¦ç“¶é¢ˆã€‚</p>
<h2 id="_2">å°ç»“</h2>
<p>æœ¬æ–‡ç®€å•æ¦‚è¿°äº†å¤šå¤´æ³¨æ„åŠ›çš„æ¼”å˜å†ç¨‹ï¼Œç‰¹åˆ«æ˜¯ä»MHAå‘MQAã€GQAï¼Œæœ€ç»ˆåˆ°MLAçš„å˜åŒ–ç†å¿µï¼Œæœ€åè¯¦ç»†å±•å¼€äº†å¯¹MLAçš„ä»‹ç»ã€‚åœ¨æœ¬æ–‡ä¸­ï¼ŒMLAè¢«è§†ä¸ºGQAçš„ä¸€èˆ¬åŒ–ï¼Œå®ƒç”¨æŠ•å½±çŸ©é˜µçš„æ–¹å¼æ›¿ä»£äº†GQAçš„åˆ†å‰²ã€é‡å¤ï¼Œå¹¶å¼•å…¥äº†ä¸€ä¸ªæ’ç­‰å˜æ¢æŠ€å·§æ¥å¯ä»¥è¿›ä¸€æ­¥å‹ç¼©KV Cacheï¼ŒåŒæ—¶é‡‡ç”¨äº†ä¸€ç§æ··åˆæ–¹æ³•æ¥å…¼å®¹RoPEã€‚æ€»çš„æ¥è¯´ï¼ŒMLAç§°å¾—ä¸Šæ˜¯ä¸€ç§éå¸¸å®ç”¨çš„æ³¨æ„åŠ›å˜ä½“ã€‚</p>
<p><em><strong>è½¬è½½åˆ°è¯·åŒ…æ‹¬æœ¬æ–‡åœ°å€ï¼š</strong><a href="https://spaces.ac.cn/archives/10091">https://spaces.ac.cn/archives/10091</a></em></p>
<p><em><strong>æ›´è¯¦ç»†çš„è½¬è½½äº‹å®œè¯·å‚è€ƒï¼š</strong></em><a href="https://spaces.ac.cn/archives/6508#%E6%96%87%E7%AB%A0%E5%A6%82%E4%BD%95%E8%BD%AC%E8%BD%BD/%E5%BC%95%E7%94%A8" title="ã€Šç§‘å­¦ç©ºé—´FAQã€‹">ã€Šç§‘å­¦ç©ºé—´FAQã€‹</a></p>
<p><strong>å¦‚æœæ‚¨è¿˜æœ‰ä»€ä¹ˆç–‘æƒ‘æˆ–å»ºè®®ï¼Œæ¬¢è¿åœ¨ä¸‹æ–¹è¯„è®ºåŒºç»§ç»­è®¨è®ºã€‚</strong></p>
<p><strong>å¦‚æœæ‚¨è§‰å¾—æœ¬æ–‡è¿˜ä¸é”™ï¼Œæ¬¢è¿åˆ†äº«/æ‰“èµæœ¬æ–‡ã€‚æ‰“èµå¹¶éè¦ä»ä¸­è·å¾—æ”¶ç›Šï¼Œè€Œæ˜¯å¸Œæœ›çŸ¥é“ç§‘å­¦ç©ºé—´è·å¾—äº†å¤šå°‘è¯»è€…çš„çœŸå¿ƒå…³æ³¨ã€‚å½“ç„¶ï¼Œå¦‚æœä½ æ— è§†å®ƒï¼Œä¹Ÿä¸ä¼šå½±å“ä½ çš„é˜…è¯»ã€‚å†æ¬¡è¡¨ç¤ºæ¬¢è¿å’Œæ„Ÿè°¢ï¼</strong></p>
<p>æ‰“èµ</p>
<p><img alt="ç§‘å­¦ç©ºé—´" src="https://spaces.ac.cn/usr/themes/geekg/payment/wx.png" /></p>
<p>å¾®ä¿¡æ‰“èµ</p>
<p><img alt="ç§‘å­¦ç©ºé—´" src="https://spaces.ac.cn/usr/themes/geekg/payment/zfb.png" /></p>
<p>æ”¯ä»˜å®æ‰“èµ</p>
<p>å› ä¸ºç½‘ç«™åå°å¯¹æ‰“èµå¹¶æ— è®°å½•ï¼Œå› æ­¤æ¬¢è¿åœ¨æ‰“èµæ—¶å€™å¤‡æ³¨ç•™è¨€ã€‚ä½ è¿˜å¯ä»¥<a href="http://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&amp;email=tN7d1drY3drrx8H0xcWa19vZ"><strong>ç‚¹å‡»è¿™é‡Œ</strong></a>æˆ–åœ¨ä¸‹æ–¹è¯„è®ºåŒºç•™è¨€æ¥å‘ŠçŸ¥ä½ çš„å»ºè®®æˆ–éœ€æ±‚ã€‚</p>
<p><strong>å¦‚æœæ‚¨éœ€è¦å¼•ç”¨æœ¬æ–‡ï¼Œè¯·å‚è€ƒï¼š</strong></p>
<p>è‹å‰‘æ—. (May. 13, 2024). ã€Šç¼“å­˜ä¸æ•ˆæœçš„æé™æ‹‰æ‰¯ï¼šä»MHAã€MQAã€GQAåˆ°MLA ã€‹[Blog post]. Retrieved from <a href="https://spaces.ac.cn/archives/10091">https://spaces.ac.cn/archives/10091</a></p>
<p>@online{kexuefm-10091,<br />
title={ç¼“å­˜ä¸æ•ˆæœçš„æé™æ‹‰æ‰¯ï¼šä»MHAã€MQAã€GQAåˆ°MLA},<br />
author={è‹å‰‘æ—},<br />
year={2024},<br />
month={May},<br />
url={\url{https://spaces.ac.cn/archives/10091}},<br />
} </p>
<hr />
<h2 id="_3">å…¬å¼æ¨å¯¼ä¸æ³¨é‡Š</h2>
<h3 id="mha_1">ä¸€ã€å¤šå¤´æ³¨æ„åŠ›(MHA)çš„å®Œæ•´æ•°å­¦æ¨å¯¼</h3>
<h4 id="11-mha">1.1 æ ‡å‡†MHAçš„æ•°å­¦å®šä¹‰</h4>
<p>å¯¹äºè¾“å…¥åºåˆ— $\boldsymbol{X} = [\boldsymbol{x}_1, \boldsymbol{x}_2, \ldots, \boldsymbol{x}_l] \in \mathbb{R}^{l \times d}$ï¼Œå¤šå¤´æ³¨æ„åŠ›æœºåˆ¶å¯ä»¥å½¢å¼åŒ–ä¸ºï¼š</p>
<p>\begin{equation}
\text{MHA}(\boldsymbol{X}) = \text{Concat}(\boldsymbol{O}^{(1)}, \boldsymbol{O}^{(2)}, \ldots, \boldsymbol{O}^{(h)}) \boldsymbol{W}_O
\tag{1}
\end{equation}</p>
<p>å…¶ä¸­ $\boldsymbol{O}^{(s)} \in \mathbb{R}^{l \times d_v}$ æ˜¯ç¬¬ $s$ ä¸ªå¤´çš„è¾“å‡ºï¼Œ$\boldsymbol{W}_O \in \mathbb{R}^{hd_v \times d}$ æ˜¯è¾“å‡ºæŠ•å½±çŸ©é˜µã€‚</p>
<p><strong>æ•°å­¦ç›´è§‰</strong>: MHAé€šè¿‡å¤šä¸ªç‹¬ç«‹çš„æ³¨æ„åŠ›å¤´å¹¶è¡Œå¤„ç†ä¿¡æ¯ï¼Œæ¯ä¸ªå¤´å…³æ³¨ä¸åŒçš„è¡¨ç¤ºå­ç©ºé—´ï¼Œæœ€åæ‹¼æ¥èåˆã€‚è¿™ç±»ä¼¼äºå·ç§¯ç¥ç»ç½‘ç»œä¸­çš„å¤šé€šé“æœºåˆ¶ã€‚</p>
<h4 id="12">1.2 å•å¤´æ³¨æ„åŠ›çš„è¯¦ç»†æ¨å¯¼</h4>
<p>å¯¹äºç¬¬ $s$ ä¸ªæ³¨æ„åŠ›å¤´ï¼Œè®¡ç®—è¿‡ç¨‹ä¸ºï¼š</p>
<p>\begin{equation}
\boldsymbol{O}^{(s)} = \text{Attention}(\boldsymbol{Q}^{(s)}, \boldsymbol{K}^{(s)}, \boldsymbol{V}^{(s)})
\tag{2}
\end{equation}</p>
<p>å±•å¼€æ³¨æ„åŠ›è®¡ç®—ï¼š</p>
<p>\begin{equation}
\text{Attention}(\boldsymbol{Q}^{(s)}, \boldsymbol{K}^{(s)}, \boldsymbol{V}^{(s)}) = \text{softmax}\left(\frac{\boldsymbol{Q}^{(s)} {\boldsymbol{K}^{(s)}}^\top}{\sqrt{d_k}}\right) \boldsymbol{V}^{(s)}
\tag{3}
\end{equation}</p>
<p>å…¶ä¸­ï¼š
- $\boldsymbol{Q}^{(s)} = \boldsymbol{X}\boldsymbol{W}_q^{(s)} \in \mathbb{R}^{l \times d_k}$ (æŸ¥è¯¢çŸ©é˜µ)
- $\boldsymbol{K}^{(s)} = \boldsymbol{X}\boldsymbol{W}_k^{(s)} \in \mathbb{R}^{l \times d_k}$ (é”®çŸ©é˜µ)
- $\boldsymbol{V}^{(s)} = \boldsymbol{X}\boldsymbol{W}_v^{(s)} \in \mathbb{R}^{l \times d_v}$ (å€¼çŸ©é˜µ)</p>
<p><strong>ç¼©æ”¾å› å­çš„æ•°å­¦åŸç†</strong>: $1/\sqrt{d_k}$ çš„ç¼©æ”¾ç¡®ä¿äº†ç‚¹ç§¯çš„æ–¹å·®ä¸º1ã€‚å‡è®¾ $\boldsymbol{q}$ å’Œ $\boldsymbol{k}$ çš„æ¯ä¸ªå…ƒç´ ç‹¬ç«‹åŒåˆ†å¸ƒï¼Œå‡å€¼ä¸º0ï¼Œæ–¹å·®ä¸º1ï¼Œåˆ™ç‚¹ç§¯ $\boldsymbol{q}^\top \boldsymbol{k} = \sum_{i=1}^{d_k} q_i k_i$ çš„æ–¹å·®ä¸ºï¼š</p>
<p>\begin{equation}
\text{Var}(\boldsymbol{q}^\top \boldsymbol{k}) = \sum_{i=1}^{d_k} \text{Var}(q_i k_i) = d_k
\tag{4}
\end{equation}</p>
<p>å› æ­¤é™¤ä»¥ $\sqrt{d_k}$ å¯ä»¥å°†æ–¹å·®å½’ä¸€åŒ–ä¸º1ï¼Œé˜²æ­¢softmaxé¥±å’Œã€‚</p>
<h4 id="13">1.3 è‡ªå›å½’ç”Ÿæˆä¸­çš„å› æœæ³¨æ„åŠ›</h4>
<p>å¯¹äºè‡ªå›å½’è¯­è¨€æ¨¡å‹ï¼Œç¬¬ $t$ ä¸ªtokenåªèƒ½å…³æ³¨åˆ°ä½ç½® $\leq t$ çš„tokenï¼š</p>
<p>\begin{equation}
\boldsymbol{o}<em i="1">t^{(s)} = \sum</em>
\tag{5}
\end{equation}}^{t} \alpha_{t,i}^{(s)} \boldsymbol{v}_i^{(s)</p>
<p>å…¶ä¸­æ³¨æ„åŠ›æƒé‡ä¸ºï¼š</p>
<p>\begin{equation}
\alpha_{t,i}^{(s)} = \frac{\exp\left(\boldsymbol{q}<em j="1">t^{(s)} {\boldsymbol{k}_i^{(s)}}^\top / \sqrt{d_k}\right)}{\sum</em>
\tag{6}
\end{equation}}^{t} \exp\left(\boldsymbol{q}_t^{(s)} {\boldsymbol{k}_j^{(s)}}^\top / \sqrt{d_k}\right)</p>
<p><strong>æ•°å­¦æ€§è´¨</strong>: æ³¨æ„åŠ›æƒé‡æ»¡è¶³ $\sum_{i=1}^{t} \alpha_{t,i}^{(s)} = 1$ ä¸” $\alpha_{t,i}^{(s)} \geq 0$ï¼Œå› æ­¤è¿™æ˜¯ä¸€ä¸ªå‡¸ç»„åˆã€‚</p>
<h4 id="14-mha">1.4 MHAçš„è®¡ç®—å¤æ‚åº¦åˆ†æ</h4>
<p><strong>æ—¶é—´å¤æ‚åº¦</strong>:
1. QKVæŠ•å½±: $\mathcal{O}(3hld \cdot d_k) = \mathcal{O}(hld^2)$ (å› ä¸ºé€šå¸¸ $hd_k = d$)
2. æ³¨æ„åŠ›çŸ©é˜µè®¡ç®—: $\mathcal{O}(hl^2d_k)$
3. æ³¨æ„åŠ›åŠ æƒæ±‚å’Œ: $\mathcal{O}(hl^2d_v)$
4. è¾“å‡ºæŠ•å½±: $\mathcal{O}(ld \cdot hd_v) = \mathcal{O}(ld^2)$</p>
<p>æ€»æ—¶é—´å¤æ‚åº¦ï¼š</p>
<p>\begin{equation}
T_{\text{MHA}} = \mathcal{O}(ld^2 + hl^2d) = \mathcal{O}(l^2d)
\tag{7}
\end{equation}</p>
<p>(å½“ $l \gg d$ æ—¶ï¼Œ$l^2d$ é¡¹å ä¸»å¯¼)</p>
<p><strong>ç©ºé—´å¤æ‚åº¦</strong>:
1. QKVçŸ©é˜µ: $\mathcal{O}(3hld_k) = \mathcal{O}(ld)$
2. æ³¨æ„åŠ›çŸ©é˜µ: $\mathcal{O}(hl^2)$
3. è¾“å‡ºçŸ©é˜µ: $\mathcal{O}(ld)$</p>
<p>æ€»ç©ºé—´å¤æ‚åº¦ï¼š</p>
<p>\begin{equation}
S_{\text{MHA}} = \mathcal{O}(ld + hl^2)
\tag{8}
\end{equation}</p>
<h3 id="kv-cache">äºŒã€KV Cacheçš„æ•°å­¦åŸç†ä¸å†…å­˜åˆ†æ</h3>
<h4 id="21-kv-cache">2.1 KV Cacheçš„å¿…è¦æ€§æ¨å¯¼</h4>
<p>åœ¨è‡ªå›å½’ç”Ÿæˆä¸­ï¼Œç”Ÿæˆç¬¬ $t+1$ ä¸ªtokenæ—¶ï¼Œéœ€è¦è®¡ç®—ï¼š</p>
<p>\begin{equation}
\boldsymbol{o}<em i="1">{t+1}^{(s)} = \sum</em>
\tag{9}
\end{equation}}^{t+1} \alpha_{t+1,i}^{(s)} \boldsymbol{v}_i^{(s)</p>
<p>æ³¨æ„åˆ°å¯¹äº $i \leq t$ï¼Œ$\boldsymbol{k}_i^{(s)}$ å’Œ $\boldsymbol{v}_i^{(s)}$ åœ¨è®¡ç®— $\boldsymbol{o}_t^{(s)}$ æ—¶å·²ç»ç®—è¿‡ï¼Œæ— éœ€é‡æ–°è®¡ç®—ã€‚</p>
<p><strong>é‡å¤è®¡ç®—é‡åˆ†æ</strong>: å¦‚æœä¸ä½¿ç”¨KV Cacheï¼Œç”Ÿæˆé•¿åº¦ä¸º $L$ çš„åºåˆ—ï¼Œæ€»è®¡ç®—é‡ä¸ºï¼š</p>
<p>\begin{equation}
\text{Total FLOPs} = \sum_{t=1}^{L} \mathcal{O}(t \cdot hd_k) = \mathcal{O}(L^2hd_k)
\tag{10}
\end{equation}</p>
<p>ä½¿ç”¨KV Cacheåï¼Œæ¯æ­¥åªéœ€è®¡ç®—æ–°tokençš„KVï¼š</p>
<p>\begin{equation}
\text{Total FLOPs (cached)} = \sum_{t=1}^{L} \mathcal{O}(hd_k) = \mathcal{O}(Lhd_k)
\tag{11}
\end{equation}</p>
<p><strong>åŠ é€Ÿæ¯”</strong>:</p>
<p>\begin{equation}
\text{Speedup} = \frac{\mathcal{O}(L^2hd_k)}{\mathcal{O}(Lhd_k)} = \mathcal{O}(L)
\tag{12}
\end{equation}</p>
<h4 id="22-mhakv-cache">2.2 MHAçš„KV Cacheå†…å­˜å ç”¨</h4>
<p>å¯¹äºMHAï¼Œæ¯å±‚éœ€è¦ç¼“å­˜ $h$ ä¸ªå¤´çš„Kå’ŒVçŸ©é˜µã€‚å¯¹äºé•¿åº¦ä¸º $L$ çš„åºåˆ—ï¼š</p>
<p>å•å±‚KV Cacheå¤§å°ï¼š</p>
<p>\begin{equation}
\text{Cache}_{\text{MHA}} = 2 \times h \times L \times d_k \times \text{sizeof(dtype)}
\tag{13}
\end{equation}</p>
<p>å¯¹äºLLAMA2-7B ($d=4096, h=32, d_k=128$)ï¼Œä½¿ç”¨FP16 (2å­—èŠ‚)ï¼š</p>
<p>\begin{equation}
\text{Cache}_{\text{MHA}}^{\text{per layer}} = 2 \times 32 \times L \times 128 \times 2 = 16384L \text{ bytes} = 16L \text{ KB}
\tag{14}
\end{equation}</p>
<p>LLAMA2-7Bæœ‰32å±‚ï¼Œæ€»KV Cacheï¼š</p>
<p>\begin{equation}
\text{Total Cache} = 32 \times 16L = 512L \text{ KB} = 0.5L \text{ MB}
\tag{15}
\end{equation}</p>
<p><strong>ç¤ºä¾‹</strong>: å¯¹äº $L=4096$ çš„ä¸Šä¸‹æ–‡ï¼š
- å•å±‚: $16 \times 4096 = 65536$ KB = 64 MB
- 32å±‚æ€»è®¡: $32 \times 64 = 2048$ MB = 2 GB</p>
<p>å¯¹äº $L=32768$ (32Kä¸Šä¸‹æ–‡):
- æ€»KV Cache: $0.5 \times 32768 = 16384$ MB = 16 GB</p>
<h4 id="23-kv-cache">2.3 KV Cacheçš„ç“¶é¢ˆåˆ†æ</h4>
<p><strong>å†…å­˜å¸¦å®½ç“¶é¢ˆ</strong>: å‡è®¾GPUæœ‰å¸¦å®½ $B$ (ä¾‹å¦‚A100çš„HBMå¸¦å®½ä¸º1.5 TB/s)ï¼Œæ¯æ¬¡ç”Ÿæˆéœ€è¦è¯»å–çš„KV Cacheå¤§å°ä¸º $S_{\text{cache}}$ï¼Œåˆ™ç”Ÿæˆä¸€ä¸ªtokençš„æœ€å°æ—¶é—´ä¸ºï¼š</p>
<p>\begin{equation}
t_{\text{min}} = \frac{S_{\text{cache}}}{B}
\tag{16}
\end{equation}</p>
<p>å¯¹äºLLAMA2-7Bï¼Œ$L=4096$æ—¶ $S_{\text{cache}} = 2$ GBï¼š</p>
<p>\begin{equation}
t_{\text{min}} = \frac{2 \text{ GB}}{1.5 \text{ TB/s}} = \frac{2}{1500} \text{ s} \approx 1.33 \text{ ms}
\tag{17}
\end{equation}</p>
<p><strong>ååé‡é™åˆ¶</strong>: å‡è®¾batch sizeä¸º $B_s$ï¼Œæ¯ä¸ªè¯·æ±‚çš„å¹³å‡åºåˆ—é•¿åº¦ä¸º $\bar{L}$ï¼ŒGPUæ˜¾å­˜ä¸º $M$ï¼Œåˆ™æœ€å¤§batch sizeå—é™äºï¼š</p>
<p>\begin{equation}
B_s \leq \frac{M - M_{\text{model}}}{N_{\text{layer}} \times \text{Cache}_{\text{MHA}}(\bar{L})}
\tag{18}
\end{equation}</p>
<p>å…¶ä¸­ $M_{\text{model}}$ æ˜¯æ¨¡å‹å‚æ•°å ç”¨çš„æ˜¾å­˜ã€‚</p>
<p><strong>æ•°å€¼ç¤ºä¾‹</strong>: A100 80GBï¼ŒLLAMA2-7B (FP16çº¦14GB)ï¼Œ$\bar{L}=2048$ï¼š</p>
<p>\begin{equation}
B_s \leq \frac{80 - 14}{32 \times 0.5 \times 2048 / 1024} = \frac{66}{32} \approx 2
\tag{19}
\end{equation}</p>
<h3 id="mqa-multi-query-attention">ä¸‰ã€MQA (Multi-Query Attention) çš„æ•°å­¦æ¨å¯¼</h3>
<h4 id="31-mqa">3.1 MQAçš„åŠ¨æœºä¸æ•°å­¦å®šä¹‰</h4>
<p>MQAçš„æ ¸å¿ƒæ€æƒ³æ˜¯è®©æ‰€æœ‰å¤´å…±äº«åŒä¸€ç»„Kå’ŒVï¼š</p>
<p>\begin{equation}
\boldsymbol{o}<em i="1">t^{(s)} = \sum</em>}^{t} \frac{\exp\left(\boldsymbol{q<em j="1">t^{(s)} \boldsymbol{k}_i^\top / \sqrt{d_k}\right)}{\sum</em>_i
\tag{20}
\end{equation}}^{t} \exp\left(\boldsymbol{q}_t^{(s)} \boldsymbol{k}_j^\top / \sqrt{d_k}\right)} \boldsymbol{v</p>
<p>æ³¨æ„è¿™é‡Œ $\boldsymbol{k}_i$ å’Œ $\boldsymbol{v}_i$ æ²¡æœ‰ä¸Šæ ‡ $(s)$ï¼Œå³æ‰€æœ‰å¤´å…±äº«ã€‚</p>
<p><strong>å‚æ•°å¯¹æ¯”</strong>:
- MHA: $h$ ä¸ª $\boldsymbol{W}_q^{(s)}$ï¼Œ$h$ ä¸ª $\boldsymbol{W}_k^{(s)}$ï¼Œ$h$ ä¸ª $\boldsymbol{W}_v^{(s)}$
- MQA: $h$ ä¸ª $\boldsymbol{W}_q^{(s)}$ï¼Œ1 ä¸ª $\boldsymbol{W}_k$ï¼Œ1 ä¸ª $\boldsymbol{W}_v$</p>
<h4 id="32-mqakv-cache">3.2 MQAçš„KV Cacheå‹ç¼©æ¯”</h4>
<p>å•å±‚KV Cacheï¼š</p>
<p>\begin{equation}
\text{Cache}_{\text{MQA}} = 2 \times 1 \times L \times d_k \times \text{sizeof(dtype)}
\tag{21}
\end{equation}</p>
<p>å‹ç¼©æ¯”ï¼š</p>
<p>\begin{equation}
\text{Compression Ratio} = \frac{\text{Cache}<em _text_MQA="\text{MQA">{\text{MHA}}}{\text{Cache}</em> = h
\tag{22}
\end{equation}}}} = \frac{2hLd_k}{2Ld_k</p>
<p><strong>æ•°å€¼ç¤ºä¾‹</strong>: å¯¹äºLLAMA2-7B ($h=32$)ï¼ŒKV Cacheå‡å°‘åˆ°åŸæ¥çš„ $1/32$ï¼š
- $L=4096$: MHA 2GB â†’ MQA 64MB
- $L=32768$: MHA 16GB â†’ MQA 512MB</p>
<h4 id="33-mqa">3.3 MQAçš„è¡¨è¾¾èƒ½åŠ›åˆ†æ</h4>
<p><strong>ç§©çš„è§’åº¦</strong>: MHAçš„è¾“å‡ºå¯ä»¥å†™æˆï¼š</p>
<p>\begin{equation}
\boldsymbol{O}<em s="1">{\text{MHA}} = \sum</em>
\tag{23}
\end{equation}}^{h} \boldsymbol{A}^{(s)} \boldsymbol{V}^{(s)</p>
<p>å…¶ä¸­ $\boldsymbol{A}^{(s)} \in \mathbb{R}^{l \times l}$ æ˜¯æ³¨æ„åŠ›çŸ©é˜µã€‚ç†è®ºç§©æœ€é«˜ä¸º $\min(hd_v, l)$ã€‚</p>
<p>MQAçš„è¾“å‡ºï¼š</p>
<p>\begin{equation}
\boldsymbol{O}<em s="1">{\text{MQA}} = \left(\sum</em>
\tag{24}
\end{equation}}^{h} \boldsymbol{A}^{(s)}\right) \boldsymbol{V</p>
<p>ç†è®ºç§©æœ€é«˜ä¸º $\min(d_v, l)$ï¼Œé™ä½äº† $h$ å€ã€‚</p>
<p><strong>å®¹é‡æŸå¤±</strong>: MQAç›¸å½“äºå¼ºåˆ¶äº†ä¸€ä¸ªä½ç§©çº¦æŸï¼Œå¯èƒ½é™ä½æ¨¡å‹çš„è¡¨è¾¾èƒ½åŠ›ã€‚å®éªŒè¡¨æ˜å¯¹äºå¤§å¤šæ•°ä»»åŠ¡æŸå¤±æœ‰é™ã€‚</p>
<h4 id="34-mqa">3.4 MQAçš„å‚æ•°é‡å˜åŒ–</h4>
<p>MHAå‚æ•°é‡ï¼š</p>
<p>\begin{equation}
P_{\text{MHA}} = h(d \times d_k + d \times d_k + d \times d_v) + hd_v \times d
\tag{25}
\end{equation}</p>
<p>å½“ $d_k = d_v = d/h$ æ—¶ï¼š</p>
<p>\begin{equation}
P_{\text{MHA}} = 3d^2 + d^2 = 4d^2
\tag{26}
\end{equation}</p>
<p>MQAå‚æ•°é‡ï¼š</p>
<p>\begin{equation}
P_{\text{MQA}} = hd \times d_k + d \times d_k + d \times d_v + hd_v \times d
\tag{27}
\end{equation}</p>
<p>\begin{equation}
P_{\text{MQA}} = d^2 + 2d \times \frac{d}{h} + d^2 = 2d^2 + \frac{2d^2}{h}
\tag{28}
\end{equation}</p>
<p>å‚æ•°å‡å°‘é‡ï¼š</p>
<p>\begin{equation}
\Delta P = 4d^2 - (2d^2 + \frac{2d^2}{h}) = 2d^2(1 - \frac{1}{h}) \approx 2d^2
\tag{29}
\end{equation}</p>
<p><strong>è¡¥å¿ç­–ç•¥</strong>: ä¸ºä¿æŒæ€»å‚æ•°é‡ä¸å˜ï¼Œé€šå¸¸å¢å¤§FFNçš„éšè—å±‚ç»´åº¦ã€‚</p>
<h3 id="gqa-grouped-query-attention">å››ã€GQA (Grouped-Query Attention) çš„æ•°å­¦æ¨å¯¼</h3>
<h4 id="41-gqa">4.1 GQAçš„åˆ†ç»„æœºåˆ¶</h4>
<p>GQAå°† $h$ ä¸ªå¤´åˆ†æˆ $g$ ç»„ï¼Œæ¯ç»„å…±äº«ä¸€ç»„Kå’ŒVã€‚è®¾æ¯ç»„æœ‰ $h/g$ ä¸ªå¤´ï¼š</p>
<p>\begin{equation}
\boldsymbol{o}<em i="1">t^{(s)} = \sum</em>, \quad s = 1, 2, \ldots, h
\tag{30}
\end{equation}}^{t} \alpha_{t,i}^{(s)} \boldsymbol{v}_i^{(\lceil sg/h \rceil)</p>
<p>å…¶ä¸­ $\lceil sg/h \rceil$ æ˜¯ç¬¬ $s$ ä¸ªå¤´æ‰€å±çš„ç»„ç´¢å¼•ã€‚</p>
<p><strong>ç¤ºä¾‹</strong>: $h=8, g=2$:
- ç»„1: å¤´1,2,3,4 å…±äº« $\boldsymbol{k}^{(1)}, \boldsymbol{v}^{(1)}$
- ç»„2: å¤´5,6,7,8 å…±äº« $\boldsymbol{k}^{(2)}, \boldsymbol{v}^{(2)}$</p>
<h4 id="42-gqakv-cache">4.2 GQAçš„KV Cacheåˆ†æ</h4>
<p>å•å±‚KV Cacheï¼š</p>
<p>\begin{equation}
\text{Cache}_{\text{GQA}} = 2 \times g \times L \times d_k \times \text{sizeof(dtype)}
\tag{31}
\end{equation}</p>
<p>å‹ç¼©æ¯”ï¼š</p>
<p>\begin{equation}
\text{Compression Ratio} = \frac{\text{Cache}<em _text_GQA="\text{GQA">{\text{MHA}}}{\text{Cache}</em>
\tag{32}
\end{equation}}}} = \frac{h}{g</p>
<p><strong>å‚æ•°åŒ–</strong>:
- $g=h$: GQAé€€åŒ–ä¸ºMHA (æ— å‹ç¼©)
- $g=1$: GQAé€€åŒ–ä¸ºMQA (æœ€å¤§å‹ç¼©)
- $1 &lt; g &lt; h$: ä¸­é—´çŠ¶æ€ï¼Œå¹³è¡¡æ•ˆæœä¸æ•ˆç‡</p>
<h4 id="43-llama2-70bgqa">4.3 LLAMA2-70Bçš„GQAé…ç½®åˆ†æ</h4>
<p>LLAMA2-70Bä½¿ç”¨ $g=8$ çš„GQAé…ç½®ï¼š
- $h=64$ (64ä¸ªå¤´)
- $g=8$ (8ç»„)
- æ¯ç»„ $64/8 = 8$ ä¸ªå¤´</p>
<p><strong>å†…å­˜èŠ‚çœ</strong>:</p>
<p>\begin{equation}
\text{Saving} = 1 - \frac{g}{h} = 1 - \frac{8}{64} = 87.5\%
\tag{33}
\end{equation}</p>
<p><strong>åˆ†å¸ƒå¼æ¨ç†ä¼˜åŠ¿</strong>: 8ç»„KVæ­£å¥½å¯¹åº”8å¼ GPUå¡ï¼Œæ¯å¼ å¡è´Ÿè´£ä¸€ç»„ï¼š</p>
<p>\begin{equation}
\text{Per-GPU Cache} = \frac{\text{Cache}_{\text{GQA}}}{8} = \frac{2gLd_k}{8} = \frac{Ld_k}{4} \times \text{sizeof(dtype)}
\tag{34}
\end{equation}</p>
<p>è¿™é¿å…äº†è·¨å¡é€šä¿¡KV Cacheçš„å¼€é”€ã€‚</p>
<h4 id="44-gqa">4.4 GQAçš„ä½ç§©åˆ†è§£è§†è§’</h4>
<p>å°†GQAçš„æ‰€æœ‰Kå’ŒVæ‹¼æ¥ï¼š</p>
<p>\begin{equation}
\boldsymbol{C} = [\boldsymbol{k}^{(1)}, \ldots, \boldsymbol{k}^{(g)}, \boldsymbol{v}^{(1)}, \ldots, \boldsymbol{v}^{(g)}] \in \mathbb{R}^{l \times g(d_k + d_v)}
\tag{35}
\end{equation}</p>
<p>å¯ä»¥å†™æˆä½ç§©æŠ•å½±ï¼š</p>
<p>\begin{equation}
\boldsymbol{C} = \boldsymbol{X} \boldsymbol{W}_c
\tag{36}
\end{equation}</p>
<p>å…¶ä¸­ $\boldsymbol{W}_c \in \mathbb{R}^{d \times g(d_k + d_v)}$ã€‚</p>
<p><strong>ç§©çº¦æŸ</strong>: ç”±äº $g(d_k + d_v) &lt; h(d_k + d_v) = d$ (é€šå¸¸æƒ…å†µ)ï¼Œè¿™æ˜¯ä¸€ä¸ªç§©ä¸º $g(d_k + d_v)$ çš„ä½ç§©çŸ©é˜µã€‚</p>
<h3 id="mla-multi-head-latent-attention">äº”ã€MLA (Multi-head Latent Attention) çš„æ·±å…¥æ¨å¯¼</h3>
<h4 id="51-mla">5.1 MLAçš„æ ¸å¿ƒæ€æƒ³ï¼šä½ç§©æŠ•å½±</h4>
<p>MLAçš„å…³é”®æ´å¯Ÿæ˜¯ï¼šGQAçš„åˆ†å‰²å’Œå¤åˆ¶æ“ä½œå¯ä»¥ç”¨æ›´ä¸€èˆ¬çš„çº¿æ€§å˜æ¢æ›¿ä»£ã€‚</p>
<p><strong>GQAçš„æ“ä½œ</strong>:
1. æŠ•å½±åˆ°ä½ç»´: $\boldsymbol{c}_i = \boldsymbol{x}_i \boldsymbol{W}_c \in \mathbb{R}^{d_c}$
2. åˆ†å‰²: å°† $\boldsymbol{c}_i$ åˆ†æˆ $g$ ä»½
3. å¤åˆ¶: æ¯ä»½å¤åˆ¶ $h/g$ æ¬¡
4. çº¿æ€§å˜æ¢å¾—åˆ°Kå’ŒV</p>
<p><strong>MLAçš„æ”¹è¿›</strong>: ç”¨å¯å­¦ä¹ çš„çº¿æ€§å˜æ¢æ›¿ä»£å›ºå®šçš„åˆ†å‰²å’Œå¤åˆ¶ï¼š</p>
<p>\begin{equation}
\boldsymbol{k}_i^{(s)} = \boldsymbol{c}_i \boldsymbol{W}_k^{(s)}, \quad \boldsymbol{v}_i^{(s)} = \boldsymbol{c}_i \boldsymbol{W}_v^{(s)}
\tag{37}
\end{equation}</p>
<p>å…¶ä¸­ $\boldsymbol{W}_k^{(s)} \in \mathbb{R}^{d_c \times d_k}$, $\boldsymbol{W}_v^{(s)} \in \mathbb{R}^{d_c \times d_v}$ã€‚</p>
<h4 id="52-mla">5.2 MLAçš„æ’ç­‰å˜æ¢æŠ€å·§</h4>
<p><strong>è®­ç»ƒé˜¶æ®µ</strong>: æ­£å¸¸è®¡ç®—æ³¨æ„åŠ›</p>
<p>\begin{equation}
\boldsymbol{q}_t^{(s)} \boldsymbol{k}_i^{(s)\top} = (\boldsymbol{x}_t \boldsymbol{W}_q^{(s)}) (\boldsymbol{c}_i \boldsymbol{W}_k^{(s)})^\top
\tag{38}
\end{equation}</p>
<p><strong>æ¨ç†é˜¶æ®µçš„æ’ç­‰å˜æ¢</strong>:</p>
<p>\begin{equation}
\boldsymbol{q}_t^{(s)} \boldsymbol{k}_i^{(s)\top} = \boldsymbol{x}_t (\boldsymbol{W}_q^{(s)} \boldsymbol{W}_k^{(s)\top}) \boldsymbol{c}_i^\top
\tag{39}
\end{equation}</p>
<p>å®šä¹‰åˆå¹¶çŸ©é˜µï¼š</p>
<p>\begin{equation}
\boldsymbol{W}_{qk}^{(s)} = \boldsymbol{W}_q^{(s)} \boldsymbol{W}_k^{(s)\top} \in \mathbb{R}^{d \times d_c}
\tag{40}
\end{equation}</p>
<p>åˆ™ï¼š</p>
<p>\begin{equation}
\boldsymbol{q}<em qk="qk">t^{(s)} \boldsymbol{k}_i^{(s)\top} = (\boldsymbol{x}_t \boldsymbol{W}</em>_i^\top
\tag{41}
\end{equation}}^{(s)}) \boldsymbol{c</p>
<p><strong>å…³é”®æ´å¯Ÿ</strong>: KV Cacheåªéœ€è¦å­˜ $\boldsymbol{c}_i \in \mathbb{R}^{d_c}$ï¼Œè€Œä¸æ˜¯ $h$ ä¸ª $\boldsymbol{k}_i^{(s)} \in \mathbb{R}^{d_k}$ å’Œ $\boldsymbol{v}_i^{(s)} \in \mathbb{R}^{d_v}$ï¼</p>
<h4 id="53-mlakv-cache">5.3 MLAçš„KV Cacheå¤§å°</h4>
<p>å•å±‚KV Cache (ä¸å«RoPEéƒ¨åˆ†):</p>
<p>\begin{equation}
\text{Cache}_{\text{MLA}}^{\text{base}} = L \times d_c \times \text{sizeof(dtype)}
\tag{42}
\end{equation}</p>
<p>DeepSeek-V2è®¾ç½® $d_c = 512$ï¼Œç›¸æ¯”MHAçš„ $h \times d_k = 32 \times 128 = 4096$ï¼Œå‹ç¼©æ¯”ä¸ºï¼š</p>
<p>\begin{equation}
\text{Compression} = \frac{4096}{512} = 8\times
\tag{43}
\end{equation}</p>
<h4 id="54-mlarope">5.4 MLAä¸RoPEçš„å…¼å®¹æ€§é—®é¢˜</h4>
<p><strong>çŸ›ç›¾</strong>: RoPEéœ€è¦åœ¨Kå’ŒQä¸Šåº”ç”¨ä½ç½®ç›¸å…³çš„æ—‹è½¬çŸ©é˜µï¼š</p>
<p>\begin{equation}
\boldsymbol{q}_t^{(s)} = \boldsymbol{x}_t \boldsymbol{W}_q^{(s)} \boldsymbol{\mathcal{R}}_t, \quad \boldsymbol{k}_i^{(s)} = \boldsymbol{c}_i \boldsymbol{W}_k^{(s)} \boldsymbol{\mathcal{R}}_i
\tag{44}
\end{equation}</p>
<p>æ­¤æ—¶ï¼š</p>
<p>\begin{equation}
\boldsymbol{q}<em t-i="t-i">t^{(s)} \boldsymbol{k}_i^{(s)\top} = \boldsymbol{x}_t \boldsymbol{W}_q^{(s)} \boldsymbol{\mathcal{R}}_t \boldsymbol{\mathcal{R}}_i^\top \boldsymbol{W}_k^{(s)\top} \boldsymbol{c}_i^\top = \boldsymbol{x}_t \boldsymbol{W}_q^{(s)} \boldsymbol{\mathcal{R}}</em>_i^\top
\tag{45}
\end{equation}} \boldsymbol{W}_k^{(s)\top} \boldsymbol{c</p>
<p>ç”±äº $\boldsymbol{\mathcal{R}}_{t-i}$ ä¾èµ–äºä½ç½®å·®ï¼Œæ— æ³•é¢„å…ˆåˆå¹¶åˆ°æŠ•å½±çŸ©é˜µä¸­ï¼</p>
<h4 id="55-mla">5.5 MLAçš„æ··åˆè§£å†³æ–¹æ¡ˆ</h4>
<p><strong>æ–¹æ¡ˆ</strong>: å°†Qå’ŒKåˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š</p>
<ol>
<li>
<p><strong>ä½ç§©éƒ¨åˆ†</strong> (ä¸åŠ RoPE): ç»´åº¦ $d_k$
\begin{equation}
\boldsymbol{q}<em qc="qc">{t,c}^{(s)} = \boldsymbol{x}_t \boldsymbol{W}</em>}^{(s)}, \quad \boldsymbol{k<em kc="kc">{i,c}^{(s)} = \boldsymbol{c}_i \boldsymbol{W}</em>
\tag{46}
\end{equation}}^{(s)</p>
</li>
<li>
<p><strong>RoPEéƒ¨åˆ†</strong> (å…±äº«): ç»´åº¦ $d_r$
\begin{equation}
\boldsymbol{q}<em qr="qr">{t,r}^{(s)} = \boldsymbol{x}_t \boldsymbol{W}</em>}^{(s)} \boldsymbol{\mathcal{R}<em i_r="i,r">t, \quad \boldsymbol{k}</em>} = \boldsymbol{x<em kr="kr">i \boldsymbol{W}</em>_i
\tag{47}
\end{equation}} \boldsymbol{\mathcal{R}</p>
</li>
</ol>
<p>æ³¨æ„ $\boldsymbol{k}_{i,r}$ æ‰€æœ‰å¤´å…±äº« (æ— ä¸Šæ ‡$(s)$)ã€‚</p>
<p><strong>æœ€ç»ˆçš„Qå’ŒK</strong>:</p>
<p>\begin{equation}
\boldsymbol{q}<em t_c="t,c">t^{(s)} = [\boldsymbol{q}</em>
\tag{48}
\end{equation}}^{(s)}, \boldsymbol{q}_{t,r}^{(s)}] \in \mathbb{R}^{d_k + d_r</p>
<p>\begin{equation}
\boldsymbol{k}<em i_c="i,c">i^{(s)} = [\boldsymbol{k}</em>
\tag{49}
\end{equation}}^{(s)}, \boldsymbol{k}_{i,r}] \in \mathbb{R}^{d_k + d_r</p>
<h4 id="56-mlakv-cache">5.6 MLAçš„æœ€ç»ˆKV Cache</h4>
<p>éœ€è¦ç¼“å­˜ï¼š
1. $\boldsymbol{c}<em i_r="i,r">i \in \mathbb{R}^{d_c}$ (ä½ç§©éƒ¨åˆ†)
2. $\boldsymbol{k}</em>$ (RoPEéƒ¨åˆ†ï¼Œæ‰€æœ‰å¤´å…±äº«)} \in \mathbb{R}^{d_r</p>
<p>å•å±‚æ€»KV Cacheï¼š</p>
<p>\begin{equation}
\text{Cache}_{\text{MLA}} = L \times (d_c + d_r) \times \text{sizeof(dtype)}
\tag{50}
\end{equation}</p>
<p>DeepSeek-V2: $d_c = 512, d_r = 64$:</p>
<p>\begin{equation}
\text{Cache}_{\text{MLA}} = L \times 576 \times 2 = 1152L \text{ bytes}
\tag{51}
\end{equation}</p>
<p>ç›¸æ¯”MHAçš„ $2 \times 32 \times 128 \times L \times 2 = 16384L$ å­—èŠ‚:</p>
<p>\begin{equation}
\text{Compression} = \frac{16384}{1152} \approx 14.2\times
\tag{52}
\end{equation}</p>
<h4 id="57-mlaq">5.7 MLAçš„ä½ç§©æŠ•å½±Q</h4>
<p>ä¸ºå‡å°‘è®­ç»ƒæ—¶çš„æ¿€æ´»å†…å­˜ï¼ŒMLAä¹Ÿå¯¹Qä½¿ç”¨ä½ç§©æŠ•å½±ï¼š</p>
<p>\begin{equation}
\boldsymbol{c}_i' = \boldsymbol{x}_i \boldsymbol{W}_c' \in \mathbb{R}^{d_c'}
\tag{53}
\end{equation}</p>
<p>\begin{equation}
\boldsymbol{q}<em qc="qc">i^{(s)} = [\boldsymbol{c}_i' \boldsymbol{W}</em>}^{(s)}, \boldsymbol{c<em qr="qr">i' \boldsymbol{W}</em>_i]
\tag{54}
\end{equation}}^{(s)} \boldsymbol{\mathcal{R}</p>
<p>DeepSeek-V2: $d_c' = 1536$ï¼Œç›¸æ¯” $d = 5120$ èŠ‚çœçº¦ 70% çš„QæŠ•å½±å‚æ•°ã€‚</p>
<h4 id="58-mla">5.8 MLAæ¨ç†æ—¶çš„è®¡ç®—é‡åˆ†æ</h4>
<p><strong>Prefillé˜¶æ®µ</strong> (è®­ç»ƒæ¨¡å¼):
- QKVæŠ•å½±: $\mathcal{O}(Ld \cdot d_c') + \mathcal{O}(Lhd_c' \cdot d_k) + \mathcal{O}(Lhd_c \cdot d_v)$
- æ³¨æ„åŠ›è®¡ç®—: $\mathcal{O}(L^2h(d_k + d_r))$</p>
<p><strong>Generationé˜¶æ®µ</strong> (æ¨ç†æ¨¡å¼):
- Qè®¡ç®—: $\mathcal{O}(h \cdot d_c \cdot d_k)$ (é€šè¿‡ $\boldsymbol{W}<em qc="qc">{qk}^{(s)} = \boldsymbol{W}</em>$)
- æ³¨æ„åŠ›è®¡ç®—: $\mathcal{O}(Lh(d_c + d_r))$}^{(s)} \boldsymbol{W}_{kc}^{(s)\top</p>
<p><strong>ç›¸æ¯”MHAçš„å˜åŒ–</strong>:
- è®¡ç®—é‡å¢åŠ : head sizeä» $d_k$ å˜ä¸º $d_c + d_r = 512 + 64 = 576$ (4.5å€)
- ä½†å†…å­˜å¸¦å®½å‡å°‘: KV Cacheå‡å°‘14å€</p>
<p>ç”±äºGenerationæ˜¯å†…å­˜å¸¦å®½ç“¶é¢ˆï¼ŒMLAä»ç„¶è·å¾—æ˜¾è‘—åŠ é€Ÿã€‚</p>
<h3 id="-">å…­ã€æ€§èƒ½-æ•ˆç‡æƒè¡¡çš„ç†è®ºåˆ†æ</h3>
<h4 id="61">6.1 æ³¨æ„åŠ›æœºåˆ¶çš„è¡¨è¾¾èƒ½åŠ›</h4>
<p><strong>å®šç†</strong>: å¯¹äºåºåˆ—é•¿åº¦ä¸º $l$ çš„è¾“å…¥ï¼ŒMHAçš„è¾“å‡ºç©ºé—´ç»´åº¦æœ€å¤šä¸º $\min(l, hd_v)$ã€‚</p>
<p><strong>è¯æ˜</strong>: MHAçš„è¾“å‡ºä¸ºï¼š</p>
<p>\begin{equation}
\boldsymbol{O} = \text{Concat}\left(\sum_{i=1}^{l} \alpha_i^{(1)} \boldsymbol{v}<em i="1">i^{(1)}, \ldots, \sum</em>\right)
\tag{55}
\end{equation}}^{l} \alpha_i^{(h)} \boldsymbol{v}_i^{(h)</p>
<p>æ¯ä¸ªå¤´çš„è¾“å‡ºæ˜¯ $l$ ä¸ªå‘é‡çš„å‡¸ç»„åˆï¼Œå› æ­¤æœ€å¤šæœ‰ $l$ ä¸ªçº¿æ€§ç‹¬ç«‹çš„è¾“å‡ºã€‚æ€»å…± $h$ ä¸ªå¤´ï¼Œæ¯ä¸ªå¤´ç»´åº¦ $d_v$ï¼Œå› æ­¤æœ€å¤š $\min(l, hd_v)$ ç»´ã€‚â–¡</p>
<p><strong>æ¨è®º</strong>: MQAçš„è¾“å‡ºç©ºé—´ç»´åº¦æœ€å¤šä¸º $\min(l, d_v)$ï¼Œé™ä½äº† $h$ å€ã€‚</p>
<h4 id="62-kv-cachetrade-off">6.2 KV Cacheå‹ç¼©ä¸å®¹é‡çš„trade-off</h4>
<p>å®šä¹‰<strong>æœ‰æ•ˆå®¹é‡</strong> $C$ ä¸ºæ¨¡å‹èƒ½å¤Ÿå»ºæ¨¡çš„ç‹¬ç«‹æ¨¡å¼æ•°é‡ï¼š</p>
<p>\begin{equation}
C_{\text{MHA}} \propto hd_v, \quad C_{\text{MQA}} \propto d_v, \quad C_{\text{GQA}} \propto gd_v
\tag{56}
\end{equation}</p>
<p>å®šä¹‰<strong>æ•ˆç‡</strong> $E$ ä¸ºå•ä½å†…å­˜çš„ååé‡ï¼š</p>
<p>\begin{equation}
E \propto \frac{1}{\text{Cache Size}}
\tag{57}
\end{equation}</p>
<p><strong>Paretoå‰æ²¿</strong>:</p>
<p>\begin{equation}
C \times E = \text{constant}
\tag{58}
\end{equation}</p>
<p>GQAé€šè¿‡å‚æ•° $g$ åœ¨Paretoå‰æ²¿ä¸Šæ»‘åŠ¨ï¼Œé€‰æ‹©æœ€ä¼˜çš„å®¹é‡-æ•ˆç‡å¹³è¡¡ç‚¹ã€‚</p>
<h4 id="63">6.3 æ•°å€¼ç¤ºä¾‹ï¼šä¸åŒæ–¹æ¡ˆçš„å¯¹æ¯”</h4>
<p>å‡è®¾ $d=4096, h=32, d_k=d_v=128, L=4096$:</p>
<table>
<thead>
<tr>
<th>æ–¹æ¡ˆ</th>
<th>KV Cache (MB)</th>
<th>æœ‰æ•ˆå®¹é‡</th>
<th>æ¨ç†åå (ç›¸å¯¹)</th>
</tr>
</thead>
<tbody>
<tr>
<td>MHA</td>
<td>2048</td>
<td>$32 \times 128 = 4096$</td>
<td>1.0Ã—</td>
</tr>
<tr>
<td>GQA-8</td>
<td>256</td>
<td>$8 \times 128 = 1024$</td>
<td>8.0Ã—</td>
</tr>
<tr>
<td>MQA</td>
<td>64</td>
<td>$128$</td>
<td>32Ã—</td>
</tr>
<tr>
<td>MLA</td>
<td>144</td>
<td>$\approx 1536$ (æœ‰æ•ˆ)</td>
<td>14.2Ã—</td>
</tr>
</tbody>
</table>
<p><strong>ç»“è®º</strong>: MLAåœ¨å‡ ä¹ä¸æŸå¤±å®¹é‡çš„æƒ…å†µä¸‹ï¼Œè·å¾—äº†æ¥è¿‘MQAçš„æ•ˆç‡æå‡ã€‚</p>
<h3 id="_4">ä¸ƒã€å®è·µå»ºè®®ä¸æ•°å€¼éªŒè¯</h3>
<h4 id="71">7.1 é€‰æ‹©åˆé€‚çš„æ³¨æ„åŠ›æœºåˆ¶</h4>
<p><strong>å†³ç­–æ ‘</strong>:</p>
<ol>
<li><strong>å†…å­˜å……è¶³</strong> ($L &lt; 2048$): ä½¿ç”¨MHAï¼Œæœ€å¤§åŒ–æ¨¡å‹å®¹é‡</li>
<li><strong>ä¸­ç­‰åºåˆ—</strong> ($2048 \leq L \leq 8192$): ä½¿ç”¨GQA ($g=8$)ï¼Œå¹³è¡¡æ•ˆæœä¸æ•ˆç‡</li>
<li><strong>é•¿åºåˆ—</strong> ($L &gt; 8192$): ä½¿ç”¨MLAæˆ–MQAï¼Œä¼˜å…ˆèŠ‚çœå†…å­˜</li>
<li><strong>èµ„æºå—é™</strong>: ä½¿ç”¨MQAï¼Œæœ€å¤§åŒ–åå</li>
</ol>
<h4 id="72-gqa">7.2 GQAçš„ç»„æ•°é€‰æ‹©</h4>
<p>ç»éªŒå…¬å¼ï¼š</p>
<p>\begin{equation}
g = \min\left(\frac{M_{\text{avail}}}{M_{\text{target}}}, h\right)
\tag{59}
\end{equation}</p>
<p>å…¶ä¸­ $M_{\text{avail}}$ æ˜¯å¯ç”¨å†…å­˜ï¼Œ$M_{\text{target}}$ æ˜¯ç›®æ ‡KV Cacheå¤§å°ã€‚</p>
<p><strong>ç¤ºä¾‹</strong>: å¸Œæœ›KV Cacheä¸è¶…è¿‡1GBï¼Œ$L=8192$:</p>
<p>\begin{equation}
2gLd_k \times 2 \leq 1024 \text{ MB} \Rightarrow g \leq \frac{1024 \times 10^6}{2 \times 8192 \times 128 \times 2} \approx 12
\tag{60}
\end{equation}</p>
<p>é€‰æ‹© $g=8$ (æœ€æ¥è¿‘çš„2çš„å¹‚æ¬¡)ã€‚</p>
<h4 id="73-mla">7.3 MLAçš„å‚æ•°é…ç½®</h4>
<p><strong>ä½ç§©ç»´åº¦é€‰æ‹©</strong>: DeepSeek-V2çš„ç»éªŒæ˜¯ $d_c \approx d/10$:</p>
<p>\begin{equation}
d_c = \max\left(\frac{d}{10}, 512\right)
\tag{61}
\end{equation}</p>
<p><strong>RoPEç»´åº¦</strong>: é€šå¸¸å– $d_r = d_k / 2$:</p>
<p>\begin{equation}
d_r = \frac{d_k}{2} = \frac{d/h}{2}
\tag{62}
\end{equation}</p>
<p><strong>Qçš„ä½ç§©ç»´åº¦</strong>: çº¦ä¸ºKçš„3å€:</p>
<p>\begin{equation}
d_c' \approx 3d_c
\tag{63}
\end{equation}</p>
<h4 id="74">7.4 æ¨ç†ä¼˜åŒ–å®è·µ</h4>
<p><strong>é‡åŒ–</strong>: FP16 â†’ INT8å¯è¿›ä¸€æ­¥å‡å°‘2å€KV Cache:</p>
<p>\begin{equation}
\text{Cache}<em _text_FP16="\text{FP16">{\text{INT8}} = \frac{\text{Cache}</em>
\tag{64}
\end{equation}}}}{2</p>
<p><strong>åˆ†é¡µæ³¨æ„åŠ›</strong>: å°†KV Cacheåˆ†å—å­˜å‚¨ï¼Œå‡å°‘å†…å­˜ç¢ç‰‡ï¼š</p>
<p>\begin{equation}
\text{Efficiency} = \frac{L \times \text{Block Size}}{\lceil L / \text{Block Size} \rceil \times \text{Block Size}} \geq 90\%
\tag{65}
\end{equation}</p>
<p>æ¨èBlock Size = 64 æˆ– 128ã€‚</p>
<h3 id="_5">å…«ã€æ€»ç»“</h3>
<p>æœ¬æ–‡è¯¦ç»†æ¨å¯¼äº†ä»MHAåˆ°MLAçš„æ¼”å˜è¿‡ç¨‹ï¼Œå…³é”®å…¬å¼æ€»ç»“ï¼š</p>
<p><strong>KV Cacheå¤§å°</strong>:
\begin{equation}
\begin{cases}
\text{MHA}: &amp; 2hLd_k \
\text{MQA}: &amp; 2Ld_k \
\text{GQA}: &amp; 2gLd_k \
\text{MLA}: &amp; L(d_c + d_r)
\end{cases}
\tag{66}
\end{equation}</p>
<p><strong>å‹ç¼©æ¯”</strong>:
\begin{equation}
\text{Ratio}_{\text{MLA}} = \frac{2hd_k}{d_c + d_r} = \frac{2 \times 32 \times 128}{512 + 64} \approx 14.2\times
\tag{67}
\end{equation}</p>
<p><strong>æ¨ç†åŠ é€Ÿ</strong>:
\begin{equation}
\text{Speedup} \approx \text{Compression Ratio} \times \text{Bandwidth Factor}
\tag{68}
\end{equation}</p>
<p>MLAé€šè¿‡å·§å¦™çš„æ•°å­¦å˜æ¢ï¼Œåœ¨å‡ ä¹ä¸æŸå¤±æ¨¡å‹èƒ½åŠ›çš„å‰æä¸‹ï¼Œå®ç°äº†æ˜¾è‘—çš„å†…å­˜èŠ‚çœå’Œæ¨ç†åŠ é€Ÿï¼Œæ˜¯Transformeræ¨ç†ä¼˜åŒ–çš„é‡è¦é‡Œç¨‹ç¢‘ã€‚</p>
        </div>
    </div>
</body>
</html>