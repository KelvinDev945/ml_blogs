<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>â€œé—­é—¨é€ è½¦â€ä¹‹å¤šæ¨¡æ€æ€è·¯æµ…è°ˆï¼ˆä¸‰ï¼‰ï¼šä½ç½®ç¼–ç </title>
    <style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    line-height: 1.6; color: #333; max-width: 900px; margin: 0 auto; padding: 20px; background: #f5f5f5;
}
.container { background: white; padding: 40px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
header { border-bottom: 2px solid #e0e0e0; padding-bottom: 20px; margin-bottom: 30px; }
h1 { color: #2c3e50; margin-bottom: 10px; font-size: 2em; }
.meta { color: #666; font-size: 0.9em; margin-bottom: 20px; }
.content { margin-top: 30px; overflow-wrap: break-word; }
.content h2 { color: #34495e; margin-top: 30px; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
.content p { margin-bottom: 15px; }
.content pre { background: #f8f8f8; padding: 15px; border-radius: 5px; overflow-x: auto; border-left: 3px solid #3498db; margin: 15px 0; }
.content code { background: #f8f8f8; padding: 2px 5px; border-radius: 3px; font-family: monospace; font-size: 0.9em; }
.content blockquote { border-left: 4px solid #3498db; padding-left: 20px; margin: 20px 0; color: #555; font-style: italic; }
.content table { border-collapse: collapse; width: 100%; margin: 20px 0; }
.content th, .content td { border: 1px solid #ddd; padding: 10px; text-align: left; }
.back-link { display: inline-block; margin-bottom: 20px; color: #3498db; text-decoration: none; font-weight: 500; }
</style>
    
<script>
    window.MathJax = {
        tex: {
            inlineMath: [['$', '$'], ['\(', '\)']],
            displayMath: [['$$', '$$'], ['\[', '\]']],
            processEscapes: true
        }
    };
</script>
<script id="MathJax-script" async src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>

</head>
<body>
    <div class="container">
        <a href="../index.html" class="back-link">â† è¿”å›é¦–é¡µ</a>
        <header>
            <h1>â€œé—­é—¨é€ è½¦â€ä¹‹å¤šæ¨¡æ€æ€è·¯æµ…è°ˆï¼ˆä¸‰ï¼‰ï¼šä½ç½®ç¼–ç </h1>
            <div class="meta">ğŸ“… æœ€åæ›´æ–°: 2025-11-26 | ğŸ“„ å¤§å°: 37.9 KB</div>
        </header>
        <div class="content">
            <p><strong>åŸæ–‡é“¾æ¥</strong>: <a href="https://spaces.ac.cn/archives/10352">https://spaces.ac.cn/archives/10352</a></p>
<p><strong>å‘å¸ƒæ—¥æœŸ</strong>: </p>
<hr />
<p>åœ¨å‰é¢çš„æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬æ›¾è¡¨è¾¾è¿‡è¿™æ ·çš„è§‚ç‚¹ï¼šå¤šæ¨¡æ€LLMç›¸æ¯”çº¯æ–‡æœ¬LLMçš„ä¸»è¦å·®å¼‚åœ¨äºï¼Œå‰è€…ç”šè‡³è¿˜æ²¡æœ‰å½¢æˆä¸€ä¸ªå…¬è®¤ä¸ºæ ‡å‡†çš„æ–¹æ³•è®ºã€‚è¿™é‡Œçš„æ–¹æ³•è®ºï¼Œä¸ä»…åŒ…æ‹¬ä¹‹å‰è®¨è®ºçš„ç”Ÿæˆå’Œè®­ç»ƒç­–ç•¥ï¼Œè¿˜åŒ…æ‹¬ä¸€äº›åŸºç¡€æ¶æ„çš„è®¾è®¡ï¼Œæ¯”å¦‚æœ¬æ–‡è¦è°ˆçš„â€œå¤šæ¨¡æ€ä½ç½®ç¼–ç â€ã€‚</p>
<p>å¯¹äºè¿™ä¸ªä¸»é¢˜ï¼Œæˆ‘ä»¬ä¹‹å‰åœ¨<a href="/archives/10040">ã€ŠTransformerå‡çº§ä¹‹è·¯ï¼š17ã€å¤šæ¨¡æ€ä½ç½®ç¼–ç çš„ç®€å•æ€è€ƒã€‹</a>å°±å·²ç»è®¨è®ºè¿‡ä¸€éï¼Œå¹¶ä¸”æå‡ºäº†ä¸€ä¸ªæ–¹æ¡ˆï¼ˆRoPE-Tieï¼‰ã€‚ç„¶è€Œï¼Œå½“æ—¶ç¬”è€…å¯¹è¿™ä¸ªé—®é¢˜çš„æ€è€ƒä»…å¤„äºèµ·æ­¥é˜¶æ®µï¼Œå­˜åœ¨ç»†èŠ‚è€ƒè™‘ä¸å‘¨å…¨ã€è®¤è¯†ä¸å¤Ÿåˆ°ä½ç­‰é—®é¢˜ï¼Œæ‰€ä»¥ç«™åœ¨ç°åœ¨çš„è§’åº¦å›çœ‹ï¼Œå½“æ—¶æ‰€æçš„æ–¹æ¡ˆä¸å®Œç¾ç­”æ¡ˆè¿˜æœ‰æ˜æ˜¾çš„è·ç¦»ã€‚</p>
<p>å› æ­¤ï¼Œæœ¬æ–‡æˆ‘ä»¬å°†è‡ªä¸Šè€Œä¸‹åœ°å†æ¬¡æ¢³ç†è¿™ä¸ªé—®é¢˜ï¼Œå¹¶ä¸”ç»™å‡ºä¸€ä¸ªè‡ªè®¤ä¸ºæ›´åŠ ç†æƒ³çš„ç»“æœã€‚</p>
<h2 id="_1">å¤šæ¨¡ä½ç½®</h2>
<p>å¤šæ¨¡æ€æ¨¡å‹å±…ç„¶è¿ä½ç½®ç¼–ç éƒ½æ²¡æœ‰å½¢æˆå…±è¯†ï¼Œè¿™ä¸€ç‚¹å¯èƒ½ä¼šè®©å¾ˆå¤šè¯»è€…æ„å¤–ï¼Œä½†äº‹å®ä¸Šç¡®å®å¦‚æ­¤ã€‚å¯¹äºæ–‡æœ¬LLMï¼Œç›®å‰ä¸»æµçš„ä½ç½®ç¼–ç æ˜¯<a href="/archives/8265">RoPE</a>ï¼ˆRoPEå°±ä¸å±•å¼€ä»‹ç»äº†ï¼Œå‡è®¾è¯»è€…å·²ç»ç†ŸçŸ¥ï¼‰ï¼Œæ›´å‡†ç¡®æ¥è¯´æ˜¯RoPE-1Dï¼Œå› ä¸ºåŸå§‹è®¾è®¡åªé€‚ç”¨äº1Dåºåˆ—ã€‚åæ¥æˆ‘ä»¬æ¨å¯¼äº†<a href="/archives/8397">RoPE-2D</a>ï¼Œè¿™å¯ä»¥ç”¨äºå›¾åƒç­‰2Dåºåˆ—ï¼ŒæŒ‰ç…§RoPE-2Dçš„æ€è·¯æˆ‘ä»¬å¯ä»¥å¹³è¡Œåœ°æ¨å¹¿åˆ°RoPE-3Dï¼Œç”¨äºè§†é¢‘ç­‰3Dåºåˆ—ã€‚</p>
<p>ç„¶è€Œï¼Œä»¥ä¸Šè¯´çš„åªæ˜¯å•ä¸€æ¨¡æ€è¾“å…¥ï¼Œå½“å¤šç§æ¨¡æ€æ··åˆè¾“å…¥æ—¶ï¼Œå›°éš¾å°±å‡ºç°äº†ï¼šæ–‡æœ¬æ˜¯1Dåºåˆ—ï¼Œæ‰€ä»¥å®ƒçš„ä½ç½®åªæ˜¯ä¸€ä¸ªæ ‡é‡$n$ï¼›å›¾åƒæ˜¯2Dçš„ï¼ˆâ€œå®½â€å’Œâ€œé«˜â€ï¼‰ï¼Œæ‰€ä»¥è¡¨è¾¾å®ƒçš„ä½ç½®éœ€è¦ä¸€ä¸ªäºŒç»´å‘é‡$(x,y)$ï¼›è§†é¢‘åˆ™åœ¨å›¾åƒçš„åŸºç¡€ä¸Šæ–°å¢äº†ä¸€ä¸ªæ—¶é—´ç»´åº¦ï¼ˆæˆ–è€…è¯´â€œå¸§â€ï¼‰ï¼Œæ‰€ä»¥å®ƒçš„ä½ç½®æ˜¯ä¸€ä¸ªä¸‰ç»´å‘é‡$(x,y,z)$ã€‚å½“æˆ‘ä»¬å¸Œæœ›ç”¨åŒä¸€ä¸ªæ¨¡å‹å»å¤„ç†ä¸‰ç§æ¨¡æ€çš„æ•°æ®æ—¶ï¼Œå°±è¦æƒ³åŠæ³•ç³…åˆè¿™ä¸‰ç§ä¸åŒå½¢å¼çš„ä½ç½®ä¿¡æ¯ã€‚</p>
<p>å¤§å®¶éƒ½çŸ¥é“ï¼ŒRoPEåœ¨å®ç°ä¸Šæ˜¯ç»å¯¹ä½ç½®ç¼–ç ï¼Œä½†ç»“åˆåŸºäºå†…ç§¯çš„Attentionæ¥ç”¨æ—¶ï¼Œå†…ç§¯ä¹‹åä½ç½®ä¼šè‡ªåŠ¨ä½œå·®ï¼Œä»è€Œå®ç°äº†ç›¸å¯¹ä½ç½®ç¼–ç çš„æ•ˆæœã€‚å¯åŒä¸€å¤§å°çš„å‘é‡å¯ä»¥ä½œå·®ï¼Œä¸åŒå¤§å°çš„å‘é‡æ€ä¹ˆä½œå·®å‘¢ï¼Ÿè¿™å°±æ˜¯å¤šæ¨¡æ€ä½ç½®ç¼–ç çš„å›°éš¾æ‰€åœ¨ã€‚</p>
<p>ä¸å°‘å·¥ä½œé€‰æ‹©â€œé€ƒé¿â€è¿™ä¸ªå›°éš¾ï¼Œç›´æ¥Flattenæ‰€æœ‰æ¨¡æ€ç„¶åä½¿ç”¨RoPE-1Dï¼Œè¿™ä¸å¤±ä¸ºä¸€ç§è§£å†³åŠæ³•ï¼Œä½†ç»ˆç©¶æ˜¾å¾—ä¸å¤Ÿä¼˜é›…ã€‚æ­¤å¤–ï¼Œå¼ºè¡ŒFlattenä¹Ÿå¯èƒ½ä¼šé™ä½æ¨¡å‹æ€§èƒ½çš„å¤©èŠ±æ¿ï¼Œå› ä¸º<a href="https://papers.cool/arxiv/2403.00522">ã€ŠVisionLLaMA: A Unified LLaMA Backbone for Vision Tasksã€‹</a>ç­‰å·¥ä½œå·²ç»è¡¨æ˜ï¼ŒRoPE-2Dçš„å¼•å…¥æœ‰åŠ©äºæå‡æ¨¡å‹æ•ˆæœå°¤å…¶æ˜¯å˜åˆ†è¾¨ç‡è¾“å…¥çš„æ•ˆæœã€‚</p>
<h2 id="_2">å‘åå…¼å®¹</h2>
<p>æ‰€ä»¥ï¼Œæˆ‘ä»¬å¸Œæœ›è®¾è®¡ä¸€ç§å¤šæ¨¡æ€ä½ç½®ç¼–ç ï¼Œå®ƒæ—¢å¯ä»¥å¤šæ¨¡æ€æ··åˆä½¿ç”¨ï¼Œåœ¨å•æ¨¡æ€ä¸‹åˆèƒ½é€€åŒ–ä¸ºå¯¹åº”çš„RoPE-1D/2D/3Dï¼Œä»¥å……åˆ†è§£é”æ¯ä¸ªæ¨¡æ€çš„èƒ½åŠ›ã€‚</p>
<p>åˆšæ‰æˆ‘ä»¬è¯´ï¼Œå¤šæ¨¡æ€ä½ç½®ç¼–ç çš„ä¸»è¦å›°éš¾æ˜¯ä¸åŒå¤§å°çš„ä½ç½®å‘é‡æ— æ³•ä½œå·®ï¼Œæ—¢è¦ä¿ç•™å®Œæ•´çš„ä½ç½®ä¿¡æ¯åˆè¦å…è®¸ä½œå·®ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±åªèƒ½ç»Ÿä¸€å‡ç»´åˆ°æœ€é«˜ç»´åº¦ã€‚ä¸‹é¢æˆ‘ä»¬ä»¥ <em>å›¾æ–‡æ··åˆæ¨¡æ€</em> ä¸ºä¾‹ï¼Œç”±äºå›¾åƒæ˜¯2Dçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å°†æ–‡æœ¬çš„ä½ç½®ç¼–ç ä¹Ÿæå‡åˆ°äºŒç»´ï¼Œç„¶åç»Ÿä¸€ç”¨RoPE-2Dã€‚æ€ä¹ˆå‡ç»´éƒ½å¯ä»¥å—ï¼Ÿå¹¶ä¸æ˜¯ï¼Œæˆ‘ä»¬å¸Œæœ›å®ƒå…·æœ‰å‘åçš„<strong>å…¼å®¹æ€§</strong> ï¼Œå³å½“è¾“å…¥æ˜¯çº¯æ–‡æœ¬æ—¶ï¼Œå®ƒè·ŸRoPE-1Då®Œå…¨ç­‰ä»·ã€‚</p>
<p>ä¸ºæ­¤ï¼Œæˆ‘ä»¬å¯¹æ¯”ä¸€ä¸‹RoPE-1Dä¸RoPE-2Dï¼š<br />
$$\scriptsize{\begin{array}{c}\begin{array}{c}\text{RoPE-1D}\\\ (\boldsymbol{\mathcal{R}}_n)\end{array}= \begin{pmatrix}  
\cos \bbox[yellow]{n}\theta_0 & -\sin \bbox[yellow]{n}\theta_0 & 0 & 0 & \cdots & 0 & 0 & 0 & 0 \\\  
\sin \bbox[yellow]{n}\theta_0 & \cos \bbox[yellow]{n}\theta_0 & 0 & 0 & \cdots & 0 & 0 & 0 & 0 \\\  
0 & 0 & \cos \bbox[yellow]{n}\theta_1 & -\sin \bbox[yellow]{n}\theta_1 & \cdots & 0 & 0 & 0 & 0 \\\  
0 & 0 & \sin \bbox[yellow]{n}\theta_1 & \cos \bbox[yellow]{n}\theta_1 & \cdots & 0 & 0 & 0 & 0 \\\  
\vdots & \vdots & \vdots & \vdots & \ddots & \vdots & \vdots & \vdots & \vdots \\\  
0 & 0 & 0 & 0 & \cdots & \cos \bbox[yellow]{n}\theta_{d/2-2} & -\sin \bbox[yellow]{n}\theta_{d/2-2} & 0 & 0 \\\  
0 & 0 & 0 & 0 & \cdots & \sin \bbox[yellow]{n}\theta_{d/2-2} & \cos \bbox[yellow]{n}\theta_{d/2-2} & 0 & 0 \\\  
0 & 0 & 0 & 0 & \cdots & 0 & 0 & \cos \bbox[yellow]{n}\theta_{d/2-1} & -\sin \bbox[yellow]{n}\theta_{d/2-1} \\\  
0 & 0 & 0 & 0 & \cdots & 0 & 0 & \sin \bbox[yellow]{n}\theta_{d/2-1} & \cos \bbox[yellow]{n}\theta_{d/2-1} \\\  
\end{pmatrix} \\\\[16pt]  
\begin{array}{c}\text{RoPE-2D}\\\ (\boldsymbol{\mathcal{R}}_{x,y})\end{array}= \begin{pmatrix}  
\cos \bbox[yellow]{x}\theta_0 & -\sin \bbox[yellow]{x}\theta_0 & 0 & 0 & \cdots & 0 & 0 & 0 & 0 \\\  
\sin \bbox[yellow]{x}\theta_0 & \cos \bbox[yellow]{x}\theta_0 & 0 & 0 & \cdots & 0 & 0 & 0 & 0 \\\  
0 & 0 & \cos \bbox[yellow]{y}\theta_1 & -\sin \bbox[yellow]{y}\theta_1 & \cdots & 0 & 0 & 0 & 0 \\\  
0 & 0 & \sin \bbox[yellow]{y}\theta_1 & \cos \bbox[yellow]{y}\theta_1 & \cdots & 0 & 0 & 0 & 0 \\\  
\vdots & \vdots & \vdots & \vdots & \ddots & \vdots & \vdots & \vdots & \vdots \\\  
0 & 0 & 0 & 0 & \cdots & \cos \bbox[yellow]{x}\theta_{d/2-2} & -\sin \bbox[yellow]{x}\theta_{d/2-2} & 0 & 0 \\\  
0 & 0 & 0 & 0 & \cdots & \sin \bbox[yellow]{x}\theta_{d/2-2} & \cos \bbox[yellow]{x}\theta_{d/2-2} & 0 & 0 \\\  
0 & 0 & 0 & 0 & \cdots & 0 & 0 & \cos \bbox[yellow]{y}\theta_{d/2-1} & -\sin \bbox[yellow]{y}\theta_{d/2-1} \\\  
0 & 0 & 0 & 0 & \cdots & 0 & 0 & \sin \bbox[yellow]{y}\theta_{d/2-1} & \cos \bbox[yellow]{y}\theta_{d/2-1} \\\  
\end{pmatrix}\end{array}}$$</p>
<p>å‘ç°ä»€ä¹ˆå…±åŒç‚¹äº†å—ï¼Ÿå¦‚æœå•çœ‹è¿™ä¸ªå½¢å¼ï¼Œå¯ä»¥å‘ç°å…¶å®æœ‰$\boldsymbol{\mathcal{R}}<em n_n="n,n">n=\boldsymbol{\mathcal{R}}</em>$ï¼Œå³ä½ç½®ä¸º$n$çš„RoPE-1Dè·Ÿä½ç½®ä¸º$(n,n)$çš„RoPE-2Då…¶å®æ˜¯ç­‰ä»·çš„ï¼Œæ‰€ä»¥è¦æƒ³åœ¨å›¾æ–‡æ··åˆä¸­ç»Ÿä¸€ç”¨RoPE-2Dï¼Œå¹¶ä¸”å¯¹äºçº¯æ–‡æœ¬èƒ½é€€åŒ–ä¸ºRoPE-1Dï¼Œé‚£ä¹ˆå°±è¦å°†æ–‡æœ¬éƒ¨åˆ†çš„ä½ç½®åæ ‡å–ä¸º$(n,n)$çš„å½¢å¼ã€‚</p>
<p>å½“ç„¶ï¼Œå®é™…ä¸Šå®ƒä»¬è¿˜æ˜¯æœ‰å°‘è®¸ä¸åŒçš„ï¼Œæˆ‘ä»¬çŸ¥é“å¯¹äºRoPE-1Dæœ‰$\theta_i = b^{-2i/d}$ï¼Œä¹Ÿå°±æ˜¯$\theta_{2j}$è·Ÿ$\theta_{2j+1}$æ˜¯ä¸åŒçš„ï¼Œä½†å¯¹äºRoPE-2Dæ¥è¯´ï¼Œä¸ºäº†ç¡®ä¿$x,y$çš„å¯¹ç§°æ€§ï¼Œé€šå¸¸çš„é€‰æ‹©æ˜¯ç¡®ä¿$\theta_{2j}=\theta_{2j+1}$ï¼Œè¿™å°±äº§ç”Ÿäº†çŸ›ç›¾ä¹‹å¤„ã€‚å¯¹æ­¤ï¼Œæˆ‘ä»¬æœ‰ä¸¤ç§é€‰æ‹©ï¼šä¸€æ˜¯æ”¾å¼ƒRoPE-2Dä¸­$x,y$çš„å¯¹ç§°æ€§ï¼Œä¾æ—§å–$\theta_i = b^{-2i/d}$ï¼›äºŒæ˜¯å–$\theta_{2j}=\theta_{2j+1}=b^{-4j/d}$ï¼Œæ­¤æ—¶çº¯æ–‡æœ¬éƒ¨åˆ†çš„ä½ç½®ç¼–ç å°±è·Ÿå·²æœ‰RoPE-1Dç•¥æœ‰ä¸åŒã€‚å¯¹äº$\theta_i = b^{-2i/d}$æ¥è¯´ï¼Œ$\theta_i$ä¸$\theta_{i+1}$å·®åˆ«ä¸å¤§ï¼Œæ‰€ä»¥ä¸¤ç§æ–¹æ¡ˆå…¶å®éƒ½å·®ä¸å¤šï¼Œé€‰å“ªä¸€ç§å–å†³äºä¸ªäººçš„å®¡ç¾ï¼Œç¬”è€…å€¾å‘äºé€‰æ‹©ç¬¬ä¸€ç§ã€‚</p>
<h2 id="_3">ç­‰ä»·å¯¹ç§°</h2>
<p>é€šè¿‡ä¸Šè¿°åˆ†æï¼Œæˆ‘ä»¬ç¡®å®šäº†å›¾æ–‡æ··åˆæ¨¡æ€ç»Ÿä¸€ç”¨RoPE-2Dçš„æ–¹æ¡ˆï¼Œå¹¶ä¸”ç”±å‘åå…¼å®¹æ€§ç¡®å®šäº†ä½ç½®$n$çš„æ–‡æœ¬Tokençš„äºŒç»´ä½ç½®åº”è¯¥å–$(n,n)$ï¼Œä»è€Œå®Œæˆäº†æ–‡æœ¬éƒ¨åˆ†çš„ä½ç½®ç¼–ç è®¾è®¡ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦æ„æ€çš„æ˜¯å›¾åƒéƒ¨åˆ†çš„ä½ç½®ç¼–ç ã€‚</p>
<p>å¦‚æœè¾“å…¥åªæœ‰ä¸€å¼ $w\times h$ä¸ªPatchçš„å›¾åƒï¼Œé‚£ä¹ˆå®ƒçš„ä½ç½®åæ ‡è‡ªç„¶å°±æ˜¯å„ä¸ªPatchæœ¬èº«çš„åæ ‡ï¼Œå³<br />
\begin{equation}\left[\begin{matrix}<br />
(1,1) &amp; (1,2) &amp; \cdots &amp; (1, w) \\\<br />
(2,1) &amp; (2,2) &amp; \cdots &amp; (2, w) \\\<br />
\vdots &amp; \vdots &amp; \ddots &amp; \vdots \\\<br />
(h,1) &amp; (h,2) &amp; \cdots &amp; (h, w) \\\<br />
\end{matrix}\right]\label{eq:rope2d}\end{equation}<br />
æˆ‘ä»¬è¿™å±•ç¤ºçš„æ˜¯ç»å¯¹ä½ç½®ï¼Œä½†å®é™…çš„æ•ˆæœæ˜¯ç›¸å¯¹ä½ç½®ï¼Œç›¸å¯¹ä½ç½®çš„ç‰¹ç‚¹æ˜¯è·Ÿä½ç½®åç½®æ— å…³ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç»™æ¯ä¸ªåæ ‡éƒ½åŠ ä¸Š$(\beta_1,\beta_2)$è€Œä¸æ”¹å˜æ•ˆæœï¼›å…¶æ¬¡ï¼Œæˆ‘ä»¬å¯ä»¥ç»™æ¯ä¸ªåæ ‡éƒ½ä¹˜ä»¥$(\gamma_1,\gamma_2)$ï¼Œè¿™æ ·å…è®¸æˆ‘ä»¬æŒ‰éœ€è°ƒæ•´ç›¸é‚»ä½ç½®çš„é—´éš”ã€‚å°†è¿™ä¸¤ç‚¹ç»“åˆèµ·æ¥ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°å›¾åƒçš„ä¸€èˆ¬åŒ–äºŒç»´ä½ç½®ä¸º<br />
\begin{equation}\left[\begin{matrix}<br />
(\beta_1 + \gamma_1,\beta_2 + \gamma_2) &amp; (\beta_1 + \gamma_1,\beta_2 + 2\gamma_2) &amp; \cdots &amp; (\beta_1 + \gamma_1,\beta_2 + w\gamma_2) \\\[8pt]<br />
(\beta_1 + 2\gamma_1,\beta_2 + \gamma_2) &amp; (\beta_1 + 2\gamma_1,\beta_2 + 2\gamma_2) &amp; \cdots &amp; (\beta_1 + 2\gamma_1,\beta_2 + w\gamma_2) \\\[8pt]<br />
\vdots &amp; \vdots &amp; \ddots &amp; \vdots \\\[8pt]<br />
(\beta_1 + h\gamma_1,\beta_2 + \gamma_2) &amp; (\beta_1 + h\gamma_1,\beta_2 + 2\gamma_2) &amp; \cdots &amp; (\beta_1 + h\gamma_1,\beta_2 + w\gamma_2)<br />
\end{matrix}\right]\end{equation}<br />
ç°åœ¨æˆ‘ä»¬è€ƒè™‘å·¦å³ä¸¤æ®µæ–‡æœ¬å¤¹ç€ä¸­é—´ä¸€å¼ å›¾åƒæ—¶ï¼Œ$\beta_1,\beta_2,\gamma_1,\gamma_2$è¯¥æ€ä¹ˆé€‰å–ã€‚</p>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬å‡è®¾æ–‡æœ¬çš„Tokenå’ŒPatchå…·æœ‰ä¸€å®šçš„<strong>ç­‰ä»·æ€§</strong> ï¼šç»è¿‡åˆç†çš„<a href="/archives/10197">Patchify</a>åæ¯ä¸ªPatchçš„åœ°ä½è·ŸTokenç­‰ä»·ï¼ˆAn Image is Worth xxx Tokensï¼‰ï¼Œè¿™æ„å‘³ç€å¯¹äºä¸¤æ®µæ–‡æœ¬æ¥è¯´ï¼Œå®ƒä»¬ç›¸å½“äºå¤¹ç€ä¸€ä¸ª$wh$ä¸ªTokençš„å¥å­ï¼Œæ‰€ä»¥å¦‚æœå·¦æ®µæ–‡æœ¬æœ€åä¸€ä¸ªTokençš„ä½ç½®æ˜¯$(L,L)$ï¼Œé‚£ä¹ˆå³æ®µæ–‡æœ¬ç¬¬ä¸€ä¸ªTokençš„ä½ç½®å°±æ˜¯$(L+wh+1, L + wh + 1)$ã€‚</p>
<p>æ¥ç€ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å¼•å…¥<strong>å¯¹ç§°æ€§</strong> â€”â€”å…·ä½“æ¥è¯´ï¼Œå›¾åƒçš„ç¬¬ä¸€ä¸ªPatchçš„ä½ç½®æ˜¯$(\beta_1 + \gamma_1,\beta_2 + \gamma_2)$ï¼Œæœ€åä¸€ä¸ªPatchçš„ä½ç½®æ˜¯$(\beta_1 + h\gamma_1,\beta_2 + w\gamma_2)$ï¼Œæˆ‘ä»¬è®¤ä¸ºã€å›¾åƒç¬¬ä¸€ä¸ªPatchã€‘ä¸ã€å·¦æ®µæ–‡æœ¬æœ€åä¸€ä¸ªTokenã€‘çš„ä½ç½®å·®ï¼Œç­‰äºã€å³æ®µæ–‡æœ¬ç¬¬ä¸€ä¸ªTokenã€‘ä¸ã€å›¾åƒæœ€åä¸€ä¸ªPatchã€‘çš„ä½ç½®å·®ï¼Œå³<br />
\begin{equation}\begin{pmatrix}\beta_1 + \gamma_1 \\\ \beta_2 + \gamma_2\end{pmatrix} - \begin{pmatrix}L \\\ L\end{pmatrix} = \begin{pmatrix}L+wh+1 \\\ L+wh+1\end{pmatrix} - \begin{pmatrix}\beta_1 + h\gamma_1 \\\ \beta_2 + w\gamma_2\end{pmatrix}\label{eq:beta-gamma}\end{equation}<br />
è¿™é‡Œè¾¹æœ‰å››ä¸ªæœªçŸ¥æ•°$\beta_1,\beta_2,\gamma_1,\gamma_2$ï¼Œä½†åªæœ‰ä¸¤ä¸ªç­‰å¼ï¼Œæ‰€ä»¥æœ‰æ— ç©·å¤šç»„è§£ã€‚æˆ‘ä»¬å¯ä»¥ç®€å•åœ°å–$\gamma_1=\gamma_2=1$ï¼Œç»§è€Œè§£å¾—<br />
\begin{equation}\beta_1 = L + \frac{1}{2}(wh - h),\quad \beta_2 = L + \frac{1}{2}(wh - w)\end{equation}<br />
è¿™ä¸ªæ–¹æ¡ˆæˆ‘ä»¬æš‚æ—¶å¯ä»¥ç§°ä¹‹ä¸ºRoPE-Tie-v2æˆ–è€…RoPE-TVï¼ˆRoPE for Text and Visionï¼‰å§ã€‚</p>
<h2 id="_4">ä¼˜åŠ£åˆ†æ</h2>
<p>æ ¹æ®è¿™ä¸ªç»“æœï¼Œå½“å¥å­åé¢æ¥ä¸€å¼ $w\times h$çš„å›¾åƒæ—¶ï¼Œåªéœ€è¦æŒ‰ç…§ä¸Šè¿°è®¡ç®—è®¡ç®—å‡º$(\beta_1,\beta_2)$ï¼Œç„¶ååŠ åˆ°å¸¸è§„çš„äºŒç»´RoPE $\eqref{eq:rope2d}$ä¸­å»ï¼Œå°±å¾—åˆ°äº†å›¾åƒéƒ¨åˆ†çš„ä½ç½®åæ ‡äº†ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º  </p>
<p><a href="/usr/uploads/2024/09/2781465051.png" title="ç‚¹å‡»æŸ¥çœ‹åŸå›¾"><img alt="æ–°ç‰ˆRoPE-TVï¼ˆRoPE-Tie-v2ï¼‰ç¤ºæ„å›¾" src="/usr/uploads/2024/09/2781465051.png" /></a></p>
<p>æ–°ç‰ˆRoPE-TVï¼ˆRoPE-Tie-v2ï¼‰ç¤ºæ„å›¾</p>
<p>ä½œä¸ºå¯¹æ¯”ï¼Œæˆ‘ä»¬åœ¨<a href="/archives/10040">ã€ŠTransformerå‡çº§ä¹‹è·¯ï¼š17ã€å¤šæ¨¡æ€ä½ç½®ç¼–ç çš„ç®€å•æ€è€ƒã€‹</a>æå‡ºçš„æ—§ç‰ˆRoPE-Tieï¼Œå…¶ä½ç½®åæ ‡å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š  </p>
<p><a href="/usr/uploads/2024/09/2581235844.png" title="ç‚¹å‡»æŸ¥çœ‹åŸå›¾"><img alt="æ—§ç‰ˆRoPE-Tieç¤ºæ„å›¾" src="/usr/uploads/2024/09/2581235844.png" /></a></p>
<p>æ—§ç‰ˆRoPE-Tieç¤ºæ„å›¾</p>
<p>äº‹å®ä¸Šï¼ŒRoPE-Tieçš„å‡ºå‘ç‚¹åŒæ ·åŒ…æ‹¬<strong>å…¼å®¹æ€§</strong> å’Œ<strong>å¯¹ç§°æ€§</strong> ï¼Œä½†æ²¡æœ‰ä¸¥æ ¼éµå¾ª<strong>ç­‰ä»·æ€§</strong> ï¼Œå¹¶ä¸”RoPE-Tieé»˜è®¤äº†$\beta_1=\beta_2=L$ï¼Œä»¥åŠæ²¡æœ‰é™å®š$w\times h$ä¸ªPatchç­‰ä»·äº$wh$ä¸ªTokenï¼Œæœ€ç»ˆæ¨å‡ºäº†ä¸€ç»„æ•´æ•°è§£ï¼ˆå¦‚æœä¸è¦æ±‚æ•´æ•°è§£ä¹Ÿå¯ä»¥æ»¡è¶³<strong>ç­‰ä»·æ€§</strong> ï¼‰ï¼š<br />
\begin{equation}\gamma_1 = w+1,\quad\gamma_2=h+1\end{equation}<br />
ä»å¦‚ä»Šçš„è§†è§’æ¥çœ‹ï¼ŒRoPE-Tieçš„é»˜è®¤è®¾ç½®å…¶å®å¹¶ä¸æ˜¯å¾ˆç†æƒ³ï¼Œæ‰€ä»¥æœ¬æ–‡é‡æ–°é€‰æ‹©äº†$\gamma_1=\gamma_2=1$ï¼Œå¹¶ç¡®ä¿<strong>ç­‰ä»·æ€§</strong> ï¼Œç„¶ååæ¨å‡º$\beta_1,\beta_2$ã€‚</p>
<p>é‚£æ–°æ–¹æ¡ˆæœ‰ä»€ä¹ˆå¥½å¤„å‘¢ï¼Ÿé¦–å…ˆï¼ŒRoPE-Tieä¸­å›¾åƒå†…çš„ç›¸å¯¹ä½ç½®è·Ÿå®ƒçš„å¤§å°æœ‰å…³ï¼Œè€Œæ–°æ–¹æ¡ˆä¸­Patchçš„é—´éš”æ˜¯å›ºå®šçš„$(0,1)$å’Œ$(1,0)$ï¼Œè¿™å¯ä»¥è®©Patchçš„å°ºåº¦æ›´ä¸ºä¸€è‡´ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œä¸€å¼ 128<em>128çš„å›¾åƒä»¥åŠè¯¥å›¾çš„ä¸ŠåŠéƒ¨ä»½ï¼ˆå³128</em>64çš„å­å›¾ï¼‰ï¼Œç”±äºä¸¤è€…é«˜åº¦ä¸ä¸€æ ·ï¼Œæ‰€ä»¥RoPE-Tieåå®ƒä»¬æ¨ªå‘çš„ä½ç½®é—´éš”å¹¶ä¸ä¸€æ ·ï¼Œè¿™æ„å‘³ç€åŒæ ·ä½ç½®ã€åŒæ ·å«ä¹‰çš„ä¸¤ä¸ªPatchåœ¨åŠ äº†RoPE-Tieåçš„è·ç¦»ï¼ˆå°ºåº¦ï¼‰å˜å¾—ä¸ä¸€è‡´äº†ï¼Œè¿™çœ‹èµ·æ¥å¹¶ä¸åˆç†ï¼Œè€Œæ–°æ–¹æ¡ˆæ²¡æœ‰è¿™ä¸ªé—®é¢˜ã€‚</p>
<p>å…¶æ¬¡ï¼ŒRoPE-Tieä¸­å›¾åƒä¸å·¦å³æ–‡æœ¬çš„é—´éš”ï¼Œè·Ÿå›¾åƒå†…éƒ¨Patchçš„é—´éš”ä¸€æ ·éƒ½æ˜¯$(\gamma_1,\gamma_2)$ï¼Œè€Œæ–°æ–¹æ¡ˆä¸­æ–‡æœ¬åˆ°å›¾åƒã€å›¾åƒåˆ°æ–‡æœ¬ä¹‹é—´ä¼šå‡ºç°ä¸€ä¸ªæ¯”è¾ƒå¤§çš„é—´éš”$\frac{1}{2}(wh - h, wh-w)$ï¼Œç„¶åæ–‡æœ¬å†…éƒ¨ã€å›¾åƒå†…éƒ¨åˆ™éƒ½æ˜¯å›ºå®šçš„å‡åŒ€é—´éš”ã€‚ç›´è§‰ä¸Šï¼Œè¿™ç§ä¸åŒæ¨¡æ€ä¹‹é—´æ¯”è¾ƒå¤§çš„ä½ç½®è·³è·ƒï¼Œå¯ä»¥æ›´å¥½åœ°å®ç°â€œæ¨¡æ€éš”ç¦»â€ï¼Œè®©å•ä¸ªæ¨¡å‹æ—¢èƒ½æ›´å¥½åœ°å¤„ç†å•æ¨¡æ€å†…å®¹ï¼Œåˆä¿ç•™äº†å¤šæ¨¡æ€ä¹‹é—´çš„äº¤äº’ï¼Œè¿™è·Ÿæˆ‘ä»¬é€šå¸¸åœ¨å·¦å³åŠ [IMG]å’Œ[/IMG]ä¸¤ä¸ªSpecial Tokenæ¥æ ‡è®°å‡ºå›¾åƒå…·æœ‰å¼‚æ›²åŒå·¥ä¹‹å¤„ã€‚</p>
<h2 id="_5">ä¸‰ç»´å›°å¢ƒ</h2>
<p>åœ¨RoPE-Tieçš„æ–‡ç« ä¸­ï¼Œå¹¶æ²¡æœ‰è®¨è®ºåˆ°â€œæ–‡æœ¬-è§†é¢‘â€æ··åˆæ¨¡æ€çš„ä½ç½®ç¼–ç ï¼Œè¿™ä¸€èŠ‚æˆ‘ä»¬æ¥è¡¥å……è®¨è®ºå®Œæ•´ã€‚</p>
<p>ç›´è§‚æ¥çœ‹ï¼Œå¯¹äºè§†é¢‘è¾“å…¥æˆ‘ä»¬å¯ä»¥æœ‰ä¸¤ç§å¤„ç†æ–¹å¼ã€‚ç¬¬ä¸€ç§æ–¹å¼å°±æ˜¯ç®€å•åœ°å°†è§†é¢‘å½“æˆå¤šå¼ å›¾ç‰‡å¤„ç†ï¼ˆå¿…è¦æ—¶åŠ ä¸ª[VIDEO]ã€[/VIDEO]çš„æ ‡è®°ï¼‰ï¼Œè¿™æ ·æˆ‘ä»¬å°±ä¸éœ€è¦é’ˆå¯¹è§†é¢‘æå‡ºæ–°çš„ä½ç½®ç¼–ç äº†ï¼Œæ²¿ç”¨â€œæ–‡æœ¬-å›¾åƒâ€çš„æ··åˆä½ç½®ç¼–ç ç»“æœå°±è¡Œï¼Œä½†è¿™æ ·ä¸§å¤±äº†åŒä¸€è§†é¢‘ä¸åŒå¸§ä¹‹é—´çš„å¯¹é½å…³ç³»ï¼Œå¯èƒ½ä¸æ˜¯å¤ªå®Œç¾ï¼Œä¾‹å¦‚â€œç¬¬1å¸§çš„ç¬¬1ä¸ªPatchâ€è·Ÿâ€œç¬¬2å¸§çš„ç¬¬1ä¸ªPatchâ€å’Œâ€œç¬¬1å¸§çš„ç¬¬2ä¸ªPatchâ€ï¼Œåº”è¯¥æœ‰å·®ä¸å¤šçš„é‚»è¿‘å…³ç³»ï¼Œä½†å±•å¹³å½“å¤šå¼ å›¾ç‰‡å¤„ç†å°±ä½“ç°ä¸å‡ºè¿™ä¸€ç‚¹ã€‚</p>
<p>ç¬¬äºŒç§æ–¹å¼åˆ™æ˜¯å°†â€œæ–‡æœ¬-å›¾åƒâ€çš„ç»“æœå¹³è¡Œåœ°æ¨å¹¿åˆ°â€œæ–‡æœ¬-è§†é¢‘â€ä¸­ã€‚å¯¹äºä¸€ä¸ª$w\times h\times t$çš„è§†é¢‘ï¼ˆç”»é¢ä¸º$w\times h$ï¼Œä¸€å…±$t$å¸§ï¼‰ï¼Œå®ƒçš„ä½ç½®åæ ‡æ˜¯ä¸‰ç»´çš„$(x,y,z)$ï¼Œæ ¹æ®ç›¸åŒçš„<strong>å…¼å®¹æ€§</strong> ã€<strong>ç­‰ä»·æ€§</strong> å’Œ<strong>å¯¹ç§°æ€§</strong> ï¼Œæˆ‘ä»¬å¯ä»¥å°†æ–¹ç¨‹$\eqref{eq:beta-gamma}$æ¨å¹¿æˆ<br />
\begin{equation}\begin{pmatrix}\beta_1 + \gamma_1 \\\ \beta_2 + \gamma_2 \\\ \beta_3 + \gamma_3\end{pmatrix} - \begin{pmatrix}L \\\ L \\\ L\end{pmatrix} = \begin{pmatrix}L+wht+1 \\\ L+wht+1 \\\ L+wht+1\end{pmatrix} - \begin{pmatrix}\beta_1 + h\gamma_1 \\\ \beta_2 + w\gamma_2 \\\ \beta_3 + t\gamma_3\end{pmatrix}\end{equation}<br />
å¦‚æœè¿˜æ˜¯è®¾$\gamma_1=\gamma_2=\gamma_3=1$ï¼Œæˆ‘ä»¬å¾—åˆ°<br />
\begin{equation}\beta_1 = L + \frac{1}{2}(wht - h),\quad \beta_2 = L + \frac{1}{2}(wht - w),\quad \beta_3 = L + \frac{1}{2}(wht - t)\end{equation}</p>
<p>è¿™æ ·åšå®Œæ•´äº†ä¿ç•™äº†è§†é¢‘ä½ç½®çš„ä¸‰ç»´æ€§ï¼Œçœ‹èµ·æ¥ä¼šæ›´ä¼˜é›…ä¸€äº›ï¼Œä½†ç¬”è€…è®¤ä¸ºå®ƒä»æœ‰ä¸€äº›ç¾ä¸­ä¸è¶³ä¹‹å¤„ã€‚</p>
<p>è¿™ä¸ªç¾ä¸­ä¸è¶³æºäºç¬”è€…å¯¹è§†é¢‘çš„æ—¶é—´ç»´åº¦çš„ä¸åŒç†è§£ï¼šè§†é¢‘çš„ä¸‰ç»´ï¼Œå®é™…ä¸Šæ˜¯â€œ2ä¸ªç©ºé—´ç»´åº¦+1ä¸ªæ—¶é—´ç»´åº¦â€ï¼Œè·ŸçœŸå®ä¸–ç•Œçš„ä¸‰ç»´ç«‹ä½“çš„â€œ3ä¸ªç©ºé—´ç»´åº¦â€ä¸ä¸€æ ·ã€‚æŒ‰ç…§ç¬”è€…çš„è§‚ç‚¹ï¼Œè§†é¢‘çš„æ—¶é—´ç»´åº¦è·Ÿä¸¤ä¸ªç©ºé—´ç»´åº¦æ˜¯ä¸å¹³æƒçš„ï¼Œæ—¶é—´ç»´åº¦æ›´åƒæ˜¯æ–‡æœ¬ä»å·¦å¾€å³çš„ä¹¦å†™æ–¹å‘ï¼Œæ‰€ä»¥ç¬”è€…æƒ³è±¡ä¸­çš„å®Œç¾å¤šæ¨¡æ€LLMï¼Œåº”è¯¥èƒ½åƒæ–‡æœ¬LLMç»­å†™æ–‡æœ¬ä¸€æ ·ï¼Œç†è®ºä¸Šèƒ½å¤Ÿä»¥è‡ªå›å½’çš„æ–¹å¼æ— é™åœ°ç»­ä½œè§†é¢‘ï¼Œç›´åˆ°å‡ºç°[EOS]æ ‡è®°ã€‚</p>
<p>åˆšæ‰æˆ‘ä»¬æäº†ä¸¤ç§â€œæ–‡æœ¬-è§†é¢‘â€æ··åˆç¼–ç æ–¹æ¡ˆï¼Œç¬¬ä¸€ç§ç›´æ¥å½“ä½œå¤šå¼ å›¾ç‰‡å¤„ç†ï¼Œè¿™ç§æ–¹æ¡ˆæ˜¯å¯ä»¥æ— é™è‡ªå›å½’ç”Ÿæˆè§†é¢‘çš„ï¼Œä½†ç¬¬äºŒç§çœ‹ä¸Šå»æ›´å®Œç¾çš„æ–¹æ¡ˆåè€Œä¸è¡Œï¼Œå› ä¸ºå®ƒçš„$\beta_1,\beta_2,\beta_3$æ˜¯ä¾èµ–äº$t$çš„ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬éœ€è¦æå‰çŸ¥é“ç”Ÿæˆå¤šå°‘å¸§çš„è§†é¢‘ï¼Œæ¢å¥è¯è¯´ï¼Œç¬¬äºŒç§æ–¹æ¡ˆå¹¶ä¸æ˜¯ä¸èƒ½ç”¨è‡ªå›å½’çš„æ–¹å¼ç”Ÿæˆè§†é¢‘ï¼Œè€Œæ˜¯éœ€è¦æå‰ç¡®å®šå¸§æ•°ï¼Œè¿™åœ¨ç¬”è€…çœ‹æ¥æ˜¯ä¸ç¬¦åˆæ—¶é—´ç»´åº¦çš„ç†æƒ³ç‰¹æ€§çš„ï¼ˆæ—¶é—´ï¼Œåº”è¯¥å¯ä»¥æ— çº¦æŸåœ°å¾€å‰æ¨è¿›ï¼‰ã€‚</p>
<p>å¯èƒ½æœ‰è¯»è€…ç–‘é—®ï¼šä¸ºä»€ä¹ˆå›¾åƒå°±ä¸ä»‹æ„$\beta_1,\beta_2$ä¸­ä¾èµ–äº$w,h$å‘¢ï¼Ÿä¹Ÿå°±æ˜¯è¯´ä¸ºä»€ä¹ˆå›¾åƒç”Ÿæˆä¸ä»‹æ„äº‹å…ˆçŸ¥é“å›¾åƒå¤§å°å‘¢ï¼Ÿè¿™æ˜¯å› ä¸ºå›¾åƒæœ‰ä¸¤ä¸ªæ–¹å‘ï¼Œå°±ç®—æˆ‘ä»¬ç”¨è‡ªå›å½’çš„æ–¹å¼ç”Ÿæˆå›¾åƒï¼Œä¹Ÿå¿…é¡»è‡³å°‘çŸ¥é“ä¸€ä¸ªæ–¹å‘çš„å¤§å°ï¼Œæ‰èƒ½å‘Šè¯‰æ¨¡å‹åŠæ—¶â€œæ¢è¡Œâ€ï¼Œä»¥ç”Ÿæˆä¸€å¼ å®Œæ•´çš„äºŒç»´å›¾åƒã€‚è€Œå›¾åƒçš„ä¸¤ä¸ªç©ºé—´ç»´åº¦æ˜¯å¹³æƒçš„ï¼Œå•çŸ¥å…¶ä¸€å€’ä¸å¦‚å…¨éƒ¨çŸ¥é“ï¼Œæ‰€ä»¥æˆ‘ä»¬èƒ½å¤Ÿæ¥å—äº‹å…ˆç¡®å®šå›¾åƒå¤§å°ã€‚</p>
<p>æ­¤å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ç”¨<a href="/archives/9984">ã€Šâ€œé—­é—¨é€ è½¦â€ä¹‹å¤šæ¨¡æ€æ€è·¯æµ…è°ˆï¼ˆä¸€ï¼‰ï¼šæ— æŸè¾“å…¥ã€‹</a>ä»‹ç»çš„â€œAR+Diffusionâ€åšâ€œæ–‡æœ¬-å›¾åƒâ€æ¨¡å‹ï¼Œæ­¤æ—¶å›¾åƒç”Ÿæˆéƒ¨åˆ†æ˜¯Diffusionï¼Œå°±å¿…é¡»æå‰çŸ¥é“ç›®æ ‡å›¾åƒå¤§å°äº†ã€‚</p>
<h2 id="_6">ç›¸å…³å·¥ä½œ</h2>
<p>å‰æ®µæ—¶é—´ï¼Œé˜¿é‡Œå¼€æºäº†åä¸ºâ€œQwen2-VLâ€çš„å¤šæ¨¡æ€æ¨¡å‹ï¼Œä»‹ç»ä¸­æåˆ°è‡ªå·±æå‡ºäº†ä¸€ç§å¤šæ¨¡æ€æ—‹è½¬ä½ç½®ç¼–ç ï¼ˆM-ROPEï¼‰ï¼Œå¼•èµ·äº†ç¬”è€…çš„å…´è¶£ã€‚ç»è¿‡é˜…è¯»æºç ï¼ˆ<a href="https://github.com/huggingface/transformers/blob/1759bb9126e59405f58693a17ef9f58040c2008b/src/transformers/models/qwen2_vl/modeling_qwen2_vl.py#L1357">é“¾æ¥</a>ï¼‰ï¼Œå‘ç°M-RoPEå®é™…ä¸Šå°±æ˜¯æ²¿ç”¨äº†RoPE-Tieçš„<strong>å…¼å®¹æ€§</strong> æ€æƒ³ï¼Œä½†æ²¡æœ‰ä¿ç•™<strong>å¯¹ç§°æ€§</strong> å’Œ<strong>ç­‰ä»·æ€§</strong> ã€‚</p>
<p><a href="/usr/uploads/2024/09/1743575360.png" title="ç‚¹å‡»æŸ¥çœ‹åŸå›¾"><img alt="M-RoPEçš„æºç æ³¨é‡Š" src="/usr/uploads/2024/09/1743575360.png" /></a></p>
<p>M-RoPEçš„æºç æ³¨é‡Š</p>
<p>ç”¨æœ¬æ–‡çš„è®°å·ï¼ŒM-RoPEå®é™…ä¸Šå°±æ˜¯å–äº†$\beta_1=\beta_2=\beta_3=L,\gamma_1=\gamma_2=\gamma_3$ï¼ˆå¯¹äºâ€œæ–‡æœ¬-è§†é¢‘â€æ··åˆæ¨¡æ€ï¼‰ï¼Œç„¶åè§†é¢‘å³æ®µçš„æ–‡æœ¬çš„ç¬¬ä¸€ä¸ªTokençš„ä½ç½®ï¼Œç›´æ¥å–è§†é¢‘æœ€å¤§çš„ä½ç½®åæ ‡åŠ 1ã€‚è¿™æ ·å¦‚æœè¿˜æ˜¯ç”¨è‡ªå›å½’çš„æ–¹å¼ç”Ÿæˆè§†é¢‘ï¼Œç¡®å®ä¹Ÿä¸ç”¨æå‰ç¡®å®šå¸§æ•°ï¼Œä½†ç‰ºç‰²äº†<strong>å¯¹ç§°æ€§</strong> å’Œ<strong>ç­‰ä»·æ€§</strong> ã€‚</p>
<p><strong>å¯¹ç§°æ€§</strong> å’Œ<strong>ç­‰ä»·æ€§</strong> æœ‰å¤šé‡è¦å‘¢ï¼Ÿç¬”è€…ä¸æ¸…æ¥šç­”æ¡ˆï¼Œè¿™éœ€è¦å……åˆ†å®éªŒæ¥éªŒè¯ã€‚ä½†å¦‚æœä»…ä»…æ˜¯å¤´è„‘é£æš´çš„è¯ï¼Œç¬”è€…çŒœæµ‹å¯èƒ½ä¼šå½±å“æç«¯æƒ…å½¢çš„è¡¨ç°ï¼Œæ¯”å¦‚å¯¹äºM-RoPEæ¥è¯´ï¼Œå¦‚æœæ˜¯ç”»é¢å¾ˆå°ä½†æ—¶é—´å¾ˆé•¿çš„è§†é¢‘ï¼Œå®ƒçš„ç©ºé—´ç»´åº¦çš„ä½ç½®åæ ‡ç›¸å¯¹äºå·¦æ®µæ–‡æœ¬æ¥è¯´æ˜¯è¿ç»­çš„ï¼Œä½†ç›¸å¯¹äºå³æ®µæ–‡æœ¬æ¥è¯´åˆ™æ˜¯çªå˜äº†ï¼Œç›´è§‰ä¸Šä¼šä½¿å¾—æ–‡æœ¬å’Œè§†è§‰çš„äº¤äº’æ›´ä¸å‹å¥½ã€‚</p>
<p>å†æ¯”å¦‚ä¸€ä¸ª$w=h=t=n$çš„è§†é¢‘ï¼Œç›´è§‰ä¸Šå®ƒç­‰æ•ˆäº$n^3$ä¸ªTokenï¼Œä½†å¦‚æœæŒ‰ç…§M-RoPEçš„è§„åˆ™ï¼Œå¦‚æœä¸¤æ®µæ–‡æœ¬å¤¹ç€è¿™æ ·ä¸€ä¸ªè§†é¢‘ï¼Œåªæ˜¯ç­‰ä»·äºå¤¹ç€ä¸€ä¸ª$n$ä¸ªTokençš„æ–‡æœ¬ï¼Œæ¢è¨€ä¹‹åœ¨å¤§å°ä¸º$n$çš„ç›¸å¯¹è·ç¦»å†…æ”¾ä¸‹äº†$n^3$ä¸ªTokenï¼Œä¼šä¸ä¼šå¯¼è‡´ä¿¡æ¯å¯†åº¦è¿‡å¤§è€Œå¢åŠ æ¨¡å‹ç†è§£éš¾åº¦äº†ï¼Ÿ</p>
<p>å½“ç„¶ï¼Œå¯¹äºNoPEéƒ½å¯èƒ½Workçš„Decoder-only LLMæ¥è¯´ï¼Œè¿™äº›é—®é¢˜ä¹Ÿå¯èƒ½æ˜¯ç¬”è€…å¤šè™‘äº†ã€‚</p>
<h2 id="_7">æ–‡ç« å°ç»“</h2>
<p>æœ¬æ–‡åˆ†äº«äº†ç¬”è€…å…³äºå¤šæ¨¡æ€ä½ç½®ç¼–ç çš„åç»­æ€è€ƒï¼Œæå‡ºäº†æ„å»ºå¤šæ¨¡æ€ä½ç½®ç¼–ç çš„ä¸‰ä¸ªåŸåˆ™ï¼šå…¼å®¹æ€§ã€ç­‰ä»·æ€§å’Œå¯¹ç§°æ€§ï¼Œæ”¹è¿›äº†ä¹‹å‰æå‡ºè¿‡çš„RoPE-Tieï¼Œæœ€åè®¨è®ºäº†â€œæ–‡æœ¬-è§†é¢‘â€æ··åˆæ¨¡æ€çš„ä½ç½®ç¼–ç è®¾è®¡å’Œå›°éš¾ï¼Œä»¥åŠQwen2-VLçš„M-RoPEä¸RoPE-Tieçš„è”ç³»ç­‰ã€‚</p>
<p><em><strong>è½¬è½½åˆ°è¯·åŒ…æ‹¬æœ¬æ–‡åœ°å€ï¼š</strong><a href="https://spaces.ac.cn/archives/10352">https://spaces.ac.cn/archives/10352</a></em></p>
<p><em><strong>æ›´è¯¦ç»†çš„è½¬è½½äº‹å®œè¯·å‚è€ƒï¼š</strong></em><a href="https://spaces.ac.cn/archives/6508#%E6%96%87%E7%AB%A0%E5%A6%82%E4%BD%95%E8%BD%AC%E8%BD%BD/%E5%BC%95%E7%94%A8" title="ã€Šç§‘å­¦ç©ºé—´FAQã€‹">ã€Šç§‘å­¦ç©ºé—´FAQã€‹</a></p>
<p><strong>å¦‚æœæ‚¨è¿˜æœ‰ä»€ä¹ˆç–‘æƒ‘æˆ–å»ºè®®ï¼Œæ¬¢è¿åœ¨ä¸‹æ–¹è¯„è®ºåŒºç»§ç»­è®¨è®ºã€‚</strong></p>
<p><strong>å¦‚æœæ‚¨è§‰å¾—æœ¬æ–‡è¿˜ä¸é”™ï¼Œæ¬¢è¿åˆ†äº«/æ‰“èµæœ¬æ–‡ã€‚æ‰“èµå¹¶éè¦ä»ä¸­è·å¾—æ”¶ç›Šï¼Œè€Œæ˜¯å¸Œæœ›çŸ¥é“ç§‘å­¦ç©ºé—´è·å¾—äº†å¤šå°‘è¯»è€…çš„çœŸå¿ƒå…³æ³¨ã€‚å½“ç„¶ï¼Œå¦‚æœä½ æ— è§†å®ƒï¼Œä¹Ÿä¸ä¼šå½±å“ä½ çš„é˜…è¯»ã€‚å†æ¬¡è¡¨ç¤ºæ¬¢è¿å’Œæ„Ÿè°¢ï¼</strong></p>
<p>æ‰“èµ</p>
<p><img alt="ç§‘å­¦ç©ºé—´" src="https://spaces.ac.cn/usr/themes/geekg/payment/wx.png" /></p>
<p>å¾®ä¿¡æ‰“èµ</p>
<p><img alt="ç§‘å­¦ç©ºé—´" src="https://spaces.ac.cn/usr/themes/geekg/payment/zfb.png" /></p>
<p>æ”¯ä»˜å®æ‰“èµ</p>
<p>å› ä¸ºç½‘ç«™åå°å¯¹æ‰“èµå¹¶æ— è®°å½•ï¼Œå› æ­¤æ¬¢è¿åœ¨æ‰“èµæ—¶å€™å¤‡æ³¨ç•™è¨€ã€‚ä½ è¿˜å¯ä»¥<a href="http://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&amp;email=tN7d1drY3drrx8H0xcWa19vZ"><strong>ç‚¹å‡»è¿™é‡Œ</strong></a>æˆ–åœ¨ä¸‹æ–¹è¯„è®ºåŒºç•™è¨€æ¥å‘ŠçŸ¥ä½ çš„å»ºè®®æˆ–éœ€æ±‚ã€‚</p>
<p><strong>å¦‚æœæ‚¨éœ€è¦å¼•ç”¨æœ¬æ–‡ï¼Œè¯·å‚è€ƒï¼š</strong></p>
<p>è‹å‰‘æ—. (Sep. 06, 2024). ã€Šâ€œé—­é—¨é€ è½¦â€ä¹‹å¤šæ¨¡æ€æ€è·¯æµ…è°ˆï¼ˆä¸‰ï¼‰ï¼šä½ç½®ç¼–ç  ã€‹[Blog post]. Retrieved from <a href="https://spaces.ac.cn/archives/10352">https://spaces.ac.cn/archives/10352</a></p>
<p>@online{kexuefm-10352,<br />
title={â€œé—­é—¨é€ è½¦â€ä¹‹å¤šæ¨¡æ€æ€è·¯æµ…è°ˆï¼ˆä¸‰ï¼‰ï¼šä½ç½®ç¼–ç },<br />
author={è‹å‰‘æ—},<br />
year={2024},<br />
month={Sep},<br />
url={\url{https://spaces.ac.cn/archives/10352}},<br />
} </p>
<hr />
<h2 id="_8">å…¬å¼æ¨å¯¼ä¸æ³¨é‡Š</h2>
<h3 id="rope-rotary-position-embedding">ä¸€ã€RoPE (Rotary Position Embedding) çš„å®Œæ•´æ•°å­¦æ¨å¯¼</h3>
<h4 id="11">1.1 æ—‹è½¬çŸ©é˜µçš„åŸºæœ¬æ€§è´¨</h4>
<p>äºŒç»´æ—‹è½¬çŸ©é˜µçš„æ ‡å‡†å½¢å¼ï¼š</p>
<p>\begin{equation}
\boldsymbol{R}(\theta) = \begin{pmatrix}
\cos\theta &amp; -\sin\theta \
\sin\theta &amp; \cos\theta
\end{pmatrix}
\tag{1}
\end{equation}</p>
<p><strong>å…³é”®æ€§è´¨</strong>:</p>
<p>\begin{equation}
\boldsymbol{R}(\theta_1) \boldsymbol{R}(\theta_2) = \boldsymbol{R}(\theta_1 + \theta_2)
\tag{2}
\end{equation}</p>
<p>\begin{equation}
\boldsymbol{R}(\theta)^\top = \boldsymbol{R}(-\theta) = \boldsymbol{R}(\theta)^{-1}
\tag{3}
\end{equation}</p>
<p><strong>æ•°å­¦ç›´è§‰</strong>: æ—‹è½¬çŸ©é˜µçš„ä¹˜æ³•å¯¹åº”è§’åº¦ç›¸åŠ ï¼Œè¿™æ˜¯RoPEå®ç°ç›¸å¯¹ä½ç½®ç¼–ç çš„æ ¸å¿ƒã€‚</p>
<h4 id="12-rope-1d">1.2 RoPE-1Dçš„æ„é€ </h4>
<p>å¯¹äº $d$ ç»´å‘é‡ $\boldsymbol{q} \in \mathbb{R}^d$ï¼ŒRoPEå°†å…¶åˆ†ä¸º $d/2$ å¯¹ï¼Œæ¯å¯¹åº”ç”¨ä¸åŒé¢‘ç‡çš„æ—‹è½¬ã€‚</p>
<p>ä½ç½® $n$ çš„RoPEçŸ©é˜µï¼š</p>
<p>\begin{equation}
\boldsymbol{\mathcal{R}}<em d_2-1="d/2-1">n = \begin{pmatrix}
\boldsymbol{R}(n\theta_0) &amp; &amp; &amp; \
&amp; \boldsymbol{R}(n\theta_1) &amp; &amp; \
&amp; &amp; \ddots &amp; \
&amp; &amp; &amp; \boldsymbol{R}(n\theta</em>)
\end{pmatrix} \in \mathbb{R}^{d \times d}
\tag{4}
\end{equation}</p>
<p>å…¶ä¸­é¢‘ç‡ $\theta_i$ å®šä¹‰ä¸ºï¼š</p>
<p>\begin{equation}
\theta_i = b^{-2i/d}, \quad i = 0, 1, \ldots, d/2-1
\tag{5}
\end{equation}</p>
<p>åŸºæ•° $b$ é€šå¸¸å– 10000ï¼ˆç±»ä¼¼Transformerçš„æ­£å¼¦ä½ç½®ç¼–ç ï¼‰ã€‚</p>
<h4 id="13-rope">1.3 RoPEå®ç°ç›¸å¯¹ä½ç½®çš„æ•°å­¦è¯æ˜</h4>
<p>Queryåœ¨ä½ç½® $m$ï¼ŒKeyåœ¨ä½ç½® $n$ï¼Œç»è¿‡RoPEåçš„å†…ç§¯ï¼š</p>
<p>\begin{equation}
(\boldsymbol{\mathcal{R}}_m \boldsymbol{q})^\top (\boldsymbol{\mathcal{R}}_n \boldsymbol{k}) = \boldsymbol{q}^\top \boldsymbol{\mathcal{R}}_m^\top \boldsymbol{\mathcal{R}}_n \boldsymbol{k}
\tag{6}
\end{equation}</p>
<p>åˆ©ç”¨æ—‹è½¬çŸ©é˜µæ€§è´¨ (2):</p>
<p>\begin{equation}
\boldsymbol{\mathcal{R}}<em n-m="n-m">m^\top \boldsymbol{\mathcal{R}}_n = \boldsymbol{\mathcal{R}}</em>
\tag{7}
\end{equation}</p>
<p><strong>å±•å¼€è¯æ˜</strong>: å¯¹äºç¬¬ $i$ ä¸ªäºŒç»´å—ï¼š</p>
<p>\begin{equation}
\boldsymbol{R}(m\theta_i)^\top \boldsymbol{R}(n\theta_i) = \boldsymbol{R}(-m\theta_i) \boldsymbol{R}(n\theta_i) = \boldsymbol{R}((n-m)\theta_i)
\tag{8}
\end{equation}</p>
<p>å› æ­¤ï¼š</p>
<p>\begin{equation}
(\boldsymbol{\mathcal{R}}<em n-m="n-m">m \boldsymbol{q})^\top (\boldsymbol{\mathcal{R}}_n \boldsymbol{k}) = \boldsymbol{q}^\top \boldsymbol{\mathcal{R}}</em>
\tag{9}
\end{equation}} \boldsymbol{k</p>
<p><strong>ç»“è®º</strong>: å†…ç§¯åªä¾èµ–äºç›¸å¯¹ä½ç½®å·® $n-m$ï¼Œå®ç°äº†ç›¸å¯¹ä½ç½®ç¼–ç ï¼</p>
<h4 id="14-rope">1.4 RoPEçš„é¢‘ç‡è®¾è®¡åŸç†</h4>
<p>ä¸åŒé¢‘ç‡ $\theta_i$ ç¼–ç ä¸åŒçš„è·ç¦»å°ºåº¦ï¼š
- ä½é¢‘ (å° $i$): $\theta_i$ å¤§ï¼Œæ—‹è½¬å¿«ï¼Œé€‚åˆç¼–ç çŸ­è·ç¦»
- é«˜é¢‘ (å¤§ $i$): $\theta_i$ å°ï¼Œæ—‹è½¬æ…¢ï¼Œé€‚åˆç¼–ç é•¿è·ç¦»</p>
<p><strong>å‘¨æœŸåˆ†æ</strong>: ç¬¬ $i$ ä¸ªç»´åº¦çš„å‘¨æœŸä¸ºï¼š</p>
<p>\begin{equation}
T_i = \frac{2\pi}{\theta_i} = 2\pi b^{2i/d}
\tag{10}
\end{equation}</p>
<p>å¯¹äº $b=10000, d=128$:
- $i=0$: $T_0 = 2\pi \approx 6.28$
- $i=63$: $T_{63} = 2\pi \times 10000 \approx 62832$</p>
<p><strong>æ•°å€¼ç¤ºä¾‹</strong>: è¿™ä¿è¯äº†ä»å±€éƒ¨åˆ°å…¨å±€çš„å¤šå°ºåº¦ä½ç½®è¡¨ç¤ºã€‚</p>
<h3 id="rope-2d">äºŒã€RoPE-2Dçš„æ•°å­¦æ¨å¯¼</h3>
<h4 id="21">2.1 äºŒç»´ä½ç½®çš„è¡¨ç¤º</h4>
<p>å¯¹äºå›¾åƒpatchï¼Œä½ç½®ç”¨äºŒå…ƒç»„ $(x, y)$ è¡¨ç¤ºï¼Œå…¶ä¸­ $x$ æ˜¯è¡Œåæ ‡ï¼Œ$y$ æ˜¯åˆ—åæ ‡ã€‚</p>
<h4 id="22-rope-2d">2.2 RoPE-2Dçš„æ„é€ æ–¹æ¡ˆ</h4>
<p><strong>æ–¹æ¡ˆ1: äº¤é”™åˆ†é…</strong> - å°† $d$ ç»´å‘é‡åˆ†ä¸ºä¸¤åŠï¼Œåˆ†åˆ«ç¼–ç  $x$ å’Œ $y$ï¼š</p>
<p>\begin{equation}
\boldsymbol{\mathcal{R}}<em d_4-1="d/4-1">{x,y}^{\text{split}} = \begin{pmatrix}
\boldsymbol{R}(x\theta_0) &amp; &amp; &amp; &amp; &amp; \
&amp; \ddots &amp; &amp; &amp; &amp; \
&amp; &amp; \boldsymbol{R}(x\theta</em>) &amp; &amp; &amp; \
&amp; &amp; &amp; \boldsymbol{R}(y\theta_{d/4}) &amp; &amp; \
&amp; &amp; &amp; &amp; \ddots &amp; \
&amp; &amp; &amp; &amp; &amp; \boldsymbol{R}(y\theta_{d/2-1})
\end{pmatrix}
\tag{11}
\end{equation}</p>
<p><strong>æ–¹æ¡ˆ2: äº¤æ›¿åˆ†é…</strong> - å¥‡æ•°ç»´åº¦ç¼–ç  $x$ï¼Œå¶æ•°ç»´åº¦ç¼–ç  $y$ï¼š</p>
<p>\begin{equation}
\boldsymbol{\mathcal{R}}<em d_2-1="d/2-1">{x,y}^{\text{alternate}} = \begin{pmatrix}
\boldsymbol{R}(x\theta_0) &amp; &amp; &amp; \
&amp; \boldsymbol{R}(y\theta_1) &amp; &amp; \
&amp; &amp; \ddots &amp; \
&amp; &amp; &amp; \boldsymbol{R}(y\theta</em>)
\end{pmatrix}
\tag{12}
\end{equation}</p>
<p>å…¶ä¸­ï¼š</p>
<p>\begin{equation}
\theta_{2i} = b^{-4i/d} \quad (\text{ç¼–ç } x)
\tag{13}
\end{equation}</p>
<p>\begin{equation}
\theta_{2i+1} = b^{-4i/d} \quad (\text{ç¼–ç } y)
\tag{14}
\end{equation}</p>
<p><strong>å¯¹ç§°æ€§</strong>: è®¾ç½® $\theta_{2i} = \theta_{2i+1}$ ä¿è¯äº† $x$ å’Œ $y$ çš„å¯¹ç§°æ€§ã€‚</p>
<h4 id="23-rope-2d">2.3 RoPE-2Dçš„ç›¸å¯¹ä½ç½®æ€§è´¨</h4>
<p>å¯¹äºä½ç½® $(m_x, m_y)$ å’Œ $(n_x, n_y)$ï¼š</p>
<p>\begin{equation}
\boldsymbol{\mathcal{R}}<em n_x_="n_x," n_y="n_y">{m_x, m_y}^\top \boldsymbol{\mathcal{R}}</em>
\tag{15}
\end{equation}} = \boldsymbol{\mathcal{R}}_{n_x - m_x, n_y - m_y</p>
<p><strong>è¯æ˜</strong>: å¯¹äºç¼–ç  $x$ çš„ç»´åº¦ï¼š</p>
<p>\begin{equation}
\boldsymbol{R}(m_x\theta_i)^\top \boldsymbol{R}(n_x\theta_i) = \boldsymbol{R}((n_x - m_x)\theta_i)
\tag{16}
\end{equation}</p>
<p>å¯¹äºç¼–ç  $y$ çš„ç»´åº¦åŒç†ã€‚å› æ­¤å†…ç§¯åªä¾èµ–äº $(n_x - m_x, n_y - m_y)$ã€‚â–¡</p>
<h4 id="24-rope-2d">2.4 RoPE-2Dçš„è·ç¦»åº¦é‡</h4>
<p>äºŒç»´ç›¸å¯¹ä½ç½® $(\Delta x, \Delta y)$ çš„ç¼–ç å¼ºåº¦ï¼š</p>
<p>\begin{equation}
s(\Delta x, \Delta y) = \sum_{i=0}^{d/4-1} \cos(\Delta x \cdot \theta_{2i}) + \sum_{i=0}^{d/4-1} \cos(\Delta y \cdot \theta_{2i+1})
\tag{17}
\end{equation}</p>
<p><strong>å„å‘åŒæ€§</strong>: å½“ $\theta_{2i} = \theta_{2i+1}$ æ—¶ï¼Œæ¬§æ°è·ç¦»ç›¸åŒçš„ä½ç½®è·å¾—ç›¸ä¼¼çš„ç¼–ç ã€‚</p>
<p>\begin{equation}
s(\Delta x, \Delta y) \approx f(\sqrt{\Delta x^2 + \Delta y^2})
\tag{18}
\end{equation}</p>
<h3 id="_9">ä¸‰ã€å¤šæ¨¡æ€ä½ç½®ç¼–ç çš„æŒ‘æˆ˜</h3>
<h4 id="31">3.1 ç»´åº¦ä¸åŒ¹é…é—®é¢˜</h4>
<p>è€ƒè™‘æ–‡æœ¬-å›¾åƒæ··åˆè¾“å…¥ï¼š
- æ–‡æœ¬tokenä½ç½®: $n \in \mathbb{N}$ (ä¸€ç»´)
- å›¾åƒpatchä½ç½®: $(x, y) \in \mathbb{N}^2$ (äºŒç»´)</p>
<p><strong>ç›´æ¥é—®é¢˜</strong>: æ— æ³•ç›´æ¥è®¡ç®—ä¸åŒç»´åº¦ä½ç½®ä¹‹é—´çš„ç›¸å¯¹ä½ç½®å·®ã€‚</p>
<p>\begin{equation}
\boldsymbol{\mathcal{R}}<em x_y="x,y">n^\top \boldsymbol{\mathcal{R}}</em>
\tag{19}
\end{equation}} = \text{?</p>
<h4 id="32">3.2 å‡ç»´ç­–ç•¥çš„æ•°å­¦åŸºç¡€</h4>
<p><strong>æ ¸å¿ƒæ€æƒ³</strong>: å°†ä½ç»´ä½ç½®åµŒå…¥åˆ°é«˜ç»´ç©ºé—´ï¼Œç»Ÿä¸€ä½¿ç”¨é«˜ç»´RoPEã€‚</p>
<p>å¯¹äºæ–‡æœ¬ä½ç½® $n$ï¼Œå‡ç»´åˆ°äºŒç»´ï¼š</p>
<p>\begin{equation}
n \to (n, n)
\tag{20}
\end{equation}</p>
<p><strong>å‘åå…¼å®¹æ€§è¯æ˜</strong>: éœ€è¦è¯æ˜ $\boldsymbol{\mathcal{R}}<em n_n="n,n">n^{\text{1D}} = \boldsymbol{\mathcal{R}}</em>$ã€‚}^{\text{2D}</p>
<p>å¯¹äºRoPE-1D:</p>
<p>\begin{equation}
\boldsymbol{\mathcal{R}}<em d_2-1="d/2-1">n^{\text{1D}} = \text{diag}(\boldsymbol{R}(n\theta_0), \boldsymbol{R}(n\theta_1), \ldots, \boldsymbol{R}(n\theta</em>))
\tag{21}
\end{equation}</p>
<p>å¯¹äºRoPE-2D (äº¤æ›¿æ–¹æ¡ˆ):</p>
<p>\begin{equation}
\boldsymbol{\mathcal{R}}<em d_2-1="d/2-1">{n,n}^{\text{2D}} = \text{diag}(\boldsymbol{R}(n\theta_0), \boldsymbol{R}(n\theta_1), \ldots, \boldsymbol{R}(n\theta</em>))
\tag{22}
\end{equation}</p>
<p>å½“ $\theta_{2i} = \theta_{2i+1}$ æ—¶ï¼Œä¸¤è€…å®Œå…¨ç›¸åŒï¼â–¡</p>
<h3 id="rope-tv-rope-for-text-and-vision">å››ã€RoPE-TV (RoPE for Text and Vision) çš„æ•°å­¦è®¾è®¡</h3>
<h4 id="41">4.1 è®¾è®¡åŸåˆ™</h4>
<ol>
<li><strong>å…¼å®¹æ€§</strong>: çº¯æ–‡æœ¬æ—¶é€€åŒ–ä¸ºRoPE-1D</li>
<li><strong>ç­‰ä»·æ€§</strong>: Patchä¸Tokenåœ°ä½ç­‰ä»·</li>
<li><strong>å¯¹ç§°æ€§</strong>: æ¨¡æ€é—´è·ç¦»å¯¹ç§°</li>
</ol>
<h4 id="42">4.2 å›¾åƒä½ç½®ç¼–ç çš„ä¸€èˆ¬åŒ–</h4>
<p>å¯¹äº $w \times h$ çš„å›¾åƒï¼ŒåŸºç¡€äºŒç»´ä½ç½®ï¼š</p>
<p>\begin{equation}
\boldsymbol{P}_{\text{base}} = {(i, j) : 1 \leq i \leq h, 1 \leq j \leq w}
\tag{23}
\end{equation}</p>
<p>å¼•å…¥ç¼©æ”¾ $(\gamma_1, \gamma_2)$ å’Œåç½® $(\beta_1, \beta_2)$ï¼š</p>
<p>\begin{equation}
\boldsymbol{P}<em _text_base="\text{base">{\text{general}} = {(\beta_1 + i\gamma_1, \beta_2 + j\gamma_2) : (i,j) \in \boldsymbol{P}</em>}
\tag{24}
\end{equation}}</p>
<p><strong>æ•°å­¦æ€§è´¨</strong>: RoPEçš„ç›¸å¯¹ä½ç½®ä¸å˜æ€§ä¿è¯äº†åç½® $\beta$ ä¸å½±å“æ³¨æ„åŠ›è®¡ç®—ï¼ˆåªå½±å“ç»å¯¹ä½ç½®ï¼‰ã€‚</p>
<h4 id="43">4.3 ç­‰ä»·æ€§çº¦æŸçš„æ¨å¯¼</h4>
<p>å‡è®¾å·¦æ®µæ–‡æœ¬æœ€åä¸€ä¸ªtokenä½ç½®ä¸º $(L, L)$ï¼Œå›¾åƒæœ‰ $wh$ ä¸ªpatchã€‚</p>
<p><strong>ç­‰ä»·æ€§</strong>: å›¾åƒç­‰ä»·äº $wh$ ä¸ªè¿ç»­tokenï¼Œå› æ­¤å³æ®µæ–‡æœ¬ç¬¬ä¸€ä¸ªtokenä½ç½®åº”ä¸ºï¼š</p>
<p>\begin{equation}
(L + wh + 1, L + wh + 1)
\tag{25}
\end{equation}</p>
<h4 id="44">4.4 å¯¹ç§°æ€§çº¦æŸçš„æ¨å¯¼</h4>
<p>å›¾åƒç¬¬ä¸€ä¸ªpatchä½ç½®: $(\beta_1 + \gamma_1, \beta_2 + \gamma_2)$</p>
<p>å›¾åƒæœ€åä¸€ä¸ªpatchä½ç½®: $(\beta_1 + h\gamma_1, \beta_2 + w\gamma_2)$</p>
<p><strong>å¯¹ç§°æ€§è¦æ±‚</strong>: æ–‡æœ¬åˆ°å›¾åƒçš„è·ç¦» = å›¾åƒåˆ°æ–‡æœ¬çš„è·ç¦»</p>
<p>\begin{equation}
\begin{pmatrix}
\beta_1 + \gamma_1 - L \
\beta_2 + \gamma_2 - L
\end{pmatrix} = \begin{pmatrix}
L + wh + 1 - (\beta_1 + h\gamma_1) \
L + wh + 1 - (\beta_2 + w\gamma_2)
\end{pmatrix}
\tag{26}
\end{equation}</p>
<p>å±•å¼€ï¼š</p>
<p>\begin{equation}
2\beta_1 + (h+1)\gamma_1 = 2L + wh + 1
\tag{27}
\end{equation}</p>
<p>\begin{equation}
2\beta_2 + (w+1)\gamma_2 = 2L + wh + 1
\tag{28}
\end{equation}</p>
<h4 id="45-rope-tv">4.5 RoPE-TVçš„è§£</h4>
<p>é€‰æ‹© $\gamma_1 = \gamma_2 = 1$ (ä¿æŒpatché—´è·ä¸º1)ï¼š</p>
<p>\begin{equation}
\beta_1 = L + \frac{wh - h}{2} = L + \frac{h(w-1)}{2}
\tag{29}
\end{equation}</p>
<p>\begin{equation}
\beta_2 = L + \frac{wh - w}{2} = L + \frac{w(h-1)}{2}
\tag{30}
\end{equation}</p>
<p><strong>æ•°å€¼ç¤ºä¾‹</strong>: $L=100, w=h=16$:</p>
<p>\begin{equation}
\beta_1 = \beta_2 = 100 + \frac{16 \times 15}{2} = 100 + 120 = 220
\tag{31}
\end{equation}</p>
<p>å›¾åƒç¬¬ä¸€ä¸ªpatch: $(221, 221)$</p>
<p>å›¾åƒæœ€åä¸€ä¸ªpatch: $(236, 236)$</p>
<p>å³æ®µæ–‡æœ¬ç¬¬ä¸€ä¸ª: $(357, 357) = (100 + 256 + 1, 100 + 256 + 1)$</p>
<p>éªŒè¯å¯¹ç§°æ€§ï¼š
- æ–‡æœ¬åˆ°å›¾åƒ: $(221-100, 221-100) = (121, 121)$
- å›¾åƒåˆ°æ–‡æœ¬: $(357-236, 357-236) = (121, 121)$ âœ“</p>
<h3 id="alibi">äº”ã€ALiBiä½ç½®ç¼–ç çš„æ•°å­¦åŸç†</h3>
<h4 id="51-alibi">5.1 ALiBiçš„å®šä¹‰</h4>
<p>ALiBi (Attention with Linear Biases) ä¸ä¿®æ”¹Qå’ŒKï¼Œè€Œæ˜¯åœ¨æ³¨æ„åŠ›logitsä¸Šæ·»åŠ åç½®ï¼š</p>
<p>\begin{equation}
\text{Attention}(\boldsymbol{Q}, \boldsymbol{K}, \boldsymbol{V}) = \text{softmax}\left(\frac{\boldsymbol{Q}\boldsymbol{K}^\top}{\sqrt{d_k}} + \boldsymbol{B}\right) \boldsymbol{V}
\tag{32}
\end{equation}</p>
<p>å…¶ä¸­åç½®çŸ©é˜µï¼š</p>
<p>\begin{equation}
B_{i,j} = -m \cdot |i - j|
\tag{33}
\end{equation}</p>
<p>$m &gt; 0$ æ˜¯head-specificçš„æ–œç‡ã€‚</p>
<h4 id="52-alibi">5.2 ALiBiçš„é•¿åº¦å¤–æ¨æ€§</h4>
<p><strong>å…³é”®æ€§è´¨</strong>: ALiBiçš„åç½®æ˜¯è·ç¦»çš„çº¿æ€§å‡½æ•°ï¼Œä¸ä¾èµ–ç»å¯¹ä½ç½®ã€‚</p>
<p>è®­ç»ƒé•¿åº¦ $L_{\text{train}}$ï¼Œæ¨ç†é•¿åº¦ $L_{\text{infer}} &gt; L_{\text{train}}$ï¼š</p>
<p>\begin{equation}
B_{i,j}^{\text{infer}} = -m \cdot |i - j|
\tag{34}
\end{equation}</p>
<p>ä¸è®­ç»ƒæ—¶çš„å½¢å¼å®Œå…¨ä¸€è‡´ï¼Œåªæ˜¯ $|i-j|$ çš„èŒƒå›´æ‰©å¤§ã€‚</p>
<p><strong>æ•°å­¦ç›´è§‰</strong>: æ¨¡å‹å­¦ä¹ çš„æ˜¯"è·ç¦»è¶Šè¿œï¼Œæ³¨æ„åŠ›è¶Šå°"ï¼Œè¿™ä¸ªè§„åˆ™åœ¨æ›´é•¿åºåˆ—ä¸Šä»ç„¶é€‚ç”¨ã€‚</p>
<h4 id="53-alibi-vs-rope">5.3 ALiBi vs RoPEçš„å¯¹æ¯”</h4>
<table>
<thead>
<tr>
<th>ç‰¹æ€§</th>
<th>RoPE</th>
<th>ALiBi</th>
</tr>
</thead>
<tbody>
<tr>
<td>å®ç°æ–¹å¼</td>
<td>ä¿®æ”¹Qå’ŒK (æ—‹è½¬)</td>
<td>æ·»åŠ æ³¨æ„åŠ›åç½®</td>
</tr>
<tr>
<td>é•¿åº¦å¤–æ¨</td>
<td>éœ€è¦æ’å€¼</td>
<td>è‡ªç„¶å¤–æ¨</td>
</tr>
<tr>
<td>è®¡ç®—å¼€é”€</td>
<td>è¾ƒé«˜ (çŸ©é˜µä¹˜æ³•)</td>
<td>è¾ƒä½ (åŠ æ³•)</td>
</tr>
<tr>
<td>ä½ç½®ä¿¡æ¯</td>
<td>ç»å¯¹+ç›¸å¯¹</td>
<td>çº¯ç›¸å¯¹</td>
</tr>
</tbody>
</table>
<p><strong>å¤–æ¨æ€§å¯¹æ¯”</strong>: å¯¹äºè®­ç»ƒé•¿åº¦2048ï¼Œæ¨ç†é•¿åº¦8192ï¼š
- ALiBi: ç›´æ¥ä½¿ç”¨ï¼Œæ€§èƒ½ä¸‹é™ &lt; 5%
- RoPE: éœ€è¦ä½ç½®æ’å€¼ï¼Œæ€§èƒ½ä¸‹é™ 10-20%</p>
<h3 id="position-interpolation">å…­ã€ä½ç½®æ’å€¼ (Position Interpolation) çš„æ•°å­¦æ¨å¯¼</h3>
<h4 id="61-rope">6.1 RoPEçš„é•¿åº¦å¤–æ¨é—®é¢˜</h4>
<p>RoPEåœ¨è®­ç»ƒé•¿åº¦ $L_{\text{train}}$ æ—¶ï¼Œæœ€å¤§ä½ç½®ä¸º $L_{\text{train}} - 1$ã€‚</p>
<p>æ¨ç†æ—¶ä½¿ç”¨ä½ç½® $n &gt; L_{\text{train}}$ï¼š</p>
<p>\begin{equation}
\boldsymbol{\mathcal{R}}<em d_2-1="d/2-1">n = \text{diag}(\boldsymbol{R}(n\theta_0), \ldots, \boldsymbol{R}(n\theta</em>))
\tag{35}
\end{equation}</p>
<p><strong>é—®é¢˜</strong>: è®­ç»ƒæ—¶ä»æœªè§è¿‡ $n &gt; L_{\text{train}}$ çš„æ—‹è½¬è§’åº¦ï¼Œæ¨¡å‹å¯èƒ½æ— æ³•æ­£ç¡®å¤„ç†ã€‚</p>
<h4 id="62-pi">6.2 ä½ç½®æ’å€¼ (PI) çš„æ–¹æ¡ˆ</h4>
<p><strong>æ ¸å¿ƒæ€æƒ³</strong>: å°†æ¨ç†ä½ç½® $n$ ç¼©æ”¾åˆ°è®­ç»ƒèŒƒå›´å†…ã€‚</p>
<p>ç¼©æ”¾å› å­ï¼š</p>
<p>\begin{equation}
s = \frac{L_{\text{train}}}{L_{\text{infer}}}
\tag{36}
\end{equation}</p>
<p>æ’å€¼åçš„ä½ç½®ï¼š</p>
<p>\begin{equation}
n' = n \cdot s = n \cdot \frac{L_{\text{train}}}{L_{\text{infer}}}
\tag{37}
\end{equation}</p>
<p>ä½¿ç”¨ $\boldsymbol{\mathcal{R}}_{n'}$ æ›¿ä»£ $\boldsymbol{\mathcal{R}}_n$ã€‚</p>
<p><strong>æ•°å€¼ç¤ºä¾‹</strong>: $L_{\text{train}} = 2048, L_{\text{infer}} = 8192$:</p>
<p>\begin{equation}
s = \frac{2048}{8192} = 0.25
\tag{38}
\end{equation}</p>
<p>ä½ç½® $n=4000$ è¢«æ’å€¼ä¸º $n' = 1000$ï¼Œåœ¨è®­ç»ƒèŒƒå›´å†…ã€‚</p>
<h4 id="63">6.3 ä½ç½®æ’å€¼çš„ç†è®ºåˆ†æ</h4>
<p><strong>ç›¸å¯¹ä½ç½®ä¿æŒ</strong>: å¯¹äºä½ç½® $m$ å’Œ $n$ï¼š</p>
<p>\begin{equation}
\frac{n' - m'}{L_{\text{infer}}} = \frac{ns - ms}{L_{\text{infer}}} = \frac{(n-m)s}{L_{\text{infer}}} = \frac{n-m}{L_{\text{train}}}
\tag{39}
\end{equation}</p>
<p>ç›¸å¯¹ä½ç½®çš„æ¯”ä¾‹ä¿æŒä¸å˜ï¼</p>
<p><strong>é«˜é¢‘æŸå¤±</strong>: æ’å€¼ä¼šå‹ç¼©é«˜é¢‘ä¿¡æ¯ï¼ˆå° $\theta_i$ï¼‰ï¼š</p>
<p>\begin{equation}
\theta_i \cdot n' = \theta_i \cdot ns = (\theta_i s) \cdot n
\tag{40}
\end{equation}</p>
<p>ç­‰æ•ˆäºé¢‘ç‡ä» $\theta_i$ é™ä½åˆ° $\theta_i s$ã€‚</p>
<h3 id="ntk-aware">ä¸ƒã€NTK-Awareæ’å€¼çš„æ”¹è¿›</h3>
<h4 id="71-ntk-neural-tangent-kernel">7.1 NTK (Neural Tangent Kernel) ç†è®º</h4>
<p>NTKç†è®ºæŒ‡å‡ºï¼Œä¸åŒé¢‘ç‡å¯¹é•¿åº¦å¤–æ¨çš„æ•æ„Ÿåº¦ä¸åŒï¼š
- ä½é¢‘ (å¤§ $\theta_i$): å¯¹é•¿è·ç¦»æ•æ„Ÿï¼Œéœ€è¦è°ƒæ•´
- é«˜é¢‘ (å° $\theta_i$): å¯¹çŸ­è·ç¦»æ•æ„Ÿï¼Œåº”ä¿æŒ</p>
<h4 id="72-ntk-aware">7.2 NTK-Awareçš„é¢‘ç‡è°ƒæ•´</h4>
<p>ä¸æ˜¯ç»Ÿä¸€ç¼©æ”¾ä½ç½®ï¼Œè€Œæ˜¯è°ƒæ•´é¢‘ç‡ï¼š</p>
<p>\begin{equation}
\theta_i' = \theta_i \cdot s^{f(i)}
\tag{41}
\end{equation}</p>
<p>å…¶ä¸­ $f(i)$ æ˜¯æ’å€¼å‡½æ•°ï¼š</p>
<p>\begin{equation}
f(i) = \begin{cases}
1, &amp; i &lt; i_{\text{threshold}} \
\frac{i - i_{\text{threshold}}}{d/2 - i_{\text{threshold}}}, &amp; i \geq i_{\text{threshold}}
\end{cases}
\tag{42}
\end{equation}</p>
<p><strong>æ•ˆæœ</strong>: ä½é¢‘å®Œå…¨è°ƒæ•´ï¼Œé«˜é¢‘ä¿æŒä¸å˜ã€‚</p>
<p>\begin{equation}
\theta_0' = \theta_0 \cdot s, \quad \theta_{d/2-1}' = \theta_{d/2-1}
\tag{43}
\end{equation}</p>
<h4 id="73-ntk">7.3 åŠ¨æ€NTKæ’å€¼</h4>
<p>æ›´æ¿€è¿›çš„æ–¹æ¡ˆï¼šæ ¹æ®åºåˆ—é•¿åº¦åŠ¨æ€è°ƒæ•´åŸºæ•° $b$ï¼š</p>
<p>\begin{equation}
b' = b \cdot \left(\frac{L_{\text{infer}}}{L_{\text{train}}}\right)^{d/(d-2)}
\tag{44}
\end{equation}</p>
<p>æ–°çš„é¢‘ç‡ï¼š</p>
<p>\begin{equation}
\theta_i' = (b')^{-2i/d} = b^{-2i/d} \cdot \left(\frac{L_{\text{infer}}}{L_{\text{train}}}\right)^{-2i/(d-2)}
\tag{45}
\end{equation}</p>
<p><strong>æ•°å€¼ç¤ºä¾‹</strong>: $d=128, b=10000, L_{\text{train}}=2048, L_{\text{infer}}=8192$:</p>
<p>\begin{equation}
b' = 10000 \times 4^{128/126} \approx 10000 \times 4.03 = 40300
\tag{46}
\end{equation}</p>
<h3 id="-">å…«ã€å›¾åƒ-æ–‡æœ¬ä½ç½®å¯¹é½çš„ç†è®º</h3>
<h4 id="81-vit">8.1 ViTçš„ä½ç½®ç¼–ç </h4>
<p>Vision Transformerä½¿ç”¨å¯å­¦ä¹ çš„ä½ç½®åµŒå…¥ï¼š</p>
<p>\begin{equation}
\boldsymbol{x}_i' = \boldsymbol{x}_i + \boldsymbol{p}_i
\tag{47}
\end{equation}</p>
<p>å…¶ä¸­ $\boldsymbol{p}_i \in \mathbb{R}^d$ æ˜¯ä½ç½®åµŒå…¥ï¼Œé€šè¿‡è®­ç»ƒå­¦ä¹ ã€‚</p>
<p><strong>ç¼ºç‚¹</strong>: ä½ç½®åµŒå…¥æ•°é‡å›ºå®šï¼Œéš¾ä»¥å¤„ç†å˜åˆ†è¾¨ç‡è¾“å…¥ã€‚</p>
<h4 id="82-clip">8.2 CLIPçš„ä½ç½®ç¼–ç ç­–ç•¥</h4>
<p>CLIPåœ¨å›¾åƒç¼–ç å™¨ä½¿ç”¨ViTå¼çš„å¯å­¦ä¹ ä½ç½®åµŒå…¥ï¼Œåœ¨æ–‡æœ¬ç¼–ç å™¨ä½¿ç”¨å­¦ä¹ çš„ä½ç½®åµŒå…¥ã€‚</p>
<p><strong>è·¨æ¨¡æ€å¯¹é½</strong>: é€šè¿‡å¯¹æ¯”å­¦ä¹ ï¼Œä½¿å¾—å›¾åƒå’Œæ–‡æœ¬çš„ç‰¹å¾åœ¨åŒä¸€è¯­ä¹‰ç©ºé—´ã€‚</p>
<p>\begin{equation}
\mathcal{L}<em t_="t'">{\text{CLIP}} = -\log \frac{\exp(\text{sim}(\boldsymbol{i}, \boldsymbol{t}) / \tau)}{\sum</em>
\tag{48}
\end{equation}} \exp(\text{sim}(\boldsymbol{i}, \boldsymbol{t}') / \tau)</p>
<p><strong>ä½ç½®ç¼–ç çš„éšå¼å¯¹é½</strong>: å¯¹æ¯”å­¦ä¹ éšå¼åœ°ä½¿å¾—ç›¸ä¼¼ä½ç½®çš„patchå’Œtokenå­¦ä¹ åˆ°ç›¸ä¼¼çš„ä½ç½®è¡¨ç¤ºã€‚</p>
<h4 id="83">8.3 æ’å€¼ç­–ç•¥å¤„ç†å˜åˆ†è¾¨ç‡</h4>
<p>å¯¹äºè®­ç»ƒåˆ†è¾¨ç‡ $H_{\text{train}} \times W_{\text{train}}$ï¼Œæ¨ç†åˆ†è¾¨ç‡ $H_{\text{infer}} \times W_{\text{infer}}$ï¼š</p>
<p><strong>äºŒç»´æ’å€¼</strong>:</p>
<p>\begin{equation}
\boldsymbol{p}<em i_j_="i',j'">{i,j}^{\text{infer}} = \text{Interpolate}({\boldsymbol{p}</em>}<em _text_train="\text{train">{i',j'}, (i \cdot \frac{H</em>))
\tag{49}
\end{equation}}}}{H_{\text{infer}}}, j \cdot \frac{W_{\text{train}}}{W_{\text{infer}}</p>
<p>ä½¿ç”¨åŒçº¿æ€§æˆ–åŒä¸‰æ¬¡æ’å€¼ã€‚</p>
<h3 id="_10">ä¹ã€å¤šå°ºåº¦ä½ç½®ç¼–ç çš„æ•°å­¦è®¾è®¡</h3>
<h4 id="91">9.1 é‡‘å­—å¡”ä½ç½®ç¼–ç </h4>
<p>å¯¹äºä¸åŒåˆ†è¾¨ç‡çš„ç‰¹å¾ï¼Œä½¿ç”¨ä¸åŒå°ºåº¦çš„ä½ç½®ç¼–ç ï¼š</p>
<p>\begin{equation}
\boldsymbol{\mathcal{R}}<em x_2_s_="x/2^s," y_2_s="y/2^s">{x,y}^{(s)} = \boldsymbol{\mathcal{R}}</em>
\tag{50}
\end{equation}</p>
<p>å…¶ä¸­ $s$ æ˜¯é‡‘å­—å¡”å±‚çº§ã€‚</p>
<p><strong>æ•°å­¦ç›´è§‰</strong>: æµ…å±‚å…³æ³¨ç»†èŠ‚ï¼ˆé«˜åˆ†è¾¨ç‡ï¼‰ï¼Œæ·±å±‚å…³æ³¨å…¨å±€ï¼ˆä½åˆ†è¾¨ç‡ï¼‰ã€‚</p>
<h4 id="92-conditional-pe">9.2 æ¡ä»¶ä½ç½®ç¼–ç  (Conditional PE)</h4>
<p>æ ¹æ®è¾“å…¥è‡ªé€‚åº”ç”Ÿæˆä½ç½®ç¼–ç ï¼š</p>
<p>\begin{equation}
\boldsymbol{p}<em _text_PE="\text{PE">i = f</em>_i, i)
\tag{51}
\end{equation}}}(\boldsymbol{x</p>
<p>$f_{\text{PE}}$ æ˜¯ä¸€ä¸ªå°å‹ç½‘ç»œï¼ˆå¦‚MLPï¼‰ã€‚</p>
<p><strong>ä¼˜åŠ¿</strong>:
1. å‚æ•°å…±äº«ï¼Œä¸å—åºåˆ—é•¿åº¦é™åˆ¶
2. å¯ä»¥ç¼–ç ç›¸å¯¹ä½ç½®å…³ç³»</p>
<h3 id="_11">åã€å®è·µå»ºè®®ä¸æ•°å€¼éªŒè¯</h3>
<h4 id="101">10.1 ä¸åŒæ¨¡æ€çš„ä½ç½®ç¼–ç é€‰æ‹©</h4>
<table>
<thead>
<tr>
<th>æ¨¡æ€</th>
<th>æ¨èæ–¹æ¡ˆ</th>
<th>ç†ç”±</th>
</tr>
</thead>
<tbody>
<tr>
<td>çº¯æ–‡æœ¬</td>
<td>RoPE-1D</td>
<td>å¤–æ¨æ€§å¥½ï¼Œæ•ˆæœä¼˜</td>
</tr>
<tr>
<td>çº¯å›¾åƒ</td>
<td>RoPE-2Dæˆ–å¯å­¦ä¹ </td>
<td>ä¿æŒç©ºé—´ç»“æ„</td>
</tr>
<tr>
<td>æ–‡æœ¬-å›¾åƒ</td>
<td>RoPE-TV</td>
<td>ç»Ÿä¸€æ¡†æ¶ï¼Œå…¼å®¹æ€§å¥½</td>
</tr>
<tr>
<td>æ–‡æœ¬-è§†é¢‘</td>
<td>RoPE-3Dæˆ–åˆ†ç¦»</td>
<td>æ—¶é—´ç»´åº¦ç‰¹æ®Šå¤„ç†</td>
</tr>
</tbody>
</table>
<h4 id="102">10.2 é•¿åº¦å¤–æ¨çš„é…ç½®å»ºè®®</h4>
<p><strong>è®­ç»ƒé•¿åº¦ $L_{\text{train}} = 2048$</strong>:</p>
<table>
<thead>
<tr>
<th>ç›®æ ‡é•¿åº¦</th>
<th>æ–¹æ³•</th>
<th>é…ç½®</th>
</tr>
</thead>
<tbody>
<tr>
<td>4096</td>
<td>PI</td>
<td>$s = 0.5$</td>
</tr>
<tr>
<td>8192</td>
<td>NTK</td>
<td>$b' \approx 40000$</td>
</tr>
<tr>
<td>16384</td>
<td>Dynamic NTK + å¾®è°ƒ</td>
<td>$b' \approx 160000$ + 1000æ­¥</td>
</tr>
<tr>
<td>32768+</td>
<td>ALiBiæ›¿æ¢</td>
<td>$m = {0.5, 1, 2, 4}$</td>
</tr>
</tbody>
</table>
<h4 id="103-rope-tv">10.3 RoPE-TVçš„å‚æ•°è®¡ç®—</h4>
<p>Pythonå®ç°ç¤ºä¾‹:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute_rope_tv_offset</span><span class="p">(</span><span class="n">L_text</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    è®¡ç®—RoPE-TVçš„åç½®å‚æ•°</span>

<span class="sd">    Args:</span>
<span class="sd">        L_text: å·¦æ®µæ–‡æœ¬é•¿åº¦</span>
<span class="sd">        w, h: å›¾åƒçš„å®½å’Œé«˜ï¼ˆpatchæ•°ï¼‰</span>

<span class="sd">    Returns:</span>
<span class="sd">        beta_1, beta_2: åç½®å‚æ•°</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">wh</span> <span class="o">=</span> <span class="n">w</span> <span class="o">*</span> <span class="n">h</span>
    <span class="n">beta_1</span> <span class="o">=</span> <span class="n">L_text</span> <span class="o">+</span> <span class="p">(</span><span class="n">wh</span> <span class="o">-</span> <span class="n">h</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">beta_2</span> <span class="o">=</span> <span class="n">L_text</span> <span class="o">+</span> <span class="p">(</span><span class="n">wh</span> <span class="o">-</span> <span class="n">w</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="k">return</span> <span class="n">beta_1</span><span class="p">,</span> <span class="n">beta_2</span>
</code></pre></div>

<p><strong>æ•°å€¼éªŒè¯</strong>:</p>
<p>\begin{equation}
\text{assert: } (\beta_1 + \gamma_1, \beta_2 + \gamma_2) - (L, L) = (L + wh + 1, L + wh + 1) - (\beta_1 + h, \beta_2 + w)
\tag{52}
\end{equation}</p>
<h4 id="104-qwen2-vlm-rope">10.4 Qwen2-VLçš„M-RoPEåˆ†æ</h4>
<p>Qwen2-VLçš„M-RoPEé€‰æ‹© $\beta_1 = \beta_2 = \beta_3 = L, \gamma_1 = \gamma_2 = \gamma_3 = 1$ã€‚</p>
<p><strong>ä¼˜ç‚¹</strong>: å®ç°ç®€å•ï¼Œè®¡ç®—é«˜æ•ˆ</p>
<p><strong>ç¼ºç‚¹</strong>:
1. ä¸æ»¡è¶³å¯¹ç§°æ€§: å·¦æ–‡æœ¬åˆ°å›¾åƒè·ç¦» $\neq$ å›¾åƒåˆ°å³æ–‡æœ¬è·ç¦»
2. ä¸æ»¡è¶³ç­‰ä»·æ€§: $wh$ ä¸ªpatchä¸ç­‰ä»·äº $wh$ ä¸ªtoken</p>
<p><strong>æ•°å€¼å¯¹æ¯”</strong>: $L=100, w=h=16$:</p>
<table>
<thead>
<tr>
<th>æ–¹æ¡ˆ</th>
<th>å›¾åƒé¦–patch</th>
<th>å›¾åƒæœ«patch</th>
<th>å³æ–‡æœ¬é¦–token</th>
<th>å¯¹ç§°æ€§</th>
</tr>
</thead>
<tbody>
<tr>
<td>RoPE-TV</td>
<td>$(220, 220)$</td>
<td>$(235, 235)$</td>
<td>$(356, 356)$</td>
<td>âœ“</td>
</tr>
<tr>
<td>M-RoPE</td>
<td>$(101, 101)$</td>
<td>$(116, 116)$</td>
<td>$(117, 117)$</td>
<td>âœ—</td>
</tr>
</tbody>
</table>
<p>M-RoPEä¸­ï¼Œ256ä¸ªpatchåªç›¸å½“äº16ä¸ªtokençš„è·ç¦»ï¼</p>
<h3 id="_12">åä¸€ã€æ€»ç»“</h3>
<p>æœ¬èŠ‚è¯¦ç»†æ¨å¯¼äº†å¤šæ¨¡æ€ä½ç½®ç¼–ç çš„æ•°å­¦åŸç†ï¼š</p>
<p><strong>æ ¸å¿ƒå…¬å¼</strong>:</p>
<ol>
<li>
<p><strong>RoPE-1Dçš„ç›¸å¯¹ä½ç½®æ€§è´¨</strong>:
\begin{equation}
\boldsymbol{\mathcal{R}}<em n-m="n-m">m^\top \boldsymbol{\mathcal{R}}_n = \boldsymbol{\mathcal{R}}</em>
\tag{53}
\end{equation}</p>
</li>
<li>
<p><strong>RoPE-TVçš„å¯¹ç§°æ€§çº¦æŸ</strong>:
\begin{equation}
\beta_1 = L + \frac{h(w-1)}{2}, \quad \beta_2 = L + \frac{w(h-1)}{2}
\tag{54}
\end{equation}</p>
</li>
<li>
<p><strong>ä½ç½®æ’å€¼çš„ç¼©æ”¾</strong>:
\begin{equation}
n' = n \cdot \frac{L_{\text{train}}}{L_{\text{infer}}}
\tag{55}
\end{equation}</p>
</li>
<li>
<p><strong>NTK-Awareçš„é¢‘ç‡è°ƒæ•´</strong>:
\begin{equation}
b' = b \cdot \left(\frac{L_{\text{infer}}}{L_{\text{train}}}\right)^{d/(d-2)}
\tag{56}
\end{equation}</p>
</li>
</ol>
<p><strong>è®¾è®¡åŸåˆ™</strong>:
1. <strong>å…¼å®¹æ€§</strong>: å•æ¨¡æ€æ—¶é€€åŒ–ä¸ºæ ‡å‡†æ–¹æ¡ˆ
2. <strong>ç­‰ä»·æ€§</strong>: ä¸åŒæ¨¡æ€çš„åŸºæœ¬å•å…ƒåœ°ä½å¹³ç­‰
3. <strong>å¯¹ç§°æ€§</strong>: è·¨æ¨¡æ€è·ç¦»å¯¹ç§°ä¸€è‡´</p>
<p>é€šè¿‡ä¸¥æ ¼çš„æ•°å­¦æ¨å¯¼ï¼ŒRoPE-TVå®ç°äº†ç»Ÿä¸€ã€ä¼˜é›…çš„å¤šæ¨¡æ€ä½ç½®ç¼–ç æ–¹æ¡ˆã€‚</p>
        </div>
    </div>
</body>
</html>