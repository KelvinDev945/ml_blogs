<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transformerå‡çº§ä¹‹è·¯ï¼š18ã€RoPEçš„åº•æ•°é€‰æ‹©åŸåˆ™</title>
    <style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    line-height: 1.6; color: #333; max-width: 900px; margin: 0 auto; padding: 20px; background: #f5f5f5;
}
.container { background: white; padding: 40px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
header { border-bottom: 2px solid #e0e0e0; padding-bottom: 20px; margin-bottom: 30px; }
h1 { color: #2c3e50; margin-bottom: 10px; font-size: 2em; }
.meta { color: #666; font-size: 0.9em; margin-bottom: 20px; }
.content { margin-top: 30px; overflow-wrap: break-word; }
.content h2 { color: #34495e; margin-top: 30px; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
.content p { margin-bottom: 15px; }
.content pre { background: #f8f8f8; padding: 15px; border-radius: 5px; overflow-x: auto; border-left: 3px solid #3498db; margin: 15px 0; }
.content code { background: #f8f8f8; padding: 2px 5px; border-radius: 3px; font-family: monospace; font-size: 0.9em; }
.content blockquote { border-left: 4px solid #3498db; padding-left: 20px; margin: 20px 0; color: #555; font-style: italic; }
.content table { border-collapse: collapse; width: 100%; margin: 20px 0; }
.content th, .content td { border: 1px solid #ddd; padding: 10px; text-align: left; }
.back-link { display: inline-block; margin-bottom: 20px; color: #3498db; text-decoration: none; font-weight: 500; }
</style>
    
<script>
    window.MathJax = {
        tex: {
            inlineMath: [['$', '$'], ['\(', '\)']],
            displayMath: [['$$', '$$'], ['\[', '\]']],
            processEscapes: true
        }
    };
</script>
<script id="MathJax-script" async src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>

</head>
<body>
    <div class="container">
        <a href="../index.html" class="back-link">â† è¿”å›é¦–é¡µ</a>
        <header>
            <h1>Transformerå‡çº§ä¹‹è·¯ï¼š18ã€RoPEçš„åº•æ•°é€‰æ‹©åŸåˆ™</h1>
            <div class="meta">ğŸ“… æœ€åæ›´æ–°: 2025-11-26 | ğŸ“„ å¤§å°: 40.6 KB</div>
        </header>
        <div class="content">
            <p><strong>åŸæ–‡é“¾æ¥</strong>: <a href="https://spaces.ac.cn/archives/10122">https://spaces.ac.cn/archives/10122</a></p>
<p><strong>å‘å¸ƒæ—¥æœŸ</strong>: </p>
<hr />
<p>æˆ‘ä»¬çŸ¥é“ï¼Œåœ¨<a href="/archives/8265">RoPE</a>ä¸­é¢‘ç‡çš„è®¡ç®—å…¬å¼ä¸º$\theta_i = b^{-2i/d}$ï¼Œåº•æ•°$b$é»˜è®¤å€¼ä¸º10000ã€‚ç›®å‰Long Contextçš„ä¸»æµåšæ³•ä¹‹ä¸€æ˜¯ï¼Œå…ˆåœ¨$b=10000$ä¸Šç”¨çŸ­æ–‡æœ¬é¢„è®­ç»ƒï¼Œç„¶åè°ƒå¤§$b$å¹¶åœ¨é•¿æ–‡æœ¬å¾®è°ƒï¼Œå…¶å‡ºå‘ç‚¹æ˜¯<a href="/archives/9675">ã€ŠTransformerå‡çº§ä¹‹è·¯ï¼š10ã€RoPEæ˜¯ä¸€ç§Î²è¿›åˆ¶ç¼–ç ã€‹</a>é‡Œä»‹ç»çš„NTK-RoPEï¼Œå®ƒæœ¬èº«æœ‰è¾ƒå¥½é•¿åº¦å¤–æ¨æ€§ï¼Œæ¢ç”¨æ›´å¤§çš„$b$å†å¾®è°ƒç›¸æ¯”ä¸åŠ æ”¹åŠ¨çš„å¾®è°ƒï¼Œèµ·å§‹æŸå¤±æ›´å°ï¼Œæ”¶æ•›ä¹Ÿæ›´å¿«ã€‚è¯¥è¿‡ç¨‹ç»™äººçš„æ„Ÿè§‰æ˜¯ï¼šè°ƒå¤§$b$å®Œå…¨æ˜¯å› ä¸ºâ€œå…ˆçŸ­åé•¿â€çš„è®­ç»ƒç­–ç•¥ï¼Œå¦‚æœä¸€ç›´éƒ½ç”¨é•¿æ–‡æœ¬è®­ç»ƒä¼¼ä¹å°±æ²¡å¿…è¦è°ƒå¤§$b$äº†ï¼Ÿ</p>
<p>ä¸Šå‘¨çš„è®ºæ–‡<a href="https://papers.cool/arxiv/2405.14591">ã€ŠBase of RoPE Bounds Context Lengthã€‹</a>è¯•å›¾å›ç­”è¿™ä¸ªé—®é¢˜ï¼Œå®ƒåŸºäºä¸€ä¸ªæœŸæœ›æ€§è´¨ç ”ç©¶äº†$b$çš„ä¸‹ç•Œï¼Œç”±æ­¤æŒ‡å‡ºæ›´å¤§çš„è®­ç»ƒé•¿åº¦æœ¬èº«å°±åº”è¯¥é€‰æ‹©æ›´å¤§çš„åº•æ•°ï¼Œä¸è®­ç»ƒç­–ç•¥æ— å…³ã€‚æ•´ä¸ªåˆ†ææ€è·¯é¢‡æœ‰å¯å‘æ€§ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ä¸€èµ·æ¥å“é‰´ä¸€ç•ªã€‚</p>
<h2 id="_1">æœŸæœ›æ€§è´¨</h2>
<p>RoPEè¿™é‡Œå°±ä¸å†è¯¦ç»†ä»‹ç»äº†ï¼Œå®ƒæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªåˆ†å—å¯¹è§’çŸ©é˜µ<br />
\begin{equation}\boldsymbol{\mathcal{R}}<em d_2-1="d/2-1">n = \scriptsize{\left(\begin{array}{cc:cc:cc:cc}<br />
\cos n\theta_0 &amp; -\sin n\theta_0 &amp; 0 &amp; 0 &amp; \cdots &amp; \cdots &amp; 0 &amp; 0 \\\<br />
\sin n\theta_0 &amp; \cos n\theta_0 &amp; 0 &amp; 0 &amp; \cdots &amp; \cdots &amp; 0 &amp; 0 \\\<br />
\hdashline<br />
0 &amp; 0 &amp; \cos n\theta_1 &amp; -\sin n\theta_1 &amp; \cdots &amp; \cdots &amp; 0 &amp; 0 \\\<br />
0 &amp; 0 &amp; \sin n\theta_1 &amp; \cos n\theta_1 &amp; \cdots &amp; \cdots &amp; 0 &amp; 0 \\\<br />
\hdashline<br />
\vdots &amp; \vdots &amp; \vdots &amp; \vdots &amp; \ddots &amp; \ddots &amp; \vdots &amp; \vdots \\\<br />
\vdots &amp; \vdots &amp; \vdots &amp; \vdots &amp; \ddots &amp; \ddots &amp; \vdots &amp; \vdots \\\<br />
\hdashline<br />
0 &amp; 0 &amp; 0 &amp; 0 &amp; \cdots &amp; \cdots &amp; \cos n\theta</em> \\\} &amp; -\sin n\theta_{d/2-1<br />
0 &amp; 0 &amp; 0 &amp; 0 &amp; \cdots &amp; \cdots &amp; \sin n\theta_{d/2-1} &amp; \cos n\theta_{d/2-1} \\\<br />
\end{array}\right)}\end{equation}<br />
ç„¶ååˆ©ç”¨æ’ç­‰å¼<br />
\begin{equation}(\boldsymbol{\mathcal{R}}<em n-m="n-m">m \boldsymbol{q})^{\top}(\boldsymbol{\mathcal{R}}_n \boldsymbol{k}) = \boldsymbol{q}^{\top} \boldsymbol{\mathcal{R}}_m^{\top}\boldsymbol{\mathcal{R}}_n \boldsymbol{k} = \boldsymbol{q}^{\top} \boldsymbol{\mathcal{R}}</em>} \boldsymbol{k}\end{equation<br />
ç»™$\boldsymbol{q},\boldsymbol{k}$æ³¨å…¥ç»å¯¹ä½ç½®ä¿¡æ¯ï¼Œå¹¶è‡ªåŠ¨å®ç°äº†ç›¸å¯¹ä½ç½®çš„æ•ˆæœã€‚å…¶ä¸­$\theta_i = b^{-2i/d}$ï¼Œè¿™é‡Œçš„$b$çš„å–å€¼å°±æ˜¯æœ¬æ–‡è¦æ¢è®¨çš„é—®é¢˜ã€‚</p>
<p>é™¤äº†ç»™æ¨¡å‹æ³¨å…¥ä½ç½®ä¿¡æ¯å¤–ï¼Œæˆ‘ä»¬æœŸæœ›RoPEèƒ½å…·å¤‡ä¸¤ä¸ªç†æƒ³æ€§è´¨ï¼Œä»¥è¾¾åˆ°æ›´å¥½çš„æ•ˆæœï¼š1ã€<strong>è¿œç¨‹è¡°å‡</strong> ï¼Œå³ä½ç½®ç›¸è¿‘çš„Tokenå¹³å‡æ¥è¯´è·å¾—æ›´å¤šçš„æ³¨æ„åŠ›ï¼›2ã€<strong>è¯­ä¹‰èšåˆ</strong> ï¼Œå³è¯­ä¹‰ç›¸ä¼¼çš„Tokenå¹³å‡æ¥è¯´è·å¾—æ›´å¤šçš„æ³¨æ„åŠ›ã€‚å…¶ä¸­ç¬¬ä¸€ç‚¹æˆ‘ä»¬æ—©åœ¨<a href="/archives/8265">ã€ŠTransformerå‡çº§ä¹‹è·¯ï¼š2ã€åšé‡‡ä¼—é•¿çš„æ—‹è½¬å¼ä½ç½®ç¼–ç ã€‹</a>æœ‰è¿‡ç›¸å…³è®¨è®ºï¼ŒRoPEç¡®å®æœ‰ä¸€å®šçš„è¿œç¨‹è¡°å‡æ€§è´¨ã€‚</p>
<p>æ‰€ä»¥æ¥ä¸‹æ¥æˆ‘ä»¬æ¥åˆ†æç¬¬äºŒç‚¹ã€‚</p>
<h2 id="_2">ä¸ç­‰å…³ç³»</h2>
<p>æ‰€è°“è¯­ä¹‰èšåˆï¼ŒæŒ‡çš„æ˜¯å½“$\boldsymbol{k}$ä¸$\boldsymbol{q}$ç›¸è¿‘æ—¶ï¼Œä¸ç®¡å®ƒä»¬çš„ç›¸å¯¹è·ç¦»$n-m$å¤šå¤§ï¼Œå…¶æ³¨æ„åŠ›$\boldsymbol{q}^{\top} \boldsymbol{\mathcal{R}}_{n-m} \boldsymbol{k}$å¹³å‡æ¥è¯´éƒ½åº”è¯¥æ›´å¤§ï¼ˆè‡³å°‘è¦æ¯”éšæœºçš„ä¸¤ä¸ªTokenæ›´å¤§ï¼‰ã€‚ä¸ºäº†å¾—åˆ°ä¸€ä¸ªé‡åŒ–çš„ç»“è®ºï¼Œæˆ‘ä»¬è¿›ä¸€æ­¥ç®€åŒ–é—®é¢˜ï¼Œå‡è®¾$\boldsymbol{q}$çš„æ¯ä¸ªåˆ†é‡éƒ½æ˜¯ç‹¬ç«‹åŒåˆ†å¸ƒçš„ï¼Œæ¯ä¸ªåˆ†é‡çš„å‡å€¼ä¸º$\mu$ï¼Œæ–¹å·®ä¸º$\sigma^2$ã€‚</p>
<p>ç°åœ¨æˆ‘ä»¬è€ƒè™‘ä¸¤ç§ä¸åŒçš„$\boldsymbol{k}$ï¼šä¸€ç§æ˜¯åœ¨$\boldsymbol{q}$çš„åŸºç¡€ä¸Šï¼ŒåŠ ä¸Šä¸€ä¸ªé›¶å‡å€¼çš„æ‰°åŠ¨$\boldsymbol{\varepsilon}$ï¼Œæˆ‘ä»¬è®°$\tilde{\boldsymbol{k}} = \boldsymbol{q} + \boldsymbol{\varepsilon}$ï¼Œä»£è¡¨è·Ÿ$\boldsymbol{q}$è¯­ä¹‰ç›¸è¿‘çš„Tokenï¼›å¦ä¸€ç§åˆ™æ˜¯å‡è®¾$\boldsymbol{k}$è·Ÿ$\boldsymbol{q}$ç‹¬ç«‹åŒåˆ†å¸ƒï¼Œè¿™ä»£è¡¨ä¸¤ä¸ªéšæœºçš„Tokenã€‚æ ¹æ®ç¬¬äºŒç‚¹ç†æƒ³æ€§è´¨ï¼Œæˆ‘ä»¬å¸Œæœ›æœ‰<br />
\begin{equation}\mathbb{E}<em n-m="n-m">{\boldsymbol{q},\boldsymbol{k},\boldsymbol{\varepsilon}}\big[\boldsymbol{q}^{\top} \boldsymbol{\mathcal{R}}</em>} \tilde{\boldsymbol{k}} - \boldsymbol{q}^{\top} \boldsymbol{\mathcal{R}<em _boldsymbol_q="\boldsymbol{q">{n-m} \boldsymbol{k}\big] \geq 0\end{equation}<br />
æ³¨æ„æˆ‘ä»¬åˆšæ‰åå¤å¼ºè°ƒäº†â€œå¹³å‡æ¥è¯´â€ï¼Œæ„å‘³ç€æˆ‘ä»¬åªæ˜¯æœŸæœ›ä¸€ä¸ªå¹³å‡çš„è¶‹åŠ¿ï¼Œè€Œä¸æ˜¯æ¯ä¸€ç‚¹éƒ½èƒ½ä¸¥æ ¼æˆç«‹ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨ä¸Šå¼åŠ äº†å–æ•°å­¦æœŸæœ›$\mathbb{E}</em>$ã€‚ç°åœ¨æ ¹æ®å‡è®¾å’ŒRoPEçš„å®šä¹‰ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠä¸Šå¼å…·ä½“åœ°ç®—å‡ºæ¥ï¼š},\boldsymbol{k},\boldsymbol{\varepsilon}<br />
\begin{equation}\begin{aligned}<br />
&amp;\,\mathbb{E}<em n-m="n-m">{\boldsymbol{q},\boldsymbol{k},\boldsymbol{\varepsilon}}\big[\boldsymbol{q}^{\top} \boldsymbol{\mathcal{R}}</em>} (\boldsymbol{q} + \boldsymbol{\varepsilon}) - \boldsymbol{q}^{\top} \boldsymbol{\mathcal{R}<em _boldsymbol_q="\boldsymbol{q">{n-m} \boldsymbol{k}\big] \\\[5pt]<br />
=&amp;\, \mathbb{E}</em>}}\big[\boldsymbol{q}^{\top} \boldsymbol{\mathcal{R}<em _boldsymbol_q="\boldsymbol{q">{n-m} \boldsymbol{q}\big] - \mathbb{E}</em>},\boldsymbol{k}}\big[\boldsymbol{q}^{\top} \boldsymbol{\mathcal{R}<em _boldsymbol_q="\boldsymbol{q">{n-m} \boldsymbol{k}\big] \\\[5pt]<br />
=&amp;\, \mathbb{E}</em>}}\big[\boldsymbol{q}^{\top} \boldsymbol{\mathcal{R}<em _boldsymbol_q="\boldsymbol{q">{n-m} \boldsymbol{q}\big] - \mathbb{E}</em>}}[\boldsymbol{q}]^{\top}\boldsymbol{\mathcal{R}<em _boldsymbol_k="\boldsymbol{k">{n-m} \mathbb{E}</em>] \\\[5pt]}}[\boldsymbol{k<br />
=&amp;\, \mathbb{E}<em n-m="n-m">{\boldsymbol{q}}\big[\boldsymbol{q}^{\top} \boldsymbol{\mathcal{R}}</em>} \boldsymbol{q}\big] - \mu^2\boldsymbol{1}^{\top}\boldsymbol{\mathcal{R}<em _boldsymbol_q="\boldsymbol{q">{n-m} \boldsymbol{1} \\\[5pt]<br />
=&amp; \mathbb{E}</em> 2\mu^2\cos (n-m)\theta_i \\\[5pt]}}\left[\sum_{i=0}^{d/2-1} (q_{2i}^2 + q_{2i+1}^2)\cos (n-m)\theta_i\right] - \sum_{i=0}^{d/2-1<br />
=&amp; \sum_{i=0}^{d/2-1} 2(\mu^2 + \sigma^2)\cos (n-m)\theta_i - \sum_{i=0}^{d/2-1} 2\mu^2\cos (n-m)\theta_i \\\[5pt]<br />
=&amp; \sum_{i=0}^{d/2-1} 2\sigma^2\cos (n-m)\theta_i \\\<br />
\end{aligned}\end{equation}<br />
å¦‚æœè®­ç»ƒé•¿åº¦æœ€å¤§ä¸º$L$ï¼Œé‚£ä¹ˆ$n-m\leq L-1$ï¼Œå› æ­¤ç¬¬äºŒç‚¹ç†æƒ³æ€§è´¨å¯ä»¥ç”¨å¦‚ä¸‹ä¸ç­‰å¼è¿‘ä¼¼æè¿°ï¼š<br />
\begin{equation}\sum_{i=0}^{d/2-1} \cos m\theta_i \geq 0,\quad m\in\{0,1,2,\cdots,L-1\}\label{neq:base}\end{equation}<br />
å…¶ä¸­$L$æ˜¯æœ€å¤§é•¿åº¦ï¼Œæ˜¯è®­ç»ƒå‰å°±è¦é€‰å®šçš„è¶…å‚ï¼Œè€Œ$d$æ˜¯æ¨¡å‹çš„head_sizeï¼ŒæŒ‰ç…§LLAMAçš„ä¸€èˆ¬è®¾ç½®æ˜¯$d=128$ï¼Œè¿™ä¹Ÿå°±æ„å‘³ç€ï¼Œä¸Šå¼çš„å”¯ä¸€å¯è°ƒå‚æ•°å°±æ˜¯$\theta_i = b^{-2i/d}$ä¸­çš„$b$ã€‚åœ¨<a href="/archives/8231">ã€ŠTransformerå‡çº§ä¹‹è·¯ï¼š1ã€Sinusoidalä½ç½®ç¼–ç è¿½æ ¹æº¯æºã€‹</a>ä¸­æˆ‘ä»¬å°±ç®€å•æ¢ç©¶è¿‡è¿™ä¸ªå‡½æ•°ï¼Œå®ƒæ•´ä½“è¶‹åŠ¿æ˜¯è¡°å‡çš„ï¼Œ$b$è¶Šå¤§åˆ™è¡°å‡é€Ÿåº¦è¶Šæ…¢ï¼Œå¯¹åº”çš„è¿ç»­éè´ŸåŒºé—´å°±è¶Šå¤§ï¼Œæ‰€ä»¥å­˜åœ¨ä¸€ä¸ªæœ€å°çš„$b$ä½¿å¾—ä¸Šè¿°ä¸ç­‰å¼æ’æˆç«‹ï¼Œå³<br />
\begin{equation}b^* = \inf\left\{\,\,b\,\,\,\left|\,\,\,f_b(m)\triangleq\sum_{i=0}^{d/2-1} \cos m b^{-2i/d} \geq 0,\,\, m\in\{0,1,2,\cdots,L-1\}\right.\right\}\end{equation}</p>
<h2 id="_3">æ•°å€¼æ±‚è§£</h2>
<p>ç”±äº$f_b(m)$æ¶‰åŠåˆ°å¤šä¸ªä¸‰è§’å‡½æ•°çš„æ±‚å’Œï¼Œå¹¶ä¸”$\theta_i$å…³äº$i$è¿˜æ˜¯éçº¿æ€§çš„ï¼Œå¾ˆéš¾æƒ³è±¡ä¸Šè¿°é—®é¢˜ä¼šæœ‰è§£æè§£ï¼Œå› æ­¤åªèƒ½è¯‰è¯¸æ•°å€¼æ±‚è§£äº†ã€‚ç„¶è€Œï¼Œ$f_b(m)$è¶Šåˆ°åé¢éœ‡è¡è¶Šé¢‘ç¹ä¸”ä¸è§„å¾‹ï¼Œå› æ­¤å³ä¾¿æ•°å€¼æ±‚è§£ä¹Ÿä¸æ˜¯é‚£ä¹ˆç®€å•çš„äº‹æƒ…ã€‚</p>
<p>ç¬”è€…ä¸€å¼€å§‹ä»¥ä¸ºï¼Œå¦‚æœ$b_0$ä½¿å¾—$f_{b_0}(m)\geq 0$æ’æˆç«‹ï¼Œé‚£ä¹ˆ$\forall b \geq b_0$éƒ½æ’æˆç«‹$f_b(m)\geq 0$ï¼Œæ‰€ä»¥ç”¨äºŒåˆ†æ³•å°±å¯ä»¥äº†ã€‚ä½†äº‹å®ä¸Šè¿™ä¸ªå‡è®¾å¹¶ä¸æˆç«‹ï¼Œæ‰€ä»¥äºŒåˆ†æ³•å®£å‘Šç ´äº§ã€‚ç»§ç»­æƒ³äº†ä¸€æ®µæ—¶é—´ï¼Œä¾ç„¶æ²¡ä»€ä¹ˆä¼˜åŒ–æ€è·¯ï¼ŒæœŸé—´å‘åŸè®ºæ–‡ä½œè€…è¯·æ•™è¿‡ï¼Œä»–ä»¬é‡‡ç”¨çš„æ˜¯é€†å‡½æ•°æ³•ï¼Œå³ç»™å®š$b$æ±‚ä½¿å¾—$f_b(m)\geq 0$æ’æˆç«‹çš„æœ€å¤§$L$æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œäºæ˜¯æˆ‘ä»¬å¯ä»¥å¾—åˆ°å¾ˆå¤š$(b, L)$å¯¹ï¼Œç†è®ºä¸Šåªè¦æšä¸¾çš„$b$è¶³å¤Ÿå¤šï¼Œé‚£ä¹ˆå¯¹äºä»»æ„$L$éƒ½å¯ä»¥æ‰¾å‡ºæœ€å°çš„$b$ã€‚ç„¶è€Œè¿™é‡Œæœ‰ä¸ªç²¾åº¦é—®é¢˜ï¼ŒåŸè®ºæ–‡æœ€å¤§çš„$L$è®¡ç®—åˆ°äº†$10^6$ï¼Œ$b$è‡³å°‘è¦æšä¸¾åˆ°$10^8$ï¼Œå¦‚æœæšä¸¾é—´éš”å°ï¼Œé‚£ä¹ˆè®¡ç®—æˆæœ¬éå¸¸å¤§ï¼Œå¦‚æœæšä¸¾é—´éš”å¤§ï¼Œé‚£ä¹ˆå¯èƒ½æ¼æ‰å¾ˆå¤šè§£ã€‚</p>
<p>æœ€åï¼Œç¬”è€…å†³å®šè¿˜æ˜¯ç”¨â€œJax + GPUâ€è¿›è¡Œæš´åŠ›æœç´¢ï¼Œä»¥æ±‚å¾—åˆ°æ›´é«˜ç²¾åº¦çš„ç»“æœï¼Œå¤§è‡´æµç¨‹æ˜¯ï¼š</p>
<blockquote>
<p>1ã€åˆå§‹åŒ–$b=1000L$ï¼ˆåœ¨$10^6$å†…$b=1000L$å¯ä»¥ä½¿å¾—$f_b(m)\geq 0$æ’æˆç«‹ï¼‰ï¼›</p>
<p>2ã€éå†$k=1,2,3,4,5$ï¼Œæ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š</p>
<p>2.1ï¼‰å°†$[0,b]$ç­‰åˆ†ä¸º$10^k$ä»½ï¼Œéå†ç­‰åˆ†ç‚¹ï¼Œåˆ¤æ–­$f_b(m)\geq 0$æ˜¯å¦æ’æˆç«‹ï¼›</p>
<p>2.2ï¼‰å–æœ€å°çš„ä½¿å¾—$f_b(m)\geq 0$æ’æˆç«‹çš„ç­‰åˆ†ç‚¹ï¼Œæ›´æ–°$b$ï¼›</p>
<p>3ã€è¿”å›æœ€ç»ˆçš„$b$ã€‚</p>
</blockquote>
<p>æœ€ç»ˆç»“æœæ™®éè¦æ¯”åŸè®ºæ–‡çš„æ›´ç´§ä¸€äº›<br />
$$\scriptsize\begin{array}{c|cccccccccc}  
\hline  
L & 1k & 2k & 4k & 8k & 16k & 32k & 64k & 128k & 256k & 512k & 1M \\\  
\hline  
b^*(\text{åŸæ–‡}) & 4.3e3 & 1.6e4 & 2.7e4 & 8.4e4 & 3.1e5 & 6.4e5 & 2.1e6 & 7.8e6 & 3.6e7 & 6.4e7 & 5.1e8 \\\  
b^*(\text{æœ¬æ–‡}) & 4.3e3 & \color{red}{1.2e4} & 2.7e4 & 8.4e4 & \color{red}{2.3e5} & \color{red}{6.3e5} & 2.1e6 & \color{red}{4.9e6} & \color{red}{2.4e7} & \color{red}{5.8e7} & \color{red}{6.5e7} \\\  
\hline  
\end{array}$$</p>
<p>å‚è€ƒä»£ç ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">partial</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">jax.numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">jnp</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">jax</span>

<span class="nd">@partial</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,))</span>
<span class="k">def</span><span class="w"> </span><span class="nf">f</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="mi">128</span><span class="p">):</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="kp">arange</span><span class="p">(</span><span class="n">d</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="kp">cos</span><span class="p">(</span><span class="n">m</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">b</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">/</span> <span class="n">d</span><span class="p">))</span><span class="o">.</span><span class="kp">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="nd">@np</span><span class="o">.</span><span class="kp">vectorize</span>
<span class="k">def</span><span class="w"> </span><span class="nf">fmin</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="kp">arange</span><span class="p">(</span><span class="n">L</span><span class="p">),</span> <span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="kp">min</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">bmin</span><span class="p">(</span><span class="n">L</span><span class="p">):</span>
    <span class="n">B</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">L</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">):</span>
        <span class="n">bs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="o">**</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">*</span> <span class="n">B</span>  
        <span class="n">ys</span> <span class="o">=</span> <span class="n">fmin</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">bs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">b</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">bs</span><span class="p">,</span> <span class="n">ys</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">y</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">B</span> <span class="o">=</span> <span class="n">b</span>
                <span class="k">break</span>
    <span class="k">return</span> <span class="n">B</span>

<span class="n">bmin</span><span class="p">(</span><span class="mi">1024</span> <span class="o">*</span> <span class="mi">128</span><span class="p">)</span>
</code></pre></div>

<h2 id="_4">æ¸è¿‘ä¼°è®¡</h2>
<p>é™¤äº†æ•°å€¼æ±‚è§£å¤–ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡æ¸è¿‘åˆ†ææ¥å¾—åˆ°ä¸€ä¸ªè§£æçš„ä¼°è®¡ç»“æœï¼Œè¿™ä¸ªä¼°è®¡æ¯”æ•°å€¼ç»“æœè¦å°ï¼Œæœ¬è´¨ä¸Šæ˜¯$d\to\infty$çš„è§£ï¼Œä½†åŒæ ·èƒ½å¤Ÿå¾—å‡ºâ€œ$b$åº”è¯¥éšç€$L$å¢å¤§è€Œå¢å¤§â€çš„ç»“è®ºã€‚</p>
<p>æ¸è¿‘ä¼°è®¡çš„æ€è·¯ï¼Œæ˜¯ç”¨ç§¯åˆ†ä»£æ›¿æ±‚å’Œï¼š<br />
\begin{equation}f_b(m) = \sum_{i=0}^{d/2-1} \cos m b^{-2i/d}\approx \int_0^1 \cos m b^{-s} ds \xlongequal{\text{ä»¤}t = mb^{-s}} \int_{mb^{-1}}^m \frac{\cos t}{t \ln b}dt\end{equation}<br />
å…¶ä¸­æˆ‘ä»¬è®°<br />
\begin{equation}\text{Ci}(x) = -\int_x^{\infty} \frac{\cos t}{t} dt\end{equation}<br />
è¿™æ˜¯è¢«å‰äººç ”ç©¶è¿‡çš„ä¸‰è§’ç§¯åˆ†ï¼ˆå‚è€ƒ <a href="https://en.wikipedia.org/wiki/Trigonometric_integral">Trigonometric integral</a> ï¼‰ï¼Œåˆ©ç”¨è¿™ä¸ªè®°å·ï¼Œæˆ‘ä»¬å¯ä»¥å†™å‡º<br />
\begin{equation}f_b(m) \approx \frac{\text{Ci}(m) - \text{Ci}(mb^{-1})}{\ln b}\end{equation}<br />
$\text{Ci}(x)$çš„å›¾åƒé•¿è¿™æ ·ï¼š  </p>
<p><a href="/usr/uploads/2024/05/3588196127.png" title="ç‚¹å‡»æŸ¥çœ‹åŸå›¾"><img alt="Ci(x)çš„å›¾åƒã€æ¥è‡ªç»´åŸºç™¾ç§‘ã€‘" src="/usr/uploads/2024/05/3588196127.png" /></a></p>
<p>Ci(x)çš„å›¾åƒã€æ¥è‡ªç»´åŸºç™¾ç§‘ã€‘</p>
<p>å®ƒçš„ç¬¬ä¸€ä¸ªé›¶ç‚¹æ˜¯$x_0=0.6165\cdots$ï¼Œå¯¹äº$m\geq 1$ï¼Œå¯ä»¥çœ‹å‡º$|\text{Ci}(m)|\leq 1/2$ï¼Œæ‰€ä»¥å…¶å®$\text{Ci}(m)$ç›¸å¯¹æ¥è¯´æ˜¯å°é¡¹ï¼Œå¯¹äºæ¸è¿‘ä¼°è®¡æ¥è¯´å¯ä»¥å¿½ç•¥ï¼Œé‚£ä¹ˆé—®é¢˜è¿‘ä¼¼åœ°å˜æˆäº†$\text{Ci}(mb^{-1})\leq 0$å¯¹äº$m=1,2,\cdots,L$æ’æˆç«‹ï¼Œæˆ‘ä»¬åªéœ€è¦è®©ç›¸åº”çš„$mb^{-1}$éƒ½è½åœ¨$[0,x_0]$åŒºé—´å†…å°±å¯ä»¥å®ç°ï¼Œè¿™æ„å‘³ç€$Lb^{-1}\leq x_0$ï¼Œå³<br />
\begin{equation}b \geq L / x_0 \approx 2L\end{equation}<br />
æˆ–è€…ç®€å•ç‚¹$b^* = \mathcal{O}(L)$ã€‚ä¸å‡ºæ„æ–™è¿™ä¸ªç»“æœæ¯”ç²¾ç¡®çš„æ•°å€¼ç»“æœè¦å°ï¼Œå› ä¸ºå®ƒå¯¹åº”äº$d\to\infty$ï¼Œæ— é™ä¸ªä¸‰è§’å‡½æ•°å åŠ ä¼šä½¿å¾—å‡½æ•°å›¾åƒçš„éœ‡è¡æ›´å°‘ï¼Œçœ‹èµ·æ¥æ›´åŠ å¹³ç¨³ï¼ˆç›¸æ¯”äºæœ‰é™çš„$d$ï¼‰ï¼Œä»è€Œå¯¹äºå›ºå®šçš„$b$ï¼Œ$f_b(m)$çš„è¿ç»­éè´ŸåŒºé—´æ›´é•¿ï¼Œæˆ–è€…åè¿‡æ¥ï¼Œå¯¹äºå›ºå®šçš„$L$ï¼Œä¿æŒ$m=0,1,2,\cdots,L-1$çš„$f_b(m)$éƒ½éè´Ÿçš„$b$æ›´å°ã€‚</p>
<h2 id="_5">ç›¸å…³æ€è€ƒ</h2>
<p>åœ¨<a href="/archives/9675">ã€ŠTransformerå‡çº§ä¹‹è·¯ï¼š10ã€RoPEæ˜¯ä¸€ç§Î²è¿›åˆ¶ç¼–ç ã€‹</a>ä¸­ï¼Œæˆ‘ä»¬å°†RoPEç±»æ¯”ä¸ºä¸€ç§$\beta$è¿›åˆ¶è¡¨ç¤ºï¼Œå…¶ä¸­$\beta = b^{2/d}$ï¼Œé‚£ä¹ˆ$b - 1= \beta^{d/2} - 1$æ­£å¥½æ˜¯$d/2$ä½$\beta$è¿›åˆ¶ç¼–ç èƒ½å¤Ÿè¡¨ç¤ºçš„æœ€å¤§æ•°å­—ï¼Œäºæ˜¯è¦è¡¨ç¤º$0,1,2,\cdots,L-1$è¿™$L$ä¸ªä½ç½®ç¼–ç ï¼Œè‡³å°‘æœ‰$b \geq L$ï¼Œè¿™ä¸ªæœ´ç´ çš„ç±»æ¯”å†æ¬¡ç»™å‡ºäº†â€œ$b$åº”è¯¥éšç€$L$å¢å¤§è€Œå¢å¤§â€çš„ç»“è®ºï¼Œå…¶ç»“æœè·Ÿä¸Šä¸€èŠ‚çš„æ¸è¿‘åˆ†æç»“æœæ›´ä¸ºæ¥è¿‘ã€‚</p>
<p>å¦ä¸€æ–¹é¢ï¼ŒMetaæœ€æ–°å‘å¸ƒçš„LLAMA3ï¼Œè®­ç»ƒé•¿åº¦ä¸º8192ï¼Œä½†RoPEçš„åº•æ•°é€‰æ‹©äº†æƒŠäººçš„500000ï¼ˆ5e5ï¼‰ï¼Œè¿™æ¯”å‰é¢çš„æ•°å€¼ç»“æœï¼ˆ8.4e4ï¼‰è¿˜è¦å¤§å°†è¿‘ä¸€ä¸ªæ•°é‡çº§ï¼Œä¸ç®¡ä»å“ªä¸ªè§’åº¦çœ‹ï¼Œè¿™ä¸ªæ•°å€¼ç¬”è€…éƒ½è®¤ä¸ºæ˜¯åå¤§çš„ï¼Œå¯èƒ½LLAMA3çš„è¿™ä¸ªåº•æ•°æœ¬å°±æ˜¯ç»™æ›´å¤§æ–‡æœ¬é•¿åº¦é¢„ç•™çš„ã€‚ä½†ä¸è®ºå¦‚ä½•ï¼Œæ›´å¤§çš„æ–‡æœ¬é•¿åº¦é€‰æ‹©æ›´å¤§çš„RoPEåº•æ•°ï¼Œä¼¼ä¹å·²ç»æˆä¸ºäº†å¾ˆå¤šè®­ç»ƒäººå‘˜çš„å…±è¯†ã€‚</p>
<p>å…¶å®ä¸ç®¡æ˜¯æ•°å€¼ç»“æœè¿˜æ˜¯æ¸è¿‘ä¼°è®¡ï¼Œéƒ½åªæ˜¯ä¸€ä¸ªå‚è€ƒå€¼ï¼Œå®é™…ä¸Šå¯¹äºç»™å®šçš„$L$ï¼Œä¸€ä¸ªç›¸å½“å¤§èŒƒå›´å†…çš„$b$éƒ½åº”è¯¥ä¼šæœ‰ç›¸è¿‘çš„æ•ˆæœã€‚æ‰€ä»¥å…·ä½“çš„æ•°å€¼éƒ½ä¸é‡è¦ï¼Œå…³é”®æ˜¯åŸè®ºæ–‡é€šè¿‡è¯­ä¹‰èšåˆçš„å‡ºå‘ç‚¹å’Œä¸€ç³»åˆ—æ¨å¯¼ï¼Œæ¾„æ¸…äº†â€œ$b$åº”è¯¥éšç€$L$å¢å¤§è€Œå¢å¤§â€çš„ç»“è®ºåŠå…¶åŸç†ï¼Œè¿™æ˜¯ç¬”è€…æ‰€è®¤ä¸ºçš„åŸè®ºæ–‡çš„æ ¸å¿ƒè´¡çŒ®ã€‚</p>
<p>æ­¤å¤–ï¼Œå…¶å®è¯­ä¹‰èšåˆçš„å‡ºå‘ç‚¹å’Œç»“è®ºä¹Ÿå¯ä»¥ç”¨æ¥è§£é‡Š<a href="https://papers.cool/arxiv/2306.15595">Position Interpolation</a>ï¼ˆPIï¼‰ã€‚åˆšæ‰æˆ‘ä»¬è¯´äº†ï¼ŒåŒä¸€ä¸ª$b$ï¼Œ$f_b(m)$çš„è¿ç»­éè´ŸåŒºé—´æ˜¯å›ºå®šçš„ï¼Œå¦‚æœè¦ä½¿$0,1,2,\cdots,L-1$éƒ½è½åœ¨éè´ŸåŒºé—´å†…ï¼Œå°±éœ€è¦éšç€$L$çš„å¢å¤§è€Œç›¸åº”çš„å¢åŠ $b$ã€‚ä½†åè¿‡æ¥ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä¸å¢åŠ $b$ï¼Œè€Œæ˜¯å‡å°‘ç›¸é‚»ä½ç½®çš„é—´éš”ï¼ˆå³ä½ç½®IDæ”¹æˆ$0,1/k,2/k,\cdots$ï¼‰ï¼Œé‚£ä¹ˆå°±å¯ä»¥åœ¨åŒæ ·å¤§å°çš„éè´ŸåŒºé—´å†…è¡¨ç¤º$k$å€çš„ä½ç½®äº†ï¼Œè¿™ä¾¿æ˜¯è¯­ä¹‰èšåˆè§†è§’ä¸‹çš„Position Interpolationã€‚</p>
<h2 id="_6">éƒ¨åˆ†æ—‹è½¬</h2>
<p>RoPEæå‡ºäº2021å¹´ï¼Œå½“æ—¶åªæœ‰ä¸€ç¯‡ä¸­æ–‡åšå®¢ï¼Œåæ¥å¾—åˆ°äº†EleutherAIç»„ç»‡çš„è®¤å¯å’Œå®éªŒï¼Œç»§è€Œæ‰é€æ¸å‘å­¦æœ¯ç•Œæ¨å¹¿ã€‚å½“æ—¶EleutherAIå®éªŒå‘ç°ï¼Œå¦‚æœåªå¯¹éƒ¨åˆ†ç»´åº¦åŠ RoPEï¼Œä¼šå–å¾—ç¨ä¼˜çš„ç»“æœï¼Œç›¸å…³å†…å®¹å¯ä»¥å‚è€ƒ<a href="https://github.com/lucidrains/x-transformers/issues/40">è¿™é‡Œ</a>ã€<a href="https://wandb.ai/eleutherai/neox/reports/Partial-Rotary-Tests--Vmlldzo2MjE1MjY">è¿™é‡Œ</a>å’Œ<a href="https://wandb.ai/eleutherai/neox/reports/Partial-Rotary-Tests-v2--Vmlldzo2MjE4MTQ">è¿™é‡Œ</a>ï¼Œåæ¥è¿™ä¸ªæ“ä½œç”¨åˆ°äº†å®ƒä»¬çš„<a href="https://github.com/EleutherAI/gpt-neox/blob/8b43196fbd832b797be9f3d88d54481171010507/megatron/model/transformer.py#L908">GPT-NeoX</a>ä¸­ã€‚</p>
<p>å½“ç„¶ï¼Œéƒ¨åˆ†æ—‹è½¬è¿˜ä¸æ˜¯å½“å‰LLMçš„ä¸»æµé€‰æ‹©ï¼Œä½†è¿™ä¸å¦¨ç¢æˆ‘ä»¬ç ”ç©¶å®ƒï¼Œä¹Ÿè®¸å®ƒæœªæˆä¸ºä¸»æµé€‰æ‹©åªæ˜¯å› ä¸ºæˆ‘ä»¬å¯¹å®ƒè¿˜ä¸å¤Ÿäº†è§£ã€‚é‚£ä¸ºä»€ä¹ˆéƒ¨åˆ†æ—‹è½¬åè€Œå¯èƒ½ä¼šæ›´ä¼˜å‘¢ï¼Ÿç¬”è€…å‘ç°å¯ä»¥ç”¨æœ¬æ–‡çš„ç»“è®ºæ¥ä¸€å®šç¨‹åº¦ä¸Šè§£é‡Šå®ƒã€‚ä»¥åªæ—‹è½¬ä¸€åŠç»´åº¦ä¸ºä¾‹ï¼Œå®ƒåœ¨æ•°å­¦ä¸Šç­‰ä»·äºé€‰æ‹©å¦‚ä¸‹çš„$\theta_i$ï¼š<br />
\begin{equation}\theta_i = \left\{\begin{aligned}&amp;b^{-4i/d},&amp; i &lt; d/4 \\\<br />
&amp;0,&amp;i \geq d/4\end{aligned}\right.\end{equation}<br />
æ­¤æ—¶æˆ‘ä»¬æœ‰<br />
\begin{equation}\sum_{i=0}^{d/2-1} \cos m\theta_i = \sum_{i=0}^{d/4-1} (1+\cos mb^{-4i/d})\geq 0\end{equation}<br />
ä¹Ÿå°±æ˜¯ä¸è®º$m,b$å¦‚ä½•ï¼Œæˆ‘ä»¬æ‰€æœŸæœ›çš„ä¸ç­‰å¼$\eqref{neq:base}$éƒ½è‡ªåŠ¨æˆç«‹ï¼Œè¿™æ„å‘³ç€ä»æœ¬æ–‡çš„è§‚ç‚¹æ¥çœ‹ï¼Œéƒ¨åˆ†æ—‹è½¬åœ¨èµ‹äºˆä½ç½®ä¿¡æ¯çš„åŒæ—¶æœ‰æ›´å¥½çš„è¯­ä¹‰èšåˆèƒ½åŠ›ï¼Œè¿™å¯¹æ¨¡å‹çš„æ•ˆæœä¹Ÿè®¸æ›´åŠ æœ‰åˆ©ã€‚åŒæ—¶ï¼Œéƒ¨åˆ†æ—‹è½¬å¯¹æ¨¡å‹çš„é•¿æ–‡æœ¬èƒ½åŠ›æˆ–è®¸ä¹Ÿæ›´æœ‰åˆ©ï¼Œå› ä¸ºä¸ç­‰å¼æ’æˆç«‹ï¼Œæ‰€ä»¥æŒ‰ç…§æœ¬æ–‡çš„è§‚ç‚¹ï¼Œä¸è®ºé•¿çŸ­æ–‡æœ¬è®­ç»ƒéƒ½ä¸ç”¨ä¿®æ”¹$b$ã€‚</p>
<p>å€¼å¾—ä¸€æçš„æ˜¯ï¼ŒDeepSeekæå‡ºçš„<a href="/archives/10091">MLA</a>ä¹Ÿåº”ç”¨äº†éƒ¨åˆ†æ—‹è½¬ï¼Œè™½ç„¶åœ¨MLAçš„åŸå§‹æ¨å¯¼ä¸­ï¼Œéƒ¨åˆ†æ—‹è½¬æ›´å¤šæ˜¯ä¸ºäº†æ•´åˆRoPEçš„æ— å¥ˆä¹‹ä¸¾ï¼Œä½†ç»“åˆä»¥å¾€çš„éƒ¨åˆ†æ—‹è½¬å®éªŒç»“æœæ¥çœ‹ï¼Œä¹Ÿè®¸MLAçš„ä¼˜å¼‚æ•ˆæœæœ‰éƒ¨åˆ†æ—‹è½¬çš„ä¸€åˆ†åŠŸåŠ³ã€‚</p>
<h2 id="_7">æ–‡ç« å°ç»“</h2>
<p>æœ¬æ–‡ç®€å•ä»‹ç»äº†è®ºæ–‡<a href="https://papers.cool/arxiv/2405.14591">ã€ŠBase of RoPE Bounds Context Lengthã€‹</a>ï¼Œå®ƒä»è¯­ä¹‰èšåˆçš„æœŸæœ›æ€§è´¨è®¨è®ºäº†RoPEçš„åº•æ•°ä¸‹ç•Œï¼Œç”±æ­¤æŒ‡å‡ºæ›´å¤§çš„è®­ç»ƒé•¿åº¦åº”è¯¥é€‰æ‹©æ›´å¤§çš„åº•æ•°ï¼Œè€Œä¸å•å•æ˜¯ä¸ºäº†é…åˆâ€œå…ˆçŸ­åé•¿â€çš„è®­ç»ƒç­–ç•¥ã€ç»§è€Œåˆ©ç”¨NTK-RoPEæ¥é™ä½åˆå§‹æŸå¤±çš„æŠ˜ä¸­é€‰æ‹©ã€‚</p>
<p><em><strong>è½¬è½½åˆ°è¯·åŒ…æ‹¬æœ¬æ–‡åœ°å€ï¼š</strong><a href="https://spaces.ac.cn/archives/10122">https://spaces.ac.cn/archives/10122</a></em></p>
<p><em><strong>æ›´è¯¦ç»†çš„è½¬è½½äº‹å®œè¯·å‚è€ƒï¼š</strong></em><a href="https://spaces.ac.cn/archives/6508#%E6%96%87%E7%AB%A0%E5%A6%82%E4%BD%95%E8%BD%AC%E8%BD%BD/%E5%BC%95%E7%94%A8" title="ã€Šç§‘å­¦ç©ºé—´FAQã€‹">ã€Šç§‘å­¦ç©ºé—´FAQã€‹</a></p>
<p><strong>å¦‚æœæ‚¨è¿˜æœ‰ä»€ä¹ˆç–‘æƒ‘æˆ–å»ºè®®ï¼Œæ¬¢è¿åœ¨ä¸‹æ–¹è¯„è®ºåŒºç»§ç»­è®¨è®ºã€‚</strong></p>
<p><strong>å¦‚æœæ‚¨è§‰å¾—æœ¬æ–‡è¿˜ä¸é”™ï¼Œæ¬¢è¿åˆ†äº«/æ‰“èµæœ¬æ–‡ã€‚æ‰“èµå¹¶éè¦ä»ä¸­è·å¾—æ”¶ç›Šï¼Œè€Œæ˜¯å¸Œæœ›çŸ¥é“ç§‘å­¦ç©ºé—´è·å¾—äº†å¤šå°‘è¯»è€…çš„çœŸå¿ƒå…³æ³¨ã€‚å½“ç„¶ï¼Œå¦‚æœä½ æ— è§†å®ƒï¼Œä¹Ÿä¸ä¼šå½±å“ä½ çš„é˜…è¯»ã€‚å†æ¬¡è¡¨ç¤ºæ¬¢è¿å’Œæ„Ÿè°¢ï¼</strong></p>
<p>æ‰“èµ</p>
<p><img alt="ç§‘å­¦ç©ºé—´" src="https://spaces.ac.cn/usr/themes/geekg/payment/wx.png" /></p>
<p>å¾®ä¿¡æ‰“èµ</p>
<p><img alt="ç§‘å­¦ç©ºé—´" src="https://spaces.ac.cn/usr/themes/geekg/payment/zfb.png" /></p>
<p>æ”¯ä»˜å®æ‰“èµ</p>
<p>å› ä¸ºç½‘ç«™åå°å¯¹æ‰“èµå¹¶æ— è®°å½•ï¼Œå› æ­¤æ¬¢è¿åœ¨æ‰“èµæ—¶å€™å¤‡æ³¨ç•™è¨€ã€‚ä½ è¿˜å¯ä»¥<a href="http://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&amp;email=tN7d1drY3drrx8H0xcWa19vZ"><strong>ç‚¹å‡»è¿™é‡Œ</strong></a>æˆ–åœ¨ä¸‹æ–¹è¯„è®ºåŒºç•™è¨€æ¥å‘ŠçŸ¥ä½ çš„å»ºè®®æˆ–éœ€æ±‚ã€‚</p>
<p><strong>å¦‚æœæ‚¨éœ€è¦å¼•ç”¨æœ¬æ–‡ï¼Œè¯·å‚è€ƒï¼š</strong></p>
<p>è‹å‰‘æ—. (May. 29, 2024). ã€ŠTransformerå‡çº§ä¹‹è·¯ï¼š18ã€RoPEçš„åº•æ•°é€‰æ‹©åŸåˆ™ ã€‹[Blog post]. Retrieved from <a href="https://spaces.ac.cn/archives/10122">https://spaces.ac.cn/archives/10122</a></p>
<p>@online{kexuefm-10122,<br />
title={Transformerå‡çº§ä¹‹è·¯ï¼š18ã€RoPEçš„åº•æ•°é€‰æ‹©åŸåˆ™},<br />
author={è‹å‰‘æ—},<br />
year={2024},<br />
month={May},<br />
url={\url{https://spaces.ac.cn/archives/10122}},<br />
} </p>
<hr />
<h2 id="_8">å…¬å¼æ¨å¯¼ä¸æ³¨é‡Š</h2>
<h3 id="1-rope">1. RoPEæ—‹è½¬çŸ©é˜µçš„åŸºæœ¬æ€§è´¨</h3>
<p>RoPEçš„æ ¸å¿ƒæ˜¯æ—‹è½¬çŸ©é˜µ$\boldsymbol{\mathcal{R}}_n$ï¼Œæˆ‘ä»¬é¦–å…ˆæ·±å…¥åˆ†æå…¶æ•°å­¦æ€§è´¨ã€‚</p>
<p><strong>æ¨å¯¼1.1ï¼šæ—‹è½¬çŸ©é˜µçš„æ­£äº¤æ€§</strong></p>
<p>å¯¹äºå•ä¸ªäºŒç»´æ—‹è½¬å—ï¼š
$$
\boldsymbol{R}_i(n) = \begin{pmatrix} \cos n\theta_i & -\sin n\theta_i \\ \sin n\theta_i & \cos n\theta_i \end{pmatrix}
$$</p>
<p>éªŒè¯æ­£äº¤æ€§ï¼Œè®¡ç®—ï¼š
$$
\boldsymbol{R}_i(n)^{\top}\boldsymbol{R}_i(n) = \begin{pmatrix} \cos n\theta_i & \sin n\theta_i \\ -\sin n\theta_i & \cos n\theta_i \end{pmatrix} \begin{pmatrix} \cos n\theta_i & -\sin n\theta_i \\ \sin n\theta_i & \cos n\theta_i \end{pmatrix}
$$</p>
<p>å±•å¼€ç¬¬ä¸€é¡¹ï¼š
$$
(\cos n\theta_i)^2 + (\sin n\theta_i)^2 = 1
$$</p>
<p>å±•å¼€éå¯¹è§’é¡¹ï¼š
$$
-\cos n\theta_i \sin n\theta_i + \sin n\theta_i \cos n\theta_i = 0
$$</p>
<p>å› æ­¤$\boldsymbol{R}_i(n)^{\top}\boldsymbol{R}_i(n) = \boldsymbol{I}$ï¼Œè¯æ˜äº†æ—‹è½¬çŸ©é˜µæ˜¯æ­£äº¤çŸ©é˜µã€‚</p>
<p><strong>æ¨å¯¼1.2ï¼šæ—‹è½¬çŸ©é˜µçš„å¯åŠ æ€§</strong></p>
<p>è¿™æ˜¯RoPEå®ç°ç›¸å¯¹ä½ç½®ç¼–ç çš„å…³é”®æ€§è´¨ã€‚å¯¹äºä¸¤ä¸ªæ—‹è½¬çŸ©é˜µï¼š
$$
\boldsymbol{R}_i(m)\boldsymbol{R}_i(n) = \begin{pmatrix} \cos m\theta_i & -\sin m\theta_i \\ \sin m\theta_i & \cos m\theta_i \end{pmatrix} \begin{pmatrix} \cos n\theta_i & -\sin n\theta_i \\ \sin n\theta_i & \cos n\theta_i \end{pmatrix}
$$</p>
<p>åˆ©ç”¨ä¸‰è§’å‡½æ•°å’Œå·®å…¬å¼ï¼š
$$
\cos(m\theta_i)\cos(n\theta_i) - \sin(m\theta_i)\sin(n\theta_i) = \cos((m+n)\theta_i)
$$
$$
\sin(m\theta_i)\cos(n\theta_i) + \cos(m\theta_i)\sin(n\theta_i) = \sin((m+n)\theta_i)
$$</p>
<p>å› æ­¤ï¼š
$$
\boldsymbol{R}_i(m)\boldsymbol{R}_i(n) = \boldsymbol{R}_i(m+n)
$$</p>
<p>è¿™ä¸ªæ€§è´¨ä¿è¯äº†ï¼š
$$
\boldsymbol{\mathcal{R}}_m^{\top}\boldsymbol{\mathcal{R}}_n = \boldsymbol{\mathcal{R}}_{n-m}
$$</p>
<p>ä½¿å¾—æ³¨æ„åŠ›è®¡ç®—åªä¾èµ–äºç›¸å¯¹ä½ç½®$n-m$ã€‚</p>
<h3 id="2">2. åº•æ•°Î¸çš„é¢‘ç‡åˆ†è§£åˆ†æ</h3>
<p><strong>æ¨å¯¼2.1ï¼šé¢‘ç‡å…¬å¼çš„æŒ‡æ•°å½¢å¼</strong></p>
<p>åº•æ•°ä¸º$b$æ—¶ï¼Œç¬¬$i$ä¸ªé¢‘ç‡ä¸ºï¼š
$$
\theta_i = b^{-2i/d}, \quad i = 0, 1, \ldots, d/2-1
$$</p>
<p>å–å¯¹æ•°å¾—åˆ°ï¼š
$$
\log \theta_i = -\frac{2i}{d}\log b
$$</p>
<p>è¿™è¡¨æ˜é¢‘ç‡åœ¨å¯¹æ•°å°ºåº¦ä¸Šå‘ˆçº¿æ€§åˆ†å¸ƒï¼Œè·¨åº¦ä¸ºï¼š
$$
\log\theta_0 - \log\theta_{d/2-1} = 0 - (-\frac{2(d/2-1)}{d}\log b) \approx \log b
$$</p>
<p><strong>æ¨å¯¼2.2ï¼šé¢‘ç‡èŒƒå›´çš„è¾¹ç•Œåˆ†æ</strong></p>
<p>æœ€é«˜é¢‘ç‡ï¼ˆæœ€å¿«æŒ¯è¡ï¼‰ï¼š
$$
\theta_0 = b^0 = 1
$$</p>
<p>æœ€ä½é¢‘ç‡ï¼ˆæœ€æ…¢æŒ¯è¡ï¼‰ï¼š
$$
\theta_{d/2-1} = b^{-2(d/2-1)/d} = b^{-(d-2)/d} \approx b^{-1}
$$</p>
<p>å¯¹äºä½ç½®$n$ï¼Œæœ€å¿«åˆ†é‡çš„ç›¸ä½ä¸º$n\theta_0 = n$ï¼Œæœ€æ…¢åˆ†é‡çš„ç›¸ä½ä¸º$n\theta_{d/2-1} \approx n/b$ã€‚</p>
<p><strong>æ¨å¯¼2.3ï¼šæ³¢é•¿çš„åˆ†å¸ƒ</strong></p>
<p>ç¬¬$i$ä¸ªåˆ†é‡çš„æ³¢é•¿å®šä¹‰ä¸ºç›¸ä½å˜åŒ–$2\pi$å¯¹åº”çš„ä½ç½®å˜åŒ–ï¼š
$$
\lambda_i = \frac{2\pi}{\theta_i} = 2\pi b^{2i/d}
$$</p>
<p>æ³¢é•¿èŒƒå›´ï¼š
$$
\lambda_0 = 2\pi, \quad \lambda_{d/2-1} \approx 2\pi b
$$</p>
<p>è¿™æ„å‘³ç€RoPEèƒ½å¤Ÿç¼–ç çš„æœ€å¤§å‘¨æœŸçº¦ä¸º$2\pi b$ã€‚</p>
<h3 id="3">3. è¯­ä¹‰èšåˆæ€§è´¨çš„è¯¦ç»†æ¨å¯¼</h3>
<p><strong>æ¨å¯¼3.1ï¼šæœŸæœ›å€¼çš„å±•å¼€</strong></p>
<p>è€ƒè™‘ä¸¤ä¸ªå‘é‡çš„å†…ç§¯ï¼š
$$
\boldsymbol{q}^{\top}\boldsymbol{\mathcal{R}}_{n-m}\boldsymbol{k}
$$</p>
<p>å¯¹äºåˆ†å—å¯¹è§’çŸ©é˜µ$\boldsymbol{\mathcal{R}}_{n-m}$ï¼Œå†…ç§¯å¯ä»¥åˆ†è§£ä¸ºï¼š
$$
\boldsymbol{q}^{\top}\boldsymbol{\mathcal{R}}_{n-m}\boldsymbol{k} = \sum_{i=0}^{d/2-1} \begin{pmatrix} q_{2i} \\ q_{2i+1} \end{pmatrix}^{\top} \begin{pmatrix} \cos(n-m)\theta_i & -\sin(n-m)\theta_i \\ \sin(n-m)\theta_i & \cos(n-m)\theta_i \end{pmatrix} \begin{pmatrix} k_{2i} \\ k_{2i+1} \end{pmatrix}
$$</p>
<p>å±•å¼€å•ä¸ªå—ï¼š
$$
\begin{aligned}
&= \sum_{i=0}^{d/2-1} [q_{2i}(k_{2i}\cos(n-m)\theta_i - k_{2i+1}\sin(n-m)\theta_i) \\
&\quad + q_{2i+1}(k_{2i}\sin(n-m)\theta_i + k_{2i+1}\cos(n-m)\theta_i)]
\end{aligned}
$$</p>
<p>æ•´ç†å¾—ï¼š
$$
= \sum_{i=0}^{d/2-1} [(q_{2i}k_{2i} + q_{2i+1}k_{2i+1})\cos(n-m)\theta_i + (q_{2i+1}k_{2i} - q_{2i}k_{2i+1})\sin(n-m)\theta_i]
$$</p>
<p><strong>æ¨å¯¼3.2ï¼šç‹¬ç«‹åŒåˆ†å¸ƒå‡è®¾ä¸‹çš„æœŸæœ›</strong></p>
<p>è®¾$\boldsymbol{q}$çš„æ¯ä¸ªåˆ†é‡ç‹¬ç«‹åŒåˆ†å¸ƒï¼Œå‡å€¼$\mu$ï¼Œæ–¹å·®$\sigma^2$ã€‚è€ƒå¯Ÿï¼š
$$
\mathbb{E}_{\boldsymbol{q}}[\boldsymbol{q}^{\top}\boldsymbol{\mathcal{R}}_{n-m}\boldsymbol{q}]
$$</p>
<p>å¯¹äºå•ä¸ªå—çš„è´¡çŒ®ï¼š
$$
\mathbb{E}[(q_{2i}^2 + q_{2i+1}^2)\cos(n-m)\theta_i]
$$</p>
<p>ç”±äº$\mathbb{E}[q_{2i}^2] = \mu^2 + \sigma^2$ï¼š
$$
= 2(\mu^2 + \sigma^2)\cos(n-m)\theta_i
$$</p>
<p>äº¤å‰é¡¹çš„æœŸæœ›ï¼š
$$
\mathbb{E}[(q_{2i+1}q_{2i} - q_{2i}q_{2i+1})\sin(n-m)\theta_i] = 0
$$</p>
<p>å› ä¸º$q_{2i}$å’Œ$q_{2i+1}$ç‹¬ç«‹ï¼Œæ‰€ä»¥ï¼š
$$
\mathbb{E}[q_{2i+1}q_{2i}] = \mathbb{E}[q_{2i+1}]\mathbb{E}[q_{2i}] = \mu^2
$$</p>
<p><strong>æ¨å¯¼3.3ï¼šè¯­ä¹‰ç›¸ä¼¼å‘é‡çš„æœŸæœ›å·®</strong></p>
<p>å¯¹äºè¯­ä¹‰ç›¸ä¼¼çš„$\tilde{\boldsymbol{k}} = \boldsymbol{q} + \boldsymbol{\varepsilon}$ï¼ˆ$\boldsymbol{\varepsilon}$é›¶å‡å€¼ï¼‰ï¼š
$$
\begin{aligned}
&\mathbb{E}[\boldsymbol{q}^{\top}\boldsymbol{\mathcal{R}}_{n-m}\tilde{\boldsymbol{k}}] \\
&= \mathbb{E}[\boldsymbol{q}^{\top}\boldsymbol{\mathcal{R}}_{n-m}(\boldsymbol{q} + \boldsymbol{\varepsilon})] \\
&= \mathbb{E}[\boldsymbol{q}^{\top}\boldsymbol{\mathcal{R}}_{n-m}\boldsymbol{q}] + \mathbb{E}[\boldsymbol{q}^{\top}\boldsymbol{\mathcal{R}}_{n-m}\boldsymbol{\varepsilon}]
\end{aligned}
$$</p>
<p>ç”±äº$\boldsymbol{\varepsilon}$é›¶å‡å€¼ä¸”ä¸$\boldsymbol{q}$ç‹¬ç«‹ï¼š
$$
\mathbb{E}[\boldsymbol{q}^{\top}\boldsymbol{\mathcal{R}}_{n-m}\boldsymbol{\varepsilon}] = \mathbb{E}[\boldsymbol{q}]^{\top}\boldsymbol{\mathcal{R}}_{n-m}\mathbb{E}[\boldsymbol{\varepsilon}] = 0
$$</p>
<p>å¯¹äºç‹¬ç«‹åŒåˆ†å¸ƒçš„$\boldsymbol{k}$ï¼š
$$
\mathbb{E}[\boldsymbol{q}^{\top}\boldsymbol{\mathcal{R}}_{n-m}\boldsymbol{k}] = \mathbb{E}[\boldsymbol{q}]^{\top}\boldsymbol{\mathcal{R}}_{n-m}\mathbb{E}[\boldsymbol{k}] = \mu^2 \boldsymbol{1}^{\top}\boldsymbol{\mathcal{R}}_{n-m}\boldsymbol{1}
$$</p>
<p>è®¡ç®—$\boldsymbol{1}^{\top}\boldsymbol{\mathcal{R}}_{n-m}\boldsymbol{1}$ï¼š
$$
\boldsymbol{1}^{\top}\boldsymbol{\mathcal{R}}_{n-m}\boldsymbol{1} = \sum_{i=0}^{d/2-1} \begin{pmatrix} 1 \\ 1 \end{pmatrix}^{\top} \begin{pmatrix} \cos(n-m)\theta_i & -\sin(n-m)\theta_i \\ \sin(n-m)\theta_i & \cos(n-m)\theta_i \end{pmatrix} \begin{pmatrix} 1 \\ 1 \end{pmatrix}
$$</p>
<p>$$
= \sum_{i=0}^{d/2-1} (\cos(n-m)\theta_i - \sin(n-m)\theta_i + \sin(n-m)\theta_i + \cos(n-m)\theta_i)
$$</p>
<p>$$
= \sum_{i=0}^{d/2-1} 2\cos(n-m)\theta_i
$$</p>
<h3 id="4">4. ä¸ç­‰å¼æ¡ä»¶çš„æ·±å…¥åˆ†æ</h3>
<p><strong>æ¨å¯¼4.1ï¼šè¯­ä¹‰èšåˆä¸ç­‰å¼çš„å¯¼å‡º</strong></p>
<p>ç»¼åˆå‰é¢çš„æ¨å¯¼ï¼ŒæœŸæœ›å·®ä¸ºï¼š
$$
\begin{aligned}
&\mathbb{E}[\boldsymbol{q}^{\top}\boldsymbol{\mathcal{R}}_{n-m}\tilde{\boldsymbol{k}}] - \mathbb{E}[\boldsymbol{q}^{\top}\boldsymbol{\mathcal{R}}_{n-m}\boldsymbol{k}] \\
&= \sum_{i=0}^{d/2-1} 2(\mu^2 + \sigma^2)\cos(n-m)\theta_i - \sum_{i=0}^{d/2-1} 2\mu^2\cos(n-m)\theta_i \\
&= 2\sigma^2 \sum_{i=0}^{d/2-1} \cos(n-m)\theta_i
\end{aligned}
$$</p>
<p>è¦æ±‚è¿™ä¸ªæœŸæœ›å·®éè´Ÿï¼Œå³ï¼š
$$
\sum_{i=0}^{d/2-1} \cos(n-m)\theta_i \geq 0
$$</p>
<p>è®°$m = n - m$çš„ç›¸å¯¹è·ç¦»ï¼Œå¯¹æ‰€æœ‰$m \in {0, 1, 2, \ldots, L-1}$éœ€è¦æ»¡è¶³ï¼š
$$
f_b(m) = \sum_{i=0}^{d/2-1} \cos(m\theta_i) \geq 0
$$</p>
<p><strong>æ¨å¯¼4.2ï¼šå‡½æ•°$f_b(m)$çš„åˆå€¼åˆ†æ</strong></p>
<p>å½“$m = 0$æ—¶ï¼š
$$
f_b(0) = \sum_{i=0}^{d/2-1} \cos(0) = \sum_{i=0}^{d/2-1} 1 = \frac{d}{2}
$$</p>
<p>è¿™æ˜¯æœ€å¤§å€¼ï¼Œç¬¦åˆç›´è§‰ï¼šä½ç½®é‡åˆæ—¶æ³¨æ„åŠ›æœ€å¼ºã€‚</p>
<p><strong>æ¨å¯¼4.3ï¼šå‡½æ•°$f_b(m)$çš„æ¸è¿‘è¡Œä¸º</strong></p>
<p>å½“$m$å¢å¤§æ—¶ï¼Œä¸åŒé¢‘ç‡$\theta_i$çš„ä½™å¼¦é¡¹ä¼šäº§ç”Ÿç›¸ä½å·®ï¼Œå¯¼è‡´æ±‚å’Œå‡ºç°æŠµæ¶ˆã€‚å…³é”®è§‚å¯Ÿï¼š</p>
<ul>
<li>é«˜é¢‘é¡¹ï¼ˆå°$i$ï¼‰ï¼š$\cos(m\theta_i)$æŒ¯è¡å¿«ï¼Œè´¡çŒ®è¿…é€Ÿå˜åŒ–</li>
<li>ä½é¢‘é¡¹ï¼ˆå¤§$i$ï¼‰ï¼š$\cos(m\theta_i)$æŒ¯è¡æ…¢ï¼Œè´¡çŒ®å˜åŒ–ç¼“æ…¢</li>
</ul>
<p><strong>æ¨å¯¼4.4ï¼šä¸´ç•Œç‚¹çš„ä¼°è®¡</strong></p>
<p>å‡½æ•°$f_b(m)$ä»æ­£å˜ä¸ºè´Ÿçš„ä¸´ç•Œç‚¹$m^*$æ»¡è¶³ï¼š
$$
\sum_{i=0}^{d/2-1} \cos(m^*\theta_i) = 0
$$</p>
<p>è¿™éœ€è¦é«˜é¢‘å’Œä½é¢‘é¡¹çš„æ­£è´Ÿè´¡çŒ®å¹³è¡¡ã€‚</p>
<h3 id="5-bl">5. åº•æ•°$b$ä¸æœ€å¤§é•¿åº¦$L$çš„å…³ç³»</h3>
<p><strong>æ¨å¯¼5.1ï¼šç§¯åˆ†è¿‘ä¼¼æ–¹æ³•</strong></p>
<p>å½“$d$å¾ˆå¤§æ—¶ï¼Œå¯ä»¥ç”¨ç§¯åˆ†è¿‘ä¼¼æ±‚å’Œï¼š
$$
f_b(m) = \sum_{i=0}^{d/2-1} \cos(mb^{-2i/d}) \approx \frac{d}{2}\int_0^1 \cos(mb^{-2s}) ds
$$</p>
<p>ä»¤$t = mb^{-2s}$ï¼Œåˆ™$dt = -2mb^{-2s}\ln b \cdot ds$ï¼Œå³ï¼š
$$
ds = -\frac{dt}{2t\ln b}
$$</p>
<p>å½“$s = 0$æ—¶ï¼Œ$t = m$ï¼›å½“$s = 1$æ—¶ï¼Œ$t = mb^{-2}$ã€‚å› æ­¤ï¼š
$$
\frac{d}{2}\int_0^1 \cos(mb^{-2s}) ds = \frac{d}{2} \int_{mb^{-2}}^m \cos(t) \cdot \left(-\frac{1}{2t\ln b}\right) dt
$$</p>
<p>$$
= -\frac{d}{4\ln b} \int_{mb^{-2}}^m \frac{\cos t}{t} dt = \frac{d}{4\ln b} \int_m^{mb^{-2}} \frac{\cos t}{t} dt
$$</p>
<p>ç”±äº$b \gg 1$æ—¶$b^{-2} \approx 0$ï¼Œè¿‘ä¼¼ä¸ºï¼š
$$
\approx \frac{d}{4\ln b} \int_m^{m/b^2} \frac{\cos t}{t} dt
$$</p>
<p><strong>æ¨å¯¼5.2ï¼šä½™å¼¦ç§¯åˆ†å‡½æ•°çš„åº”ç”¨</strong></p>
<p>å®šä¹‰ä½™å¼¦ç§¯åˆ†ï¼š
$$
\text{Ci}(x) = -\int_x^{\infty} \frac{\cos t}{t} dt
$$</p>
<p>åˆ™ï¼š
$$
\int_m^{m/b^2} \frac{\cos t}{t} dt = -[\text{Ci}(m/b^2) - \text{Ci}(m)]
$$</p>
<p>å› æ­¤ï¼š
$$
f_b(m) \approx \frac{d}{4\ln b}[\text{Ci}(m/b^2) - \text{Ci}(m)]
$$</p>
<p>ç®€åŒ–ç¬¦å·ï¼Œå¯¹å•ä½ç»´åº¦ï¼ˆ$d=2$ï¼‰ï¼š
$$
f_b(m) \approx \frac{\text{Ci}(m/b^2) - \text{Ci}(m)}{\ln b}
$$</p>
<p><strong>æ¨å¯¼5.3ï¼šé›¶ç‚¹æ¡ä»¶</strong></p>
<p>$f_b(m) = 0$çš„æ¡ä»¶è¿‘ä¼¼ä¸ºï¼š
$$
\text{Ci}(m/b^2) = \text{Ci}(m)
$$</p>
<p>æ ¹æ®$\text{Ci}(x)$çš„æ€§è´¨ï¼Œç¬¬ä¸€ä¸ªé›¶ç‚¹åœ¨$x_0 \approx 0.6165$ã€‚å¯¹äº$m \geq 1$ï¼Œ$|\text{Ci}(m)| \leq 0.5$ç›¸å¯¹è¾ƒå°ï¼Œä¸»è¦ç”±$\text{Ci}(m/b^2)$ä¸»å¯¼ã€‚</p>
<p>è¦æ±‚$f_b(m) \geq 0$å¯¹æ‰€æœ‰$m \leq L-1$æˆç«‹ï¼Œéœ€è¦ï¼š
$$
\text{Ci}(m/b^2) \geq \text{Ci}(m)
$$</p>
<p>ç”±äº$\text{Ci}(x)$é€’å‡ï¼Œéœ€è¦$m/b^2 \leq m$ï¼Œè¿™æ€»æ˜¯æˆç«‹çš„ã€‚æ›´å¼ºçš„æ¡ä»¶æ˜¯$m/b^2$åº”è¯¥åœ¨ç¬¬ä¸€ä¸ªé›¶ç‚¹ä¹‹å‰ï¼š
$$
\frac{L-1}{b^2} \leq x_0 \approx 0.6165
$$</p>
<p>è§£å¾—ï¼š
$$
b \geq \sqrt{\frac{L-1}{0.6165}} \approx 1.27\sqrt{L}
$$</p>
<p><strong>æ¨å¯¼5.4ï¼šæ›´ç²¾ç¡®çš„çº¿æ€§ä¼°è®¡</strong></p>
<p>è€ƒè™‘åˆ°$b$é€šå¸¸å¾ˆå¤§ï¼ˆ$b \gg 1$ï¼‰ï¼Œè€Œ$mb^{-2} \ll 1$ï¼Œå¯ä»¥ä½¿ç”¨$\text{Ci}(x)$åœ¨å°$x$é™„è¿‘çš„å±•å¼€ï¼š
$$
\text{Ci}(x) \approx \gamma + \ln x, \quad x \to 0^+
$$</p>
<p>å…¶ä¸­$\gamma \approx 0.5772$æ˜¯æ¬§æ‹‰å¸¸æ•°ã€‚ä½†æ›´ç›´æ¥çš„æ–¹æ³•æ˜¯æ³¨æ„åˆ°ï¼Œå¦‚æœæˆ‘ä»¬å¸Œæœ›$m\theta_{d/2-1} = mb^{-1}$ä¸è¶…è¿‡æŸä¸ªä¸´ç•Œè§’åº¦ï¼Œæ¯”å¦‚$\pi/2$ï¼š
$$
\frac{L}{b} \leq \frac{\pi}{2}
$$</p>
<p>è¿™ç»™å‡ºï¼š
$$
b \geq \frac{2L}{\pi} \approx 0.64L
$$</p>
<p>ç»“åˆæ›´ç»†è‡´çš„åˆ†æï¼Œå¾—åˆ°$b = \mathcal{O}(L)$çš„ç»“è®ºã€‚</p>
<h3 id="6">6. Î²è¿›åˆ¶ç¼–ç çš„è§†è§’</h3>
<p><strong>æ¨å¯¼6.1ï¼šRoPEä½œä¸ºè¿›åˆ¶è¡¨ç¤º</strong></p>
<p>å®šä¹‰$\beta = b^{2/d}$ï¼Œåˆ™ï¼š
$$
\theta_i = b^{-2i/d} = \beta^{-i}
$$</p>
<p>ä½ç½®$n$çš„ç¼–ç å¯ä»¥çœ‹ä½œï¼š
$$
n = \sum_{i=0}^{d/2-1} a_i \beta^i
$$</p>
<p>å…¶ä¸­$a_i \in [0, \beta)$æ˜¯"æ•°å­—"ã€‚</p>
<p><strong>æ¨å¯¼6.2ï¼šè¡¨ç¤ºèƒ½åŠ›çš„åˆ†æ</strong></p>
<p>$d/2$ä½$\beta$è¿›åˆ¶æ•°èƒ½è¡¨ç¤ºçš„æœ€å¤§å€¼ä¸ºï¼š
$$
N_{\max} = \sum_{i=0}^{d/2-1} (\beta - 1)\beta^i = (\beta - 1) \cdot \frac{\beta^{d/2} - 1}{\beta - 1} = \beta^{d/2} - 1
$$</p>
<p>ç”±äº$\beta = b^{2/d}$ï¼š
$$
N_{\max} = (b^{2/d})^{d/2} - 1 = b - 1
$$</p>
<p>å› æ­¤ï¼Œè¦è¡¨ç¤º$0, 1, \ldots, L-1$å…±$L$ä¸ªä½ç½®ï¼Œéœ€è¦ï¼š
$$
b - 1 \geq L - 1 \implies b \geq L
$$</p>
<p>è¿™å†æ¬¡è¯æ˜äº†$b$åº”è¯¥è‡³å°‘ä¸$L$åŒé˜¶ã€‚</p>
<p><strong>æ¨å¯¼6.3ï¼šè¿›åˆ¶è¡¨ç¤ºçš„å”¯ä¸€æ€§</strong></p>
<p>å¯¹äºç»™å®šçš„$b$å’Œ$d$ï¼Œæ¯ä¸ªä½ç½®$n &lt; b$éƒ½æœ‰å”¯ä¸€çš„$\beta$è¿›åˆ¶è¡¨ç¤ºã€‚è¿™ç¡®ä¿äº†ä¸åŒä½ç½®çš„ç¼–ç èƒ½å¤Ÿè¢«æ¨¡å‹åŒºåˆ†ã€‚</p>
<h3 id="7-ntk">7. NTKæ’å€¼ä¸­çš„åº•æ•°è°ƒæ•´</h3>
<p><strong>æ¨å¯¼7.1ï¼šNTK-RoPEçš„åŸºæœ¬æ€æƒ³</strong></p>
<p>Neural Tangent Kernelï¼ˆNTKï¼‰å¯å‘çš„RoPEè°ƒæ•´é€šè¿‡ç¼©æ”¾åº•æ•°æ¥å®ç°é•¿åº¦å¤–æ¨ã€‚åŸå§‹è®­ç»ƒé•¿åº¦$L_0$ï¼Œç›®æ ‡é•¿åº¦$L$ï¼Œç¼©æ”¾å› å­ï¼š
$$
\alpha = \frac{L}{L_0}
$$</p>
<p>NTK-RoPEå°†åº•æ•°è°ƒæ•´ä¸ºï¼š
$$
b' = b \cdot \alpha^{d/(d-2)}
$$</p>
<p><strong>æ¨å¯¼7.2ï¼šé¢‘ç‡çš„éå‡åŒ€ç¼©æ”¾</strong></p>
<p>åŸå§‹é¢‘ç‡ï¼š
$$
\theta_i = b^{-2i/d}
$$</p>
<p>NTKè°ƒæ•´åï¼š
$$
\theta_i' = (b')^{-2i/d} = (b\alpha^{d/(d-2)})^{-2i/d} = b^{-2i/d} \cdot \alpha^{-2i/(d-2)}
$$</p>
<p>è¿™ç›¸å½“äºå¯¹ä¸åŒé¢‘ç‡åˆ†é‡è¿›è¡Œéå‡åŒ€ç¼©æ”¾ï¼š</p>
<ul>
<li>ä½é¢‘ï¼ˆå¤§æ³¢é•¿ï¼Œå°$i$ï¼‰ï¼šç¼©æ”¾å› å­æ¥è¿‘1</li>
<li>é«˜é¢‘ï¼ˆå°æ³¢é•¿ï¼Œå¤§$i$ï¼‰ï¼šç¼©æ”¾å› å­æ›´å¤§</li>
</ul>
<p><strong>æ¨å¯¼7.3ï¼šå†…æ’ä¸å¤–æ¨çš„ç»Ÿä¸€</strong></p>
<p>Position Interpolationï¼ˆPIï¼‰ç›´æ¥ç¼©æ”¾ä½ç½®ï¼š
$$
n' = \frac{n}{\alpha}
$$</p>
<p>ç­‰ä»·äºæ‰€æœ‰é¢‘ç‡å‡åŒ€ç¼©æ”¾ï¼š
$$
\theta_i' = \frac{\theta_i}{\alpha}
$$</p>
<p>NTK-RoPEçš„éå‡åŒ€ç¼©æ”¾åœ¨ä¸¤ç§æç«¯ä¹‹é—´æ‰¾åˆ°å¹³è¡¡ï¼š</p>
<ul>
<li>å¯¹äº$i = 0$ï¼ˆæœ€ä½é¢‘ï¼‰ï¼š$\theta_0' = 1$ï¼ˆä¸ç¼©æ”¾ï¼‰</li>
<li>å¯¹äº$i = d/2-1$ï¼ˆæœ€é«˜é¢‘ï¼‰ï¼š$\theta_{d/2-1}' \approx \theta_{d/2-1}/\alpha$ï¼ˆå®Œå…¨ç¼©æ”¾ï¼‰</li>
</ul>
<p><strong>æ¨å¯¼7.4ï¼šä¿æŒè¯­ä¹‰èšåˆæ€§è´¨</strong></p>
<p>åœ¨æ–°çš„åº•æ•°$b'$ä¸‹ï¼Œæ£€éªŒä¸ç­‰å¼ï¼š
$$
f_{b'}(m) = \sum_{i=0}^{d/2-1} \cos(m(b')^{-2i/d}) \geq 0, \quad m \leq L-1
$$</p>
<p>ç”±äº$b' &gt; b$ï¼Œç›¸å½“äºæ‹‰ä¼¸äº†é¢‘ç‡èŒƒå›´ï¼Œä½¿å¾—åŸæœ¬å¯¹åº”$L_0$çš„éè´ŸåŒºé—´èƒ½å¤Ÿè¦†ç›–æ‰©å±•åçš„$L$ã€‚</p>
<h3 id="8">8. éƒ¨åˆ†æ—‹è½¬çš„æ•°å­¦ä¼˜åŠ¿</h3>
<p><strong>æ¨å¯¼8.1ï¼šéƒ¨åˆ†æ—‹è½¬çš„é¢‘ç‡é…ç½®</strong></p>
<p>å‡è®¾åªå¯¹å‰$d/4$ç»´åº¦å¯¹åº”çš„é¢‘ç‡æ—‹è½¬ï¼Œåˆ™ï¼š
$$
\theta_i = \begin{cases}
b^{-4i/d}, & i < d/4 \\
0, & i \geq d/4
\end{cases}
$$</p>
<p>æ³¨æ„è¿™é‡Œ$i &lt; d/4$æ—¶ä½¿ç”¨$-4i/d$è€Œé$-2i/d$ï¼Œæ˜¯ä¸ºäº†ä¿æŒé¢‘ç‡è·¨åº¦ã€‚</p>
<p><strong>æ¨å¯¼8.2ï¼šè¯­ä¹‰èšåˆæ¡ä»¶çš„è‡ªåŠ¨æ»¡è¶³</strong></p>
<p>è®¡ç®—æ±‚å’Œå‡½æ•°ï¼š
$$
f_b(m) = \sum_{i=0}^{d/2-1} \cos(m\theta_i) = \sum_{i=0}^{d/4-1} \cos(mb^{-4i/d}) + \sum_{i=d/4}^{d/2-1} \cos(0)
$$</p>
<p>$$
= \sum_{i=0}^{d/4-1} \cos(mb^{-4i/d}) + \frac{d}{4}
$$</p>
<p>ç”±äºå¸¸æ•°é¡¹$d/4 &gt; 0$ï¼Œä¸”$\cos(mb^{-4i/d}) \geq -1$ï¼š
$$
f_b(m) \geq \frac{d}{4} - \frac{d}{4} = 0
$$</p>
<p>ç­‰å·æˆç«‹å½“ä¸”ä»…å½“æ‰€æœ‰$\cos(mb^{-4i/d}) = -1$ï¼Œè¿™åœ¨å®é™…ä¸­å‡ ä¹ä¸å¯èƒ½åŒæ—¶å‘ç”Ÿã€‚å› æ­¤ï¼š
$$
f_b(m) > 0, \quad \forall m, b
$$</p>
<p><strong>æ¨å¯¼8.3ï¼šä½ç½®ä¿¡æ¯ä¸è¯­ä¹‰ä¿¡æ¯çš„å¹³è¡¡</strong></p>
<p>éƒ¨åˆ†æ—‹è½¬çš„ä¼˜åŠ¿åœ¨äºï¼š</p>
<ul>
<li>æ—‹è½¬ç»´åº¦ï¼šæä¾›ä½ç½®ä¿¡æ¯</li>
<li>éæ—‹è½¬ç»´åº¦ï¼šä¿ç•™çº¯è¯­ä¹‰ä¿¡æ¯</li>
</ul>
<p>è®°$\boldsymbol{q} = [\boldsymbol{q}_r, \boldsymbol{q}_n]$ï¼ˆæ—‹è½¬å’Œéæ—‹è½¬éƒ¨åˆ†ï¼‰ï¼Œå†…ç§¯åˆ†è§£ä¸ºï¼š
$$
(\boldsymbol{\mathcal{R}}_m\boldsymbol{q})^{\top}(\boldsymbol{\mathcal{R}}_n\boldsymbol{k}) = (\boldsymbol{\mathcal{R}}_{n-m}\boldsymbol{q}_r)^{\top}\boldsymbol{k}_r + \boldsymbol{q}_n^{\top}\boldsymbol{k}_n
$$</p>
<p>ç¬¬ä¸€é¡¹ç¼–ç ç›¸å¯¹ä½ç½®ï¼Œç¬¬äºŒé¡¹çº¯ç²¹åŸºäºè¯­ä¹‰ï¼Œä¸¤è€…ç»“åˆæä¾›æ›´çµæ´»çš„æ³¨æ„åŠ›æœºåˆ¶ã€‚</p>
<h3 id="9">9. æ•°å€¼æ±‚è§£çš„æ”¶æ•›æ€§åˆ†æ</h3>
<p><strong>æ¨å¯¼9.1ï¼šäºŒåˆ†æ³•å¤±æ•ˆçš„åŸå› </strong></p>
<p>å®šä¹‰é›†åˆï¼š
$$
S_b = \{m \in \mathbb{Z}^+ : f_b(m) \geq 0\}
$$</p>
<p>ç†æƒ³æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¸Œæœ›$b_1 &gt; b_2$è•´å«$S_{b_1} \supseteq S_{b_2}$ï¼Œè¿™æ ·å¯ä»¥ç”¨äºŒåˆ†æ³•ã€‚ä½†å®é™…ä¸Šç”±äº$f_b(m)$çš„å¤æ‚æŒ¯è¡ï¼Œè¿™ä¸ªå•è°ƒæ€§ä¸æ€»æ˜¯æˆç«‹ã€‚</p>
<p><strong>æ¨å¯¼9.2ï¼šé€†å‡½æ•°æ³•çš„æœ‰æ•ˆæ€§</strong></p>
<p>å®šä¹‰ï¼š
$$
L(b) = \max\{m : f_b(m') \geq 0, \forall m' \leq m\}
$$</p>
<p>è™½ç„¶$b \mapsto S_b$ä¸å•è°ƒï¼Œä½†å¯¹äºå›ºå®šçš„$b$ï¼Œè®¡ç®—$L(b)$æ˜¯å¯è¡Œçš„ï¼š</p>
<p>éå†$m = 1, 2, \ldots$ç›´åˆ°$f_b(m) &lt; 0$ï¼Œè®°å½•æœ€å¤§çš„$m$ã€‚</p>
<p>é€šè¿‡æšä¸¾è¶³å¤Ÿå¤šçš„$b$å€¼ï¼Œå¯ä»¥æ„å»º$(b, L(b))$çš„æ•°æ®ç‚¹ï¼Œç„¶åé€šè¿‡æŸ¥è¡¨æˆ–æ’å€¼å¾—åˆ°$b^*(L)$ã€‚</p>
<p><strong>æ¨å¯¼9.3ï¼šç½‘æ ¼æœç´¢çš„å¤æ‚åº¦</strong></p>
<p>åœ¨åŒºé—´$[0, B]$ä¸Šç”¨$N$ä¸ªç‚¹ç½‘æ ¼æœç´¢ï¼Œå¯¹æ¯ä¸ªç‚¹éœ€è¦æ£€éªŒ$L$ä¸ªä¸ç­‰å¼ï¼Œæ€»å¤æ‚åº¦ï¼š
$$
\mathcal{O}(N \cdot L \cdot d/2)
$$</p>
<p>åˆ©ç”¨GPUå¹¶è¡ŒåŒ–ï¼Œå¯ä»¥åŒæ—¶è®¡ç®—æ‰€æœ‰$m \in [0, L-1]$å’Œ$i \in [0, d/2-1]$ï¼š
$$
\text{å¤æ‚åº¦} = \mathcal{O}(N) \text{ï¼ˆåœ¨GPUæ—¶é—´æ„ä¹‰ä¸‹ï¼‰}
$$</p>
<h3 id="10">10. æ¸è¿‘ä¼°è®¡çš„ç²¾ç»†åŒ–</h3>
<p><strong>æ¨å¯¼10.1ï¼šCiå‡½æ•°çš„çº§æ•°å±•å¼€</strong></p>
<p>ä½™å¼¦ç§¯åˆ†å‡½æ•°åœ¨$x &gt; 0$å¤„çš„çº§æ•°è¡¨ç¤ºï¼š
$$
\text{Ci}(x) = \gamma + \ln x + \sum_{n=1}^{\infty} \frac{(-1)^n x^{2n}}{(2n)(2n)!}
$$</p>
<p>å…¶ä¸­$\gamma$æ˜¯æ¬§æ‹‰å¸¸æ•°ã€‚å¯¹äºå°$x$ï¼š
$$
\text{Ci}(x) \approx \gamma + \ln x - \frac{x^2}{4}
$$</p>
<p><strong>æ¨å¯¼10.2ï¼šä¸´ç•Œæ¡ä»¶çš„è¿‘ä¼¼è§£</strong></p>
<p>ä»£å…¥$f_b(m)$çš„è¡¨è¾¾å¼ï¼š
$$
f_b(m) \approx \frac{\text{Ci}(m/b^2) - \text{Ci}(m)}{\ln b}
$$</p>
<p>ä½¿ç”¨çº§æ•°å±•å¼€ï¼š
$$
\text{Ci}(m/b^2) \approx \gamma + \ln(m/b^2) = \gamma + \ln m - 2\ln b
$$</p>
<p>$$
\text{Ci}(m) \approx \gamma + \ln m - \frac{m^2}{4}
$$</p>
<p>å› æ­¤ï¼š
$$
f_b(m) \approx \frac{-2\ln b + m^2/4}{\ln b} = -2 + \frac{m^2}{4\ln b}
$$</p>
<p>è¦æ±‚$f_b(m) \geq 0$ï¼š
$$
\frac{m^2}{4\ln b} \geq 2 \implies \ln b \geq \frac{m^2}{8}
$$</p>
<p>å¯¹äº$m = L-1$ï¼š
$$
b \geq \exp\left(\frac{(L-1)^2}{8}\right)
$$</p>
<p>è¿™ä¸ªä¼°è®¡å¯¹äºå°$L$è¿‡äºä¸¥æ ¼ï¼Œä½†æ•æ‰äº†$b$éš$L$å¢é•¿çš„è¶‹åŠ¿ã€‚</p>
<p><strong>æ¨å¯¼10.3ï¼šæ”¹è¿›çš„çº¿æ€§ä¼°è®¡</strong></p>
<p>è€ƒè™‘$\text{Ci}(x)$çš„ç¬¬ä¸€ä¸ªé›¶ç‚¹$x_0 \approx 0.6165$ï¼Œä»¥åŠåœ¨$x &gt; 1$æ—¶$|\text{Ci}(x)| &lt; 0.5$çš„æ€§è´¨ã€‚</p>
<p>å¦‚æœå¿½ç•¥$\text{Ci}(m)$çš„è´¡çŒ®ï¼ˆå› ä¸ºå®ƒç›¸å¯¹è¾ƒå°ä¸”æŒ¯è¡ï¼‰ï¼Œä¸»è¦æ¡ä»¶å˜ä¸ºï¼š
$$
\text{Ci}(m/b^2) \geq 0
$$</p>
<p>è¦æ±‚$m/b^2 \leq x_0$å¯¹æ‰€æœ‰$m \leq L-1$æˆç«‹ï¼š
$$
\frac{L-1}{b^2} \leq x_0 \implies b \geq \sqrt{\frac{L-1}{x_0}} \approx 1.27\sqrt{L-1}
$$</p>
<p>ä½†è€ƒè™‘åˆ°å®é™…ä¸­$d$æ˜¯æœ‰é™çš„ï¼ˆå¦‚$d=128$ï¼‰ï¼Œç§¯åˆ†è¿‘ä¼¼ä¼šæœ‰åå·®ï¼Œå®é™…çš„$b^<em>$æ¯”è¿™ä¸ªä¼°è®¡è¦å¤§ã€‚æ•°å€¼ç»“æœæ˜¾ç¤º$b^</em> \sim L^{1.5}$åˆ°$L^2$ä¹‹é—´ã€‚</p>
<h3 id="11-llama3">11. LLAMA3åº•æ•°é€‰æ‹©çš„ç†è®ºè§£é‡Š</h3>
<p><strong>æ¨å¯¼11.1ï¼šLLAMA3çš„é…ç½®</strong></p>
<p>LLAMA3ä½¿ç”¨ï¼š
- è®­ç»ƒé•¿åº¦ï¼š$L_0 = 8192$
- RoPEåº•æ•°ï¼š$b = 500000$
- head_sizeï¼š$d = 128$</p>
<p>æ ¹æ®æ•°å€¼ç»“æœï¼Œ$L = 8192$å¯¹åº”çš„$b^* \approx 8.4 \times 10^4$ï¼Œè€ŒLLAMA3ä½¿ç”¨$b = 5 \times 10^5$ï¼Œçº¦ä¸ºç†è®ºå€¼çš„6å€ã€‚</p>
<p><strong>æ¨å¯¼11.2ï¼šåº•æ•°å†—ä½™çš„ä¼˜åŠ¿</strong></p>
<p>ä½¿ç”¨æ¯”ç†è®ºä¸‹ç•Œæ›´å¤§çš„$b$æœ‰å‡ ä¸ªå¥½å¤„ï¼š</p>
<ol>
<li><strong>å®‰å…¨è¾¹é™…</strong>ï¼šç¡®ä¿åœ¨$m \in [0, L-1]$å†…$f_b(m)$ç¨³å®šä¸ºæ­£</li>
<li><strong>é•¿åº¦å¤–æ¨é¢„ç•™</strong>ï¼šå¦‚æœæœªæ¥éœ€è¦æ‰©å±•åˆ°æ›´é•¿çš„ä¸Šä¸‹æ–‡ï¼Œæ— éœ€é‡æ–°è°ƒæ•´åº•æ•°</li>
<li><strong>è®­ç»ƒç¨³å®šæ€§</strong>ï¼šæ›´å¤§çš„$b$ä½¿å¾—ä½ç½®ç¼–ç æ›´åŠ å¹³æ»‘</li>
</ol>
<p><strong>æ¨å¯¼11.3ï¼šè¿‡å¤§åº•æ•°çš„æ½œåœ¨é£é™©</strong></p>
<p>å½“$b$è¿‡å¤§æ—¶ï¼Œä½é¢‘åˆ†é‡å˜å¾—æå…¶ç¼“æ…¢ï¼š
$$
\theta_{d/2-1} = b^{-(d-2)/d} = (5 \times 10^5)^{-126/128} \approx 2 \times 10^{-6}
$$</p>
<p>è¿™æ„å‘³ç€æœ€ä½é¢‘åˆ†é‡çš„å‘¨æœŸçº¦ä¸ºï¼š
$$
T = \frac{2\pi}{\theta_{d/2-1}} \approx 3 \times 10^6
$$</p>
<p>è¿œè¶…è®­ç»ƒé•¿åº¦8192ï¼Œè¿™éƒ¨åˆ†é¢‘ç‡åˆ†é‡åœ¨è®­ç»ƒä¸­å‡ ä¹ä¸å˜ï¼Œå¯èƒ½å¯¼è‡´å‚æ•°å†—ä½™ã€‚</p>
<h3 id="12">12. é¢‘ç‡åˆ†å¸ƒçš„ä¿¡æ¯è®ºè§£é‡Š</h3>
<p><strong>æ¨å¯¼12.1ï¼šé¦™å†œé‡‡æ ·å®šç†çš„ç±»æ¯”</strong></p>
<p>å°†ä½ç½®ç¼–ç ç±»æ¯”ä¸ºä¿¡å·ï¼Œé¢‘ç‡$\theta_i$å¯¹åº”äºå‚…é‡Œå¶åŸºã€‚æ ¹æ®é‡‡æ ·å®šç†ï¼Œè¦å‡†ç¡®è¡¨ç¤ºæœ€å¤§é¢‘ç‡ä¸º$f_{\max}$çš„ä¿¡å·ï¼Œé‡‡æ ·ç‡å¿…é¡»è‡³å°‘ä¸º$2f_{\max}$ã€‚</p>
<p>å¯¹äºRoPEï¼Œ"é‡‡æ ·ç‡"å¯¹åº”äºæœ€å¤§ä½ç½®$L$ï¼Œ"æœ€å¤§é¢‘ç‡"å¯¹åº”äº$\theta_0 = 1$ã€‚ä½†RoPEä½¿ç”¨å¤šä¸ªé¢‘ç‡çš„ç»„åˆï¼Œç›¸å½“äºå¤šé¢‘å¸¦ç¼–ç ã€‚</p>
<p><strong>æ¨å¯¼12.2ï¼šé¢‘ç‡åˆ†è¾¨ç‡</strong></p>
<p>ç›¸é‚»ä¸¤ä¸ªé¢‘ç‡çš„æ¯”å€¼ï¼š
$$
\frac{\theta_i}{\theta_{i+1}} = \frac{b^{-2i/d}}{b^{-2(i+1)/d}} = b^{2/d}
$$</p>
<p>è¿™æ˜¯ä¸€ä¸ªå¸¸æ•°ï¼Œæ„å‘³ç€é¢‘ç‡åœ¨å¯¹æ•°å°ºåº¦ä¸Šç­‰è·åˆ†å¸ƒã€‚é¢‘ç‡åˆ†è¾¨ç‡ï¼ˆå¯¹æ•°å°ºåº¦ï¼‰ï¼š
$$
\Delta(\log\theta) = \log\theta_i - \log\theta_{i+1} = \frac{2\log b}{d}
$$</p>
<p>æ›´å¤§çš„$b$æˆ–æ›´å¤§çš„$d$æä¾›æ›´ç²¾ç»†çš„é¢‘ç‡åˆ†è¾¨ç‡ã€‚</p>
<p><strong>æ¨å¯¼12.3ï¼šç¼–ç å®¹é‡</strong></p>
<p>ä»ä¿¡æ¯è®ºè§’åº¦ï¼Œ$d/2$ä¸ªä¸åŒé¢‘ç‡å¯ä»¥ç¼–ç çš„"ä¿¡æ¯é‡"å¤§è‡´ä¸ºï¼š
$$
I \sim (d/2) \log_2(\text{é¢‘ç‡åŠ¨æ€èŒƒå›´})
$$</p>
<p>é¢‘ç‡åŠ¨æ€èŒƒå›´ä¸º$\theta_0/\theta_{d/2-1} \approx b$ï¼Œå› æ­¤ï¼š
$$
I \sim \frac{d}{2} \log_2 b
$$</p>
<p>è¦ç¼–ç $L$ä¸ªä¸åŒä½ç½®ï¼Œéœ€è¦ï¼š
$$
I \geq \log_2 L \implies \frac{d}{2}\log_2 b \geq \log_2 L
$$</p>
<p>è§£å¾—ï¼š
$$
b \geq L^{2/d}
$$</p>
<p>å¯¹äº$d = 128$ï¼š
$$
b \geq L^{1/64}
$$</p>
<p>è¿™ä¸ªä¸‹ç•Œè¿œä½äºå®é™…éœ€æ±‚ï¼Œè¯´æ˜é™¤äº†ç¼–ç å®¹é‡ï¼Œè¿˜æœ‰å…¶ä»–çº¦æŸï¼ˆå¦‚è¯­ä¹‰èšåˆï¼‰åœ¨èµ·ä½œç”¨ã€‚</p>
<h3 id="13">13. é•¿åº¦æ³›åŒ–çš„ç†è®ºä¿è¯</h3>
<p><strong>æ¨å¯¼13.1ï¼šè®­ç»ƒä¸æµ‹è¯•çš„åˆ†å¸ƒå˜åŒ–</strong></p>
<p>è®­ç»ƒé˜¶æ®µè§åˆ°çš„ç›¸å¯¹ä½ç½®ï¼š$\Delta \in [0, L_0 - 1]$</p>
<p>æµ‹è¯•é˜¶æ®µå¯èƒ½å‡ºç°çš„ç›¸å¯¹ä½ç½®ï¼š$\Delta \in [0, L - 1]$ï¼Œå…¶ä¸­$L &gt; L_0$</p>
<p>é•¿åº¦æ³›åŒ–è¦æ±‚æ¨¡å‹åœ¨æœªè§è¿‡çš„$\Delta \in [L_0, L-1]$ä¸Šä»èƒ½æ­£å¸¸å·¥ä½œã€‚</p>
<p><strong>æ¨å¯¼13.2ï¼šå¤–æ¨å¤±è´¥çš„æœºåˆ¶</strong></p>
<p>å¦‚æœ$b$é€‰æ‹©ä»…æ»¡è¶³$f_b(\Delta) \geq 0$å¯¹$\Delta \leq L_0 - 1$ï¼Œå½“$\Delta \geq L_0$æ—¶ï¼Œå¯èƒ½å‡ºç°$f_b(\Delta) &lt; 0$ã€‚</p>
<p>è¿™ä¼šå¯¼è‡´ï¼š
$$
\mathbb{E}[\text{ç›¸ä¼¼tokençš„æ³¨æ„åŠ›}] < \mathbb{E}[\text{éšæœºtokençš„æ³¨æ„åŠ›}]
$$</p>
<p>ç ´åäº†æ³¨æ„åŠ›æœºåˆ¶çš„è¯­ä¹‰æ€§ï¼Œå¯¼è‡´å¤–æ¨å¤±è´¥ã€‚</p>
<p><strong>æ¨å¯¼13.3ï¼šå®‰å…¨å¤–æ¨çš„åº•æ•°é€‰æ‹©</strong></p>
<p>ä¸ºäº†å®‰å…¨å¤–æ¨åˆ°é•¿åº¦$L$ï¼Œåº”è¯¥åœ¨è®­ç»ƒæ—¶å°±é€‰æ‹©æ»¡è¶³$L$çš„$b^*(L)$ï¼Œå³ä½¿è®­ç»ƒé•¿åº¦åªæœ‰$L_0 &lt; L$ã€‚</p>
<p>æˆ–è€…ï¼Œä½¿ç”¨NTKæ’å€¼åŠ¨æ€è°ƒæ•´ï¼š
$$
b'(\text{æµ‹è¯•æ—¶}) = b(\text{è®­ç»ƒæ—¶}) \cdot \left(\frac{L}{L_0}\right)^{d/(d-2)}
$$</p>
<h3 id="14">14. éƒ¨åˆ†æ—‹è½¬æ¯”ä¾‹çš„ä¼˜åŒ–</h3>
<p><strong>æ¨å¯¼14.1ï¼šæ—‹è½¬æ¯”ä¾‹å‚æ•°</strong></p>
<p>è®¾æ—‹è½¬ç»´åº¦æ¯”ä¾‹ä¸º$\rho \in (0, 1]$ï¼Œåˆ™æ—‹è½¬ç»´åº¦æ•°ä¸º$\rho d$ï¼Œéæ—‹è½¬ç»´åº¦æ•°ä¸º$(1-\rho)d$ã€‚</p>
<p><strong>æ¨å¯¼14.2ï¼šè¯­ä¹‰èšåˆæ¡ä»¶çš„æ¨å¹¿</strong></p>
<p>ç±»ä¼¼ä¹‹å‰çš„æ¨å¯¼ï¼š
$$
f_b(m, \rho) = \sum_{i=0}^{\rho d/2 - 1} \cos(m\theta_i) + (1-\rho)\frac{d}{2}
$$</p>
<p>è¦æ±‚éè´Ÿï¼š
$$
\sum_{i=0}^{\rho d/2 - 1} \cos(m\theta_i) \geq -(1-\rho)\frac{d}{2}
$$</p>
<p>ç”±äº$\cos(m\theta_i) \geq -1$ï¼š
$$
\sum_{i=0}^{\rho d/2 - 1} \cos(m\theta_i) \geq -\rho\frac{d}{2}
$$</p>
<p>æ‰€ä»¥åªè¦$-\rho d/2 \geq -(1-\rho)d/2$ï¼Œå³$\rho \leq 1 - \rho$ï¼Œå³$\rho \leq 0.5$ï¼Œä¸ç­‰å¼å°±è‡ªåŠ¨æ»¡è¶³ã€‚</p>
<p><strong>æ¨å¯¼14.3ï¼šæœ€ä¼˜æ¯”ä¾‹çš„æƒè¡¡</strong></p>
<p>é€‰æ‹©$\rho$éœ€è¦æƒè¡¡ï¼š</p>
<ul>
<li>$\rho$è¶Šå¤§ï¼šä½ç½®ä¿¡æ¯è¶Šä¸°å¯Œï¼Œä½†è¯­ä¹‰èšåˆæ¡ä»¶è¶Šéš¾æ»¡è¶³</li>
<li>$\rho$è¶Šå°ï¼šè¯­ä¹‰èšåˆæ¡ä»¶å®¹æ˜“æ»¡è¶³ï¼Œä½†ä½ç½®ä¿¡æ¯ä¸è¶³</li>
</ul>
<p>å®éªŒè¡¨æ˜$\rho \in [0.25, 0.5]$æ˜¯ä¸€ä¸ªè¾ƒå¥½çš„èŒƒå›´ã€‚</p>
<h3 id="15-attention">15. å¤šå±‚Attentionçš„ç´¯ç§¯æ•ˆåº”</h3>
<p><strong>æ¨å¯¼15.1ï¼šè·¨å±‚çš„ä½ç½®ç¼–ç </strong></p>
<p>è€ƒè™‘$L$å±‚Transformerï¼Œæ¯å±‚éƒ½ä½¿ç”¨RoPEã€‚ä½ç½®ä¿¡æ¯åœ¨å±‚é—´ä¼ æ’­çš„æœºåˆ¶ï¼š</p>
<p>ç¬¬$\ell$å±‚çš„è¾“å‡ºï¼š
$$
\boldsymbol{h}_n^{(\ell)} = f(\text{Attention}(\boldsymbol{\mathcal{R}}_n\boldsymbol{q}_n^{(\ell)}, \{\boldsymbol{\mathcal{R}}_m\boldsymbol{k}_m^{(\ell)}\}_{m \leq n}))
$$</p>
<p>ä½ç½®ä¿¡æ¯é€šè¿‡$\boldsymbol{\mathcal{R}}_n$æ³¨å…¥ï¼Œä½†$\boldsymbol{h}_n^{(\ell)}$æœ¬èº«ä¸æ˜¾å¼æºå¸¦ä½ç½®æ ‡è®°ã€‚</p>
<p><strong>æ¨å¯¼15.2ï¼šå±‚é—´ä½ç½®ä¿¡æ¯çš„è¡°å‡</strong></p>
<p>å‡è®¾ç¬¬$\ell$å±‚çš„è¾“å‡ºå¯¹ä½ç½®çš„æ•æ„Ÿåº¦ä¸º$s^{(\ell)}$ï¼Œåˆ™ï¼š
$$
s^{(\ell+1)} \approx \gamma \cdot s^{(\ell)}
$$</p>
<p>å…¶ä¸­$\gamma &lt; 1$æ˜¯è¡°å‡å› å­ï¼Œå–å†³äºAttentionåçš„éçº¿æ€§å˜æ¢ï¼ˆLayerNormã€FFNç­‰ï¼‰ã€‚</p>
<p>ç»è¿‡$L$å±‚åï¼š
$$
s^{(L)} \approx \gamma^L \cdot s^{(0)}
$$</p>
<p>å¦‚æœ$\gamma$å¤ªå°ï¼Œæ·±å±‚çš„ä½ç½®ä¿¡æ¯ä¼šä¸¢å¤±ã€‚</p>
<p><strong>æ¨å¯¼15.3ï¼šéƒ¨åˆ†æ—‹è½¬çš„è·¨å±‚ä¼˜åŠ¿</strong></p>
<p>éƒ¨åˆ†æ—‹è½¬åœ¨æ¯å±‚éƒ½é‡æ–°æ³¨å…¥ä½ç½®ä¿¡æ¯åˆ°æ—‹è½¬ç»´åº¦ï¼ŒåŒæ—¶ä¿æŒéæ—‹è½¬ç»´åº¦çš„è¯­ä¹‰ä¿¡æ¯ï¼š
$$
\boldsymbol{h}_n^{(\ell)} = [\boldsymbol{h}_{n,r}^{(\ell)}, \boldsymbol{h}_{n,nr}^{(\ell)}]
$$</p>
<p>æ¯å±‚Attentionæ—¶ï¼Œ$\boldsymbol{h}<em n_nr="n,nr">{n,r}^{(\ell)}$è¢«æ—‹è½¬ï¼Œ$\boldsymbol{h}</em>$ä¿æŒä¸å˜ï¼Œè¿™æä¾›äº†æ›´ç¨³å®šçš„ä½ç½®ä¿¡æ¯ä¼ æ’­ã€‚}^{(\ell)</p>
<h3 id="16">16. å®éªŒéªŒè¯çš„ç»Ÿè®¡æ£€éªŒ</h3>
<p><strong>æ¨å¯¼16.1ï¼šåº•æ•°é€‰æ‹©çš„å‡è®¾æ£€éªŒ</strong></p>
<p>é›¶å‡è®¾$H_0$ï¼šåº•æ•°$b$ä¸æœ€å¤§é•¿åº¦$L$æ— å…³</p>
<p>å¤‡æ‹©å‡è®¾$H_1$ï¼š$b$åº”è¯¥éš$L$å¢å¤§è€Œå¢å¤§</p>
<p>æ£€éªŒç»Ÿè®¡é‡ï¼šSpearmanç§©ç›¸å…³ç³»æ•°
$$
\rho_s = \frac{\text{Cov}(\text{rank}(b), \text{rank}(L))}{\sigma_{\text{rank}(b)} \sigma_{\text{rank}(L)}}
$$</p>
<p>æ ¹æ®æ•°å€¼ç»“æœçš„$(b^*, L)$æ•°æ®ç‚¹ï¼Œè®¡ç®—$\rho_s$æ˜¾è‘—å¤§äº0ï¼Œæ‹’ç»$H_0$ã€‚</p>
<p><strong>æ¨å¯¼16.2ï¼šæ‹Ÿåˆå…³ç³»çš„ç¡®å®š</strong></p>
<p>å‡è®¾å¹‚å¾‹å…³ç³»ï¼š$b = aL^{\alpha}$</p>
<p>å–å¯¹æ•°ï¼š$\log b = \log a + \alpha \log L$</p>
<p>çº¿æ€§å›å½’å¾—åˆ°$\alpha$çš„ä¼°è®¡ã€‚æ ¹æ®æ•°å€¼æ•°æ®ï¼Œ$\alpha \approx 1.5 \sim 2.0$ã€‚</p>
<p><strong>æ¨å¯¼16.3ï¼šç½®ä¿¡åŒºé—´ä¼°è®¡</strong></p>
<p>ç»™å®š$L$ï¼Œ$b^*$çš„$95\%$ç½®ä¿¡åŒºé—´å¯ä»¥é€šè¿‡è‡ªåŠ©æ³•ï¼ˆBootstrapï¼‰ä¼°è®¡ï¼š</p>
<ol>
<li>ä»æ•°å€¼ç»“æœä¸­é‡é‡‡æ ·</li>
<li>å¯¹æ¯ä¸ªé‡é‡‡æ ·é›†æ‹Ÿåˆ$b = aL^{\alpha}$</li>
<li>è®¡ç®—$b^*(L)$çš„åˆ†ä½æ•°</li>
</ol>
<p>è¿™æä¾›äº†$b^*$é€‰æ‹©çš„ä¸ç¡®å®šæ€§åº¦é‡ã€‚</p>
<h3 id="17">17. æ€»ç»“ä¸å®è·µå»ºè®®</h3>
<p><strong>æ¨å¯¼17.1ï¼šåº•æ•°é€‰æ‹©çš„å¯å‘å¼è§„åˆ™</strong></p>
<p>ç»¼åˆç†è®ºåˆ†æå’Œæ•°å€¼ç»“æœï¼Œå»ºè®®ï¼š</p>
<ol>
<li><strong>ä¿å®ˆä¼°è®¡</strong>ï¼š$b \geq 10L$</li>
<li><strong>æ ‡å‡†é…ç½®</strong>ï¼š$b = 100L$ï¼ˆå¯¹äºå¸¸è§çš„$d=128$ï¼‰</li>
<li><strong>é•¿ä¸Šä¸‹æ–‡</strong>ï¼š$b = 1000L$æˆ–æ ¹æ®æ•°å€¼è¡¨æŸ¥è¯¢</li>
</ol>
<p><strong>æ¨å¯¼17.2ï¼šåŠ¨æ€è°ƒæ•´ç­–ç•¥</strong></p>
<p>è®­ç»ƒè¿‡ç¨‹ä¸­åŠ¨æ€è°ƒæ•´$b$çš„æ–¹æ¡ˆï¼š</p>
<ul>
<li>è®­ç»ƒå‰æœŸï¼ˆçŸ­ä¸Šä¸‹æ–‡ï¼‰ï¼šä½¿ç”¨è¾ƒå°çš„$b_0$</li>
<li>è®­ç»ƒä¸­æœŸï¼ˆé€æ¸å¢åŠ ä¸Šä¸‹æ–‡ï¼‰ï¼šçº¿æ€§å¢å¤§$b$</li>
<li>è®­ç»ƒåæœŸï¼ˆé•¿ä¸Šä¸‹æ–‡ï¼‰ï¼šå›ºå®šåœ¨ç›®æ ‡$b_{\text{final}}$</li>
</ul>
<p>è°ƒæ•´å…¬å¼ï¼š
$$
b(t) = b_0 + (b_{\text{final}} - b_0) \cdot \min(1, t/t_{\text{transition}})
$$</p>
<p><strong>æ¨å¯¼17.3ï¼šä¸å…¶ä»–æŠ€æœ¯çš„ç»“åˆ</strong></p>
<p>RoPEåº•æ•°é€‰æ‹©åº”ä¸ä»¥ä¸‹æŠ€æœ¯ååŒè€ƒè™‘ï¼š</p>
<ul>
<li>ALiBiï¼šåŠ æ€§ä½ç½®åç½®ï¼Œå¯ä»¥å‡å°å¯¹$b$çš„ä¾èµ–</li>
<li>ä½ç½®æ’å€¼ï¼šå…è®¸ç”¨è¾ƒå°çš„$b$è®­ç»ƒåï¼Œé€šè¿‡æ’å€¼å¤–æ¨åˆ°æ›´é•¿ä¸Šä¸‹æ–‡</li>
<li>FlashAttentionç­‰ä¼˜åŒ–ï¼šä¸»è¦å½±å“è®¡ç®—æ•ˆç‡ï¼Œä¸æ”¹å˜å¯¹$b$çš„ç†è®ºè¦æ±‚</li>
</ul>
<p>æœ€ä½³å®è·µæ˜¯ï¼šé€‰æ‹©åˆé€‚çš„$b$ä½œä¸ºåŸºç¡€ï¼Œç„¶åè¾…ä»¥å…¶ä»–æŠ€æœ¯æå‡æ€§èƒ½å’Œæ•ˆç‡ã€‚</p>
        </div>
    </div>
</body>
</html>