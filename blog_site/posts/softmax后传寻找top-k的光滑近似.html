<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Softmaxåä¼ ï¼šå¯»æ‰¾Top-Kçš„å…‰æ»‘è¿‘ä¼¼</title>
    <style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    line-height: 1.6; color: #333; max-width: 900px; margin: 0 auto; padding: 20px; background: #f5f5f5;
}
.container { background: white; padding: 40px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
header { border-bottom: 2px solid #e0e0e0; padding-bottom: 20px; margin-bottom: 30px; }
h1 { color: #2c3e50; margin-bottom: 10px; font-size: 2em; }
.meta { color: #666; font-size: 0.9em; margin-bottom: 20px; }
.content { margin-top: 30px; overflow-wrap: break-word; }
.content h2 { color: #34495e; margin-top: 30px; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
.content p { margin-bottom: 15px; }
.content pre { background: #f8f8f8; padding: 15px; border-radius: 5px; overflow-x: auto; border-left: 3px solid #3498db; margin: 15px 0; }
.content code { background: #f8f8f8; padding: 2px 5px; border-radius: 3px; font-family: monospace; font-size: 0.9em; }
.content blockquote { border-left: 4px solid #3498db; padding-left: 20px; margin: 20px 0; color: #555; font-style: italic; }
.content table { border-collapse: collapse; width: 100%; margin: 20px 0; }
.content th, .content td { border: 1px solid #ddd; padding: 10px; text-align: left; }
.back-link { display: inline-block; margin-bottom: 20px; color: #3498db; text-decoration: none; font-weight: 500; }
</style>
    
<script>
    window.MathJax = {
        tex: {
            inlineMath: [['$', '$'], ['\(', '\)']],
            displayMath: [['$$', '$$'], ['\[', '\]']],
            processEscapes: true
        }
    };
</script>
<script id="MathJax-script" async src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>

</head>
<body>
    <div class="container">
        <a href="../index.html" class="back-link">â† è¿”å›é¦–é¡µ</a>
        <header>
            <h1>Softmaxåä¼ ï¼šå¯»æ‰¾Top-Kçš„å…‰æ»‘è¿‘ä¼¼</h1>
            <div class="meta">ğŸ“… æœ€åæ›´æ–°: 2025-11-26 | ğŸ“„ å¤§å°: 46.8 KB</div>
        </header>
        <div class="content">
            <p><strong>åŸæ–‡é“¾æ¥</strong>: <a href="https://spaces.ac.cn/archives/10373">https://spaces.ac.cn/archives/10373</a></p>
<p><strong>å‘å¸ƒæ—¥æœŸ</strong>: </p>
<hr />
<p>Softmaxï¼Œé¡¾åæ€ä¹‰æ˜¯â€œsoftçš„maxâ€ï¼Œæ˜¯$\max$ç®—å­ï¼ˆå‡†ç¡®æ¥è¯´æ˜¯$\text{argmax}$ï¼‰çš„å…‰æ»‘è¿‘ä¼¼ï¼Œå®ƒé€šè¿‡æŒ‡æ•°å½’ä¸€åŒ–å°†ä»»æ„å‘é‡$\boldsymbol{x}\in\mathbb{R}^n$è½¬åŒ–ä¸ºåˆ†é‡éè´Ÿä¸”å’Œä¸º1çš„æ–°å‘é‡ï¼Œå¹¶å…è®¸æˆ‘ä»¬é€šè¿‡æ¸©åº¦å‚æ•°æ¥è°ƒèŠ‚å®ƒä¸$\text{argmax}$ï¼ˆçš„one hotå½¢å¼ï¼‰çš„è¿‘ä¼¼ç¨‹åº¦ã€‚é™¤äº†æŒ‡æ•°å½’ä¸€åŒ–å¤–ï¼Œæˆ‘ä»¬æ­¤å‰åœ¨<a href="/archives/10145">ã€Šé€šå‘æ¦‚ç‡åˆ†å¸ƒä¹‹è·¯ï¼šç›˜ç‚¹SoftmaxåŠå…¶æ›¿ä»£å“ã€‹</a>ä¹Ÿä»‹ç»è¿‡å…¶ä»–ä¸€äº›èƒ½å®ç°ç›¸åŒæ•ˆæœçš„æ–¹æ¡ˆã€‚</p>
<p>æˆ‘ä»¬çŸ¥é“ï¼Œæœ€å¤§å€¼é€šå¸¸åˆç§°Top-1ï¼Œå®ƒçš„å…‰æ»‘è¿‘ä¼¼æ–¹æ¡ˆçœ‹èµ·æ¥å·²ç»ç›¸å½“æˆç†Ÿï¼Œé‚£è¯»è€…æœ‰æ²¡æœ‰æ€è€ƒè¿‡ï¼Œä¸€èˆ¬çš„Top-$k$çš„å…‰æ»‘è¿‘ä¼¼åˆæ˜¯æ€ä¹ˆæ ·çš„å‘¢ï¼Ÿä¸‹é¢è®©æˆ‘ä»¬ä¸€èµ·æ¥æ¢è®¨ä¸€ä¸‹è¿™ä¸ªé—®é¢˜ã€‚</p>
<h2 id="_1">é—®é¢˜æè¿°</h2>
<p>è®¾å‘é‡$\boldsymbol{x}=(x_1,x_2,\cdots,x_n)\in\mathbb{R}^n$ï¼Œç®€å•èµ·è§æˆ‘ä»¬å‡è®¾å®ƒä»¬ä¸¤ä¸¤ä¸ç›¸ç­‰ï¼Œå³$i\neq j \Leftrightarrow x_i\neq x_j$ã€‚è®°$\Omega_k(\boldsymbol{x})$ä¸º$\boldsymbol{x}$æœ€å¤§çš„$k$ä¸ªåˆ†é‡çš„ä¸‹æ ‡é›†åˆï¼Œå³$|\Omega_k(\boldsymbol{x})|=k$ä»¥åŠ$\forall i\in \Omega_k(\boldsymbol{x}), j \not\in \Omega_k(\boldsymbol{x})\Rightarrow x_i &gt; x_j$ã€‚æˆ‘ä»¬å®šä¹‰Top-$k$ç®—å­$\mathcal{T}_k$ä¸º$\mathbb{R}^n\mapsto\{0,1\}^n$çš„æ˜ å°„ï¼š<br />
\begin{equation}<br />
[\mathcal{T}_k(\boldsymbol{x})]_i = \left\{\begin{aligned}1,\,\, i\in \Omega_k(\boldsymbol{x}) \\\ 0,\,\, i \not\in \Omega_k(\boldsymbol{x})\end{aligned}\right.<br />
\end{equation}<br />
è¯´ç™½äº†ï¼Œå¦‚æœ$x_i$å±äºæœ€å¤§çš„$k$ä¸ªå…ƒç´ ä¹‹ä¸€ï¼Œé‚£ä¹ˆå¯¹åº”çš„ä½ç½®å˜æˆ1ï¼Œå¦åˆ™å˜æˆ0ï¼Œæœ€ç»ˆç»“æœæ˜¯ä¸€ä¸ªMulti-Hotå‘é‡ï¼Œæ¯”å¦‚$\mathcal{T}_2([3,2,1,4]) = [1,0,0,1]$ã€‚</p>
<p>ä»$\boldsymbol{x}$åˆ°$\mathcal{T}_k(\boldsymbol{x})$å®é™…ä¸Šæ˜¯ä¸€ç§ç¡¬æŒ‡æ´¾ï¼ˆHard Assignmentï¼‰è¿ç®—ï¼Œå®ƒæœ¬è´¨ä¸Šæ˜¯ä¸è¿ç»­çš„ï¼Œæ²¡æœ‰ä¿ç•™å…³äº$\boldsymbol{x}$çš„æœ‰æ•ˆæ¢¯åº¦ï¼Œå› æ­¤æ— æ³•é›†æˆåˆ°æ¨¡å‹ä¸­è¿›è¡Œç«¯åˆ°ç«¯è®­ç»ƒã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å°±éœ€è¦æ„é€ ä¸€ä¸ªèƒ½å¤Ÿæä¾›æœ‰æ•ˆæ¢¯åº¦ä¿¡æ¯çš„$\mathcal{T}_k(\boldsymbol{x})$çš„å…‰æ»‘è¿‘ä¼¼â€”â€”åœ¨æœ‰äº›æ–‡çŒ®ä¸­ä¹Ÿç§°ä¸ºâ€œå¯å¾®Top-$k$ç®—å­ï¼ˆDifferentiable Top-$k$ Operatorï¼‰â€ã€‚</p>
<p>å…·ä½“æ¥è¯´ï¼Œæˆ‘ä»¬å®šä¹‰é›†åˆ<br />
\begin{equation}\Delta_k^{n-1} = \left\{\boldsymbol{p}=(p_1,p_2,\cdots,p_n)\left|\, p_1,p_2,\cdots,p_n\in[0,1],\sum_{i=1}^n p_i = k\right.\right\}\end{equation}<br />
é‚£ä¹ˆæˆ‘ä»¬è¦åšçš„äº‹æƒ…å°±æ˜¯æ„å»º$\mathbb{R}^n\mapsto \Delta_k^{n-1}$çš„ä¸€ä¸ªæ˜ å°„$\mathcal{ST}<em 0_="0^+" _tau_to="\tau\to">k(\boldsymbol{x})$ï¼Œå¹¶å°½é‡æ»¡è¶³å¦‚ä¸‹æ€§è´¨<br />
\begin{align}&amp;{\color{red}{å•è°ƒæ€§}}:\quad [\mathcal{ST}_k(\boldsymbol{x})]_i \geq [\mathcal{ST}_k(\boldsymbol{x})]_j \,\,\Leftrightarrow\,\, x_i \geq x_j \\\[8pt]<br />
&amp;{\color{red}{ä¸å˜æ€§}}:\quad \mathcal{ST}_k(\boldsymbol{x}) = \mathcal{ST}_k(\boldsymbol{x} + c),\,\,\forall c\in\mathbb{R} \\\[8pt]<br />
&amp;{\color{red}{è¶‹è¿‘æ€§}}:\quad \lim</em>) \\\}\mathcal{ST}_k(\boldsymbol{x}/\tau) = \mathcal{T}_k(\boldsymbol{x<br />
\end{align}<br />
å¯ä»¥éªŒè¯ä½œä¸º$\mathcal{ST}_1(\boldsymbol{x})$çš„Softmaxæ˜¯æ»¡è¶³å¦‚ä¸Šæ€§è´¨çš„ï¼Œæ‰€ä»¥æå‡ºä¸Šè¿°æ€§è´¨å®é™…å°±æ˜¯å¸Œæœ›æ„å»ºå‡ºæ¥çš„$\mathcal{ST}_k(\boldsymbol{x})$èƒ½å¤Ÿæˆä¸ºSoftmaxçš„è‡ªç„¶æ¨å¹¿ã€‚å½“ç„¶ï¼Œæ„å»ºTop-$k$çš„å…‰æ»‘è¿‘ä¼¼æœ¬èº«å°±æ¯”Top-1çš„è¦éš¾ï¼Œæ‰€ä»¥å¦‚æœé‡åˆ°å›°éš¾çš„è¯ï¼Œä¸å¿…è¦ä¸¥æ ¼éµå¾ªä»¥ä¸Šæ€§è´¨ï¼Œåªè¦èƒ½è¡¨æ˜æ‰€æ„å»ºçš„æ˜ å°„ç¡®å®å…·å¤‡$\mathcal{T}_k(\boldsymbol{x})$çš„å…‰æ»‘è¿‘ä¼¼çš„ç‰¹æ€§å°±è¡Œã€‚</p>
<h2 id="_2">è¿­ä»£æ„é€ </h2>
<p>äº‹å®ä¸Šï¼Œç¬”è€…å¾ˆæ—©ä¹‹å‰å°±å…³æ³¨è¿‡è¯¥é—®é¢˜ï¼Œé¦–æ¬¡è®¨è®ºäº2019å¹´çš„æ–‡ç« <a href="/archives/6620">ã€Šå‡½æ•°å…‰æ»‘åŒ–æ‚è°ˆï¼šä¸å¯å¯¼å‡½æ•°çš„å¯å¯¼é€¼è¿‘ã€‹</a>ä¸­ï¼Œå½“æ—¶ç§°ä¹‹ä¸º$\text{soft-}k\text{-max}$ï¼Œå¹¶ç»™å‡ºè¿‡ä¸€ä¸ªè¿­ä»£æ„é€ æ–¹æ¡ˆï¼š</p>
<blockquote>
<p>è¾“å…¥ä¸º$\boldsymbol{x}$ï¼Œåˆå§‹åŒ–$\boldsymbol{p}^{(0)}$ä¸ºå…¨0å‘é‡ï¼›<br />
 æ‰§è¡Œ$\boldsymbol{x} = \boldsymbol{x} - \min(\boldsymbol{x})$ï¼ˆä¿è¯æ‰€æœ‰å…ƒç´ éè´Ÿï¼‰</p>
<p>å¯¹äº$i=1,2,\dots,k$ï¼Œæ‰§è¡Œï¼š<br />
 $\boldsymbol{y} = (1 - \boldsymbol{p}^{(i-1)})\otimes\boldsymbol{x}$;<br />
 $\boldsymbol{p}^{(i)} = \boldsymbol{p}^{(i-1)} + \text{softmax}(\boldsymbol{y})$</p>
<p>è¿”å›$\boldsymbol{p}^{(k)}$ã€‚</p>
</blockquote>
<p>å…¶å®è¿™ä¸ªè¿­ä»£çš„æ„é€ æ€è·¯å¾ˆç®€å•ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆå°†$\text{softmax}(\boldsymbol{y})$æ›¿æ¢ä¸º$\mathcal{T}_1(\boldsymbol{y})$æ¥ç†è§£ï¼Œæ­¤æ—¶ç®—æ³•æµç¨‹å°±æ˜¯å…ˆä¿è¯åˆ†é‡éè´Ÿï¼Œç„¶åè¯†åˆ«å‡ºTop-1ï¼Œå†å°†Top-1ç½®é›¶ï¼ˆæœ€å¤§å€¼å˜æˆäº†æœ€å°å€¼ï¼‰ï¼Œæ¥ç€è¯†åˆ«å‡ºå‰©ä¸‹çš„Top-1ï¼Œä¾æ­¤ç±»æ¨ï¼Œæœ€ç»ˆçš„$\boldsymbol{p}_k$æ­£å¥½å°±æ˜¯$\mathcal{T}_k(\boldsymbol{x})$ã€‚è€Œ$\text{softmax}(\boldsymbol{y})$ä½œä¸º$\mathcal{T}_1(\boldsymbol{y})$çš„å…‰æ»‘è¿‘ä¼¼ï¼Œåœ¨è¿­ä»£è¿‡ç¨‹ä¸­ä½¿ç”¨$\text{softmax}(\boldsymbol{y})$è‡ªç„¶ä¹Ÿå°±å¾—åˆ°$\mathcal{T}_k(\boldsymbol{x})$çš„å…‰æ»‘è¿‘ä¼¼äº†ã€‚</p>
<p>æ— ç‹¬æœ‰å¶ï¼Œç¬”è€…å‘ç°åœ¨Stack Exchangeä¸Šçš„æé—®<a href="https://stats.stackexchange.com/a/454788">ã€ŠIs there something like softmax but for top k values?ã€‹</a>ä¸­æœ‰å›å¤è€…æå‡ºè¿‡ä¸€ä¸ªç›¸åŒæ€è·¯çš„æ–¹æ¡ˆï¼Œå®ƒå…ˆå®šä¹‰äº†åŠ æƒSoftmaxï¼š<br />
\begin{equation}[\text{softmax}(\boldsymbol{x};\boldsymbol{w})]<em i="1">i = \frac{w_i e^{x_i}}{\sum\limits</em>}^n w_i e^{x_i}}\end{equation<br />
ç„¶åæ„å»ºçš„è¿­ä»£è¿‡ç¨‹ä¸º</p>
<blockquote>
<p>è¾“å…¥ä¸º$\boldsymbol{x}$ï¼Œåˆå§‹åŒ–$\boldsymbol{p}^{(0)}$ä¸ºå…¨0å‘é‡ï¼›</p>
<p>å¯¹äº$i=1,2,\dots,k$ï¼Œæ‰§è¡Œï¼š<br />
 $\boldsymbol{p}^{(i)} = \boldsymbol{p}^{(i-1)} + \text{softmax}(\boldsymbol{x}; 1 - \boldsymbol{p}^{(i-1)})$</p>
<p>è¿”å›$\boldsymbol{p}^{(k)}$ã€‚</p>
</blockquote>
<p>è¿™è·Ÿç¬”è€…æ‰€æçš„è¿­ä»£è¿‡ç¨‹åœ¨æ€è·¯ä¸Šæ˜¯å®Œå…¨ä¸€æ ·çš„ï¼Œåªä¸è¿‡ç¬”è€…æŠŠ$1 - \boldsymbol{p}<em>{i-1}$ä¹˜åˆ°äº†$\boldsymbol{x}$ä¸Šè€Œå®ƒåˆ™ä¹˜åˆ°äº†$e^{\boldsymbol{x}}$ä¸Šï¼Œå€ŸåŠ©$e^{\boldsymbol{x}}$æœ¬èº«çš„éè´Ÿæ€§ç®€åŒ–äº†æµç¨‹ã€‚ç„¶è€Œï¼Œè¿™ä¸ªè¿­ä»£å®é™…ä¸Šæ˜¯é”™è¯¯çš„ï¼Œå®ƒ _ä¸ç¬¦åˆâ€œè¶‹è¿‘æ€§â€</em> ï¼Œæ¯”å¦‚å½“$k=2$æ—¶ï¼Œä»£å…¥$\boldsymbol{x}/\tau$å–$\tau\to 0^+$çš„æé™å¹¶ä¸æ˜¯Multi-Hotå‘é‡ï¼Œè€Œæ˜¯æœ€å¤§å€¼å˜ä¸º1.5ã€æ¬¡å¤§å€¼å˜ä¸º0.5ã€å…¶ä½™éƒ½å˜ä¸º0çš„å‘é‡ï¼Œè¿™æ˜¯å› ä¸º$1-p_{\max}$è·Ÿ$e^{-x_{\max}}$å¤§è‡´ä¸Šæ˜¯åŒé˜¶çš„ï¼Œ$1-p_{\max}$ä¹˜åˆ°$e^{x_{\max}}$ä¸Šå¹¶ä¸èƒ½å®Œå…¨æ¶ˆé™¤æœ€å¤§å€¼ã€‚</p>
<h2 id="_3">ä½œä¸ºæ¢¯åº¦</h2>
<p>è¿­ä»£æ„é€ å…¨å‡­ç»éªŒï¼Œå¯èƒ½ä¼šéšè—ä¸€äº›éš¾ä»¥å‘ç°çš„é—®é¢˜ï¼Œæ¯”å¦‚çœ‹èµ·æ¥æ›´ç®€å•çš„åŠ æƒSoftmaxè¿­ä»£å®é™…ä¸Šä¸åˆç†ã€‚ç”±äºæ²¡æœ‰æ›´è´´è¿‘æœ¬è´¨çš„åŸç†æŒ‡å¯¼ï¼Œè¿™äº›æ–¹æ¡ˆå¾€å¾€ä¹Ÿéš¾ä»¥ç†è®ºåˆ†æï¼Œæ¯”å¦‚ç¬”è€…æ„é€ çš„è¿­ä»£ï¼Œè™½ç„¶æµ‹èµ·æ¥æ²¡æœ‰é—®é¢˜ï¼Œä½†æˆ‘ä»¬å¾ˆéš¾è¯æ˜$\boldsymbol{p}_k$åˆ†é‡éƒ½åœ¨$[0,1]$å†…ï¼Œä¹Ÿå¾ˆéš¾åˆ¤æ–­å®ƒæ˜¯å¦æ»¡è¶³å•è°ƒæ€§ã€‚</p>
<p>æ‰€ä»¥ï¼Œæˆ‘ä»¬å¸Œæœ›å¾—åˆ°ä¸€ä¸ªæ›´é«˜è§‚ç‚¹çš„åŸç†å»æŒ‡å¯¼å’Œè®¾è®¡è¿™ä¸ªå…‰æ»‘è¿‘ä¼¼ã€‚å°±åœ¨å‰å‡ å¤©ï¼Œç¬”è€…çªç„¶æ„è¯†åˆ°ä¸€ä¸ªå…³é”®çš„äº‹å®<br />
\begin{equation}\mathcal{T}<em _boldsymbol_x="\boldsymbol{x">k(\boldsymbol{x}) = \nabla</em>}} \sum_{i\in\Omega_k(\boldsymbol{x})} x_i\end{equation<br />
ä¹Ÿå°±æ˜¯è¯´ï¼Œæœ€å¤§çš„$k$ä¸ªåˆ†é‡çš„å’Œï¼Œå®ƒçš„æ¢¯åº¦æ­£å¥½æ˜¯$\mathcal{T}<em i_in_Omega_k_boldsymbol_x="i\in\Omega_k(\boldsymbol{x">k(\boldsymbol{x})$ã€‚æ‰€ä»¥æˆ‘ä»¬ä¼¼ä¹å¯ä»¥æ”¹ä¸ºæ‰¾$\sum\limits</em>})} x_i$çš„å…‰æ»‘è¿‘ä¼¼ï¼Œç„¶åæ±‚æ¢¯åº¦å°±å¾—åˆ°$\mathcal{T<em i_in_Omega_k_boldsymbol_x="i\in\Omega_k(\boldsymbol{x">k(\boldsymbol{x})$çš„å…‰æ»‘è¿‘ä¼¼äº†ï¼Œå‰è€…æ˜¯ä¸€ä¸ªæ ‡é‡ï¼Œå®ƒçš„å…‰æ»‘è¿‘ä¼¼æ‰¾èµ·æ¥æ›´å®¹æ˜“ä¸€äº›ï¼Œæ¯”å¦‚åˆ©ç”¨æ’ç­‰å¼<br />
\begin{equation}\sum</em>})} x_i = \max_{i_1 &lt; \cdots &lt; i_k} (x_{i_1} + \cdots + x_{i_k})\end{equation<br />
å³éå†æ‰€æœ‰$k$ä¸ªåˆ†é‡ä¹‹å’Œå–æœ€å¤§å€¼ï¼Œè¿™æ ·ä¸€æ¥ï¼Œé—®é¢˜å˜æˆäº†æ‰¾$\max$çš„å…‰æ»‘è¿‘ä¼¼ï¼Œè¿™ä¸ªæˆ‘ä»¬æ—©å·²è§£å†³ï¼ˆå‚è€ƒ<a href="/archives/3290">ã€Šå¯»æ±‚ä¸€ä¸ªå…‰æ»‘çš„æœ€å¤§å€¼å‡½æ•°ã€‹</a>ï¼‰ï¼Œç­”æ¡ˆæ˜¯$\text{logsumexp}$ï¼š<br />
\begin{equation}\max_{i_1 &lt; \cdots &lt; i_k} (x_{i_1} + \cdots + x_{i_k})\approx \log\sum_{i_1 &lt; \cdots &lt; i_k} e^{x_{i_1} + \cdots + x_{i_k}}\triangleq \log Z_k\end{equation}<br />
å¯¹å®ƒæ±‚æ¢¯åº¦ï¼Œæˆ‘ä»¬å°±å¾—åˆ°$\mathcal{ST}<em _="&lt;" _cdots="\cdots" i_2="i_2" i_k="i_k">k(\boldsymbol{x})$çš„ä¸€ä¸ªå½¢å¼ï¼š<br />
\begin{equation}[\mathcal{ST}_k(\boldsymbol{x})]_i = \frac{\sum\limits</em>} e^{x_i+x_{i_2} + \cdots + x_{i_k}}}{\sum\limits_{i_1 &lt; \cdots &lt; i_k} e^{x_{i_1} +x_{i_2}+ \cdots + x_{i_k}}}\triangleq \frac{Z_{k,i}}{Z_k}\label{eq:k-max-grad}\end{equation<br />
åˆ†æ¯æ˜¯æ‰€æœ‰$k$åˆ†é‡å’Œçš„æŒ‡æ•°å’Œï¼Œåˆ†å­åˆ™æ˜¯æ‰€æœ‰åŒ…å«$x_i$çš„$k$åˆ†é‡å’Œçš„æŒ‡æ•°å’Œã€‚æ ¹æ®è¿™ä¸ªå½¢å¼ï¼Œæˆ‘ä»¬å¯ä»¥è½»æ¾è¯æ˜<br />
\begin{equation}0 &lt; [\mathcal{ST}<em i="1">k(\boldsymbol{x})]_i &lt; 1,\quad \sum</em>}^n [\mathcal{ST}_k(\boldsymbol{x})]_i = k\end{equation<br />
æ‰€ä»¥è¿™æ ·å®šä¹‰çš„$\mathcal{ST}_k(\boldsymbol{x})$ç¡®å®æ˜¯å±äº$\Delta_k^{n-1}$çš„ã€‚äº‹å®ä¸Šï¼Œæˆ‘ä»¬è¿˜å¯ä»¥è¯æ˜å®ƒåŒæ—¶æ»¡è¶³å•è°ƒæ€§ã€ä¸å˜æ€§å’Œè¶‹è¿‘æ€§ï¼Œå¹¶ä¸”$\mathcal{ST}_1(\boldsymbol{x})$å®ƒå°±æ˜¯Softmaxï¼Œè¿™äº›ç‰¹æ€§æ˜¾ç¤ºå®ƒç¡®å®æ˜¯Softmaxå¯¹äºTop-$k$ç®—å­çš„è‡ªç„¶æ¨å¹¿ï¼Œæˆ‘ä»¬æš‚ä¸”ç§°ä¹‹ä¸ºâ€œ<strong>GradTopK</strong> ï¼ˆGradient-guided Soft Top-k operatorï¼‰â€ã€‚</p>
<p>ä¸è¿‡è¿˜æ²¡åˆ°åº†ç¥æ—¶åˆ»ï¼Œå› ä¸ºå¼$\eqref{eq:k-max-grad}$çš„æ•°å€¼è®¡ç®—é—®é¢˜è¿˜æ²¡è§£å†³ã€‚å¦‚æœç›´æ¥æŒ‰ç…§å¼$\eqref{eq:k-max-grad}$æ¥è®¡ç®—çš„è¯ï¼Œåˆ†æ¯å°±æ¶‰åŠåˆ°$C_n^k$é¡¹æŒ‡æ•°æ±‚å’Œï¼Œè®¡ç®—é‡éå¸¸å¯è§‚ï¼Œæ‰€ä»¥å¿…é¡»æ‰¾åˆ°ä¸€ä¸ªé«˜æ•ˆçš„è®¡ç®—æ–¹æ³•ã€‚æˆ‘ä»¬å·²ç»åˆ†åˆ«è®°äº†åˆ†å­ã€åˆ†æ¯ä¸º$Z_{k,i},Z_k$ï¼Œå¯ä»¥è§‚å¯Ÿåˆ°åˆ†å­$Z_{k,i}$æ»¡è¶³é€’å½’å¼<br />
\begin{equation}Z_{k,i} = e^{x_i}(Z_{k-1} - Z_{k-1,i})\end{equation}<br />
ç»“åˆ$Z_{k,i}$å¯¹$i$æ±‚å’Œç­‰äº$kZ_k$çš„äº‹å®ï¼Œæˆ‘ä»¬å¯ä»¥æ„å»ºä¸€ä¸ªé€’å½’è®¡ç®—è¿‡ç¨‹ï¼š<br />
\begin{equation}\begin{aligned}<br />
\log Z_{k,i} =&amp;\, x_i + \log(e^{\log Z_{k-1}} - e^{\log Z_{k-1,i}}) \\\<br />
\log Z_k =&amp;\, \left(\log\sum_{i=1}^n e^{\log Z_{k,i}}\right) - \log k \\\<br />
\end{aligned}\end{equation}<br />
å…¶ä¸­$\log Z_{1,i} = x_i$ï¼Œä¸ºäº†å‡å°‘æº¢å‡ºé£é™©ï¼Œæˆ‘ä»¬å¯¹ä¸¤ç«¯éƒ½å–äº†å¯¹æ•°ã€‚ç°åœ¨åªéœ€è¦è¿­ä»£$k$æ­¥å°±å¯ä»¥å®Œæˆ$\mathcal{ST}<em k-1="k-1">k(\boldsymbol{x})$çš„è®¡ç®—ï¼Œæ•ˆç‡ä¸Šæ˜¯å¯ä»¥æ¥å—çš„ã€‚ç„¶è€Œï¼Œå³ä¾¿åšäº†å¯¹æ•°åŒ–å¤„ç†ï¼Œä¸Šè¿°é€’å½’ä¹Ÿåªèƒ½å¯¹å°æ–¹å·®çš„$\boldsymbol{x}$æˆ–è€…æ¯”è¾ƒå°çš„$k$ç®—ä¸€ä¸‹ï¼Œåä¹‹$\log Z</em>$å°±ä¼šç›¸å½“æ¥è¿‘ï¼Œå½“æ•°å€¼ä¸Šæ— æ³•åŒºåˆ†æ—¶å°±ä¼šå‡ºç°$\log 0$çš„Bugï¼Œä¸ªäººè®¤ä¸ºè¿™æ˜¯è¿™ç§é€’å½’è½¬åŒ–çš„æ ¹æœ¬å›°éš¾ã€‚}$ä¸æœ€å¤§çš„$\log Z_{k-1,i</p>
<p>ä¸€ä¸ªéå¸¸ç®€é™‹çš„å‚è€ƒå®ç°ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="k">def</span><span class="w"> </span><span class="nf">GradTopK</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">logZs</span> <span class="o">=</span> <span class="n">x</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">x</span> <span class="o">+</span> <span class="n">logZ</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="kp">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="kp">exp</span><span class="p">(</span><span class="n">logZs</span> <span class="o">-</span> <span class="n">logZ</span><span class="p">))</span>
        <span class="n">logZ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logaddexp</span><span class="o">.</span><span class="kp">reduce</span><span class="p">(</span><span class="n">logZs</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="kp">log</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="kp">exp</span><span class="p">(</span><span class="n">logZs</span> <span class="o">-</span> <span class="n">logZ</span><span class="p">)</span>

<span class="n">k</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="n">GradTopK</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
</code></pre></div>

<h2 id="_4">å¾…å®šå¸¸æ•°</h2>
<p>ä¸Šä¸€èŠ‚é€šè¿‡æ¢¯åº¦æ¥æ„å»ºTop-$k$å…‰æ»‘è¿‘ä¼¼çš„æ€è·¯ï¼Œç¡®å®èƒ½ç»™äººä¸€ç§é«˜å±‹å»ºç“´çš„ç¾æ„Ÿï¼Œä½†å¯èƒ½ä¹Ÿä¼šæœ‰è¯»è€…è§‰å¾—å®ƒè¿‡äºæŠ½è±¡ï¼Œç¼ºä¹ä¸€ç§ç”±è¡¨åŠé‡Œçš„ç›´è§‚æ„Ÿï¼ŒåŒæ—¶å¯¹äºå¤§æ–¹å·®çš„$\boldsymbol{x}$æˆ–è€…æ¯”è¾ƒå¤§çš„$k$çš„æ•°å€¼ä¸ç¨³å®šæ€§ï¼Œä¹Ÿè®©æˆ‘ä»¬éš¾ä»¥å®Œå…¨æ»¡æ„ç°æœ‰ç»“æœã€‚æ‰€ä»¥ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°†æ¢ç©¶ä¸€ç§è‡ªä¸‹è€Œä¸Šçš„æ„å»ºæ€è·¯ã€‚</p>
<h3 id="_5">æ–¹æ³•å¤§æ„</h3>
<p>è¯¥æ€è·¯æ¥æºäºStack Exchangeä¸Šçš„å¦ä¸€ä¸ªå¸–å­<a href="https://math.stackexchange.com/a/4506773">ã€ŠDifferentiable top-k functionã€‹</a>çš„å›å¤ã€‚è®¾$f(x)$æ˜¯ä»»æ„$\mathbb{R}\mapsto [0,1]$çš„ã€å…‰æ»‘çš„ã€å•è°ƒé€’å¢çš„å‡½æ•°ï¼Œå¹¶ä¸”æ»¡è¶³$\lim\limits_{x\to\infty}f(x) = 1,\lim\limits_{x\to-\infty}f(x) = 0$ã€‚çœ‹ä¸Šå»æ¡ä»¶å¾ˆå¤šï¼Œä½†å®é™…ä¸Šè¿™ç§å‡½æ•°æ„é€ èµ·æ¥æ²¡æœ‰ä»€ä¹ˆéš¾åº¦ï¼Œæ¯”å¦‚ç»å…¸çš„Sigmoidå‡½æ•°$\sigma(x)=1/(1+e^{-x})$ï¼Œè¿˜æœ‰$\text{clip}(x,0,1)$ã€$\min(1, e^x)$ç­‰ã€‚æ¥ç€æˆ‘ä»¬è€ƒè™‘<br />
\begin{equation}f(\boldsymbol{x}) = [f(x_1),f(x_2),\cdots,f(x_n)]\end{equation}<br />
$f(\boldsymbol{x})$è·Ÿæˆ‘ä»¬æƒ³è¦çš„$\mathcal{ST}<em i="1">k(\boldsymbol{x})$å·®å¤šè¿œå‘¢ï¼Ÿæ¯ä¸ªåˆ†é‡éƒ½åœ¨$[0,1]$å†…è‚¯å®šæ˜¯æ»¡è¶³äº†ï¼Œä½†æ˜¯åˆ†é‡ä¹‹å’Œç­‰äº$k$æ— æ³•ä¿è¯ï¼Œæ‰€ä»¥æˆ‘ä»¬å¼•å…¥ä¸€ä¸ªè·Ÿ$\boldsymbol{x}$ç›¸å…³çš„å¾…å®šå¸¸æ•°$\lambda(x)$æ¥ä¿è¯è¿™ä¸€ç‚¹ï¼š<br />
\begin{equation}\mathcal{ST}_k(\boldsymbol{x}) \triangleq f(\boldsymbol{x} - \lambda(\boldsymbol{x})),\quad \sum</em>}^n f(x_i - \lambda(\boldsymbol{x})) = k\end{equation<br />
ä¹Ÿå°±æ˜¯é€šè¿‡åˆ†é‡ä¹‹å’Œä¸º$k$æ¥åè§£å‡º$\lambda(\boldsymbol{x})$ï¼Œæˆ‘ä»¬å¯ä»¥ç§°ä¹‹ä¸ºâ€œ<strong>ThreTopK</strong> ï¼ˆThreshold-adjusted Soft Top-k operatorï¼‰â€ï¼Œå¦‚æœè¯»è€…å·²ç»é˜…è¯»è¿‡<a href="/archives/10145">ã€Šé€šå‘æ¦‚ç‡åˆ†å¸ƒä¹‹è·¯ï¼šç›˜ç‚¹SoftmaxåŠå…¶æ›¿ä»£å“ã€‹</a>ï¼Œå°±ä¼šå‘ç°è¿™ä¸ªåšæ³•è·ŸSparsemaxã€Entmax-$\alpha$æ˜¯ä¸€æ ·çš„ã€‚</p>
<p>ThreTopKä¼šæ˜¯æˆ‘ä»¬ç†æƒ³çš„$\mathcal{ST}_k(\boldsymbol{x})$å—ï¼Ÿè¿˜çœŸæ˜¯ï¼é¦–å…ˆæˆ‘ä»¬å‡è®¾äº†$f$çš„å•è°ƒæ€§ï¼Œæ‰€ä»¥å•è°ƒæ€§æ˜¯æ»¡è¶³çš„ï¼Œå…¶æ¬¡$f(\boldsymbol{x} - \lambda(\boldsymbol{x}))=f(\boldsymbol{x}+c - (c+\lambda(\boldsymbol{x})))$ï¼Œä¹Ÿå°±æ˜¯å¸¸æ•°å¯ä»¥æ”¶çº³åˆ°$\lambda(\boldsymbol{x})$é‡Œè¾¹ï¼Œæ‰€ä»¥ä¸å˜æ€§ä¹Ÿæ˜¯æ»¡è¶³çš„ã€‚æœ€åï¼Œå½“$\tau\to 0^+$æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥æ‰¾åˆ°ä¸€ä¸ªé€‚å½“çš„é˜ˆå€¼$\lambda(\boldsymbol{x}/\tau)$ï¼Œä½¿å¾—$\boldsymbol{x}/\tau-\lambda(\boldsymbol{x}/\tau)$æœ€å¤§çš„$k$ä¸ªåˆ†é‡è¶‹äº$\infty$ï¼Œå‰©ä¸‹çš„åˆ†é‡è¶‹äº$-\infty$ï¼Œä»è€Œ$f(\boldsymbol{x}/\tau-\lambda(\boldsymbol{x}/\tau))$å°±ç­‰äº$\mathcal{T}_k(\boldsymbol{x})$ï¼Œä¹Ÿå°±æ˜¯è¯´æ»¡è¶³è¶‹è¿‘æ€§ã€‚</p>
<h3 id="_6">è§£ææ±‚è§£</h3>
<p>æ—¢ç„¶å·²ç»è¯æ˜äº†ThreTopKçš„ç†è®ºä¼˜è¶Šæ€§ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥è¦è§£å†³çš„å°±æ˜¯$\lambda(\boldsymbol{x})$çš„è®¡ç®—äº†ï¼Œè¿™ä¸ªå¤§éƒ¨ä»½æƒ…å†µä¸‹éƒ½åªèƒ½è¯‰è¯¸æ•°å€¼è®¡ç®—æ–¹æ³•ï¼Œä¸è¿‡å¯¹äº$f(x)=\min(1, e^x)$ï¼Œæˆ‘ä»¬å¯ä»¥æ±‚å¾—ä¸€ä¸ªè§£æè§£ã€‚</p>
<p>æ±‚è§£çš„æ€è·¯è·Ÿä¹‹å‰çš„Sparsemaxæ˜¯ä¸€æ ·çš„ã€‚ä¸å¤±ä¸€èˆ¬æ€§ï¼Œå‡è®¾$\boldsymbol{x}$çš„åˆ†é‡å·²ç»ä»å¤§åˆ°å°æ’å¥½é¡ºåºï¼Œå³$x_1 &gt; x_2 &gt; \cdots &gt; x_n$ï¼Œæ¥ç€å‡è®¾æˆ‘ä»¬å·²ç»çŸ¥é“$x_m \geq \lambda(\boldsymbol{x}) \geq x_{m+1}$ï¼Œé‚£ä¹ˆæ­¤æ—¶<br />
\begin{equation}k = \sum_{i=1}^n \min(1, e^{x_i - \lambda(\boldsymbol{x})}) = m + \sum_{i=m+1}^n e^{x_i - \lambda(\boldsymbol{x})}\end{equation}<br />
ç”±æ­¤è§£å¾—<br />
\begin{equation}\lambda(\boldsymbol{x})=\log\left(\sum_{i=m+1}^n e^{x_i}\right) - \log(k-m)\end{equation}<br />
ç”±æ­¤æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œå½“$k=1$æ—¶ï¼Œ$m$åªèƒ½å–$0$ï¼Œæ­¤æ—¶å¯ä»¥å‘ç°ThreTopKæ­£å¥½å°±æ˜¯Softmaxï¼›å½“$k &gt; 1$æ—¶ï¼Œæˆ‘ä»¬æ— æ³•äº‹å…ˆç¡®å®š$m$çš„å€¼ï¼Œæ‰€ä»¥åªèƒ½éå†$m=0,1,\cdots,k-1$ï¼Œæ ¹æ®ä¸Šå¼è®¡ç®—$\lambda(\boldsymbol{x})$ï¼Œå¯»æ‰¾æ»¡è¶³$x_m \geq \lambda(\boldsymbol{x}) \geq x_{m+1}$çš„$\lambda(\boldsymbol{x})$ã€‚ä¸‹é¢åŒæ ·æ˜¯ä¸€ä¸ªéå¸¸ç®€é™‹çš„å‚è€ƒå®ç°ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="k">def</span><span class="w"> </span><span class="nf">ThreTopK</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
    <span class="n">x_sort</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">sort</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x_lamb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logaddexp</span><span class="o">.</span><span class="kp">accumulate</span><span class="p">(</span><span class="n">x_sort</span><span class="p">)[</span><span class="o">-</span><span class="n">k</span><span class="p">:]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="kp">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="kp">arange</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">x_sort_shift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">x_sort</span><span class="p">[</span><span class="o">-</span><span class="n">k</span><span class="p">:][</span><span class="mi">1</span><span class="p">:],</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">constant_values</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="kp">inf</span><span class="p">)</span>
    <span class="n">lamb</span> <span class="o">=</span> <span class="n">x_lamb</span><span class="p">[(</span><span class="n">x_lamb</span> <span class="o">&lt;=</span> <span class="n">x_sort_shift</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x_lamb</span> <span class="o">&gt;=</span> <span class="n">x_sort</span><span class="p">[</span><span class="o">-</span><span class="n">k</span><span class="p">:])]</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="kp">clip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="kp">exp</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">lamb</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">k</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="n">ThreTopK</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
</code></pre></div>

<h3 id="_7">é€šç”¨ç»“æœ</h3>
<p>ä»åŸç†å’Œä»£ç éƒ½å¯ä»¥çœ‹å‡ºï¼Œ$f(x)=\min(1, e^x)$æ—¶çš„ThreTopKå‡ ä¹ä¸ä¼šå‡ºç°æ•°å€¼ç¨³å®šæ€§é—®é¢˜ï¼Œå¹¶ä¸”$k=1$æ—¶èƒ½é€€åŒ–ä¸ºSoftmaxï¼Œè¿™äº›éƒ½æ˜¯å®ƒçš„ä¼˜åŠ¿ã€‚ç„¶è€Œï¼Œ$\min(1, e^x)$å®é™…ä¸Šä¹Ÿç®—ä¸ä¸Šå®Œå…¨å…‰æ»‘ï¼ˆé™¤äº†å½“$k=1$æ—¶$\min$ä¸èµ·ä½œç”¨ï¼‰ï¼Œå®ƒåœ¨$x=0$å¤„æ˜¯ä¸å¯å¯¼çš„ã€‚å¦‚æœä»‹æ„è¿™ä¸€ç‚¹ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦é€‰æ‹©å¤„å¤„å¯å¯¼çš„$f(x)$ï¼Œæ¯”å¦‚$\sigma(x)$ã€‚</p>
<p>ä¸‹é¢æˆ‘ä»¬ä»¥$f(x)=\sigma(x)$ä¸ºä¾‹ï¼Œæ­¤æ—¶æˆ‘ä»¬æ— æ³•æ±‚å‡º$\lambda(\boldsymbol{x})$çš„è§£æè§£ï¼Œä¸è¿‡ç”±äº$\sigma(x)$çš„å•è°ƒé€’å¢æ€§ï¼Œæ‰€ä»¥å‡½æ•°<br />
\begin{equation}F(\lambda)\triangleq \sum_{i=1}^n \sigma(x_i - \lambda)\end{equation}<br />
å…³äº$\lambda$æ˜¯å•è°ƒé€’å‡çš„ï¼Œå› æ­¤$F(\lambda(\boldsymbol{x}))=k$çš„æ•°å€¼æ±‚è§£å¹¶ä¸å›°éš¾ï¼ŒäºŒåˆ†æ³•ã€ç‰›é¡¿æ³•å‡å¯ã€‚ä»¥äºŒåˆ†æ³•ä¸ºä¾‹ï¼Œä¸éš¾çœ‹å‡º$\lambda(\boldsymbol{x})\in[x_{\min} - \sigma^{-1}(k/n), x_{\max} - \sigma^{-1}(k/n)]$ï¼Œè¿™é‡Œ$\sigma^{-1}$æ˜¯$\sigma$çš„é€†å‡½æ•°ï¼Œä»è¿™ä¸ªåˆå§‹åŒºé—´å‡ºå‘ï¼Œé€æ­¥äºŒåˆ†åˆ°æŒ‡å®šç²¾åº¦å³å¯ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="k">def</span><span class="w"> </span><span class="nf">sigmoid</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">exp</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="kp">abs</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="kp">where</span><span class="p">(</span><span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">y</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">sigmoid_inv</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="kp">log</span><span class="p">(</span><span class="n">x</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">x</span><span class="p">))</span>

<span class="k">def</span><span class="w"> </span><span class="nf">ThreTopK</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">):</span>
    <span class="n">low</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="kp">min</span><span class="p">()</span> <span class="o">-</span> <span class="n">sigmoid_inv</span><span class="p">(</span><span class="n">k</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="n">high</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="kp">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">sigmoid_inv</span><span class="p">(</span><span class="n">k</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="k">while</span> <span class="n">high</span> <span class="o">-</span> <span class="n">low</span> <span class="o">&gt;</span> <span class="n">epsilon</span><span class="p">:</span>
        <span class="n">lamb</span> <span class="o">=</span> <span class="p">(</span><span class="n">low</span> <span class="o">+</span> <span class="n">high</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">Z</span> <span class="o">=</span> <span class="n">sigmoid</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">lamb</span><span class="p">)</span><span class="o">.</span><span class="kp">sum</span><span class="p">()</span>
        <span class="n">low</span><span class="p">,</span> <span class="n">high</span> <span class="o">=</span> <span class="p">(</span><span class="n">low</span><span class="p">,</span> <span class="n">lamb</span><span class="p">)</span> <span class="k">if</span> <span class="n">Z</span> <span class="o">&lt;</span> <span class="n">k</span> <span class="k">else</span> <span class="p">(</span><span class="n">lamb</span><span class="p">,</span> <span class="n">high</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sigmoid</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">lamb</span><span class="p">)</span>

<span class="n">k</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="n">ThreTopK</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
</code></pre></div>

<p>å› æ­¤ï¼Œ$\lambda(\boldsymbol{x})$çš„æ•°å€¼è®¡ç®—å¹¶æ²¡æœ‰å¤ªå¤§å›°éš¾ï¼ŒçœŸæ­£çš„å›°éš¾æ˜¯å½“æˆ‘ä»¬ç”¨æ•°å€¼æ–¹æ³•å»è®¡ç®—$\lambda(\boldsymbol{x})$æ—¶ï¼Œå¾€å¾€ä¼šä¸¢å¤±$\lambda(\boldsymbol{x})$å…³äº$\boldsymbol{x}$çš„æ¢¯åº¦ï¼Œä»è€Œå½±å“ç«¯åˆ°ç«¯çš„è®­ç»ƒã€‚é’ˆå¯¹è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥æ‰‹åŠ¨æŠŠ$\nabla_{\boldsymbol{x}}\lambda(\boldsymbol{x})$ç®—å‡ºæ¥ï¼Œç„¶åè‡ªå®šä¹‰åå‘ä¼ æ’­è¿‡ç¨‹ã€‚å…·ä½“æ¥è¯´ï¼Œæˆ‘ä»¬å¯¹<br />
\begin{equation}\sum_{i=1}^n \sigma(x_i - \lambda(\boldsymbol{x})) = k\end{equation}<br />
ä¸¤è¾¹æ±‚æŸä¸ª$x_j$çš„åå¯¼æ•°ï¼Œå¾—åˆ°<br />
\begin{equation}\sigma'(x_j - \lambda(\boldsymbol{x}))-\sum_{i=1}^n \sigma'(x_i - \lambda(\boldsymbol{x}))\frac{\partial\lambda(\boldsymbol{x})}{\partial x_j} = 0\end{equation}<br />
é‚£ä¹ˆ<br />
\begin{equation}\frac{\partial\lambda(\boldsymbol{x})}{\partial x_j} = \frac{\sigma'(x_j - \lambda(\boldsymbol{x}))}{\sum\limits_{i=1}^n \sigma'(x_i - \lambda(\boldsymbol{x}))}\end{equation}<br />
å…¶ä¸­$\sigma'$æ˜¯$\sigma$çš„å¯¼å‡½æ•°ã€‚ç°åœ¨æˆ‘ä»¬æœ‰äº†$\nabla_{\boldsymbol{x}}\lambda(\boldsymbol{x})$çš„è¡¨è¾¾å¼ï¼Œå®ƒçš„æ¯ä¸€é¡¹éƒ½æ˜¯å¯è®¡ç®—çš„ï¼ˆ$\lambda(\boldsymbol{x})$ä¹Ÿå·²ç»ç”±æ•°å€¼æ–¹æ³•æ±‚å‡ºï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥æŒ‡å®šå®ƒä½œä¸ºåå‘ä¼ æ’­çš„ç»“æœã€‚ä¸€ä¸ªæ¯”è¾ƒç®€å•ä¸”é€šç”¨çš„å®ç°æ–¹æ³•æ˜¯åˆ©ç”¨$\text{stop_gradient}$ï¼ˆä¸‹é¢ç®€ç§°$\text{sg}$ï¼‰æŠ€å·§ï¼Œå³åœ¨å®ç°æ¨¡å‹æ—¶å°†$\lambda(\boldsymbol{x})$æ›¿æ¢ä¸º<br />
\begin{equation}\boldsymbol{x}\cdot\text{sg}[\nabla_{\boldsymbol{x}}\lambda(\boldsymbol{x})] + \text{sg}[\lambda(\boldsymbol{x}) - \boldsymbol{x}\cdot\nabla_{\boldsymbol{x}}\lambda(\boldsymbol{x})]\end{equation}<br />
å…¶ä¸­$\cdot$æ˜¯å‘é‡çš„å†…ç§¯ã€‚è¿™æ ·ä¸€æ¥ï¼Œå‰å‘ä¼ æ’­æ—¶ç­‰ä»·äº$\text{sg}$ä¸å­˜åœ¨ï¼Œæ‰€ä»¥ç»“æœæ˜¯$\lambda(\boldsymbol{x})$ï¼Œåå‘ä¼ æ’­æ—¶è¢«$\text{sg}$çš„éƒ¨ä»½æ¢¯åº¦éƒ½æ˜¯é›¶ï¼Œæ‰€ä»¥æ¢¯åº¦å°±æ˜¯ç»™å®šçš„$\nabla_{\boldsymbol{x}}\lambda(\boldsymbol{x})$ï¼Œè¿™æ ·æˆ‘ä»¬å°±è‡ªå®šä¹‰äº†$\lambda(\boldsymbol{x})$çš„æ¢¯åº¦ï¼Œè·Ÿ$\lambda(\boldsymbol{x})$å¦‚ä½•è®¡ç®—å¾—åˆ°çš„æ— å…³ã€‚</p>
<h3 id="_8">äºŒè€…å…¼ä¹‹</h3>
<p>ç°åœ¨æˆ‘ä»¬çœ‹åˆ°ï¼Œ$f(x)=\min(1,e^x)$æœ‰è§£æè§£ï¼Œä½†å®ƒå¹¶éå…¨å±€å…‰æ»‘ï¼›$f(x)=\sigma(x)$å€’æ˜¯è¶³å¤Ÿå…‰æ»‘äº†ï¼Œä½†å®ƒæ±‚è§£èµ·æ¥æ¯”è¾ƒå¤æ‚ã€‚æœ‰æ²¡æœ‰å…¼é¡¾ä¸¤è€…ä¼˜ç‚¹çš„é€‰æ‹©å‘¢ï¼Ÿè¿˜çœŸæœ‰ï¼Œç¬”è€…å‘ç°ä¸‹è¿°çš„$f(x)$æ˜¯å…¨å±€å…‰æ»‘å¹¶ä¸”$\lambda(\boldsymbol{x})$å¯ä»¥è§£ææ±‚è§£çš„ï¼š<br />
\begin{equation}f(x) = \left\{\begin{aligned}1 - e^{-x}/2,\quad x\geq 0 \\\ e^x / 2,\quad x &lt; 0\end{aligned}\right.\end{equation}<br />
ä¹Ÿå¯ä»¥å†™æˆ$f(x) = (1 - e^{-|x|})\text{sign}(x)/2+1/2$ã€‚å¯ä»¥éªŒè¯$f(x)$å…¶å®ä¹Ÿæ˜¯ä¸€ä¸ªSå‹å‡½æ•°ï¼Œè™½ç„¶å®ƒæ˜¯åˆ†æ®µå‡½æ•°ï¼Œä½†å®ƒæœ¬èº«åŠå…¶å¯¼å‡½æ•°åœ¨$x=0$å¤„éƒ½æ˜¯è¿ç»­çš„ï¼Œå› æ­¤è¶³å¤Ÿå…‰æ»‘äº†ã€‚</p>
<p>æ±‚è§£æ€è·¯è·Ÿä¹‹å‰ä¸€æ ·ï¼Œä¸å¤±ä¸€èˆ¬æ€§è®¾$x_1 &gt; x_2 &gt; \cdots &gt; x_n$ï¼Œå‡è®¾å·²ç»çŸ¥é“$x_m \geq \lambda(\boldsymbol{x}) \geq x_{m+1}$ï¼Œé‚£ä¹ˆ<br />
\begin{equation}\begin{aligned}<br />
k =&amp;\, \sum_{i=1}^m (1 - e^{-(x_i - \lambda(\boldsymbol{x}))}/2) + \sum_{i=m+1}^n e^{x_i - \lambda(\boldsymbol{x})}/2 \\\<br />
=&amp;\, m - \frac{1}{2}e^{\lambda(\boldsymbol{x})}\sum_{i=1}^m e^{-x_i} + \frac{1}{2}e^{-\lambda(\boldsymbol{x})}\sum_{i=m+1}^n e^{x_i}<br />
\end{aligned}\end{equation}<br />
ç”±æ­¤è§£å¾—<br />
\begin{equation}\lambda(\boldsymbol{x})=\log\sum_{i=m+1}^n e^{x_i} - \log\left(\sqrt{(k-m)^2 + \left(\sum_{i=1}^m e^{-x_i}\right)\left(\sum_{i=m+1}^n e^{x_i}\right)}+(k-m)\right)\end{equation}<br />
ç„¶åéå†$m=0,1,\cdots,n-1$ï¼Œå¯»æ‰¾æ»¡è¶³$x_m \geq \lambda(\boldsymbol{x}) \geq x_{m+1}$çš„$\lambda(\boldsymbol{x})$å³å¯ã€‚è¯»è€…è¿˜å¯ä»¥å°è¯•è¯æ˜ä¸€ä¸‹ï¼Œå½“$k=1$æ—¶æ­¤$f(x)$ä¸‹çš„ThreTopKä¹Ÿæ­£å¥½é€€åŒ–ä¸ºSoftmaxã€‚</p>
<p>å‚è€ƒå®ç°ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="k">def</span><span class="w"> </span><span class="nf">ThreTopK</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
    <span class="n">x_sort</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">sort</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">lse1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logaddexp</span><span class="o">.</span><span class="kp">accumulate</span><span class="p">(</span><span class="n">x_sort</span><span class="p">)</span>
    <span class="n">lse2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logaddexp</span><span class="o">.</span><span class="kp">accumulate</span><span class="p">(</span><span class="o">-</span><span class="n">x_sort</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">constant_values</span><span class="o">=-</span><span class="n">np</span><span class="o">.</span><span class="kp">inf</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">x_lamb</span> <span class="o">=</span> <span class="n">lse1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="kp">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="kp">sqrt</span><span class="p">((</span><span class="n">k</span> <span class="o">-</span> <span class="n">m</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="kp">exp</span><span class="p">(</span><span class="n">lse1</span> <span class="o">+</span> <span class="n">lse2</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="n">k</span> <span class="o">-</span> <span class="n">m</span><span class="p">))</span>
    <span class="n">x_sort_shift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">x_sort</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">constant_values</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="kp">inf</span><span class="p">)</span>
    <span class="n">lamb</span> <span class="o">=</span> <span class="n">x_lamb</span><span class="p">[(</span><span class="n">x_lamb</span> <span class="o">&lt;=</span> <span class="n">x_sort_shift</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x_lamb</span> <span class="o">&gt;=</span> <span class="n">x_sort</span><span class="p">)]</span>
    <span class="k">return</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="kp">exp</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="kp">abs</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">lamb</span><span class="p">)))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="kp">sign</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">lamb</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">+</span> <span class="mf">0.5</span>

<span class="n">k</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="n">ThreTopK</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
</code></pre></div>

<h2 id="_9">æ–‡ç« å°ç»“</h2>
<p>æœ¬æ–‡æ¢è®¨äº†Top-kç®—å­çš„å…‰æ»‘è¿‘ä¼¼é—®é¢˜ï¼Œå®ƒæ˜¯Softmaxç­‰Top1çš„å…‰æ»‘è¿‘ä¼¼çš„ä¸€èˆ¬æ¨å¹¿ï¼Œæå‡ºäº†è¿­ä»£æ„é€ ã€æ¢¯åº¦æŒ‡å¼•ã€å¾…å®šå¸¸æ•°ä¸‰ç§æ„é€ æ€è·¯ï¼Œå¹¶åˆ†æäº†å®ƒä»¬çš„ä¼˜ç¼ºç‚¹ã€‚</p>
<p><em><strong>è½¬è½½åˆ°è¯·åŒ…æ‹¬æœ¬æ–‡åœ°å€ï¼š</strong><a href="https://spaces.ac.cn/archives/10373">https://spaces.ac.cn/archives/10373</a></em></p>
<p><em><strong>æ›´è¯¦ç»†çš„è½¬è½½äº‹å®œè¯·å‚è€ƒï¼š</strong></em><a href="https://spaces.ac.cn/archives/6508#%E6%96%87%E7%AB%A0%E5%A6%82%E4%BD%95%E8%BD%AC%E8%BD%BD/%E5%BC%95%E7%94%A8" title="ã€Šç§‘å­¦ç©ºé—´FAQã€‹">ã€Šç§‘å­¦ç©ºé—´FAQã€‹</a></p>
<p><strong>å¦‚æœæ‚¨è¿˜æœ‰ä»€ä¹ˆç–‘æƒ‘æˆ–å»ºè®®ï¼Œæ¬¢è¿åœ¨ä¸‹æ–¹è¯„è®ºåŒºç»§ç»­è®¨è®ºã€‚</strong></p>
<p><strong>å¦‚æœæ‚¨è§‰å¾—æœ¬æ–‡è¿˜ä¸é”™ï¼Œæ¬¢è¿åˆ†äº«/æ‰“èµæœ¬æ–‡ã€‚æ‰“èµå¹¶éè¦ä»ä¸­è·å¾—æ”¶ç›Šï¼Œè€Œæ˜¯å¸Œæœ›çŸ¥é“ç§‘å­¦ç©ºé—´è·å¾—äº†å¤šå°‘è¯»è€…çš„çœŸå¿ƒå…³æ³¨ã€‚å½“ç„¶ï¼Œå¦‚æœä½ æ— è§†å®ƒï¼Œä¹Ÿä¸ä¼šå½±å“ä½ çš„é˜…è¯»ã€‚å†æ¬¡è¡¨ç¤ºæ¬¢è¿å’Œæ„Ÿè°¢ï¼</strong></p>
<p>æ‰“èµ</p>
<p><img alt="ç§‘å­¦ç©ºé—´" src="https://spaces.ac.cn/usr/themes/geekg/payment/wx.png" /></p>
<p>å¾®ä¿¡æ‰“èµ</p>
<p><img alt="ç§‘å­¦ç©ºé—´" src="https://spaces.ac.cn/usr/themes/geekg/payment/zfb.png" /></p>
<p>æ”¯ä»˜å®æ‰“èµ</p>
<p>å› ä¸ºç½‘ç«™åå°å¯¹æ‰“èµå¹¶æ— è®°å½•ï¼Œå› æ­¤æ¬¢è¿åœ¨æ‰“èµæ—¶å€™å¤‡æ³¨ç•™è¨€ã€‚ä½ è¿˜å¯ä»¥<a href="http://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&amp;email=tN7d1drY3drrx8H0xcWa19vZ"><strong>ç‚¹å‡»è¿™é‡Œ</strong></a>æˆ–åœ¨ä¸‹æ–¹è¯„è®ºåŒºç•™è¨€æ¥å‘ŠçŸ¥ä½ çš„å»ºè®®æˆ–éœ€æ±‚ã€‚</p>
<p><strong>å¦‚æœæ‚¨éœ€è¦å¼•ç”¨æœ¬æ–‡ï¼Œè¯·å‚è€ƒï¼š</strong></p>
<p>è‹å‰‘æ—. (Sep. 19, 2024). ã€ŠSoftmaxåä¼ ï¼šå¯»æ‰¾Top-Kçš„å…‰æ»‘è¿‘ä¼¼ ã€‹[Blog post]. Retrieved from <a href="https://spaces.ac.cn/archives/10373">https://spaces.ac.cn/archives/10373</a></p>
<p>@online{kexuefm-10373,<br />
title={Softmaxåä¼ ï¼šå¯»æ‰¾Top-Kçš„å…‰æ»‘è¿‘ä¼¼},<br />
author={è‹å‰‘æ—},<br />
year={2024},<br />
month={Sep},<br />
url={\url{https://spaces.ac.cn/archives/10373}},<br />
} </p>
<hr />
<h2 id="_10">å…¬å¼æ¨å¯¼ä¸æ³¨é‡Š</h2>
<p>æœ¬èŠ‚å°†æ·±å…¥æ¨å¯¼Top-Kæ“ä½œçš„å…‰æ»‘è¿‘ä¼¼ç†è®ºï¼ŒåŒ…æ‹¬Top-Kçš„ä¸¥æ ¼æ•°å­¦å®šä¹‰ã€ä¸å¯å¾®æ€§é—®é¢˜çš„å®Œæ•´åˆ†æã€Softmaxå…‰æ»‘è¿‘ä¼¼çš„ç†è®ºåŸºç¡€ã€Î±-entmaxçš„è¯¦ç»†æ¨å¯¼ã€sparsemaxçš„å®Œæ•´è¯æ˜ã€å…‰æ»‘æ€§ä¸ç¨€ç–æ€§çš„æƒè¡¡åˆ†æã€æ¢¯åº¦è®¡ç®—ä¸åå‘ä¼ æ’­ï¼Œä»¥åŠè¿‘ä¼¼è¯¯å·®çš„å®šé‡åˆ†æã€‚</p>
<h3 id="1-top-k">1. Top-Kæ“ä½œçš„æ•°å­¦å®šä¹‰ä¸æ€§è´¨</h3>
<h4 id="11-top-k">1.1 Top-Kç®—å­çš„å½¢å¼åŒ–å®šä¹‰</h4>
<p><strong>æ¨å¯¼1ï¼šTop-Ké€‰æ‹©é›†åˆ</strong></p>
<p>ç»™å®šå‘é‡$\boldsymbol{x} = (x_1, x_2, \ldots, x_n) \in \mathbb{R}^n$ï¼ŒTop-Ké€‰æ‹©é›†åˆå®šä¹‰ä¸ºï¼š</p>
<p>$$
\Omega_k(\boldsymbol{x}) = \{i_1, i_2, \ldots, i_k\} \subset \{1, 2, \ldots, n\}
$$</p>
<p>æ»¡è¶³ï¼š</p>
<p>$$
x_{i_1} \geq x_{i_2} \geq \cdots \geq x_{i_k} > x_j, \quad \forall j \notin \Omega_k(\boldsymbol{x})
$$</p>
<p>å³$\Omega_k(\boldsymbol{x})$åŒ…å«$\boldsymbol{x}$ä¸­æœ€å¤§çš„$k$ä¸ªåˆ†é‡çš„ä¸‹æ ‡ã€‚</p>
<p><strong>æ¨å¯¼2ï¼šTop-KæŒ‡ç¤ºå‘é‡</strong></p>
<p>å®šä¹‰Top-Kç®—å­$\mathcal{T}_k: \mathbb{R}^n \to {0, 1}^n$ï¼š</p>
<p>$$
[\mathcal{T}_k(\boldsymbol{x})]_i = \begin{cases}
1, & i \in \Omega_k(\boldsymbol{x}) \\
0, & i \notin \Omega_k(\boldsymbol{x})
\end{cases}
$$</p>
<p>éªŒè¯æ€§è´¨ï¼š$\sum_{i=1}^{n} [\mathcal{T}_k(\boldsymbol{x})]_i = k$ï¼ˆæ°æœ‰$k$ä¸ª1ï¼‰ã€‚</p>
<p><strong>æ¨å¯¼3ï¼šTop-Kä½œä¸ºæŠ•å½±ç®—å­</strong></p>
<p>Top-Kå¯ä»¥è§†ä¸ºå‘é‡åˆ°Multi-Hoté›†åˆçš„æŠ•å½±ï¼š</p>
<p>$$
\mathcal{T}_k(\boldsymbol{x}) = \mathop{\arg\min}_{\boldsymbol{z} \in \{0,1\}^n, \|\boldsymbol{z}\|_1 = k} \|\boldsymbol{z} - \boldsymbol{x}\|^2
$$</p>
<p>è¿™ä¸ªä¼˜åŒ–é—®é¢˜çš„è§£æ­£æ˜¯ä¿ç•™æœ€å¤§çš„$k$ä¸ªåˆ†é‡ã€‚</p>
<p>è¯æ˜ï¼šç›®æ ‡å‡½æ•°å±•å¼€ä¸º</p>
<p>$$
\|\boldsymbol{z} - \boldsymbol{x}\|^2 = \sum_{i=1}^{n} (z_i - x_i)^2
$$</p>
<p>åœ¨çº¦æŸ$z_i \in {0, 1}$å’Œ$\sum_i z_i = k$ä¸‹ï¼Œè¦æœ€å°åŒ–ä¸Šå¼ï¼Œåº”è¯¥è®©$z_i = 1$å¯¹åº”æœ€å¤§çš„$x_i$ã€‚</p>
<h4 id="12-top-k">1.2 Top-Kçš„ç»„åˆæ€§è´¨</h4>
<p><strong>æ¨å¯¼4ï¼šTop-Kçš„æ’åˆ—ä¸å˜æ€§</strong></p>
<p>å¯¹äºä»»æ„ç½®æ¢$\pi: {1, \ldots, n} \to {1, \ldots, n}$ï¼š</p>
<p>$$
\mathcal{T}_k(\boldsymbol{x}_\pi) = (\mathcal{T}_k(\boldsymbol{x}))_\pi
$$</p>
<p>å…¶ä¸­$\boldsymbol{x}<em _pi_1_="\pi(1)">\pi = (x</em>)$ã€‚}, \ldots, x_{\pi(n)</p>
<p>è¿™è¡¨æ˜Top-Kåªä¾èµ–äºå€¼çš„å¤§å°å…³ç³»ï¼Œä¸ä¾èµ–äºä¸‹æ ‡ã€‚</p>
<p><strong>æ¨å¯¼5ï¼šTop-Kçš„å•è°ƒæ€§</strong></p>
<p>å¦‚æœ$x_i &gt; x_j$ï¼Œé‚£ä¹ˆï¼š</p>
<p>$$
[\mathcal{T}_k(\boldsymbol{x})]_i \geq [\mathcal{T}_k(\boldsymbol{x})]_j
$$</p>
<p>å³è¾ƒå¤§çš„åˆ†é‡æ›´å¯èƒ½è¢«é€‰ä¸­ã€‚</p>
<p><strong>æ¨å¯¼6ï¼šTop-Kçš„å¹³ç§»ä¸å˜æ€§</strong></p>
<p>å¯¹äºä»»æ„å¸¸æ•°$c \in \mathbb{R}$ï¼š</p>
<p>$$
\mathcal{T}_k(\boldsymbol{x} + c \boldsymbol{1}) = \mathcal{T}_k(\boldsymbol{x})
$$</p>
<p>å…¶ä¸­$\boldsymbol{1} = (1, 1, \ldots, 1)$ã€‚Top-Kåªå…³å¿ƒç›¸å¯¹å¤§å°ï¼Œä¸å—æ•´ä½“å¹³ç§»å½±å“ã€‚</p>
<h3 id="2">2. ä¸å¯å¾®æ€§é—®é¢˜çš„æ·±å…¥åˆ†æ</h3>
<h4 id="21-top-k">2.1 Top-Kçš„ä¸è¿ç»­æ€§</h4>
<p><strong>æ¨å¯¼7ï¼šTop-Kçš„è·³å˜ç‚¹</strong></p>
<p>è€ƒè™‘ä¸€ç»´æƒ…å†µï¼Œ$n=2, k=1$ï¼Œ$\boldsymbol{x} = (x_1, x_2)$ï¼š</p>
<p>$$
\mathcal{T}_1(\boldsymbol{x}) = \begin{cases}
(1, 0), & x_1 > x_2 \\
(0, 1), & x_1 < x_2
\end{cases}
$$</p>
<p>åœ¨$x_1 = x_2$å¤„ï¼Œ$\mathcal{T}_1$ä¸è¿ç»­ï¼ˆä»$(1, 0)$è·³å˜åˆ°$(0, 1)$ï¼‰ã€‚</p>
<p><strong>æ¨å¯¼8ï¼šTop-Kçš„æ¢¯åº¦ä¸å­˜åœ¨æ€§</strong></p>
<p>åœ¨è·³å˜ç‚¹ï¼Œåå¯¼æ•°ä¸å­˜åœ¨ã€‚è€ƒè™‘$x_1 = x_2 = t$ï¼š</p>
<p>$$
\lim_{\epsilon \to 0^+} \frac{[\mathcal{T}_1(t+\epsilon, t)]_1 - [\mathcal{T}_1(t, t)]_1}{\epsilon}
$$</p>
<p>è¿™ä¸ªæé™ä¸å­˜åœ¨ï¼Œå› ä¸ºï¼š
- å½“$\epsilon &gt; 0$æ—¶ï¼Œ$[\mathcal{T}_1(t+\epsilon, t)]_1 = 1$
- å½“$\epsilon &lt; 0$æ—¶ï¼Œ$[\mathcal{T}_1(t+\epsilon, t)]_1 = 0$</p>
<p>å·¦å³å¯¼æ•°ä¸ç›¸ç­‰ã€‚</p>
<p><strong>æ¨å¯¼9ï¼šæµ‹åº¦é›¶é›†ä¸Šçš„å¯å¾®æ€§</strong></p>
<p>Top-Kåœ¨$\mathbb{R}^n$çš„å‡ ä¹å¤„å¤„å¯å¾®ï¼ˆé™¤äº†æµ‹åº¦é›¶çš„è¾¹ç•Œé›†ï¼‰ï¼Œä½†åœ¨è¾¹ç•Œå¤„æ¢¯åº¦ä¸ºé›¶ï¼š</p>
<p>$$
\nabla \mathcal{T}_k(\boldsymbol{x}) = \boldsymbol{0}, \quad \text{a.e.}
$$</p>
<p>è¿™å¯¹äºåŸºäºæ¢¯åº¦çš„ä¼˜åŒ–æ¯«æ— å¸®åŠ©ã€‚</p>
<h4 id="22">2.2 åå‘ä¼ æ’­çš„å›°éš¾</h4>
<p><strong>æ¨å¯¼10ï¼šé“¾å¼æ³•åˆ™çš„å¤±æ•ˆ</strong></p>
<p>å‡è®¾æŸå¤±å‡½æ•°$\mathcal{L}(\mathcal{T}_k(\boldsymbol{x}))$ï¼Œé“¾å¼æ³•åˆ™è¦æ±‚ï¼š</p>
<p>$$
\frac{\partial \mathcal{L}}{\partial x_i} = \frac{\partial \mathcal{L}}{\partial \mathcal{T}_k} \cdot \frac{\partial \mathcal{T}_k}{\partial x_i}
$$</p>
<p>ä½†ç”±äº$\frac{\partial \mathcal{T}_k}{\partial x_i} = 0$ï¼ˆå‡ ä¹å¤„å¤„ï¼‰ï¼Œæ¢¯åº¦ä¿¡æ¯æ— æ³•å›ä¼ ã€‚</p>
<p><strong>æ¨å¯¼11ï¼šæ¬¡æ¢¯åº¦çš„å±€é™æ€§</strong></p>
<p>è™½ç„¶å¯ä»¥å®šä¹‰æ¬¡æ¢¯åº¦ï¼ˆsubgradientï¼‰ï¼Œä½†å¯¹äºTop-Kï¼š</p>
<p>$$
\partial \mathcal{T}_k(\boldsymbol{x}) = \text{convex hull of gradients near } \boldsymbol{x}
$$</p>
<p>è¿™ä¸ªé›†åˆé€šå¸¸åŒ…å«é›¶å‘é‡ï¼Œä¸æä¾›æœ‰ç”¨çš„ä¼˜åŒ–æ–¹å‘ã€‚</p>
<h3 id="3-softmax">3. Softmaxå…‰æ»‘è¿‘ä¼¼çš„ç†è®ºåŸºç¡€</h3>
<h4 id="31-softmaxtop-1">3.1 Softmaxä½œä¸ºTop-1çš„è¿‘ä¼¼</h4>
<p><strong>æ¨å¯¼12ï¼šSoftmaxçš„å®šä¹‰</strong></p>
<p>Softmaxå‡½æ•°å®šä¹‰ä¸ºï¼š</p>
<p>$$
[\text{softmax}(\boldsymbol{x})]_i = \frac{e^{x_i}}{\sum_{j=1}^{n} e^{x_j}}
$$</p>
<p>å…³é”®æ€§è´¨ï¼š
- $\sum_{i=1}^{n} [\text{softmax}(\boldsymbol{x})]_i = 1$ï¼ˆå½’ä¸€åŒ–ï¼‰
- $[\text{softmax}(\boldsymbol{x})]_i &gt; 0$ï¼ˆä¸¥æ ¼æ­£ï¼‰
- $x_i &gt; x_j \Rightarrow [\text{softmax}(\boldsymbol{x})]_i &gt; [\text{softmax}(\boldsymbol{x})]_j$ï¼ˆå•è°ƒæ€§ï¼‰</p>
<p><strong>æ¨å¯¼13ï¼šæ¸©åº¦å‚æ•°çš„ä½œç”¨</strong></p>
<p>å¼•å…¥æ¸©åº¦$\tau &gt; 0$ï¼š</p>
<p>$$
[\text{softmax}(\boldsymbol{x}/\tau)]_i = \frac{e^{x_i/\tau}}{\sum_{j=1}^{n} e^{x_j/\tau}}
$$</p>
<p>å½“$\tau \to 0^+$æ—¶çš„æé™è¡Œä¸ºï¼š</p>
<p>è®¾$x_{\max} = \max_i x_i$ï¼Œ$\Omega_1 = {i : x_i = x_{\max}}$ï¼ˆæœ€å¤§å€¼çš„ä¸‹æ ‡é›†åˆï¼Œå¯èƒ½æœ‰å¤šä¸ªï¼‰ã€‚</p>
<p>$$
\lim_{\tau \to 0^+} [\text{softmax}(\boldsymbol{x}/\tau)]_i = \begin{cases}
\frac{1}{|\Omega_1|}, & i \in \Omega_1 \\
0, & i \notin \Omega_1
\end{cases}
$$</p>
<p>è¯æ˜ï¼šå¯¹äº$i \in \Omega_1$ï¼Œ$x_i = x_{\max}$ï¼š</p>
<p>$$
[\text{softmax}(\boldsymbol{x}/\tau)]_i = \frac{e^{x_{\max}/\tau}}{\sum_{j \in \Omega_1} e^{x_{\max}/\tau} + \sum_{j \notin \Omega_1} e^{x_j/\tau}}
$$</p>
<p>å½“$\tau \to 0^+$æ—¶ï¼Œ$e^{(x_j - x_{\max})/\tau} \to 0$å¯¹æ‰€æœ‰$j \notin \Omega_1$ï¼ˆå› ä¸º$x_j &lt; x_{\max}$ï¼‰ï¼Œæ‰€ä»¥ï¼š</p>
<p>$$
[\text{softmax}(\boldsymbol{x}/\tau)]_i \to \frac{e^{x_{\max}/\tau}}{|\Omega_1| e^{x_{\max}/\tau}} = \frac{1}{|\Omega_1|}
$$</p>
<p><strong>æ¨å¯¼14ï¼šSoftmaxä½œä¸ºLogSumExpçš„æ¢¯åº¦</strong></p>
<p>å®šä¹‰LogSumExpï¼ˆLSEï¼‰ï¼š</p>
<p>$$
\text{LSE}(\boldsymbol{x}) = \log \sum_{i=1}^{n} e^{x_i}
$$</p>
<p>è®¡ç®—å…¶æ¢¯åº¦ï¼š</p>
<p>$$
\frac{\partial \text{LSE}(\boldsymbol{x})}{\partial x_i} = \frac{e^{x_i}}{\sum_{j=1}^{n} e^{x_j}} = [\text{softmax}(\boldsymbol{x})]_i
$$</p>
<p>è¿™ä¸ªè”ç³»å¾ˆé‡è¦ï¼šSoftmaxå¯ä»¥è§†ä¸ºæŸä¸ªå‡¸å‡½æ•°çš„æ¢¯åº¦ï¼Œå› æ­¤ç»§æ‰¿äº†è‰¯å¥½çš„ä¼˜åŒ–æ€§è´¨ã€‚</p>
<h4 id="32-softmax">3.2 Softmaxçš„ä¼˜åŒ–æ€§è´¨</h4>
<p><strong>æ¨å¯¼15ï¼šSoftmaxçš„å…‰æ»‘æ€§</strong></p>
<p>Softmaxæ˜¯æ— ç©·æ¬¡å¯å¾®çš„ï¼ˆ$C^\infty$ï¼‰ã€‚å¯¹äºä»»æ„$i, j$ï¼š</p>
<p>$$
\frac{\partial^2 \text{softmax}_i}{\partial x_j \partial x_k} \text{ å­˜åœ¨ä¸”è¿ç»­}
$$</p>
<p>JacobiançŸ©é˜µï¼š</p>
<p>$$
J_{ij} = \frac{\partial \text{softmax}_i(\boldsymbol{x})}{\partial x_j} = \begin{cases}
\text{softmax}_i(1 - \text{softmax}_i), & i = j \\
-\text{softmax}_i \cdot \text{softmax}_j, & i \neq j
\end{cases}
$$</p>
<p>è¿™æ˜¯å¯¹è§’å ä¼˜çŸ©é˜µï¼Œæ•°å€¼ç¨³å®šã€‚</p>
<p><strong>æ¨å¯¼16ï¼šSoftmaxçš„Lipschitzè¿ç»­æ€§</strong></p>
<p>å­˜åœ¨å¸¸æ•°$L$ä½¿å¾—ï¼š</p>
<p>$$
\|\text{softmax}(\boldsymbol{x}_1) - \text{softmax}(\boldsymbol{x}_2)\| \leq L \|\boldsymbol{x}_1 - \boldsymbol{x}_2\|
$$</p>
<p>å…·ä½“åœ°ï¼Œå¯¹äº$\ell_2$èŒƒæ•°ï¼Œ$L = 1$ï¼š</p>
<p>$$
\|\text{softmax}(\boldsymbol{x}_1) - \text{softmax}(\boldsymbol{x}_2)\|_2 \leq \|\boldsymbol{x}_1 - \boldsymbol{x}_2\|_2
$$</p>
<p>è¿™ä¿è¯äº†Softmaxä¸ä¼šæ”¾å¤§è¾“å…¥çš„æ‰°åŠ¨ã€‚</p>
<h3 id="4-top-klogsumexp">4. æ¨å¹¿åˆ°Top-Kï¼šLogSumExpæ–¹æ³•</h3>
<h4 id="41-k-sumlogsumexp">4.1 K-sumçš„LogSumExp</h4>
<p><strong>æ¨å¯¼17ï¼šK-sumçš„å®šä¹‰</strong></p>
<p>å®šä¹‰K-sumä¸ºæœ€å¤§çš„$k$ä¸ªåˆ†é‡ä¹‹å’Œï¼š</p>
<p>$$
S_k(\boldsymbol{x}) = \sum_{i \in \Omega_k(\boldsymbol{x})} x_i
$$</p>
<p>è¿™å¯ä»¥é‡å†™ä¸ºï¼š</p>
<p>$$
S_k(\boldsymbol{x}) = \max_{|I| = k} \sum_{i \in I} x_i
$$</p>
<p>å…¶ä¸­æœ€å¤§åŒ–éå†æ‰€æœ‰å¤§å°ä¸º$k$çš„ä¸‹æ ‡é›†åˆ$I$ã€‚</p>
<p><strong>æ¨å¯¼18ï¼šK-sumçš„å…‰æ»‘è¿‘ä¼¼</strong></p>
<p>ç”¨LogSumExpè¿‘ä¼¼æœ€å¤§å€¼ï¼š</p>
<p>$$
\tilde{S}_k(\boldsymbol{x}) = \log \sum_{|I|=k} \exp\left(\sum_{i \in I} x_i\right)
$$</p>
<p>å®šä¹‰é…åˆ†å‡½æ•°ï¼š</p>
<p>$$
Z_k = \sum_{|I|=k} \exp\left(\sum_{i \in I} x_i\right) = \sum_{i_1 < i_2 < \cdots < i_k} e^{x_{i_1} + x_{i_2} + \cdots + x_{i_k}}
$$</p>
<p>åˆ™$\tilde{S}_k(\boldsymbol{x}) = \log Z_k$ã€‚</p>
<p><strong>æ¨å¯¼19ï¼šæ¢¯åº¦æ¨å¯¼ï¼ˆGradTopKï¼‰</strong></p>
<p>è®¡ç®—$\tilde{S}_k$å…³äº$x_i$çš„æ¢¯åº¦ï¼š</p>
<p>$$
\frac{\partial \tilde{S}_k}{\partial x_i} = \frac{1}{Z_k} \frac{\partial Z_k}{\partial x_i}
$$</p>
<p>æ³¨æ„åˆ°$Z_k$ä¸­åŒ…å«$x_i$çš„é¡¹æ˜¯æ‰€æœ‰åŒ…å«$i$çš„$k$å…ƒå­é›†ï¼š</p>
<p>$$
\frac{\partial Z_k}{\partial x_i} = \sum_{\substack{|I|=k \\ i \in I}} e^{\sum_{j \in I} x_j}
$$</p>
<p>å®šä¹‰ï¼š</p>
<p>$$
Z_{k,i} = \sum_{\substack{|I|=k \\ i \in I}} e^{\sum_{j \in I} x_j}
$$</p>
<p>åˆ™ï¼š</p>
<p>$$
[\text{GradTopK}(\boldsymbol{x})]_i = \frac{Z_{k,i}}{Z_k}
$$</p>
<p><strong>æ¨å¯¼20ï¼šGradTopKçš„æ€§è´¨éªŒè¯</strong></p>
<p>éªŒè¯å½’ä¸€åŒ–ï¼š</p>
<p>$$
\sum_{i=1}^{n} \frac{Z_{k,i}}{Z_k} = \frac{1}{Z_k} \sum_{i=1}^{n} Z_{k,i}
$$</p>
<p>æ³¨æ„åˆ°æ¯ä¸ª$k$å…ƒå­é›†$I$åœ¨$\sum_{i} Z_{k,i}$ä¸­è¢«è®¡æ•°$k$æ¬¡ï¼ˆ$I$çš„æ¯ä¸ªå…ƒç´ è´¡çŒ®ä¸€æ¬¡ï¼‰ï¼Œæ‰€ä»¥ï¼š</p>
<p>$$
\sum_{i=1}^{n} Z_{k,i} = k \cdot Z_k
$$</p>
<p>å› æ­¤ï¼š</p>
<p>$$
\sum_{i=1}^{n} [\text{GradTopK}(\boldsymbol{x})]_i = k
$$</p>
<p>éªŒè¯æé™è¡Œä¸ºï¼šè®¾$\boldsymbol{x}/\tau$ï¼Œå½“$\tau \to 0^+$æ—¶ï¼Œ$Z_k$ç”±æœ€å¤§çš„$k$ä¸ªåˆ†é‡ä¸»å¯¼ï¼š</p>
<p>$$
Z_k \approx \exp\left(\frac{1}{\tau}\sum_{i \in \Omega_k} x_i\right)
$$</p>
<p>ç±»ä¼¼åœ°ï¼Œ$Z_{k,i} \approx \exp\left(\frac{1}{\tau}\sum_{j \in \Omega_k} x_j\right)$å¦‚æœ$i \in \Omega_k$ï¼Œå¦åˆ™æŒ‡æ•°é¡¹æ›´å°ã€‚</p>
<p>å› æ­¤ï¼š</p>
<p>$$
\lim_{\tau \to 0^+} [\text{GradTopK}(\boldsymbol{x}/\tau)]_i = \begin{cases}
1, & i \in \Omega_k(\boldsymbol{x}) \\
0, & i \notin \Omega_k(\boldsymbol{x})
\end{cases}
$$</p>
<p>è¿™æ­£æ˜¯$\mathcal{T}_k(\boldsymbol{x})$ï¼</p>
<h4 id="42">4.2 é€’å½’è®¡ç®—çš„æ•°å€¼ç¨³å®šæ€§</h4>
<p><strong>æ¨å¯¼21ï¼šé€’å½’å…³ç³»</strong></p>
<p>æ³¨æ„åˆ°ï¼š</p>
<p>$$
Z_{k,i} = e^{x_i} \cdot (Z_{k-1} - Z_{k-1,i})
$$</p>
<p>è§£é‡Šï¼šåŒ…å«$i$çš„$k$å…ƒå­é›† = ${i}$ + ä¸åŒ…å«$i$çš„$(k-1)$å…ƒå­é›†ã€‚</p>
<p>ä½†è¿™æœ‰ä¸ªé—®é¢˜ï¼š$Z_{k-1,i}$ä¹Ÿè®¡æ•°äº†åŒ…å«$i$çš„å­é›†ï¼Œéœ€è¦æ’é™¤ã€‚</p>
<p>æ­£ç¡®çš„é€’å½’æ˜¯ï¼š</p>
<p>$$
Z_{k,i} = e^{x_i} \cdot Z_{k-1}^{(-i)}
$$</p>
<p>å…¶ä¸­$Z_{k-1}^{(-i)}$æ˜¯ä»$\boldsymbol{x}<em i-1="i-1">{-i} = (x_1, \ldots, x</em>, \ldots, x_n)$è®¡ç®—çš„é…åˆ†å‡½æ•°ã€‚}, x_{i+1</p>
<p><strong>æ¨å¯¼22ï¼šå¯¹æ•°åŸŸè®¡ç®—</strong></p>
<p>ä¸ºäº†æ•°å€¼ç¨³å®šï¼Œåœ¨å¯¹æ•°åŸŸè®¡ç®—ï¼š</p>
<p>$$
\log Z_k = \text{LSE}\left(\left\{\sum_{i \in I} x_i : |I| = k\right\}\right)
$$</p>
<p>ä½¿ç”¨åŠ¨æ€è§„åˆ’ï¼šå®šä¹‰$\ell_k^{(m)}$ä¸ºä»å‰$m$ä¸ªå…ƒç´ ä¸­é€‰$k$ä¸ªçš„logé…åˆ†å‡½æ•°ã€‚</p>
<p>é€’å½’ï¼š</p>
<p>$$
\ell_k^{(m)} = \text{LSE}(\ell_k^{(m-1)}, x_m + \ell_{k-1}^{(m-1)})
$$</p>
<p>è¾¹ç•Œï¼š$\ell_0^{(m)} = 0$ï¼Œ$\ell_k^{(k)} = \sum_{i=1}^{k} x_i$ã€‚</p>
<p><strong>æ¨å¯¼23ï¼šæ•°å€¼ä¸ç¨³å®šæ€§åˆ†æ</strong></p>
<p>å³ä½¿åœ¨å¯¹æ•°åŸŸï¼Œå½“$k$è¾ƒå¤§æˆ–$\boldsymbol{x}$æ–¹å·®å¤§æ—¶ï¼Œ$\log Z_{k-1}$å’Œ$\max_i \log Z_{k-1,i}$å¯èƒ½éå¸¸æ¥è¿‘ï¼Œå¯¼è‡´ï¼š</p>
<p>$$
\log(e^{\log Z_{k-1}} - e^{\log Z_{k-1,i}}) \approx \log(e^{A} - e^{A-\epsilon})
$$</p>
<p>å½“$\epsilon$å¾ˆå°æ—¶ï¼Œç²¾åº¦æŸå¤±ä¸¥é‡ã€‚è¿™æ˜¯LogSumExpæ–¹æ³•çš„æ ¹æœ¬é™åˆ¶ã€‚</p>
<h3 id="5-thretopk">5. é˜ˆå€¼æ–¹æ³•ï¼šThreTopK</h3>
<h4 id="51">5.1 é€šç”¨é˜ˆå€¼åŒ–æ¡†æ¶</h4>
<p><strong>æ¨å¯¼24ï¼šé˜ˆå€¼åŒ–æ„é€ </strong></p>
<p>å®šä¹‰å…‰æ»‘çš„Så‹å‡½æ•°$f: \mathbb{R} \to [0, 1]$ï¼Œæ»¡è¶³ï¼š
- $\lim_{x \to \infty} f(x) = 1$
- $\lim_{x \to -\infty} f(x) = 0$
- $f$å•è°ƒé€’å¢ä¸”å…‰æ»‘</p>
<p>æ„é€ ï¼š</p>
<p>$$
\mathcal{ST}_k(\boldsymbol{x}) = f(\boldsymbol{x} - \lambda(\boldsymbol{x}))
$$</p>
<p>å…¶ä¸­$\lambda(\boldsymbol{x})$æ»¡è¶³ï¼š</p>
<p>$$
\sum_{i=1}^{n} f(x_i - \lambda(\boldsymbol{x})) = k
$$</p>
<p>è¿™ä¿è¯äº†å½’ä¸€åŒ–ã€‚</p>
<p><strong>æ¨å¯¼25ï¼šé˜ˆå€¼çš„å­˜åœ¨å”¯ä¸€æ€§</strong></p>
<p>å®šä¹‰å‡½æ•°ï¼š</p>
<p>$$
g(\lambda) = \sum_{i=1}^{n} f(x_i - \lambda)
$$</p>
<p>ç”±äº$f$å•è°ƒé€’å¢ï¼Œ$g(\lambda)$å•è°ƒé€’å‡ï¼š</p>
<p>$$
\lambda_1 < \lambda_2 \Rightarrow g(\lambda_1) > g(\lambda_2)
$$</p>
<p>è¾¹ç•Œæ¡ä»¶ï¼š
- $\lim_{\lambda \to -\infty} g(\lambda) = n$
- $\lim_{\lambda \to \infty} g(\lambda) = 0$</p>
<p>ç”±ä¸­é—´å€¼å®šç†ï¼Œå­˜åœ¨å”¯ä¸€çš„$\lambda$ä½¿å¾—$g(\lambda) = k$ï¼ˆå‡è®¾$0 &lt; k &lt; n$ï¼‰ã€‚</p>
<p><strong>æ¨å¯¼26ï¼šThreTopKçš„å•è°ƒæ€§</strong></p>
<p>å¦‚æœ$x_i &gt; x_j$ï¼Œåˆ™ï¼š</p>
<p>$$
[\mathcal{ST}_k(\boldsymbol{x})]_i = f(x_i - \lambda) > f(x_j - \lambda) = [\mathcal{ST}_k(\boldsymbol{x})]_j
$$</p>
<p>å› ä¸º$f$å•è°ƒä¸”$x_i - \lambda &gt; x_j - \lambda$ã€‚</p>
<p><strong>æ¨å¯¼27ï¼šThreTopKçš„æé™è¡Œä¸º</strong></p>
<p>å¯¹äº$\boldsymbol{x}/\tau$ï¼Œå½“$\tau \to 0^+$æ—¶ï¼Œ$\lambda(\boldsymbol{x}/\tau)$çš„è¡Œä¸ºï¼š</p>
<p>å‡è®¾$\boldsymbol{x}$çš„ç¬¬$k$å¤§å’Œç¬¬$(k+1)$å¤§åˆ†åˆ«ä¸º$x_{(k)}$å’Œ$x_{(k+1)}$ï¼Œ$x_{(k)} &gt; x_{(k+1)}$ã€‚</p>
<p>é€‰æ‹©$\lambda \in (x_{(k+1)}, x_{(k)})$ï¼ˆåœ¨$\tau \to 0$çš„å°ºåº¦ä¸‹ï¼‰ï¼Œåˆ™ï¼š
- å¯¹äº$i \in \Omega_k$ï¼š$x_i/\tau - \lambda/\tau \to +\infty$ï¼Œæ‰€ä»¥$f(x_i/\tau - \lambda/\tau) \to 1$
- å¯¹äº$i \notin \Omega_k$ï¼š$x_i/\tau - \lambda/\tau \to -\infty$ï¼Œæ‰€ä»¥$f(x_i/\tau - \lambda/\tau) \to 0$</p>
<p>å› æ­¤$\mathcal{ST}_k(\boldsymbol{x}/\tau) \to \mathcal{T}_k(\boldsymbol{x})$ã€‚</p>
<h4 id="52">5.2 å…·ä½“å®ä¾‹ï¼šæŒ‡æ•°å‹é˜ˆå€¼</h4>
<p><strong>æ¨å¯¼28ï¼š$f(x) = \min(1, e^x)$çš„è§£æè§£</strong></p>
<p>å¯¹äºè¿™ä¸ª$f$ï¼Œçº¦æŸå˜ä¸ºï¼š</p>
<p>$$
\sum_{i=1}^{n} \min(1, e^{x_i - \lambda}) = k
$$</p>
<p>å‡è®¾$\boldsymbol{x}$å·²é™åºæ’åˆ—ï¼š$x_1 \geq x_2 \geq \cdots \geq x_n$ã€‚</p>
<p>çŒœæµ‹$\lambda \in [x_{m+1}, x_m]$ï¼Œåˆ™ï¼š
- å¯¹äº$i \leq m$ï¼š$x_i \geq \lambda$ï¼Œæ‰€ä»¥$\min(1, e^{x_i - \lambda}) = 1$
- å¯¹äº$i &gt; m$ï¼š$x_i &lt; \lambda$ï¼Œæ‰€ä»¥$\min(1, e^{x_i - \lambda}) = e^{x_i - \lambda}$</p>
<p>çº¦æŸå˜ä¸ºï¼š</p>
<p>$$
m + \sum_{i=m+1}^{n} e^{x_i - \lambda} = k
$$</p>
<p>è§£å¾—ï¼š</p>
<p>$$
e^{-\lambda} = \frac{k - m}{\sum_{i=m+1}^{n} e^{x_i}}
$$</p>
<p>å³ï¼š</p>
<p>$$
\lambda = \log\left(\sum_{i=m+1}^{n} e^{x_i}\right) - \log(k - m)
$$</p>
<p>éœ€è¦éªŒè¯$\lambda \in [x_{m+1}, x_m]$ã€‚éå†$m = 0, 1, \ldots, k-1$æ‰¾åˆ°æ»¡è¶³æ¡ä»¶çš„$m$ã€‚</p>
<p><strong>æ¨å¯¼29ï¼šé€€åŒ–åˆ°Softmax</strong></p>
<p>å½“$k=1$æ—¶ï¼Œ$m$åªèƒ½ä¸º0ï¼Œçº¦æŸä¸ºï¼š</p>
<p>$$
\sum_{i=1}^{n} e^{x_i - \lambda} = 1
$$</p>
<p>å³ï¼š</p>
<p>$$
e^{-\lambda} = \frac{1}{\sum_{i=1}^{n} e^{x_i}}
$$</p>
<p>æ‰€ä»¥ï¼š</p>
<p>$$
[\mathcal{ST}_1(\boldsymbol{x})]_i = e^{x_i - \lambda} = \frac{e^{x_i}}{\sum_j e^{x_j}} = [\text{softmax}(\boldsymbol{x})]_i
$$</p>
<p>å®Œç¾é€€åŒ–ï¼</p>
<h4 id="53-sigmoid">5.3 Sigmoidå‹é˜ˆå€¼</h4>
<p><strong>æ¨å¯¼30ï¼š$f(x) = \sigma(x)$çš„æ•°å€¼æ±‚è§£</strong></p>
<p>å¯¹äºSigmoidå‡½æ•°$\sigma(x) = \frac{1}{1 + e^{-x}}$ï¼Œçº¦æŸä¸ºï¼š</p>
<p>$$
\sum_{i=1}^{n} \sigma(x_i - \lambda) = k
$$</p>
<p>å®šä¹‰ç›®æ ‡å‡½æ•°ï¼š</p>
<p>$$
F(\lambda) = \sum_{i=1}^{n} \sigma(x_i - \lambda) - k
$$</p>
<p>æ±‚è§£$F(\lambda) = 0$ã€‚ä½¿ç”¨äºŒåˆ†æ³•æˆ–ç‰›é¡¿æ³•ã€‚</p>
<p><strong>æ¨å¯¼31ï¼šäºŒåˆ†æ³•çš„ç•Œ</strong></p>
<p>ç”±äº$\sigma(x) \in (0, 1)$ï¼Œæˆ‘ä»¬æœ‰ï¼š</p>
<p>$$
0 < F(\lambda) < n
$$</p>
<p>å½“$\lambda \to -\infty$æ—¶ï¼Œ$\sigma(x_i - \lambda) \to 1$ï¼Œ$F(\lambda) \to n - k &gt; 0$ï¼ˆå¦‚æœ$k &lt; n$ï¼‰ã€‚
å½“$\lambda \to +\infty$æ—¶ï¼Œ$\sigma(x_i - \lambda) \to 0$ï¼Œ$F(\lambda) \to -k &lt; 0$ã€‚</p>
<p>æ‰€ä»¥$F$åœ¨æŸä¸ªåŒºé—´$[\lambda_{\min}, \lambda_{\max}]$å†…æœ‰é›¶ç‚¹ã€‚æ›´ç²¾ç¡®çš„ç•Œï¼š</p>
<p>$$
\lambda_{\min} = x_{\min} - \sigma^{-1}(k/n), \quad \lambda_{\max} = x_{\max} - \sigma^{-1}(k/n)
$$</p>
<p>å…¶ä¸­$\sigma^{-1}(p) = \log\frac{p}{1-p}$ï¼ˆlogitå‡½æ•°ï¼‰ã€‚</p>
<p><strong>æ¨å¯¼32ï¼šç‰›é¡¿æ³•è¿­ä»£</strong></p>
<p>ç‰›é¡¿æ³•æ›´æ–°ï¼š</p>
<p>$$
\lambda_{t+1} = \lambda_t - \frac{F(\lambda_t)}{F'(\lambda_t)}
$$</p>
<p>è®¡ç®—$F'(\lambda)$ï¼š</p>
<p>$$
F'(\lambda) = -\sum_{i=1}^{n} \sigma'(x_i - \lambda) = -\sum_{i=1}^{n} \sigma(x_i - \lambda)(1 - \sigma(x_i - \lambda))
$$</p>
<p>æ³¨æ„$F'(\lambda) &lt; 0$ï¼ˆå•è°ƒé€’å‡ï¼‰ï¼Œä¿è¯æ”¶æ•›ã€‚</p>
<h3 id="6">6. æ¢¯åº¦è®¡ç®—ä¸åå‘ä¼ æ’­</h3>
<h4 id="61">6.1 éšå‡½æ•°å®šç†æ±‚æ¢¯åº¦</h4>
<p><strong>æ¨å¯¼33ï¼šé˜ˆå€¼$\lambda$å…³äº$\boldsymbol{x}$çš„æ¢¯åº¦</strong></p>
<p>çº¦æŸæ–¹ç¨‹ï¼š</p>
<p>$$
G(\boldsymbol{x}, \lambda) = \sum_{i=1}^{n} f(x_i - \lambda(\boldsymbol{x})) - k = 0
$$</p>
<p>å¯¹$x_j$æ±‚åå¯¼ï¼š</p>
<p>$$
\frac{\partial G}{\partial x_j} + \frac{\partial G}{\partial \lambda} \frac{\partial \lambda}{\partial x_j} = 0
$$</p>
<p>å…¶ä¸­ï¼š</p>
<p>$$
\frac{\partial G}{\partial x_j} = f'(x_j - \lambda), \quad \frac{\partial G}{\partial \lambda} = -\sum_{i=1}^{n} f'(x_i - \lambda)
$$</p>
<p>è§£å¾—ï¼š</p>
<p>$$
\frac{\partial \lambda}{\partial x_j} = \frac{f'(x_j - \lambda)}{\sum_{i=1}^{n} f'(x_i - \lambda)}
$$</p>
<p><strong>æ¨å¯¼34ï¼šThreTopKçš„Jacobian</strong></p>
<p>å¯¹äº$y_i = f(x_i - \lambda(\boldsymbol{x}))$ï¼š</p>
<p>$$
\frac{\partial y_i}{\partial x_j} = f'(x_i - \lambda) \left(\delta_{ij} - \frac{\partial \lambda}{\partial x_j}\right)
$$</p>
<p>ä»£å…¥$\frac{\partial \lambda}{\partial x_j}$ï¼š</p>
<p>$$
\frac{\partial y_i}{\partial x_j} = f'(x_i - \lambda) \left(\delta_{ij} - \frac{f'(x_j - \lambda)}{\sum_k f'(x_k - \lambda)}\right)
$$</p>
<p>çŸ©é˜µå½¢å¼ï¼ˆè®°$w_i = f'(x_i - \lambda)$ï¼Œ$W = \sum_k w_k$ï¼‰ï¼š</p>
<p>$$
J = \text{diag}(\boldsymbol{w}) - \frac{1}{W} \boldsymbol{w} \boldsymbol{w}^T
$$</p>
<p>è¿™æ˜¯ç§©1ä¿®æ­£çš„å¯¹è§’çŸ©é˜µã€‚</p>
<p><strong>æ¨å¯¼35ï¼šåå‘ä¼ æ’­å…¬å¼</strong></p>
<p>æŸå¤±$\mathcal{L}(\boldsymbol{y})$å…³äº$\boldsymbol{x}$çš„æ¢¯åº¦ï¼š</p>
<p>$$
\frac{\partial \mathcal{L}}{\partial \boldsymbol{x}} = J^T \frac{\partial \mathcal{L}}{\partial \boldsymbol{y}}
$$</p>
<p>å±•å¼€ï¼š</p>
<p>$$
\frac{\partial \mathcal{L}}{\partial x_i} = w_i \frac{\partial \mathcal{L}}{\partial y_i} - \frac{w_i}{W} \sum_{j=1}^{n} w_j \frac{\partial \mathcal{L}}{\partial y_j}
$$</p>
<p>å¯ä»¥é«˜æ•ˆè®¡ç®—ï¼šå…ˆç®—$\sum_{j} w_j \frac{\partial \mathcal{L}}{\partial y_j}$ï¼Œç„¶åå¯¹æ¯ä¸ª$i$è®¡ç®—ã€‚</p>
<h4 id="62-stop-gradient">6.2 Stop GradientæŠ€å·§</h4>
<p><strong>æ¨å¯¼36ï¼šæ˜¾å¼æ¢¯åº¦æ›¿æ¢</strong></p>
<p>å®šä¹‰ï¼š</p>
<p>$$
\lambda_{\text{sg}} = \boldsymbol{x} \cdot \text{sg}[\nabla_{\boldsymbol{x}} \lambda] + \text{sg}[\lambda - \boldsymbol{x} \cdot \nabla_{\boldsymbol{x}} \lambda]
$$</p>
<p>å…¶ä¸­$\text{sg}[\cdot]$æ˜¯stop gradientç®—å­ã€‚</p>
<p>å‰å‘ä¼ æ’­ï¼š$\lambda_{\text{sg}} = \lambda$ï¼ˆå› ä¸º$\text{sg}[x] = x$åœ¨å‰å‘ï¼‰
åå‘ä¼ æ’­ï¼š</p>
<p>$$
\nabla_{\boldsymbol{x}} \lambda_{\text{sg}} = \text{sg}[\nabla_{\boldsymbol{x}} \lambda] + \text{sg}[0] = \nabla_{\boldsymbol{x}} \lambda
$$</p>
<p>è¿™æ ·æˆ‘ä»¬æ‰‹åŠ¨æŒ‡å®šäº†$\lambda$çš„æ¢¯åº¦ã€‚</p>
<p><strong>æ¨å¯¼37ï¼šè®¡ç®—å›¾åˆ†ç¦»</strong></p>
<p>åœ¨å®ç°ä¸­ï¼Œå¯ä»¥ï¼š
1. ç”¨æ•°å€¼æ–¹æ³•æ±‚$\lambda$ï¼ˆå¦‚äºŒåˆ†æ³•ï¼‰ï¼Œå¾—åˆ°æ ‡é‡å€¼
2. è®¡ç®—$\nabla_{\boldsymbol{x}} \lambda$çš„è§£æè¡¨è¾¾å¼
3. ç”¨stop gradientæŠ€å·§å°†ä¸¤è€…ç»“åˆ</p>
<p>ä¼ªä»£ç ï¼š</p>
<div class="codehilite"><pre><span></span><code>lambda_val = binary_search(x, k)  # æ•°å€¼æ±‚è§£ï¼Œä¸å»ºè®¡ç®—å›¾
grad_lambda = f&#39;(x - lambda_val) / sum(f&#39;(x - lambda_val))  # è§£ææ¢¯åº¦
lambda_with_grad = x @ sg(grad_lambda) + sg(lambda_val - x @ grad_lambda)
y = f(x - lambda_with_grad)
</code></pre></div>

<h3 id="7-entmax">7. Î±-entmaxçš„å®Œæ•´æ¨å¯¼</h3>
<h4 id="71-tsallis-entmax">7.1 Tsallisç†µä¸Î±-entmax</h4>
<p><strong>æ¨å¯¼38ï¼šTsallisç†µ</strong></p>
<p>æ™®é€šShannonç†µï¼š</p>
<p>$$
H(\boldsymbol{p}) = -\sum_{i} p_i \log p_i
$$</p>
<p>Tsallisç†µï¼ˆ$\alpha &gt; 0$ï¼Œ$\alpha \neq 1$ï¼‰ï¼š</p>
<p>$$
H_\alpha(\boldsymbol{p}) = \frac{1}{\alpha - 1} \left(1 - \sum_{i} p_i^\alpha\right)
$$</p>
<p>å½“$\alpha \to 1$æ—¶ï¼ŒTsallisç†µé€€åŒ–ä¸ºShannonç†µã€‚</p>
<p><strong>æ¨å¯¼39ï¼šÎ±-entmaxçš„ä¼˜åŒ–é—®é¢˜</strong></p>
<p>Î±-entmaxå®šä¹‰ä¸ºå¦‚ä¸‹ä¼˜åŒ–é—®é¢˜çš„è§£ï¼š</p>
<p>$$
\mathcal{E}_\alpha(\boldsymbol{x}) = \mathop{\arg\max}_{\boldsymbol{p} \in \Delta^{n-1}} \boldsymbol{p} \cdot \boldsymbol{x} + H_\alpha(\boldsymbol{p})
$$</p>
<p>å…¶ä¸­$\Delta^{n-1} = {\boldsymbol{p} : p_i \geq 0, \sum_i p_i = 1}$æ˜¯æ¦‚ç‡å•çº¯å½¢ã€‚</p>
<p>å±•å¼€ç›®æ ‡å‡½æ•°ï¼š</p>
<p>$$
\mathcal{L}_\alpha(\boldsymbol{p}) = \sum_{i} p_i x_i + \frac{1}{\alpha - 1} \left(1 - \sum_{i} p_i^\alpha\right)
$$</p>
<p><strong>æ¨å¯¼40ï¼šKKTæ¡ä»¶</strong></p>
<p>æ‹‰æ ¼æœ—æ—¥å‡½æ•°ï¼š</p>
<p>$$
\mathcal{L} = \sum_{i} p_i x_i + \frac{1}{\alpha - 1} (1 - \sum_{i} p_i^\alpha) - \lambda (\sum_{i} p_i - 1) - \sum_{i} \mu_i p_i
$$</p>
<p>KKTæ¡ä»¶ï¼š
1. $\frac{\partial \mathcal{L}}{\partial p_i} = x_i - \frac{\alpha}{\alpha - 1} p_i^{\alpha - 1} - \lambda - \mu_i = 0$
2. $\mu_i \geq 0, p_i \geq 0, \mu_i p_i = 0$ï¼ˆäº’è¡¥æ¾å¼›ï¼‰
3. $\sum_i p_i = 1$</p>
<p><strong>æ¨å¯¼41ï¼šæœ€ä¼˜è§£çš„å½¢å¼</strong></p>
<p>å¯¹äºæ´»è·ƒçš„$p_i &gt; 0$ï¼ˆ$\mu_i = 0$ï¼‰ï¼š</p>
<p>$$
x_i - \frac{\alpha}{\alpha - 1} p_i^{\alpha - 1} = \lambda
$$</p>
<p>è§£å¾—ï¼š</p>
<p>$$
p_i = \left(\frac{\alpha - 1}{\alpha}(x_i - \lambda)\right)^{1/(\alpha - 1)}
$$</p>
<p>å®šä¹‰æŠ•å½±å‡½æ•°ï¼š</p>
<p>$$
[t]_+ = \max(0, t)
$$</p>
<p>åˆ™ï¼š</p>
<p>$$
p_i = \left[\frac{\alpha - 1}{\alpha}(x_i - \lambda)\right]_+^{1/(\alpha - 1)}
$$</p>
<p>å…¶ä¸­$\lambda$ç”±å½’ä¸€åŒ–æ¡ä»¶$\sum_i p_i = 1$ç¡®å®šã€‚</p>
<p><strong>æ¨å¯¼42ï¼šç‰¹æ®Šæƒ…å†µ</strong></p>
<ul>
<li>$\alpha = 1$ï¼šé€€åŒ–ä¸ºSoftmax</li>
</ul>
<p>æé™$\alpha \to 1$ï¼šä½¿ç”¨L'HÃ´pitalæ³•åˆ™ï¼Œå¯ä»¥è¯æ˜è§£ä¸º$p_i = \frac{e^{x_i}}{\sum_j e^{x_j}}$</p>
<ul>
<li>$\alpha = 2$ï¼šSparsemax</li>
</ul>
<p>$$
  p_i = [x_i - \lambda]_+
  $$</p>
<p>è¿™æ­£æ˜¯Sparsemaxï¼</p>
<h4 id="72-sparsemax">7.2 Sparsemaxçš„è¯¦ç»†æ¨å¯¼</h4>
<p><strong>æ¨å¯¼43ï¼šSparsemaxä½œä¸ºæ¬§å‡ é‡Œå¾—æŠ•å½±</strong></p>
<p>Sparsemaxæ˜¯å‘é‡$\boldsymbol{x}$åˆ°æ¦‚ç‡å•çº¯å½¢$\Delta^{n-1}$çš„æ¬§å‡ é‡Œå¾—æŠ•å½±ï¼š</p>
<p>$$
\text{sparsemax}(\boldsymbol{x}) = \mathop{\arg\min}_{\boldsymbol{p} \in \Delta^{n-1}} \|\boldsymbol{p} - \boldsymbol{x}\|^2
$$</p>
<p>æ‹‰æ ¼æœ—æ—¥å‡½æ•°ï¼š</p>
<p>$$
\mathcal{L} = \frac{1}{2} \sum_{i} (p_i - x_i)^2 - \lambda(\sum_{i} p_i - 1) - \sum_{i} \mu_i p_i
$$</p>
<p>KKTæ¡ä»¶ï¼š$p_i - x_i - \lambda - \mu_i = 0$</p>
<p>å¯¹äº$p_i &gt; 0$ï¼š$p_i = x_i + \lambda$
å¯¹äº$p_i = 0$ï¼š$x_i + \lambda \leq 0$</p>
<p>æ‰€ä»¥ï¼š</p>
<p>$$
p_i = [x_i + \lambda]_+
$$</p>
<p>ç”±äºSparsemaxæ˜¯æœ€å°åŒ–ï¼ˆè€Œéæœ€å¤§åŒ–ï¼‰ï¼Œ$\lambda$é€šå¸¸æ˜¯è´Ÿæ•°ï¼Œæ”¹å†™ä¸º$\lambda = -\tau$ï¼š</p>
<p>$$
p_i = [x_i - \tau]_+
$$</p>
<p><strong>æ¨å¯¼44ï¼šé˜ˆå€¼$\tau$çš„è®¡ç®—</strong></p>
<p>è®¾$\boldsymbol{x}$é™åºæ’åˆ—ï¼ŒçŒœæµ‹æ”¯æ’‘é›†$S = {1, 2, \ldots, k}$ï¼ˆå‰$k$ä¸ªéé›¶ï¼‰ã€‚</p>
<p>å½’ä¸€åŒ–æ¡ä»¶ï¼š</p>
<p>$$
\sum_{i=1}^{k} (x_i - \tau) = 1
$$</p>
<p>è§£å¾—ï¼š</p>
<p>$$
\tau = \frac{\sum_{i=1}^{k} x_i - 1}{k}
$$</p>
<p>éœ€è¦éªŒè¯ï¼š
- å¯¹äº$i \leq k$ï¼š$x_i \geq \tau$ï¼ˆéé›¶ï¼‰
- å¯¹äº$i &gt; k$ï¼š$x_i &lt; \tau$ï¼ˆä¸ºé›¶ï¼‰</p>
<p>éå†$k$æ‰¾åˆ°æ»¡è¶³æ¡ä»¶çš„é‚£ä¸ªã€‚</p>
<p><strong>æ¨å¯¼45ï¼šSparsemaxæ¢¯åº¦</strong></p>
<p>ä½¿ç”¨éšå‡½æ•°å®šç†ï¼ˆä¸ä¹‹å‰ThreTopKç±»ä¼¼ï¼‰ï¼š</p>
<p>$$
\frac{\partial \tau}{\partial x_j} = \frac{1_{j \in S}}{|S|}
$$</p>
<p>å…¶ä¸­$S$æ˜¯æ”¯æ’‘é›†ï¼Œ$1_{j \in S}$æ˜¯æŒ‡ç¤ºå‡½æ•°ã€‚</p>
<p>Jacobianï¼š</p>
<p>$$
\frac{\partial p_i}{\partial x_j} = 1_{i \in S} \left(\delta_{ij} - \frac{1}{|S|}\right)
$$</p>
<p>çŸ©é˜µå½¢å¼ï¼ˆé™åˆ¶åˆ°æ”¯æ’‘é›†$S$ï¼‰ï¼š</p>
<p>$$
J_S = I_S - \frac{1}{|S|} \boldsymbol{1}_S \boldsymbol{1}_S^T
$$</p>
<p>è¿™æ˜¯ä¸­å¿ƒåŒ–çŸ©é˜µã€‚</p>
<h3 id="8">8. å…‰æ»‘æ€§ä¸ç¨€ç–æ€§çš„æƒè¡¡</h3>
<h4 id="81">8.1 å®šé‡åˆ†æ</h4>
<p><strong>æ¨å¯¼46ï¼šç¨€ç–æ€§åº¦é‡</strong></p>
<p>å®šä¹‰ç¨€ç–æ€§ä¸ºé›¶åˆ†é‡çš„æ¯”ä¾‹ï¼š</p>
<p>$$
\text{Sparsity}(\boldsymbol{p}) = \frac{|\{i : p_i = 0\}|}{n}
$$</p>
<p>å¯¹äºä¸åŒæ–¹æ³•ï¼š
- Softmaxï¼š$\text{Sparsity} = 0$ï¼ˆæ— ç¨€ç–æ€§ï¼‰
- Sparsemaxï¼š$\text{Sparsity} \approx 1 - \frac{k}{n}$ï¼ˆé«˜ç¨€ç–æ€§ï¼‰
- Î±-entmaxï¼ˆ$1 &lt; \alpha &lt; 2$ï¼‰ï¼šä»‹äºä¸¤è€…ä¹‹é—´</p>
<p><strong>æ¨å¯¼47ï¼šå…‰æ»‘æ€§åº¦é‡</strong></p>
<p>ç”¨Lipschitzå¸¸æ•°è¡¡é‡å…‰æ»‘æ€§ï¼š</p>
<p>$$
L = \sup_{\boldsymbol{x}_1 \neq \boldsymbol{x}_2} \frac{\|\mathcal{ST}_k(\boldsymbol{x}_1) - \mathcal{ST}_k(\boldsymbol{x}_2)\|}{\|\boldsymbol{x}_1 - \boldsymbol{x}_2\|}
$$</p>
<p>å¯¹äºSoftmaxï¼š$L = 1$ï¼ˆæœ€å…‰æ»‘ï¼‰
å¯¹äºSparsemaxï¼š$L$å¯èƒ½è¾ƒå¤§ï¼ˆåœ¨è¾¹ç•Œå¤„æœ‰è·³å˜ï¼‰</p>
<p><strong>æ¨å¯¼48ï¼šç†µä¸ç¨€ç–æ€§çš„å…³ç³»</strong></p>
<p>å¯¹äºÎ±-entmaxï¼Œç†µ$H_\alpha$éš$\alpha$å˜åŒ–ï¼š
- $\alpha \to 1$ï¼šç†µå¤§ï¼Œåˆ†å¸ƒå¹³æ»‘ï¼Œç¨€ç–æ€§ä½
- $\alpha \to 2$ï¼šç†µå°ï¼Œåˆ†å¸ƒé›†ä¸­ï¼Œç¨€ç–æ€§é«˜</p>
<p>æƒè¡¡æ›²çº¿ï¼š</p>
<p>$$
\alpha \in [1, 2] \Rightarrow \text{ä»å…‰æ»‘åˆ°ç¨€ç–çš„è¿ç»­è¿‡æ¸¡}
$$</p>
<h4 id="82">8.2 è¿‘ä¼¼è¯¯å·®åˆ†æ</h4>
<p><strong>æ¨å¯¼49ï¼š$L^2$è¯¯å·®ç•Œ</strong></p>
<p>å®šä¹‰è¿‘ä¼¼è¯¯å·®ï¼š</p>
<p>$$
E(\boldsymbol{x}, \tau) = \|\mathcal{ST}_k(\boldsymbol{x}/\tau) - \mathcal{T}_k(\boldsymbol{x})\|^2
$$</p>
<p>å½“$\tau \to 0$æ—¶ï¼Œ$E \to 0$ã€‚é‡åŒ–æ”¶æ•›é€Ÿç‡ï¼š</p>
<p>å¯¹äºSoftmaxç±»æ–¹æ³•ï¼ˆæŒ‡æ•°å‹ï¼‰ï¼Œå¯ä»¥è¯æ˜ï¼š</p>
<p>$$
E(\boldsymbol{x}, \tau) = O(e^{-\Delta/\tau})
$$</p>
<p>å…¶ä¸­$\Delta = x_{(k)} - x_{(k+1)}$æ˜¯ç¬¬$k$å¤§å’Œç¬¬$(k+1)$å¤§çš„é—´éš”ï¼ˆgapï¼‰ã€‚</p>
<p>è¯æ˜æ¢—æ¦‚ï¼šä¸»è¦è¯¯å·®æ¥è‡ª$i = k$å’Œ$i = k+1$é™„è¿‘ï¼Œå…¶ä»–åˆ†é‡æŒ‡æ•°è¡°å‡ã€‚</p>
<p><strong>æ¨å¯¼50ï¼šæœ€å¤§è¯¯å·®ç•Œ</strong></p>
<p>$$
\|[\mathcal{ST}_k(\boldsymbol{x}/\tau)]_i - [\mathcal{T}_k(\boldsymbol{x})]_i\|_\infty = O(\tau)
$$</p>
<p>å¯¹äºçº¿æ€§å‹æ–¹æ³•ï¼ˆå¦‚Sparsemaxï¼‰ï¼Œè¯¯å·®éš$\tau$çº¿æ€§ä¸‹é™ã€‚</p>
<p><strong>æ¨å¯¼51ï¼šæ¢¯åº¦è¯¯å·®</strong></p>
<p>è¿‘ä¼¼çš„æ¢¯åº¦$\nabla \mathcal{ST}_k$ä¸çœŸå®æ¢¯åº¦ï¼ˆæ¬¡æ¢¯åº¦ï¼‰$\partial \mathcal{T}_k$çš„å·®å¼‚ï¼š</p>
<p>$$
\|\nabla \mathcal{ST}_k(\boldsymbol{x}/\tau) - \partial \mathcal{T}_k(\boldsymbol{x})\| = O(1/\tau)
$$</p>
<p>å½“$\tau$å¾ˆå°æ—¶ï¼Œæ¢¯åº¦å¯èƒ½å¾ˆå¤§ï¼ˆæ•°å€¼ä¸ç¨³å®šï¼‰ã€‚å®è·µä¸­éœ€è¦é€‰æ‹©é€‚ä¸­çš„$\tau$ã€‚</p>
<h3 id="9">9. ç»¼åˆå¯¹æ¯”ä¸åº”ç”¨å»ºè®®</h3>
<p><strong>æ¨å¯¼52ï¼šè®¡ç®—å¤æ‚åº¦å¯¹æ¯”</strong></p>
<table>
<thead>
<tr>
<th>æ–¹æ³•</th>
<th>å‰å‘å¤æ‚åº¦</th>
<th>åå‘å¤æ‚åº¦</th>
<th>æ•°å€¼ç¨³å®šæ€§</th>
</tr>
</thead>
<tbody>
<tr>
<td>GradTopK</td>
<td>$O(n C_n^k)$</td>
<td>$O(n C_n^k)$</td>
<td>ä¸­ç­‰ï¼ˆå¤§$k$æ—¶å·®ï¼‰</td>
</tr>
<tr>
<td>ThreTopK (äºŒåˆ†)</td>
<td>$O(n \log(1/\epsilon))$</td>
<td>$O(n)$</td>
<td>å¥½</td>
</tr>
<tr>
<td>ThreTopK (è§£æ)</td>
<td>$O(n \log n)$</td>
<td>$O(n)$</td>
<td>å¾ˆå¥½</td>
</tr>
<tr>
<td>Sparsemax</td>
<td>$O(n \log n)$</td>
<td>$O(n)$</td>
<td>å¾ˆå¥½</td>
</tr>
</tbody>
</table>
<p><strong>æ¨å¯¼53ï¼šåº”ç”¨åœºæ™¯æ¨è</strong></p>
<ol>
<li><strong>éœ€è¦é«˜åº¦ç¨€ç–</strong>ï¼šSparsemaxæˆ–$\alpha$-entmaxï¼ˆ$\alpha$æ¥è¿‘2ï¼‰</li>
<li>
<p>ä¾‹å¦‚ï¼šæ³¨æ„åŠ›æœºåˆ¶ä¸­åªå…³æ³¨å°‘æ•°Token</p>
</li>
<li>
<p><strong>éœ€è¦å¹³æ»‘æ¢¯åº¦</strong>ï¼šSoftmaxæˆ–$\alpha$-entmaxï¼ˆ$\alpha$æ¥è¿‘1ï¼‰</p>
</li>
<li>
<p>ä¾‹å¦‚ï¼šè®­ç»ƒæ—©æœŸï¼Œé¿å…æ¢¯åº¦æ¶ˆå¤±</p>
</li>
<li>
<p><strong>è®¡ç®—æ•ˆç‡ä¼˜å…ˆ</strong>ï¼šThreTopK with $f(x) = \min(1, e^x)$</p>
</li>
<li>
<p>è§£æè§£ï¼Œæ— éœ€è¿­ä»£</p>
</li>
<li>
<p><strong>$k$è¾ƒå¤§</strong>ï¼šé¿å…GradTopKï¼ˆç»„åˆçˆ†ç‚¸ï¼‰</p>
</li>
<li>ä½¿ç”¨ThreTopKæˆ–Sparsemax</li>
</ol>
<p><strong>æ¨å¯¼54ï¼šç†è®ºæ€§è´¨æ€»ç»“è¡¨</strong></p>
<table>
<thead>
<tr>
<th>æ€§è´¨</th>
<th>Softmax</th>
<th>GradTopK</th>
<th>ThreTopK</th>
<th>Sparsemax</th>
</tr>
</thead>
<tbody>
<tr>
<td>å½’ä¸€åŒ–</td>
<td>$\sum p_i = 1$</td>
<td>$\sum p_i = k$</td>
<td>$\sum p_i = k$</td>
<td>$\sum p_i = 1$</td>
</tr>
<tr>
<td>ç¨€ç–æ€§</td>
<td>æ— </td>
<td>æ— </td>
<td>å–å†³äº$f$</td>
<td>æœ‰</td>
</tr>
<tr>
<td>$C^\infty$å…‰æ»‘</td>
<td>âœ“</td>
<td>âœ“</td>
<td>å–å†³äº$f$</td>
<td>âœ—ï¼ˆ$C^1$ï¼‰</td>
</tr>
<tr>
<td>$k=1$é€€åŒ–</td>
<td>è‡ªèº«</td>
<td>Softmax</td>
<td>å–å†³äº$f$</td>
<td>Softmax</td>
</tr>
<tr>
<td>å•è°ƒæ€§</td>
<td>âœ“</td>
<td>âœ“</td>
<td>âœ“</td>
<td>âœ“</td>
</tr>
<tr>
<td>å¹³ç§»ä¸å˜æ€§</td>
<td>âœ“</td>
<td>âœ“</td>
<td>âœ“</td>
<td>âœ“</td>
</tr>
</tbody>
</table>
<h3 id="10">10. æ€»ç»“</h3>
<p>é€šè¿‡ä»¥ä¸Š54ä¸ªè¯¦ç»†æ¨å¯¼ï¼Œæˆ‘ä»¬å…¨é¢åˆ†æäº†Top-Kå…‰æ»‘è¿‘ä¼¼é—®é¢˜ï¼š</p>
<ol>
<li><strong>æ•°å­¦å®šä¹‰</strong>ï¼šä¸¥æ ¼å®šä¹‰äº†Top-Kç®—å­åŠå…¶ç»„åˆæ€§è´¨</li>
<li><strong>ä¸å¯å¾®æ€§</strong>ï¼šæ·±å…¥åˆ†æäº†Top-Kçš„è·³å˜ç‚¹å’Œæ¢¯åº¦ä¸å­˜åœ¨æ€§</li>
<li><strong>Softmaxç†è®º</strong>ï¼šå»ºç«‹äº†Softmaxä½œä¸ºLogSumExpæ¢¯åº¦çš„ç†è®ºåŸºç¡€</li>
<li><strong>GradTopK</strong>ï¼šæ¨å¯¼äº†åŸºäºK-sum LogSumExpçš„æ¢¯åº¦æ–¹æ³•åŠå…¶æ•°å€¼é—®é¢˜</li>
<li><strong>ThreTopK</strong>ï¼šæå‡ºäº†é€šç”¨é˜ˆå€¼åŒ–æ¡†æ¶ï¼Œç»™å‡ºè§£æè§£å’Œæ•°å€¼è§£</li>
<li><strong>æ¢¯åº¦è®¡ç®—</strong>ï¼šä½¿ç”¨éšå‡½æ•°å®šç†å’ŒSTEæŠ€å·§æ¨å¯¼äº†å®Œæ•´çš„åå‘ä¼ æ’­</li>
<li><strong>Î±-entmax</strong>ï¼šä»Tsallisç†µæ¨å¯¼äº†Î±-entmaxï¼Œç»Ÿä¸€äº†Softmaxå’ŒSparsemax</li>
<li><strong>æƒè¡¡åˆ†æ</strong>ï¼šå®šé‡åˆ†æäº†å…‰æ»‘æ€§ä¸ç¨€ç–æ€§çš„æƒè¡¡ï¼Œç»™å‡ºè¯¯å·®ç•Œ</li>
<li><strong>ç»¼åˆå¯¹æ¯”</strong>ï¼šæ¯”è¾ƒäº†å„æ–¹æ³•çš„è®¡ç®—å¤æ‚åº¦å’Œé€‚ç”¨åœºæ™¯</li>
</ol>
<p>è¿™äº›ç†è®ºä¸ºç†è§£å’Œåº”ç”¨Top-Kå…‰æ»‘è¿‘ä¼¼æä¾›äº†åšå®çš„æ•°å­¦åŸºç¡€ï¼Œå¹¶æŒ‡å¯¼å®é™…é€‰æ‹©åˆé€‚çš„æ–¹æ³•ã€‚</p>
        </div>
    </div>
</body>
</html>