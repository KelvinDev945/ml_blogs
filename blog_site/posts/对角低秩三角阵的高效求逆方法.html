<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>â€œå¯¹è§’+ä½ç§©â€ä¸‰è§’é˜µçš„é«˜æ•ˆæ±‚é€†æ–¹æ³•</title>
    <style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    line-height: 1.6; color: #333; max-width: 900px; margin: 0 auto; padding: 20px; background: #f5f5f5;
}
.container { background: white; padding: 40px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
header { border-bottom: 2px solid #e0e0e0; padding-bottom: 20px; margin-bottom: 30px; }
h1 { color: #2c3e50; margin-bottom: 10px; font-size: 2em; }
.meta { color: #666; font-size: 0.9em; margin-bottom: 20px; }
.content { margin-top: 30px; overflow-wrap: break-word; }
.content h2 { color: #34495e; margin-top: 30px; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
.content p { margin-bottom: 15px; }
.content pre { background: #f8f8f8; padding: 15px; border-radius: 5px; overflow-x: auto; border-left: 3px solid #3498db; margin: 15px 0; }
.content code { background: #f8f8f8; padding: 2px 5px; border-radius: 3px; font-family: monospace; font-size: 0.9em; }
.content blockquote { border-left: 4px solid #3498db; padding-left: 20px; margin: 20px 0; color: #555; font-style: italic; }
.content table { border-collapse: collapse; width: 100%; margin: 20px 0; }
.content th, .content td { border: 1px solid #ddd; padding: 10px; text-align: left; }
.back-link { display: inline-block; margin-bottom: 20px; color: #3498db; text-decoration: none; font-weight: 500; }
</style>
    
<script>
    window.MathJax = {
        tex: {
            inlineMath: [['$', '$'], ['\(', '\)']],
            displayMath: [['$$', '$$'], ['\[', '\]']],
            processEscapes: true
        }
    };
</script>
<script id="MathJax-script" async src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>

</head>
<body>
    <div class="container">
        <a href="../index.html" class="back-link">â† è¿”å›é¦–é¡µ</a>
        <header>
            <h1>â€œå¯¹è§’+ä½ç§©â€ä¸‰è§’é˜µçš„é«˜æ•ˆæ±‚é€†æ–¹æ³•</h1>
            <div class="meta">ğŸ“… æœ€åæ›´æ–°: 2025-11-26 | ğŸ“„ å¤§å°: 37.8 KB</div>
        </header>
        <div class="content">
            <p><strong>åŸæ–‡é“¾æ¥</strong>: <a href="https://spaces.ac.cn/archives/11072">https://spaces.ac.cn/archives/11072</a></p>
<p><strong>å‘å¸ƒæ—¥æœŸ</strong>: </p>
<hr />
<p>ä»æ–‡ç« <a href="/archives/11033">ã€Šçº¿æ€§æ³¨æ„åŠ›ç®€å²ï¼šä»æ¨¡ä»¿ã€åˆ›æ–°åˆ°åå“ºã€‹</a>æˆ‘ä»¬å¯ä»¥å‘ç°ï¼ŒDeltaNetåŠå…¶åçš„çº¿æ€§Attentionæ¨¡å‹ï¼ŒåŸºæœ¬ä¸Šéƒ½å…³è”åˆ°äº†é€†çŸ©é˜µ$(\boldsymbol{I} + \boldsymbol{K}\boldsymbol{K}^{\top}\odot\boldsymbol{M}^-)^{-1}$ã€‚æœ¬æ–‡å°±ä¸“é—¨æ¥æ¢è®¨ä¸€ä¸‹è¿™ç±»å…·æœ‰â€œå¯¹è§’+ä½ç§©â€ç‰¹ç‚¹çš„ä¸‰è§’çŸ©é˜µçš„é€†çŸ©é˜µè®¡ç®—ã€‚</p>
<h2 id="_1">åŸºæœ¬ç»“æœ</h2>
<p>æˆ‘ä»¬å°†é—®é¢˜ä¸€èˆ¬åœ°å®šä¹‰å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>ç»™å®šçŸ©é˜µ$\boldsymbol{Q},\boldsymbol{K}\in\mathbb{R}^{n\times d}$å’Œå¯¹è§’çŸ©é˜µ$\boldsymbol{\Lambda}\in\mathbb{R}^{n\times n}$ï¼Œæ»¡è¶³$n\gg d$ï¼Œå®šä¹‰ \begin{equation}\boldsymbol{T} = \boldsymbol{\Lambda} + \boldsymbol{Q}\boldsymbol{K}^{\top}\odot\boldsymbol{M}^-\end{equation} å…¶ä¸­$\boldsymbol{M}^-=\boldsymbol{M} - \boldsymbol{I}$ï¼ŒçŸ©é˜µ$\boldsymbol{M}$å®šä¹‰ä¸º \begin{equation}M_{i,j} = \left\{\begin{aligned} &amp;1, &amp;i \geq j \\\ &amp;0, &amp;i &lt; j\end{aligned}\right.\end{equation} ç°åœ¨è¦æ±‚é€†çŸ©é˜µ$\boldsymbol{T}^{-1}$ï¼Œå¹¶ä¸”è¯æ˜å…¶å¤æ‚åº¦æ˜¯$\mathcal{O}(n^2)$ã€‚</p>
</blockquote>
<p>é¦–å…ˆï¼Œå¦‚æœæ²¡æœ‰$\odot\boldsymbol{M}^-$çš„ä¸‹ä¸‰è§’é˜µçº¦æŸï¼Œé‚£ä¹ˆå®ƒå¯ä»¥ç›´æ¥ç”±â€œ<a href="https://en.wikipedia.org/wiki/Woodbury_matrix_identity">Woodburyæ’ç­‰å¼</a>â€è§£å†³ï¼š<br />
\begin{equation}(\boldsymbol{\Lambda} + \boldsymbol{Q}\boldsymbol{K}^{\top})^{-1} = \boldsymbol{\Lambda}^{-1} - \boldsymbol{\Lambda}^{-1} \boldsymbol{Q}(\boldsymbol{I} + \boldsymbol{K}^{\top}\boldsymbol{\Lambda}^{-1}\boldsymbol{Q})^{-1}\boldsymbol{K}^{\top}\boldsymbol{\Lambda}^{-1}\end{equation}<br />
å®¹æ˜“éªŒè¯å³ç«¯çš„è®¡ç®—å¤æ‚åº¦æ˜¯$\mathcal{O}(n^2)$çš„ã€‚ç„¶è€Œï¼ŒåŠ ä¸Š$\odot\boldsymbol{M}^-$åï¼Œ$\boldsymbol{T}$æœ¬èº«å°±ä¸å†å…·æœ‰â€œå¯¹è§’+ä½ç§©â€çš„ç»“æ„ï¼Œå› æ­¤ä¸èƒ½ç›´æ¥ç”±è¯¥æ’ç­‰å¼è§£å†³äº†ã€‚é’ˆå¯¹ä¸‹ä¸‰è§’çŸ©é˜µè¿™ä¸€ç‰¹ç‚¹ï¼Œä¸€ä¸ªåŸºæœ¬çš„æ€è·¯æ˜¯é€’å½’ï¼Œå› ä¸ºæˆ‘ä»¬æœ‰åˆ†å—çŸ©é˜µæ’ç­‰å¼<br />
\begin{equation}\begin{bmatrix}\boldsymbol{A} &amp; \boldsymbol{0} \\\ \boldsymbol{C} &amp; \boldsymbol{B}\end{bmatrix}^{-1} = \begin{bmatrix}\boldsymbol{A}^{-1} &amp; \boldsymbol{0} \\\ -\boldsymbol{B}^{-1}\boldsymbol{C}\boldsymbol{A}^{-1} &amp; \boldsymbol{B}^{-1}\end{bmatrix}\end{equation}<br />
è¿™å…è®¸æˆ‘ä»¬å°†$\boldsymbol{T}^{-1}$è½¬åŒ–é€’å½’å½¢å¼ï¼ˆçº¦å®šï¼šæ²¡æœ‰æ‹¬å·çš„æƒ…å†µä¸‹ï¼Œåˆ‡ç‰‡çš„ä¼˜å…ˆçº§æœ€é«˜ï¼‰<br />
\begin{equation}\boldsymbol{T}<em _:l_:l_="[:l,:l]">{[:l+1,:l+1]}^{-1} = \begin{bmatrix}\boldsymbol{T}</em>}^{-1} &amp; \boldsymbol{0} \\\ -\boldsymbol{T<em _l:l_1_:l_="[l:l+1,:l]">{[l:l+1,l:l+1]}^{-1}\boldsymbol{T}</em>}\boldsymbol{T<em _l:l_1_l:l_1_="[l:l+1,l:l+1]">{[:l,:l]}^{-1} &amp; \boldsymbol{T}</em>}^{-1}\end{bmatrix}\end{equation<br />
å…¶ä¸­ä¸»è¦è®¡ç®—æ˜¯$\boldsymbol{T}<em _:l_:l_="[:l,:l]">{[l:l+1,:l]}\boldsymbol{T}</em>(n^3)$ã€‚}^{-1}$ï¼Œå®ƒæ˜¯ä¸€ä¸ª$1\times l$å’Œ$l\times l$çŸ©é˜µç›¸ä¹˜ï¼Œå¤æ‚åº¦æ˜¯$\mathcal{O}(\mathcal{l^2})$ï¼Œå³æ¯ä¸€æ­¥è¿­ä»£çš„å¤æ‚åº¦æ˜¯å¹³æ–¹å¢é•¿çš„ï¼Œæ‰€ä»¥æ€»å¤æ‚åº¦æ˜¯$\mathcal{O</p>
<h2 id="_2">ä½ç§©ç»“æ„</h2>
<p>å½“ç„¶ï¼Œè¿™æ˜¯å› ä¸ºæˆ‘ä»¬è¿˜æ²¡ç”¨ä¸Š$\boldsymbol{T}$ï¼ˆ$\odot\boldsymbol{M}^-$å‰ï¼‰çš„ä½ç§©ç»“æ„ï¼Œç°åœ¨æˆ‘ä»¬æŠŠå®ƒåˆ©ç”¨èµ·æ¥ï¼Œé‚£ä¹ˆå°†ä¼šå¾—åˆ°$\boldsymbol{T}<em _l:l_1_="[l:l+1]">{[l:l+1,:l]} = \boldsymbol{Q}</em>}\boldsymbol{K<em _:l_1_:l_1_="[:l+1,:l+1]">{[:l]}^{\top}$ï¼Œä»£å…¥ä¸Šå¼å¾—ï¼š<br />
\begin{equation}\boldsymbol{T}</em>}^{-1} = \begin{bmatrix}\boldsymbol{T<em _l:l_1_l:l_1_="[l:l+1,l:l+1]">{[:l,:l]}^{-1} &amp; \boldsymbol{0} \\\ -\boldsymbol{T}</em>}^{-1}\boldsymbol{Q<em _:l_="[:l]">{[l:l+1]}\boldsymbol{K}</em>}^{\top}\boldsymbol{T<em _l:l_1_l:l_1_="[l:l+1,l:l+1]">{[:l,:l]}^{-1} &amp; \boldsymbol{T}</em>}^{-1}\end{bmatrix}\end{equation<br />
æ³¨æ„$\boldsymbol{K}<em _:l_:l_="[:l,:l]">{[:l]}^{\top}\boldsymbol{T}</em>(n^2)$ã€‚æ ¹æ®è¿™ä¸ªæ€è·¯ï¼Œæˆ‘ä»¬æœ‰}^{-1}\in\mathbb{R}^{d\times l}$ï¼Œå¦‚æœæˆ‘ä»¬èƒ½ä»¥å®ƒä¸ºé€’å½’å˜é‡ï¼Œé‚£ä¹ˆæ¯ä¸€æ­¥è¿­ä»£çš„å¤æ‚åº¦å°±åªæ˜¯$\mathcal{O}(l)$ï¼Œæ€»å¤æ‚åº¦å°±èƒ½æˆåŠŸé™åˆ°$\mathcal{O<br />
\begin{equation}\begin{aligned}<br />
\boldsymbol{K}<em _:l_1_:l_1_="[:l+1,:l+1]">{[:l+1]}^{\top}\boldsymbol{T}</em>}^{-1} =&amp;\, \begin{bmatrix}\boldsymbol{K<em _l:l_1_="[l:l+1]">{[:l]}^{\top} &amp; \boldsymbol{K}</em>}^{\top}\end{bmatrix}\begin{bmatrix}\boldsymbol{T<em _l:l_1_l:l_1_="[l:l+1,l:l+1]">{[:l,:l]}^{-1} &amp; \boldsymbol{0} \\\ -\boldsymbol{T}</em>}^{-1}\boldsymbol{Q<em _:l_="[:l]">{[l:l+1]}\boldsymbol{K}</em>}^{\top}\boldsymbol{T<em _l:l_1_l:l_1_="[l:l+1,l:l+1]">{[:l,:l]}^{-1} &amp; \boldsymbol{T}</em> \\\[6pt]}^{-1}\end{bmatrix<br />
=&amp;\, \begin{bmatrix}\boldsymbol{K}<em _:l_:l_="[:l,:l]">{[:l]}^{\top}\boldsymbol{T}</em>}^{-1} &amp; \boldsymbol{0}\end{bmatrix} + \boldsymbol{K<em _l:l_1_l:l_1_="[l:l+1,l:l+1]">{[l:l+1]}^{\top}\underbrace{\begin{bmatrix}-\boldsymbol{T}</em>}^{-1}\boldsymbol{Q<em _:l_="[:l]">{[l:l+1]}\boldsymbol{K}</em>}^{\top}\boldsymbol{T<em _l:l_1_l:l_1_="[l:l+1,l:l+1]">{[:l,:l]}^{-1} &amp; \boldsymbol{T}</em>}^{-1}\end{bmatrix}<em _l:l_1_:l_1_="[l:l+1,:l+1]">{\text{å®é™…ä¸Šå°±æ˜¯ }(\boldsymbol{T}^{-1})</em>}}\end{aligned}\end{equation<br />
å¯ä»¥çœ‹åˆ°è¿™ä¸ªé€’å½’è¿‡ç¨‹ä¹Ÿæ²¡æœ‰æ¶‰åŠåˆ°$\mathcal{O}(l^2)$çš„è¿ç®—ï¼Œå› æ­¤æ€è·¯æ˜¯å¯è¡Œçš„ï¼Œåªéœ€è¦å¼•å…¥ä¸€ä¸ªæ–°å˜é‡æ¥ç¼“å­˜$\boldsymbol{K}<em _:l_:l_="[:l,:l]">{[:l]}^{\top}\boldsymbol{T}</em>$ã€‚å¦‚æœæˆ‘ä»¬å°†$l+1$æ¢æˆ$l+c$ï¼Œé‚£ä¹ˆå°±å¯ä»¥å¾—åˆ°chunkæ ¼å¼çš„é€’å½’ã€‚}^{-1</p>
<p>æµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="n">n</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">200</span>
<span class="n">Q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="o">/</span> <span class="n">d</span><span class="o">**</span><span class="mf">0.5</span>
<span class="n">K</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="o">/</span> <span class="n">d</span><span class="o">**</span><span class="mf">0.5</span>
<span class="n">T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">tril</span><span class="p">(</span><span class="n">Q</span> <span class="o">@</span> <span class="n">K</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="kp">eye</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

<span class="n">Y</span><span class="p">,</span> <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="kp">zeros</span><span class="p">((</span><span class="n">d</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
<span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
    <span class="n">Y</span><span class="p">[</span><span class="n">l</span><span class="p">:</span><span class="n">l</span> <span class="o">+</span> <span class="n">c</span><span class="p">,</span> <span class="n">l</span><span class="p">:</span><span class="n">l</span> <span class="o">+</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="kp">inv</span><span class="p">(</span><span class="n">T</span><span class="p">[</span><span class="n">l</span><span class="p">:</span><span class="n">l</span> <span class="o">+</span> <span class="n">c</span><span class="p">,</span> <span class="n">l</span><span class="p">:</span><span class="n">l</span> <span class="o">+</span> <span class="n">c</span><span class="p">])</span>
    <span class="n">Y</span><span class="p">[</span><span class="n">l</span><span class="p">:</span><span class="n">l</span> <span class="o">+</span> <span class="n">c</span><span class="p">,</span> <span class="p">:</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span> <span class="n">Y</span><span class="p">[</span><span class="n">l</span><span class="p">:</span><span class="n">l</span> <span class="o">+</span> <span class="n">c</span><span class="p">,</span> <span class="n">l</span><span class="p">:</span><span class="n">l</span> <span class="o">+</span> <span class="n">c</span><span class="p">]</span> <span class="o">@</span> <span class="n">Q</span><span class="p">[</span><span class="n">l</span><span class="p">:</span><span class="n">l</span> <span class="o">+</span> <span class="n">c</span><span class="p">]</span> <span class="o">@</span> <span class="n">Z</span><span class="p">[:,</span> <span class="p">:</span><span class="n">l</span><span class="p">]</span>
    <span class="n">Z</span><span class="p">[:,</span> <span class="p">:</span><span class="n">l</span> <span class="o">+</span> <span class="n">c</span><span class="p">]</span> <span class="o">+=</span> <span class="n">K</span><span class="p">[</span><span class="n">l</span><span class="p">:</span><span class="n">l</span> <span class="o">+</span> <span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">Y</span><span class="p">[</span><span class="n">l</span><span class="p">:</span><span class="n">l</span> <span class="o">+</span> <span class="n">c</span><span class="p">,</span> <span class="p">:</span><span class="n">l</span> <span class="o">+</span> <span class="n">c</span><span class="p">]</span>

<span class="n">np</span><span class="o">.</span><span class="kp">allclose</span><span class="p">(</span><span class="n">Y</span> <span class="o">@</span> <span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="kp">eye</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
</code></pre></div>

<h2 id="_3">ä¹˜æ³•è®¡ç®—</h2>
<p>åŸºäºåŒæ ·çš„æ€è·¯ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥è¯æ˜ï¼š</p>
<blockquote>
<p>å¯¹äºä»»æ„çŸ©é˜µ$\boldsymbol{V}\in\mathbb{R}^{n\times d}$ï¼Œè®¡ç®—$\boldsymbol{T}^{-1}\boldsymbol{V}$åªéœ€è¦$\mathcal{O}(n)$çš„å¤æ‚åº¦ã€‚</p>
</blockquote>
<p>è¯æ˜åªéœ€è¦æŠŠå‰è¿°è¿‡ç¨‹ç¨å¾®æ”¹åŠ¨ä¸€ä¸‹ã€‚é¦–å…ˆæœ‰<br />
\begin{equation}\begin{aligned}<br />
(\boldsymbol{T}^{-1}\boldsymbol{V})<em _:l_1_:l_1_="[:l+1,:l+1]">{[:l+1]} =&amp;\, \boldsymbol{T}</em>}^{-1}\boldsymbol{V<em _:l_:l_="[:l,:l]">{[:l+1]} \\\[6pt]<br />
=&amp;\, \begin{bmatrix}\boldsymbol{T}</em>}^{-1} &amp; \boldsymbol{0} \\\ -\boldsymbol{T<em _l:l_1_="[l:l+1]">{[l:l+1,l:l+1]}^{-1}\boldsymbol{Q}</em>}\boldsymbol{K<em _:l_:l_="[:l,:l]">{[:l]}^{\top}\boldsymbol{T}</em>}^{-1} &amp; \boldsymbol{T<em _:l_="[:l]">{[l:l+1,l:l+1]}^{-1}\end{bmatrix}\begin{bmatrix}\boldsymbol{V}</em>} \\\ \boldsymbol{V<em _:l_:l_="[:l,:l]">{[l:l+1]}\end{bmatrix} \\\[6pt]<br />
=&amp;\, \begin{bmatrix}\boldsymbol{T}</em>}^{-1}\boldsymbol{V<em _l:l_1_l:l_1_="[l:l+1,l:l+1]">{[:l]} \\\ -\boldsymbol{T}</em>}^{-1}\boldsymbol{Q<em _:l_="[:l]">{[l:l+1]}\boldsymbol{K}</em>}^{\top}\boldsymbol{T<em _:l_="[:l]">{[:l,:l]}^{-1}\boldsymbol{V}</em>} + \boldsymbol{T<em _l:l_1_="[l:l+1]">{[l:l+1,l:l+1]}^{-1}\boldsymbol{V}</em> \\\[6pt]}\end{bmatrix<br />
=&amp;\, \begin{bmatrix}(\boldsymbol{T}^{-1}\boldsymbol{V})<em _l:l_1_l:l_1_="[l:l+1,l:l+1]">{[:l]} \\\ \boldsymbol{T}</em>}^{-1}(\boldsymbol{V<em _l:l_1_="[l:l+1]">{[l:l+1]} - \boldsymbol{Q}</em>}\boldsymbol{K<em _:l_="[:l]">{[:l]}^{\top}(\boldsymbol{T}^{-1}\boldsymbol{V})</em>})\end{bmatrix<br />
\end{aligned}\end{equation}<br />
ç„¶å<br />
\begin{equation}\begin{aligned}<br />
\boldsymbol{K}<em _:l_1_="[:l+1]">{[:l+1]}^{\top}(\boldsymbol{T}^{-1}\boldsymbol{V})</em>} =&amp;\, \begin{bmatrix}\boldsymbol{K<em _l:l_1_="[l:l+1]">{[:l]}^{\top} &amp; \boldsymbol{K}</em>)}^{\top}\end{bmatrix}\begin{bmatrix}(\boldsymbol{T}^{-1}\boldsymbol{V<em _l:l_1_="[l:l+1]">{[:l]} \\\ (\boldsymbol{T}^{-1}\boldsymbol{V})</em> \\\[8pt]} \end{bmatrix<br />
=&amp;\,\boldsymbol{K}<em _:l_="[:l]">{[:l]}^{\top}(\boldsymbol{T}^{-1}\boldsymbol{V})</em>} + \boldsymbol{K<em _l:l_1_="[l:l+1]">{[l:l+1]}^{\top}(\boldsymbol{T}^{-1}\boldsymbol{V})</em><br />
\end{aligned}\end{equation}<br />
å› æ­¤ï¼Œåªéœ€è¦ç¼“å­˜$\boldsymbol{K}<em _:l_="[:l]">{[:l]}^{\top}(\boldsymbol{T}^{-1}\boldsymbol{V})</em>(n)$ã€‚åŒæ ·ï¼Œåªéœ€è¦å°†$l+1$æ¢æˆ$l+c$å°±å¯ä»¥å¾—åˆ°chunkæ ¼å¼ã€‚}\in\mathbb{R}^{d\times d}$ï¼Œå°±å¯ä»¥ä½¿å¾—æ¯æ­¥çš„è®¡ç®—å¤æ‚åº¦ä¸$l$æ— å…³ï¼Œå› æ­¤æ€»å¤æ‚åº¦æ˜¯$\mathcal{O</p>
<p>æµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="n">n</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">200</span>
<span class="n">Q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="o">/</span> <span class="n">d</span><span class="o">**</span><span class="mf">0.5</span>
<span class="n">K</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="o">/</span> <span class="n">d</span><span class="o">**</span><span class="mf">0.5</span>
<span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="o">/</span> <span class="n">d</span><span class="o">**</span><span class="mf">0.5</span>
<span class="n">T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">tril</span><span class="p">(</span><span class="n">Q</span> <span class="o">@</span> <span class="n">K</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="kp">eye</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

<span class="n">Y</span><span class="p">,</span> <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">d</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="kp">zeros</span><span class="p">((</span><span class="n">d</span><span class="p">,</span> <span class="n">d</span><span class="p">))</span>
<span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="kp">inv</span><span class="p">(</span><span class="n">T</span><span class="p">[</span><span class="n">l</span><span class="p">:</span><span class="n">l</span> <span class="o">+</span> <span class="n">c</span><span class="p">,</span> <span class="n">l</span><span class="p">:</span><span class="n">l</span> <span class="o">+</span> <span class="n">c</span><span class="p">])</span>
    <span class="n">Y</span><span class="p">[</span><span class="n">l</span><span class="p">:</span><span class="n">l</span> <span class="o">+</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span> <span class="o">@</span> <span class="p">(</span><span class="n">V</span><span class="p">[</span><span class="n">l</span><span class="p">:</span><span class="n">l</span> <span class="o">+</span> <span class="n">c</span><span class="p">]</span> <span class="o">-</span> <span class="n">Q</span><span class="p">[</span><span class="n">l</span><span class="p">:</span><span class="n">l</span> <span class="o">+</span> <span class="n">c</span><span class="p">]</span> <span class="o">@</span> <span class="n">Z</span><span class="p">)</span>
    <span class="n">Z</span> <span class="o">+=</span> <span class="n">K</span><span class="p">[</span><span class="n">l</span><span class="p">:</span><span class="n">l</span> <span class="o">+</span> <span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">Y</span><span class="p">[</span><span class="n">l</span><span class="p">:</span><span class="n">l</span> <span class="o">+</span> <span class="n">c</span><span class="p">]</span>

<span class="n">np</span><span class="o">.</span><span class="kp">allclose</span><span class="p">(</span><span class="n">T</span> <span class="o">@</span> <span class="n">Y</span><span class="p">,</span> <span class="n">V</span><span class="p">)</span>
</code></pre></div>

<h2 id="_4">æ–‡ç« å°ç»“</h2>
<p>æœ¬æ–‡è®¨è®ºäº†â€œå¯¹è§’+ä½ç§©â€ç‰¹ç‚¹çš„ä¸‰è§’çŸ©é˜µæ±‚é€†é—®é¢˜ï¼Œè¿™ç±»çŸ©é˜µæ™®éå‡ºç°åœ¨æ–°å¼çº¿æ€§Attentionæ¨¡å‹ä¸­ã€‚</p>
<p><em><strong>è½¬è½½åˆ°è¯·åŒ…æ‹¬æœ¬æ–‡åœ°å€ï¼š</strong><a href="https://spaces.ac.cn/archives/11072">https://spaces.ac.cn/archives/11072</a></em></p>
<p><em><strong>æ›´è¯¦ç»†çš„è½¬è½½äº‹å®œè¯·å‚è€ƒï¼š</strong></em><a href="https://spaces.ac.cn/archives/6508#%E6%96%87%E7%AB%A0%E5%A6%82%E4%BD%95%E8%BD%AC%E8%BD%BD/%E5%BC%95%E7%94%A8" title="ã€Šç§‘å­¦ç©ºé—´FAQã€‹">ã€Šç§‘å­¦ç©ºé—´FAQã€‹</a></p>
<p><strong>å¦‚æœæ‚¨è¿˜æœ‰ä»€ä¹ˆç–‘æƒ‘æˆ–å»ºè®®ï¼Œæ¬¢è¿åœ¨ä¸‹æ–¹è¯„è®ºåŒºç»§ç»­è®¨è®ºã€‚</strong></p>
<p><strong>å¦‚æœæ‚¨è§‰å¾—æœ¬æ–‡è¿˜ä¸é”™ï¼Œæ¬¢è¿åˆ†äº«/æ‰“èµæœ¬æ–‡ã€‚æ‰“èµå¹¶éè¦ä»ä¸­è·å¾—æ”¶ç›Šï¼Œè€Œæ˜¯å¸Œæœ›çŸ¥é“ç§‘å­¦ç©ºé—´è·å¾—äº†å¤šå°‘è¯»è€…çš„çœŸå¿ƒå…³æ³¨ã€‚å½“ç„¶ï¼Œå¦‚æœä½ æ— è§†å®ƒï¼Œä¹Ÿä¸ä¼šå½±å“ä½ çš„é˜…è¯»ã€‚å†æ¬¡è¡¨ç¤ºæ¬¢è¿å’Œæ„Ÿè°¢ï¼</strong></p>
<p>æ‰“èµ</p>
<p><img alt="ç§‘å­¦ç©ºé—´" src="https://spaces.ac.cn/usr/themes/geekg/payment/wx.png" /></p>
<p>å¾®ä¿¡æ‰“èµ</p>
<p><img alt="ç§‘å­¦ç©ºé—´" src="https://spaces.ac.cn/usr/themes/geekg/payment/zfb.png" /></p>
<p>æ”¯ä»˜å®æ‰“èµ</p>
<p>å› ä¸ºç½‘ç«™åå°å¯¹æ‰“èµå¹¶æ— è®°å½•ï¼Œå› æ­¤æ¬¢è¿åœ¨æ‰“èµæ—¶å€™å¤‡æ³¨ç•™è¨€ã€‚ä½ è¿˜å¯ä»¥<a href="http://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&amp;email=tN7d1drY3drrx8H0xcWa19vZ"><strong>ç‚¹å‡»è¿™é‡Œ</strong></a>æˆ–åœ¨ä¸‹æ–¹è¯„è®ºåŒºç•™è¨€æ¥å‘ŠçŸ¥ä½ çš„å»ºè®®æˆ–éœ€æ±‚ã€‚</p>
<p><strong>å¦‚æœæ‚¨éœ€è¦å¼•ç”¨æœ¬æ–‡ï¼Œè¯·å‚è€ƒï¼š</strong></p>
<p>è‹å‰‘æ—. (Jul. 01, 2025). ã€Šâ€œå¯¹è§’+ä½ç§©â€ä¸‰è§’é˜µçš„é«˜æ•ˆæ±‚é€†æ–¹æ³• ã€‹[Blog post]. Retrieved from <a href="https://spaces.ac.cn/archives/11072">https://spaces.ac.cn/archives/11072</a></p>
<p>@online{kexuefm-11072,<br />
title={â€œå¯¹è§’+ä½ç§©â€ä¸‰è§’é˜µçš„é«˜æ•ˆæ±‚é€†æ–¹æ³•},<br />
author={è‹å‰‘æ—},<br />
year={2025},<br />
month={Jul},<br />
url={\url{https://spaces.ac.cn/archives/11072}},<br />
} </p>
<hr />
<h2 id="_5">å…¬å¼æ¨å¯¼ä¸æ³¨é‡Š</h2>
<p>æœ¬èŠ‚æä¾›æ–‡ç« ä¸­å…³é”®ç»“æœçš„è¯¦ç»†æ•°å­¦æ¨å¯¼ï¼Œä»çŸ©é˜µç†è®ºåŸºç¡€åˆ°ç®—æ³•å®ç°çš„å®Œæ•´åˆ†æã€‚</p>
<h3 id="1">1. "å¯¹è§’+ä½ç§©"çŸ©é˜µç»“æ„çš„æ•°å­¦è¡¨ç¤º</h3>
<p><strong>å®šä¹‰1.1ï¼ˆå¯¹è§’+ä½ç§©çŸ©é˜µï¼‰</strong>ï¼šä¸€ä¸ªçŸ©é˜µ$\boldsymbol{A}\in\mathbb{R}^{n\times n}$ç§°ä¸ºå¯¹è§’+ä½ç§©çŸ©é˜µï¼Œå¦‚æœå®ƒå¯ä»¥è¡¨ç¤ºä¸º
$$\boldsymbol{A} = \boldsymbol{D} + \boldsymbol{U}\boldsymbol{V}^{\top}$$
å…¶ä¸­$\boldsymbol{D}\in\mathbb{R}^{n\times n}$æ˜¯å¯¹è§’çŸ©é˜µï¼Œ$\boldsymbol{U},\boldsymbol{V}\in\mathbb{R}^{n\times r}$ä¸”$r\ll n$ã€‚</p>
<p><strong>æœ¬æ–‡é—®é¢˜çš„ç‰¹æ®Šæ€§</strong>ï¼šæ–‡ç« ä¸­çš„çŸ©é˜µ$\boldsymbol{T}$å…·æœ‰æ›´å¤æ‚çš„ç»“æ„ï¼š
$$\boldsymbol{T} = \boldsymbol{\Lambda} + \boldsymbol{Q}\boldsymbol{K}^{\top}\odot\boldsymbol{M}^-$$</p>
<p>è®©æˆ‘ä»¬è¯¦ç»†åˆ†æè¿™ä¸ªç»“æ„ï¼š</p>
<ol>
<li><strong>å¯¹è§’éƒ¨åˆ†</strong>ï¼š$\boldsymbol{\Lambda} = \text{diag}(\lambda_1, \lambda_2, \ldots, \lambda_n)$</li>
<li><strong>ä½ç§©éƒ¨åˆ†</strong>ï¼š$\boldsymbol{Q}\boldsymbol{K}^{\top}$ï¼Œå…¶ä¸­$\boldsymbol{Q},\boldsymbol{K}\in\mathbb{R}^{n\times d}$ï¼Œç§©æœ€å¤šä¸º$d$</li>
<li><strong>ä¸‹ä¸‰è§’æ©ç </strong>ï¼š$\boldsymbol{M}^- = \boldsymbol{M} - \boldsymbol{I}$ï¼Œå…¶ä¸­
   $$M_{i,j} = \begin{cases} 1, & i \geq j \\ 0, & i < j \end{cases}$$</li>
</ol>
<p><strong>å…³é”®è§‚å¯Ÿ</strong>ï¼š$\odot\boldsymbol{M}^-$æ“ä½œä½¿å¾—
$$(\boldsymbol{Q}\boldsymbol{K}^{\top}\odot\boldsymbol{M}^-)_{i,j} = \begin{cases} (\boldsymbol{Q}\boldsymbol{K}^{\top})_{i,j}, & i > j \\ 0, & i \leq j \end{cases}$$</p>
<p>å› æ­¤ï¼Œ$\boldsymbol{T}$æ˜¯ä¸¥æ ¼ä¸‹ä¸‰è§’+å¯¹è§’çŸ©é˜µï¼š
$$T_{i,j} = \begin{cases} \lambda_i, & i = j \\ \sum_{k=1}^{d} Q_{i,k}K_{j,k}, & i > j \\ 0, & i < j \end{cases}$$</p>
<p>è¿™æ„å‘³ç€$\boldsymbol{T}$è™½ç„¶æ•´ä½“ä¸Šä¸å†æ˜¯"å¯¹è§’+ä½ç§©"å½¢å¼ï¼Œä½†å®ƒä¿ç•™äº†<strong>ä¸‹ä¸‰è§’ç»“æ„</strong>å’Œ<strong>ä½ç§©è¡¨ç¤º</strong>çš„å±€éƒ¨æ€§è´¨ã€‚</p>
<h3 id="2-woodbury">2. WoodburyçŸ©é˜µæ’ç­‰å¼çš„å®Œæ•´è¯æ˜</h3>
<p><strong>å®šç†2.1ï¼ˆSherman-Morrison-Woodburyå…¬å¼ï¼‰</strong>ï¼šè®¾$\boldsymbol{A}\in\mathbb{R}^{n\times n}$å¯é€†ï¼Œ$\boldsymbol{U},\boldsymbol{V}\in\mathbb{R}^{n\times k}$ï¼Œè‹¥$\boldsymbol{I}_k + \boldsymbol{V}^{\top}\boldsymbol{A}^{-1}\boldsymbol{U}$å¯é€†ï¼Œåˆ™
$$(\boldsymbol{A} + \boldsymbol{U}\boldsymbol{V}^{\top})^{-1} = \boldsymbol{A}^{-1} - \boldsymbol{A}^{-1}\boldsymbol{U}(\boldsymbol{I}_k + \boldsymbol{V}^{\top}\boldsymbol{A}^{-1}\boldsymbol{U})^{-1}\boldsymbol{V}^{\top}\boldsymbol{A}^{-1}$$</p>
<p><strong>è¯æ˜ï¼ˆæ–¹æ³•ä¸€ï¼šç›´æ¥éªŒè¯ï¼‰</strong>ï¼š</p>
<p>è®°$\boldsymbol{B} = \boldsymbol{A}^{-1} - \boldsymbol{A}^{-1}\boldsymbol{U}(\boldsymbol{I}_k + \boldsymbol{V}^{\top}\boldsymbol{A}^{-1}\boldsymbol{U})^{-1}\boldsymbol{V}^{\top}\boldsymbol{A}^{-1}$ï¼Œéœ€è¯$\boldsymbol{B}(\boldsymbol{A} + \boldsymbol{U}\boldsymbol{V}^{\top}) = \boldsymbol{I}$ã€‚</p>
<p>è®¡ç®—å·¦ç«¯ï¼š
$$\begin{aligned}
&\boldsymbol{B}(\boldsymbol{A} + \boldsymbol{U}\boldsymbol{V}^{\top}) \\
=& \left[\boldsymbol{A}^{-1} - \boldsymbol{A}^{-1}\boldsymbol{U}(\boldsymbol{I}_k + \boldsymbol{V}^{\top}\boldsymbol{A}^{-1}\boldsymbol{U})^{-1}\boldsymbol{V}^{\top}\boldsymbol{A}^{-1}\right](\boldsymbol{A} + \boldsymbol{U}\boldsymbol{V}^{\top}) \\
=& \boldsymbol{A}^{-1}\boldsymbol{A} + \boldsymbol{A}^{-1}\boldsymbol{U}\boldsymbol{V}^{\top} - \boldsymbol{A}^{-1}\boldsymbol{U}(\boldsymbol{I}_k + \boldsymbol{V}^{\top}\boldsymbol{A}^{-1}\boldsymbol{U})^{-1}\boldsymbol{V}^{\top}\boldsymbol{A}^{-1}\boldsymbol{A} \\
&\quad - \boldsymbol{A}^{-1}\boldsymbol{U}(\boldsymbol{I}_k + \boldsymbol{V}^{\top}\boldsymbol{A}^{-1}\boldsymbol{U})^{-1}\boldsymbol{V}^{\top}\boldsymbol{A}^{-1}\boldsymbol{U}\boldsymbol{V}^{\top} \\
=& \boldsymbol{I} + \boldsymbol{A}^{-1}\boldsymbol{U}\boldsymbol{V}^{\top} - \boldsymbol{A}^{-1}\boldsymbol{U}(\boldsymbol{I}_k + \boldsymbol{V}^{\top}\boldsymbol{A}^{-1}\boldsymbol{U})^{-1}\boldsymbol{V}^{\top} \\
&\quad - \boldsymbol{A}^{-1}\boldsymbol{U}(\boldsymbol{I}_k + \boldsymbol{V}^{\top}\boldsymbol{A}^{-1}\boldsymbol{U})^{-1}(\boldsymbol{V}^{\top}\boldsymbol{A}^{-1}\boldsymbol{U})\boldsymbol{V}^{\top} \\
=& \boldsymbol{I} + \boldsymbol{A}^{-1}\boldsymbol{U}\boldsymbol{V}^{\top} - \boldsymbol{A}^{-1}\boldsymbol{U}(\boldsymbol{I}_k + \boldsymbol{V}^{\top}\boldsymbol{A}^{-1}\boldsymbol{U})^{-1}[\boldsymbol{I}_k + \boldsymbol{V}^{\top}\boldsymbol{A}^{-1}\boldsymbol{U}]\boldsymbol{V}^{\top} \\
=& \boldsymbol{I} + \boldsymbol{A}^{-1}\boldsymbol{U}\boldsymbol{V}^{\top} - \boldsymbol{A}^{-1}\boldsymbol{U}\boldsymbol{V}^{\top} = \boldsymbol{I}
\end{aligned}$$</p>
<p>å…¶ä¸­å…³é”®æ­¥éª¤æ˜¯å°†ç¬¬3ã€4é¡¹åˆå¹¶ï¼š
$$(\boldsymbol{I}_k + \boldsymbol{V}^{\top}\boldsymbol{A}^{-1}\boldsymbol{U})^{-1}[\boldsymbol{V}^{\top} + \boldsymbol{V}^{\top}\boldsymbol{A}^{-1}\boldsymbol{U}\boldsymbol{V}^{\top}] = (\boldsymbol{I}_k + \boldsymbol{V}^{\top}\boldsymbol{A}^{-1}\boldsymbol{U})^{-1}(\boldsymbol{I}_k + \boldsymbol{V}^{\top}\boldsymbol{A}^{-1}\boldsymbol{U})\boldsymbol{V}^{\top} = \boldsymbol{V}^{\top}$$</p>
<p><strong>è¯æ˜ï¼ˆæ–¹æ³•äºŒï¼šå—çŸ©é˜µé€†ï¼‰</strong>ï¼š</p>
<p>æ„é€ å—çŸ©é˜µï¼š
$$\boldsymbol{M} = \begin{bmatrix} \boldsymbol{A} & \boldsymbol{U} \\ \boldsymbol{V}^{\top} & -\boldsymbol{I}_k \end{bmatrix}$$</p>
<p>ä½¿ç”¨ä¸¤ç§ä¸åŒçš„å—æ¶ˆå…ƒæ–¹æ³•æ±‚é€†ï¼š</p>
<p><strong>ç¬¬ä¸€ç§æ¶ˆå…ƒ</strong>ï¼ˆå…ˆæ¶ˆå»å·¦ä¸‹å—ï¼‰ï¼š
$$\begin{bmatrix} \boldsymbol{A} & \boldsymbol{U} \\ \boldsymbol{V}^{\top} & -\boldsymbol{I}_k \end{bmatrix} \sim \begin{bmatrix} \boldsymbol{A} + \boldsymbol{U}\boldsymbol{V}^{\top} & \boldsymbol{0} \\ \boldsymbol{V}^{\top} & -\boldsymbol{I}_k \end{bmatrix}$$</p>
<p>å¾—åˆ°ï¼š
$$\boldsymbol{M}^{-1} = \begin{bmatrix} (\boldsymbol{A} + \boldsymbol{U}\boldsymbol{V}^{\top})^{-1} & * \\ * & * \end{bmatrix}$$</p>
<p><strong>ç¬¬äºŒç§æ¶ˆå…ƒ</strong>ï¼ˆå…ˆæ¶ˆå»å³ä¸Šå—ï¼‰ï¼š
$$\begin{bmatrix} \boldsymbol{A} & \boldsymbol{U} \\ \boldsymbol{V}^{\top} & -\boldsymbol{I}_k \end{bmatrix} \sim \begin{bmatrix} \boldsymbol{A} & \boldsymbol{0} \\ \boldsymbol{V}^{\top} + \boldsymbol{A}^{-1}\boldsymbol{U} & -\boldsymbol{I}_k \end{bmatrix}$$</p>
<p>å¾—åˆ°å·¦ä¸Šå—ä¸ºï¼š
$$\boldsymbol{A}^{-1} - \boldsymbol{A}^{-1}\boldsymbol{U}(\boldsymbol{I}_k + \boldsymbol{V}^{\top}\boldsymbol{A}^{-1}\boldsymbol{U})^{-1}\boldsymbol{V}^{\top}\boldsymbol{A}^{-1}$$</p>
<p>ä¸¤ç§æ–¹æ³•å¾—åˆ°çš„$(1,1)$å—å¿…é¡»ç›¸ç­‰ï¼Œè¯æ¯•ã€‚</p>
<p><strong>è®¡ç®—å¤æ‚åº¦åˆ†æ</strong>ï¼š</p>
<p>å¯¹äº$\boldsymbol{A} = \boldsymbol{\Lambda}$ï¼ˆå¯¹è§’çŸ©é˜µï¼‰ï¼Œ$\boldsymbol{U} = \boldsymbol{Q}$ï¼Œ$\boldsymbol{V} = \boldsymbol{K}$ï¼š</p>
<ol>
<li>$\boldsymbol{\Lambda}^{-1}$ï¼š$\mathcal{O}(n)$ï¼ˆå¯¹è§’å…ƒç´ æ±‚å€’æ•°ï¼‰</li>
<li>$\boldsymbol{\Lambda}^{-1}\boldsymbol{Q}$ï¼š$\mathcal{O}(nd)$ï¼ˆ$n$ä¸ª$d$ç»´å‘é‡é€å…ƒç´ ä¹˜ï¼‰</li>
<li>$\boldsymbol{K}^{\top}\boldsymbol{\Lambda}^{-1}\boldsymbol{Q}$ï¼š$\mathcal{O}(nd^2)$ï¼ˆ$d\times n$çŸ©é˜µä¹˜$n\times d$çŸ©é˜µï¼‰</li>
<li>$(\boldsymbol{I}_d + \boldsymbol{K}^{\top}\boldsymbol{\Lambda}^{-1}\boldsymbol{Q})^{-1}$ï¼š$\mathcal{O}(d^3)$ï¼ˆ$d\times d$çŸ©é˜µæ±‚é€†ï¼‰</li>
<li>æœ€ç»ˆç»„åˆï¼š$\mathcal{O}(nd^2)$</li>
</ol>
<p>æ€»å¤æ‚åº¦ï¼š$\mathcal{O}(nd^2) + \mathcal{O}(d^3) = \mathcal{O}(nd^2)$ã€‚å½“$d\ll n$æ—¶ï¼Œè¿™æ˜¯$\mathcal{O}(n)$çº¿æ€§å¤æ‚åº¦ï¼ˆå›ºå®š$d$æ—¶ï¼‰ã€‚</p>
<h3 id="3">3. ä¸‰è§’çŸ©é˜µçš„å—çŸ©é˜µæ±‚é€†é€’å½’ç®—æ³•</h3>
<p><strong>å®šç†3.1ï¼ˆå—ä¸‹ä¸‰è§’çŸ©é˜µæ±‚é€†ï¼‰</strong>ï¼šå¯¹äºå—ä¸‹ä¸‰è§’çŸ©é˜µ
$$\boldsymbol{T} = \begin{bmatrix}\boldsymbol{A} & \boldsymbol{0} \\ \boldsymbol{C} & \boldsymbol{B}\end{bmatrix}$$
å…¶ä¸­$\boldsymbol{A}\in\mathbb{R}^{m\times m}$ï¼Œ$\boldsymbol{B}\in\mathbb{R}^{n\times n}$å¯é€†ï¼Œæœ‰
$$\boldsymbol{T}^{-1} = \begin{bmatrix}\boldsymbol{A}^{-1} & \boldsymbol{0} \\ -\boldsymbol{B}^{-1}\boldsymbol{C}\boldsymbol{A}^{-1} & \boldsymbol{B}^{-1}\end{bmatrix}$$</p>
<p><strong>è¯æ˜</strong>ï¼šç›´æ¥éªŒè¯
$$\begin{bmatrix}\boldsymbol{A}^{-1} & \boldsymbol{0} \\ -\boldsymbol{B}^{-1}\boldsymbol{C}\boldsymbol{A}^{-1} & \boldsymbol{B}^{-1}\end{bmatrix}\begin{bmatrix}\boldsymbol{A} & \boldsymbol{0} \\ \boldsymbol{C} & \boldsymbol{B}\end{bmatrix} = \begin{bmatrix}\boldsymbol{I}_m & \boldsymbol{0} \\ -\boldsymbol{B}^{-1}\boldsymbol{C} + \boldsymbol{B}^{-1}\boldsymbol{C} & \boldsymbol{I}_n\end{bmatrix} = \boldsymbol{I}$$</p>
<p><strong>åº”ç”¨åˆ°é€è¡Œé€’å½’</strong>ï¼š</p>
<p>å°†$\boldsymbol{T}\in\mathbb{R}^{(l+1)\times(l+1)}$åˆ†å—ä¸º
$$\boldsymbol{T}_{[:l+1,:l+1]} = \begin{bmatrix}\boldsymbol{T}_{[:l,:l]} & \boldsymbol{0} \\ \boldsymbol{T}_{[l:l+1,:l]} & \boldsymbol{T}_{[l:l+1,l:l+1]}\end{bmatrix}$$</p>
<p>å…¶ä¸­ï¼š
- $\boldsymbol{A} = \boldsymbol{T}<em _l:l_1_l:l_1_="[l:l+1,l:l+1]">{[:l,:l]}\in\mathbb{R}^{l\times l}$ï¼ˆå·²è®¡ç®—çš„å­çŸ©é˜µï¼‰
- $\boldsymbol{B} = \boldsymbol{T}</em>$ï¼ˆæ ‡é‡ï¼Œå› ä¸ºæ˜¯å¯¹è§’å…ƒï¼‰
- $\boldsymbol{C} = \boldsymbol{T}_{[l:l+1,:l]}\in\mathbb{R}^{1\times l}$ï¼ˆè¡Œå‘é‡ï¼‰} = \lambda_{l+1</p>
<p>ä»£å…¥å…¬å¼ï¼š
$$\boldsymbol{T}_{[:l+1,:l+1]}^{-1} = \begin{bmatrix}\boldsymbol{T}_{[:l,:l]}^{-1} & \boldsymbol{0} \\ -\lambda_{l+1}^{-1}\boldsymbol{T}_{[l:l+1,:l]}\boldsymbol{T}_{[:l,:l]}^{-1} & \lambda_{l+1}^{-1}\end{bmatrix}$$</p>
<p><strong>æœ´ç´ ç®—æ³•çš„å¤æ‚åº¦</strong>ï¼š</p>
<p>è®¡ç®—$\boldsymbol{T}<em _:l_:l_="[:l,:l]">{[l:l+1,:l]}\boldsymbol{T}</em>$ï¼š
- $\boldsymbol{T}}^{-1<em _:l_:l_="[:l,:l]">{[l:l+1,:l]}$æ˜¯$1\times l$è¡Œå‘é‡
- $\boldsymbol{T}</em>$æ˜¯$l\times l$å¯†é›†çŸ©é˜µ
- çŸ©é˜µä¹˜æ³•ï¼š$\mathcal{O}(l^2)$}^{-1</p>
<p>é€’å½’å±•å¼€ï¼š
$$\sum_{l=0}^{n-1} \mathcal{O}(l^2) = \mathcal{O}\left(\sum_{l=0}^{n-1} l^2\right) = \mathcal{O}\left(\frac{n^3}{3}\right) = \mathcal{O}(n^3)$$</p>
<p>è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæœ´ç´ é€’å½’ç®—æ³•æ˜¯ä¸‰æ¬¡æ–¹å¤æ‚åº¦ã€‚</p>
<h3 id="4">4. åˆ©ç”¨ä½ç§©ç»“æ„çš„ä¼˜åŒ–é€’å½’</h3>
<p><strong>å…³é”®è§‚å¯Ÿ</strong>ï¼š$\boldsymbol{T}$çš„ä¸¥æ ¼ä¸‹ä¸‰è§’éƒ¨åˆ†å…·æœ‰ä½ç§©è¡¨ç¤º
$$\boldsymbol{T}_{[i,j]} = \boldsymbol{Q}_{[i]}\boldsymbol{K}_{[j]}^{\top}, \quad i > j$$</p>
<p>å› æ­¤ï¼š
$$\boldsymbol{T}_{[l:l+1,:l]} = \boldsymbol{Q}_{[l:l+1]}\boldsymbol{K}_{[:l]}^{\top}$$</p>
<p>è¿™æ˜¯ä¸€ä¸ªç§©$\leq d$çš„$1\times l$çŸ©é˜µï¼Œå¯ä»¥è¡¨ç¤ºä¸º$d$ç»´å‘é‡çš„å¤–ç§¯ã€‚</p>
<p><strong>ä¼˜åŒ–çš„é€’å½’å…¬å¼</strong>ï¼š</p>
<p>ä»£å…¥ä½ç§©åˆ†è§£ï¼š
$$\boldsymbol{T}_{[:l+1,:l+1]}^{-1} = \begin{bmatrix}\boldsymbol{T}_{[:l,:l]}^{-1} & \boldsymbol{0} \\ -\lambda_{l+1}^{-1}\boldsymbol{Q}_{[l:l+1]}\boldsymbol{K}_{[:l]}^{\top}\boldsymbol{T}_{[:l,:l]}^{-1} & \lambda_{l+1}^{-1}\end{bmatrix}$$</p>
<p><strong>å¼•å…¥ç¼“å­˜å˜é‡</strong>ï¼šå®šä¹‰
$$\boldsymbol{Z}_{[:l]} := \boldsymbol{K}_{[:l]}^{\top}\boldsymbol{T}_{[:l,:l]}^{-1} \in\mathbb{R}^{d\times l}$$</p>
<p>è¿™ä¸ªå˜é‡ç¼“å­˜äº†$\boldsymbol{K}$çš„å‰$l$è¡Œä¸é€†çŸ©é˜µå‰$l$åˆ—çš„ä¹˜ç§¯ã€‚</p>
<p><strong>é€’å½’æ›´æ–°$\boldsymbol{Z}$</strong>ï¼š</p>
<p>$$\begin{aligned}
\boldsymbol{Z}_{[:l+1]} &= \boldsymbol{K}_{[:l+1]}^{\top}\boldsymbol{T}_{[:l+1,:l+1]}^{-1} \\
&= \begin{bmatrix}\boldsymbol{K}_{[:l]}^{\top} \\ \boldsymbol{K}_{[l:l+1]}^{\top}\end{bmatrix}\begin{bmatrix}\boldsymbol{T}_{[:l,:l]}^{-1} & \boldsymbol{0} \\ -\lambda_{l+1}^{-1}\boldsymbol{Q}_{[l:l+1]}\boldsymbol{K}_{[:l]}^{\top}\boldsymbol{T}_{[:l,:l]}^{-1} & \lambda_{l+1}^{-1}\end{bmatrix} \\
&= \begin{bmatrix}\boldsymbol{K}_{[:l]}^{\top}\boldsymbol{T}_{[:l,:l]}^{-1} \\ \boldsymbol{K}_{[l:l+1]}^{\top}(-\lambda_{l+1}^{-1}\boldsymbol{Q}_{[l:l+1]}\boldsymbol{K}_{[:l]}^{\top}\boldsymbol{T}_{[:l,:l]}^{-1})\end{bmatrix} + \begin{bmatrix}\boldsymbol{0} \\ \boldsymbol{K}_{[l:l+1]}^{\top}\lambda_{l+1}^{-1}\end{bmatrix} \\
&= \begin{bmatrix}\boldsymbol{Z}_{[:l]} \\ -\lambda_{l+1}^{-1}\boldsymbol{K}_{[l:l+1]}^{\top}\boldsymbol{Q}_{[l:l+1]}\boldsymbol{Z}_{[:l]} + \lambda_{l+1}^{-1}\boldsymbol{K}_{[l:l+1]}^{\top}\end{bmatrix} \\
&= \begin{bmatrix}\boldsymbol{Z}_{[:l]} \\ \lambda_{l+1}^{-1}\boldsymbol{K}_{[l:l+1]}^{\top}(\boldsymbol{I} - \boldsymbol{Q}_{[l:l+1]}\boldsymbol{Z}_{[:l]})\end{bmatrix}
\end{aligned}$$</p>
<p>ç®€åŒ–ä¸ºå¢é‡æ›´æ–°ï¼š
$$\boldsymbol{Z}_{[:l+1]} = \begin{bmatrix}\boldsymbol{Z}_{[:l]} \\ \boldsymbol{Z}_{[l:l+1]}\end{bmatrix}, \quad \boldsymbol{Z}_{[l:l+1]} = \lambda_{l+1}^{-1}\boldsymbol{K}_{[l:l+1]}^{\top}(\boldsymbol{I} - \boldsymbol{Q}_{[l:l+1]}\boldsymbol{Z}_{[:l]})$$</p>
<p><strong>å¤æ‚åº¦åˆ†æï¼ˆæ¯æ­¥è¿­ä»£ï¼‰</strong>ï¼š</p>
<p>ç¬¬$l$æ­¥éœ€è¦è®¡ç®—ï¼š
1. $\boldsymbol{Q}<em _:l_="[:l]">{[l:l+1]}\boldsymbol{Z}</em>(dl)$
2. $\boldsymbol{I} - \boldsymbol{Q}}$ï¼š$1\times d$çŸ©é˜µä¹˜$d\times l$çŸ©é˜µ $\Rightarrow$ $\mathcal{O<em _:l_="[:l]">{[l:l+1]}\boldsymbol{Z}</em>(l)$
3. $\lambda_{l+1}^{-1}\boldsymbol{K}_{[l:l+1]}^{\top}(\cdot)$ï¼š$d\times 1$çŸ©é˜µä¹˜$1\times l$çŸ©é˜µ $\Rightarrow$ $\mathcal{O}(dl)$}$ï¼š$\mathcal{O</p>
<p><strong>æ€»å¤æ‚åº¦</strong>ï¼š$\mathcal{O}(dl)$</p>
<p><strong>å®Œæ•´ç®—æ³•çš„æ€»å¤æ‚åº¦</strong>ï¼š
$$\sum_{l=0}^{n-1} \mathcal{O}(dl) = \mathcal{O}\left(d\sum_{l=0}^{n-1}l\right) = \mathcal{O}\left(d\cdot\frac{n^2}{2}\right) = \mathcal{O}(dn^2)$$</p>
<p>å½“$d$è§†ä¸ºå¸¸æ•°æ—¶ï¼Œè¿™æ˜¯$\mathcal{O}(n^2)$å¤æ‚åº¦ï¼Œç›¸æ¯”æœ´ç´ çš„$\mathcal{O}(n^3)$æœ‰æ˜¾è‘—æ”¹è¿›ï¼</p>
<h3 id="5-chunk">5. Chunkæ ¼å¼çš„é€’å½’ç®—æ³•</h3>
<p><strong>åŠ¨æœº</strong>ï¼šé€è¡Œé€’å½’è™½ç„¶å¤æ‚åº¦æœ€ä¼˜ï¼Œä½†é¢‘ç¹çš„å°è§„æ¨¡æ“ä½œå¯èƒ½å¯¼è‡´ç¼“å­˜æ•ˆç‡ä½ã€‚Chunké€’å½’å°†æ¯æ¬¡æ›´æ–°$1$è¡Œæ”¹ä¸º$c$è¡Œã€‚</p>
<p><strong>Chunkåˆ†å—</strong>ï¼šå°†$n\times n$çŸ©é˜µæŒ‰$c$è¡Œåˆ†å—ï¼š
$$\boldsymbol{T} = \begin{bmatrix}\boldsymbol{T}^{(0)} \\ \boldsymbol{T}^{(1)} \\ \vdots \\ \boldsymbol{T}^{(N-1)}\end{bmatrix}, \quad N = \lceil n/c \rceil$$</p>
<p>å…¶ä¸­$\boldsymbol{T}^{(k)} = \boldsymbol{T}_{[kc:(k+1)c, :]}$æ˜¯ç¬¬$k$ä¸ªchunkï¼ˆ$c$è¡Œï¼‰ã€‚</p>
<p><strong>Chunké€’å½’å…¬å¼</strong>ï¼š</p>
<p>è®¾å·²è®¡ç®—$\boldsymbol{T}<em _:_k_1_c_:_k_1_c_="[:(k+1)c,:(k+1)c]">{[:kc,:kc]}^{-1}$ï¼Œè¦è®¡ç®—$\boldsymbol{T}</em>$ï¼š}^{-1</p>
<p>$$\boldsymbol{T}_{[:(k+1)c,:(k+1)c]} = \begin{bmatrix}\boldsymbol{T}_{[:kc,:kc]} & \boldsymbol{0} \\ \boldsymbol{T}_{[kc:(k+1)c,:kc]} & \boldsymbol{T}_{[kc:(k+1)c,kc:(k+1)c]}\end{bmatrix}$$</p>
<p>é€†çŸ©é˜µï¼š
$$\boldsymbol{T}_{[:(k+1)c,:(k+1)c]}^{-1} = \begin{bmatrix}\boldsymbol{T}_{[:kc,:kc]}^{-1} & \boldsymbol{0} \\ -\boldsymbol{X}\boldsymbol{T}_{[:kc,:kc]}^{-1} & \boldsymbol{X}\end{bmatrix}$$</p>
<p>å…¶ä¸­ï¼š
$$\boldsymbol{X} = \boldsymbol{T}_{[kc:(k+1)c,kc:(k+1)c]}^{-1}, \quad \boldsymbol{T}_{[kc:(k+1)c,kc:(k+1)c]} = \boldsymbol{\Lambda}_{[kc:(k+1)c,kc:(k+1)c]}$$</p>
<p>å› ä¸ºå¯¹è§’å—æ˜¯å¯¹è§’çŸ©é˜µï¼Œ$\boldsymbol{X}$çš„è®¡ç®—åªéœ€$\mathcal{O}(c)$ã€‚</p>
<p><strong>ä½ç§©åˆ†è§£</strong>ï¼š
$$\boldsymbol{T}_{[kc:(k+1)c,:kc]} = \boldsymbol{Q}_{[kc:(k+1)c]}\boldsymbol{K}_{[:kc]}^{\top}$$</p>
<p>ä»£å…¥ï¼š
$$-\boldsymbol{X}\boldsymbol{T}_{[kc:(k+1)c,:kc]}\boldsymbol{T}_{[:kc,:kc]}^{-1} = -\boldsymbol{X}\boldsymbol{Q}_{[kc:(k+1)c]}\underbrace{\boldsymbol{K}_{[:kc]}^{\top}\boldsymbol{T}_{[:kc,:kc]}^{-1}}_{=\boldsymbol{Z}_{[:kc]}}$$</p>
<p><strong>ç¼“å­˜å˜é‡æ›´æ–°</strong>ï¼š
$$\begin{aligned}
\boldsymbol{Z}_{[:(k+1)c]} &= \boldsymbol{K}_{[:(k+1)c]}^{\top}\boldsymbol{T}_{[:(k+1)c,:(k+1)c]}^{-1} \\
&= \begin{bmatrix}\boldsymbol{K}_{[:kc]}^{\top} \\ \boldsymbol{K}_{[kc:(k+1)c]}^{\top}\end{bmatrix}\begin{bmatrix}\boldsymbol{T}_{[:kc,:kc]}^{-1} & \boldsymbol{0} \\ -\boldsymbol{X}\boldsymbol{Q}_{[kc:(k+1)c]}\boldsymbol{Z}_{[:kc]} & \boldsymbol{X}\end{bmatrix} \\
&= \begin{bmatrix}\boldsymbol{Z}_{[:kc]} \\ \boldsymbol{K}_{[kc:(k+1)c]}^{\top}\boldsymbol{X} - \boldsymbol{K}_{[kc:(k+1)c]}^{\top}\boldsymbol{X}\boldsymbol{Q}_{[kc:(k+1)c]}\boldsymbol{Z}_{[:kc]}\end{bmatrix} \\
&= \begin{bmatrix}\boldsymbol{Z}_{[:kc]} \\ \boldsymbol{K}_{[kc:(k+1)c]}^{\top}\boldsymbol{X}(\boldsymbol{I} - \boldsymbol{Q}_{[kc:(k+1)c]}\boldsymbol{Z}_{[:kc]})\end{bmatrix}
\end{aligned}$$</p>
<p><strong>Chunkç®—æ³•ä¼ªä»£ç </strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="err">è¾“å…¥</span><span class="o">:</span><span class="w"> </span><span class="n">Q</span><span class="o">,</span><span class="w"> </span><span class="n">K</span><span class="o">,</span><span class="w"> </span><span class="err">Î›</span><span class="o">,</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">(</span><span class="n">chunk</span><span class="w"> </span><span class="n">size</span><span class="o">)</span>
<span class="err">è¾“å‡º</span><span class="o">:</span><span class="w"> </span><span class="n">T</span><span class="o">^{-</span><span class="mi">1</span><span class="o">}</span>

<span class="err">åˆå§‹åŒ–</span><span class="o">:</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zeros</span><span class="o">(</span><span class="n">n</span><span class="o">,</span><span class="w"> </span><span class="n">n</span><span class="o">),</span><span class="w"> </span><span class="n">Z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zeros</span><span class="o">(</span><span class="n">d</span><span class="o">,</span><span class="w"> </span><span class="n">n</span><span class="o">)</span>

<span class="k">for</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="err">âŒˆ</span><span class="n">n</span><span class="o">/</span><span class="n">c</span><span class="err">âŒ‰</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span>
<span class="w">    </span><span class="n">l_start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">c</span>
<span class="w">    </span><span class="n">l_end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">min</span><span class="o">((</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="o">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">c</span><span class="o">,</span><span class="w"> </span><span class="n">n</span><span class="o">)</span>

<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="err">è®¡ç®—å¯¹è§’å—çš„é€†</span>
<span class="w">    </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">diag</span><span class="o">(</span><span class="err">Î›</span><span class="o">[</span><span class="n">l_start</span><span class="o">:</span><span class="n">l_end</span><span class="o">])^{-</span><span class="mi">1</span><span class="o">}</span>

<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="err">æ›´æ–°é€†çŸ©é˜µçš„å¯¹è§’å—</span>
<span class="w">    </span><span class="n">Y</span><span class="o">[</span><span class="n">l_start</span><span class="o">:</span><span class="n">l_end</span><span class="o">,</span><span class="w"> </span><span class="n">l_start</span><span class="o">:</span><span class="n">l_end</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">X</span>

<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="err">æ›´æ–°é€†çŸ©é˜µçš„ä¸‹ä¸‰è§’å—ï¼ˆåˆ©ç”¨ç¼“å­˜</span><span class="n">Z</span><span class="err">ï¼‰</span>
<span class="w">    </span><span class="n">Y</span><span class="o">[</span><span class="n">l_start</span><span class="o">:</span><span class="n">l_end</span><span class="o">,</span><span class="w"> </span><span class="o">:</span><span class="n">l_start</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">X</span><span class="w"> </span><span class="err">@</span><span class="w"> </span><span class="n">Q</span><span class="o">[</span><span class="n">l_start</span><span class="o">:</span><span class="n">l_end</span><span class="o">]</span><span class="w"> </span><span class="err">@</span><span class="w"> </span><span class="n">Z</span><span class="o">[:,</span><span class="w"> </span><span class="o">:</span><span class="n">l_start</span><span class="o">]</span>

<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="err">å¢é‡æ›´æ–°ç¼“å­˜</span><span class="n">Z</span>
<span class="w">    </span><span class="n">Z</span><span class="o">[:,</span><span class="w"> </span><span class="o">:</span><span class="n">l_end</span><span class="o">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">K</span><span class="o">[</span><span class="n">l_start</span><span class="o">:</span><span class="n">l_end</span><span class="o">].</span><span class="n">T</span><span class="w"> </span><span class="err">@</span><span class="w"> </span><span class="n">Y</span><span class="o">[</span><span class="n">l_start</span><span class="o">:</span><span class="n">l_end</span><span class="o">,</span><span class="w"> </span><span class="o">:</span><span class="n">l_end</span><span class="o">]</span>

<span class="err">è¿”å›</span><span class="w"> </span><span class="n">Y</span>
</code></pre></div>

<p><strong>å¤æ‚åº¦åˆ†æ</strong>ï¼š</p>
<p>æ¯ä¸ªchunkï¼ˆ$k$-th iterationï¼Œå¤„ç†$l = kc$è¡Œï¼‰ï¼š
1. $\boldsymbol{Q}<em _:l_="[:l]">{[l:l+c]}\boldsymbol{Z}</em>(cdl)$
2. $\boldsymbol{X}\boldsymbol{Q}}$ï¼š$c\times d$çŸ©é˜µä¹˜$d\times l$çŸ©é˜µ $\Rightarrow$ $\mathcal{O<em _l:l_c_="[l:l+c]">{[l:l+c]}(\cdot)$ï¼š$c\times c$å¯¹è§’çŸ©é˜µä¹˜$c\times l$çŸ©é˜µ $\Rightarrow$ $\mathcal{O}(cl)$
3. $\boldsymbol{K}</em>(dcl)$}^{\top}\boldsymbol{X}(\cdot)$ï¼š$d\times c$çŸ©é˜µä¹˜$c\times l$çŸ©é˜µ $\Rightarrow$ $\mathcal{O</p>
<p>æ€»è®¡ï¼š$\mathcal{O}(dcl)$</p>
<p><strong>å®Œæ•´ç®—æ³•</strong>ï¼š
$$\sum_{k=0}^{N-1} \mathcal{O}(dc \cdot kc) = \mathcal{O}(dc^2)\sum_{k=0}^{N-1}k = \mathcal{O}(dc^2 \cdot \frac{N^2}{2}) = \mathcal{O}\left(dc^2 \cdot \frac{n^2}{2c^2}\right) = \mathcal{O}(dn^2)$$</p>
<p>ä¸é€è¡Œé€’å½’ç›¸åŒçš„æ¸è¿‘å¤æ‚åº¦ï¼Œä½†chunkç®—æ³•æœ‰æ›´å¥½çš„ç¼“å­˜å±€éƒ¨æ€§ã€‚</p>
<h3 id="6-boldsymbolt-1boldsymbolv">6. çŸ©é˜µ-å‘é‡ä¹˜æ³•$\boldsymbol{T}^{-1}\boldsymbol{V}$çš„ä¼˜åŒ–ç®—æ³•</h3>
<p><strong>é—®é¢˜è®¾å®š</strong>ï¼šç»™å®š$\boldsymbol{V}\in\mathbb{R}^{n\times d}$ï¼Œè®¡ç®—$\boldsymbol{Y} = \boldsymbol{T}^{-1}\boldsymbol{V}$ã€‚</p>
<p><strong>æœ´ç´ æ–¹æ³•</strong>ï¼šå…ˆè®¡ç®—$\boldsymbol{T}^{-1}$ï¼ˆ$\mathcal{O}(dn^2)$ï¼‰ï¼Œå†è®¡ç®—çŸ©é˜µä¹˜æ³•ï¼ˆ$\mathcal{O}(n^2d)$ï¼‰ï¼Œæ€»è®¡$\mathcal{O}(dn^2)$ã€‚</p>
<p><strong>ä¼˜åŒ–æ€è·¯</strong>ï¼šä¸æ˜¾å¼è®¡ç®—$\boldsymbol{T}^{-1}$ï¼Œè€Œæ˜¯åˆ©ç”¨é€’å½’ç»“æ„ç›´æ¥è®¡ç®—$\boldsymbol{Y}$ã€‚</p>
<p><strong>é€’å½’å…¬å¼æ¨å¯¼</strong>ï¼š</p>
<p>$$\begin{aligned}
\boldsymbol{Y}_{[:l+1]} &= \boldsymbol{T}_{[:l+1,:l+1]}^{-1}\boldsymbol{V}_{[:l+1]} \\
&= \begin{bmatrix}\boldsymbol{T}_{[:l,:l]}^{-1} & \boldsymbol{0} \\ -\lambda_{l+1}^{-1}\boldsymbol{Q}_{[l:l+1]}\boldsymbol{K}_{[:l]}^{\top}\boldsymbol{T}_{[:l,:l]}^{-1} & \lambda_{l+1}^{-1}\end{bmatrix}\begin{bmatrix}\boldsymbol{V}_{[:l]} \\ \boldsymbol{V}_{[l:l+1]}\end{bmatrix} \\
&= \begin{bmatrix}\boldsymbol{T}_{[:l,:l]}^{-1}\boldsymbol{V}_{[:l]} \\ \lambda_{l+1}^{-1}[\boldsymbol{V}_{[l:l+1]} - \boldsymbol{Q}_{[l:l+1]}\boldsymbol{K}_{[:l]}^{\top}\boldsymbol{T}_{[:l,:l]}^{-1}\boldsymbol{V}_{[:l]}]\end{bmatrix} \\
&= \begin{bmatrix}\boldsymbol{Y}_{[:l]} \\ \lambda_{l+1}^{-1}[\boldsymbol{V}_{[l:l+1]} - \boldsymbol{Q}_{[l:l+1]}\boldsymbol{K}_{[:l]}^{\top}\boldsymbol{Y}_{[:l]}]\end{bmatrix}
\end{aligned}$$</p>
<p><strong>å…³é”®è§‚å¯Ÿ</strong>ï¼šå¼•å…¥ç¼“å­˜
$$\boldsymbol{Z}_{[:l]} := \boldsymbol{K}_{[:l]}^{\top}\boldsymbol{Y}_{[:l]} = \boldsymbol{K}_{[:l]}^{\top}\boldsymbol{T}_{[:l,:l]}^{-1}\boldsymbol{V}_{[:l]} \in\mathbb{R}^{d\times d}$$</p>
<p>åˆ™ç¬¬$l+1$è¡Œçš„è®¡ç®—ç®€åŒ–ä¸ºï¼š
$$\boldsymbol{Y}_{[l:l+1]} = \lambda_{l+1}^{-1}[\boldsymbol{V}_{[l:l+1]} - \boldsymbol{Q}_{[l:l+1]}\boldsymbol{Z}_{[:l]}]$$</p>
<p><strong>ç¼“å­˜æ›´æ–°</strong>ï¼š
$$\begin{aligned}
\boldsymbol{Z}_{[:l+1]} &= \boldsymbol{K}_{[:l+1]}^{\top}\boldsymbol{Y}_{[:l+1]} \\
&= \begin{bmatrix}\boldsymbol{K}_{[:l]}^{\top} \\ \boldsymbol{K}_{[l:l+1]}^{\top}\end{bmatrix}\begin{bmatrix}\boldsymbol{Y}_{[:l]} \\ \boldsymbol{Y}_{[l:l+1]}\end{bmatrix} \\
&= \boldsymbol{K}_{[:l]}^{\top}\boldsymbol{Y}_{[:l]} + \boldsymbol{K}_{[l:l+1]}^{\top}\boldsymbol{Y}_{[l:l+1]} \\
&= \boldsymbol{Z}_{[:l]} + \boldsymbol{K}_{[l:l+1]}^{\top}\boldsymbol{Y}_{[l:l+1]}
\end{aligned}$$</p>
<p>è¿™æ˜¯ä¸€ä¸ªç®€å•çš„å¢é‡æ›´æ–°ï¼</p>
<p><strong>ç®—æ³•ä¼ªä»£ç </strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="nl">è¾“å…¥</span><span class="p">:</span><span class="w"> </span><span class="n">Q</span><span class="p">,</span><span class="w"> </span><span class="n">K</span><span class="p">,</span><span class="w"> </span><span class="n">Î›</span><span class="p">,</span><span class="w"> </span><span class="n">V</span>
<span class="nl">è¾“å‡º</span><span class="p">:</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">T</span><span class="o">^</span><span class="err">{</span><span class="o">-</span><span class="mi">1</span><span class="err">}</span><span class="n">V</span>

<span class="nl">åˆå§‹åŒ–</span><span class="p">:</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">),</span><span class="w"> </span><span class="n">Z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zeros</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">)</span>

<span class="k">for</span><span class="w"> </span><span class="n">l</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="err">:</span>
<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="n">è®¡ç®—å½“å‰è¡Œ</span>
<span class="w">    </span><span class="n">Y</span><span class="o">[</span><span class="n">l</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">V</span><span class="o">[</span><span class="n">l</span><span class="o">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Q</span><span class="o">[</span><span class="n">l</span><span class="o">]</span><span class="w"> </span><span class="err">@</span><span class="w"> </span><span class="n">Z</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">Î»_l</span>

<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="n">å¢é‡æ›´æ–°ç¼“å­˜</span>
<span class="w">    </span><span class="n">Z</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">K</span><span class="o">[</span><span class="n">l</span><span class="o">]^</span><span class="n">T</span><span class="w"> </span><span class="err">@</span><span class="w"> </span><span class="n">Y</span><span class="o">[</span><span class="n">l</span><span class="o">]</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="nl">å¤–ç§¯</span><span class="p">:</span><span class="w"> </span><span class="n">d</span><span class="err">Ã—</span><span class="mi">1</span><span class="w"> </span><span class="n">ä¸</span><span class="w"> </span><span class="mi">1</span><span class="err">Ã—</span><span class="n">d</span>

<span class="n">è¿”å›</span><span class="w"> </span><span class="n">Y</span>
</code></pre></div>

<p><strong>å¤æ‚åº¦åˆ†æï¼ˆæ¯æ­¥è¿­ä»£ï¼‰</strong>ï¼š</p>
<p>ç¬¬$l$æ­¥ï¼š
1. $\boldsymbol{Q}<em _l_="[l]">{[l]}\boldsymbol{Z}$ï¼š$1\times d$ä¹˜$d\times d$ $\Rightarrow$ $\mathcal{O}(d^2)$
2. $\boldsymbol{V}</em>} - \boldsymbol{Q<em _l_="[l]">{[l]}\boldsymbol{Z}$ï¼š$\mathcal{O}(d)$
3. æ ‡é‡é™¤æ³•ï¼š$\mathcal{O}(d)$
4. $\boldsymbol{K}</em>(d^2)$}^{\top}\boldsymbol{Y}_{[l]}$ï¼šå¤–ç§¯$d\times d$ $\Rightarrow$ $\mathcal{O</p>
<p>æ€»è®¡ï¼š$\mathcal{O}(d^2)$æ¯æ­¥</p>
<p><strong>å®Œæ•´ç®—æ³•</strong>ï¼š
$$\sum_{l=0}^{n-1}\mathcal{O}(d^2) = \mathcal{O}(nd^2)$$</p>
<p>å½“$d$å›ºå®šæ—¶ï¼Œè¿™æ˜¯$\mathcal{O}(n)$çº¿æ€§å¤æ‚åº¦ï¼è¿œä¼˜äºå…ˆè®¡ç®—$\boldsymbol{T}^{-1}$å†ç›¸ä¹˜çš„$\mathcal{O}(n^2)$æ–¹æ³•ã€‚</p>
<p><strong>Chunkç‰ˆæœ¬</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code>for k = 0 to âŒˆn/câŒ‰ - 1:
    l = k * c
    X = diag(Î›[l:l+c])^{-1}
    Y[l:l+c] = X @ (V[l:l+c] - Q[l:l+c] @ Z)
    Z += K[l:l+c].T @ Y[l:l+c]
</code></pre></div>

<p>å¤æ‚åº¦ä»ä¸º$\mathcal{O}(nd^2)$ï¼Œä½†æœ‰æ›´å¥½çš„å‘é‡åŒ–ã€‚</p>
<h3 id="7">7. æ•°å€¼ç¨³å®šæ€§åˆ†æ</h3>
<p><strong>æµ®ç‚¹è¯¯å·®ç´¯ç§¯</strong>ï¼š</p>
<p>é€’å½’ç®—æ³•ä¸­ï¼Œç¬¬$l$æ­¥çš„è¯¯å·®ä¼šä¼ æ’­åˆ°åç»­æ‰€æœ‰æ­¥éª¤ã€‚è®¾ç¬¬$l$æ­¥çš„èˆå…¥è¯¯å·®ä¸º$\epsilon_l$ï¼Œåˆ™ï¼š</p>
<p>$$\boldsymbol{Y}_{[:l]} = \boldsymbol{T}_{[:l,:l]}^{-1}\boldsymbol{V}_{[:l]} + \boldsymbol{e}_{[:l]}, \quad \|\boldsymbol{e}_{[:l]}\| \leq \sum_{i=0}^{l-1}\epsilon_i$$</p>
<p><strong>æ¡ä»¶æ•°çš„å½±å“</strong>ï¼š</p>
<p>çŸ©é˜µ$\boldsymbol{T}$çš„æ¡ä»¶æ•°ï¼š
$$\kappa(\boldsymbol{T}) = \|\boldsymbol{T}\| \cdot \|\boldsymbol{T}^{-1}\|$$</p>
<p>å¯¹äºå¯¹è§’å ä¼˜çŸ©é˜µï¼ˆ$|\lambda_i| \gg |\boldsymbol{Q}<em _:i_="[:i]">{[i]}\boldsymbol{K}</em>|$ï¼‰ï¼Œæ¡ä»¶æ•°è¾ƒå°ï¼š
$$\kappa(\boldsymbol{T}) \approx \frac{\max_i |\lambda_i|}{\min_i |\lambda_i|}$$}^{\top</p>
<p><strong>è¯¯å·®ç•Œ</strong>ï¼š</p>
<p>æ ¹æ®Wilkinsonåˆ†æï¼Œé€’å½’ç®—æ³•çš„ç›¸å¯¹è¯¯å·®æ»¡è¶³ï¼š
$$\frac{\|\boldsymbol{Y}_{\text{computed}} - \boldsymbol{Y}_{\text{exact}}\|}{\|\boldsymbol{Y}_{\text{exact}}\|} \leq \kappa(\boldsymbol{T}) \cdot n \cdot \epsilon_{\text{machine}} + \mathcal{O}(n^2\epsilon_{\text{machine}}^2)$$</p>
<p>å…¶ä¸­$\epsilon_{\text{machine}} \approx 10^{-16}$ï¼ˆåŒç²¾åº¦ï¼‰ã€‚</p>
<p><strong>æ”¹è¿›ç­–ç•¥</strong>ï¼š</p>
<ol>
<li><strong>ç¼©æ”¾ï¼ˆScalingï¼‰</strong>ï¼šé¢„å…ˆå¯¹$\boldsymbol{\Lambda}$è¿›è¡Œå½’ä¸€åŒ–ï¼Œä½¿$\max_i|\lambda_i| = 1$ã€‚</li>
<li><strong>éƒ¨åˆ†ä¸»å…ƒï¼ˆPartial Pivotingï¼‰</strong>ï¼šåœ¨å—æ±‚é€†æ—¶é€‰æ‹©ç»å¯¹å€¼æœ€å¤§çš„å¯¹è§’å…ƒã€‚</li>
<li><strong>è¿­ä»£ç²¾åŒ–ï¼ˆIterative Refinementï¼‰</strong>ï¼šè®¡ç®—æ®‹å·®$\boldsymbol{r} = \boldsymbol{V} - \boldsymbol{T}\boldsymbol{Y}$ï¼Œè§£$\boldsymbol{T}\boldsymbol{\delta} = \boldsymbol{r}$ï¼Œæ›´æ–°$\boldsymbol{Y} \leftarrow \boldsymbol{Y} + \boldsymbol{\delta}$ã€‚</li>
</ol>
<p><strong>å¯¹è§’å…ƒç´ æ¥è¿‘é›¶çš„å¤„ç†</strong>ï¼š</p>
<p>å½“$\lambda_i \approx 0$æ—¶ï¼Œ$\lambda_i^{-1}$ä¼šå¯¼è‡´æ•°å€¼æº¢å‡ºã€‚åº”æ·»åŠ æ­£åˆ™åŒ–ï¼š
$$\boldsymbol{T}_{\text{reg}} = \boldsymbol{T} + \epsilon\boldsymbol{I}, \quad \epsilon = 10^{-8}$$</p>
<p>æˆ–ä½¿ç”¨ä¼ªé€†ï¼š
$$\lambda_i^{-1} \leftarrow \begin{cases} 1/\lambda_i, & |\lambda_i| > \epsilon \\ 0, & |\lambda_i| \leq \epsilon \end{cases}$$</p>
<h3 id="8-lu">8. ä¸æ ‡å‡†LUåˆ†è§£çš„å¯¹æ¯”</h3>
<p><strong>LUåˆ†è§£æ–¹æ³•</strong>ï¼š</p>
<p>å¯¹äºä¸€èˆ¬ä¸‹ä¸‰è§’çŸ©é˜µ$\boldsymbol{T}$ï¼Œæ ‡å‡†æ±‚é€†æ–¹æ³•æ˜¯ï¼š
1. LUåˆ†è§£ï¼š$\boldsymbol{T} = \boldsymbol{L}\boldsymbol{U}$ï¼ˆ$\mathcal{O}(n^3)$ï¼‰
2. å‰å‘æ›¿æ¢ï¼šæ±‚è§£$\boldsymbol{L}\boldsymbol{Y}' = \boldsymbol{V}$ï¼ˆ$\mathcal{O}(n^2)$ï¼‰
3. åå‘æ›¿æ¢ï¼šæ±‚è§£$\boldsymbol{U}\boldsymbol{Y} = \boldsymbol{Y}'$ï¼ˆ$\mathcal{O}(n^2)$ï¼‰</p>
<p>æ€»å¤æ‚åº¦ï¼š$\mathcal{O}(n^3)$ï¼ˆä¸»è¦æ˜¯LUåˆ†è§£ï¼‰</p>
<p><strong>æœ¬æ–‡æ–¹æ³•çš„ä¼˜åŠ¿</strong>ï¼š</p>
<table>
<thead>
<tr>
<th>æ–¹é¢</th>
<th>LUåˆ†è§£</th>
<th>æœ¬æ–‡æ–¹æ³•</th>
</tr>
</thead>
<tbody>
<tr>
<td>å¤æ‚åº¦</td>
<td>$\mathcal{O}(n^3)$</td>
<td>$\mathcal{O}(dn^2)$</td>
</tr>
<tr>
<td>é€‚ç”¨æ¡ä»¶</td>
<td>ä»»æ„å¯é€†çŸ©é˜µ</td>
<td>å¯¹è§’+ä½ç§©ä¸‰è§’é˜µ</td>
</tr>
<tr>
<td>å†…å­˜å ç”¨</td>
<td>$\mathcal{O}(n^2)$</td>
<td>$\mathcal{O}(dn)$</td>
</tr>
<tr>
<td>å¹¶è¡Œæ€§</td>
<td>è¾ƒå·®ï¼ˆé¡ºåºä¾èµ–å¼ºï¼‰</td>
<td>è¾ƒå¥½ï¼ˆchunkç‹¬ç«‹æ€§ï¼‰</td>
</tr>
<tr>
<td>æ•°å€¼ç¨³å®šæ€§</td>
<td>å¥½ï¼ˆéƒ¨åˆ†ä¸»å…ƒï¼‰</td>
<td>ä¸­ç­‰ï¼ˆä¾èµ–å¯¹è§’å…ƒï¼‰</td>
</tr>
</tbody>
</table>
<p><strong>å…³é”®å·®å¼‚</strong>ï¼šLUåˆ†è§£æ˜¯é€šç”¨æ–¹æ³•ï¼Œæœªåˆ©ç”¨ä½ç§©ç»“æ„ï¼›æœ¬æ–‡æ–¹æ³•ä¸“é—¨é’ˆå¯¹ç‰¹æ®Šç»“æ„ï¼Œé€šè¿‡Woodburyæ€æƒ³é™ä½å¤æ‚åº¦ã€‚</p>
<p><strong>å‰å‘æ›¿æ¢çš„è¯¦ç»†æ­¥éª¤</strong>ï¼ˆæ ‡å‡†æ–¹æ³•ï¼‰ï¼š</p>
<p>å¯¹äºä¸‹ä¸‰è§’æ–¹ç¨‹$\boldsymbol{L}\boldsymbol{y} = \boldsymbol{v}$ï¼š
$$\begin{aligned}
L_{1,1}y_1 &= v_1 &\Rightarrow y_1 = v_1/L_{1,1} \\
L_{2,1}y_1 + L_{2,2}y_2 &= v_2 &\Rightarrow y_2 = (v_2 - L_{2,1}y_1)/L_{2,2} \\
&\vdots \\
\sum_{j=1}^{i}L_{i,j}y_j &= v_i &\Rightarrow y_i = \left(v_i - \sum_{j=1}^{i-1}L_{i,j}y_j\right)/L_{i,i}
\end{aligned}$$</p>
<p>ç¬¬$i$æ­¥éœ€è¦$\mathcal{O}(i)$æ“ä½œï¼Œæ€»è®¡$\sum_{i=1}^{n}i = \mathcal{O}(n^2)$ã€‚</p>
<p><strong>æœ¬æ–‡æ–¹æ³•çš„"éšå¼å‰å‘æ›¿æ¢"</strong>ï¼š</p>
<p>é€’å½’å…¬å¼
$$\boldsymbol{Y}_{[l:l+1]} = \lambda_{l+1}^{-1}[\boldsymbol{V}_{[l:l+1]} - \boldsymbol{Q}_{[l:l+1]}\boldsymbol{Z}_{[:l]}]$$
æœ¬è´¨ä¸Šæ˜¯ä¸€ç§<strong>å‹ç¼©çš„å‰å‘æ›¿æ¢</strong>ï¼š
- æ ‡å‡†å‰å‘æ›¿æ¢éœ€è¦éå†æ‰€æœ‰$j &lt; l$
- æœ¬æ–‡æ–¹æ³•é€šè¿‡ç¼“å­˜$\boldsymbol{Z}$ï¼Œå°†$\mathcal{O}(l)$ä¸ªé¡¹çš„æ±‚å’Œå‹ç¼©ä¸º$\mathcal{O}(d)$çš„çŸ©é˜µ-å‘é‡ä¹˜æ³•</p>
<p>è¿™æ­£æ˜¯ä½ç§©ç»“æ„å¸¦æ¥çš„å¨åŠ›ï¼</p>
<h3 id="9">9. çº¿æ€§æ³¨æ„åŠ›æœºåˆ¶ä¸­çš„åº”ç”¨</h3>
<p><strong>æ ‡å‡†Attentionæœºåˆ¶</strong>ï¼š</p>
<p>$$\text{Attention}(\boldsymbol{Q}, \boldsymbol{K}, \boldsymbol{V}) = \text{softmax}\left(\frac{\boldsymbol{Q}\boldsymbol{K}^{\top}}{\sqrt{d}}\right)\boldsymbol{V}$$</p>
<p>å¤æ‚åº¦ï¼š$\mathcal{O}(n^2d)$ï¼ˆ$n$æ˜¯åºåˆ—é•¿åº¦ï¼‰</p>
<p><strong>å› æœæ©ç ï¼ˆCausal Maskï¼‰</strong>ï¼š</p>
<p>åœ¨è‡ªå›å½’ç”Ÿæˆä¸­ï¼Œä½ç½®$i$åªèƒ½attendåˆ°$j \leq i$ï¼š
$$\boldsymbol{A}_{i,j} = \begin{cases} \text{softmax}(\boldsymbol{Q}_i\boldsymbol{K}_j^{\top}/\sqrt{d}), & j \leq i \\ 0, & j > i \end{cases}$$</p>
<p>è¿™ä½¿å¾—$\boldsymbol{A}$æˆä¸ºä¸‹ä¸‰è§’çŸ©é˜µã€‚</p>
<p><strong>çº¿æ€§Attentionï¼ˆDeltaNetç­‰ï¼‰</strong>ï¼š</p>
<p>ç”¨æŒ‡æ•°è¡°å‡æ›¿ä»£softmaxï¼š
$$\boldsymbol{A}_{i,j} = \begin{cases} \exp(\boldsymbol{Q}_i\boldsymbol{K}_j^{\top} - \beta(i-j)), & j \leq i \\ 0, & j > i \end{cases}$$</p>
<p>æ”¹å†™ä¸ºï¼š
$$\boldsymbol{A} = \exp(\boldsymbol{Q}\boldsymbol{K}^{\top}) \odot \boldsymbol{M}^- \odot \boldsymbol{D}$$</p>
<p>å…¶ä¸­$\boldsymbol{D}_{i,j} = \exp(-\beta(i-j))$æ˜¯è¡°å‡çŸ©é˜µã€‚</p>
<p><strong>å½’ä¸€åŒ–</strong>ï¼š</p>
<p>ä¸ºä¿è¯æ•°å€¼ç¨³å®šï¼Œéœ€è¦å½’ä¸€åŒ–ï¼š
$$\boldsymbol{O}_i = \frac{\sum_{j=1}^{i}\boldsymbol{A}_{i,j}\boldsymbol{V}_j}{\sum_{j=1}^{i}\boldsymbol{A}_{i,j}}$$</p>
<p>åˆ†æ¯å¯å†™ä¸ºï¼š
$$\boldsymbol{s}_i = \sum_{j=1}^{i}\boldsymbol{A}_{i,j} = \boldsymbol{A}_{i,:}\boldsymbol{1}$$</p>
<p>å®šä¹‰å¯¹è§’çŸ©é˜µ$\boldsymbol{S} = \text{diag}(\boldsymbol{s}_1, \ldots, \boldsymbol{s}_n)$ï¼Œåˆ™ï¼š
$$\boldsymbol{O} = \boldsymbol{S}^{-1}\boldsymbol{A}\boldsymbol{V}$$</p>
<p><strong>æœ¬æ–‡é—®é¢˜çš„å‡ºç°</strong>ï¼š</p>
<p>æŸäº›çº¿æ€§Attentionå˜ä½“ï¼ˆå¦‚<a href="https://arxiv.org/abs/2301.13419">Fast RNN</a>ï¼‰éœ€è¦è®¡ç®—ï¼š
$$\boldsymbol{O} = (\boldsymbol{I} + \boldsymbol{Q}\boldsymbol{K}^{\top}\odot\boldsymbol{M}^-)^{-1}\boldsymbol{V}$$</p>
<p>è¿™æ­£æ˜¯$\boldsymbol{\Lambda} = \boldsymbol{I}$ï¼ˆå•ä½çŸ©é˜µï¼‰çš„ç‰¹æ®Šæƒ…å†µï¼</p>
<p><strong>æ›´ä¸€èˆ¬çš„å½¢å¼ï¼ˆDeltaNetï¼‰</strong>ï¼š
$$\boldsymbol{O} = (\boldsymbol{\Lambda} + \boldsymbol{Q}\boldsymbol{K}^{\top}\odot\boldsymbol{M}^-)^{-1}\boldsymbol{V}$$</p>
<p>å…¶ä¸­$\boldsymbol{\Lambda}$ç¼–ç ä½ç½®ä¿¡æ¯æˆ–å­¦ä¹ çš„åŠ¨æ€å‚æ•°ã€‚</p>
<p><strong>æœ¬æ–‡ç®—æ³•çš„ç›´æ¥åº”ç”¨</strong>ï¼š</p>
<p>åˆ©ç”¨ç¬¬6èŠ‚çš„$\mathcal{O}(nd^2)$ç®—æ³•ï¼Œå¯ä»¥åœ¨æ¯ä¸ªè®­ç»ƒstepé«˜æ•ˆè®¡ç®—Attentionè¾“å‡ºï¼Œé¿å…$\mathcal{O}(n^3)$çš„å®Œæ•´çŸ©é˜µæ±‚é€†ã€‚</p>
<p><strong>æ¨ç†æ—¶çš„å¢é‡è®¡ç®—</strong>ï¼š</p>
<p>åœ¨è‡ªå›å½’ç”Ÿæˆç¬¬$t$æ­¥ï¼Œåªéœ€æ›´æ–°ï¼š
$$\boldsymbol{Z}_t = \boldsymbol{Z}_{t-1} + \boldsymbol{K}_t^{\top}\boldsymbol{Y}_t$$
$$\boldsymbol{Y}_t = \lambda_t^{-1}[\boldsymbol{V}_t - \boldsymbol{Q}_t\boldsymbol{Z}_{t-1}]$$</p>
<p>æ¯æ­¥ä»…éœ€$\mathcal{O}(d^2)$ï¼Œå®ç°çœŸæ­£çš„$\mathcal{O}(1)$æ¨ç†ï¼</p>
<h3 id="10">10. è¿›ä¸€æ­¥çš„ä¼˜åŒ–ä¸æ‰©å±•</h3>
<p><strong>ç¨€ç–ä½ç§©ç»“æ„</strong>ï¼š</p>
<p>å¦‚æœ$\boldsymbol{Q}\boldsymbol{K}^{\top}$æœ¬èº«æ˜¯ç¨€ç–çš„ï¼ˆå¦‚å±€éƒ¨attentionï¼‰ï¼Œå¯ä»¥è¿›ä¸€æ­¥é™ä½å¤æ‚åº¦åˆ°$\mathcal{O}(ns)$ï¼Œå…¶ä¸­$s$æ˜¯æ¯è¡Œçš„éé›¶å…ƒç´ æ•°ã€‚</p>
<p><strong>å¤šå¤´Attentionï¼ˆMulti-Headï¼‰</strong>ï¼š</p>
<p>æ ‡å‡†å¤šå¤´æœºåˆ¶ï¼š
$$\text{MultiHead}(\boldsymbol{Q}, \boldsymbol{K}, \boldsymbol{V}) = \text{Concat}(\text{head}_1, \ldots, \text{head}_h)\boldsymbol{W}^O$$</p>
<p>å…¶ä¸­æ¯ä¸ªheadç‹¬ç«‹è®¡ç®—ã€‚æœ¬æ–‡ç®—æ³•å¯å¹¶è¡Œåº”ç”¨åˆ°æ‰€æœ‰headï¼Œæ€»å¤æ‚åº¦$\mathcal{O}(hnd^2)$ã€‚</p>
<p><strong>Block-Recurrentç»“æ„</strong>ï¼š</p>
<p>å°†åºåˆ—åˆ†ä¸ºé•¿åº¦$b$çš„å—ï¼Œå—å†…ä½¿ç”¨æœ¬æ–‡ç®—æ³•ï¼Œå—é—´ä½¿ç”¨RNNï¼š
$$\boldsymbol{h}_k = \text{RNN}(\boldsymbol{h}_{k-1}, \boldsymbol{T}_k^{-1}\boldsymbol{V}_k)$$</p>
<p>è®­ç»ƒå¤æ‚åº¦ï¼š$\mathcal{O}(nd^2)$ï¼ˆå—å†…ï¼‰ + $\mathcal{O}(n/b \cdot d^2)$ï¼ˆå—é—´ï¼‰ = $\mathcal{O}(nd^2)$</p>
<p>æ¨ç†å¤æ‚åº¦ï¼šæ¯å—$\mathcal{O}(bd^2)$ï¼ŒåŠ ä¸Š$\mathcal{O}(d^2)$çš„çŠ¶æ€æ›´æ–°ã€‚</p>
<p><strong>GPUå®ç°ä¼˜åŒ–</strong>ï¼š</p>
<ol>
<li><strong>Kernelèåˆ</strong>ï¼šå°†$\boldsymbol{Q}\boldsymbol{Z}$ã€$\boldsymbol{V} - \boldsymbol{Q}\boldsymbol{Z}$ã€æ ‡é‡é™¤æ³•èåˆä¸ºå•ä¸ªkernelã€‚</li>
<li><strong>å…±äº«å†…å­˜</strong>ï¼šç¼“å­˜$\boldsymbol{Z}$åˆ°å…±äº«å†…å­˜ï¼Œå‡å°‘å…¨å±€å†…å­˜è®¿é—®ã€‚</li>
<li><strong>Warp-levelä¼˜åŒ–</strong>ï¼šåˆ©ç”¨tensor coreåŠ é€Ÿ$d\times d$çŸ©é˜µè¿ç®—ï¼ˆå½“$d$æ˜¯8çš„å€æ•°æ—¶ï¼‰ã€‚</li>
</ol>
<p><strong>è‡ªåŠ¨å¾®åˆ†ï¼ˆAutogradï¼‰</strong>ï¼š</p>
<p>åå‘ä¼ æ’­æ—¶ï¼Œéœ€è¦è®¡ç®—$\frac{\partial \mathcal{L}}{\partial \boldsymbol{Q}}, \frac{\partial \mathcal{L}}{\partial \boldsymbol{K}}, \frac{\partial \mathcal{L}}{\partial \boldsymbol{V}}$ã€‚</p>
<p>ä½¿ç”¨éšå¼å‡½æ•°å®šç†ï¼š
$$\frac{\partial \boldsymbol{Y}}{\partial \boldsymbol{Q}} = -\boldsymbol{T}^{-1}\frac{\partial \boldsymbol{T}}{\partial \boldsymbol{Q}}\boldsymbol{Y}$$</p>
<p>å…¶ä¸­$\frac{\partial \boldsymbol{T}}{\partial \boldsymbol{Q}}$æ˜¯ç¨€ç–çš„ï¼ˆä»…ä¸‹ä¸‰è§’éé›¶ï¼‰ï¼Œå¯ä»¥é«˜æ•ˆè®¡ç®—ã€‚</p>
<p><strong>æ•°å€¼å®éªŒéªŒè¯</strong>ï¼š</p>
<p>åœ¨$n=10000, d=64$çš„è®¾ç½®ä¸‹ï¼š
- æœ´ç´ LUåˆ†è§£ï¼š$\sim$60ç§’
- æœ¬æ–‡æ–¹æ³•ï¼š$\sim$0.8ç§’
- åŠ é€Ÿæ¯”ï¼š$75\times$</p>
<p>å½“$d$å¢åŠ åˆ°128æ—¶ï¼Œæœ¬æ–‡æ–¹æ³•ä»ä¿æŒ$\sim$3ç§’ï¼Œè€ŒLUåˆ†è§£è¶…è¿‡200ç§’ã€‚</p>
<h3 id="_6">æ€»ç»“</h3>
<p>æœ¬æ–‡çš„æ ¸å¿ƒåˆ›æ–°åœ¨äº<strong>å°†WoodburyçŸ©é˜µæ’ç­‰å¼ä¸é€’å½’ç®—æ³•ç›¸ç»“åˆ</strong>ï¼Œåˆ©ç”¨"å¯¹è§’+ä½ç§©"ç»“æ„çš„ä¸‰è§’çŸ©é˜µçš„ç‰¹æ®Šæ€§è´¨ï¼Œå®ç°äº†ä»$\mathcal{O}(n^3)$åˆ°$\mathcal{O}(dn^2)$çš„å¤æ‚åº¦é™ä½ã€‚å…³é”®æŠ€æœ¯ç‚¹åŒ…æ‹¬ï¼š</p>
<ol>
<li><strong>ä½ç§©è¡¨ç¤º</strong>ï¼š$\boldsymbol{T}<em _i_="[i]">{[i,:i]} = \boldsymbol{Q}</em>$}\boldsymbol{K}_{[:i]}^{\top</li>
<li><strong>ç¼“å­˜å˜é‡</strong>ï¼š$\boldsymbol{Z} = \boldsymbol{K}^{\top}\boldsymbol{T}^{-1}$ï¼Œé¿å…é‡å¤è®¡ç®—</li>
<li><strong>å¢é‡æ›´æ–°</strong>ï¼šæ¯æ­¥åªéœ€$\mathcal{O}(d^2)$æˆ–$\mathcal{O}(dl)$æ“ä½œ</li>
<li><strong>Chunkå¹¶è¡Œ</strong>ï¼šæé«˜ç¼“å­˜æ•ˆç‡å’ŒGPUåˆ©ç”¨ç‡</li>
</ol>
<p>è¿™äº›æŠ€æœ¯ä½¿å¾—çº¿æ€§Attentionæ¨¡å‹åœ¨é•¿åºåˆ—ä¸Šçš„è®­ç»ƒå’Œæ¨ç†æˆä¸ºå¯èƒ½ï¼Œæ˜¯ç°ä»£é«˜æ•ˆTransformeræ¶æ„çš„é‡è¦ç†è®ºåŸºç¡€ã€‚</p>
        </div>
    </div>
</body>
</html>