<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MoEç¯æ¸¸è®°ï¼š3ã€æ¢ä¸ªæ€è·¯æ¥åˆ†é…</title>
    <style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    line-height: 1.6; color: #333; max-width: 900px; margin: 0 auto; padding: 20px; background: #f5f5f5;
}
.container { background: white; padding: 40px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
header { border-bottom: 2px solid #e0e0e0; padding-bottom: 20px; margin-bottom: 30px; }
h1 { color: #2c3e50; margin-bottom: 10px; font-size: 2em; }
.meta { color: #666; font-size: 0.9em; margin-bottom: 20px; }
.content { margin-top: 30px; overflow-wrap: break-word; }
.content h2 { color: #34495e; margin-top: 30px; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
.content p { margin-bottom: 15px; }
.content pre { background: #f8f8f8; padding: 15px; border-radius: 5px; overflow-x: auto; border-left: 3px solid #3498db; margin: 15px 0; }
.content code { background: #f8f8f8; padding: 2px 5px; border-radius: 3px; font-family: monospace; font-size: 0.9em; }
.content blockquote { border-left: 4px solid #3498db; padding-left: 20px; margin: 20px 0; color: #555; font-style: italic; }
.content table { border-collapse: collapse; width: 100%; margin: 20px 0; }
.content th, .content td { border: 1px solid #ddd; padding: 10px; text-align: left; }
.back-link { display: inline-block; margin-bottom: 20px; color: #3498db; text-decoration: none; font-weight: 500; }
</style>
    
<script>
    window.MathJax = {
        tex: {
            inlineMath: [['$', '$'], ['\(', '\)']],
            displayMath: [['$$', '$$'], ['\[', '\]']],
            processEscapes: true
        }
    };
</script>
<script id="MathJax-script" async src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>

</head>
<body>
    <div class="container">
        <a href="../index.html" class="back-link">â† è¿”å›é¦–é¡µ</a>
        <header>
            <h1>MoEç¯æ¸¸è®°ï¼š3ã€æ¢ä¸ªæ€è·¯æ¥åˆ†é…</h1>
            <div class="meta">ğŸ“… æœ€åæ›´æ–°: 2025-11-24 | ğŸ“„ å¤§å°: 76.3 KB</div>
        </header>
        <div class="content">
            <p><strong>åŸæ–‡é“¾æ¥</strong>: <a href="https://spaces.ac.cn/archives/10757">https://spaces.ac.cn/archives/10757</a></p>
<p><strong>å‘å¸ƒæ—¥æœŸ</strong>: </p>
<hr />
<p>è¿™ç¯‡æ–‡ç« æˆ‘ä»¬ç»§ç»­æ¢è®¨MoEçš„è´Ÿè½½å‡è¡¡é—®é¢˜ã€‚åœ¨ä¸Šä¸€ç¯‡æ–‡ç« <a href="/archives/10735">ã€ŠMoEç¯æ¸¸è®°ï¼š2ã€ä¸æ‚£å¯¡è€Œæ‚£ä¸å‡ã€‹</a>ä¸­ï¼Œæˆ‘ä»¬ä¸»è¦è®¨è®ºäº†é€šè¿‡Aux Lossæ¥ä¿ƒè¿›è´Ÿè½½å‡è¡¡çš„æ€è·¯ã€‚Aux Losså›ºç„¶ç®€å•ç›´è§‚ï¼Œä½†å®ƒä¹Ÿæœ‰ä¸€ä¸ªæ˜æ˜¾çš„ç¼ºç‚¹â€”â€”æƒé‡ä¸å¥½è°ƒâ€”â€”è°ƒä½äº†æ— æ³•ä¿ƒè¿›å‡è¡¡ï¼Œè°ƒé«˜äº†å®¹æ˜“æŸå®³LM Lossï¼Œæ‰€ä»¥ä¸šç•Œä¸€ç›´æœ‰å¯»æ‰¾æ›¿ä»£æ–¹æ¡ˆçš„å°è¯•ã€‚</p>
<p>æœ¬æ–‡è¦åˆ†äº«çš„æ˜¯åä¸ºâ€œLoss-Freeâ€çš„æ–¹æ¡ˆï¼Œç”±DeepSeekåœ¨<a href="https://papers.cool/arxiv/2408.15664">ã€ŠAuxiliary-Loss-Free Load Balancing Strategy for Mixture-of-Expertsã€‹</a>æå‡ºã€‚å’ŒDeepSeekä¼—å¤šè€€çœ¼çš„å¼€æºä½œå“ç›¸æ¯”ï¼Œè¿™ç¯‡è®ºæ–‡ä¹Ÿè®¸ä¸ç®—èµ·çœ¼ï¼Œä½†åœ¨ç¬”è€…çœ‹æ¥ï¼Œå®ƒæ½œåœ¨çš„å­¦æœ¯å½±å“åŠ›å¯èƒ½è¿œè¶…å…¶ä»–å·¥ä½œï¼Œå› ä¸ºæ‰€ææ–¹æ³•ä¸ä»…ç®€å•æœ‰æ•ˆï¼Œè€Œä¸”æå…·æ™®é€‚æ€§ï¼Œå ªç§°ç»å…¸ã€‚</p>
<h2 id="_1">æ–¹æ³•å¤§æ„</h2>
<p>é¢å¯¹è´Ÿè½½ä¸å‡è¡¡ï¼ŒAux Lossçš„åº”å¯¹æ€è·¯æ˜¯é€šè¿‡é¢å¤–çš„æŸå¤±å¼•å¯¼Routerç»™å‡ºå‡è¡¡çš„æ‰“åˆ†ï¼Œè€ŒLoss-Freeçš„æƒ³æ³•åˆ™æ˜¯æ¢ä¸ªæ–°çš„åˆ†é…æ€è·¯ï¼Œå³ä¸æ”¹å˜Routerç°æœ‰æ‰“åˆ†ç»“æœï¼Œè€Œæ˜¯æ”¹å˜$\mathop{\text{argtop}}_k \boldsymbol{\rho}$è¿™ä¸ªåˆ†é…æ–¹å¼ã€‚</p>
<p>å…¶å®è¿™ä¸ªæ–¹å‘æ­¤å‰ä¹Ÿæœ‰è¿‡ä¸€äº›åŠªåŠ›ã€‚æ¯”å¦‚2021å¹´Facebookæå‡ºäº†<a href="https://papers.cool/arxiv/2103.16716">BASE Layer</a>ï¼Œå°†Expertçš„åˆ†é…è§†ä¸º<a href="https://en.wikipedia.org/wiki/Assignment_problem">çº¿æ€§æŒ‡æ´¾é—®é¢˜</a>ï¼Œå³ä»¥è´Ÿè½½å‡è¡¡ä¸ºçº¦æŸæ¡ä»¶ï¼Œæ±‚åœ¨è¯¥çº¦æŸä¹‹ä¸‹Routeræ€»æ‰“åˆ†å°½å¯èƒ½é«˜çš„åˆ†é…ç»“æœï¼Œè¿™å¯ä»¥ç”¨<a href="https://en.wikipedia.org/wiki/Hungarian_algorithm">åŒˆç‰™åˆ©ç®—æ³•</a>ç­‰æ¥è§£å†³ã€‚ä½†è¯¥æ–¹æ¡ˆéœ€è¦çŸ¥é“å…¨ä½“Tokençš„æ‰“åˆ†ï¼Œæ‰€ä»¥å¯¹äºè‡ªå›å½’å¼LLMæ¥è¯´ï¼Œå®ƒåªé€‚ç”¨äºè®­ç»ƒï¼Œæ¨ç†è¿˜æ˜¯åªèƒ½ç”¨$\mathop{\text{argtop}}_k \boldsymbol{\rho}$ï¼Œè®­ç»ƒæ¨ç†å­˜åœ¨ä¸ä¸€è‡´æ€§ï¼Œå¹¶ä¸”ç”±äºç›®å‰æ±‚è§£ç®—æ³•çš„é™åˆ¶ï¼Œå®ƒåªé€‚ç”¨äº$k=1$çš„åœºæ™¯ã€‚</p>
<p>ç›¸æ¯”ä¹‹ä¸‹ï¼ŒLoss-Freeçš„åšæ³•éå¸¸ç®€å•ä¸”æœ‰æ•ˆï¼Œå®ƒç•™æ„åˆ°ä¸€ä¸ªäº‹å®ï¼Œå³æˆ‘ä»¬æ€»å¯ä»¥å¼•å…¥ä¸€ä¸ªåç½®é¡¹$\boldsymbol{b}$ï¼Œä½¿å¾—$\mathop{\text{argtop}}<em _mathop_text_argtop="\mathop{\text{argtop" i_in="i\in">k \boldsymbol{\rho} + \boldsymbol{b}$çš„åˆ†é…æ˜¯å‡è¡¡çš„ï¼Œæ‰€ä»¥å®ƒå°†MoEçš„å½¢å¼æ”¹ä¸º<br />
\begin{equation}\boldsymbol{y} = \sum</em>}<em _mathop_text_argtop="\mathop{\text{argtop" i_in="i\in">k \boldsymbol{\rho}} \rho_i \boldsymbol{e}_i\qquad\to\qquad \boldsymbol{y} = \sum</em>}}_k \boldsymbol{\rho} + \boldsymbol{b}} \rho_i \boldsymbol{e}_i\end{equation<br />
è¿™é‡Œçš„$\boldsymbol{b}$æ˜¯è¾“å…¥æ— å…³çš„å‘é‡ï¼Œç”±è®­ç»ƒè¿‡ç¨‹ç¡®å®šä¸‹æ¥ï¼Œè®­ç»ƒå®Œåå®ƒå°±ä¿æŒä¸å˜ï¼Œå› æ­¤æ¨ç†é˜¶æ®µä¹Ÿå¯ä»¥ç”¨ï¼Œæ¢è¨€ä¹‹è®­ç»ƒå’Œæ¨ç†å…·æœ‰ä¸€è‡´çš„å½¢å¼ã€‚æ³¨æ„ä¹˜ä»¥$\boldsymbol{e}_i$çš„è¿˜æ˜¯$\rho_i$è€Œä¸æ˜¯$\rho_i + b_i$ï¼Œä¹Ÿå°±æ˜¯è¯´$\boldsymbol{b}$ä»…ä»…å‚ä¸åˆ†é…è¿‡ç¨‹è€Œä¸å‚ä¸MoEçš„å‰å‘è®¡ç®—ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯¹$\boldsymbol{b}$æˆ–$\boldsymbol{\rho} + \boldsymbol{b}$çš„æ­£è´Ÿæ€§éƒ½æ²¡æœ‰ç‰¹æ®Šè¦æ±‚ã€‚</p>
<h2 id="_2">æ‰‹æ“æ¢¯åº¦</h2>
<p>æ€ä¹ˆè®­ç»ƒ$\boldsymbol{b}$å‘¢ï¼Ÿæˆ‘ä»¬çŸ¥é“ï¼Œ$\boldsymbol{b}$çš„ä¼˜åŒ–æ–¹å‘è‡ªç„¶æ˜¯ä¿ƒè¿›è´Ÿè½½å‡è¡¡ï¼Œä¸ºæ­¤æŒ‰ç…§ä¸Šä¸€ç¯‡çš„è®°å·ï¼Œæˆ‘ä»¬å…ˆå®šä¹‰$\boldsymbol{f}=[f_1,f_2,\cdots,f_n]$ï¼š<br />
\begin{equation}f_i = \left\{\begin{aligned}1/k, \quad i\in \mathop{\text{argtop}}\nolimits_k \boldsymbol{\rho}+\boldsymbol{b} \\\<br />
0, \quad i\not\in \mathop{\text{argtop}}\nolimits_k \boldsymbol{\rho}+\boldsymbol{b}\end{aligned}\right.\end{equation}<br />
ä»¥åŠ$\boldsymbol{F}=\mathbb{E}[\boldsymbol{f}]$ï¼Œè¿™é‡Œçš„$\boldsymbol{F}$è‡ªç„¶å°±æ˜¯åœ¨$\boldsymbol{b}$åç½®ä¸‹Expertå½“å‰çš„è´Ÿè½½åˆ†å¸ƒäº†ã€‚å€Ÿç€æˆ‘ä»¬å®šä¹‰å‡åŒ€åˆ†å¸ƒä¸º$\boldsymbol{Q}=(1/n,1/n,\cdots,1/n)$ï¼Œé‚£ä¹ˆè´Ÿè½½å‡è¡¡å°±ç›¸å½“äºæœ€å°åŒ–<br />
\begin{equation}\mathcal{L}<em i="1">{\text{aux}} = \frac{1}{2}\Vert\boldsymbol{F} - \boldsymbol{Q}\Vert^2 = \frac{1}{2}\sum</em>}^n (F_i - 1/n)^2\end{equation<br />
è¿™ä¸ªç›®æ ‡æ˜¯ä¸å¯å¯¼çš„ï¼Œä½†æœ‰äº†ä¸Šä¸€ç¯‡çš„ç»éªŒï¼Œæˆ‘ä»¬çŸ¥é“STEï¼ˆStraight-Through Estimatorï¼‰å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚STEçš„å…³é”®æ˜¯æ‰¾ä¸€ä¸ªå¯å¯¼ä¸”è·Ÿ$\boldsymbol{F}$å…·æœ‰åŒå¢å‡è¶‹åŠ¿çš„é‡ä½œä¸º$\boldsymbol{F}$çš„å…‰æ»‘è¿‘ä¼¼ï¼Œè¿™é‡Œæˆ‘ä»¬çš„ä¼˜åŒ–å‚æ•°åªæœ‰$\boldsymbol{b}$ï¼Œè€Œå®ƒæ­£å¥½å…·æœ‰æˆ‘ä»¬æœŸæœ›çš„æ€§è´¨ï¼ˆå¢å¤§$b_i$ï¼Œ$i$è¢«é€‰ä¸­çš„æ¦‚ç‡å°±æ›´é«˜ï¼Œé‚£ä¹ˆ$F_i$å°±æ›´å¤§ï¼‰ï¼Œæ‰€ä»¥ç­”æ¡ˆå°±å‘¼ä¹‹æ¬²å‡ºäº†ï¼š<br />
\begin{equation}\mathcal{L}<em i="1">{\text{aux}} = \frac{1}{2}\Vert\boldsymbol{b} + \text{sg}[\boldsymbol{F}-\boldsymbol{b}] - \boldsymbol{Q}\Vert^2 = \frac{1}{2}\sum</em>}^n (b_i + \text{sg}[F_i - b_i] - 1/n)^2\end{equation<br />
å®ƒçš„æ¢¯åº¦æ˜¯<br />
\begin{equation}\nabla_{\boldsymbol{b}}\mathcal{L}<em _boldsymbol_b="\boldsymbol{b">{\text{aux}} = \frac{1}{2}\nabla</em>}}\Vert\boldsymbol{b} + \text{sg}[\boldsymbol{F}-\boldsymbol{b}] - \boldsymbol{Q}\Vert^2 = \boldsymbol{F} - \boldsymbol{Q}\end{equation<br />
æ‰€ä»¥ç”¨æ¢¯åº¦ä¸‹é™ï¼ˆSGDï¼‰æ¥æ›´æ–°$\boldsymbol{b}$å°±æ˜¯<br />
\begin{equation}\boldsymbol{b}\leftarrow \boldsymbol{b} - \alpha (\boldsymbol{F} - \boldsymbol{Q})\end{equation}<br />
è¿™é‡Œ$\alpha$æ˜¯$\boldsymbol{b}$çš„å­¦ä¹ ç‡ã€‚ä¸è¿‡Loss-Freeæœ€ç»ˆé€‰æ‹©çš„æ›´æ–°è§„åˆ™ç•¥æœ‰ä¸åŒï¼Œå®ƒé€‰æ‹©çš„æ˜¯ç¬¦å·æ¢¯åº¦ä¸‹é™ï¼ˆSignSGDï¼‰ï¼š<br />
\begin{equation}\boldsymbol{b}\leftarrow \boldsymbol{b} - \alpha \mathop{\text{sign}}(\boldsymbol{F} - \boldsymbol{Q})\label{eq:aux-loss-free}\end{equation}<br />
è¿™ä¸ªç»“æœå…¶å®ä¹Ÿå¾ˆå¥½ç†è§£ï¼Œå°±æ˜¯å¦‚æœ$F_i$æ¯”$1/n$å¤§ï¼Œé‚£ä¹ˆå°±è°ƒå°ä¸€ç‚¹$b_i$ï¼Œå¦åˆ™å°±å¢å¤§ä¸€ç‚¹$b_i$ã€‚</p>
<h2 id="_3">æ”¹è‰¯ç‰ˆæœ¬</h2>
<p>é™¤äº†åŠ $\mathop{\text{sign}}$çš„ç¬¦å·æ¢¯åº¦ä¸‹é™å¤–ï¼Œç¬”è€…å‘ç°ç›´æ¥å¯¹$\boldsymbol{F} - \boldsymbol{Q}$åšRMS Normï¼ˆå³Normalized SGDï¼‰ï¼Œåœ¨ç›¸åŒçš„$\alpha$ä¸‹å¾€å¾€èƒ½è¾¾åˆ°æ›´å¥½çš„å‡è¡¡æ•ˆæœï¼š<br />
\begin{equation}\boldsymbol{b}\leftarrow \boldsymbol{b} - \alpha\frac{\boldsymbol{F} - \boldsymbol{Q}}{\text{RMS}(\boldsymbol{F} - \boldsymbol{Q})}\end{equation}<br />
è¿™é‡Œçš„$\text{RMS}$æ˜¯â€œRoot Mean Squareâ€ï¼Œå®šä¹‰ä¸º<br />
\begin{equation}\text{RMS}(\boldsymbol{F} - \boldsymbol{Q}) = \sqrt{\frac{1}{n}\sum_{i=1}^n (F_i - Q_i)^2}\end{equation}<br />
ä¸éš¾çœ‹å‡ºï¼ŒåŠ $\mathop{\text{sign}}$åçš„$\mathop{\text{sign}}(\boldsymbol{F} - \boldsymbol{Q})$å’ŒåŠ RMS Normåçš„$\frac{\boldsymbol{F} - \boldsymbol{Q}}{\text{RMS}(\boldsymbol{F} - \boldsymbol{Q})}$ï¼Œå®ƒä»¬çš„$\text{RMS}$éƒ½æ˜¯1ï¼Œå› æ­¤å®ƒä»¬ä¿©å°ºåº¦ä¸Šæ˜¯å¤§è‡´ç›¸åŒçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ç›¸åŒçš„$\alpha$ã€‚</p>
<p>ç®€å•æ¥è¯´ï¼Œ$\mathop{\text{sign}}$çš„é—®é¢˜åœ¨äºä¸è®º$F_i$ä¸ç›®æ ‡$Q_i$çš„è¿œè¿‘éƒ½ä½¿ç”¨åŒæ ·çš„æ›´æ–°å¹…åº¦ï¼Œè¿™å¯¼è‡´åŸæœ¬å°±å·²ç»è·Ÿ$Q_i$æ¯”è¾ƒæ¥è¿‘çš„$F_i$åè€Œå®¹æ˜“åç¦»åŸæœ¬å·²ç»è¾¾åˆ°çš„å‡è¡¡ï¼Œä»è€Œäº§ç”Ÿéœ‡è¡ï¼›è€ŒRMS Normåˆ™ä¿ç•™äº†$F_i-Q_i$ä¹‹é—´çš„ç›¸å¯¹å¤§å°ï¼Œæ›´æ–°å¹…åº¦æ›´åŠ è‡ªé€‚åº”ä¸€äº›ï¼Œç†è®ºä¸Šæ›´æœ‰åŠ©äºä¿ƒè¿›å‡è¡¡ï¼Œå®æµ‹æ•ˆæœä¹Ÿå¤šæ˜¯å®ƒæ›´å¥½ã€‚</p>
<h2 id="_4">ä¸€è„‰ç›¸æ‰¿</h2>
<p>åŸè®ºæ–‡åœ¨ä»‹ç»Loss-Freeæ—¶ï¼Œå¹¶æ²¡æœ‰ä¸Šè¿°Aux Lossçš„æ¨å¯¼è¿‡ç¨‹ï¼Œè€Œæ˜¯ç›´æ¥ç»™å‡ºå¼$\eqref{eq:aux-loss-free}$çš„æ›´æ–°è§„åˆ™ï¼Œç»™äººçš„æ„Ÿè§‰æ˜¯ç»™$\boldsymbol{b}$â€œæ‰‹æ“â€äº†æ¢¯åº¦$\mathop{\text{sign}}(\boldsymbol{F} - \boldsymbol{Q})$ï¼Œè¿™ä¹Ÿæ˜¯å®ƒLoss-Freeè¿™ä¸ªåå­—çš„æ¥æºã€‚</p>
<p>ç„¶è€Œï¼Œä»æœ¬æ–‡ç»™å‡ºçš„æ¨å¯¼å¯ä»¥çœ‹å‡ºï¼Œæ›´æ–°è§„åˆ™$\eqref{eq:aux-loss-free}$ä¹Ÿå®Œå…¨å¯ä»¥ä»Aux Lossè§†è§’å¾—åˆ°ï¼Œä¸¤è€…æ˜¯ä¸€è„‰ç›¸æ‰¿çš„ã€‚çœ‹èµ·æ¥Loss-Freeæœ€ç›´æ¥çš„å¥½å¤„æ˜¯ä¸ç”¨è°ƒAux Lossæƒé‡äº†ï¼Œä½†å®ƒå®é™…ä¸Šä¹Ÿæœ‰ä¸ªå­¦ä¹ ç‡å‚æ•°$\alpha$è¦è°ƒï¼Œå°½ç®¡åŸè®ºæ–‡å·²ç»å¸®æˆ‘ä»¬æœå¥½$\alpha=0.001$è¿™ä¸ªé»˜è®¤å€¼ï¼Œä½†ä¸å¯å¦è®¤è¿™ä¸ªè¶…å‚æ•°æ˜¯å­˜åœ¨çš„ã€‚</p>
<p>åœ¨ç¬”è€…çœ‹æ¥ï¼ŒLoss-Freeçš„æœ¬è´¨åˆ›æ–°å¹¶ä¸æ˜¯æ²¡æœ‰Aux Lossï¼Œè€Œæ˜¯éš”ç¦»äº†Aux Losså’ŒLM Lossçš„ä¼˜åŒ–å‚æ•°ï¼Œä»è€Œè¾¾åˆ°äº†è´Ÿè½½å‡è¡¡å’Œæ¨¡å‹èƒ½åŠ›ä¸¤ä¸è¯¯çš„æ•ˆæœã€‚å…¶ä¸­æœ€å…³é”®ä¸€æ­¥ï¼Œæ˜¯ç•™æ„åˆ°â€œä¸€ä¸ªåç½®é¡¹è¶³ä»¥è¾¾åˆ°è´Ÿè½½å‡è¡¡â€è¿™ä¸€äº‹å®ï¼Œç„¶åå°±è®©Aux Lossåªä¼˜åŒ–æ–°å¼•å…¥çš„åç½®$\boldsymbol{b}$ï¼Œè€ŒLM Lossåˆ™ä¼˜åŒ–å‰©ä½™å‚æ•°ï¼Œè®©Aux Losså¯¹LM Lossçš„è´Ÿé¢ä½œç”¨é™åˆ°æœ€ä½ã€‚</p>
<p>ç›¸æ¯”ä¹‹ä¸‹ï¼Œå¸¸è§„çš„Aux Lossæ–¹æ¡ˆéœ€è¦å…¨ä½“å‚æ•°æ¥ä¿ƒè¿›è´Ÿè½½å‡è¡¡ï¼Œè€ŒLM Lossä¼˜åŒ–çš„ä¹Ÿæ˜¯å…¨ä½“å‚æ•°ï¼Œä¸¤è€…çš„ä¼˜åŒ–æ–¹å‘å¯èƒ½å¹¶ä¸å®Œå…¨å…¼å®¹ï¼Œå› æ­¤æƒ³æ‰¾åˆ°ä¸€ä¸ªæœ€ä¼˜çš„å¹³è¡¡ç‚¹ç›¸å¯¹æ¥è¯´å°±æ›´ä¸ºå›°éš¾ã€‚æ‰€ä»¥ï¼ŒLoss-FreeåŸºäºâ€œä¸€ä¸ªåç½®é¡¹è¶³ä»¥è¾¾åˆ°è´Ÿè½½å‡è¡¡â€å°†ä¸¤ä¸ªLossçš„ä¼˜åŒ–å‚æ•°éš”ç¦»å¼€æ¥ï¼Œæ˜¯è´Ÿè½½å‡è¡¡é—®é¢˜çš„ä¸€ä¸ªç»å¦™çš„è§£å†³åŠæ³•ã€‚</p>
<h2 id="_5">ç›¸å…³ç»†èŠ‚</h2>
<p>å°½ç®¡Loss-Freeå·²ç»è¶³å¤Ÿç®€å•æ˜äº†ï¼Œä½†æ˜¯åœ¨ä½¿ç”¨çš„æ—¶å€™è¿˜è¦ç¨å¾®æ³¨æ„ä¸€äº›ç»†èŠ‚ã€‚</p>
<p>é¦–å…ˆï¼Œå¯¹äºæ¯ä¸ªBatchçš„æ•°æ®ï¼Œæˆ‘ä»¬åº”å½“å…ˆæ ¹æ®LM Lossæ¥æ›´æ–°æ¨¡å‹å‚æ•°ï¼Œç„¶åå†æ ¹æ®å¼$\eqref{eq:aux-loss-free}$æ¥æ›´æ–°$\boldsymbol{b}$ã€‚è¿™æ˜¯å› ä¸º$\boldsymbol{b}$çš„æ›´æ–°ä¾èµ–äºå…¨ä½“Tokençš„ç»Ÿè®¡ä¿¡æ¯$\boldsymbol{F}$ï¼Œå…ˆæ›´æ–°$\boldsymbol{b}$å†æ›´æ–°æ¨¡å‹å…¶ä½™å‚æ•°çš„è¯ï¼ŒåŸåˆ™ä¸Šä¼šæœ‰æ³„æ¼æœªæ¥ä¿¡æ¯çš„é£é™©ã€‚è™½ç„¶ç›´è§‚çœ‹æ¥å°±ä¸€ä¸ªå‘é‡$\boldsymbol{b}$æ³„æ¼ä¸äº†å¤šå°‘ä¿¡æ¯ï¼Œä½†è¿™ä¸ªé£é™©ç»ˆå½’æ˜¯å­˜åœ¨çš„ï¼Œå› æ­¤è¦å°½é‡å»è§„é¿å®ƒã€‚</p>
<p>å…¶æ¬¡ï¼Œåˆšæ‰æˆ‘ä»¬è¯´åŸè®ºæ–‡å·²ç»è°ƒå¥½$\alpha=0.001$ï¼Œä½†è¿™ä¸ªç»“æœå¯èƒ½è·ŸåŸè®ºæ–‡ç”¨Sigmoidä½œä¸ºRouter $\boldsymbol{\rho}$æ¿€æ´»å‡½æ•°çš„é€‰æ‹©æ˜¯ç»‘å®šçš„ã€‚åŸå› ä¹Ÿä¸éš¾æƒ³ï¼Œç»è¿‡Sigmoidåï¼Œæ¯ä¸ª$\rho_i$ç›¸å¯¹æ¯”è¾ƒç‹¬ç«‹ï¼Œå¹¶ä¸”éƒ½åœ¨$(0,1)$å†…ï¼Œ$\alpha=0.001$ç›¸å½“äºè¯´æ¯ä¸€æ­¥çš„æ›´æ–°å¹…åº¦çº¦ä¸ºåƒåˆ†ä¹‹ä¸€ï¼Œå¦‚æœæ¢Softmaxã€ReLUæˆ–è€…å…¶ä»–æ¿€æ´»å‡½æ•°ï¼Œé‚£ä¹ˆå°±å¯èƒ½éœ€è¦é‡è°ƒ$\alpha$äº†ã€‚</p>
<p>é’ˆå¯¹è¿™ä¸ªé—®é¢˜ï¼Œç¬”è€…å»ºè®®çš„åšæ³•æ˜¯è§£è€¦Gateå’ŒBiasæ‰€ç”¨çš„æ¿€æ´»å‡½æ•°ï¼Œå³<br />
\begin{equation}\boldsymbol{y} = \sum_{i\in \mathop{\text{argtop}}<em _mathop_text_argtop="\mathop{\text{argtop" i_in="i\in">k \boldsymbol{\rho} + \boldsymbol{b}} \rho_i \boldsymbol{e}_i\qquad\to\qquad \boldsymbol{y} = \sum</em>}}_k \boldsymbol{\rho}^{(\sigma)} + \boldsymbol{b}} \rho_i^{(h)} \boldsymbol{e}_i\end{equation<br />
å…¶ä¸­$\boldsymbol{\rho}^{(\sigma)} = \sigma(\boldsymbol{x}\boldsymbol{W}^{(R)}), \boldsymbol{\rho}^{(h)} = h(\boldsymbol{x}\boldsymbol{W}^{(R)})$ï¼Œ$\sigma(\cdot)$æ˜¯Sigmoidå‡½æ•°ï¼Œ$h(\cdot)$æ˜¯ä»»æ„å•è°ƒä¸”å€¼åŸŸéè´Ÿçš„å‡½æ•°ï¼Œè¯´ç™½äº†å°±æ˜¯åŠ ä¸Š$\boldsymbol{b}$çš„æ˜¯Sigmoidæ¿€æ´»çš„æ‰“åˆ†ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥å¤ç”¨$\alpha=0.001$ï¼Œè‡³äºä¹˜ä¸ŠExpertçš„Gateï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å…¶ä»–æ¿€æ´»å‡½æ•°ï¼Œåªè¦å®ƒçš„å•è°ƒæ€§è·ŸSigmoidä¸€è‡´å°±è¡Œã€‚</p>
<p>æ­¤å¤–ï¼Œç”±äºæ›´æ–°è§„åˆ™$\eqref{eq:aux-loss-free}$åŠ äº†$\text{sign}$å‡½æ•°ï¼Œå› æ­¤æœ‰å¯èƒ½è®­å‡ºç»å¯¹å€¼å¤§äº1çš„$b_i$ï¼Œæ•´ä½“ç»å¯¹å€¼è¿˜å¯èƒ½è¶Šæ¥è¶Šå¤§ï¼Œè¿™äº›éƒ½æ˜¯æ­£å¸¸çš„ï¼Œå¯¹æ¨¡å‹æ•ˆæœä¸ä¼šæœ‰å½±å“ã€‚å®é™…ä¸Š$\boldsymbol{b}$æœ‰ä¸€ä¸ªå†—ä½™çš„è‡ªç”±åº¦ï¼Œå› ä¸ºå…¨ä½“$b_i$éƒ½åŠ ä¸ŠåŒä¸€ä¸ªå¸¸æ•°åï¼Œ$\mathop{\text{argtop}}_k \boldsymbol{\rho} + \boldsymbol{b}$çš„ç»“æœä¸å˜ã€‚è¿™ä¸ªé¢å¤–çš„è‡ªç”±åº¦æˆ‘ä»¬å¯ä»¥ç”¨æ¥åšå…¶ä»–å¥½ç©çš„äº‹æƒ…ï¼ˆä¸”å¬ä¸‹å›åˆ†è§£ï¼‰ã€‚</p>
<h2 id="_6">å»¶ä¼¸æ€è€ƒ</h2>
<p>é™¤äº†MoEçš„è´Ÿè½½å‡è¡¡ä¹‹å¤–ï¼ŒLoss-Freeçš„æ€æƒ³è¿˜å¯ä»¥åº”ç”¨åˆ°å¾ˆå¤šç±»ä¼¼é—®é¢˜ï¼Œæ¯”å¦‚VQ-VQEçš„ç¼–ç è¡¨åç¼©ï¼ˆCodebook Collapseï¼‰ï¼Œå°±å¯ä»¥ç”¨åŒæ ·æ€è·¯è§£å†³ï¼Œè€Œä¸”ç›¸æ¯”ä¹‹å‰ä»‹ç»çš„â€œ<a href="/archives/10489">æ—‹è½¬æŠ€å·§</a>â€ã€â€œ<a href="/archives/10519">çº¿æ€§å˜æ¢æŠ€å·§</a>â€æ˜¾å¾—æ›´è‡ªç„¶å’Œæ™®é€‚ã€‚äº‹å®ä¸Šï¼Œæœ¬æ–‡å¼€ç¯‡çš„è¯„ä»·â€œLoss-Freeæ½œåœ¨çš„å­¦æœ¯å½±å“åŠ›å¯èƒ½è¿œè¶…å…¶ä»–å·¥ä½œâ€ï¼Œæ­£æ˜¯åŸºäºLoss-Freeçš„æ™®é€‚æ€§è€ƒè™‘çš„ã€‚</p>
<p>æŠ›å¼€å…·ä½“çš„åº”ç”¨èƒŒæ™¯ï¼Œä»æ•°å­¦ä¸Šæ¥çœ‹ï¼ŒLoss-Freeçš„è´¡çŒ®å¯ä»¥ç†è§£ä¸ºç»™å‡ºäº†ç”¨æ¢¯åº¦ä¸‹é™æ¥æ±‚è§£æŒ‡æ´¾é—®é¢˜çš„æ–¹æ³•ã€‚ä¸€ä¸ªç»å…¸çš„çº¿æ€§æŒ‡æ´¾é—®é¢˜å¯ä»¥è¡¨ç¤ºä¸ºï¼š<br />
\begin{equation}\min_f \sum_{i=1}^n c_{i, f(i)}\end{equation}<br />
å…¶ä¸­$c_{i,j}$æ˜¯ç»™å®šçš„æˆæœ¬å‡½æ•°ï¼Œ$f$æ˜¯$\{1,2,\cdots,n\}$åˆ°è‡ªèº«çš„åŒå°„ã€‚æ”¾åˆ°æœ¬æ–‡çš„èƒŒæ™¯ä¸‹ï¼Œ$c_{i,j}$ä¸å°±ç›¸å½“äº$n$ä¸ªTokenã€$n$ä¸ªExpertçš„æ‰“åˆ†ï¼Œæ‰€æ±‚$f$ä¸å°±æ˜¯ä¸€ä¸ªè´Ÿè½½å‡è¡¡çš„åˆ†é…æ–¹æ¡ˆï¼Ÿæ±‚è§£æ­¤ç±»é—®é¢˜çš„ä¸€èˆ¬æƒ³æ³•æ˜¯åœ¨æ»¡è¶³çº¦æŸæ¡ä»¶çš„ç©ºé—´é‡Œæœç´¢å°½å¯èƒ½ä¼˜çš„è§£ï¼Œè€ŒLoss-Freeåˆ™åè¿‡æ¥ï¼Œå…ˆæ„å»ºä¸€ä¸ªæœ€ä¼˜ä½†ä¸ä¸€å®šæ»¡è¶³çº¦æŸæ¡ä»¶çš„è§£ï¼š<br />
\begin{equation}f(i) = \mathop{\text{argmin}}<em i_j="i,j">j c</em>}\end{equation<br />
è¿™ä¸ªè§£åœ¨åˆ†æ•°ä¸Šè‚¯å®šæ˜¯æœ€ä¼˜çš„ï¼Œä½†ä¸ä¸€å®šæ»¡è¶³åŒå°„çš„æ¡ä»¶ï¼Œè¿™é‡Œä¸æ»¡è¶³åŒå°„å°±ç­‰ä»·äºè´Ÿè½½ä¸å‡è¡¡ã€‚äºæ˜¯æˆ‘ä»¬å¼•å…¥åç½®<br />
\begin{equation}f(i) = \mathop{\text{argmin}}<em i_j="i,j">j c</em>} + b_j\end{equation<br />
$b_j$åˆå§‹åŒ–ä¸ºé›¶ï¼Œç„¶åæ ¹æ®å¼$\eqref{eq:aux-loss-free}$æ¥æ›´æ–°ï¼Œæ›´æ–°è§„åˆ™è¯´ç™½äº†å°±æ˜¯å“ªä¸ª$j$å‡ºç°å‡ºç°æ¬¡æ•°å¤šï¼Œé‚£å‡å°‘ç›¸åº”çš„$b_j$ï¼Œåä¹‹å¢åŠ ï¼Œç›´åˆ°å‡ºç°åŒå°„ä¸ºæ­¢ã€‚</p>
<h2 id="_7">æ–‡ç« å°ç»“</h2>
<p>æœ¬æ–‡ä»‹ç»äº†MoEè´Ÿè½½å‡è¡¡é—®é¢˜çš„Loss-Freeæ–¹æ³•ï¼Œå®ƒç”±DeepSeekæå‡ºï¼Œå…¶æ ¸å¿ƒåœ¨äºé€šè¿‡å¼•å…¥ä¸€ä¸ªç®€å•çš„åç½®é¡¹æ¥å®ç°è´Ÿè½½å‡è¡¡ã€‚æœ¬æ–‡è¿›ä¸€æ­¥æ€è€ƒäº†å®ƒä¸Aux Lossçš„è”ç³»ï¼Œä»¥åŠå®ƒåœ¨ç±»ä¼¼æ•°å­¦é—®é¢˜ä¸Šçš„åº”ç”¨æ½œåŠ›ã€‚</p>
<p><em><strong>è½¬è½½åˆ°è¯·åŒ…æ‹¬æœ¬æ–‡åœ°å€ï¼š</strong><a href="https://spaces.ac.cn/archives/10757">https://spaces.ac.cn/archives/10757</a></em></p>
<p><em><strong>æ›´è¯¦ç»†çš„è½¬è½½äº‹å®œè¯·å‚è€ƒï¼š</strong></em><a href="https://spaces.ac.cn/archives/6508#%E6%96%87%E7%AB%A0%E5%A6%82%E4%BD%95%E8%BD%AC%E8%BD%BD/%E5%BC%95%E7%94%A8" title="ã€Šç§‘å­¦ç©ºé—´FAQã€‹">ã€Šç§‘å­¦ç©ºé—´FAQã€‹</a></p>
<p><strong>å¦‚æœæ‚¨è¿˜æœ‰ä»€ä¹ˆç–‘æƒ‘æˆ–å»ºè®®ï¼Œæ¬¢è¿åœ¨ä¸‹æ–¹è¯„è®ºåŒºç»§ç»­è®¨è®ºã€‚</strong></p>
<p><strong>å¦‚æœæ‚¨è§‰å¾—æœ¬æ–‡è¿˜ä¸é”™ï¼Œæ¬¢è¿åˆ†äº«/æ‰“èµæœ¬æ–‡ã€‚æ‰“èµå¹¶éè¦ä»ä¸­è·å¾—æ”¶ç›Šï¼Œè€Œæ˜¯å¸Œæœ›çŸ¥é“ç§‘å­¦ç©ºé—´è·å¾—äº†å¤šå°‘è¯»è€…çš„çœŸå¿ƒå…³æ³¨ã€‚å½“ç„¶ï¼Œå¦‚æœä½ æ— è§†å®ƒï¼Œä¹Ÿä¸ä¼šå½±å“ä½ çš„é˜…è¯»ã€‚å†æ¬¡è¡¨ç¤ºæ¬¢è¿å’Œæ„Ÿè°¢ï¼</strong></p>
<p>æ‰“èµ</p>
<p><img alt="ç§‘å­¦ç©ºé—´" src="https://spaces.ac.cn/usr/themes/geekg/payment/wx.png" /></p>
<p>å¾®ä¿¡æ‰“èµ</p>
<p><img alt="ç§‘å­¦ç©ºé—´" src="https://spaces.ac.cn/usr/themes/geekg/payment/zfb.png" /></p>
<p>æ”¯ä»˜å®æ‰“èµ</p>
<p>å› ä¸ºç½‘ç«™åå°å¯¹æ‰“èµå¹¶æ— è®°å½•ï¼Œå› æ­¤æ¬¢è¿åœ¨æ‰“èµæ—¶å€™å¤‡æ³¨ç•™è¨€ã€‚ä½ è¿˜å¯ä»¥<a href="http://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&amp;email=tN7d1drY3drrx8H0xcWa19vZ"><strong>ç‚¹å‡»è¿™é‡Œ</strong></a>æˆ–åœ¨ä¸‹æ–¹è¯„è®ºåŒºç•™è¨€æ¥å‘ŠçŸ¥ä½ çš„å»ºè®®æˆ–éœ€æ±‚ã€‚</p>
<p><strong>å¦‚æœæ‚¨éœ€è¦å¼•ç”¨æœ¬æ–‡ï¼Œè¯·å‚è€ƒï¼š</strong></p>
<p>è‹å‰‘æ—. (Mar. 05, 2025). ã€ŠMoEç¯æ¸¸è®°ï¼š3ã€æ¢ä¸ªæ€è·¯æ¥åˆ†é… ã€‹[Blog post]. Retrieved from <a href="https://spaces.ac.cn/archives/10757">https://spaces.ac.cn/archives/10757</a></p>
<p>@online{kexuefm-10757,<br />
title={MoEç¯æ¸¸è®°ï¼š3ã€æ¢ä¸ªæ€è·¯æ¥åˆ†é…},<br />
author={è‹å‰‘æ—},<br />
year={2025},<br />
month={Mar},<br />
url={\url{https://spaces.ac.cn/archives/10757}},<br />
} </p>
<hr />
<h2 id="_8">å…¬å¼æ¨å¯¼ä¸æ³¨é‡Š</h2>
<h3 id="1">ç¬¬1éƒ¨åˆ†ï¼šæ ¸å¿ƒç†è®ºã€å…¬ç†ä¸å†å²åŸºç¡€</h3>
<h4 id="11">1.1 ç†è®ºèµ·æºä¸å†å²å‘å±•</h4>
<p><strong>è´Ÿè½½å‡è¡¡é—®é¢˜çš„ç†è®ºæ ¹æº</strong>å¯è¿½æº¯åˆ°å¤šä¸ªè®¡ç®—æœºç§‘å­¦å’Œè¿ç­¹å­¦é¢†åŸŸï¼š</p>
<div class="theorem-box">

**å¤šé¢†åŸŸäº¤å‰**ï¼š
- **è´Ÿè½½å‡è¡¡ç†è®º** (1960s)ï¼šåˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„èµ„æºè°ƒåº¦é—®é¢˜
- **æŒ‡æ´¾é—®é¢˜** (Assignment Problem, 1950s)ï¼šåŒˆç‰™åˆ©ç®—æ³•æ±‚è§£æœ€ä¼˜åŒ¹é…
- **å…¬å¹³èµ„æºåˆ†é…** (Fair Division)ï¼šç»æµå­¦ä¸­çš„è›‹ç³•åˆ†å‰²é—®é¢˜
- **æœ€ä¼˜ä¼ è¾“ç†è®º** (Optimal Transport, 18-19ä¸–çºª)ï¼šMonge-Kantoroviché—®é¢˜
- **åœ¨çº¿è´Ÿè½½å‡è¡¡** (Online Load Balancing, 1990s)ï¼šæµå¼æ•°æ®ä¸‹çš„åŠ¨æ€è°ƒåº¦

</div>

<p><strong>MoEè´Ÿè½½å‡è¡¡çš„å…³é”®é‡Œç¨‹ç¢‘</strong>ï¼š</p>
<ol>
<li><strong>2017 - Shazeerç­‰äººï¼ˆGoogle Brainï¼‰</strong>ï¼šé¦–æ¬¡æå‡ºMoEçš„è´Ÿè½½ä¸å‡è¡¡é—®é¢˜ï¼Œä½†æœªç»™å‡ºç³»ç»Ÿè§£å†³æ–¹æ¡ˆ</li>
<li><strong>2020 - GShard</strong>ï¼šæå‡ºè¾…åŠ©æŸå¤±ï¼ˆAux Lossï¼‰$\mathcal{L}_{\text{aux}} = n \sum_i F_i P_i$</li>
<li><strong>2021 - Switch Transformer</strong>ï¼šç®€åŒ–ä¸ºTop-1è·¯ç”±ï¼Œå¼•å…¥Expert Capacityæœºåˆ¶</li>
<li><strong>2021 - BASE Layer (Facebook)</strong>ï¼šå°†è´Ÿè½½å‡è¡¡å»ºæ¨¡ä¸ºçº¿æ€§æŒ‡æ´¾é—®é¢˜ï¼Œä½¿ç”¨åŒˆç‰™åˆ©ç®—æ³•</li>
<li><strong>2024 - DeepSeek Loss-Free</strong>ï¼šå¼•å…¥åç½®é¡¹$\boldsymbol{b}$ï¼Œå®ç°å‚æ•°ç©ºé—´åˆ†ç¦» â­</li>
</ol>
<h4 id="12">1.2 æ•°å­¦å…¬ç†ä¸åŸºç¡€å‡è®¾</h4>
<div class="theorem-box">

### å…¬ç†1ï¼šèµ„æºæœ‰é™æ€§ï¼ˆBounded Capacityï¼‰

åœ¨åˆ†å¸ƒå¼MoEç³»ç»Ÿä¸­ï¼Œæ¯ä¸ªExpertæœ‰å›ºå®šçš„è®¡ç®—èµ„æºå®¹é‡ï¼š

$$C_i \leq C_{\max}, \quad \forall i = 1, \ldots, n$$

å…¶ä¸­$C_i$æ˜¯Expert $i$çš„å®¹é‡ï¼ˆå¯å¤„ç†çš„tokenæ•°ï¼‰ï¼Œ$C_{\max}$æ˜¯ç¡¬ä»¶é™åˆ¶ã€‚

</div>

<div class="theorem-box">

### å…¬ç†2ï¼šè´Ÿè½½å¯è°ƒèŠ‚æ€§ï¼ˆLoad Adjustabilityï¼‰

**æ ¸å¿ƒå‡è®¾**ï¼šå­˜åœ¨ä¸€ä¸ªè°ƒèŠ‚å‚æ•°ç©ºé—´ï¼ˆå¦‚åç½®å‘é‡$\boldsymbol{b}$ï¼‰ï¼Œä½¿å¾—å¯¹ä»»æ„ç»™å®šçš„Routerè¾“å‡º$\boldsymbol{\rho}$ï¼Œéƒ½èƒ½é€šè¿‡è°ƒèŠ‚å‚æ•°è¾¾åˆ°è´Ÿè½½å‡è¡¡ã€‚

$$\exists \boldsymbol{b}^* \in \mathbb{R}^n: \quad \mathbb{E}_{\boldsymbol{x}}[\boldsymbol{f}(\boldsymbol{x}; \boldsymbol{\rho} + \boldsymbol{b}^*)] = \boldsymbol{Q}$$

å…¶ä¸­$\boldsymbol{Q} = (\frac{1}{n}, \ldots, \frac{1}{n})$æ˜¯å‡åŒ€åˆ†å¸ƒï¼Œ$\boldsymbol{f}$æ˜¯ä¸“å®¶é€‰æ‹©å‡½æ•°ã€‚

</div>

<div class="theorem-box">

### å…¬ç†3ï¼šæŸå¤±å‡½æ•°è§£è€¦æ€§ï¼ˆLoss Decompositionï¼‰

ä¼˜åŒ–ç›®æ ‡å¯ä»¥åˆ†è§£ä¸ºä¸¤ä¸ªç‹¬ç«‹çš„å­é—®é¢˜ï¼š

$$\begin{cases}
\min_{\theta} \mathcal{L}_{\text{task}}(\theta) & \text{(ä¸»ä»»åŠ¡)} \\
\min_{\boldsymbol{b}} \mathcal{L}_{\text{balance}}(\boldsymbol{b}) & \text{(è´Ÿè½½å‡è¡¡)}
\end{cases}$$

**å…³é”®æ€§è´¨**ï¼š$\boldsymbol{b}$åªå½±å“Top-Ké€‰æ‹©ï¼Œä¸å½±å“å‰å‘è®¡ç®—æƒé‡ï¼Œå› æ­¤$\frac{\partial \mathcal{L}_{\text{task}}}{\partial \boldsymbol{b}} = \boldsymbol{0}$ã€‚

</div>

<h4 id="13">1.3 è®¾è®¡å“²å­¦</h4>
<p>Loss-Freeæ–¹æ³•çš„æ ¸å¿ƒè®¾è®¡å“²å­¦ä½“ç°ä¸º<strong>"å‚æ•°ç©ºé—´åˆ†ç¦»"</strong>ä¸<strong>"æœ€å°å¹²é¢„åŸåˆ™"</strong>çš„ç»“åˆï¼š</p>
<p><strong>å‚æ•°ç©ºé—´åˆ†ç¦»ï¼ˆParameter Space Separationï¼‰</strong>ï¼š
- ä¼ ç»Ÿæ–¹æ³•ï¼šæ‰€æœ‰å‚æ•°å…±åŒä¼˜åŒ–ä¸¤ä¸ªç›®æ ‡ï¼ˆä¸»ä»»åŠ¡ + è´Ÿè½½å‡è¡¡ï¼‰
- Loss-Freeï¼šå°†å‚æ•°åˆ†ä¸ºä¸¤ç»„
  - <strong>ä¸»å‚æ•°</strong>$\theta$ï¼šRouteræƒé‡ã€Expertå‚æ•° â†’ åªä¼˜åŒ–ä¸»ä»»åŠ¡
  - <strong>è¾…åŠ©å‚æ•°</strong>$\boldsymbol{b}$ï¼šåç½®å‘é‡ â†’ åªä¼˜åŒ–è´Ÿè½½å‡è¡¡
- <strong>ç±»æ¯”</strong>ï¼šå¦‚åŒè½¯ä»¶å·¥ç¨‹ä¸­çš„"å…³æ³¨ç‚¹åˆ†ç¦»"ï¼ˆSeparation of Concernsï¼‰</p>
<p><strong>æœ€å°å¹²é¢„åŸåˆ™ï¼ˆMinimal Interventionï¼‰</strong>ï¼š
- Routerå·²ç»å­¦ä¹ äº†"å“ªäº›Expertæœ€é€‚åˆå¤„ç†å½“å‰è¾“å…¥"
- æˆ‘ä»¬ä¸æ”¹å˜Routerçš„åˆ¤æ–­ï¼Œåªæ˜¯<strong>è½»å¾®è°ƒæ•´</strong>é€‰æ‹©è¾¹ç•Œ
- <strong>ç±»æ¯”</strong>ï¼šä¸æ˜¯é‡æ–°åŸ¹è®­ä¸“å®¶ï¼Œè€Œæ˜¯è°ƒæ•´ä»–ä»¬çš„"ä¼˜å…ˆçº§"</p>
<p><strong>ä¸ç°æœ‰æ–¹æ³•çš„æœ¬è´¨åŒºåˆ«</strong>ï¼š</p>
<table>
<thead>
<tr>
<th>ç»´åº¦</th>
<th>ä¼ ç»ŸAux Loss</th>
<th>BASE Layer</th>
<th>Loss-Free</th>
</tr>
</thead>
<tbody>
<tr>
<td>ä¼˜åŒ–æ–¹å¼</td>
<td>æ¢¯åº¦ä¸‹é™ï¼ˆæ‰€æœ‰å‚æ•°ï¼‰</td>
<td>çº¿æ€§æŒ‡æ´¾ç®—æ³•</td>
<td>æ¢¯åº¦ä¸‹é™ï¼ˆä»…$\boldsymbol{b}$ï¼‰</td>
</tr>
<tr>
<td>è®­ç»ƒ/æ¨ç†ä¸€è‡´æ€§</td>
<td>âœ… ä¸€è‡´</td>
<td>âŒ ä¸ä¸€è‡´ï¼ˆæ¨ç†ç”¨Top-Kï¼‰</td>
<td>âœ… ä¸€è‡´</td>
</tr>
<tr>
<td>é€‚ç”¨çš„$k$å€¼</td>
<td>ä»»æ„$k$</td>
<td>ä»…$k=1$</td>
<td>ä»»æ„$k$</td>
</tr>
<tr>
<td>è®¡ç®—å¤æ‚åº¦</td>
<td>$O(d \cdot n)$</td>
<td>$O(n^3)$ï¼ˆåŒˆç‰™åˆ©ç®—æ³•ï¼‰</td>
<td>$O(d \cdot n + n)$</td>
</tr>
<tr>
<td>å¯¹ä¸»ä»»åŠ¡å½±å“</td>
<td>âš ï¸ å¯èƒ½æŸå®³</td>
<td>âœ… æ— ç›´æ¥å½±å“</td>
<td>âœ… æ— ç›´æ¥å½±å“</td>
</tr>
<tr>
<td>è¶…å‚æ•°æ•æ„Ÿåº¦</td>
<td>âš ï¸ é«˜ï¼ˆæƒé‡$\alpha$ï¼‰</td>
<td>âš ï¸ ä¸­ç­‰</td>
<td>âœ… ä½ï¼ˆ$\alpha=0.001$é€‚ç”¨å¹¿ï¼‰</td>
</tr>
</tbody>
</table>
<p><strong>æ ¸å¿ƒæ€æƒ³</strong>ï¼š</p>
<blockquote>
<p>"ä¸€ä¸ªåç½®é¡¹è¶³ä»¥è¾¾åˆ°è´Ÿè½½å‡è¡¡" â€”â€” DeepSeek, 2024</p>
</blockquote>
<p>è¿™ä¸ªæ´å¯Ÿçœ‹ä¼¼ç®€å•ï¼Œå´æå…·æ™®é€‚æ€§ï¼Œé€‚ç”¨äºæ‰€æœ‰æ¶‰åŠTop-Ké€‰æ‹©å’Œè´Ÿè½½å‡è¡¡çš„é—®é¢˜ã€‚</p>
<hr />
<h3 id="2">ç¬¬2éƒ¨åˆ†ï¼šä¸¥è°¨çš„æ ¸å¿ƒæ•°å­¦æ¨å¯¼</h3>
<h3 id="1-moe">1. MoEçš„æ•°å­¦æ¨¡å‹</h3>
<h4 id="11_1">1.1 åŸºæœ¬å½¢å¼</h4>
<p>æ ‡å‡†çš„MoEï¼ˆMixture of Expertsï¼‰æ¨¡å‹å¯ä»¥å½¢å¼åŒ–è¡¨ç¤ºä¸ºï¼š</p>
<p>$$
\boldsymbol{y} = \sum_{i=1}^{n} g_i(\boldsymbol{x}) \boldsymbol{e}_i(\boldsymbol{x})
$$</p>
<p>å…¶ä¸­ï¼š
- $\boldsymbol{x} \in \mathbb{R}^d$ æ˜¯è¾“å…¥tokençš„è¡¨ç¤º
- $n$ æ˜¯ä¸“å®¶ï¼ˆExpertï¼‰çš„æ€»æ•°
- $\boldsymbol{e}<em i="1">i: \mathbb{R}^d \to \mathbb{R}^{d'}$ æ˜¯ç¬¬ $i$ ä¸ªä¸“å®¶ç½‘ç»œ
- $g_i: \mathbb{R}^d \to \mathbb{R}$ æ˜¯é—¨æ§ï¼ˆGatingï¼‰å‡½æ•°ï¼Œæ»¡è¶³ $\sum</em>) = 1$}^n g_i(\boldsymbol{x</p>
<h4 id="12-top-kmoe">1.2 Top-Kç¨€ç–åŒ–MoE</h4>
<p>ä¸ºäº†è®¡ç®—æ•ˆç‡ï¼Œå®é™…åº”ç”¨ä¸­é€šå¸¸é‡‡ç”¨Top-Kç¨€ç–åŒ–çš„MoEï¼š</p>
<p>$$
\boldsymbol{y} = \sum_{i \in \mathcal{T}_k(\boldsymbol{x})} \tilde{g}_i(\boldsymbol{x}) \boldsymbol{e}_i(\boldsymbol{x})
$$</p>
<p>å…¶ä¸­ $\mathcal{T}_k(\boldsymbol{x}) = \mathop{\text{argtop}}_k {\rho_1(\boldsymbol{x}), \ldots, \rho_n(\boldsymbol{x})}$ æ˜¯é€‰æ‹©å¾—åˆ†æœ€é«˜çš„ $k$ ä¸ªä¸“å®¶çš„ç´¢å¼•é›†åˆï¼Œè€Œ</p>
<p>$$
\tilde{g}_i(\boldsymbol{x}) = \frac{\rho_i(\boldsymbol{x})}{\sum_{j \in \mathcal{T}_k(\boldsymbol{x})} \rho_j(\boldsymbol{x})}
$$</p>
<p>æ˜¯é‡å½’ä¸€åŒ–çš„é—¨æ§æƒé‡ã€‚è¿™é‡Œ $\boldsymbol{\rho}(\boldsymbol{x}) = [\rho_1(\boldsymbol{x}), \ldots, \rho_n(\boldsymbol{x})]^T$ æ˜¯è·¯ç”±å™¨ï¼ˆRouterï¼‰çš„è¾“å‡ºå¾—åˆ†ã€‚</p>
<p><strong>è·¯ç”±å™¨çš„å‚æ•°åŒ–</strong>ï¼š</p>
<p>$$
\boldsymbol{\rho}(\boldsymbol{x}) = h(\boldsymbol{x} \boldsymbol{W}^{(R)})
$$</p>
<p>å…¶ä¸­ $\boldsymbol{W}^{(R)} \in \mathbb{R}^{d \times n}$ æ˜¯è·¯ç”±å™¨çš„æƒé‡çŸ©é˜µï¼Œ$h(\cdot)$ æ˜¯æ¿€æ´»å‡½æ•°ï¼ˆå¦‚Softmaxã€Sigmoidã€ReLUç­‰ï¼‰ã€‚</p>
<h3 id="2_1">2. ä¸“å®¶åˆ†é…é—®é¢˜çš„æœ€ä¼˜åŒ–è¡¨è¿°</h3>
<h4 id="21">2.1 è´Ÿè½½å‡è¡¡ä½œä¸ºçº¦æŸä¼˜åŒ–é—®é¢˜</h4>
<p>è€ƒè™‘ä¸€ä¸ªæ‰¹æ¬¡ï¼ˆbatchï¼‰ä¸­æœ‰ $m$ ä¸ªtokenï¼Œè®°ä¸º ${\boldsymbol{x}_1, \ldots, \boldsymbol{x}_m}$ã€‚ä¸“å®¶åˆ†é…é—®é¢˜å¯ä»¥è¡¨è¿°ä¸ºä»¥ä¸‹ä¼˜åŒ–é—®é¢˜ï¼š</p>
<p>$$
\begin{align}
\max_{\{S_i\}_{i=1}^{m}} \quad & \sum_{t=1}^{m} \sum_{i \in S_t} \rho_i(\boldsymbol{x}_t) \\
\text{s.t.} \quad & |S_t| = k, \quad \forall t = 1, \ldots, m \\
& \left|\bigcup_{t: i \in S_t} \{t\}\right| \leq C, \quad \forall i = 1, \ldots, n
\end{align}
$$</p>
<p>å…¶ä¸­ï¼š
- $S_t \subseteq {1, \ldots, n}$ æ˜¯åˆ†é…ç»™ç¬¬ $t$ ä¸ªtokençš„ä¸“å®¶é›†åˆ
- ç¬¬ä¸€ä¸ªçº¦æŸä¿è¯æ¯ä¸ªtokenæ°å¥½é€‰æ‹© $k$ ä¸ªä¸“å®¶
- ç¬¬äºŒä¸ªçº¦æŸæ˜¯å®¹é‡çº¦æŸï¼ˆCapacity Constraintï¼‰ï¼Œé™åˆ¶æ¯ä¸ªä¸“å®¶æœ€å¤šå¤„ç† $C$ ä¸ªtoken
- $C = \lceil \frac{mk}{n} \cdot \gamma \rceil$ æ˜¯å®¹é‡ä¸Šé™ï¼Œ$\gamma \geq 1$ æ˜¯å®¹é‡å› å­ï¼ˆCapacity Factorï¼‰</p>
<p><strong>å½“ $\gamma = 1$ æ—¶çš„å®Œç¾å‡è¡¡</strong>ï¼šå®¹é‡æ°å¥½ç­‰äº $C = \frac{mk}{n}$ï¼Œè¿™æ„å‘³ç€æ‰€æœ‰ä¸“å®¶çš„è´Ÿè½½å®Œå…¨å‡è¡¡ã€‚</p>
<h4 id="22-linear-assignment-problem">2.2 çº¿æ€§æŒ‡æ´¾é—®é¢˜ï¼ˆLinear Assignment Problemï¼‰</h4>
<p>å½“ $k=1$ æ—¶ï¼Œä¸Šè¿°é—®é¢˜é€€åŒ–ä¸ºç»å…¸çš„çº¿æ€§æŒ‡æ´¾é—®é¢˜ï¼š</p>
<p>$$
\begin{align}
\min_{A \in \mathcal{P}} \quad & \sum_{t=1}^{m} \sum_{i=1}^{n} c_{ti} a_{ti} \\
\text{s.t.} \quad & \sum_{i=1}^{n} a_{ti} = 1, \quad \forall t \\
& \sum_{t=1}^{m} a_{ti} \leq C, \quad \forall i \\
& a_{ti} \in \{0, 1\}
\end{align}
$$</p>
<p>å…¶ä¸­ $c_{ti} = -\rho_i(\boldsymbol{x}<em ti="ti">t)$ æ˜¯æˆæœ¬çŸ©é˜µï¼Œ$a</em>$ æ˜¯æŒ‡ç¤ºå˜é‡ï¼ˆtoken $t$ æ˜¯å¦åˆ†é…ç»™ä¸“å®¶ $i$ï¼‰ã€‚</p>
<p>è¿™ä¸ªé—®é¢˜å¯ä»¥ç”¨<strong>åŒˆç‰™åˆ©ç®—æ³•</strong>ï¼ˆHungarian Algorithmï¼‰æˆ–<strong>Kuhn-Munkresç®—æ³•</strong>åœ¨ $O(m^3)$ æ—¶é—´å†…æ±‚è§£ï¼Œä½†å­˜åœ¨ä»¥ä¸‹é™åˆ¶ï¼š
1. ä»…é€‚ç”¨äº $k=1$ çš„æƒ…å†µ
2. éœ€è¦å…¨å±€ä¿¡æ¯ï¼ˆæ•´ä¸ªbatchçš„æ‰€æœ‰tokenï¼‰ï¼Œä¸é€‚åˆè‡ªå›å½’æ¨ç†
3. è®¡ç®—å¤æ‚åº¦è¾ƒé«˜</p>
<h3 id="3">3. è´Ÿè½½å‡è¡¡çº¦æŸçš„æ•°å­¦è¡¨å¾</h3>
<h4 id="31">3.1 è´Ÿè½½åˆ†å¸ƒçš„å®šä¹‰</h4>
<p>å¯¹äºå•ä¸ªtoken $\boldsymbol{x}$ï¼Œå®šä¹‰å…¶ä¸“å®¶é€‰æ‹©çš„one-hotå‘é‡ï¼š</p>
<p>$$
f_i = \begin{cases}
\frac{1}{k}, & i \in \mathop{\text{argtop}}_k \boldsymbol{\rho}(\boldsymbol{x}) \\
0, & \text{otherwise}
\end{cases}
$$</p>
<p>è¿™é‡Œé™¤ä»¥ $k$ æ˜¯ä¸ºäº†å½’ä¸€åŒ–ï¼Œä½¿å¾— $\sum_{i=1}^{n} f_i = 1$ã€‚</p>
<p><strong>æ‰¹æ¬¡çº§åˆ«çš„è´Ÿè½½åˆ†å¸ƒ</strong>ï¼šå¯¹äºåŒ…å« $m$ ä¸ªtokençš„æ‰¹æ¬¡ï¼Œä¸“å®¶ $i$ çš„å¹³å‡è´Ÿè½½ä¸ºï¼š</p>
<p>$$
F_i = \frac{1}{m} \sum_{t=1}^{m} f_i^{(t)} = \mathbb{E}_{\boldsymbol{x} \sim \mathcal{D}}[f_i(\boldsymbol{x})]
$$</p>
<p>å…¶ä¸­ $\mathcal{D}$ æ˜¯è®­ç»ƒæ•°æ®åˆ†å¸ƒã€‚</p>
<p><strong>ç†æƒ³å‡åŒ€åˆ†å¸ƒ</strong>ï¼š</p>
<p>$$
Q_i = \frac{1}{n}, \quad \forall i = 1, \ldots, n
$$</p>
<p>æ»¡è¶³ $\sum_{i=1}^{n} Q_i = 1$ã€‚</p>
<h4 id="32">3.2 è´Ÿè½½ä¸å‡è¡¡çš„åº¦é‡</h4>
<p>å¸¸ç”¨çš„åº¦é‡åŒ…æ‹¬ï¼š</p>
<p><strong>ï¼ˆ1ï¼‰L2è·ç¦»ï¼ˆæ¬§æ°è·ç¦»ï¼‰</strong>ï¼š</p>
<p>$$
\mathcal{D}_2(\boldsymbol{F}, \boldsymbol{Q}) = \|\boldsymbol{F} - \boldsymbol{Q}\|_2 = \sqrt{\sum_{i=1}^{n} (F_i - Q_i)^2}
$$</p>
<p><strong>ï¼ˆ2ï¼‰KLæ•£åº¦ï¼ˆKullback-Leibler Divergenceï¼‰</strong>ï¼š</p>
<p>$$
\mathcal{D}_{\text{KL}}(\boldsymbol{F} \| \boldsymbol{Q}) = \sum_{i=1}^{n} F_i \log \frac{F_i}{Q_i}
$$</p>
<p><strong>ï¼ˆ3ï¼‰å˜å¼‚ç³»æ•°ï¼ˆCoefficient of Variationï¼‰</strong>ï¼š</p>
<p>$$
\text{CV}(\boldsymbol{F}) = \frac{\sqrt{\text{Var}(\boldsymbol{F})}}{\mathbb{E}[\boldsymbol{F}]} = \frac{\sqrt{\frac{1}{n}\sum_{i=1}^{n} (F_i - \frac{1}{n})^2}}{\frac{1}{n}} = \sqrt{n \sum_{i=1}^{n} (F_i - \frac{1}{n})^2}
$$</p>
<p>æœ¬æ–‡é‡‡ç”¨L2è·ç¦»çš„å¹³æ–¹ä½œä¸ºä¼˜åŒ–ç›®æ ‡ï¼Œè¿™åœ¨æ•°å­¦ä¸Šæ›´åŠ æ–¹ä¾¿å¤„ç†ã€‚</p>
<h3 id="4">4. è·¯ç”±ç­–ç•¥çš„æ•°å­¦åˆ†æ</h3>
<h4 id="41">4.1 å¸¸è§æ¿€æ´»å‡½æ•°çš„æ€§è´¨</h4>
<p><strong>ï¼ˆ1ï¼‰Softmaxæ¿€æ´»</strong>ï¼š</p>
<p>$$
\rho_i^{(\text{softmax})}(\boldsymbol{x}) = \frac{\exp(z_i)}{\sum_{j=1}^{n} \exp(z_j)}
$$</p>
<p>å…¶ä¸­ $z_i = \boldsymbol{x}^T \boldsymbol{w}_i^{(R)}$ æ˜¯ç¬¬ $i$ ä¸ªä¸“å®¶çš„logitã€‚</p>
<p><strong>æ€§è´¨</strong>ï¼š
- æ¦‚ç‡çº¦æŸï¼š$\sum_{i=1}^{n} \rho_i = 1$
- å€¼åŸŸï¼š$\rho_i \in (0, 1)$
- æ¢¯åº¦ï¼š$\frac{\partial \rho_i}{\partial z_j} = \rho_i (\delta_{ij} - \rho_j)$ï¼Œå…¶ä¸­ $\delta_{ij}$ æ˜¯Kronecker delta</p>
<p><strong>ï¼ˆ2ï¼‰Sigmoidæ¿€æ´»</strong>ï¼š</p>
<p>$$
\rho_i^{(\text{sigmoid})}(\boldsymbol{x}) = \sigma(z_i) = \frac{1}{1 + \exp(-z_i)}
$$</p>
<p><strong>æ€§è´¨</strong>ï¼š
- ç‹¬ç«‹æ€§ï¼šæ¯ä¸ª $\rho_i$ ç‹¬ç«‹è®¡ç®—
- å€¼åŸŸï¼š$\rho_i \in (0, 1)$
- æ¢¯åº¦ï¼š$\frac{\partial \rho_i}{\partial z_i} = \rho_i(1 - \rho_i)$
- <strong>ä¸æ»¡è¶³æ¦‚ç‡çº¦æŸ</strong>ï¼š$\sum_{i=1}^{n} \rho_i \neq 1$ï¼ˆä¸€èˆ¬æƒ…å†µï¼‰</p>
<p><strong>ï¼ˆ3ï¼‰ReLUæ¿€æ´»</strong>ï¼š</p>
<p>$$
\rho_i^{(\text{ReLU})}(\boldsymbol{x}) = \max(0, z_i)
$$</p>
<p><strong>æ€§è´¨</strong>ï¼š
- å€¼åŸŸï¼š$\rho_i \in [0, +\infty)$
- ç¨€ç–æ€§ï¼šå¯èƒ½äº§ç”Ÿå¾ˆå¤šé›¶å€¼
- æ¢¯åº¦ï¼š$\frac{\partial \rho_i}{\partial z_i} = \mathbb{1}_{z_i &gt; 0}$ï¼ˆå‡ ä¹å¤„å¤„å¯å¯¼ï¼‰</p>
<h4 id="42-top-k">4.2 Top-Ké€‰æ‹©çš„éå¹³æ»‘æ€§</h4>
<p>Top-Kæ“ä½œå®šä¹‰ä¸ºï¼š</p>
<p>$$
\mathop{\text{argtop}}_k \boldsymbol{\rho} = \{i_1, \ldots, i_k\}
$$</p>
<p>å…¶ä¸­ $\rho_{i_1} \geq \rho_{i_2} \geq \cdots \geq \rho_{i_k} \geq \rho_j$ å¯¹æ‰€æœ‰ $j \notin {i_1, \ldots, i_k}$ã€‚</p>
<p><strong>é—®é¢˜</strong>ï¼šè¿™æ˜¯ä¸€ä¸ª<strong>ç¦»æ•£çš„ã€ä¸å¯å¾®çš„</strong>æ“ä½œï¼š
- å½“ $\rho_i$ å‘ç”Ÿå¾®å°å˜åŒ–æ—¶ï¼Œé€‰æ‹©é›†åˆ $\mathcal{T}_k$ å¯èƒ½å‘ç”Ÿçªå˜
- æ ‡å‡†çš„åå‘ä¼ æ’­æ— æ³•ç›´æ¥åº”ç”¨</p>
<p><strong>æ¢¯åº¦è¿‘ä¼¼æ–¹æ³•</strong>ï¼š</p>
<p>ï¼ˆ1ï¼‰<strong>ç›´é€šä¼°è®¡å™¨ï¼ˆStraight-Through Estimator, STEï¼‰</strong>ï¼š</p>
<p>$$
\frac{\partial \mathcal{L}}{\partial \rho_i} \approx \begin{cases}
\frac{\partial \mathcal{L}}{\partial \tilde{\rho}_i}, & i \in \mathcal{T}_k \\
0, & \text{otherwise}
\end{cases}
$$</p>
<p>å…¶ä¸­ $\tilde{\rho}_i$ æ˜¯å½’ä¸€åŒ–åçš„é—¨æ§æƒé‡ã€‚</p>
<p>ï¼ˆ2ï¼‰<strong>Gumbel-Softmaxæ¾å¼›</strong>ï¼šç”¨è¿ç»­åˆ†å¸ƒè¿‘ä¼¼ç¦»æ•£é‡‡æ ·ã€‚</p>
<p>ï¼ˆ3ï¼‰<strong>æœ¬æ–‡æ–¹æ³•ï¼ˆLoss-Freeï¼‰</strong>ï¼šå¼•å…¥åç½®é¡¹ $\boldsymbol{b}$ï¼Œå°†Top-Kçš„è¾“å…¥ä» $\boldsymbol{\rho}$ æ”¹ä¸º $\boldsymbol{\rho} + \boldsymbol{b}$ã€‚</p>
<h3 id="5-loss-free">5. Loss-Freeæ–¹æ³•çš„æœ€ä¼˜åŒ–ç†è®º</h3>
<h4 id="51">5.1 åç½®é¡¹çš„å¼•å…¥</h4>
<p><strong>æ ¸å¿ƒè§‚å¯Ÿ</strong>ï¼šå¯¹äºä»»æ„ç»™å®šçš„è·¯ç”±å¾—åˆ† $\boldsymbol{\rho}$ï¼Œæ€»å­˜åœ¨ä¸€ä¸ªåç½®å‘é‡ $\boldsymbol{b} \in \mathbb{R}^n$ï¼Œä½¿å¾—åŸºäº $\boldsymbol{\rho} + \boldsymbol{b}$ çš„Top-Ké€‰æ‹©è¾¾åˆ°è´Ÿè½½å‡è¡¡ã€‚</p>
<p><strong>æ•°å­¦è¡¨è¿°</strong>ï¼šå­˜åœ¨ $\boldsymbol{b}^* \in \mathbb{R}^n$ï¼Œä½¿å¾—</p>
<p>$$
\mathbb{E}_{\boldsymbol{x} \sim \mathcal{D}}\left[\boldsymbol{f}(\boldsymbol{x}; \boldsymbol{b}^*)\right] = \boldsymbol{Q}
$$</p>
<p>å…¶ä¸­</p>
<p>$$
f_i(\boldsymbol{x}; \boldsymbol{b}) = \begin{cases}
\frac{1}{k}, & i \in \mathop{\text{argtop}}_k (\boldsymbol{\rho}(\boldsymbol{x}) + \boldsymbol{b}) \\
0, & \text{otherwise}
\end{cases}
$$</p>
<p><strong>å­˜åœ¨æ€§è¯æ˜ï¼ˆæ„é€ æ€§ï¼‰</strong>ï¼š</p>
<p>è€ƒè™‘æ˜ å°„ $\Phi: \mathbb{R}^n \to \mathbb{R}^n$ï¼š</p>
<p>$$
\Phi(\boldsymbol{b}) = \mathbb{E}_{\boldsymbol{x} \sim \mathcal{D}}\left[\boldsymbol{f}(\boldsymbol{x}; \boldsymbol{b})\right] - \boldsymbol{Q}
$$</p>
<p>ç›®æ ‡æ˜¯æ‰¾åˆ° $\boldsymbol{b}^<em>$ ä½¿å¾— $\Phi(\boldsymbol{b}^</em>) = \boldsymbol{0}$ã€‚</p>
<p>é€šè¿‡ä»¥ä¸‹è§‚å¯Ÿå¯ä»¥è¯æ˜è§£çš„å­˜åœ¨æ€§ï¼š
1. å½“ $b_i \to +\infty$ æ—¶ï¼Œä¸“å®¶ $i$ æ€»æ˜¯è¢«é€‰ä¸­ï¼ˆå¯¹æ‰€æœ‰tokenï¼‰ï¼Œå› æ­¤ $F_i \to 1 &gt; Q_i$
2. å½“ $b_i \to -\infty$ æ—¶ï¼Œä¸“å®¶ $i$ ä»ä¸è¢«é€‰ä¸­ï¼Œå› æ­¤ $F_i \to 0 &lt; Q_i$
3. $\Phi_i(\boldsymbol{b})$ å…³äº $b_i$ å•è°ƒé€’å¢ï¼ˆå‡ ä¹å¤„å¤„ï¼‰
4. ç”±ä¸­é—´å€¼å®šç†å’Œä¸åŠ¨ç‚¹å®šç†ï¼Œå­˜åœ¨ $\boldsymbol{b}^<em>$ ä½¿å¾— $\Phi(\boldsymbol{b}^</em>) = \boldsymbol{0}$</p>
<h4 id="52">5.2 ä¼˜åŒ–ç›®æ ‡çš„æ„é€ </h4>
<p>å®šä¹‰æŸå¤±å‡½æ•°ï¼š</p>
<p>$$
\mathcal{L}_{\text{balance}}(\boldsymbol{b}) = \frac{1}{2} \|\boldsymbol{F}(\boldsymbol{b}) - \boldsymbol{Q}\|_2^2 = \frac{1}{2} \sum_{i=1}^{n} (F_i(\boldsymbol{b}) - Q_i)^2
$$</p>
<p>å…¶ä¸­ $\boldsymbol{F}(\boldsymbol{b}) = \mathbb{E}_{\boldsymbol{x} \sim \mathcal{D}}[\boldsymbol{f}(\boldsymbol{x}; \boldsymbol{b})]$ã€‚</p>
<p><strong>ç›®æ ‡</strong>ï¼šæœ€å°åŒ– $\mathcal{L}_{\text{balance}}(\boldsymbol{b})$ ä»¥è¾¾åˆ° $\boldsymbol{F}(\boldsymbol{b}) \approx \boldsymbol{Q}$ã€‚</p>
<p><strong>å›°éš¾</strong>ï¼š$\boldsymbol{F}(\boldsymbol{b})$ å…³äº $\boldsymbol{b}$ ä¸å¯å¾®ï¼ˆå› ä¸ºæ¶‰åŠ $\mathop{\text{argtop}}_k$ æ“ä½œï¼‰ã€‚</p>
<h4 id="53-ste">5.3 ç›´é€šä¼°è®¡å™¨ï¼ˆSTEï¼‰çš„åº”ç”¨</h4>
<p><strong>è§‚å¯Ÿ</strong>ï¼šå°½ç®¡ $F_i(\boldsymbol{b})$ ä¸å¯å¾®ï¼Œä½†æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ä»¥ä¸‹æ€§è´¨ï¼š
- å¢å¤§ $b_i$ ä¼šå¢åŠ ä¸“å®¶ $i$ è¢«é€‰ä¸­çš„æ¦‚ç‡ï¼Œä»è€Œå¢å¤§ $F_i$
- å‡å° $b_i$ ä¼šå‡å°‘ä¸“å®¶ $i$ è¢«é€‰ä¸­çš„æ¦‚ç‡ï¼Œä»è€Œå‡å° $F_i$</p>
<p><strong>STEæ„é€ </strong>ï¼šå°†æŸå¤±å‡½æ•°é‡å†™ä¸º</p>
<p>$$
\mathcal{L}_{\text{balance}}(\boldsymbol{b}) = \frac{1}{2} \|\boldsymbol{b} + \text{sg}[\boldsymbol{F}(\boldsymbol{b}) - \boldsymbol{b}] - \boldsymbol{Q}\|_2^2
$$</p>
<p>å…¶ä¸­ $\text{sg}[\cdot]$ è¡¨ç¤ºstop-gradientæ“ä½œï¼ˆåœ¨åå‘ä¼ æ’­æ—¶è§†ä¸ºå¸¸æ•°ï¼‰ã€‚</p>
<p><strong>æ¢¯åº¦è®¡ç®—</strong>ï¼š</p>
<p>$$
\begin{align}
\nabla_{\boldsymbol{b}} \mathcal{L}_{\text{balance}} &= \nabla_{\boldsymbol{b}} \frac{1}{2} \|\boldsymbol{b} + \text{sg}[\boldsymbol{F} - \boldsymbol{b}] - \boldsymbol{Q}\|_2^2 \\
&= \nabla_{\boldsymbol{b}} \frac{1}{2} \|\boldsymbol{F} - \boldsymbol{Q}\|_2^2 \quad (\text{è§†} \boldsymbol{F} \text{ä¸ºå¸¸æ•°}) \\
&= \boldsymbol{F} - \boldsymbol{Q}
\end{align}
$$</p>
<p>è¿™ä¸ªæ¢¯åº¦å½¢å¼ç®€å•ä¸”ç›´è§‚ï¼š
- å¦‚æœ $F_i &gt; Q_i$ï¼ˆä¸“å®¶ $i$ è¿‡è½½ï¼‰ï¼Œåˆ™ $\nabla_{b_i} \mathcal{L} &gt; 0$ï¼Œæ¢¯åº¦ä¸‹é™ä¼šå‡å° $b_i$
- å¦‚æœ $F_i &lt; Q_i$ï¼ˆä¸“å®¶ $i$ æ¬ è½½ï¼‰ï¼Œåˆ™ $\nabla_{b_i} \mathcal{L} &lt; 0$ï¼Œæ¢¯åº¦ä¸‹é™ä¼šå¢å¤§ $b_i$</p>
<h4 id="54">5.4 æ¢¯åº¦ä¸‹é™æ›´æ–°è§„åˆ™</h4>
<p><strong>æ ‡å‡†SGD</strong>ï¼š</p>
<p>$$
\boldsymbol{b}^{(t+1)} = \boldsymbol{b}^{(t)} - \alpha (\boldsymbol{F}^{(t)} - \boldsymbol{Q})
$$</p>
<p>å…¶ä¸­ $\alpha &gt; 0$ æ˜¯å­¦ä¹ ç‡ï¼Œ$\boldsymbol{F}^{(t)}$ æ˜¯ç¬¬ $t$ æ­¥çš„è´Ÿè½½ç»Ÿè®¡ã€‚</p>
<p><strong>ç¬¦å·æ¢¯åº¦ä¸‹é™ï¼ˆSignSGDï¼‰</strong>ï¼ˆåŸè®ºæ–‡é‡‡ç”¨ï¼‰ï¼š</p>
<p>$$
\boldsymbol{b}^{(t+1)} = \boldsymbol{b}^{(t)} - \alpha \, \text{sign}(\boldsymbol{F}^{(t)} - \boldsymbol{Q})
$$</p>
<p>å…¶ä¸­</p>
<p>$$
\text{sign}(x) = \begin{cases}
+1, & x > 0 \\
0, & x = 0 \\
-1, & x < 0
\end{cases}
$$</p>
<p><strong>ä¼˜ç‚¹</strong>ï¼š
- æ›´æ–°å¹…åº¦ç»Ÿä¸€ï¼Œä¸å— $|F_i - Q_i|$ ç»å¯¹å€¼çš„å½±å“
- ç±»ä¼¼äºAdamç­‰è‡ªé€‚åº”ä¼˜åŒ–å™¨çš„æ•ˆæœ
- é²æ£’æ€§æ›´å¼ºï¼Œä¸å®¹æ˜“å› ä¸ºæŸä¸ªä¸“å®¶è´Ÿè½½æåº¦ä¸å‡è€Œäº§ç”Ÿè¿‡å¤§çš„æ›´æ–°</p>
<p><strong>ç¼ºç‚¹</strong>ï¼š
- å¿½ç•¥äº†ä¸å‡è¡¡ç¨‹åº¦çš„ä¿¡æ¯
- å¯èƒ½åœ¨æ¥è¿‘æœ€ä¼˜ç‚¹æ—¶äº§ç”Ÿéœ‡è¡</p>
<h4 id="55-rms">5.5 RMSå½’ä¸€åŒ–æ¢¯åº¦ä¸‹é™ï¼ˆæ”¹è¿›ç‰ˆï¼‰</h4>
<p>æœ¬æ–‡ä½œè€…æå‡ºçš„æ”¹è¿›æ–¹æ¡ˆï¼š</p>
<p>$$
\boldsymbol{b}^{(t+1)} = \boldsymbol{b}^{(t)} - \alpha \frac{\boldsymbol{F}^{(t)} - \boldsymbol{Q}}{\text{RMS}(\boldsymbol{F}^{(t)} - \boldsymbol{Q})}
$$</p>
<p>å…¶ä¸­RMSï¼ˆRoot Mean Squareï¼‰å®šä¹‰ä¸ºï¼š</p>
<p>$$
\text{RMS}(\boldsymbol{v}) = \sqrt{\frac{1}{n} \sum_{i=1}^{n} v_i^2}
$$</p>
<p><strong>æ€§è´¨åˆ†æ</strong>ï¼š</p>
<p>ï¼ˆ1ï¼‰<strong>å°ºåº¦å½’ä¸€åŒ–</strong>ï¼šå½’ä¸€åŒ–åçš„æ¢¯åº¦çš„RMSå€¼æ’ä¸º1ï¼š</p>
<p>$$
\text{RMS}\left(\frac{\boldsymbol{v}}{\text{RMS}(\boldsymbol{v})}\right) = 1
$$</p>
<p>è¿™ä¸ $\text{sign}(\boldsymbol{v})$ çš„ $\ell_2$ èŒƒæ•°ä¸º $\sqrt{n}$ ä¸åŒï¼Œä½†ä¸¤è€…éƒ½å®ç°äº†å°ºåº¦å½’ä¸€åŒ–ã€‚</p>
<p>ï¼ˆ2ï¼‰<strong>ä¿ç•™ç›¸å¯¹ä¿¡æ¯</strong>ï¼šä¸SignSGDä¸åŒï¼ŒRMSå½’ä¸€åŒ–ä¿ç•™äº†å„åˆ†é‡çš„ç›¸å¯¹å¤§å°å…³ç³»ï¼š</p>
<p>$$
\frac{F_i - Q_i}{\text{RMS}(\boldsymbol{F} - \boldsymbol{Q})} \propto (F_i - Q_i)
$$</p>
<p>è¿™æ„å‘³ç€ä¸å‡è¡¡æ›´ä¸¥é‡çš„ä¸“å®¶ä¼šå¾—åˆ°æ›´å¤§çš„è°ƒæ•´ã€‚</p>
<p>ï¼ˆ3ï¼‰<strong>å‡å°‘éœ‡è¡</strong>ï¼šåœ¨æ¥è¿‘æ”¶æ•›æ—¶ï¼Œ$|\boldsymbol{F} - \boldsymbol{Q}|$ è¾ƒå°ï¼Œå½’ä¸€åŒ–æ¢¯åº¦çš„å„åˆ†é‡ä¹Ÿç›¸åº”å˜å°ï¼Œæœ‰åŠ©äºç¨³å®šæ”¶æ•›ã€‚</p>
<p><strong>ä¸æ ‡å‡†SGDçš„å…³ç³»</strong>ï¼š</p>
<p>RMSå½’ä¸€åŒ–æ¢¯åº¦ä¸‹é™å¯ä»¥çœ‹ä½œæ˜¯è‡ªé€‚åº”å­¦ä¹ ç‡çš„SGDï¼š</p>
<p>$$
\boldsymbol{b}^{(t+1)} = \boldsymbol{b}^{(t)} - \frac{\alpha}{\text{RMS}(\boldsymbol{F}^{(t)} - \boldsymbol{Q})} (\boldsymbol{F}^{(t)} - \boldsymbol{Q})
$$</p>
<p>ç›¸å½“äºæœ‰æ•ˆå­¦ä¹ ç‡ä¸º $\alpha_{\text{eff}} = \frac{\alpha}{\text{RMS}(\boldsymbol{F} - \boldsymbol{Q})}$ã€‚</p>
<h3 id="6">6. æœ€ä¼˜ä¼ è¾“ç†è®ºçš„è”ç³»</h3>
<h4 id="61-optimal-transport">6.1 æœ€ä¼˜ä¼ è¾“é—®é¢˜ï¼ˆOptimal Transportï¼‰</h4>
<p>è´Ÿè½½å‡è¡¡é—®é¢˜å¯ä»¥ä»æœ€ä¼˜ä¼ è¾“ï¼ˆOTï¼‰çš„è§’åº¦æ¥ç†è§£ã€‚ç»™å®šä¸¤ä¸ªæ¦‚ç‡åˆ†å¸ƒï¼š
- æºåˆ†å¸ƒï¼š$\boldsymbol{\mu} = \boldsymbol{F}$ï¼ˆå½“å‰è´Ÿè½½åˆ†å¸ƒï¼‰
- ç›®æ ‡åˆ†å¸ƒï¼š$\boldsymbol{\nu} = \boldsymbol{Q}$ï¼ˆå‡åŒ€åˆ†å¸ƒï¼‰</p>
<p>æœ€ä¼˜ä¼ è¾“é—®é¢˜å¯»æ‰¾ä¸€ä¸ªä¼ è¾“è®¡åˆ’ $\boldsymbol{\pi} \in \mathbb{R}^{n \times n}$ï¼Œä½¿å¾—</p>
<p>$$
\begin{align}
\min_{\boldsymbol{\pi}} \quad & \sum_{i,j=1}^{n} C_{ij} \pi_{ij} \\
\text{s.t.} \quad & \sum_{j=1}^{n} \pi_{ij} = \mu_i, \quad \forall i \\
& \sum_{i=1}^{n} \pi_{ij} = \nu_j, \quad \forall j \\
& \pi_{ij} \geq 0
\end{align}
$$</p>
<p>å…¶ä¸­ $C_{ij}$ æ˜¯ä»ä½ç½® $i$ ä¼ è¾“åˆ°ä½ç½® $j$ çš„æˆæœ¬ã€‚</p>
<p><strong>ç‰¹æ®Šæƒ…å†µ</strong>ï¼šå½“ $C_{ij} = |i - j|^2$ æ—¶ï¼Œè¿™æ˜¯ç»å…¸çš„<strong>Wasserstein-2è·ç¦»</strong>ï¼š</p>
<p>$$
W_2(\boldsymbol{\mu}, \boldsymbol{\nu}) = \left(\min_{\boldsymbol{\pi} \in \Pi(\boldsymbol{\mu}, \boldsymbol{\nu})} \sum_{i,j} C_{ij} \pi_{ij}\right)^{1/2}
$$</p>
<h4 id="62">6.2 ç†µæ­£åˆ™åŒ–æœ€ä¼˜ä¼ è¾“</h4>
<p>ä¸ºäº†æé«˜è®¡ç®—æ•ˆç‡ï¼Œå¼•å…¥<strong>ç†µæ­£åˆ™åŒ–</strong>ï¼š</p>
<p>$$
\min_{\boldsymbol{\pi}} \quad \sum_{i,j=1}^{n} C_{ij} \pi_{ij} + \epsilon H(\boldsymbol{\pi})
$$</p>
<p>å…¶ä¸­ç†µé¡¹å®šä¹‰ä¸ºï¼š</p>
<p>$$
H(\boldsymbol{\pi}) = -\sum_{i,j=1}^{n} \pi_{ij} \log \pi_{ij}
$$</p>
<p>å‚æ•° $\epsilon &gt; 0$ æ§åˆ¶æ­£åˆ™åŒ–å¼ºåº¦ã€‚</p>
<p><strong>ä¼˜ç‚¹</strong>ï¼š
- æœ€ä¼˜è§£å…·æœ‰ $\pi_{ij}^<em> = u_i K_{ij} v_j$ çš„å½¢å¼ï¼Œå…¶ä¸­ $K_{ij} = \exp(-C_{ij}/\epsilon)$
- å¯ä»¥ç”¨</em><em>Sinkhornç®—æ³•</em>*é«˜æ•ˆæ±‚è§£</p>
<h4 id="63-sinkhorn">6.3 Sinkhornç®—æ³•</h4>
<p>Sinkhornç®—æ³•æ˜¯æ±‚è§£ç†µæ­£åˆ™åŒ–OTé—®é¢˜çš„ç»å…¸è¿­ä»£ç®—æ³•ã€‚</p>
<p><strong>åˆå§‹åŒ–</strong>ï¼š</p>
<p>$$
\boldsymbol{u}^{(0)} = \mathbf{1}_n, \quad \boldsymbol{v}^{(0)} = \mathbf{1}_n
$$</p>
<p><strong>è¿­ä»£æ›´æ–°</strong>ï¼ˆç¬¬ $t$ æ¬¡è¿­ä»£ï¼‰ï¼š</p>
<p>$$
\begin{align}
u_i^{(t+1)} &= \frac{\mu_i}{\sum_{j=1}^{n} K_{ij} v_j^{(t)}} = \frac{\mu_i}{(\boldsymbol{K} \boldsymbol{v}^{(t)})_i} \\
v_j^{(t+1)} &= \frac{\nu_j}{\sum_{i=1}^{n} K_{ij} u_i^{(t+1)}} = \frac{\nu_j}{(\boldsymbol{K}^T \boldsymbol{u}^{(t+1)})_j}
\end{align}
$$</p>
<p><strong>æ”¶æ•›æ€§</strong>ï¼šSinkhornç®—æ³•çº¿æ€§æ”¶æ•›åˆ°æœ€ä¼˜è§£ï¼Œæ”¶æ•›é€Ÿåº¦ä¸ $\epsilon$ æœ‰å…³ã€‚</p>
<p><strong>ä¸Loss-Freeçš„è”ç³»</strong>ï¼šLoss-Freeçš„åç½®é¡¹ $\boldsymbol{b}$ å¯ä»¥çœ‹ä½œæ˜¯ä¸€ç§éšå¼çš„æœ€ä¼˜ä¼ è¾“è°ƒæ•´ï¼š
- $\boldsymbol{b}$ çš„ä½œç”¨æ˜¯è°ƒæ•´é€‰æ‹©æ¦‚ç‡ï¼Œä½¿å¾—è´Ÿè½½åˆ†å¸ƒä» $\boldsymbol{F}$ ç§»åŠ¨åˆ° $\boldsymbol{Q}$
- è¿™ç±»ä¼¼äºOTä¸­çš„dual variableï¼ˆå¯¹å¶å˜é‡ï¼‰</p>
<p><strong>å¯¹å¶å½¢å¼</strong>ï¼šæœ€ä¼˜ä¼ è¾“çš„å¯¹å¶é—®é¢˜ä¸º</p>
<p>$$
\max_{\boldsymbol{\phi}, \boldsymbol{\psi}} \quad \sum_{i=1}^{n} \mu_i \phi_i + \sum_{j=1}^{n} \nu_j \psi_j
$$</p>
<p>æ»¡è¶³ $\phi_i + \psi_j \leq C_{ij}$ã€‚åç½®é¡¹ $\boldsymbol{b}$ å¯ä»¥ç†è§£ä¸ºå¯¹å¶å˜é‡çš„ç¦»æ•£åŒ–è¿‘ä¼¼ã€‚</p>
<h3 id="7">7. æ¢¯åº¦è®¡ç®—ä¸åå‘ä¼ æ’­</h3>
<h4 id="71-moe">7.1 å®Œæ•´çš„MoEå‰å‘ä¼ æ’­</h4>
<p>è€ƒè™‘å¸¦åç½®çš„MoEå‰å‘è¿‡ç¨‹ï¼š</p>
<p>$$
\begin{align}
\boldsymbol{z} &= \boldsymbol{x} \boldsymbol{W}^{(R)} \in \mathbb{R}^n \\
\boldsymbol{\rho} &= h(\boldsymbol{z}) \in \mathbb{R}^n \\
\boldsymbol{\rho}' &= \boldsymbol{\rho} + \boldsymbol{b} \\
\mathcal{T}_k &= \mathop{\text{argtop}}_k \boldsymbol{\rho}' \\
\tilde{\boldsymbol{\rho}} &= \text{normalize}(\boldsymbol{\rho}|_{\mathcal{T}_k}) \\
\boldsymbol{y} &= \sum_{i \in \mathcal{T}_k} \tilde{\rho}_i \boldsymbol{e}_i(\boldsymbol{x})
\end{align}
$$</p>
<h4 id="72">7.2 å‚æ•°çš„æ¢¯åº¦</h4>
<p><strong>ï¼ˆ1ï¼‰ä¸“å®¶ç½‘ç»œå‚æ•°çš„æ¢¯åº¦</strong>ï¼š</p>
<p>å¯¹äº $i \in \mathcal{T}_k$ï¼š</p>
<p>$$
\frac{\partial \mathcal{L}}{\partial \boldsymbol{\theta}_i^{(E)}} = \frac{\partial \mathcal{L}}{\partial \boldsymbol{y}} \cdot \frac{\partial \boldsymbol{y}}{\partial \boldsymbol{e}_i} \cdot \frac{\partial \boldsymbol{e}_i}{\partial \boldsymbol{\theta}_i^{(E)}} = \tilde{\rho}_i \frac{\partial \mathcal{L}}{\partial \boldsymbol{y}} \cdot \frac{\partial \boldsymbol{e}_i}{\partial \boldsymbol{\theta}_i^{(E)}}
$$</p>
<p>å¯¹äº $i \notin \mathcal{T}_k$ï¼šæ¢¯åº¦ä¸ºé›¶ï¼ˆå› ä¸ºè¯¥ä¸“å®¶æœªå‚ä¸è®¡ç®—ï¼‰ã€‚</p>
<p><strong>ï¼ˆ2ï¼‰è·¯ç”±å™¨å‚æ•°çš„æ¢¯åº¦</strong>ï¼š</p>
<p>ä½¿ç”¨STEè¿‘ä¼¼ï¼š</p>
<p>$$
\frac{\partial \mathcal{L}}{\partial \boldsymbol{W}^{(R)}} \approx \sum_{i \in \mathcal{T}_k} \frac{\partial \mathcal{L}}{\partial \tilde{\rho}_i} \cdot \frac{\partial \tilde{\rho}_i}{\partial \rho_i} \cdot \frac{\partial \rho_i}{\partial \boldsymbol{z}} \cdot \frac{\partial \boldsymbol{z}}{\partial \boldsymbol{W}^{(R)}}
$$</p>
<p>å…¶ä¸­å½’ä¸€åŒ–çš„æ¢¯åº¦ä¸ºï¼š</p>
<p>$$
\frac{\partial \tilde{\rho}_i}{\partial \rho_j} = \begin{cases}
\frac{1}{Z} - \frac{\rho_i}{Z^2}, & i = j \in \mathcal{T}_k \\
-\frac{\rho_i}{Z^2}, & i \neq j, \, i,j \in \mathcal{T}_k \\
0, & \text{otherwise}
\end{cases}
$$</p>
<p>å…¶ä¸­ $Z = \sum_{j \in \mathcal{T}_k} \rho_j$ã€‚</p>
<p><strong>ï¼ˆ3ï¼‰åç½®é¡¹çš„æ¢¯åº¦</strong>ï¼š</p>
<p>å…³é”®æ˜¯ $\boldsymbol{b}$ <strong>ä¸å‚ä¸å‰å‘è®¡ç®—çš„æƒé‡</strong>ï¼Œåªå‚ä¸Top-Ké€‰æ‹©ã€‚å› æ­¤ï¼š</p>
<p>$$
\frac{\partial \boldsymbol{y}}{\partial \boldsymbol{b}} = \boldsymbol{0}
$$</p>
<p>æ¢è¨€ä¹‹ï¼Œ$\boldsymbol{b}$ å¯¹ä¸»æŸå¤±å‡½æ•° $\mathcal{L}_{\text{LM}}$ çš„æ¢¯åº¦ä¸ºé›¶ï¼</p>
<p>è¿™æ­£æ˜¯Loss-Freeçš„æ ¸å¿ƒä¼˜åŠ¿ï¼š$\boldsymbol{b}$ çš„ä¼˜åŒ–å®Œå…¨ç‹¬ç«‹äºä¸»ä»»åŠ¡ï¼Œä¸ä¼šå¹²æ‰°è¯­è¨€æ¨¡å‹çš„è®­ç»ƒã€‚</p>
<h4 id="73">7.3 åç½®é¡¹çš„ç‹¬ç«‹æ›´æ–°</h4>
<p>$\boldsymbol{b}$ çš„æ›´æ–°ä¸é€šè¿‡ $\mathcal{L}_{\text{LM}}$ çš„æ¢¯åº¦ï¼Œè€Œæ˜¯é€šè¿‡è´Ÿè½½å‡è¡¡ç›®æ ‡ï¼š</p>
<p>$$
\boldsymbol{b}^{(t+1)} = \boldsymbol{b}^{(t)} - \alpha \nabla_{\boldsymbol{b}} \mathcal{L}_{\text{balance}} = \boldsymbol{b}^{(t)} - \alpha (\boldsymbol{F}^{(t)} - \boldsymbol{Q})
$$</p>
<p><strong>æ›´æ–°é¡ºåº</strong>ï¼š
1. å‰å‘ä¼ æ’­ï¼šè®¡ç®— $\mathcal{L}_{\text{LM}}$ å’Œç»Ÿè®¡ $\boldsymbol{F}$
2. åå‘ä¼ æ’­ï¼šæ›´æ–° $\boldsymbol{W}^{(R)}$ å’Œ ${\boldsymbol{\theta}_i^{(E)}}$
3. ç‹¬ç«‹æ›´æ–° $\boldsymbol{b}$</p>
<p>è¿™ä¸ªé¡ºåºä¿è¯äº†ï¼š
- $\boldsymbol{b}$ çš„æ›´æ–°åŸºäºå½“å‰batchçš„çœŸå®è´Ÿè½½ç»Ÿè®¡
- é¿å…äº†"æ³„æ¼æœªæ¥ä¿¡æ¯"çš„é£é™©</p>
<h3 id="8-capacity-factor">8. å®¹é‡å› å­ï¼ˆCapacity Factorï¼‰çš„å½±å“</h3>
<h4 id="81">8.1 å®¹é‡å› å­çš„å®šä¹‰</h4>
<p>å®¹é‡å› å­ $\gamma \geq 1$ å†³å®šäº†æ¯ä¸ªä¸“å®¶çš„æœ€å¤§å®¹é‡ï¼š</p>
<p>$$
C = \left\lceil \frac{mk}{n} \cdot \gamma \right\rceil
$$</p>
<p>å…¶ä¸­ï¼š
- $m$ï¼šbatchä¸­çš„tokenæ•°
- $k$ï¼šæ¯ä¸ªtokené€‰æ‹©çš„ä¸“å®¶æ•°
- $n$ï¼šä¸“å®¶æ€»æ•°
- $\frac{mk}{n}$ï¼šå®Œç¾å‡è¡¡æ—¶æ¯ä¸ªä¸“å®¶çš„å¹³å‡è´Ÿè½½</p>
<h4 id="82-gamma">8.2 ä¸åŒ $\gamma$ å€¼çš„å½±å“</h4>
<p><strong>ï¼ˆ1ï¼‰$\gamma = 1$ï¼ˆç†æƒ³æƒ…å†µï¼‰</strong>ï¼š</p>
<ul>
<li>å®¹é‡æ°å¥½ç­‰äºå¹³å‡è´Ÿè½½</li>
<li><strong>æ— æº¢å‡ºç©ºé—´</strong>ï¼šè¦æ±‚ä¸¥æ ¼çš„è´Ÿè½½å‡è¡¡</li>
<li>ä¼˜ç‚¹ï¼šè®¡ç®—èµ„æºåˆ©ç”¨æœ€ä¼˜</li>
<li>ç¼ºç‚¹ï¼šå¯èƒ½å¯¼è‡´token overflowï¼ˆæŸäº›tokenæ— æ³•åˆ†é…åˆ°kä¸ªä¸“å®¶ï¼‰</li>
</ul>
<p><strong>ï¼ˆ2ï¼‰$\gamma &gt; 1$ï¼ˆå®é™…å¸¸ç”¨ï¼‰</strong>ï¼š</p>
<ul>
<li>æä¾›äº† $(\gamma - 1) \times 100\%$ çš„å†—ä½™å®¹é‡</li>
<li>å…è®¸ä¸€å®šç¨‹åº¦çš„è´Ÿè½½ä¸å‡è¡¡</li>
<li>å¸¸ç”¨å€¼ï¼š$\gamma = 1.25$ æˆ– $\gamma = 1.5$</li>
</ul>
<p><strong>tokenæº¢å‡ºæ¦‚ç‡åˆ†æ</strong>ï¼š</p>
<p>å‡è®¾è´Ÿè½½åˆ†å¸ƒçš„æ ‡å‡†å·®ä¸º $\sigma_F$ï¼Œåˆ™ä¸“å®¶ $i$ çš„å®é™…è´Ÿè½½ $L_i$ å¯ä»¥è¿‘ä¼¼ä¸ºï¼š</p>
<p>$$
L_i \sim \mathcal{N}\left(\frac{mk}{n}, \sigma_F^2 m\right)
$$</p>
<p>æº¢å‡ºæ¦‚ç‡ï¼š</p>
<p>$$
P(\text{overflow}) = P\left(L_i > C\right) = P\left(L_i > \frac{mk}{n} \gamma\right)
$$</p>
<p>æ ‡å‡†åŒ–åï¼š</p>
<p>$$
P(\text{overflow}) \approx 1 - \Phi\left(\frac{(\gamma - 1) mk/n}{\sigma_F \sqrt{m}}\right)
$$</p>
<p>å…¶ä¸­ $\Phi(\cdot)$ æ˜¯æ ‡å‡†æ­£æ€åˆ†å¸ƒçš„CDFã€‚</p>
<p><strong>ç»“è®º</strong>ï¼š
- $\gamma$ è¶Šå¤§ï¼Œæº¢å‡ºæ¦‚ç‡è¶Šä½
- $\sigma_F$ è¶Šå°ï¼ˆè´Ÿè½½è¶Šå‡è¡¡ï¼‰ï¼Œæº¢å‡ºæ¦‚ç‡è¶Šä½
- Loss-Freeé€šè¿‡å‡å° $\sigma_F$ æ¥é™ä½æ‰€éœ€çš„ $\gamma$</p>
<h4 id="83">8.3 å®¹é‡çº¦æŸä¸‹çš„ä¿®æ­£</h4>
<p>å½“å­˜åœ¨å®¹é‡çº¦æŸæ—¶ï¼Œåˆ†é…ç­–ç•¥éœ€è¦ä¿®æ”¹ä¸ºï¼š</p>
<p>$$
\mathcal{T}_k(\boldsymbol{x}_t; \{\ell_i\}) = \begin{cases}
\mathop{\text{argtop}}_k (\boldsymbol{\rho}_t + \boldsymbol{b}) & \text{if no overflow} \\
\text{greedy allocation} & \text{otherwise}
\end{cases}
$$</p>
<p>å…¶ä¸­ $\ell_i$ æ˜¯ä¸“å®¶ $i$ çš„å½“å‰è´Ÿè½½è®¡æ•°ã€‚</p>
<p><strong>è´ªå¿ƒåˆ†é…ç®—æ³•</strong>ï¼šæŒ‰ $\rho_{ti} + b_i$ é™åºéå†ï¼Œè·³è¿‡å·²æ»¡çš„ä¸“å®¶ï¼š</p>
<div class="codehilite"><pre><span></span><code>for i in argsort(Ï_t + b, descending=True):
    if â„“_i &lt; C and |T_k| &lt; k:
        T_k.add(i)
        â„“_i += 1
</code></pre></div>

<h3 id="9">9. æŸå¤±å‡½æ•°è®¾è®¡ï¼ˆè¾…åŠ©æŸå¤±å¯¹æ¯”ï¼‰</h3>
<h4 id="91-aux-loss">9.1 ä¼ ç»Ÿè¾…åŠ©æŸå¤±ï¼ˆAux Lossï¼‰</h4>
<p><strong>å½¢å¼1ï¼šå‡è¡¡æŸå¤±</strong>ï¼ˆSwitch Transformerï¼‰ï¼š</p>
<p>$$
\mathcal{L}_{\text{aux}}^{(1)} = \alpha \sum_{i=1}^{n} F_i P_i
$$</p>
<p>å…¶ä¸­ $P_i = \frac{1}{m} \sum_{t=1}^{m} \rho_{ti}$ æ˜¯ä¸“å®¶ $i$ çš„å¹³å‡å¾—åˆ†ã€‚</p>
<p><strong>ä¼˜åŒ–ç›®æ ‡</strong>ï¼šæœ€å°åŒ–è´Ÿè½½ $F_i$ ä¸å¾—åˆ† $P_i$ çš„ä¹˜ç§¯ï¼Œä¿ƒä½¿é«˜å¾—åˆ†çš„ä¸“å®¶è¢«æ›´å¤šé€‰æ‹©ã€‚</p>
<p><strong>å½¢å¼2ï¼šå˜å¼‚ç³»æ•°æŸå¤±</strong>ï¼š</p>
<p>$$
\mathcal{L}_{\text{aux}}^{(2)} = \alpha \cdot \text{Var}(\boldsymbol{F}) = \alpha \sum_{i=1}^{n} (F_i - \frac{1}{n})^2
$$</p>
<p><strong>æ€»æŸå¤±</strong>ï¼š</p>
<p>$$
\mathcal{L}_{\text{total}} = \mathcal{L}_{\text{LM}} + \mathcal{L}_{\text{aux}}
$$</p>
<p><strong>é—®é¢˜</strong>ï¼š
- æƒé‡ $\alpha$ éš¾ä»¥è°ƒèŠ‚
- $\mathcal{L}_{\text{aux}}$ çš„æ¢¯åº¦ä¼šå½±å“æ‰€æœ‰å‚æ•°ï¼ˆåŒ…æ‹¬è·¯ç”±å™¨å’Œä¸“å®¶ç½‘ç»œï¼‰
- å¯èƒ½æŸå®³ä¸»ä»»åŠ¡æ€§èƒ½</p>
<h4 id="92-loss-free">9.2 Loss-Freeçš„ä¼˜åŠ¿</h4>
<p><strong>å¯¹æ¯”è¡¨</strong>ï¼š</p>
<table>
<thead>
<tr>
<th>ç‰¹æ€§</th>
<th>ä¼ ç»ŸAux Loss</th>
<th>Loss-Free</th>
</tr>
</thead>
<tbody>
<tr>
<td>ä¼˜åŒ–å‚æ•°</td>
<td>å…¨ä½“å‚æ•°</td>
<td>ä»…åç½® $\boldsymbol{b}$</td>
</tr>
<tr>
<td>å¯¹ä¸»ä»»åŠ¡å½±å“</td>
<td>ç›´æ¥å½±å“ $\mathcal{L}_{\text{LM}}$</td>
<td>ä¸å½±å“å‰å‘æƒé‡</td>
</tr>
<tr>
<td>è¶…å‚æ•°</td>
<td>æƒé‡ $\alpha$</td>
<td>å­¦ä¹ ç‡ $\alpha$</td>
</tr>
<tr>
<td>è®­ç»ƒ/æ¨ç†ä¸€è‡´æ€§</td>
<td>ä¸€è‡´</td>
<td>ä¸€è‡´</td>
</tr>
<tr>
<td>å®ç°å¤æ‚åº¦</td>
<td>ä¸­ç­‰</td>
<td>ä½</td>
</tr>
</tbody>
</table>
<p><strong>æ•°å­¦åˆ†æ</strong>ï¼š</p>
<p>ï¼ˆ1ï¼‰<strong>å‚æ•°ç©ºé—´åˆ†ç¦»</strong>ï¼š</p>
<p>ä¼ ç»Ÿæ–¹æ³•ï¼š$\theta = {\boldsymbol{W}^{(R)}, {\boldsymbol{\theta}_i^{(E)}}}$ åŒæ—¶ä¼˜åŒ–ä¸¤ä¸ªç›®æ ‡</p>
<p>$$
\theta^* = \arg\min_{\theta} \left[\mathcal{L}_{\text{LM}}(\theta) + \alpha \mathcal{L}_{\text{aux}}(\theta)\right]
$$</p>
<p>Loss-Freeï¼šå‚æ•°åˆ†ä¸ºä¸¤ç»„
- ä¸»å‚æ•°ï¼š$\theta = {\boldsymbol{W}^{(R)}, {\boldsymbol{\theta}<em _text_LM="\text{LM">i^{(E)}}}$ ä¼˜åŒ– $\mathcal{L}</em>$
- è¾…åŠ©å‚æ•°ï¼š$\boldsymbol{b}$ ä¼˜åŒ– $\mathcal{L}_{\text{balance}}$}</p>
<p>$$
\begin{align}
\theta^* &= \arg\min_{\theta} \mathcal{L}_{\text{LM}}(\theta; \boldsymbol{b}) \\
\boldsymbol{b}^* &= \arg\min_{\boldsymbol{b}} \mathcal{L}_{\text{balance}}(\boldsymbol{b})
\end{align}
$$</p>
<p>ï¼ˆ2ï¼‰<strong>ä¼˜åŒ–æ™¯è§‚ï¼ˆOptimization Landscapeï¼‰</strong>ï¼š</p>
<p>ä¼ ç»Ÿæ–¹æ³•çš„æ¢¯åº¦ï¼š</p>
<p>$$
\nabla_{\theta} \mathcal{L}_{\text{total}} = \nabla_{\theta} \mathcal{L}_{\text{LM}} + \alpha \nabla_{\theta} \mathcal{L}_{\text{aux}}
$$</p>
<p>ä¸¤ä¸ªæ¢¯åº¦å¯èƒ½æ–¹å‘å†²çªï¼Œå¯¼è‡´ä¼˜åŒ–å›°éš¾ã€‚</p>
<p>Loss-Freeçš„æ¢¯åº¦ï¼š</p>
<p>$$
\begin{align}
\nabla_{\theta} \mathcal{L}_{\text{LM}} &\quad \text{(ä¸»ä»»åŠ¡)} \\
\nabla_{\boldsymbol{b}} \mathcal{L}_{\text{balance}} = \boldsymbol{F} - \boldsymbol{Q} &\quad \text{(è´Ÿè½½å‡è¡¡)}
\end{align}
$$</p>
<p>ä¸¤è€…æ­£äº¤ï¼Œäº’ä¸å¹²æ‰°ã€‚</p>
<h3 id="10">10. æ”¶æ•›æ€§åˆ†æä¸ç†è®ºä¿è¯</h3>
<h4 id="101">10.1 åç½®æ›´æ–°çš„æ”¶æ•›æ€§</h4>
<p>è€ƒè™‘è¿ç»­æ—¶é—´çš„æ¢¯åº¦æµï¼ˆGradient Flowï¼‰ï¼š</p>
<p>$$
\frac{d\boldsymbol{b}(t)}{dt} = -(\boldsymbol{F}(\boldsymbol{b}(t)) - \boldsymbol{Q})
$$</p>
<p><strong>Lyapunovå‡½æ•°</strong>ï¼šå®šä¹‰</p>
<p>$$
V(\boldsymbol{b}) = \frac{1}{2} \|\boldsymbol{F}(\boldsymbol{b}) - \boldsymbol{Q}\|_2^2
$$</p>
<p>å…¶æ²¿æ¢¯åº¦æµçš„å¯¼æ•°ä¸ºï¼š</p>
<p>$$
\frac{dV}{dt} = (\boldsymbol{F} - \boldsymbol{Q})^T \frac{d\boldsymbol{F}}{dt} = (\boldsymbol{F} - \boldsymbol{Q})^T \frac{\partial \boldsymbol{F}}{\partial \boldsymbol{b}} \frac{d\boldsymbol{b}}{dt}
$$</p>
<p>å‡è®¾ $\frac{\partial F_i}{\partial b_i} &gt; 0$ï¼ˆå¢å¤§ $b_i$ å¢åŠ  $F_i$ï¼‰ï¼Œå¹¶ä¸” $\frac{\partial F_i}{\partial b_j} \approx 0$ å¯¹ $i \neq j$ï¼Œåˆ™</p>
<p>$$
\frac{dV}{dt} \approx -\sum_{i=1}^{n} (F_i - Q_i) \frac{\partial F_i}{\partial b_i} (F_i - Q_i) = -\sum_{i=1}^{n} \frac{\partial F_i}{\partial b_i} (F_i - Q_i)^2 < 0
$$</p>
<p>å› æ­¤ $V(\boldsymbol{b}(t))$ å•è°ƒé€’å‡ï¼Œç³»ç»Ÿæ”¶æ•›åˆ° $\boldsymbol{F} = \boldsymbol{Q}$ã€‚</p>
<h4 id="102">10.2 ç¦»æ•£åŒ–è¯¯å·®</h4>
<p>å®é™…çš„SignSGDæˆ–RMS-SGDæ˜¯ç¦»æ•£åŒ–çš„ï¼š</p>
<p>$$
\boldsymbol{b}^{(t+1)} = \boldsymbol{b}^{(t)} - \alpha \boldsymbol{g}^{(t)}
$$</p>
<p>å…¶ä¸­ $\boldsymbol{g}^{(t)}$ æ˜¯å½’ä¸€åŒ–æ¢¯åº¦ã€‚</p>
<p><strong>ç¨³å®šæ€§æ¡ä»¶</strong>ï¼šè¦æ±‚å­¦ä¹ ç‡æ»¡è¶³</p>
<p>$$
\alpha < \frac{2}{\lambda_{\max}(\boldsymbol{H})}
$$</p>
<p>å…¶ä¸­ $\boldsymbol{H} = \frac{\partial^2 V}{\partial \boldsymbol{b}^2}$ æ˜¯HessiançŸ©é˜µã€‚</p>
<p>å¯¹äºæœ¬é—®é¢˜ï¼Œç”±äº $\frac{\partial F_i}{\partial b_i}$ é€šå¸¸è¾ƒå°ï¼ˆè´Ÿè½½å˜åŒ–ç¼“æ…¢ï¼‰ï¼Œ$\alpha = 0.001$ è¿œå°äºç¨³å®šæ€§ä¸Šç•Œï¼Œå› æ­¤æ”¶æ•›æœ‰ä¿è¯ã€‚</p>
<h4 id="103">10.3 éšæœºæ€§çš„å½±å“</h4>
<p>å®é™…è®­ç»ƒä¸­ï¼Œ$\boldsymbol{F}$ æ˜¯åŸºäºmini-batchä¼°è®¡çš„ï¼Œå­˜åœ¨æ–¹å·®ï¼š</p>
<p>$$
\boldsymbol{F}_{\text{batch}} = \boldsymbol{F}_{\text{true}} + \boldsymbol{\epsilon}
$$</p>
<p>å…¶ä¸­ $\mathbb{E}[\boldsymbol{\epsilon}] = \boldsymbol{0}$ï¼Œ$\text{Var}(\epsilon_i) = \frac{\sigma_i^2}{m}$ã€‚</p>
<p><strong>å½±å“</strong>ï¼š
- æ›´æ–°å­˜åœ¨å™ªå£°ï¼Œå¯¼è‡´ $\boldsymbol{b}$ åœ¨æœ€ä¼˜ç‚¹é™„è¿‘æŒ¯è¡
- æŒ¯è¡å¹…åº¦ä¸batch size $m$ æˆåæ¯”
- å¯ä»¥é€šè¿‡å¢å¤§ $m$ æˆ–ä½¿ç”¨moving averageæ¥å‡å°æ–¹å·®</p>
<h3 id="11_2">11. å®éªŒç»“æœçš„ç†è®ºè§£é‡Š</h3>
<h4 id="111">11.1 è´Ÿè½½å‡è¡¡æŒ‡æ ‡</h4>
<p>å¸¸ç”¨æŒ‡æ ‡ï¼š</p>
<p><strong>ï¼ˆ1ï¼‰è´Ÿè½½å˜å¼‚ç³»æ•°</strong>ï¼š</p>
<p>$$
\text{CV}(\boldsymbol{F}) = \frac{\sqrt{\text{Var}(\boldsymbol{F})}}{\mathbb{E}[\boldsymbol{F}]} = \sqrt{n \sum_{i=1}^{n} (F_i - \frac{1}{n})^2}
$$</p>
<p><strong>ï¼ˆ2ï¼‰æœ€å¤§/æœ€å°è´Ÿè½½æ¯”</strong>ï¼š</p>
<p>$$
\text{Ratio} = \frac{\max_i F_i}{\min_i F_i}
$$</p>
<p>ç†æƒ³æƒ…å†µï¼š$\text{Ratio} = 1$</p>
<p><strong>ï¼ˆ3ï¼‰ç†µ</strong>ï¼š</p>
<p>$$
H(\boldsymbol{F}) = -\sum_{i=1}^{n} F_i \log F_i
$$</p>
<p>æœ€å¤§å€¼ï¼š$H(\boldsymbol{Q}) = \log n$ï¼ˆå‡åŒ€åˆ†å¸ƒï¼‰</p>
<h4 id="112">11.2 æ€§èƒ½æ”¹è¿›çš„ç†è®ºåŸå› </h4>
<p><strong>ï¼ˆ1ï¼‰è®¡ç®—æ•ˆç‡</strong>ï¼š</p>
<p>å‡è¡¡è´Ÿè½½ä¸‹ï¼Œæ€»è®¡ç®—æ—¶é—´ä¸ºï¼š</p>
<p>$$
T_{\text{total}} = \max_{i} T_i \approx \frac{mk}{n} \cdot T_{\text{expert}}
$$</p>
<p>ä¸å‡è¡¡æ—¶ï¼š</p>
<p>$$
T_{\text{total}} = \max_{i} L_i \cdot T_{\text{expert}} \gg \frac{mk}{n} \cdot T_{\text{expert}}
$$</p>
<p><strong>åŠ é€Ÿæ¯”</strong>ï¼š</p>
<p>$$
\text{Speedup} = \frac{\max_i L_i^{\text{before}}}{\max_i L_i^{\text{after}}} = \frac{\max_i L_i^{\text{before}}}{mk/n}
$$</p>
<p><strong>ï¼ˆ2ï¼‰æ¨¡å‹è´¨é‡</strong>ï¼š</p>
<p>ä¼ ç»ŸAux Lossä¼šæŸå®³ä¸»ä»»åŠ¡ï¼Œå› ä¸ºï¼š</p>
<p>$$
\nabla_{\theta} \mathcal{L}_{\text{LM}} \quad \text{ä¸} \quad \nabla_{\theta} \mathcal{L}_{\text{aux}} \quad \text{å¯èƒ½åå‘}
$$</p>
<p>å¯¼è‡´å¦¥åè§£ï¼š</p>
<p>$$
\theta^* \neq \arg\min_{\theta} \mathcal{L}_{\text{LM}}
$$</p>
<p>Loss-Freeé¿å…äº†è¿™ä¸ªé—®é¢˜ï¼š</p>
<p>$$
\theta^* = \arg\min_{\theta} \mathcal{L}_{\text{LM}}(\theta; \boldsymbol{b}^*)
$$</p>
<p><strong>ï¼ˆ3ï¼‰ä¸“å®¶ä¸“ä¸šåŒ–ï¼ˆExpert Specializationï¼‰</strong>ï¼š</p>
<p>è´Ÿè½½å‡è¡¡æœ‰åŠ©äºæ¯ä¸ªä¸“å®¶å­¦ä¹ ä¸åŒçš„æ¨¡å¼ï¼š</p>
<p>$$
\min_{\{\boldsymbol{\theta}_i^{(E)}\}} \mathbb{E}\left[\sum_{i \in \mathcal{T}_k(\boldsymbol{x})} \tilde{\rho}_i(\boldsymbol{x}) \mathcal{L}(\boldsymbol{e}_i(\boldsymbol{x}), \boldsymbol{y})\right]
$$</p>
<p>å‡è¡¡è´Ÿè½½ç¡®ä¿æ¯ä¸ªä¸“å®¶éƒ½æœ‰è¶³å¤Ÿçš„è®­ç»ƒæ ·æœ¬ï¼Œé¿å…æŸäº›ä¸“å®¶"é¥¿æ­»"ã€‚</p>
<h4 id="113">11.3 æ¶ˆèå®éªŒåˆ†æ</h4>
<p><strong>ï¼ˆ1ï¼‰ä¸åŒæ¿€æ´»å‡½æ•°çš„å½±å“</strong>ï¼š</p>
<ul>
<li>Sigmoidï¼š$\rho_i \in (0,1)$ï¼Œç‹¬ç«‹ï¼Œé€‚åˆ $\alpha=0.001$</li>
<li>Softmaxï¼š$\sum_i \rho_i = 1$ï¼Œç›¸äº’ä¾èµ–ï¼Œå¯èƒ½éœ€è¦è°ƒæ•´ $\alpha$</li>
<li>ReLUï¼š$\rho_i \in [0, \infty)$ï¼Œå°ºåº¦ä¸å›ºå®šï¼Œéœ€è¦ä»”ç»†è°ƒæ•´</li>
</ul>
<p><strong>ï¼ˆ2ï¼‰SignSGD vs RMS-SGD</strong>ï¼š</p>
<p>å®éªŒè¡¨æ˜RMS-SGDé€šå¸¸æ›´å¥½ï¼š
- æ›´å¹³æ»‘çš„æ”¶æ•›æ›²çº¿
- æ›´ä½çš„æœ€ç»ˆCVå€¼
- å¯¹å­¦ä¹ ç‡ $\alpha$ çš„é²æ£’æ€§æ›´å¼º</p>
<p><strong>ç†è®ºè§£é‡Š</strong>ï¼šRMSå½’ä¸€åŒ–ä¿ç•™äº†æ¢¯åº¦çš„æ–¹å‘ä¿¡æ¯ï¼Œè€ŒSignä»…ä¿ç•™ç¬¦å·ï¼Œä¸¢å¤±äº†å¹…åº¦ä¿¡æ¯ã€‚</p>
<p><strong>ï¼ˆ3ï¼‰å­¦ä¹ ç‡ $\alpha$ çš„å½±å“</strong>ï¼š</p>
<ul>
<li>$\alpha$ å¤ªå°ï¼šæ”¶æ•›æ…¢ï¼Œå¯èƒ½åœ¨è®­ç»ƒç»“æŸå‰æœªè¾¾åˆ°å‡è¡¡</li>
<li>$\alpha$ å¤ªå¤§ï¼šå¯èƒ½äº§ç”ŸæŒ¯è¡æˆ–è¿‡å†²</li>
<li>æœ€ä¼˜ $\alpha$ ä¾èµ–äºbatch sizeã€ä¸“å®¶æ•°ç­‰</li>
</ul>
<p><strong>ç»éªŒæ³•åˆ™</strong>ï¼š</p>
<p>$$
\alpha \approx \frac{C_0}{\sqrt{n}}
$$</p>
<p>å…¶ä¸­ $C_0 \approx 0.03$ å¯¹Sigmoidæ¿€æ´»ã€‚</p>
<h3 id="12-vq-vae">12. æ‰©å±•åº”ç”¨ï¼šVQ-VAEçš„ç¼–ç è¡¨åç¼©</h3>
<h4 id="121">12.1 é—®é¢˜æè¿°</h4>
<p>Vector Quantization VAEï¼ˆVQ-VAEï¼‰ä¸­çš„ç¼–ç è¡¨åç¼©ï¼ˆCodebook Collapseï¼‰ï¼šæŸäº›ç¼–ç å‘é‡ä»ä¸è¢«ä½¿ç”¨ï¼Œå¯¼è‡´ç¼–ç è¡¨çš„æœ‰æ•ˆå®¹é‡å‡å°ã€‚</p>
<p><strong>å½¢å¼åŒ–</strong>ï¼šè®¾ç¼–ç è¡¨ ${\boldsymbol{c}_1, \ldots, \boldsymbol{c}_K}$ï¼Œç¼–ç è¿‡ç¨‹ä¸º</p>
<p>$$
\text{encode}(\boldsymbol{z}) = \arg\min_{i} \|\boldsymbol{z} - \boldsymbol{c}_i\|_2
$$</p>
<p><strong>é—®é¢˜</strong>ï¼šæŸäº› $\boldsymbol{c}_i$ å¯èƒ½æ°¸è¿œä¸è¢«é€‰ä¸­ã€‚</p>
<h4 id="122-loss-free">12.2 Loss-Freeè§£å†³æ–¹æ¡ˆ</h4>
<p>å¼•å…¥åç½® $\boldsymbol{b} = [b_1, \ldots, b_K]$ï¼š</p>
<p>$$
\text{encode}(\boldsymbol{z}; \boldsymbol{b}) = \arg\min_{i} \|\boldsymbol{z} - \boldsymbol{c}_i\|_2 + b_i
$$</p>
<p><strong>ç›®æ ‡</strong>ï¼šå‡è¡¡ä½¿ç”¨é¢‘ç‡ $\boldsymbol{F} = [F_1, \ldots, F_K]$ï¼Œå…¶ä¸­</p>
<p>$$
F_i = \mathbb{E}_{\boldsymbol{z}}[\mathbb{1}_{\text{encode}(\boldsymbol{z}; \boldsymbol{b}) = i}]
$$</p>
<p><strong>æ›´æ–°è§„åˆ™</strong>ï¼š</p>
<p>$$
\boldsymbol{b} \leftarrow \boldsymbol{b} - \alpha (\boldsymbol{F} - \boldsymbol{Q})
$$</p>
<p>å…¶ä¸­ $\boldsymbol{Q} = (\frac{1}{K}, \ldots, \frac{1}{K})$ã€‚</p>
<p><strong>ä¼˜åŠ¿</strong>ï¼š
- ä¸éœ€è¦ä¿®æ”¹VQ-VAEçš„æ ¸å¿ƒæŸå¤±
- è®­ç»ƒå’Œæ¨ç†ä¸€è‡´
- è‡ªåŠ¨é€‚åº”æ•°æ®åˆ†å¸ƒ</p>
<hr />
<h3 id="3_1">ç¬¬3éƒ¨åˆ†ï¼šæ•°å­¦ç›´è§‰ã€å¤šè§’åº¦è§£é‡Šä¸ç±»æ¯”</h3>
<h4 id="31_1">3.1 ç”Ÿæ´»åŒ–ç±»æ¯”</h4>
<div class="intuition-box">

### ğŸ§  ç›´è§‰ç†è§£1ï¼šåŒ»é™¢å°±è¯Šåˆ†æµ

**åœºæ™¯**ï¼šåŒ»é™¢æ€¥è¯Šå®¤æœ‰$n=5$ä¸ªåŒ»ç”Ÿï¼ˆExpertï¼‰ï¼Œæ¥äº†å¾ˆå¤šæ‚£è€…ï¼ˆTokenï¼‰ã€‚

**ä¼ ç»ŸTop-Kæ–¹æ³•**ï¼š
- æ¯ä¸ªæ‚£è€…è‡ªè¡Œé€‰æ‹©"çœ‹èµ·æ¥æœ€ä¸“ä¸š"çš„åŒ»ç”Ÿ
- ç»“æœï¼šååŒ»ç‹åŒ»ç”Ÿè¢«é€‰äº†100æ¬¡ï¼Œæ–°äººå¼ åŒ»ç”Ÿåªè¢«é€‰äº†5æ¬¡
- **é—®é¢˜**ï¼šç‹åŒ»ç”Ÿå¿™ä¸è¿‡æ¥ï¼Œå¾ˆå¤šæ‚£è€…è¢«æ‹’ç»ï¼ˆtoken dropï¼‰ï¼Œå¼ åŒ»ç”Ÿå´åœ¨é—²ç€

**Loss-Freeæ–¹æ³•**ï¼š
- å¼•å…¥"ä¼˜å…ˆçº§è°ƒæ•´"$\boldsymbol{b}$ï¼šç»™ç‹åŒ»ç”Ÿé™ä½ä¼˜å…ˆçº§$b_{\text{ç‹}} = -2$ï¼Œç»™å¼ åŒ»ç”Ÿæé«˜ä¼˜å…ˆçº§$b_{\text{å¼ }} = +3$
- æ‚£è€…è¿˜æ˜¯æŒ‰"ä¸“ä¸šåº¦ + ä¼˜å…ˆçº§è°ƒæ•´"æ¥é€‰åŒ»ç”Ÿ
- æ›´æ–°è§„åˆ™ï¼šæ¯å¤©ç»Ÿè®¡å„åŒ»ç”Ÿè´Ÿè½½ï¼Œè¿‡è½½çš„é™ä½ä¼˜å…ˆçº§ï¼Œæ¬ è½½çš„æé«˜ä¼˜å…ˆçº§
- **ç»“æœ**ï¼šå‡ å¤©åè¾¾åˆ°å‡è¡¡ï¼Œæ¯ä¸ªåŒ»ç”Ÿéƒ½å¤„ç†çº¦21ä¸ªæ‚£è€…

**å…³é”®æ´å¯Ÿ**ï¼š
- æˆ‘ä»¬**æ²¡æœ‰æ”¹å˜åŒ»ç”Ÿçš„ä¸“ä¸šèƒ½åŠ›**ï¼ˆæ²¡æœ‰ä¿®æ”¹Expertå‚æ•°ï¼‰
- åªæ˜¯é€šè¿‡"æ’é˜Ÿå«å·ç³»ç»Ÿ"ï¼ˆåç½®$\boldsymbol{b}$ï¼‰è°ƒèŠ‚äº†æ‚£è€…åˆ†é…
- æœ€ç»ˆæ—¢ä¿è¯äº†åŒ»ç–—è´¨é‡ï¼ˆä¸»ä»»åŠ¡ï¼‰ï¼Œåˆå®ç°äº†è´Ÿè½½å‡è¡¡

</div>

<div class="intuition-box">

### ğŸ§  ç›´è§‰ç†è§£2ï¼šå¤©å¹³å¹³è¡¡

**åœºæ™¯**ï¼šä¸€ä¸ª$n$è‡‚å¤©å¹³ï¼Œæ¯è‡‚ä¸Šçš„é‡é‡æ˜¯$F_i$ï¼ˆExpert $i$çš„è´Ÿè½½ï¼‰ã€‚

**ç›®æ ‡**ï¼šè®©å¤©å¹³ä¿æŒå¹³è¡¡ï¼Œå³æ‰€æœ‰$F_i = 1/n$ã€‚

**ä¼ ç»ŸAux Lossæ–¹æ³•**ï¼š
- åœ¨å¤©å¹³çš„æ”¯ç‚¹ä¸Šæ–½åŠ åŠ›ï¼ˆè°ƒæ•´æ‰€æœ‰å‚æ•°ï¼‰
- **é—®é¢˜**ï¼šè¿™ä¼šæ”¹å˜æ•´ä¸ªå¤©å¹³çš„ç»“æ„ï¼Œå¯èƒ½å½±å“å…¶æœ¬èº«çš„åŠŸèƒ½ï¼ˆä¸»ä»»åŠ¡æ€§èƒ½ï¼‰

**Loss-Freeæ–¹æ³•**ï¼š
- åœ¨æ¯è‡‚ä¸‹æ–¹å®‰è£…**å¯è°ƒèŠ‚çš„å«ç‰‡**ï¼ˆåç½®$\boldsymbol{b}$ï¼‰
- å«ç‰‡é«˜åº¦$b_i$ï¼šé‡çš„ä¸€ä¾§é™ä½å«ç‰‡ï¼Œè½»çš„ä¸€ä¾§å‡é«˜å«ç‰‡
- **ä¼˜ç‚¹**ï¼šä¸æ”¹å˜å¤©å¹³æœ¬èº«ï¼Œåªè°ƒèŠ‚å¤–éƒ¨æ”¯æ’‘

**æ•°å­¦ç±»æ¯”**ï¼š
$$\text{é€‰æ‹©}(i) = \mathop{\text{argtop}}_k \underbrace{(\text{èƒ½åŠ›}_i}_{\rho_i} + \underbrace{\text{å«ç‰‡}_i)}_{b_i}$$

</div>

<div class="intuition-box">

### ğŸ§  ç›´è§‰ç†è§£3ï¼šå…¬å¹³æ¸¸æˆçš„è®©åˆ†æœºåˆ¶

**åœºæ™¯**ï¼š$n$ä¸ªé€‰æ‰‹ï¼ˆExpertï¼‰å‚åŠ æ¯”èµ›ï¼Œå®åŠ›ä¸åŒã€‚

**é—®é¢˜**ï¼šå¼ºé€‰æ‰‹æ€»è¢«é€‰ä¸Šï¼Œå¼±é€‰æ‰‹æ²¡æœºä¼šã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼šå¼•å…¥"è®©åˆ†åˆ¶åº¦"
- å¼ºé€‰æ‰‹ï¼ˆè¢«é€‰å¤ªå¤šï¼‰ï¼š$b_i$å‡åˆ†ï¼ˆhandicapï¼‰
- å¼±é€‰æ‰‹ï¼ˆè¢«é€‰å¤ªå°‘ï¼‰ï¼š$b_i$åŠ åˆ†ï¼ˆbonusï¼‰
- æœ€ç»ˆé€‰æ‹©åŸºäº"å®åŠ› + è®©åˆ†"

**ä¸ºä»€ä¹ˆæœ‰æ•ˆï¼Ÿ**
- è®©åˆ†$\boldsymbol{b}$éšæ—¶é—´è‡ªé€‚åº”è°ƒæ•´
- æœ€ç»ˆè¾¾åˆ°å¹³è¡¡ï¼šæ¯ä¸ªé€‰æ‰‹è¢«é€‰çš„æ¬¡æ•°ç›¸å½“
- **å…³é”®**ï¼šè®©åˆ†åˆ¶ä¸æ”¹å˜é€‰æ‰‹æœ¬èº«çš„å®åŠ›è®­ç»ƒï¼ˆä¸»ä»»åŠ¡ä¸å—å½±å“ï¼‰

</div>

<h4 id="32_1">3.2 å‡ ä½•æ„ä¹‰</h4>
<p><strong>å‡ ä½•è§†è§’1ï¼šé«˜ç»´ç©ºé—´ä¸­çš„åˆ†å‰²è¶…å¹³é¢</strong></p>
<div class="intuition-box">

æƒ³è±¡$n$ä¸ªExpertå¯¹åº”$n$ä¸ªåŒºåŸŸï¼Œå°†è¾“å…¥ç©ºé—´$\mathbb{R}^d$åˆ†å‰²ï¼š

$$\mathcal{R}_i = \{\boldsymbol{x}: i \in \mathop{\text{argtop}}_k(\boldsymbol{\rho}(\boldsymbol{x}) + \boldsymbol{b})\}$$

- **æ²¡æœ‰åç½®**ï¼ˆ$\boldsymbol{b} = \boldsymbol{0}$ï¼‰ï¼šåˆ†å‰²è¾¹ç•Œç”±Router $\boldsymbol{\rho}$å†³å®š
  - æŸäº›åŒºåŸŸ$\mathcal{R}_i$å¯èƒ½å¾ˆå¤§ï¼ˆExpert $i$è¿‡è½½ï¼‰
  - æŸäº›åŒºåŸŸå¾ˆå°ï¼ˆExpert $i$æ¬ è½½ï¼‰

- **å¼•å…¥åç½®**ï¼ˆ$\boldsymbol{b} \neq \boldsymbol{0}$ï¼‰ï¼šè¾¹ç•Œå¹³ç§»
  - å¢å¤§$b_i$ â†’ åŒºåŸŸ$\mathcal{R}_i$æ‰©å¤§ï¼ˆæ›´å¤šè¾“å…¥ä¼šé€‰Expert $i$ï¼‰
  - å‡å°$b_i$ â†’ åŒºåŸŸ$\mathcal{R}_i$ç¼©å°

**ç›®æ ‡**ï¼šè°ƒæ•´$\boldsymbol{b}$ä½¿å¾—å„åŒºåŸŸçš„"æ•°æ®å¯†åº¦ç§¯åˆ†"ç›¸ç­‰ï¼š

$$\int_{\mathcal{R}_i} p(\boldsymbol{x}) d\boldsymbol{x} = \frac{1}{n}, \quad \forall i$$

</div>

<p><strong>å‡ ä½•è§†è§’2ï¼šVoronoiå›¾çš„åŠ¨æ€è°ƒæ•´</strong></p>
<div class="intuition-box">

å°†Top-Ké€‰æ‹©çœ‹ä½œ"åŠ æƒVoronoiå›¾"ï¼š
- æ¯ä¸ªExpert $i$æœ‰ä¸€ä¸ª"å¸å¼•åŠ›"$\rho_i(\boldsymbol{x}) + b_i$
- è¾“å…¥$\boldsymbol{x}$è¢«åˆ†é…ç»™å¸å¼•åŠ›æœ€å¤§çš„$k$ä¸ªExpert

ä¼ ç»ŸVoronoiå›¾ï¼ˆ$\boldsymbol{b} = \boldsymbol{0}$ï¼‰ï¼š
- æ ¹æ®$\boldsymbol{\rho}$åˆ’åˆ†
- å¯èƒ½ä¸å‡åŒ€

Loss-Freeçš„åŠ æƒVoronoiå›¾ï¼ˆ$\boldsymbol{b} \neq \boldsymbol{0}$ï¼‰ï¼š
- åç½®$b_i$ç›¸å½“äºæ”¹å˜Expert $i$çš„"å½±å“åŠå¾„"
- é€šè¿‡åŠ¨æ€è°ƒæ•´åŠå¾„è¾¾åˆ°è´Ÿè½½å‡è¡¡

</div>

<h4 id="33">3.3 å¤šè§’åº¦ç†è§£</h4>
<p><strong>ğŸ“Š æœ€ä¼˜åŒ–è§†è§’</strong></p>
<div class="intuition-box">

Loss-Freeå¯ä»¥çœ‹ä½œ**åŒå±‚ä¼˜åŒ–é—®é¢˜**ï¼ˆBi-level Optimizationï¼‰ï¼š

**å¤–å±‚ï¼ˆä¸»ä»»åŠ¡ï¼‰**ï¼š
$$\min_{\theta} \mathcal{L}_{\text{LM}}(\theta; \boldsymbol{b}^*)$$

**å†…å±‚ï¼ˆè´Ÿè½½å‡è¡¡ï¼‰**ï¼š
$$\boldsymbol{b}^* = \arg\min_{\boldsymbol{b}} \|\boldsymbol{F}(\boldsymbol{b}) - \boldsymbol{Q}\|^2$$

**ç±»æ¯”**ï¼š
- å¤–å±‚ = è®­ç»ƒä¸€ä¸ªå¥½æ¨¡å‹
- å†…å±‚ = æ‰¾åˆ°æœ€ä½³çš„èµ„æºåˆ†é…ç­–ç•¥
- ä¸¤è€…è§£è€¦ï¼Œäº’ä¸å¹²æ‰°

</div>

<p><strong>ğŸ“¡ æ§åˆ¶è®ºè§†è§’</strong></p>
<div class="intuition-box">

å°†è´Ÿè½½å‡è¡¡çœ‹ä½œ**åé¦ˆæ§åˆ¶ç³»ç»Ÿ**ï¼š

$$\boldsymbol{b}^{(t+1)} = \boldsymbol{b}^{(t)} - \alpha \underbrace{(\boldsymbol{F}^{(t)} - \boldsymbol{Q})}_{\text{è¯¯å·®ä¿¡å·}}$$

- **è¢«æ§å¯¹è±¡**ï¼šè´Ÿè½½åˆ†å¸ƒ$\boldsymbol{F}$
- **æ§åˆ¶å™¨**ï¼šåç½®æ›´æ–°è§„åˆ™
- **åé¦ˆä¿¡å·**ï¼š$\boldsymbol{F} - \boldsymbol{Q}$ï¼ˆåç¦»å‡åŒ€åˆ†å¸ƒçš„ç¨‹åº¦ï¼‰
- **æ§åˆ¶ç›®æ ‡**ï¼š$\boldsymbol{F} \to \boldsymbol{Q}$

**ç¨³å®šæ€§**ï¼š
- ç³»ç»Ÿæœ‰**Lyapunovå‡½æ•°**$V(\boldsymbol{b}) = \frac{1}{2}\|\boldsymbol{F}(\boldsymbol{b}) - \boldsymbol{Q}\|^2$
- $V$å•è°ƒé€’å‡ â†’ ç³»ç»Ÿæ”¶æ•›

**ç±»æ¯”**ï¼šæ’æ¸©å™¨è‡ªåŠ¨è°ƒèŠ‚æ¸©åº¦

</div>

<p><strong>ğŸ¯ åšå¼ˆè®ºè§†è§’</strong></p>
<div class="intuition-box">

å°†Experté€‰æ‹©çœ‹ä½œ**å¤šäººåšå¼ˆ**ï¼š
- **ç©å®¶**ï¼š$n$ä¸ªExpert
- **ç­–ç•¥**ï¼šæ¯ä¸ªExpertè¯•å›¾å¸å¼•æ›´å¤šToken
- **æ”¶ç›Š**ï¼šè¢«é€‰ä¸­çš„æ¬¡æ•°

**é—®é¢˜**ï¼šçº³ä»€å‡è¡¡å¯èƒ½ä¸å‡è¡¡ï¼ˆæŸäº›Expert dominateï¼‰

**Loss-Freeçš„ä½œç”¨**ï¼šå¼•å…¥"æœºåˆ¶è®¾è®¡"ï¼ˆMechanism Designï¼‰
- é€šè¿‡åç½®$\boldsymbol{b}$è®¾è®¡æ¿€åŠ±æœºåˆ¶
- ä½¿å¾—å‡è¡¡è§£æ°å¥½æ˜¯è´Ÿè½½å‡è¡¡

**æ•°å­¦**ï¼š
$$u_i(\boldsymbol{b}) = F_i - \lambda |F_i - Q_i| \quad \text{(å¸¦æƒ©ç½šçš„æ”¶ç›Š)}$$

åç½®$\boldsymbol{b}$è°ƒæ•´"æƒ©ç½šé¡¹"ï¼Œå¼•å¯¼åšå¼ˆèµ°å‘å‡è¡¡ã€‚

</div>

<p><strong>ğŸ”„ åŠ¨åŠ›ç³»ç»Ÿè§†è§’</strong></p>
<div class="intuition-box">

å°†åç½®æ›´æ–°çœ‹ä½œ**æ¢¯åº¦æµ**ï¼ˆGradient Flowï¼‰ï¼š

$$\frac{d\boldsymbol{b}(t)}{dt} = -\nabla_{\boldsymbol{b}} V(\boldsymbol{b}) = -(\boldsymbol{F}(\boldsymbol{b}(t)) - \boldsymbol{Q})$$

**ç›¸ç©ºé—´**ï¼š$\boldsymbol{b} \in \mathbb{R}^n$

**å¸å¼•å­**ï¼ˆAttractorï¼‰ï¼š$\boldsymbol{b}^*$æ»¡è¶³$\boldsymbol{F}(\boldsymbol{b}^*) = \boldsymbol{Q}$

**è½¨è¿¹**ï¼šä»åˆå§‹$\boldsymbol{b}^{(0)} = \boldsymbol{0}$å‡ºå‘ï¼Œæ²¿æ¢¯åº¦æµæ”¶æ•›åˆ°$\boldsymbol{b}^*$

**ç±»æ¯”**ï¼šæ°´å¾€ä½å¤„æµï¼Œç³»ç»Ÿè‡ªåŠ¨å¯»æ‰¾èƒ½é‡æœ€ä½ç‚¹

</div>

<hr />
<h3 id="4_1">ç¬¬4éƒ¨åˆ†ï¼šæ–¹æ³•è®ºå˜ä½“ã€æ‰¹åˆ¤æ€§æ¯”è¾ƒä¸ä¼˜åŒ–</h3>
<h4 id="41_1">4.1 è´Ÿè½½å‡è¡¡æ–¹æ³•å¯¹æ¯”è¡¨</h4>
<table>
<thead>
<tr>
<th>æ–¹æ³•</th>
<th>æ ¸å¿ƒæ€æƒ³</th>
<th>ä¼˜ç‚¹</th>
<th><strong>ç¼ºé™·</strong></th>
<th><strong>ä¼˜åŒ–æ–¹å‘</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>ä¼ ç»ŸAux Loss</strong></td>
<td>åœ¨ä¸»æŸå¤±ä¸­åŠ å…¥$\mathcal{L}_{\text{aux}}$</td>
<td>âœ… å®ç°ç®€å•<br>âœ… è®­ç»ƒ/æ¨ç†ä¸€è‡´</td>
<td>âŒ <strong>æƒé‡$\alpha$éš¾è°ƒ</strong><br>âŒ æŸå®³ä¸»ä»»åŠ¡æ€§èƒ½<br>âŒ æ¢¯åº¦å†²çª</td>
<td>âœ… è‡ªé€‚åº”$\alpha$<br>âœ… å¤šç›®æ ‡ä¼˜åŒ–ç®—æ³•<br>âœ… æ¢¯åº¦æŠ•å½±</td>
</tr>
<tr>
<td><strong>BASE Layer</strong></td>
<td>çº¿æ€§æŒ‡æ´¾é—®é¢˜</td>
<td>âœ… ç†è®ºæœ€ä¼˜<br>âœ… å®Œç¾å‡è¡¡</td>
<td>âŒ <strong>ä»…é€‚ç”¨$k=1$</strong><br>âŒ è®­ç»ƒ/æ¨ç†ä¸ä¸€è‡´<br>âŒ $O(n^3)$å¤æ‚åº¦</td>
<td>âœ… è¿‘ä¼¼ç®—æ³•ï¼ˆSinkhornï¼‰<br>âœ… æ‰©å±•åˆ°$k&gt;1$<br>âœ… è®­ç»ƒæ—¶ä¹Ÿç”¨Top-K</td>
</tr>
<tr>
<td><strong>Expert Capacity</strong></td>
<td>å›ºå®šå®¹é‡ä¸Šé™</td>
<td>âœ… ç¡¬æ€§ä¿è¯å‡è¡¡<br>âœ… é˜²æ­¢OOM</td>
<td>âŒ <strong>Tokenä¸¢å¼ƒ</strong><br>âŒ è®­ç»ƒä¸ç¨³å®š<br>âŒ å®¹é‡å› å­éš¾è°ƒ</td>
<td>âœ… åŠ¨æ€å®¹é‡<br>âœ… æŸ”æ€§æº¢å‡º<br>âœ… é‡è¦æ€§åŠ æƒ</td>
</tr>
<tr>
<td><strong>Loss-Freeï¼ˆæœ¬æ–‡ï¼‰</strong></td>
<td>å¼•å…¥åç½®$\boldsymbol{b}$</td>
<td>âœ… å‚æ•°è§£è€¦<br>âœ… ä¸æŸå®³ä¸»ä»»åŠ¡<br>âœ… è®­ç»ƒ/æ¨ç†ä¸€è‡´</td>
<td>âŒ <strong>$\boldsymbol{b}$çš„å†—ä½™åº¦</strong><br>âŒ æ¿€æ´»å‡½æ•°ä¾èµ–<br>âŒ ç†è®ºåˆ†æä¸å®Œå¤‡</td>
<td>âœ… çº¦æŸ$\boldsymbol{b}$<br>âœ… è§£è€¦æ¿€æ´»å‡½æ•°<br>âœ… æ”¶æ•›æ€§è¯æ˜</td>
</tr>
</tbody>
</table>
<h4 id="42-aux-loss-">4.2 ä¼ ç»ŸAux Loss - æ‰¹åˆ¤æ€§åˆ†æ</h4>
<div class="analysis-box">

### **æ ¸å¿ƒç¼ºé™·**

**ç¼ºé™·1ï¼šæƒé‡è¶…å‚æ•°$\alpha$æéš¾è°ƒèŠ‚**

**é—®é¢˜æè¿°**ï¼š
- $\alpha$å¤ªå°ï¼šæ— æ³•ä¿ƒè¿›å‡è¡¡ï¼Œè´Ÿè½½ä¸å‡é—®é¢˜ä¾ç„¶å­˜åœ¨
- $\alpha$å¤ªå¤§ï¼šä¸¥é‡æŸå®³è¯­è¨€æ¨¡å‹æ€§èƒ½ï¼Œperplexityä¸Šå‡
- æœ€ä¼˜$\alpha$éšæ•°æ®é›†ã€æ¨¡å‹å¤§å°ã€Expertæ•°é‡å˜åŒ–

**æ ¹æœ¬åŸå› **ï¼š
1. **æ¢¯åº¦å°ºåº¦ä¸åŒ¹é…**ï¼š$\|\nabla_{\theta} \mathcal{L}_{\text{LM}}\|$å’Œ$\|\nabla_{\theta} \mathcal{L}_{\text{aux}}\|$é‡çº§ç›¸å·®å¾ˆå¤§
2. **è®­ç»ƒé˜¶æ®µå˜åŒ–**ï¼šæ—©æœŸéœ€è¦å¼ºå‡è¡¡ï¼ˆå¤§$\alpha$ï¼‰ï¼ŒåæœŸéœ€è¦ç²¾è°ƒï¼ˆå°$\alpha$ï¼‰
3. **ä»»åŠ¡ä¾èµ–æ€§**ï¼šä¸åŒä¸‹æ¸¸ä»»åŠ¡å¯¹å‡è¡¡çš„å®¹å¿åº¦ä¸åŒ

**å®šé‡å½±å“**ï¼ˆæ–‡çŒ®æŠ¥å‘Šï¼‰ï¼š
- Switch Transformer: $\alpha=0.01$æ—¶ï¼Œperplexityä»2.5å‡è‡³2.7ï¼ˆ+8%ï¼‰
- GShard: éœ€è¦å¯¹æ¯ä¸ªä»»åŠ¡å•ç‹¬è°ƒ$\alpha$ï¼ŒèŒƒå›´ä»$0.001$åˆ°$0.1$
- ç½‘æ ¼æœç´¢æˆæœ¬ï¼šè‡³å°‘éœ€è¦10æ¬¡å®éªŒæ‰èƒ½æ‰¾åˆ°åˆç†çš„$\alpha$

**ç¤ºä¾‹æ•°æ®**ï¼š

| $\alpha$ | Perplexity | è´Ÿè½½CV | æœ€ä¼˜ï¼Ÿ |
|---------|-----------|-------|--------|
| 0.001 | 2.50 | 0.45 | âŒ ä¸å‡è¡¡ |
| 0.01 | 2.65 | 0.15 | âš ï¸ å¦¥å |
| 0.1 | 3.20 | 0.08 | âŒ æ€§èƒ½å·® |

---

**ç¼ºé™·2ï¼šæ¢¯åº¦å†²çªå¯¼è‡´æ¬¡ä¼˜è§£**

**é—®é¢˜æè¿°**ï¼š
- $\mathcal{L}_{\text{LM}}$å’Œ$\mathcal{L}_{\text{aux}}$çš„æ¢¯åº¦æ–¹å‘å¯èƒ½ç›¸å
- å¯¼è‡´ä¼˜åŒ–é™·å…¥"æ‹‰é”¯æˆ˜"ï¼Œæ— æ³•è¾¾åˆ°ä¸¤ä¸ªç›®æ ‡çš„æœ€ä¼˜

**æ ¹æœ¬åŸå› **ï¼š
å¤šç›®æ ‡ä¼˜åŒ–ä¸­çš„**Paretoå‰æ²¿**é—®é¢˜ï¼š
$$\min_{\theta} \{\mathcal{L}_{\text{LM}}(\theta), \mathcal{L}_{\text{aux}}(\theta)\}$$

ä¸å­˜åœ¨åŒæ—¶æœ€å°åŒ–ä¸¤è€…çš„$\theta^*$ï¼Œåªèƒ½æ‰¾åˆ°å¦¥åè§£ã€‚

**å®šé‡å½±å“**ï¼š
- æ¢¯åº¦å¤¹è§’ï¼šå®éªŒæ˜¾ç¤ºåœ¨è®­ç»ƒä¸­åæœŸï¼Œ$\cos(\nabla \mathcal{L}_{\text{LM}}, \nabla \mathcal{L}_{\text{aux}}) < -0.5$ï¼ˆæ¥è¿‘åå‘ï¼‰
- æœ€ç»ˆperplexityæ¯”Denseæ¨¡å‹é«˜5%-10%

---

**ç¼ºé™·3ï¼šæ‰€æœ‰å‚æ•°éƒ½è¢«Aux Losså½±å“**

**é—®é¢˜æè¿°**ï¼š
- Aux Lossçš„æ¢¯åº¦ä¼ æ’­åˆ°Router **å’Œ** Expertç½‘ç»œ
- å³ä½¿Expertæœ¬èº«ä¸è´Ÿè½½å‡è¡¡æ— ç›´æ¥å…³ç³»ï¼Œä¹Ÿä¼šè¢«è°ƒæ•´

**æ ¹æœ¬åŸå› **ï¼š
$$\nabla_{\boldsymbol{\theta}_i^{(E)}} \mathcal{L}_{\text{aux}} \neq \boldsymbol{0}$$

å› ä¸º$\mathcal{L}_{\text{aux}}$ä¾èµ–äº$F_i$ï¼Œè€Œ$F_i$é—´æ¥ä¾èµ–äº$\boldsymbol{e}_i(\boldsymbol{x}; \boldsymbol{\theta}_i^{(E)})$ï¼ˆé€šè¿‡è®­ç»ƒåŠ¨æ€ï¼‰ã€‚

**å®šé‡å½±å“**ï¼š
- æ‰€æœ‰$n$ä¸ªExpertçš„å‚æ•°éƒ½éœ€è¦é¢å¤–çš„æ¢¯åº¦è®¡ç®—å’Œæ›´æ–°
- å¢åŠ å†…å­˜å ç”¨å’Œè®¡ç®—æ—¶é—´

---

### **ä¼˜åŒ–æ–¹å‘**

**ä¼˜åŒ–1ï¼šè‡ªé€‚åº”æƒé‡è°ƒæ•´**

**ç­–ç•¥**ï¼šæ ¹æ®è®­ç»ƒé˜¶æ®µåŠ¨æ€è°ƒæ•´$\alpha$ã€‚

**å…¬å¼**ï¼š
$$\alpha(t) = \alpha_0 \cdot \left(1 + \frac{t}{T}\right)^{-\beta}$$

å…¶ä¸­$t$æ˜¯è®­ç»ƒæ­¥æ•°ï¼Œ$T$æ˜¯æ€»æ­¥æ•°ï¼Œ$\beta = 0.5$ã€‚

**æ•ˆæœ**ï¼š
- æ—©æœŸï¼š$\alpha$å¤§ï¼Œå¼ºåˆ¶å‡è¡¡
- åæœŸï¼š$\alpha$å°ï¼Œä¸“æ³¨ä¸»ä»»åŠ¡
- å®éªŒæ˜¾ç¤ºperplexityæ”¹å–„2%-3%

---

**ä¼˜åŒ–2ï¼šæ¢¯åº¦æŠ•å½±ï¼ˆGradient Projectionï¼‰**

**ç­–ç•¥**ï¼šå°†$\nabla \mathcal{L}_{\text{aux}}$æŠ•å½±åˆ°ä¸$\nabla \mathcal{L}_{\text{LM}}$æ­£äº¤çš„æ–¹å‘ã€‚

**å…¬å¼**ï¼š
$$\nabla_{\theta}' = \nabla_{\theta} \mathcal{L}_{\text{aux}} - \frac{(\nabla \mathcal{L}_{\text{aux}})^T (\nabla \mathcal{L}_{\text{LM}})}{\|\nabla \mathcal{L}_{\text{LM}}\|^2} \nabla_{\theta} \mathcal{L}_{\text{LM}}$$

**æ•ˆæœ**ï¼š
- æ¶ˆé™¤æ¢¯åº¦å†²çª
- ç±»ä¼¼äºå¤šä»»åŠ¡å­¦ä¹ ä¸­çš„PCGradæ–¹æ³•

---

**ä¼˜åŒ–3ï¼šåˆ†å±‚Aux Lossï¼ˆåªä½œç”¨äºRouterï¼‰**

**ç­–ç•¥**ï¼šåªå¯¹Routerå‚æ•°åº”ç”¨Aux Lossï¼š
$$\mathcal{L}_{\text{total}} = \mathcal{L}_{\text{LM}} + \alpha \mathcal{L}_{\text{aux}}(\boldsymbol{W}^{(R)})$$

å¹¶é˜»æ­¢Aux Lossæ¢¯åº¦ä¼ æ’­åˆ°Expertï¼š
$$\nabla_{\boldsymbol{\theta}_i^{(E)}} \mathcal{L}_{\text{aux}} = \boldsymbol{0} \quad \text{(æ‰‹åŠ¨è®¾ç½®)}$$

**æ•ˆæœ**ï¼š
- å‡å°‘å¯¹Expertçš„å¹²æ‰°
- ä½†ä»æ— æ³•å®Œå…¨é¿å…æƒé‡è°ƒèŠ‚é—®é¢˜

</div>

<h4 id="43-base-layer-">4.3 BASE Layer - æ‰¹åˆ¤æ€§åˆ†æ</h4>
<div class="analysis-box">

### **æ ¸å¿ƒç¼ºé™·**

**ç¼ºé™·1ï¼šä»…é€‚ç”¨äºTop-1è·¯ç”±ï¼ˆ$k=1$ï¼‰**

**é—®é¢˜æè¿°**ï¼š
- çº¿æ€§æŒ‡æ´¾é—®é¢˜è¦æ±‚æ¯ä¸ªTokenåˆ†é…ç»™æ°å¥½1ä¸ªExpert
- æ— æ³•è‡ªç„¶æ‰©å±•åˆ°$k>1$ï¼ˆæ¯ä¸ªTokené€‰å¤šä¸ªExpertï¼‰

**æ ¹æœ¬åŸå› **ï¼š
$k>1$æ—¶ï¼Œé—®é¢˜å˜ä¸º**äºŒæ¬¡æŒ‡æ´¾é—®é¢˜**ï¼ˆQuadratic Assignment Problemï¼‰ï¼ŒNP-éš¾ã€‚

**å®šé‡å½±å“**ï¼š
- é™åˆ¶äº†æ¨¡å‹çš„è¡¨è¾¾èƒ½åŠ›
- Top-2/Top-3é€šå¸¸æ¯”Top-1æ•ˆæœæ›´å¥½

---

**ç¼ºé™·2ï¼šè®­ç»ƒ/æ¨ç†ä¸ä¸€è‡´**

**é—®é¢˜æè¿°**ï¼š
- **è®­ç»ƒæ—¶**ï¼šç”¨åŒˆç‰™åˆ©ç®—æ³•å…¨å±€ä¼˜åŒ–åˆ†é…ï¼ˆéœ€è¦æ•´ä¸ªbatchï¼‰
- **æ¨ç†æ—¶**ï¼šåªèƒ½é€Tokenç”¨Top-Kï¼ˆè‡ªå›å½’ç”Ÿæˆï¼‰

**æ ¹æœ¬åŸå› **ï¼š
æ¨ç†æ—¶æ— æ³•é¢„çŸ¥æœªæ¥Tokenï¼Œæ— æ³•è¿›è¡Œå…¨å±€ä¼˜åŒ–ã€‚

**å®šé‡å½±å“**ï¼š
- è®­ç»ƒæ—¶è´Ÿè½½å®Œç¾å‡è¡¡ï¼Œæ¨ç†æ—¶ä»ç„¶ä¸å‡ï¼ˆåˆ†å¸ƒæ¼‚ç§»ï¼‰
- å¯¼è‡´å®é™…éƒ¨ç½²æ•ˆæœä¸å¦‚é¢„æœŸ

---

**ç¼ºé™·3ï¼šè®¡ç®—å¤æ‚åº¦é«˜**

**é—®é¢˜æè¿°**ï¼š
åŒˆç‰™åˆ©ç®—æ³•å¤æ‚åº¦$O(n^3)$ï¼Œå½“Expertæ•°é‡$n$å¾ˆå¤§æ—¶ï¼ˆå¦‚$n=128$ï¼‰éå¸¸æ…¢ã€‚

**å®šé‡å½±å“**ï¼š
- å¯¹äº$n=64$ï¼Œæ¯ä¸ªbatché¢å¤–è€—æ—¶~100ms
- æˆä¸ºè®­ç»ƒç“¶é¢ˆ

---

### **ä¼˜åŒ–æ–¹å‘**

**ä¼˜åŒ–1ï¼šè¿‘ä¼¼ç®—æ³•ï¼ˆSinkhornè¿­ä»£ï¼‰**

**ç­–ç•¥**ï¼šç”¨Sinkhornç®—æ³•æ±‚è§£ç†µæ­£åˆ™åŒ–çš„æœ€ä¼˜ä¼ è¾“ã€‚

**ä¼˜ç‚¹**ï¼š
- å¤æ‚åº¦é™è‡³$O(n^2 \cdot K)$ï¼ˆ$K$æ˜¯è¿­ä»£æ¬¡æ•°ï¼Œé€šå¸¸$K < 10$ï¼‰
- å¯å¾®åˆ†ï¼Œæ”¯æŒç«¯åˆ°ç«¯è®­ç»ƒ

**æ•ˆæœ**ï¼š
- é€Ÿåº¦æå‡10-100å€
- ç²¾åº¦ç•¥æœ‰ä¸‹é™ï¼ˆä½†å¯æ¥å—ï¼‰

---

**ä¼˜åŒ–2ï¼šæ‰©å±•åˆ°Top-Kï¼ˆ$k>1$ï¼‰**

**ç­–ç•¥**ï¼šå°†æ¯ä¸ªToken"æ‹†åˆ†"æˆ$k$ä¸ªè™šæ‹ŸTokenï¼Œæ¯ä¸ªè™šæ‹ŸTokenåˆ†é…ç»™1ä¸ªExpertã€‚

**æŒ‘æˆ˜**ï¼š
- éœ€è¦é¢å¤–çš„çº¦æŸç¡®ä¿$k$ä¸ªè™šæ‹ŸTokené€‰æ‹©ä¸åŒçš„Expert
- ä»ç„¶æ˜¯NP-éš¾é—®é¢˜ï¼Œéœ€è¦å¯å‘å¼ç®—æ³•

---

**ä¼˜åŒ–3ï¼šè®­ç»ƒæ—¶ä¹Ÿä½¿ç”¨Top-K**

**ç­–ç•¥**ï¼šæ”¾å¼ƒå®Œç¾å‡è¡¡ï¼Œè®­ç»ƒæ—¶ä¹Ÿç”¨Top-K + è½¯çº¦æŸã€‚

**æ•ˆæœ**ï¼š
- æ¢å¤è®­ç»ƒ/æ¨ç†ä¸€è‡´æ€§
- ä½†å¤±å»äº†BASEçš„ä¸»è¦ä¼˜åŠ¿ï¼ˆæœ€ä¼˜åˆ†é…ï¼‰

</div>

<h4 id="44-loss-free-">4.4 Loss-Freeæ–¹æ³• - æ‰¹åˆ¤æ€§åˆ†æ</h4>
<div class="analysis-box">

### **æ ¸å¿ƒç¼ºé™·**

**ç¼ºé™·1ï¼šåç½®$\boldsymbol{b}$å­˜åœ¨å†—ä½™è‡ªç”±åº¦**

**é—®é¢˜æè¿°**ï¼š
- $\boldsymbol{b}$å’Œ$\boldsymbol{b} + c \cdot \mathbf{1}_n$ï¼ˆæ‰€æœ‰åˆ†é‡åŠ å¸¸æ•°$c$ï¼‰æ•ˆæœç›¸åŒ
- å› ä¸ºTop-Kåªå…³å¿ƒç›¸å¯¹å¤§å°ï¼Œä¸å…³å¿ƒç»å¯¹å€¼

**æ ¹æœ¬åŸå› **ï¼š
$$\mathop{\text{argtop}}_k(\boldsymbol{\rho} + \boldsymbol{b}) = \mathop{\text{argtop}}_k(\boldsymbol{\rho} + \boldsymbol{b} + c \cdot \mathbf{1}_n)$$

**å®šé‡å½±å“**ï¼š
- $\boldsymbol{b}$çš„ç»å¯¹å€¼å¯èƒ½æ¼‚ç§»ï¼ˆè¶Šæ¥è¶Šå¤§æˆ–è¶Šæ¥è¶Šå°ï¼‰
- ä¸å½±å“åŠŸèƒ½ï¼Œä½†ä¸å¤Ÿä¼˜é›…

---

**ç¼ºé™·2ï¼šå¯¹æ¿€æ´»å‡½æ•°æœ‰å‡è®¾**

**é—®é¢˜æè¿°**ï¼š
- è®ºæ–‡æ¨è$\alpha=0.001$æ˜¯åŸºäºSigmoidæ¿€æ´»
- å¦‚æœç”¨Softmaxæˆ–ReLUï¼Œéœ€è¦é‡æ–°è°ƒ$\alpha$

**æ ¹æœ¬åŸå› **ï¼š
$\rho_i$çš„å°ºåº¦ä¾èµ–äºæ¿€æ´»å‡½æ•°ï¼š
- Sigmoid: $\rho_i \in (0, 1)$
- ReLU: $\rho_i \in [0, \infty)$

$\boldsymbol{b}$çš„æ›´æ–°å¹…åº¦$\alpha$éœ€è¦ä¸$\rho_i$çš„å°ºåº¦åŒ¹é…ã€‚

**å®šé‡å½±å“**ï¼š
- Softmaxæ—¶ï¼Œ$\alpha=0.001$å¯èƒ½å¤ªå¤§ï¼Œå¯¼è‡´æŒ¯è¡
- ReLUæ—¶ï¼Œå¯èƒ½éœ€è¦$\alpha=0.01$

---

**ç¼ºé™·3ï¼šæ”¶æ•›æ€§ç†è®ºä¸å®Œå¤‡**

**é—®é¢˜æè¿°**ï¼š
- è®ºæ–‡ç»™å‡ºäº†æ¢¯åº¦å…¬å¼ï¼Œä½†æœªä¸¥æ ¼è¯æ˜æ”¶æ•›æ€§
- ç‰¹åˆ«æ˜¯åœ¨éšæœºæ¢¯åº¦ï¼ˆmini-batchï¼‰è®¾ç½®ä¸‹

**æ ¹æœ¬åŸå› **ï¼š
$\boldsymbol{F}(\boldsymbol{b})$å…³äº$\boldsymbol{b}$ä¸è¿ç»­ï¼ˆå› ä¸ºTop-Kæ˜¯ç¦»æ•£çš„ï¼‰ï¼Œæ ‡å‡†ä¼˜åŒ–ç†è®ºä¸é€‚ç”¨ã€‚

**å®šé‡å½±å“**ï¼š
- æç«¯æƒ…å†µä¸‹å¯èƒ½æŒ¯è¡
- éœ€è¦ä»”ç»†é€‰æ‹©å­¦ä¹ ç‡

---

### **ä¼˜åŒ–æ–¹å‘**

**ä¼˜åŒ–1ï¼šçº¦æŸ$\boldsymbol{b}$çš„å‡å€¼**

**ç­–ç•¥**ï¼šåœ¨æ¯æ¬¡æ›´æ–°åï¼Œå¼ºåˆ¶$\sum_{i=1}^{n} b_i = 0$ã€‚

**å®ç°**ï¼š
$$\boldsymbol{b} \leftarrow \boldsymbol{b} - \frac{1}{n}\sum_{i=1}^{n} b_i \cdot \mathbf{1}_n$$

**æ•ˆæœ**ï¼š
- æ¶ˆé™¤å†—ä½™è‡ªç”±åº¦
- $\boldsymbol{b}$çš„ç»å¯¹å€¼ä¸å†æ¼‚ç§»

---

**ä¼˜åŒ–2ï¼šè§£è€¦Gateå’ŒBiasçš„æ¿€æ´»å‡½æ•°**

**ç­–ç•¥**ï¼ˆæœ¬æ–‡å·²æå‡ºï¼‰ï¼š
$$\boldsymbol{y} = \sum_{i\in \mathop{\text{argtop}}_k \boldsymbol{\rho}^{(\sigma)} + \boldsymbol{b}} \rho_i^{(h)} \boldsymbol{e}_i$$

å…¶ä¸­$\boldsymbol{\rho}^{(\sigma)} = \sigma(\boldsymbol{z})$ï¼ˆSigmoidï¼‰ï¼Œ$\boldsymbol{\rho}^{(h)} = h(\boldsymbol{z})$ï¼ˆä»»æ„å•è°ƒå‡½æ•°ï¼‰ã€‚

**ä¼˜ç‚¹**ï¼š
- $\boldsymbol{b}$å§‹ç»ˆä¸Sigmoidçš„è¾“å‡ºç›¸åŠ ï¼Œ$\alpha=0.001$é€‚ç”¨
- $h(\cdot)$å¯ä»¥çµæ´»é€‰æ‹©ï¼ˆå¦‚Softplusã€ReLUï¼‰

---

**ä¼˜åŒ–3ï¼šå»ºç«‹æ”¶æ•›æ€§ç†è®º**

**ç­–ç•¥**ï¼šåˆ©ç”¨éšæœºé€¼è¿‘ç†è®ºï¼ˆStochastic Approximation Theoryï¼‰åˆ†ææ”¶æ•›ã€‚

**å…³é”®æ­¥éª¤**ï¼š
1. è¯æ˜$\mathbb{E}[\nabla_{\boldsymbol{b}} \mathcal{L}] = \boldsymbol{F} - \boldsymbol{Q}$
2. è¯æ˜å™ªå£°æœ‰ç•Œï¼š$\text{Var}[\nabla_{\boldsymbol{b}} \mathcal{L}] \leq C / m$
3. åº”ç”¨Robbins-Monroå®šç†

**æ•ˆæœ**ï¼š
- ç†è®ºä¿è¯æ”¶æ•›åˆ°$\boldsymbol{F} = \boldsymbol{Q}$
- ç»™å‡ºæ”¶æ•›é€Ÿç‡$O(1/\sqrt{T})$

</div>

<hr />
<h3 id="5">ç¬¬5éƒ¨åˆ†ï¼šå­¦ä¹ è·¯çº¿å›¾ä¸æœªæ¥å±•æœ›</h3>
<h4 id="51_1">5.1 å­¦ä¹ è·¯çº¿å›¾</h4>
<p><strong>å¿…å¤‡å‰ç½®çŸ¥è¯†</strong></p>
<p><strong>æ•°å­¦åŸºç¡€</strong>ï¼š
- <strong>çº¿æ€§ä»£æ•°</strong>ï¼šçŸ©é˜µè¿ç®—ã€ç‰¹å¾å€¼ã€æŠ•å½±
- <strong>å‡¸ä¼˜åŒ–</strong>ï¼šæ¢¯åº¦ä¸‹é™ã€çº¦æŸä¼˜åŒ–ã€Lagrangeå¯¹å¶
- <strong>æ¦‚ç‡è®º</strong>ï¼šæœŸæœ›ã€æ–¹å·®ã€å¤§æ•°å®šå¾‹
- <strong>æœ€ä¼˜ä¼ è¾“ç†è®º</strong>ï¼ˆå¯é€‰ï¼‰ï¼šWassersteinè·ç¦»ã€Sinkhornç®—æ³•</p>
<p><strong>æœºå™¨å­¦ä¹ åŸºç¡€</strong>ï¼š
- <strong>æ·±åº¦å­¦ä¹ </strong>ï¼šåå‘ä¼ æ’­ã€ä¼˜åŒ–å™¨ï¼ˆSGDã€Adamï¼‰
- <strong>MoEåŸºç¡€</strong>ï¼šExpertã€Routerã€Top-Ké€‰æ‹©
- <strong>åˆ†å¸ƒå¼è®­ç»ƒ</strong>ï¼šæ•°æ®å¹¶è¡Œã€æ¨¡å‹å¹¶è¡Œã€All-to-Allé€šä¿¡</p>
<p><strong>æ¨èå­¦ä¹ é¡ºåº</strong>ï¼š</p>
<ol>
<li><strong>ç†è§£MoEçš„è´Ÿè½½å‡è¡¡é—®é¢˜</strong></li>
<li>é˜…è¯»GShardè®ºæ–‡ï¼ˆ2020ï¼‰äº†è§£Aux Loss</li>
<li>
<p>é˜…è¯»Switch Transformerè®ºæ–‡ï¼ˆ2021ï¼‰äº†è§£Expert Capacity</p>
</li>
<li>
<p><strong>å­¦ä¹ æŒ‡æ´¾é—®é¢˜</strong></p>
</li>
<li>äº†è§£åŒˆç‰™åˆ©ç®—æ³•</li>
<li>
<p>å­¦ä¹ BASE Layerçš„æ–¹æ³•</p>
</li>
<li>
<p><strong>æŒæ¡Loss-Freeæ–¹æ³•</strong></p>
</li>
<li>é˜…è¯»DeepSeekè®ºæ–‡ï¼ˆ2024ï¼‰</li>
<li>ç†è§£STEï¼ˆStraight-Through Estimatorï¼‰</li>
<li>
<p>å®ç°åç½®æ›´æ–°è§„åˆ™</p>
</li>
<li>
<p><strong>æ‰©å±•åº”ç”¨</strong></p>
</li>
<li>VQ-VAEçš„ç¼–ç è¡¨åç¼©</li>
<li>å…¶ä»–Top-Ké€‰æ‹©åœºæ™¯</li>
</ol>
<hr />
<p><strong>æ ¸å¿ƒè®ºæ–‡åˆ—è¡¨ï¼ˆæŒ‰æ—¶é—´é¡ºåºï¼‰</strong></p>
<p><strong>è´Ÿè½½å‡è¡¡çš„æ—©æœŸå·¥ä½œ</strong>ï¼š
1. Jacobs et al. (1991) - "Adaptive Mixtures of Local Experts"
2. Shazeer et al. (2017) - "Outrageously Large Neural Networks: The Sparsely-Gated MoE Layer" â­</p>
<p><strong>MoEè´Ÿè½½å‡è¡¡æ–¹æ³•</strong>ï¼š
3. Lepikhin et al. (2020) - "GShard: Scaling Giant Models with Conditional Computation" â­
4. Fedus et al. (2021) - "Switch Transformers: Scaling to Trillion Parameter Models" â­
5. Lewis et al. (2021) - "BASE Layers: Simplifying Training of Large Models" â­</p>
<p><strong>Loss-FreeåŠç›¸å…³</strong>ï¼š
6. Liu et al. (2024) - "Auxiliary-Loss-Free Load Balancing Strategy for Mixture-of-Experts" â­â­â­
7. Jiang et al. (2024) - "Mixtral of Experts"
8. DeepSeek-AI (2024) - "DeepSeek-V3"</p>
<p><strong>ç†è®ºåŸºç¡€</strong>ï¼š
9. Cuturi (2013) - "Sinkhorn Distances: Lightspeed Computation of Optimal Transport"
10. PeyrÃ© &amp; Cuturi (2019) - "Computational Optimal Transport"</p>
<hr />
<h4 id="52_1">5.2 ç ”ç©¶ç©ºç™½ä¸æœªæ¥æ–¹å‘</h4>
<h4 id="1-"><strong>æ–¹å‘1ï¼šç†è®ºå±‚é¢ - æ”¶æ•›æ€§ä¸ç¨³å®šæ€§</strong></h4>
<p><strong>ç ”ç©¶ç©ºç™½</strong>ï¼š
- å½“å‰Loss-Freeæ–¹æ³•ç¼ºä¹ä¸¥æ ¼çš„æ”¶æ•›æ€§è¯æ˜ï¼ˆç‰¹åˆ«æ˜¯éšæœºæ¢¯åº¦è®¾ç½®ï¼‰
- åç½®$\boldsymbol{b}$çš„æœ€ä¼˜åˆå§‹åŒ–ç­–ç•¥æœªçŸ¥
- ä¸åŒå­¦ä¹ ç‡$\alpha$å¯¹æ”¶æ•›é€Ÿåº¦çš„å½±å“ç¼ºä¹ç†è®ºåˆ†æ</p>
<p><strong>å…·ä½“ç ”ç©¶é—®é¢˜</strong>ï¼š</p>
<ol>
<li><strong>é—®é¢˜</strong>ï¼šåœ¨ä»€ä¹ˆæ¡ä»¶ä¸‹ï¼Œåç½®æ›´æ–°è§„åˆ™$\boldsymbol{b}^{(t+1)} = \boldsymbol{b}^{(t)} - \alpha(\boldsymbol{F}^{(t)} - \boldsymbol{Q})$ä¿è¯æ”¶æ•›åˆ°$\boldsymbol{F} = \boldsymbol{Q}$ï¼Ÿ</li>
<li><strong>æŒ‘æˆ˜</strong>ï¼š$\boldsymbol{F}(\boldsymbol{b})$å…³äº$\boldsymbol{b}$ä¸è¿ç»­ï¼ˆTop-Kæ˜¯ç¦»æ•£æ“ä½œï¼‰</li>
<li><strong>æ½œåœ¨æ–¹æ³•</strong>ï¼š<ul>
<li>åˆ©ç”¨<strong>éšæœºé€¼è¿‘ç†è®º</strong>ï¼ˆStochastic Approximationï¼‰</li>
<li>è¯æ˜$\boldsymbol{F}(\boldsymbol{b})$å‡ ä¹å¤„å¤„å¯å¾®</li>
<li>å»ºç«‹ç±»Lyapunovåˆ†æ</li>
</ul>
</li>
<li>
<p><strong>æ½œåœ¨æ„ä¹‰</strong>ï¼šç»™å‡ºæ”¶æ•›é€Ÿç‡$O(1/\sqrt{T})$ï¼ŒæŒ‡å¯¼å­¦ä¹ ç‡é€‰æ‹©</p>
</li>
<li>
<p><strong>é—®é¢˜</strong>ï¼šSignSGD vs RMS-SGDçš„ç†è®ºå·®å¼‚ï¼Ÿ</p>
</li>
<li><strong>å·²çŸ¥</strong>ï¼šå®éªŒæ˜¾ç¤ºRMS-SGDé€šå¸¸æ›´å¥½</li>
<li><strong>æœªçŸ¥</strong>ï¼šç†è®ºä¸Šèƒ½å¦è¯æ˜RMS-SGDçš„ä¼˜è¶Šæ€§ï¼Ÿ</li>
<li><strong>æ½œåœ¨æ–¹æ³•</strong>ï¼šåˆ†æä¸¤è€…çš„æ”¶æ•›é€Ÿç‡å’Œç¨³å®šåŸŸ</li>
<li>
<p><strong>æ½œåœ¨æ„ä¹‰</strong>ï¼šä¸ºä¼˜åŒ–å™¨é€‰æ‹©æä¾›ç†è®ºæŒ‡å¯¼</p>
</li>
<li>
<p><strong>é—®é¢˜</strong>ï¼šå¤šå±‚MoEä¸­åç½®çš„ååŒä¼˜åŒ–ï¼Ÿ</p>
</li>
<li><strong>ç°çŠ¶</strong>ï¼šå½“å‰æ¯å±‚çš„$\boldsymbol{b}$ç‹¬ç«‹æ›´æ–°</li>
<li><strong>æ¢ç´¢æ–¹å‘</strong>ï¼šæ˜¯å¦å­˜åœ¨å…¨å±€æœ€ä¼˜çš„è”åˆæ›´æ–°ç­–ç•¥ï¼Ÿ</li>
<li><strong>æ½œåœ¨æ„ä¹‰</strong>ï¼šæå‡å¤šå±‚MoEçš„æ•´ä½“å‡è¡¡æ€§</li>
</ol>
<p><strong>ä¼˜åŒ–æ–¹å‘</strong>ï¼š
- å€Ÿé‰´<strong>éå‡¸ä¼˜åŒ–</strong>ç†è®ºï¼ˆå¦‚Polyak-Åojasiewiczæ¡ä»¶ï¼‰
- å¼€å‘é’ˆå¯¹ç¦»æ•£Top-Kçš„<strong>å¹³æ»‘é€¼è¿‘ç†è®º</strong>
- ç ”ç©¶$\boldsymbol{b}$çš„æœ€ä¼˜åˆå§‹åŒ–ï¼ˆå¦‚åŸºäºæ•°æ®åˆ†å¸ƒçš„é¢„ä¼°ï¼‰</p>
<p><strong>é‡åŒ–ç›®æ ‡</strong>ï¼š
- è¯æ˜åœ¨$\alpha \leq \alpha_{\max}$æ—¶ï¼Œç®—æ³•ä»¥æ¦‚ç‡1æ”¶æ•›
- ç»™å‡ºæ”¶æ•›é€Ÿç‡ç•Œï¼š$\mathbb{E}[|\boldsymbol{F}^{(T)} - \boldsymbol{Q}|^2] \leq O(1/\sqrt{T})$
- å¼€å‘è‡ªé€‚åº”$\alpha$ç­–ç•¥ï¼Œä½¿æ”¶æ•›é€Ÿåº¦æå‡2-3å€</p>
<hr />
<h4 id="2-"><strong>æ–¹å‘2ï¼šæ•ˆç‡å±‚é¢ - é€šä¿¡ä¸å†…å­˜ä¼˜åŒ–</strong></h4>
<p><strong>ç ”ç©¶ç©ºç™½</strong>ï¼š
- åˆ†å¸ƒå¼è®­ç»ƒä¸­ï¼Œè´Ÿè½½å‡è¡¡çš„<strong>é€šä¿¡æˆæœ¬</strong>æœªå……åˆ†ç ”ç©¶
- åç½®$\boldsymbol{b}$åœ¨å¤šGPUç¯å¢ƒä¸‹çš„åŒæ­¥ç­–ç•¥ç¼ºå¤±
- è¶…å¤§è§„æ¨¡Expertï¼ˆ$n &gt; 1000$ï¼‰çš„è´Ÿè½½å‡è¡¡æ•ˆç‡ç“¶é¢ˆ</p>
<p><strong>å…·ä½“ç ”ç©¶é—®é¢˜</strong>ï¼š</p>
<ol>
<li><strong>é—®é¢˜</strong>ï¼šå¦‚ä½•åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸‹é«˜æ•ˆæ›´æ–°$\boldsymbol{b}$ï¼Ÿ</li>
<li><strong>ç°çŠ¶</strong>ï¼šéœ€è¦All-ReduceåŒæ­¥$\boldsymbol{F}$ï¼ˆæ¯ä¸ªbatchï¼‰</li>
<li><strong>ä¼˜åŒ–æ–¹å‘</strong>ï¼š<ul>
<li><strong>å¼‚æ­¥æ›´æ–°</strong>ï¼šå„GPUç‹¬ç«‹ç»´æŠ¤å±€éƒ¨$\boldsymbol{b}_{\text{local}}$ï¼Œå®šæœŸåŒæ­¥</li>
<li><strong>åˆ†å±‚åŒæ­¥</strong>ï¼šå…ˆåœ¨èŠ‚ç‚¹å†…åŒæ­¥ï¼Œå†è·¨èŠ‚ç‚¹</li>
<li><strong>å‹ç¼©é€šä¿¡</strong>ï¼šåªä¼ è¾“Top-$k$è´Ÿè½½çš„Expertç»Ÿè®¡</li>
</ul>
</li>
<li>
<p><strong>é‡åŒ–ç›®æ ‡</strong>ï¼šé€šä¿¡é‡é™è‡³åŸæ¥çš„10%-20%</p>
</li>
<li>
<p><strong>é—®é¢˜</strong>ï¼šèƒ½å¦è®¾è®¡"åœ¨çº¿"è´Ÿè½½å‡è¡¡ï¼ˆæ— éœ€batchç»Ÿè®¡ï¼‰ï¼Ÿ</p>
</li>
<li><strong>æŒ‘æˆ˜</strong>ï¼š$\boldsymbol{F}$æ˜¯batchçº§ç»Ÿè®¡ï¼Œå•ä¸ªæ ·æœ¬æ— æ³•è®¡ç®—</li>
<li><strong>æ½œåœ¨æ–¹æ³•</strong>ï¼š<ul>
<li>ä½¿ç”¨<strong>æŒ‡æ•°ç§»åŠ¨å¹³å‡</strong>ï¼ˆEMAï¼‰ç»´æŠ¤é•¿æœŸè´Ÿè½½ç»Ÿè®¡</li>
<li>æ¯ä¸ªæ ·æœ¬åªæ›´æ–°$\boldsymbol{b}$çš„ä¸€å°éƒ¨åˆ†ï¼ˆå¦‚è¢«é€‰ä¸­çš„Expertï¼‰</li>
</ul>
</li>
<li>
<p><strong>æ½œåœ¨æ„ä¹‰</strong>ï¼šé€‚ç”¨äºæµå¼æ•°æ®å’Œåœ¨çº¿å­¦ä¹ </p>
</li>
<li>
<p><strong>é—®é¢˜</strong>ï¼šå¦‚ä½•å¤„ç†è¶…å¤§è§„æ¨¡Expertï¼ˆ$n &gt; 1000$ï¼‰ï¼Ÿ</p>
</li>
<li><strong>ç°çŠ¶</strong>ï¼š$\boldsymbol{b} \in \mathbb{R}^n$çš„å­˜å‚¨å’Œæ›´æ–°æˆæœ¬éš$n$çº¿æ€§å¢é•¿</li>
<li><strong>ä¼˜åŒ–æ–¹å‘</strong>ï¼š<ul>
<li><strong>å±‚æ¬¡åŒ–åç½®</strong>ï¼šå°†$n$ä¸ªExpertåˆ†ç»„ï¼Œæ¯ç»„å…±äº«åç½®</li>
<li><strong>ä½ç§©åç½®</strong>ï¼š$\boldsymbol{b} = \boldsymbol{U}\boldsymbol{V}^T \boldsymbol{c}$ï¼ˆä½ç§©åˆ†è§£ï¼‰</li>
<li><strong>ç¨€ç–åç½®</strong>ï¼šåªå¯¹å¸¸ç”¨Expertç»´æŠ¤åç½®ï¼Œå†·é—¨Expertç”¨é»˜è®¤å€¼</li>
</ul>
</li>
<li><strong>é‡åŒ–ç›®æ ‡</strong>ï¼šå‚æ•°é‡ä»$O(n)$é™è‡³$O(\sqrt{n})$æˆ–$O(\log n)$</li>
</ol>
<p><strong>ä¼˜åŒ–æ–¹å‘</strong>ï¼š
- ç ”ç©¶<strong>è”é‚¦å­¦ä¹ </strong>ä¸­çš„è´Ÿè½½å‡è¡¡ï¼ˆè·¨è®¾å¤‡ï¼‰
- æ¢ç´¢<strong>æ¨¡å‹å¹¶è¡Œ</strong>ä¸è´Ÿè½½å‡è¡¡çš„ååŒè®¾è®¡
- å¼€å‘GPU kernelä¼˜åŒ–åç½®æ›´æ–°ï¼ˆèåˆæ“ä½œï¼‰</p>
<p><strong>é‡åŒ–ç›®æ ‡</strong>ï¼š
- åˆ†å¸ƒå¼é€šä¿¡æ—¶é—´é™è‡³&lt;5%æ€»è®­ç»ƒæ—¶é—´ï¼ˆvs å½“å‰15%-20%ï¼‰
- æ”¯æŒ$n=10000$è§„æ¨¡çš„Expertï¼Œå†…å­˜å¢åŠ &lt;1%
- åœ¨çº¿æ›´æ–°ç®—æ³•ï¼Œå•æ ·æœ¬å»¶è¿Ÿ&lt;1ms</p>
<hr />
<h4 id="3-"><strong>æ–¹å‘3ï¼šåº”ç”¨å±‚é¢ - æ‰©å±•åˆ°å…¶ä»–é¢†åŸŸ</strong></h4>
<p><strong>ç ”ç©¶ç©ºç™½</strong>ï¼š
- Loss-Freeæ€æƒ³åœ¨<strong>VQ-VAEã€æ£€ç´¢ã€æ¨è</strong>ç­‰åœºæ™¯çš„åº”ç”¨ä¸å……åˆ†
- ç¦»æ•£é€‰æ‹©ï¼ˆå¦‚Beam Searchã€NMSï¼‰çš„è´Ÿè½½å‡è¡¡
- å¤šæ¨¡æ€MoEçš„è´Ÿè½½å‡è¡¡ç­–ç•¥</p>
<p><strong>å…·ä½“ç ”ç©¶é—®é¢˜</strong>ï¼š</p>
<ol>
<li><strong>é—®é¢˜</strong>ï¼šå¦‚ä½•å°†Loss-Freeåº”ç”¨äºVQ-VAEçš„ç¼–ç è¡¨åç¼©ï¼Ÿ</li>
<li><strong>å·²æœ‰å·¥ä½œ</strong>ï¼šè®ºæ–‡æå‡ºäº†åŸºæœ¬æ€è·¯</li>
<li><strong>ä¼˜åŒ–æ–¹å‘</strong>ï¼š<ul>
<li>é’ˆå¯¹å›¾åƒ/è§†é¢‘çš„ç‰¹å®šä¼˜åŒ–ï¼ˆå¦‚ç©ºé—´å±€éƒ¨æ€§ï¼‰</li>
<li>ä¸ç æœ¬å­¦ä¹ ç®—æ³•ï¼ˆå¦‚EMAæ›´æ–°ï¼‰ç»“åˆ</li>
<li>å¤šå°ºåº¦VQçš„å±‚æ¬¡åŒ–åç½®</li>
</ul>
</li>
<li>
<p><strong>é‡åŒ–ç›®æ ‡</strong>ï¼šç æœ¬åˆ©ç”¨ç‡ä»60%æå‡è‡³95%+</p>
</li>
<li>
<p><strong>é—®é¢˜</strong>ï¼šLoss-Freeèƒ½å¦ç”¨äºç¥ç»ç½‘ç»œæ¶æ„æœç´¢ï¼ˆNASï¼‰ï¼Ÿ</p>
</li>
<li><strong>ç±»æ¯”</strong>ï¼šå°†æ¯ä¸ªå€™é€‰æ¶æ„çœ‹ä½œExpert</li>
<li><strong>æŒ‘æˆ˜</strong>ï¼šæ¶æ„çš„"è´¨é‡"éš¾ä»¥é‡åŒ–ï¼Œä¸åŒäºMoEçš„Routerå¾—åˆ†</li>
<li><strong>æ½œåœ¨æ–¹æ³•</strong>ï¼š<ul>
<li>å¼•å…¥åç½®è°ƒèŠ‚æ¶æ„çš„é‡‡æ ·æ¦‚ç‡</li>
<li>ç¡®ä¿æ‰€æœ‰å€™é€‰æ¶æ„éƒ½è¢«å……åˆ†è®­ç»ƒ</li>
</ul>
</li>
<li>
<p><strong>æ½œåœ¨æ„ä¹‰</strong>ï¼šæå‡NASçš„é‡‡æ ·æ•ˆç‡ï¼Œé¿å…æŸäº›æ¶æ„è¢«å¿½ç•¥</p>
</li>
<li>
<p><strong>é—®é¢˜</strong>ï¼šå¤šæ¨¡æ€MoEï¼ˆå›¾åƒ+æ–‡æœ¬ï¼‰çš„è”åˆè´Ÿè½½å‡è¡¡ï¼Ÿ</p>
</li>
<li><strong>æŒ‘æˆ˜</strong>ï¼šä¸åŒæ¨¡æ€çš„æ•°æ®é‡ä¸å‡ï¼ˆå¦‚æ–‡æœ¬&gt;&gt;å›¾åƒï¼‰</li>
<li><strong>ä¼˜åŒ–æ–¹å‘</strong>ï¼š<ul>
<li>æ¨¡æ€ç‰¹å®šçš„åç½®$\boldsymbol{b}<em _text_image="\text{image">{\text{text}}$ã€$\boldsymbol{b}</em>$}</li>
<li>è·¨æ¨¡æ€Expertçš„è´Ÿè½½è”åˆä¼˜åŒ–</li>
<li>è‡ªé€‚åº”å®¹é‡åˆ†é…ï¼ˆæ ¹æ®æ¨¡æ€æ¯”ä¾‹ï¼‰</li>
</ul>
</li>
<li><strong>é‡åŒ–ç›®æ ‡</strong>ï¼šå„æ¨¡æ€è´Ÿè½½CV &lt; 0.1</li>
</ol>
<p><strong>ä¼˜åŒ–æ–¹å‘</strong>ï¼š
- ç ”ç©¶<strong>ç¦»æ•£ä¼˜åŒ–</strong>ä¸­çš„åç½®æ–¹æ³•ï¼ˆå¦‚æ•´æ•°è§„åˆ’ï¼‰
- æ¢ç´¢<strong>å¼ºåŒ–å­¦ä¹ </strong>ä¸­çš„Expertè´Ÿè½½å‡è¡¡ï¼ˆå¦‚å¤šè‡‚è€è™æœºï¼‰
- å¼€å‘é€šç”¨çš„Loss-Freeæ¡†æ¶ï¼ˆé€‚ç”¨äºä»»æ„Top-Kåœºæ™¯ï¼‰</p>
<p><strong>é‡åŒ–ç›®æ ‡</strong>ï¼š
- VQ-VAEç æœ¬åç¼©ç‡ä»30%-40%é™è‡³&lt;5%
- NASä¸­æ‰€æœ‰å€™é€‰æ¶æ„è¢«é‡‡æ ·è‡³å°‘100æ¬¡
- å¤šæ¨¡æ€MoEåœ¨æ‰€æœ‰æ¨¡æ€ä¸Šæ€§èƒ½å‡è¡¡ï¼ˆæ— çŸ­æ¿ï¼‰</p>
<hr />
<h4 id="4-"><strong>æ–¹å‘4ï¼šé²æ£’æ€§å±‚é¢ - å¯¹æŠ—ä¸å¤±æ•ˆ</strong></h4>
<p><strong>ç ”ç©¶ç©ºé—´</strong>ï¼š
- Loss-Freeæ–¹æ³•å¯¹<strong>å¯¹æŠ—æ”»å‡»</strong>çš„é²æ£’æ€§æœªçŸ¥
- åç½®$\boldsymbol{b}$å¯èƒ½è¢«æ¶æ„æ“çºµå¯¼è‡´è´Ÿè½½ä¸å‡
- Expertå¤±æ•ˆæ—¶çš„å®¹é”™æœºåˆ¶</p>
<p><strong>å…·ä½“ç ”ç©¶é—®é¢˜</strong>ï¼š</p>
<ol>
<li><strong>é—®é¢˜</strong>ï¼šèƒ½å¦é€šè¿‡æ”»å‡»$\boldsymbol{b}$ç ´åè´Ÿè½½å‡è¡¡ï¼Ÿ</li>
<li><strong>æ”»å‡»åœºæ™¯</strong>ï¼šå¯¹æ‰‹åœ¨è®­ç»ƒæ•°æ®ä¸­æ³¨å…¥ç‰¹å®šæ ·æœ¬</li>
<li><strong>ç›®æ ‡</strong>ï¼šä½¿æŸäº›Expertè¿‡è½½ï¼Œå…¶ä»–æ¬ è½½</li>
<li><strong>æ½œåœ¨é˜²å¾¡</strong>ï¼š<ul>
<li>åç½®çš„é²æ£’æ›´æ–°ï¼ˆå¦‚ä¸­ä½æ•°ä»£æ›¿å‡å€¼ï¼‰</li>
<li>æ£€æµ‹å¼‚å¸¸è´Ÿè½½æ¨¡å¼</li>
<li>é™åˆ¶$\boldsymbol{b}$çš„å˜åŒ–å¹…åº¦</li>
</ul>
</li>
<li>
<p><strong>é‡åŒ–ç›®æ ‡</strong>ï¼šåœ¨10%å¯¹æŠ—æ ·æœ¬ä¸‹ï¼Œè´Ÿè½½CVå¢åŠ &lt;20%</p>
</li>
<li>
<p><strong>é—®é¢˜</strong>ï¼šå¦‚ä½•å¤„ç†ExpertåŠ¨æ€å¤±æ•ˆï¼Ÿ</p>
</li>
<li><strong>åœºæ™¯</strong>ï¼šåˆ†å¸ƒå¼æ¨ç†ä¸­æŸGPUæ•…éšœï¼Œå¯¹åº”Expertä¸å¯ç”¨</li>
<li><strong>ä¼˜åŒ–æ–¹å‘</strong>ï¼š<ul>
<li>å®æ—¶è°ƒæ•´$\boldsymbol{b}$ï¼Œå°†è´Ÿè½½é‡å®šå‘åˆ°æ­£å¸¸Expert</li>
<li>å†—ä½™è®¾è®¡ï¼ˆæ¯ä¸ªExpertæœ‰å¤‡ä»½ï¼‰</li>
<li>é™çº§ç­–ç•¥ï¼ˆä¸´æ—¶ç”¨Denseå±‚æ›¿ä»£ï¼‰</li>
</ul>
</li>
<li>
<p><strong>é‡åŒ–ç›®æ ‡</strong>ï¼š1ä¸ªExpertå¤±æ•ˆï¼Œæ€§èƒ½ä¸‹é™&lt;5%ï¼Œæ¢å¤æ—¶é—´&lt;10ç§’</p>
</li>
<li>
<p><strong>é—®é¢˜</strong>ï¼šåç½®$\boldsymbol{b}$çš„å¯è§£é‡Šæ€§ï¼Ÿ</p>
</li>
<li><strong>ç°çŠ¶</strong>ï¼š$\boldsymbol{b}$æ˜¯é»‘ç›’å‚æ•°ï¼Œéš¾ä»¥ç†è§£</li>
<li><strong>æ¢ç´¢æ–¹å‘</strong>ï¼š<ul>
<li>åˆ†æ$b_i$ä¸Expert $i$çš„è´Ÿè½½ã€è´¨é‡çš„å…³ç³»</li>
<li>å¯è§†åŒ–$\boldsymbol{b}$çš„æ¼”åŒ–è½¨è¿¹</li>
<li>è§£é‡Šä¸ºä»€ä¹ˆæŸäº›Expertéœ€è¦å¤§çš„æ­£/è´Ÿåç½®</li>
</ul>
</li>
<li><strong>æ½œåœ¨æ„ä¹‰</strong>ï¼šå¸®åŠ©è¯Šæ–­è®­ç»ƒé—®é¢˜ï¼ŒæŒ‡å¯¼æ¨¡å‹è®¾è®¡</li>
</ol>
<p><strong>ä¼˜åŒ–æ–¹å‘</strong>ï¼š
- å€Ÿé‰´<strong>é²æ£’ä¼˜åŒ–</strong>ç†è®ºï¼ˆmin-maxæ¡†æ¶ï¼‰
- å¼€å‘<strong>è‡ªåŠ¨ä¿®å¤</strong>æœºåˆ¶ï¼ˆç±»ä¼¼è‡ªæ„ˆç³»ç»Ÿï¼‰
- ç ”ç©¶<strong>å¯ä¿¡AI</strong>ä¸­çš„å…¬å¹³æ€§ä¸è´Ÿè½½å‡è¡¡çš„å…³ç³»</p>
<p><strong>é‡åŒ–ç›®æ ‡</strong>ï¼š
- å¯¹æŠ—é²æ£’æ€§ï¼šåœ¨PGDæ”»å‡»ï¼ˆ$\epsilon=0.1$ï¼‰ä¸‹ï¼Œè´Ÿè½½CVå¢åŠ &lt;30%
- å®¹é”™æ€§ï¼š$n/2$ä¸ªExpertå¤±æ•ˆï¼Œä»èƒ½ç»´æŒ70%æ€§èƒ½
- å¯è§£é‡Šæ€§ï¼šé€šè¿‡$\boldsymbol{b}$åˆ†æï¼Œè¯†åˆ«å‡º80%çš„è´Ÿè½½ç“¶é¢ˆåŸå› </p>
<hr />
<h4 id="5-moe"><strong>æ–¹å‘5ï¼šæ–°å‹æ¶æ„ - åŠ¨æ€ä¸è‡ªé€‚åº”MoE</strong></h4>
<p><strong>ç ”ç©¶ç©ºç™½</strong>ï¼š
- Expertæ•°é‡$n$å›ºå®šï¼Œæ— æ³•æ ¹æ®ä»»åŠ¡éš¾åº¦åŠ¨æ€è°ƒæ•´
- Top-$k$çš„$k$ä¹Ÿæ˜¯å›ºå®šçš„ï¼Œç¼ºä¹è‡ªé€‚åº”æœºåˆ¶
- è·¨å±‚Expertå…±äº«ä¸è´Ÿè½½å‡è¡¡çš„ååŒ</p>
<p><strong>å…·ä½“ç ”ç©¶é—®é¢˜</strong>ï¼š</p>
<ol>
<li><strong>é—®é¢˜</strong>ï¼šåŠ¨æ€Expertæ•°é‡ï¼ˆGrowing/Shrinking MoEï¼‰ï¼Ÿ</li>
<li><strong>æ€è·¯</strong>ï¼šè®­ç»ƒåˆæœŸç”¨å°‘é‡Expertï¼Œé€æ¸å¢åŠ ï¼›æ¨ç†æ—¶æ ¹æ®è´Ÿè½½åŠ¨æ€åˆ å‡</li>
<li><strong>æŒ‘æˆ˜</strong>ï¼š<ul>
<li>å¦‚ä½•åˆå§‹åŒ–æ–°Expertï¼Ÿï¼ˆéšæœºï¼Ÿè’¸é¦ç°æœ‰Expertï¼Ÿï¼‰</li>
<li>ä½•æ—¶å¢åŠ /åˆ å‡Expertï¼Ÿï¼ˆåŸºäºè´Ÿè½½ï¼Ÿæ€§èƒ½ï¼Ÿï¼‰</li>
</ul>
</li>
<li><strong>ä¼˜åŒ–æ–¹å‘</strong>ï¼š<ul>
<li>ç›‘æ§è´Ÿè½½CVï¼Œå½“CVæŒç»­é«˜äºé˜ˆå€¼æ—¶å¢åŠ Expert</li>
<li>åˆ å‡é•¿æœŸæ¬ è½½çš„Expertï¼ˆè´Ÿè½½&lt;é˜ˆå€¼ï¼‰</li>
</ul>
</li>
<li>
<p><strong>é‡åŒ–ç›®æ ‡</strong>ï¼šè‡ªåŠ¨è°ƒèŠ‚$n$ï¼Œæœ€ç»ˆè´Ÿè½½CV &lt; 0.1ï¼Œå‚æ•°é‡å‡å°‘20%</p>
</li>
<li>
<p><strong>é—®é¢˜</strong>ï¼šè‡ªé€‚åº”Top-$k$ï¼ˆæ¯ä¸ªæ ·æœ¬çš„$k$å¯å˜ï¼‰ï¼Ÿ</p>
</li>
<li><strong>è§‚å¯Ÿ</strong>ï¼šç®€å•æ ·æœ¬å¯èƒ½åªéœ€Top-1ï¼Œå¤æ‚æ ·æœ¬éœ€è¦Top-3</li>
<li><strong>æ½œåœ¨æ–¹æ³•</strong>ï¼š<ul>
<li>å¼•å…¥"éš¾åº¦é¢„æµ‹å™¨"$k(\boldsymbol{x}) = f_{\text{diff}}(\boldsymbol{x})$</li>
<li>åŸºäºRouterç½®ä¿¡åº¦å†³å®š$k$ï¼ˆTop-1ä¸Top-2å¾—åˆ†å·®å¤§ â†’ $k=1$ï¼‰</li>
<li>å¼ºåŒ–å­¦ä¹ ä¼˜åŒ–$k$çš„é€‰æ‹©ç­–ç•¥</li>
</ul>
</li>
<li>
<p><strong>é‡åŒ–ç›®æ ‡</strong>ï¼šå¹³å‡$k$ä»2é™è‡³1.5ï¼Œæ€§èƒ½ä¿æŒä¸å˜ï¼ŒèŠ‚çœ25%è®¡ç®—</p>
</li>
<li>
<p><strong>é—®é¢˜</strong>ï¼šè·¨å±‚Expertå…±äº«+è´Ÿè½½å‡è¡¡ï¼Ÿ</p>
</li>
<li><strong>è®¾è®¡</strong>ï¼šå¤šå±‚å…±äº«åŒä¸€ä¸ªExpertæ± ï¼Œæ¯å±‚ç‹¬ç«‹é€‰æ‹©Top-$k$</li>
<li><strong>æŒ‘æˆ˜</strong>ï¼šå…¨å±€è´Ÿè½½å‡è¡¡ï¼ˆæ‰€æœ‰å±‚çš„è´Ÿè½½æ€»å’Œï¼‰vs å±€éƒ¨å‡è¡¡ï¼ˆæ¯å±‚ç‹¬ç«‹ï¼‰</li>
<li><strong>ä¼˜åŒ–æ–¹å‘</strong>ï¼š<ul>
<li>å…¨å±€åç½®$\boldsymbol{b}_{\text{global}}$ï¼Œå„å±‚å…±äº«</li>
<li>æ¯å±‚å¾®è°ƒ$\boldsymbol{b}<em _text_global="\text{global">{\ell} = \boldsymbol{b}</em>$}} + \Delta\boldsymbol{b}_{\ell</li>
</ul>
</li>
<li><strong>é‡åŒ–ç›®æ ‡</strong>ï¼šå‚æ•°é‡é™ä½40%ï¼Œå…¨å±€è´Ÿè½½CV &lt; 0.15</li>
</ol>
<p><strong>ä¼˜åŒ–æ–¹å‘</strong>ï¼š
- å€Ÿé‰´<strong>å…ƒå­¦ä¹ </strong>ï¼ˆMeta-Learningï¼‰è‡ªåŠ¨è®¾è®¡MoEæ¶æ„
- ç ”ç©¶<strong>ç¥ç»æ¶æ„æœç´¢</strong>ï¼ˆNASï¼‰for MoE
- æ¢ç´¢<strong>ç»ˆèº«å­¦ä¹ </strong>ä¸­çš„ExpertåŠ¨æ€ç®¡ç†</p>
<p><strong>é‡åŒ–ç›®æ ‡</strong>ï¼š
- åŠ¨æ€MoEï¼šè®­ç»ƒæ—¶é—´èŠ‚çœ30%ï¼Œæœ€ç»ˆæ€§èƒ½æå‡5%
- è‡ªé€‚åº”Top-$k$ï¼šå¹³å‡è®¡ç®—é‡é™ä½25%ï¼Œæ€§èƒ½ä¸‹é™&lt;2%
- è·¨å±‚å…±äº«ï¼šå‚æ•°é‡é™ä½40%ï¼Œæ€§èƒ½ä¿æŒ95%</p>
<hr />
<h4 id="_9"><strong>æ½œåœ¨åº”ç”¨åœºæ™¯</strong></h4>
<p><strong>å¤§è§„æ¨¡è¯­è¨€æ¨¡å‹</strong>ï¼š
- ä¸‡äº¿å‚æ•°LLMçš„è´Ÿè½½å‡è¡¡
- å¤šè¯­è¨€æ¨¡å‹ï¼ˆæ¯ç§è¯­è¨€å¯¹åº”ä¸€ç»„Expertï¼‰
- ä»£ç ç”Ÿæˆï¼ˆä¸åŒç¼–ç¨‹è¯­è¨€çš„Expertï¼‰</p>
<p><strong>å¤šæ¨¡æ€å­¦ä¹ </strong>ï¼š
- å›¾æ–‡ç”Ÿæˆï¼ˆè§†è§‰Expert + æ–‡æœ¬Expertï¼‰
- è§†é¢‘ç†è§£ï¼ˆæ—¶ç©ºMoEï¼‰
- è·¨æ¨¡æ€æ£€ç´¢</p>
<p><strong>æ¨èç³»ç»Ÿ</strong>ï¼š
- ç”¨æˆ·ç¾¤ä½“ç»†åˆ†ï¼ˆæ¯ä¸ªç¾¤ä½“å¯¹åº”ä¸€ä¸ªExpertï¼‰
- å†·å¯åŠ¨é—®é¢˜ï¼ˆæ–°ç”¨æˆ·/ç‰©å“çš„è´Ÿè½½å‡è¡¡ï¼‰</p>
<p><strong>ç§‘å­¦è®¡ç®—</strong>ï¼š
- PDEæ±‚è§£ï¼ˆä¸åŒæ–¹ç¨‹ç±»å‹çš„Expertï¼‰
- è›‹ç™½è´¨æŠ˜å ï¼ˆæ°¨åŸºé…¸ç±»å‹ç‰¹å®šExpertï¼‰
- æ°”å€™æ¨¡æ‹Ÿï¼ˆåœ°ç†åŒºåŸŸExpertï¼‰</p>
<p><strong>è¾¹ç¼˜è®¡ç®—</strong>ï¼š
- è®¾å¤‡å¼‚æ„ç¯å¢ƒä¸‹çš„è´Ÿè½½å‡è¡¡
- ç§»åŠ¨ç«¯MoEçš„åŠ¨æ€ExpertåŠ è½½</p>
<hr />
<h3 id="_10">æ€»ç»“</h3>
<p>æœ¬æ–‡æ·±å…¥åˆ†æäº†MoEçš„è´Ÿè½½å‡è¡¡é—®é¢˜ï¼Œé‡ç‚¹ä»‹ç»äº†DeepSeekæå‡ºçš„Loss-Freeæ–¹æ³•ã€‚é€šè¿‡å¼•å…¥åç½®é¡¹$\boldsymbol{b}$ï¼ŒLoss-Freeå®ç°äº†<strong>å‚æ•°ç©ºé—´åˆ†ç¦»</strong>ï¼Œä½¿å¾—è´Ÿè½½å‡è¡¡ä¼˜åŒ–ä¸ä¸»ä»»åŠ¡ä¼˜åŒ–äº’ä¸å¹²æ‰°ï¼Œè¿™æ˜¯å…¶ç›¸æ¯”ä¼ ç»ŸAux Lossçš„æ ¸å¿ƒä¼˜åŠ¿ã€‚</p>
<p><strong>æ ¸å¿ƒè¦ç‚¹</strong>ï¼š
1. <strong>"ä¸€ä¸ªåç½®é¡¹è¶³ä»¥è¾¾åˆ°è´Ÿè½½å‡è¡¡"</strong>â€”â€”ç®€æ´è€Œæ·±åˆ»çš„æ´å¯Ÿ
2. <strong>å‚æ•°ç©ºé—´åˆ†ç¦»</strong>ï¼š$\theta$ä¼˜åŒ–ä¸»ä»»åŠ¡ï¼Œ$\boldsymbol{b}$ä¼˜åŒ–å‡è¡¡ï¼Œäº’ä¸å¹²æ‰°
3. <strong>è®­ç»ƒ/æ¨ç†ä¸€è‡´</strong>ï¼š$\boldsymbol{b}$åœ¨ä¸¤ä¸ªé˜¶æ®µéƒ½èµ·ä½œç”¨
4. <strong>æ™®é€‚æ€§å¼º</strong>ï¼šé€‚ç”¨äºæ‰€æœ‰Top-Ké€‰æ‹©+è´Ÿè½½å‡è¡¡åœºæ™¯ï¼ˆMoEã€VQ-VAEã€NASç­‰ï¼‰
5. <strong>ç†è®ºä¼˜é›…ã€å®è·µæœ‰æ•ˆ</strong>ï¼šæ•°å­¦æ¨å¯¼æ¸…æ™°ï¼Œå®éªŒæ•ˆæœæ˜¾è‘—</p>
<p><strong>æœªæ¥å€¼å¾—å…³æ³¨</strong>ï¼š
- <strong>ç†è®º</strong>ï¼šæ”¶æ•›æ€§è¯æ˜ã€ç¨³å®šæ€§åˆ†æ
- <strong>æ•ˆç‡</strong>ï¼šåˆ†å¸ƒå¼é€šä¿¡ä¼˜åŒ–ã€è¶…å¤§è§„æ¨¡Expert
- <strong>åº”ç”¨</strong>ï¼šVQ-VAEã€NASã€å¤šæ¨¡æ€ã€æ¨èç³»ç»Ÿ
- <strong>é²æ£’æ€§</strong>ï¼šå¯¹æŠ—æ”»å‡»ã€å®¹é”™æœºåˆ¶
- <strong>æ–°æ¶æ„</strong>ï¼šåŠ¨æ€Expertã€è‡ªé€‚åº”Top-$k$ã€è·¨å±‚å…±äº«</p>
<p>Loss-Freeä¸ä»…è§£å†³äº†MoEçš„è´Ÿè½½å‡è¡¡é—®é¢˜ï¼Œæ›´æä¾›äº†ä¸€ç§é€šç”¨çš„è®¾è®¡æ¨¡å¼ï¼š<strong>å½“å¤šä¸ªä¼˜åŒ–ç›®æ ‡å†²çªæ—¶ï¼Œé€šè¿‡å¼•å…¥è¾…åŠ©å‚æ•°å®ç°ç›®æ ‡è§£è€¦ï¼Œå„è‡ªä¼˜åŒ–è€Œäº’ä¸å¹²æ‰°</strong>ã€‚è¿™ä¸€æ€æƒ³åœ¨æ·±åº¦å­¦ä¹ çš„è¯¸å¤šé¢†åŸŸéƒ½æœ‰å¹¿é˜”çš„åº”ç”¨å‰æ™¯ã€‚</p>
        </div>
    </div>
</body>
</html>