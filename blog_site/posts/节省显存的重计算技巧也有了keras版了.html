<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èŠ‚çœæ˜¾å­˜çš„é‡è®¡ç®—æŠ€å·§ä¹Ÿæœ‰äº†Kerasç‰ˆäº†</title>
    <style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    line-height: 1.6; color: #333; max-width: 900px; margin: 0 auto; padding: 20px; background: #f5f5f5;
}
.container { background: white; padding: 40px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
header { border-bottom: 2px solid #e0e0e0; padding-bottom: 20px; margin-bottom: 30px; }
h1 { color: #2c3e50; margin-bottom: 10px; font-size: 2em; }
.meta { color: #666; font-size: 0.9em; margin-bottom: 20px; }
.content { margin-top: 30px; overflow-wrap: break-word; }
.content h2 { color: #34495e; margin-top: 30px; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
.content p { margin-bottom: 15px; }
.content pre { background: #f8f8f8; padding: 15px; border-radius: 5px; overflow-x: auto; border-left: 3px solid #3498db; margin: 15px 0; }
.content code { background: #f8f8f8; padding: 2px 5px; border-radius: 3px; font-family: monospace; font-size: 0.9em; }
.content blockquote { border-left: 4px solid #3498db; padding-left: 20px; margin: 20px 0; color: #555; font-style: italic; }
.content table { border-collapse: collapse; width: 100%; margin: 20px 0; }
.content th, .content td { border: 1px solid #ddd; padding: 10px; text-align: left; }
.back-link { display: inline-block; margin-bottom: 20px; color: #3498db; text-decoration: none; font-weight: 500; }
</style>
    
<script>
    window.MathJax = {
        tex: {
            inlineMath: [['$', '$'], ['\(', '\)']],
            displayMath: [['$$', '$$'], ['\[', '\]']],
            processEscapes: true
        }
    };
</script>
<script id="MathJax-script" async src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>

</head>
<body>
    <div class="container">
        <a href="../index.html" class="back-link">â† è¿”å›é¦–é¡µ</a>
        <header>
            <h1>èŠ‚çœæ˜¾å­˜çš„é‡è®¡ç®—æŠ€å·§ä¹Ÿæœ‰äº†Kerasç‰ˆäº†</h1>
            <div class="meta">ğŸ“… æœ€åæ›´æ–°: 2025-12-31 | ğŸ“„ å¤§å°: 5.7 KB</div>
        </header>
        <div class="content">
            <p><strong>åŸæ–‡é“¾æ¥</strong>: <a href="https://spaces.ac.cn/archives/7367">https://spaces.ac.cn/archives/7367</a></p>
<p><strong>å‘å¸ƒæ—¥æœŸ</strong>: </p>
<hr />
<p>ä¸å°‘è¯»è€…æœ€è¿‘å¯èƒ½ç•™æ„åˆ°äº†å…¬ä¼—å·æ–‡ç« <a href="https://mp.weixin.qq.com/s/CmIVwGFqrSD0wcSN_hgH1A">ã€ŠBERTé‡è®¡ç®—ï¼šç”¨22.5%çš„è®­ç»ƒæ—¶é—´èŠ‚çœ5å€çš„æ˜¾å­˜å¼€é”€ï¼ˆé™„ä»£ç ï¼‰ã€‹</a>ï¼Œé‡Œè¾¹ä»‹ç»äº†ä¸€ä¸ªå«åšâ€œé‡è®¡ç®—â€çš„æŠ€å·§ï¼Œç®€å•æ¥è¯´å°±æ˜¯ç”¨æ¥çœæ˜¾å­˜çš„æ–¹æ³•ï¼Œè®©å¹³å‡è®­ç»ƒé€Ÿåº¦æ…¢ä¸€ç‚¹ï¼Œä½†batch_sizeå¯ä»¥å¢å¤§å¥½å‡ å€ã€‚è¯¥æŠ€å·§é¦–å…ˆå‘å¸ƒäºè®ºæ–‡<a href="https://papers.cool/arxiv/1604.06174">ã€ŠTraining Deep Nets with Sublinear Memory Costã€‹</a>ï¼Œå…¶å®åœ¨2016å¹´å°±å·²ç»æå‡ºäº†ï¼Œåªä¸è¿‡ä¼¼ä¹è¿˜æ²¡æœ‰ç‰¹åˆ«æµè¡Œèµ·æ¥ã€‚</p>
<h2 id="_1">æ¢ç´¢</h2>
<p>å…¬ä¼—å·æ–‡ç« æåˆ°è¯¥æŠ€å·§åœ¨pytorchå’Œpaddlepaddleéƒ½æœ‰åŸç”Ÿå®ç°äº†ï¼Œä½†tensorflowè¿˜æ²¡æœ‰ã€‚ä½†äº‹å®ä¸Šä»tensorflow 1.8å¼€å§‹ï¼Œtensorflowå°±å·²ç»è‡ªå¸¦äº†è¯¥åŠŸèƒ½äº†ï¼Œå½“æ—¶è¢«åˆ—å…¥äº†<code>tf.contrib</code>è¿™ä¸ªå­åº“ä¸­ï¼Œè€Œä»tensorflow 1.15å¼€å§‹ï¼Œå®ƒå°±è¢«å†…ç½®ä¸ºtensorflowçš„ä¸»å‡½æ•°ä¹‹ä¸€ï¼Œé‚£å°±æ˜¯<code>tf.recompute_grad</code>ã€‚</p>
<p>æ‰¾åˆ°<code>tf.recompute_grad</code>ä¹‹åï¼Œç¬”è€…å°±ç¢ç£¨äº†ä¸€ä¸‹å®ƒçš„ç”¨æ³•ï¼Œç»è¿‡ä¸€ç•ªæŠ˜è…¾ï¼Œæœ€ç»ˆå±…ç„¶çœŸçš„æˆåŠŸåœ°ç”¨èµ·æ¥äº†ï¼Œå±…ç„¶æˆåŠŸåœ°è®©<code>batch_size</code>ä»48å¢åŠ åˆ°äº†144ï¼ç„¶è€Œï¼Œåœ¨ç»§ç»­æ•´ç†æµ‹è¯•çš„è¿‡ç¨‹ä¸­ï¼Œå‘ç°è¿™ç©æ„å±…ç„¶åœ¨tensorflow 2.xæ˜¯å¤±æ•ˆçš„...äºæ˜¯å†æŠ˜è…¾äº†ä¸¤å¤©ï¼ŒæŸ¥æ‰¾äº†å„ç§èµ„æ–™å¹¶åå¤è°ƒè¯•ï¼Œæœ€ç»ˆç®—æ˜¯æˆåŠŸåœ°è¡¥å……äº†è¿™ä¸€ç¼ºé™·ã€‚</p>
<p>æœ€åæ˜¯ç¬”è€…è‡ªå·±çš„å¼€æºå®ç°ï¼š</p>
<blockquote>
<p><strong>Githubåœ°å€ï¼š<a href="https://github.com/bojone/keras_recompute">https://github.com/bojone/keras_recompute</a></strong></p>
</blockquote>
<p>è¯¥å®ç°å·²ç»å†…ç½®åœ¨<a href="https://github.com/bojone/bert4keras">bert4keras</a>ä¸­ï¼Œä½¿ç”¨bert4kerasçš„è¯»è€…å¯ä»¥å‡çº§åˆ°æœ€æ–°ç‰ˆæœ¬ï¼ˆ0.7.5+ï¼‰æ¥æµ‹è¯•è¯¥åŠŸèƒ½ã€‚</p>
<h2 id="_2">ä½¿ç”¨</h2>
<p>ç¬”è€…çš„å®ç°ä¹Ÿå‘½åä¸º<code>recompute_grad</code>ï¼Œå®ƒæ˜¯ä¸€ä¸ªè£…é¥°å™¨ï¼Œç”¨äºè‡ªå®šä¹‰Keraså±‚çš„<code>call</code>å‡½æ•°ï¼Œæ¯”å¦‚</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">recompute</span><span class="w"> </span><span class="kn">import</span> <span class="n">recompute_grad</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MyLayer</span><span class="p">(</span><span class="n">Layer</span><span class="p">):</span>
    <span class="nd">@recompute_grad</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">inputs</span> <span class="o">*</span> <span class="mi">2</span>
</code></pre></div>

<p>å¯¹äºå·²ç»å­˜åœ¨çš„å±‚ï¼Œå¯ä»¥é€šè¿‡ç»§æ‰¿çš„æ–¹å¼æ¥è£…é¥°ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">recompute</span><span class="w"> </span><span class="kn">import</span> <span class="n">recompute_grad</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MyDense</span><span class="p">(</span><span class="n">Dense</span><span class="p">):</span>
    <span class="nd">@recompute_grad</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">MyDense</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
</code></pre></div>

<p>è‡ªå®šä¹‰å¥½å±‚ä¹‹åï¼Œåœ¨ä»£ç ä¸­åµŒå…¥è‡ªå®šä¹‰å±‚ï¼Œç„¶ååœ¨æ‰§è¡Œä»£ç ä¹‹å‰ï¼ŒåŠ å…¥ç¯å¢ƒå˜é‡<code>RECOMPUTE=1</code>æ¥å¯ç”¨é‡è®¡ç®—ã€‚</p>
<p>æ³¨æ„ï¼šä¸æ˜¯åœ¨æ€»æ¨¡å‹é‡Œæ’å…¥äº†<code>@recompute_grad</code>ï¼Œå°±èƒ½è¾¾åˆ°çœå†…å­˜çš„ç›®çš„ï¼Œè€Œæ˜¯è¦åœ¨æ¯ä¸ªå±‚éƒ½æ’å…¥<code>@recompute_grad</code>æ‰èƒ½æ›´å¥½åœ°çœæ˜¾å­˜ã€‚ç®€å•æ¥è¯´ï¼Œå°±æ˜¯æ’å…¥çš„<code>@recompute_grad</code>è¶Šå¤šï¼Œå°±çœæ˜¾å­˜ã€‚å…·ä½“åŸå› è¯·ä»”ç»†ç†è§£é‡è®¡ç®—çš„åŸç†ã€‚</p>
<h2 id="_3">æ•ˆæœ</h2>
<p>bert4keras 0.7.5+å·²ç»å†…ç½®äº†é‡è®¡ç®—ï¼Œç›´æ¥ä¼ å…¥ç¯å¢ƒå˜é‡<code>RECOMPUTE=1</code>å°±ä¼šå¯ç”¨é‡è®¡ç®—ï¼Œè¯»è€…å¯ä»¥è‡ªè¡Œå°è¯•ï¼Œå¤§æ¦‚çš„æ•ˆæœæ˜¯ï¼š</p>
<blockquote>
<p>1ã€åœ¨BERT Baseç‰ˆæœ¬ä¸‹ï¼Œbatch_sizeå¯ä»¥å¢å¤§ä¸ºåŸæ¥çš„3å€å·¦å³ï¼›</p>
<p>2ã€åœ¨BERT Largeç‰ˆæœ¬ä¸‹ï¼Œbatch_sizeå¯ä»¥å¢å¤§ä¸ºåŸæ¥çš„4å€å·¦å³ï¼›</p>
<p>3ã€å¹³å‡æ¯ä¸ªæ ·æœ¬çš„è®­ç»ƒæ—¶é—´å¤§çº¦å¢åŠ 25%ï¼›</p>
<p>4ã€ç†è®ºä¸Šï¼Œå±‚æ•°è¶Šå¤šï¼Œbatch_sizeå¯ä»¥å¢å¤§çš„å€æ•°è¶Šå¤§ã€‚</p>
</blockquote>
<h2 id="_4">ç¯å¢ƒ</h2>
<p>åœ¨ä¸‹é¢çš„ç¯å¢ƒä¸‹æµ‹è¯•é€šè¿‡ï¼š</p>
<blockquote>
<p>tensorflow 1.14 + keras 2.3.1</p>
<p>tensorflow 1.15 + keras 2.3.1</p>
<p>tensorflow 2.0 + keras 2.3.1</p>
<p>tensorflow 2.1 + keras 2.3.1</p>
<p>tensorflow 2.0 + è‡ªå¸¦tf.keras</p>
<p>tensorflow 2.1 + è‡ªå¸¦tf.keras</p>
</blockquote>
<p>ç¡®è®¤ä¸æ”¯æŒçš„ç¯å¢ƒï¼š</p>
<blockquote>
<p>tensorflow 1.x + è‡ªå¸¦tf.keras</p>
</blockquote>
<p>æ¬¢è¿æŠ¥å‘Šæ›´å¤šçš„æµ‹è¯•ç»“æœã€‚</p>
<p>é¡ºä¾¿è¯´ä¸€ä¸‹ï¼Œ<strong>å¼ºçƒˆå»ºè®®ç”¨keras 2.3.1é…åˆtensorflow 1.x/2.xæ¥è·‘ï¼Œå¼ºçƒˆä¸å»ºè®®ä½¿ç”¨tensorflow 2.xè‡ªå¸¦çš„tf.kerasæ¥è·‘</strong> ã€‚</p>
<h2 id="_5">å‚è€ƒ</h2>
<p>æœ€åï¼Œç¬”è€…çš„å®ç°ä¸»è¦å‚è€ƒè‡ªå¦‚ä¸‹ä¸¤ä¸ªæºç ï¼Œåœ¨æ­¤è¡¨ç¤ºæ„Ÿè°¢ã€‚</p>
<blockquote>
<p><a href="https://github.com/davisyoshida/tf2-gradient-checkpointing">https://github.com/davisyoshida/tf2-gradient-checkpointing</a></p>
<p><a href="https://github.com/tensorflow/tensorflow/blob/v2.1.0/tensorflow/python/ops/custom_gradient.py#L454-L499">https://github.com/tensorflow/tensorflow/blob/v2.1.0/tensorflow/python/ops/custom_gradient.py#L454-L499</a></p>
</blockquote>
<p><em><strong>è½¬è½½åˆ°è¯·åŒ…æ‹¬æœ¬æ–‡åœ°å€ï¼š</strong><a href="https://spaces.ac.cn/archives/7367">https://spaces.ac.cn/archives/7367</a></em></p>
<p><em><strong>æ›´è¯¦ç»†çš„è½¬è½½äº‹å®œè¯·å‚è€ƒï¼š</strong></em><a href="https://spaces.ac.cn/archives/6508#%E6%96%87%E7%AB%A0%E5%A6%82%E4%BD%95%E8%BD%AC%E8%BD%BD/%E5%BC%95%E7%94%A8" title="ã€Šç§‘å­¦ç©ºé—´FAQã€‹">ã€Šç§‘å­¦ç©ºé—´FAQã€‹</a></p>
<p><strong>å¦‚æœæ‚¨è¿˜æœ‰ä»€ä¹ˆç–‘æƒ‘æˆ–å»ºè®®ï¼Œæ¬¢è¿åœ¨ä¸‹æ–¹è¯„è®ºåŒºç»§ç»­è®¨è®ºã€‚</strong></p>
<p><strong>å¦‚æœæ‚¨è§‰å¾—æœ¬æ–‡è¿˜ä¸é”™ï¼Œæ¬¢è¿åˆ†äº«/æ‰“èµæœ¬æ–‡ã€‚æ‰“èµå¹¶éè¦ä»ä¸­è·å¾—æ”¶ç›Šï¼Œè€Œæ˜¯å¸Œæœ›çŸ¥é“ç§‘å­¦ç©ºé—´è·å¾—äº†å¤šå°‘è¯»è€…çš„çœŸå¿ƒå…³æ³¨ã€‚å½“ç„¶ï¼Œå¦‚æœä½ æ— è§†å®ƒï¼Œä¹Ÿä¸ä¼šå½±å“ä½ çš„é˜…è¯»ã€‚å†æ¬¡è¡¨ç¤ºæ¬¢è¿å’Œæ„Ÿè°¢ï¼</strong></p>
<p>æ‰“èµ</p>
<p><img alt="ç§‘å­¦ç©ºé—´" src="https://spaces.ac.cn/usr/themes/geekg/payment/wx.png" /></p>
<p>å¾®ä¿¡æ‰“èµ</p>
<p><img alt="ç§‘å­¦ç©ºé—´" src="https://spaces.ac.cn/usr/themes/geekg/payment/zfb.png" /></p>
<p>æ”¯ä»˜å®æ‰“èµ</p>
<p>å› ä¸ºç½‘ç«™åå°å¯¹æ‰“èµå¹¶æ— è®°å½•ï¼Œå› æ­¤æ¬¢è¿åœ¨æ‰“èµæ—¶å€™å¤‡æ³¨ç•™è¨€ã€‚ä½ è¿˜å¯ä»¥<a href="http://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&amp;email=tN7d1drY3drrx8H0xcWa19vZ"><strong>ç‚¹å‡»è¿™é‡Œ</strong></a>æˆ–åœ¨ä¸‹æ–¹è¯„è®ºåŒºç•™è¨€æ¥å‘ŠçŸ¥ä½ çš„å»ºè®®æˆ–éœ€æ±‚ã€‚</p>
<p><strong>å¦‚æœæ‚¨éœ€è¦å¼•ç”¨æœ¬æ–‡ï¼Œè¯·å‚è€ƒï¼š</strong></p>
<p>è‹å‰‘æ—. (Apr. 29, 2020). ã€ŠèŠ‚çœæ˜¾å­˜çš„é‡è®¡ç®—æŠ€å·§ä¹Ÿæœ‰äº†Kerasç‰ˆäº† ã€‹[Blog post]. Retrieved from <a href="https://spaces.ac.cn/archives/7367">https://spaces.ac.cn/archives/7367</a></p>
<p>@online{kexuefm-7367,<br />
title={èŠ‚çœæ˜¾å­˜çš„é‡è®¡ç®—æŠ€å·§ä¹Ÿæœ‰äº†Kerasç‰ˆäº†},<br />
author={è‹å‰‘æ—},<br />
year={2020},<br />
month={Apr},<br />
url={\url{https://spaces.ac.cn/archives/7367}},<br />
} </p>
<hr />
<h2 id="_6">å…¬å¼æ¨å¯¼ä¸æ³¨é‡Š</h2>
<p>TODO: æ·»åŠ è¯¦ç»†çš„æ•°å­¦å…¬å¼æ¨å¯¼å’Œæ³¨é‡Š</p>
        </div>
    </div>
</body>
</html>