<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transformerå‡çº§ä¹‹è·¯ï¼š1ã€Sinusoidalä½ç½®ç¼–ç è¿½æ ¹æº¯æº</title>
    <style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    line-height: 1.6; color: #333; max-width: 900px; margin: 0 auto; padding: 20px; background: #f5f5f5;
}
.container { background: white; padding: 40px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
header { border-bottom: 2px solid #e0e0e0; padding-bottom: 20px; margin-bottom: 30px; }
h1 { color: #2c3e50; margin-bottom: 10px; font-size: 2em; }
.meta { color: #666; font-size: 0.9em; margin-bottom: 20px; }
.content { margin-top: 30px; overflow-wrap: break-word; }
.content h2 { color: #34495e; margin-top: 30px; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
.content p { margin-bottom: 15px; }
.content pre { background: #f8f8f8; padding: 15px; border-radius: 5px; overflow-x: auto; border-left: 3px solid #3498db; margin: 15px 0; }
.content code { background: #f8f8f8; padding: 2px 5px; border-radius: 3px; font-family: monospace; font-size: 0.9em; }
.content blockquote { border-left: 4px solid #3498db; padding-left: 20px; margin: 20px 0; color: #555; font-style: italic; }
.content table { border-collapse: collapse; width: 100%; margin: 20px 0; }
.content th, .content td { border: 1px solid #ddd; padding: 10px; text-align: left; }
.back-link { display: inline-block; margin-bottom: 20px; color: #3498db; text-decoration: none; font-weight: 500; }
</style>
    
<script>
    window.MathJax = {
        tex: {
            inlineMath: [['$', '$'], ['\(', '\)']],
            displayMath: [['$$', '$$'], ['\[', '\]']],
            processEscapes: true
        }
    };
</script>
<script id="MathJax-script" async src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>

</head>
<body>
    <div class="container">
        <a href="../index.html" class="back-link">â† è¿”å›é¦–é¡µ</a>
        <header>
            <h1>Transformerå‡çº§ä¹‹è·¯ï¼š1ã€Sinusoidalä½ç½®ç¼–ç è¿½æ ¹æº¯æº</h1>
            <div class="meta">ğŸ“… æœ€åæ›´æ–°: 2026-01-08 | ğŸ“„ å¤§å°: 52.3 KB</div>
        </header>
        <div class="content">
            <p><strong>åŸæ–‡é“¾æ¥</strong>: <a href="https://spaces.ac.cn/archives/8231">https://spaces.ac.cn/archives/8231</a></p>
<p><strong>å‘å¸ƒæ—¥æœŸ</strong>: </p>
<hr />
<p>æœ€è¿‘ç¬”è€…åšäº†ä¸€äº›ç†è§£å’Œæ”¹è¿›Transformerçš„å°è¯•ï¼Œå¾—åˆ°äº†ä¸€äº›ä¼¼ä¹è¿˜æœ‰ä»·å€¼çš„ç»éªŒå’Œç»“è®ºï¼Œé‚å¼€ä¸€ä¸ªä¸“é¢˜æ€»ç»“ä¸€ä¸‹ï¼Œå‘½åä¸ºâ€œTransformerå‡çº§ä¹‹è·¯â€ï¼Œæ—¢ä»£è¡¨ç†è§£ä¸Šçš„æ·±å…¥ï¼Œä¹Ÿä»£è¡¨ç»“æœä¸Šçš„æ”¹è¿›ã€‚</p>
<p>ä½œä¸ºè¯¥ä¸“é¢˜çš„ç¬¬ä¸€ç¯‡æ–‡ç« ï¼Œç¬”è€…å°†ä¼šä»‹ç»è‡ªå·±å¯¹Googleåœ¨<a href="https://papers.cool/arxiv/1706.03762">ã€ŠAttention is All You Needã€‹</a>ä¸­æå‡ºæ¥çš„Sinusoidalä½ç½®ç¼–ç <br />
\begin{equation}\left\{\begin{aligned}&amp;\boldsymbol{p}<em 2i_1="2i+1" k_="k,">{k,2i}=\sin\Big(k/10000^{2i/d}\Big)\\\<br />
&amp;\boldsymbol{p}</em>\Big)}=\cos\Big(k/10000^{2i/d<br />
\end{aligned}\right.\label{eq:sin}\end{equation}<br />
çš„æ–°ç†è§£ï¼Œå…¶ä¸­$\boldsymbol{p}<em k_2i_1="k,2i+1">{k,2i},\boldsymbol{p}</em>$åˆ†åˆ«æ˜¯ä½ç½®$k$çš„ç¼–ç å‘é‡çš„ç¬¬$2i,2i+1$ä¸ªåˆ†é‡ï¼Œ$d$æ˜¯å‘é‡ç»´åº¦ã€‚</p>
<p>ä½œä¸ºä½ç½®ç¼–ç çš„ä¸€ä¸ªæ˜¾å¼è§£ï¼ŒGoogleåœ¨åŸè®ºæ–‡ä¸­å¯¹å®ƒçš„æè¿°å´å¯¥å¯¥æ— å‡ ï¼Œåªæ˜¯ç®€å•æåŠäº†å®ƒå¯ä»¥è¡¨è¾¾ç›¸å¯¹ä½ç½®ä¿¡æ¯ï¼Œåæ¥çŸ¥ä¹ç­‰å¹³å°ä¸Šä¹Ÿå‡ºç°äº†ä¸€äº›è§£è¯»ï¼Œå®ƒçš„ä¸€äº›ç‰¹ç‚¹ä¹Ÿé€æ­¥ä¸ºå¤§å®¶æ‰€çŸ¥ï¼Œä½†æ€»ä½“è€Œè¨€æ¯”è¾ƒé›¶æ•£ã€‚ç‰¹åˆ«æ˜¯å¯¹äºâ€œå®ƒæ˜¯æ€ä¹ˆæƒ³å‡ºæ¥çš„â€ã€â€œéå¾—è¦è¿™ä¸ªå½¢å¼ä¸å¯å—â€ç­‰åŸç†æ€§é—®é¢˜ï¼Œè¿˜æ²¡æœ‰æ¯”è¾ƒå¥½çš„ç­”æ¡ˆã€‚</p>
<p>å› æ­¤ï¼Œæœ¬æ–‡ä¸»è¦å›´ç»•è¿™äº›é—®é¢˜å±•å¼€æ€è€ƒï¼Œå¯èƒ½åœ¨æ€è€ƒè¿‡ç¨‹ä¸­è¯»è€…ä¼šæœ‰è·Ÿç¬”è€…ä¸€æ ·çš„æ„Ÿè§‰ï¼Œå³è¶Šæ€è€ƒè¶Šè§‰å¾—è¿™ä¸ªè®¾è®¡ä¹‹ç²¾å¦™æ¼‚äº®ï¼Œè®©äººå¹æœï½</p>
<h2 id="1">ç¬¬1éƒ¨åˆ†ï¼šç†è®ºåŸºç¡€ä¸å†å²å‘å±•</h2>
<h3 id="11">1.1 ä½ç½®ç¼–ç çš„å¿…è¦æ€§</h3>
<h4 id="transformer">Transformerçš„ç½®æ¢ä¸å˜æ€§é—®é¢˜</h4>
<p>Transformerçš„æ ¸å¿ƒæœºåˆ¶Self-Attentionæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ª<strong>ç½®æ¢ä¸å˜</strong>ï¼ˆPermutation Invariantï¼‰çš„æ“ä½œã€‚å‡è®¾æˆ‘ä»¬æœ‰è¾“å…¥åºåˆ—$\boldsymbol{X} = [\boldsymbol{x}_1, \boldsymbol{x}_2, \ldots, \boldsymbol{x}_n]$ï¼Œæ ‡å‡†çš„Self-Attentionè®¡ç®—ä¸ºï¼š</p>
<p>\begin{equation}
\text{Attention}(\boldsymbol{Q}, \boldsymbol{K}, \boldsymbol{V}) = \text{softmax}\left(\frac{\boldsymbol{QK}^{\top}}{\sqrt{d_k}}\right)\boldsymbol{V}
\tag{1}
\end{equation}</p>
<p>å…¶ä¸­$\boldsymbol{Q} = \boldsymbol{XW}_Q$ï¼Œ$\boldsymbol{K} = \boldsymbol{XW}_K$ï¼Œ$\boldsymbol{V} = \boldsymbol{XW}_V$ã€‚</p>
<p><strong>å®šç†1ï¼ˆAttentionçš„ç½®æ¢ä¸å˜æ€§ï¼‰</strong>ï¼šå¯¹äºä»»æ„ç½®æ¢çŸ©é˜µ$\boldsymbol{P}$ï¼ˆ$\boldsymbol{P}^{\top}\boldsymbol{P} = \boldsymbol{I}$ï¼‰ï¼Œæœ‰ï¼š</p>
<p>\begin{equation}
\text{Attention}(\boldsymbol{PX}, \boldsymbol{PX}, \boldsymbol{PX}) = \boldsymbol{P} \cdot \text{Attention}(\boldsymbol{X}, \boldsymbol{X}, \boldsymbol{X})
\tag{2}
\end{equation}</p>
<p><strong>è¯æ˜</strong>ï¼šç›´æ¥å±•å¼€æ³¨æ„åŠ›æœºåˆ¶å³å¯éªŒè¯ã€‚è¿™æ„å‘³ç€å¦‚æœäº¤æ¢è¾“å…¥é¡ºåºï¼Œè¾“å‡ºä¹Ÿä¼šä»¥ç›¸åŒæ–¹å¼äº¤æ¢ï¼Œæ¨¡å‹æ— æ³•åŒºåˆ†åºåˆ—çš„<strong>ç»å¯¹ä½ç½®</strong>ã€‚</p>
<p><strong>å®é™…åæœ</strong>ï¼š
- "æˆ‘çˆ±ä½ " å’Œ "ä½ çˆ±æˆ‘" å¯¹çº¯Attentionæ¨¡å‹æ˜¯ç­‰ä»·çš„
- "The cat sat on the mat" å’Œ "mat the on sat cat The" æ— æ³•åŒºåˆ†
- æ—¶åºä¿¡æ¯å®Œå…¨ä¸¢å¤±</p>
<p>è¿™åœ¨NLPã€æ—¶åºé¢„æµ‹ç­‰ä»»åŠ¡ä¸­æ˜¯è‡´å‘½çš„ï¼Œå› æ­¤å¿…é¡»å¼•å…¥<strong>ä½ç½®ç¼–ç </strong>ï¼ˆPositional Encodingï¼‰æ¥æ‰“ç ´è¿™ç§å¯¹ç§°æ€§ã€‚</p>
<h4 id="_1">ä½ç½®ç¼–ç çš„æ•°å­¦æœ¬è´¨</h4>
<p>ä»å½¢å¼ä¸Šçœ‹ï¼Œä½ç½®ç¼–ç å°±æ˜¯åœ¨è¾“å…¥åµŒå…¥$\boldsymbol{x}_i$ä¸ŠåŠ ä¸Šä½ç½®ç›¸å…³çš„å‘é‡$\boldsymbol{p}_i$ï¼š</p>
<p>\begin{equation}
\tilde{\boldsymbol{x}}_i = \boldsymbol{x}_i + \boldsymbol{p}_i
\tag{3}
\end{equation}</p>
<p>è¿™æ ·Attentionçš„è®¡ç®—å°±å˜æˆäº†ï¼š</p>
<p>\begin{equation}
\boldsymbol{q}_i = (\boldsymbol{x}_i + \boldsymbol{p}_i)\boldsymbol{W}_Q, \quad \boldsymbol{k}_j = (\boldsymbol{x}_j + \boldsymbol{p}_j)\boldsymbol{W}_K
\tag{4}
\end{equation}</p>
<p>æ³¨æ„åŠ›æƒé‡ä¸­çš„å†…ç§¯é¡¹ï¼š</p>
<p>\begin{equation}
\begin{aligned}
\boldsymbol{q}<em _text_å†…å®¹äº¤äº’="\text{å†…å®¹äº¤äº’">i^{\top}\boldsymbol{k}_j &amp;= (\boldsymbol{x}_i + \boldsymbol{p}_i)^{\top}\boldsymbol{W}_Q^{\top}\boldsymbol{W}_K(\boldsymbol{x}_j + \boldsymbol{p}_j) \
&amp;= \underbrace{\boldsymbol{x}_i^{\top}\boldsymbol{W}_Q^{\top}\boldsymbol{W}_K\boldsymbol{x}_j}</em>}} + \underbrace{\boldsymbol{x<em _text_å†…å®¹-ä½ç½®äº¤äº’="\text{å†…å®¹-ä½ç½®äº¤äº’">i^{\top}\boldsymbol{W}_Q^{\top}\boldsymbol{W}_K\boldsymbol{p}_j + \boldsymbol{p}_i^{\top}\boldsymbol{W}_Q^{\top}\boldsymbol{W}_K\boldsymbol{x}_j}</em> \
&amp;\quad + \underbrace{\boldsymbol{p}}<em _text_ä½ç½®-ä½ç½®äº¤äº’="\text{ä½ç½®-ä½ç½®äº¤äº’">i^{\top}\boldsymbol{W}_Q^{\top}\boldsymbol{W}_K\boldsymbol{p}_j}</em>
\end{aligned}
\tag{5}
\end{equation}}</p>
<p>æœ€åä¸€é¡¹$\boldsymbol{p}_i^{\top}\boldsymbol{W}_Q^{\top}\boldsymbol{W}_K\boldsymbol{p}_j$æä¾›äº†çº¯ç²¹çš„ä½ç½®ä¿¡æ¯äº¤äº’ã€‚</p>
<h3 id="12">1.2 ä½ç½®ç¼–ç æ–¹æ¡ˆç»¼è¿°</h3>
<h4 id="learned-positional-embeddings">å¯å­¦ä¹ çš„ä½ç½®ç¼–ç ï¼ˆLearned Positional Embeddingsï¼‰</h4>
<p>æœ€ç›´æ¥çš„æ–¹æ³•æ˜¯å°†ä½ç½®ç¼–ç ä½œä¸ºå¯å­¦ä¹ å‚æ•°ï¼Œå¦‚BERTæ‰€é‡‡ç”¨çš„æ–¹æ¡ˆï¼š</p>
<p>\begin{equation}
\boldsymbol{p}<em _max="\max">i \in \mathbb{R}^d, \quad i = 1, 2, \ldots, L</em>
\tag{6}
\end{equation}</p>
<p>å…¶ä¸­$L_{\max}$æ˜¯é¢„è®¾çš„æœ€å¤§åºåˆ—é•¿åº¦ï¼ˆBERTä¸­ä¸º512ï¼‰ã€‚</p>
<p><strong>ä¼˜ç‚¹</strong>ï¼š
- å®Œå…¨ç”±æ•°æ®é©±åŠ¨ï¼Œç†è®ºä¸Šå¯ä»¥å­¦åˆ°æœ€ä¼˜çš„ä½ç½®è¡¨ç¤º
- å®ç°ç®€å•</p>
<p><strong>ç¼ºç‚¹</strong>ï¼š
- æ— æ³•æ³›åŒ–åˆ°è®­ç»ƒæ—¶æœªè§è¿‡çš„é•¿åº¦ï¼ˆ$L &gt; L_{\max}$ï¼‰
- å‚æ•°é‡éšåºåˆ—é•¿åº¦çº¿æ€§å¢é•¿ï¼š$\mathcal{O}(L_{\max} \cdot d)$
- æ²¡æœ‰æ˜¾å¼çš„ç›¸å¯¹ä½ç½®ä¿¡æ¯</p>
<h4 id="sinusoidalfixed-sinusoidal-encoding">Sinusoidalä½ç½®ç¼–ç ï¼ˆFixed Sinusoidal Encodingï¼‰</h4>
<p>Googleåœ¨ã€ŠAttention is All You Needã€‹ä¸­æå‡ºçš„ç»å…¸æ–¹æ¡ˆï¼š</p>
<p>\begin{equation}
\begin{cases}
\boldsymbol{p}<em k_2i_1="k,2i+1">{k,2i} = \sin\left(\frac{k}{10000^{2i/d}}\right) \
\boldsymbol{p}</em>\right)
\end{cases}, \quad i = 0, 1, \ldots, \frac{d}{2}-1
\tag{7}
\end{equation}} = \cos\left(\frac{k}{10000^{2i/d}</p>
<p><strong>ä¼˜ç‚¹</strong>ï¼š
- æ— å‚æ•°ï¼Œæ— éœ€è®­ç»ƒ
- å¯ä»¥å¤–æ¨åˆ°ä»»æ„é•¿åº¦
- å…·æœ‰è‰¯å¥½çš„æ•°å­¦æ€§è´¨ï¼ˆæœ¬æ–‡é‡ç‚¹ï¼‰</p>
<p><strong>ç¼ºç‚¹</strong>ï¼š
- å›ºå®šä¸å¯è°ƒï¼Œå¯èƒ½ä¸æ˜¯æœ€ä¼˜çš„
- å¤–æ¨æ€§èƒ½ä»æœ‰å±€é™</p>
<h4 id="_2">ç›¸å¯¹ä½ç½®ç¼–ç å®¶æ—</h4>
<p>åç»­ç ”ç©¶å‘ç°ï¼Œå¾ˆå¤šä»»åŠ¡ä¸­<strong>ç›¸å¯¹ä½ç½®</strong>æ¯”ç»å¯¹ä½ç½®æ›´é‡è¦ï¼Œè¡ç”Ÿå‡ºå¤šä¸ªæ–¹æ¡ˆï¼š</p>
<ol>
<li>
<p><strong>Shaw et al. (2018) - Self-Attention with Relative Position Representations</strong>ï¼š
   ç›´æ¥åœ¨Attentionä¸­åŠ å…¥ç›¸å¯¹ä½ç½®åç½®ï¼š
   \begin{equation}
   e_{ij} = \frac{\boldsymbol{x}<em i-j="i-j">i\boldsymbol{W}_Q (\boldsymbol{x}_j\boldsymbol{W}_K + \boldsymbol{r}</em>
   \tag{8}
   \end{equation}})^{\top}}{\sqrt{d_k}</p>
</li>
<li>
<p><strong>RoPE (Su et al. 2021) - Rotary Position Embedding</strong>ï¼š
   é€šè¿‡æ—‹è½¬çŸ©é˜µç¼–ç ç›¸å¯¹ä½ç½®ï¼ˆåç»­ç¯‡ç« è¯¦è¿°ï¼‰</p>
</li>
<li>
<p><strong>ALiBi (Press et al. 2021)</strong>ï¼š
   åœ¨æ³¨æ„åŠ›åˆ†æ•°ä¸Šç›´æ¥åŠ çº¿æ€§åç½®ï¼š
   \begin{equation}
   \text{softmax}(\boldsymbol{QK}^{\top} - m \cdot |i-j|)
   \tag{9}
   \end{equation}</p>
</li>
</ol>
<h3 id="13-sinusoidal">1.3 Sinusoidalä½ç½®ç¼–ç çš„è®¾è®¡å“²å­¦</h3>
<p>Sinusoidalä½ç½®ç¼–ç çš„è®¾è®¡è•´å«äº†ä¸‰ä¸ªæ ¸å¿ƒæ€æƒ³ï¼š</p>
<h4 id="1_1">æ€æƒ³1ï¼šé€šè¿‡ç»å¯¹ä½ç½®è¡¨è¾¾ç›¸å¯¹ä½ç½®</h4>
<p>çœ‹ä¼¼çŸ›ç›¾ï¼Œä½†æ•°å­¦ä¸Šå¯è¡Œã€‚å…³é”®åœ¨äºåˆ©ç”¨ä¸‰è§’å‡½æ•°çš„<strong>å’Œå·®å…¬å¼</strong>ï¼š</p>
<p>\begin{equation}
\sin(\alpha - \beta) = \sin\alpha\cos\beta - \cos\alpha\sin\beta
\tag{10}
\end{equation}</p>
<p>è¿™ä½¿å¾—$\boldsymbol{p}_m$å’Œ$\boldsymbol{p}_n$çš„å†…ç§¯å¯ä»¥è¡¨è¾¾ç›¸å¯¹ä½ç½®$m-n$çš„ä¿¡æ¯ï¼ˆåæ–‡è¯¦ç»†æ¨å¯¼ï¼‰ã€‚</p>
<h4 id="2long-range-decay">æ€æƒ³2ï¼šè¿œç¨‹è¡°å‡ï¼ˆLong-Range Decayï¼‰</h4>
<p>ç›´è§‰ä¸Šï¼Œè·ç¦»è¶Šè¿œçš„tokenç›¸å…³æ€§åº”è¯¥è¶Šå¼±ã€‚Sinusoidalç¼–ç é€šè¿‡å¤šé¢‘ç‡å åŠ ï¼Œè‡ªç„¶äº§ç”Ÿäº†è¿œç¨‹è¡°å‡æ•ˆåº”ï¼š</p>
<p>\begin{equation}
\langle \boldsymbol{p}_m, \boldsymbol{p}_n \rangle \approx \frac{C}{|m-n|^{\alpha}}, \quad |m-n| \to \infty
\tag{11}
\end{equation}</p>
<p>è¿™ä¸ç‰©ç†å­¦ä¸­çš„è¡°å‡å¾‹ç±»ä¼¼ï¼ˆå¦‚å¼•åŠ›çš„å¹³æ–¹åæ¯”å¾‹ï¼‰ã€‚</p>
<h4 id="3multi-scale-representation">æ€æƒ³3ï¼šå¤šå°ºåº¦è¡¨ç¤ºï¼ˆMulti-Scale Representationï¼‰</h4>
<p>ä¸åŒç»´åº¦ä½¿ç”¨ä¸åŒé¢‘ç‡$\theta_i = 10000^{-2i/d}$ï¼Œå½¢æˆ<strong>é¢‘è°±</strong>ï¼š</p>
<ul>
<li>é«˜é¢‘åˆ†é‡ï¼ˆ$i$å°ï¼‰ï¼šæ•æ‰çŸ­ç¨‹ä¾èµ–ï¼ˆç›¸é‚»è¯æ±‡ï¼‰</li>
<li>ä½é¢‘åˆ†é‡ï¼ˆ$i$å¤§ï¼‰ï¼šæ•æ‰é•¿ç¨‹ä¾èµ–ï¼ˆå¥å­ç»“æ„ï¼‰</li>
</ul>
<p>ç±»æ¯”ä¿¡å·å¤„ç†ä¸­çš„å°æ³¢å˜æ¢ï¼Œè¿™æ˜¯ä¸€ç§<strong>æ—¶é¢‘åˆ†æ</strong>æ€æƒ³ã€‚</p>
<h3 id="14">1.4 é—®é¢˜çš„æå‡ºä¸æœ¬æ–‡ç›®æ ‡</h3>
<p>å°½ç®¡Sinusoidalä½ç½®ç¼–ç è¢«å¹¿æ³›ä½¿ç”¨ï¼Œä½†åŸå§‹è®ºæ–‡å¯¹å…¶æ¥æºè¯­ç„‰ä¸è¯¦ã€‚æ ¸å¿ƒé—®é¢˜ï¼š</p>
<ol>
<li><strong>å¦‚ä½•"åæ¨"å‡ºè¿™ä¸ªå½¢å¼</strong>ï¼Ÿï¼ˆæ•°å­¦æ¨å¯¼ï¼‰</li>
<li><strong>ä¸ºä»€ä¹ˆæ˜¯$10000^{-2i/d}$è¿™ä¸ªåº•æ•°</strong>ï¼Ÿï¼ˆå‚æ•°é€‰æ‹©ï¼‰</li>
<li><strong>åœ¨ä»€ä¹ˆå‡è®¾ä¸‹å®ƒæ˜¯"æœ€ä¼˜"çš„</strong>ï¼Ÿï¼ˆç†è®ºåˆ†æï¼‰</li>
<li><strong>ä¸å­¦ä¹ å¼ç¼–ç ç›¸æ¯”ï¼Œä¼˜åŠ£åŠ¿åœ¨å“ª</strong>ï¼Ÿï¼ˆå¯¹æ¯”åˆ†æï¼‰</li>
</ol>
<p>æœ¬æ–‡å°†é€šè¿‡<strong>å››æ­¥æ¨å¯¼æ³•</strong>å›ç­”è¿™äº›é—®é¢˜ï¼š
1. æ³°å‹’å±•å¼€ â†’ å»ºç«‹ä½ç½®ç¼–ç ä¸ç›¸å¯¹ä½ç½®çš„æ•°å­¦è”ç³»
2. å¤æ•°æ¨å¯¼ â†’ å¾—åˆ°ä¸‰è§’å‡½æ•°å½¢å¼
3. è¿œç¨‹è¡°å‡ â†’ ç¡®å®šé¢‘ç‡å‚æ•°
4. ä¸€èˆ¬åŒ–åˆ†æ â†’ è®¨è®ºHessiançŸ©é˜µçš„å½±å“</p>
<h2 id="2">ç¬¬2éƒ¨åˆ†ï¼šæ•°å­¦æ¨å¯¼çš„å®Œæ•´å±•å¼€</h2>
<h3 id="21">2.1 æ³°å‹’å±•å¼€ä¸æ‰°åŠ¨åˆ†æ</h3>
<h4 id="_3">æ¨¡å‹çš„å…¨å¯¹ç§°æ€§</h4>
<p>å‡è®¾æˆ‘ä»¬çš„æ¨¡å‹ä¸º$f(\cdots,\boldsymbol{x}_m,\cdots,\boldsymbol{x}_n,\cdots)$ï¼Œå…¶ä¸­æ ‡è®°å‡ºæ¥çš„$\boldsymbol{x}_m,\boldsymbol{x}_n$åˆ†åˆ«è¡¨ç¤ºç¬¬$m,n$ä¸ªè¾“å…¥ï¼Œä¸å¤±ä¸€èˆ¬æ€§ï¼Œè®¾$f$æ˜¯æ ‡é‡å‡½æ•°ã€‚å¯¹äºä¸å¸¦Attention Maskçš„çº¯Attentionæ¨¡å‹ï¼Œå®ƒæ˜¯å…¨å¯¹ç§°çš„ï¼Œå³å¯¹äºä»»æ„çš„$m,n$ï¼Œéƒ½æœ‰
\begin{equation}f(\cdots,\boldsymbol{x}_m,\cdots,\boldsymbol{x}_n,\cdots)=f(\cdots,\boldsymbol{x}_n,\cdots,\boldsymbol{x}_m,\cdots)\tag{12}\end{equation}
è¿™å°±æ˜¯æˆ‘ä»¬è¯´Transformeræ— æ³•è¯†åˆ«ä½ç½®çš„åŸå› â€”â€”å…¨å¯¹ç§°æ€§ï¼Œç®€å•æ¥è¯´å°±æ˜¯å‡½æ•°å¤©ç„¶æ»¡è¶³æ’ç­‰å¼$f(x,y)=f(y,x)$ï¼Œä»¥è‡³äºæˆ‘ä»¬æ— æ³•ä»ç»“æœä¸ŠåŒºåˆ†è¾“å…¥æ˜¯$[x,y]$è¿˜æ˜¯$[y,x]$ã€‚</p>
<p>å› æ­¤ï¼Œæˆ‘ä»¬è¦åšçš„äº‹æƒ…ï¼Œå°±æ˜¯è¦æ‰“ç ´è¿™ç§å¯¹ç§°æ€§ï¼Œæ¯”å¦‚åœ¨æ¯ä¸ªä½ç½®ä¸Šéƒ½åŠ ä¸Šä¸€ä¸ªä¸åŒçš„ç¼–ç å‘é‡ï¼š<br />
\begin{equation}\tilde{f}(\cdots,\boldsymbol{x}_m,\cdots,\boldsymbol{x}_n,\cdots)=f(\cdots,\boldsymbol{x}_m + \boldsymbol{p}_m,\cdots,\boldsymbol{x}_n + \boldsymbol{p}_n,\cdots)\end{equation}<br />
ä¸€èˆ¬æ¥è¯´ï¼Œåªè¦æ¯ä¸ªä½ç½®çš„ç¼–ç å‘é‡ä¸åŒï¼Œé‚£ä¹ˆè¿™ç§å…¨å¯¹ç§°æ€§å°±è¢«æ‰“ç ´äº†ï¼Œå³å¯ä»¥ç”¨$\tilde{f}$ä»£æ›¿$f$æ¥å¤„ç†æœ‰åºçš„è¾“å…¥ã€‚ä½†ç°åœ¨æˆ‘ä»¬å¸Œæœ›èƒ½è¿›ä¸€æ­¥åˆ†æä½ç½®ç¼–ç çš„æ€§è´¨ï¼Œç”šè‡³å¾—åˆ°ä¸€ä¸ªæ˜¾å¼è§£ï¼Œé‚£ä¹ˆå°±ä¸èƒ½æ­¢æ­¥äºæ­¤ã€‚</p>
<p>ä¸ºäº†ç®€åŒ–é—®é¢˜ï¼Œæˆ‘ä»¬å…ˆåªè€ƒè™‘$m,n$è¿™ä¸¤ä¸ªä½ç½®ä¸Šçš„ä½ç½®ç¼–ç ï¼Œå°†å®ƒè§†ä¸ºæ‰°åŠ¨é¡¹ï¼Œæ³°å‹’å±•å¼€åˆ°äºŒé˜¶ï¼š<br />
\begin{equation}\tilde{f}\approx f + \boldsymbol{p}<em _boldsymbol_p="\boldsymbol{p">m^{\top} \frac{\partial f}{\partial \boldsymbol{x}_m} + \boldsymbol{p}_n^{\top} \frac{\partial f}{\partial \boldsymbol{x}_n} + \frac{1}{2}\boldsymbol{p}_m^{\top} \frac{\partial^2 f}{\partial \boldsymbol{x}_m^2}\boldsymbol{p}_m + \frac{1}{2}\boldsymbol{p}_n^{\top} \frac{\partial^2 f}{\partial \boldsymbol{x}_n^2}\boldsymbol{p}_n + \underbrace{\boldsymbol{p}_m^{\top} \frac{\partial^2 f}{\partial \boldsymbol{x}_m \partial \boldsymbol{x}_n}\boldsymbol{p}_n}</em>}_m^{\top} \boldsymbol{\mathcal{H}} \boldsymbol{p}_n}\end{equation<br />
å¯ä»¥çœ‹åˆ°ï¼Œç¬¬1é¡¹è·Ÿä½ç½®æ— å…³ï¼Œç¬¬2åˆ°5é¡¹éƒ½åªä¾èµ–äºå•ä¸€ä½ç½®ï¼Œæ‰€ä»¥å®ƒä»¬æ˜¯çº¯ç²¹çš„ç»å¯¹ä½ç½®ä¿¡æ¯ï¼Œç¬¬6é¡¹æ˜¯ç¬¬ä¸€ä¸ªåŒæ—¶åŒ…å«$\boldsymbol{p}_m,\boldsymbol{p}_n$çš„äº¤äº’é¡¹ï¼Œæˆ‘ä»¬å°†å®ƒè®°ä¸º$\boldsymbol{p}_m^{\top} \boldsymbol{\mathcal{H}} \boldsymbol{p}_n$ï¼Œå¸Œæœ›å®ƒèƒ½è¡¨è¾¾ä¸€å®šçš„ç›¸å¯¹ä½ç½®ä¿¡æ¯ã€‚</p>
<p>ï¼ˆæ­¤å¤„çš„æ³°å‹’å±•å¼€å‚è€ƒäº†çŸ¥ä¹é—®é¢˜<a href="https://www.zhihu.com/question/307293465/answer/1028613658">ã€ŠBERTä¸ºä½•ä½¿ç”¨å­¦ä¹ çš„position embeddingè€Œéæ­£å¼¦position encoding?ã€‹</a>ä¸Šçš„çº³ç±³é…±çš„å›å¤ã€‚ï¼‰</p>
<h3 id="22">2.2 ç›¸å¯¹ä½ç½®çš„å¤æ•°æ¨å¯¼</h3>
<h4 id="_4">ä»å†…ç§¯åˆ°ç›¸å¯¹ä½ç½®</h4>
<p>æˆ‘ä»¬å…ˆä»ç®€å•çš„ä¾‹å­å…¥æ‰‹ï¼Œå‡è®¾$\boldsymbol{\mathcal{H}}=\boldsymbol{I}$æ˜¯å•ä½çŸ©é˜µï¼Œæ­¤æ—¶ï¼š</p>
<p>\begin{equation}
\boldsymbol{p}_m^{\top} \boldsymbol{\mathcal{H}} \boldsymbol{p}_n = \boldsymbol{p}_m^{\top} \boldsymbol{p}_n = \langle\boldsymbol{p}_m, \boldsymbol{p}_n\rangle
\tag{13}
\end{equation}</p>
<p>æ˜¯ä¸¤ä¸ªä½ç½®ç¼–ç çš„å†…ç§¯ã€‚æˆ‘ä»¬å¸Œæœ›åœ¨è¿™ä¸ªç®€å•çš„ä¾‹å­ä¸­è¯¥é¡¹è¡¨è¾¾çš„æ˜¯ç›¸å¯¹ä½ç½®ä¿¡æ¯ï¼Œå³å­˜åœ¨æŸä¸ªå‡½æ•°$g$ä½¿å¾—ï¼š</p>
<p>\begin{equation}
\langle\boldsymbol{p}_m, \boldsymbol{p}_n\rangle = g(m-n)
\tag{14}\label{eq:r1}
\end{equation}</p>
<p>è¿™ä¸ªè¦æ±‚çœ‹ä¼¼ç®€å•ï¼Œå®åˆ™æ·±åˆ»ï¼š<strong>ä»…é€šè¿‡ä¸¤ä¸ªç»å¯¹ä½ç½®å‘é‡çš„å†…ç§¯ï¼Œå°±èƒ½æå–å‡ºç›¸å¯¹ä½ç½®$m-n$çš„ä¿¡æ¯</strong>ã€‚</p>
<h4 id="_5">äºŒç»´æƒ…å½¢çš„å®Œæ•´æ¨å¯¼</h4>
<p>è¿™é‡Œçš„$\boldsymbol{p}_m, \boldsymbol{p}_n$æ˜¯$d$ç»´å‘é‡ï¼Œè¿™é‡Œæˆ‘ä»¬ä»æœ€ç®€å•$d=2$å…¥æ‰‹ã€‚</p>
<p><strong>å¤æ•°è¡¨ç¤ºçš„å·§å¦™ä¹‹å¤„</strong>ï¼šå¯¹äº2ç»´å‘é‡ï¼Œæˆ‘ä»¬å€ŸåŠ©å¤æ•°æ¥æ¨å¯¼ã€‚å°†å‘é‡$[x,y]$è§†ä¸ºå¤æ•°$z = x + y\text{i}$ï¼Œè¿™é‡Œå¤æ•°ä¹˜æ³•çš„å‡ ä½•æ„ä¹‰è‡³å…³é‡è¦ï¼š</p>
<p>\begin{equation}
z_1 \cdot z_2 = |z_1||z_2|e^{\text{i}(\arg z_1 + \arg z_2)}
\tag{15}
\end{equation}</p>
<p>å³å¤æ•°ç›¸ä¹˜ï¼Œæ¨¡é•¿ç›¸ä¹˜ï¼Œå¹…è§’ç›¸åŠ ã€‚æ ¹æ®å¤æ•°å†…ç§¯çš„æ€§è´¨ï¼š</p>
<p>\begin{equation}
\langle\boldsymbol{p}_m, \boldsymbol{p}_n\rangle = \text{Re}[\boldsymbol{p}_m \boldsymbol{p}_n^*]
\tag{16}
\end{equation}</p>
<p>å…¶ä¸­$\boldsymbol{p}_n^<em>$æ˜¯$\boldsymbol{p}_n$çš„å…±è½­å¤æ•°ï¼ˆ$z^</em> = x - y\text{i}$ï¼‰ï¼Œ$\text{Re}[\cdot]$ä»£è¡¨å¤æ•°çš„å®éƒ¨ã€‚</p>
<p><strong>å…³é”®æŠ€å·§</strong>ï¼šä¸ºäº†æ»¡è¶³å¼$\eqref{eq:r1}$ï¼ˆå³å†…ç§¯åªä¾èµ–äº$m-n$ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥å‡è®¾å­˜åœ¨å¤æ•°$\boldsymbol{q}_{m-n}$ä½¿å¾—ï¼š</p>
<p>\begin{equation}
\boldsymbol{p}<em m-n="m-n">m \boldsymbol{p}_n^* = \boldsymbol{q}</em>
\tag{17}
\end{equation}</p>
<p>è¿™æ ·ä¸¤è¾¹å–å®éƒ¨å°±å¾—åˆ°äº†å¼$\eqref{eq:r1}$ã€‚</p>
<p><strong>æŒ‡æ•°å½¢å¼æ±‚è§£</strong>ï¼šä½¿ç”¨Eulerå…¬å¼$e^{\text{i}\theta} = \cos\theta + \text{i}\sin\theta$ï¼Œè®¾ï¼š</p>
<p>\begin{equation}
\begin{cases}
\boldsymbol{p}<em m-n="m-n">m = r_m e^{\text{i}\phi_m} \
\boldsymbol{p}_n^* = r_n e^{-\text{i}\phi_n} \
\boldsymbol{q}</em>
\end{cases}
\tag{18}
\end{equation}} = R_{m-n} e^{\text{i}\Phi_{m-n}</p>
<p>ä»£å…¥æ–¹ç¨‹(17)å¾—ï¼š</p>
<p>\begin{equation}
r_m r_n e^{\text{i}(\phi_m - \phi_n)} = R_{m-n} e^{\text{i}\Phi_{m-n}}
\tag{19}
\end{equation}</p>
<p>ç”±å¤æ•°ç›¸ç­‰çš„å……è¦æ¡ä»¶ï¼ˆæ¨¡é•¿ç›¸ç­‰ä¸”å¹…è§’ç›¸ç­‰ï¼‰ï¼Œå¾—åˆ°ï¼š</p>
<p>\begin{equation}
\begin{cases}
r_m r_n = R_{m-n} &amp; \text{ï¼ˆæ¨¡é•¿æ–¹ç¨‹ï¼‰} \
\phi_m - \phi_n = \Phi_{m-n} &amp; \text{ï¼ˆå¹…è§’æ–¹ç¨‹ï¼‰}
\end{cases}
\tag{20}
\end{equation}</p>
<p><strong>æ±‚è§£æ¨¡é•¿</strong>ï¼šä»¤$n=m$ä»£å…¥æ¨¡é•¿æ–¹ç¨‹ï¼š</p>
<p>\begin{equation}
r_m^2 = R_0 \quad \Rightarrow \quad r_m = \sqrt{R_0} = \text{å¸¸æ•°}
\tag{21}
\end{equation}</p>
<p>ç®€å•èµ·è§ï¼Œå½’ä¸€åŒ–ä¸º$r_m = 1$ï¼ˆè¿™æ ·ä½ç½®ç¼–ç çš„æ¨¡é•¿ä¸º1ï¼Œç±»ä¼¼å•ä½åœ†ä¸Šçš„ç‚¹ï¼‰ã€‚</p>
<p><strong>æ±‚è§£å¹…è§’</strong>ï¼šä»¤$n=0$ä»£å…¥å¹…è§’æ–¹ç¨‹ï¼š</p>
<p>\begin{equation}
\phi_m - \phi_0 = \Phi_m
\tag{22}
\end{equation}</p>
<p>åˆå§‹æ¡ä»¶é€‰æ‹©$\phi_0 = 0$ï¼ˆåŸç‚¹å¯¹åº”å¤å¹³é¢å®è½´ï¼‰ï¼Œåˆ™$\phi_m = \Phi_m$ã€‚</p>
<p>å†ä»¤$n=m-1$ä»£å…¥å¹…è§’æ–¹ç¨‹ï¼š</p>
<p>\begin{equation}
\phi_m - \phi_{m-1} = \phi_1 \equiv \theta \quad \text{ï¼ˆå¸¸æ•°ï¼‰}
\tag{23}
\end{equation}</p>
<p>è¿™è¡¨æ˜${\phi_m}$æ˜¯<strong>ç­‰å·®æ•°åˆ—</strong>ï¼Œå…¬å·®ä¸º$\theta$ã€‚ç”±é€’æ¨å…³ç³»ï¼š</p>
<p>\begin{equation}
\phi_m = \phi_0 + m\theta = m\theta
\tag{24}
\end{equation}</p>
<p><strong>æœ€ç»ˆè§£</strong>ï¼šå› æ­¤äºŒç»´æƒ…å½¢ä¸‹ä½ç½®ç¼–ç çš„è§£ä¸ºï¼š</p>
<p>\begin{equation}
\boldsymbol{p}_m = e^{\text{i}m\theta} = \cos(m\theta) + \text{i}\sin(m\theta)
\tag{25}
\end{equation}</p>
<p>è½¬æ¢ä¸ºå®å‘é‡å½¢å¼ï¼š</p>
<p>\begin{equation}
\boldsymbol{p}_m = \begin{pmatrix}\cos(m\theta) \ \sin(m\theta)\end{pmatrix}
\tag{26}
\end{equation}</p>
<p><strong>å‡ ä½•æ„ä¹‰</strong>ï¼šè¿™å¯¹åº”äºå•ä½åœ†ä¸Šä»¥è§’é€Ÿåº¦$\theta$æ—‹è½¬çš„ç‚¹ã€‚ä½ç½®$m$å¯¹åº”çš„è§’åº¦ä¸º$m\theta$ï¼Œç›¸é‚»ä½ç½®ç›¸å·®å›ºå®šè§’åº¦$\theta$ã€‚</p>
<h4 id="_6">éªŒè¯ç›¸å¯¹ä½ç½®æ€§è´¨</h4>
<p>è®©æˆ‘ä»¬éªŒè¯å¼(26)ç¡®å®æ»¡è¶³å¼$\eqref{eq:r1}$ï¼š</p>
<p>\begin{equation}
\begin{aligned}
\langle\boldsymbol{p}_m, \boldsymbol{p}_n\rangle &amp;= \cos(m\theta)\cos(n\theta) + \sin(m\theta)\sin(n\theta) \
&amp;= \cos((m-n)\theta) \quad \text{ï¼ˆä½™å¼¦å’Œå·®å…¬å¼ï¼‰}
\end{aligned}
\tag{27}
\end{equation}</p>
<p>å®Œç¾ï¼å†…ç§¯ä»…ä¾èµ–äºç›¸å¯¹ä½ç½®$m-n$ï¼Œä¸”å…·æœ‰å‘¨æœŸæ€§å’Œå¯¹ç§°æ€§ï¼š</p>
<ul>
<li><strong>å‘¨æœŸæ€§</strong>ï¼š$g(k) = \cos(k\theta)$ï¼Œå‘¨æœŸä¸º$2\pi/\theta$</li>
<li><strong>å¯¹ç§°æ€§</strong>ï¼š$g(m-n) = g(n-m)$</li>
<li><strong>å•è°ƒæ€§</strong>ï¼šåœ¨$k \in [0, \pi/\theta]$å†…å•è°ƒé€’å‡ï¼Œç¬¦åˆ"è·ç¦»è¶Šè¿œç›¸å…³æ€§è¶Šå¼±"çš„ç›´è§‰</li>
</ul>
<h4 id="_7">é«˜ç»´æ¨å¹¿</h4>
<p>ç”±äºå†…ç§¯æ»¡è¶³<strong>çº¿æ€§å åŠ æ€§</strong>ï¼Œæ›´é«˜ç»´çš„å¶æ•°ç»´ä½ç½®ç¼–ç å¯ä»¥è¡¨ç¤ºä¸ºå¤šä¸ªäºŒç»´ç¼–ç çš„æ‹¼æ¥ï¼š</p>
<p>\begin{equation}
\boldsymbol{p}<em d_2-1="d/2-1">m = \begin{pmatrix}
e^{\text{i}m\theta_0} \
e^{\text{i}m\theta_1} \
\vdots \
e^{\text{i}m\theta</em>
\end{pmatrix}
\quad \Leftrightarrow \quad
\boldsymbol{p}}<em d_2-1="d/2-1">m = \begin{pmatrix}
\cos(m\theta_0) \
\sin(m\theta_0) \
\cos(m\theta_1) \
\sin(m\theta_1) \
\vdots \
\cos(m\theta</em>) \
\sin(m\theta_{d/2-1})
\end{pmatrix}
\tag{28}\label{eq:r2}
\end{equation}</p>
<p>æ­¤æ—¶å†…ç§¯ä¸ºï¼š</p>
<p>\begin{equation}
\langle\boldsymbol{p}<em i="0">m, \boldsymbol{p}_n\rangle = \sum</em> \cos((m-n)\theta_i)
\tag{29}
\end{equation}}^{d/2-1</p>
<p>ä»ç„¶åªä¾èµ–äº$m-n$ï¼Œæ»¡è¶³ç›¸å¯¹ä½ç½®æ€§è´¨ã€‚</p>
<p><strong>å”¯ä¸€æ€§è®¨è®º</strong>ï¼šå¼(28)åªæ˜¯ä¸€ä¸ªç‰¹è§£ï¼Œä¸æ˜¯å”¯ä¸€è§£ã€‚ä¾‹å¦‚ï¼š
- æ”¹å˜$\sin/\cos$é¡ºåº
- æ·»åŠ ç›¸ä½åç§»$\cos(m\theta + \phi_i)$
- ä½¿ç”¨å…¶ä»–æ­£äº¤å‡½æ•°ç³»ï¼ˆChebyshevå¤šé¡¹å¼ç­‰ï¼‰</p>
<p>ä½†ä¸‰è§’å‡½æ•°å½¢å¼ç”±äºå…¶è‰¯å¥½çš„è§£ææ€§è´¨ï¼ˆå¯å¾®ã€å‘¨æœŸã€æ­£äº¤ï¼‰ï¼Œæˆä¸ºæœ€è‡ªç„¶çš„é€‰æ‹©ã€‚</p>
<h3 id="23">2.3 è¿œç¨‹è¡°å‡ç‰¹æ€§çš„æ·±å…¥åˆ†æ</h3>
<h4 id="_8">é¢‘ç‡å‚æ•°çš„é€‰æ‹©</h4>
<p>åŸºäºå‰é¢çš„å‡è®¾ï¼Œæˆ‘ä»¬æ¨å¯¼å‡ºäº†ä½ç½®ç¼–ç çš„å½¢å¼$\eqref{eq:r2}$ï¼Œå®ƒè·Ÿæ ‡å‡†çš„Sinusoidalä½ç½®ç¼–ç å½¢å¼åŸºæœ¬ä¸€æ ·äº†ï¼Œåªæ˜¯$\sin,\cos$çš„ä½ç½®ç•¥æœ‰ä¸åŒã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œç¥ç»ç½‘ç»œçš„ç¥ç»å…ƒéƒ½æ˜¯æ— åºçš„ï¼Œæ‰€ä»¥å“ªæ€•æ‰“ä¹±å„ä¸ªç»´åº¦ï¼Œä¹Ÿæ˜¯ä¸€ç§åˆç†çš„ä½ç½®ç¼–ç ï¼Œå› æ­¤é™¤äº†å„ä¸ª$\theta_i$æ²¡ç¡®å®šä¸‹æ¥å¤–ï¼ŒäºŒè€…å¹¶æ— æœ¬è´¨åŒºåˆ«ã€‚</p>
<p><strong>æ ¸å¿ƒé—®é¢˜</strong>ï¼šåŸå§‹è®ºæ–‡é€‰æ‹©$\theta_i = 10000^{-2i/d}$ï¼Œè¿™ä¸ª"é­”æ³•æ•°å­—"æœ‰ä»€ä¹ˆæ·±æ„ï¼Ÿ</p>
<p>\begin{equation}
\theta_i = \frac{1}{10000^{2i/d}} = 10000^{-2i/d}, \quad i = 0, 1, \ldots, \frac{d}{2}-1
\tag{30}
\end{equation}</p>
<p>äº‹å®ä¸Šï¼Œè¿™ä¸ªå½¢å¼å¸¦æ¥ä¸€ä¸ªç²¾å¦™çš„æ€§è´¨ï¼š<strong>éšç€$|m-n|$å¢å¤§ï¼Œå†…ç§¯$\langle\boldsymbol{p}_m, \boldsymbol{p}_n\rangle$å‘ˆç°è¡°å‡è¶‹åŠ¿</strong>ã€‚</p>
<p>è¿™ç¬¦åˆè¯­è¨€å­¦ç›´è§‰ï¼š<strong>ç›¸å¯¹è·ç¦»è¶Šå¤§çš„è¯ï¼Œç›¸å…³æ€§åº”è¯¥è¶Šå¼±</strong>ã€‚ä½†é—®é¢˜æ¥äº†ï¼šæ˜æ˜æ˜¯å‘¨æœŸæ€§çš„ä¸‰è§’å‡½æ•°ï¼Œæ€ä¹ˆä¼šè¡°å‡ï¼Ÿ</p>
<h4 id="_9">æŒ¯è¡ç§¯åˆ†ä¸è¿œç¨‹æ¸è¿‘è¡Œä¸º</h4>
<p>ä»å¼(29)å‡ºå‘ï¼Œå°†å†…ç§¯æ”¹å†™ä¸ºç¦»æ•£å’Œçš„å½¢å¼ï¼š</p>
<p>\begin{equation}
\begin{aligned}
\langle\boldsymbol{p}<em i="0">m, \boldsymbol{p}_n\rangle &amp;= \sum</em> \cos((m-n)\theta_i) \
&amp;= \text{Re}\left[\sum_{i=0}^{d/2-1} e^{\text{i}(m-n)\theta_i}\right]
\end{aligned}
\tag{31}
\end{equation}}^{d/2-1</p>
<p>ä»£å…¥$\theta_i = 10000^{-2i/d}$ï¼š</p>
<p>\begin{equation}
\langle\boldsymbol{p}<em i="0">m, \boldsymbol{p}_n\rangle = \text{Re}\left[\sum</em>\right]
\tag{32}
\end{equation}}^{d/2-1} e^{\text{i}(m-n) \cdot 10000^{-2i/d}</p>
<p><strong>å…³é”®å˜æ¢</strong>ï¼šå°†æ±‚å’Œè½¬æ¢ä¸ºç§¯åˆ†ã€‚ä»¤$t = 2i/d \in [0, 1]$ï¼Œæ­¥é•¿$\Delta t = 2/d$ï¼Œé»æ›¼å’Œè¿‘ä¼¼ï¼š</p>
<p>\begin{equation}
\begin{aligned}
\sum_{i=0}^{d/2-1} e^{\text{i}(m-n) \cdot 10000^{-2i/d}} &amp;\approx \frac{d}{2} \sum_{i=0}^{d/2-1} e^{\text{i}(m-n) \cdot 10000^{-t}} \cdot \frac{2}{d} \
&amp;\approx \frac{d}{2} \int_0^1 e^{\text{i}(m-n) \cdot 10000^{-t}} dt
\end{aligned}
\tag{33}
\end{equation}</p>
<p>å› æ­¤é—®é¢˜è½¬åŒ–ä¸ºä¼°è®¡<strong>æŒ¯è¡ç§¯åˆ†</strong>ï¼ˆOscillatory Integralï¼‰ï¼š</p>
<p>\begin{equation}
I(\Delta) = \int_0^1 e^{\text{i}\Delta \cdot 10000^{-t}} dt, \quad \Delta = m - n
\tag{34}
\end{equation}</p>
<h4 id="_10">æŒ¯è¡ç§¯åˆ†ç†è®ºåŸºç¡€</h4>
<p><strong>å®šç†2ï¼ˆRiemann-Lebesgueå¼•ç†çš„ç‰¹ä¾‹ï¼‰</strong>ï¼šè®¾$\phi(t)$æ˜¯$[a,b]$ä¸Šçš„å•è°ƒå…‰æ»‘å‡½æ•°ï¼Œä¸”$\phi'(t) \neq 0$ï¼Œåˆ™ï¼š</p>
<p>\begin{equation}
\left|\int_a^b e^{\text{i}\lambda\phi(t)} dt\right| \lesssim \frac{C}{|\lambda|}, \quad |\lambda| \to \infty
\tag{35}
\end{equation}</p>
<p>å…¶ä¸­$C$ä¾èµ–äº$\phi$çš„å¯¼æ•°ç•Œï¼Œä½†ä¸$\lambda$æ— å…³ã€‚</p>
<p><strong>åº”ç”¨åˆ°æˆ‘ä»¬çš„æƒ…å†µ</strong>ï¼šå–$\phi(t) = 10000^{-t}$ï¼Œè¿™æ˜¯å•è°ƒé€’å‡å‡½æ•°ï¼š</p>
<p>\begin{equation}
\phi'(t) = -\ln(10000) \cdot 10000^{-t} &lt; 0
\tag{36}
\end{equation}</p>
<p>å› æ­¤å½“$|\Delta| = |m-n|$å¢å¤§æ—¶ï¼Œç§¯åˆ†$I(\Delta)$ä¼šè¡°å‡ï¼</p>
<h4 id="_11">ç²¾ç¡®è®¡ç®—ä¸æ¸è¿‘å±•å¼€</h4>
<p>è®©æˆ‘ä»¬ç²¾ç¡®è®¡ç®—ç§¯åˆ†(34)ã€‚ä»¤$u = 10000^{-t}$ï¼Œåˆ™$t = -\log_{10000}(u) = -\frac{\ln u}{\ln 10000}$ï¼Œ$dt = -\frac{du}{u\ln 10000}$ï¼š</p>
<p>\begin{equation}
\begin{aligned}
I(\Delta) &amp;= \int_{10000}^{1} e^{\text{i}\Delta u} \cdot \left(-\frac{du}{u\ln 10000}\right) \
&amp;= \frac{1}{\ln 10000} \int_1^{10000} \frac{e^{\text{i}\Delta u}}{u} du
\end{aligned}
\tag{37}
\end{equation}</p>
<p>è¿™æ˜¯<strong>æŒ‡æ•°ç§¯åˆ†</strong>ï¼ˆExponential Integralï¼‰$\text{Ei}$çš„å˜ä½“ï¼å¯¹äºå¤§$|\Delta|$ï¼Œåˆ©ç”¨åˆ†éƒ¨ç§¯åˆ†ï¼š</p>
<p>\begin{equation}
\int_1^{10000} \frac{e^{\text{i}\Delta u}}{u} du = \left[\frac{e^{\text{i}\Delta u}}{\text{i}\Delta u}\right]_1^{10000} - \int_1^{10000} \frac{e^{\text{i}\Delta u}}{\text{i}\Delta u^2} du
\tag{38}
\end{equation}</p>
<p>ä¸»å¯¼é¡¹ï¼š</p>
<p>\begin{equation}
I(\Delta) \approx \frac{1}{\ln 10000} \cdot \frac{e^{\text{i}\Delta \cdot 10000} - e^{\text{i}\Delta}}{\text{i}\Delta} \cdot \frac{1}{10000}
\tag{39}
\end{equation}</p>
<p>æ¨¡é•¿ä¼°è®¡ï¼š</p>
<p>\begin{equation}
|I(\Delta)| \lesssim \frac{2}{\ln(10000) \cdot |\Delta|} = \frac{2}{9.21 |\Delta|} \approx \frac{0.22}{|\Delta|}
\tag{40}
\end{equation}</p>
<p><strong>ç»“è®º</strong>ï¼šå†…ç§¯ä»¥$\mathcal{O}(1/|\Delta|)$é€Ÿç‡è¡°å‡ï¼</p>
<h4 id="mathematica">Mathematicaæ•°å€¼éªŒè¯</h4>
<p>åŸæ–‡æä¾›çš„ä»£ç ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="err">Î¸</span><span class="p">[</span><span class="nv">t_</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">10000</span><span class="p">)</span><span class="o">^</span><span class="n">t</span><span class="p">;</span>
<span class="n">f</span><span class="p">[</span><span class="nv">x_</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Re</span><span class="p">[</span><span class="n">Integrate</span><span class="p">[</span><span class="n">Exp</span><span class="p">[</span><span class="n">I</span><span class="o">*</span><span class="n">x</span><span class="o">*</span><span class="err">Î¸</span><span class="p">[</span><span class="n">t</span><span class="p">]],</span><span class="w"> </span><span class="p">{</span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">}]];</span>
<span class="n">Plot</span><span class="p">[</span><span class="n">f</span><span class="p">[</span><span class="n">x</span><span class="p">],</span><span class="w"> </span><span class="p">{</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="mi">-128</span><span class="p">,</span><span class="w"> </span><span class="mi">128</span><span class="p">}]</span>
</code></pre></div>

<p>ç»˜åˆ¶çš„å›¾åƒæ˜¾ç¤ºï¼š
- <strong>çŸ­è·ç¦»</strong>ï¼ˆ$|m-n| &lt; 10$ï¼‰ï¼šå†…ç§¯æ¥è¿‘1ï¼ˆç›¸é‚»ä½ç½®å¼ºç›¸å…³ï¼‰
- <strong>ä¸­è·ç¦»</strong>ï¼ˆ$10 &lt; |m-n| &lt; 100$ï¼‰ï¼šå¿«é€Ÿè¡°å‡
- <strong>é•¿è·ç¦»</strong>ï¼ˆ$|m-n| &gt; 100$ï¼‰ï¼šæŒ¯è¡è¡°å‡ï¼Œå¹…åº¦$\sim 1/|m-n|$</p>
<h4 id="_12">ä¸å…¶ä»–é¢‘ç‡æ–¹æ¡ˆçš„å¯¹æ¯”</h4>
<p><strong>å¹‚å‡½æ•°</strong>ï¼š$\theta_i = i^{-\alpha}$ï¼Œå¯¹åº”ç§¯åˆ†ï¼š</p>
<p>\begin{equation}
I_{\text{power}}(\Delta) = \int_0^1 e^{\text{i}\Delta t^{-\alpha}} dt
\tag{41}
\end{equation}</p>
<ul>
<li>$\alpha = 1$ï¼šè¿‡å¿«è¡°å‡ï¼ŒçŸ­ç¨‹ä¾èµ–ä¸¢å¤±</li>
<li>$\alpha = 0.5$ï¼šä¸­ç­‰è¡°å‡</li>
<li>$\alpha = 2$ï¼šè¿‡æ…¢è¡°å‡ï¼Œé•¿ç¨‹å¹²æ‰°</li>
</ul>
<p><strong>æŒ‡æ•°å‡½æ•°</strong>ï¼ˆåŸå§‹æ–¹æ¡ˆï¼‰ï¼š$\theta_i = 10000^{-2i/d}$ï¼Œå¯¹åº”ï¼š</p>
<p>\begin{equation}
I_{\text{exp}}(\Delta) = \int_0^1 e^{\text{i}\Delta \cdot b^{-t}} dt, \quad b = 10000
\tag{42}
\end{equation}</p>
<p><strong>çº¿æ€§å‡½æ•°</strong>ï¼š$\theta_i = 1 - i/d$ï¼Œå¯¹åº”ï¼š</p>
<p>\begin{equation}
I_{\text{linear}}(\Delta) = \int_0^1 e^{\text{i}\Delta(1-t)} dt = e^{\text{i}\Delta} \cdot \frac{1 - e^{-\text{i}\Delta}}{\text{i}\Delta}
\tag{43}
\end{equation}</p>
<p>è¿™ä¼šå¯¼è‡´å†…ç§¯<strong>å‘¨æœŸæ€§å½’é›¶</strong>ï¼ˆå½“$\Delta = 2\pi k$æ—¶ï¼‰ï¼Œä¸ç¬¦åˆå•è°ƒè¡°å‡çš„ç›´è§‰ã€‚</p>
<p><strong>å¯¹æ¯”ç»“è®º</strong>ï¼š
- æŒ‡æ•°æ–¹æ¡ˆåœ¨çŸ­/ä¸­/é•¿è·ç¦»å–å¾—æœ€ä½³å¹³è¡¡
- å¹‚å‡½æ•°çŸ­è·ç¦»è¿‡æ¿€ï¼ŒæŒ‡æ•°å‡½æ•°é•¿è·ç¦»è¿‡å¼±
- çº¿æ€§æ–¹æ¡ˆæœ‰å‘¨æœŸæ€§é›¶ç‚¹ï¼Œä¸é€‚åˆ</p>
<h4 id="10000">åº•æ•°10000çš„é€‰æ‹©</h4>
<p>ä¸ºä»€ä¹ˆæ˜¯10000è€Œä¸æ˜¯1000æˆ–100000ï¼Ÿ</p>
<p><strong>é¢‘ç‡èŒƒå›´</strong>ï¼š$\theta_i \in [1, 10000^{-1}]$ï¼Œå¯¹åº”æ³¢é•¿èŒƒå›´$\lambda_i = 2\pi/\theta_i \in [2\pi, 2\pi \cdot 10000]$ã€‚</p>
<ul>
<li>æœ€çŸ­æ³¢é•¿ï¼š$\lambda_0 \approx 6.28$ï¼ˆæ•æ‰ç›¸é‚»è¯ï¼‰</li>
<li>æœ€é•¿æ³¢é•¿ï¼š$\lambda_{d/2-1} \approx 62800$ï¼ˆæ•æ‰å¥å­çº§ç»“æ„ï¼‰</li>
</ul>
<p>å¯¹äºå…¸å‹çš„åºåˆ—é•¿åº¦$L = 512$ï¼ˆBERTï¼‰æˆ–$L = 2048$ï¼ˆGPTï¼‰ï¼Œéœ€è¦æ³¢é•¿è¦†ç›–$[1, L]$ï¼š</p>
<p>\begin{equation}
10000^{2/d} \geq \frac{L_{\max}}{2\pi} \quad \Rightarrow \quad 10000 \geq \left(\frac{L_{\max}}{2\pi}\right)^{d/2}
\tag{44}
\end{equation}</p>
<p>å¯¹äº$d=512$ï¼Œ$L_{\max}=2048$ï¼š</p>
<p>\begin{equation}
10000 \geq (326)^{256} \quad \text{ï¼ˆæ˜¾ç„¶ä¸æˆç«‹ï¼ï¼‰}
\tag{45}
\end{equation}</p>
<p>å®é™…ä¸Šï¼Œ<strong>10000æ˜¯ç»éªŒé€‰æ‹©</strong>ï¼Œå¹¶éä¸¥æ ¼ä¼˜åŒ–çš„ç»“æœã€‚å…¶ä»–åˆç†é€‰æ‹©ï¼š
- $b = 1000$ï¼šæ›´å¿«è¡°å‡ï¼Œé€‚åˆçŸ­æ–‡æœ¬
- $b = 100000$ï¼šæ›´æ…¢è¡°å‡ï¼Œé€‚åˆè¶…é•¿æ–‡æœ¬
- <strong>å¯è®­ç»ƒåº•æ•°</strong>ï¼šå°†$b$ä½œä¸ºè¶…å‚æ•°å¾®è°ƒ</p>
<h3 id="24-hessian">2.4 HessiançŸ©é˜µçš„ä¸€èˆ¬æƒ…å†µ</h3>
<p>å‰é¢ä¸¤èŠ‚ä¸­ï¼Œæˆ‘ä»¬å±•ç¤ºäº†é€šè¿‡ç»å¯¹ä½ç½®ç¼–ç æ¥è¡¨è¾¾ç›¸å¯¹ä½ç½®ä¿¡æ¯çš„æ€æƒ³ï¼ŒåŠ ä¸Šè¿œç¨‹è¡°å‡çš„çº¦æŸï¼Œå¯ä»¥â€œåæ¨â€å‡ºSinusoidalä½ç½®ç¼–ç ï¼Œå¹¶ä¸”ç»™å‡ºäº†å…³äº$\theta_i$çš„å…¶ä»–é€‰æ‹©ã€‚ä½†æ˜¯åˆ«å¿˜äº†ï¼Œåˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬çš„æ¨å¯¼éƒ½æ˜¯åŸºäº$\boldsymbol{\mathcal{H}}=\boldsymbol{I}$è¿™ä¸ªç®€å•æƒ…å†µçš„ï¼Œå¯¹äºä¸€èˆ¬çš„$\boldsymbol{\mathcal{H}}$ï¼Œä½¿ç”¨ä¸Šè¿°Sinusoidalä½ç½®ç¼–ç ï¼Œè¿˜èƒ½å…·å¤‡ä»¥ä¸Šçš„è‰¯å¥½æ€§è´¨å—ï¼Ÿ</p>
<p>å¦‚æœ$\boldsymbol{\mathcal{H}}$æ˜¯ä¸€ä¸ªå¯¹è§’é˜µï¼Œé‚£ä¹ˆä¸Šé¢çš„å„ä¸ªæ€§è´¨å¯ä»¥å¾—åˆ°ä¸€å®šçš„ä¿ç•™ï¼Œæ­¤æ—¶<br />
\begin{equation}\boldsymbol{p}<em i="1">m^{\top} \boldsymbol{\mathcal{H}} \boldsymbol{p}_n=\sum</em>}^{d/2} \boldsymbol{\mathcal{H}<em 2i_1_2i_1="2i+1,2i+1">{2i,2i} \cos m\theta_i \cos n\theta_i + \boldsymbol{\mathcal{H}}</em>} \sin m\theta_i \sin n\theta_i\end{equation<br />
ç”±ç§¯åŒ–å’Œå·®å…¬å¼å¾—åˆ°<br />
\begin{equation}\sum_{i=1}^{d/2} \frac{1}{2}\left(\boldsymbol{\mathcal{H}}<em 2i_1_2i_1="2i+1,2i+1">{2i,2i} + \boldsymbol{\mathcal{H}}</em>}\right) \cos (m-n)\theta_i + \frac{1}{2}\left(\boldsymbol{\mathcal{H}<em 2i_1_2i_1="2i+1,2i+1">{2i,2i} - \boldsymbol{\mathcal{H}}</em>}\right) \cos (m+n)\theta_i \end{equation<br />
å¯ä»¥çœ‹åˆ°å®ƒä¹Ÿæ˜¯ç¡®å®åŒ…å«äº†ç›¸å¯¹ä½ç½®$m-n$ï¼Œåªä¸è¿‡å¯èƒ½ä¼šå¤šå‡º$m+n$è¿™ä¸€é¡¹ï¼Œå¦‚æœä¸éœ€è¦å®ƒï¼Œæ¨¡å‹å¯ä»¥è®©$\boldsymbol{\mathcal{H}}<em 2i_1_2i_1="2i+1,2i+1">{2i,2i} = \boldsymbol{\mathcal{H}}</em>$æ¥æ¶ˆé™¤å®ƒã€‚åœ¨è¿™ä¸ªç‰¹ä¾‹ä¸‹ï¼Œæˆ‘ä»¬æŒ‡å‡ºçš„æ˜¯Sinusoidalä½ç½®ç¼–ç èµ‹äºˆäº†æ¨¡å‹å­¦ä¹ ç›¸å¯¹ä½ç½®çš„å¯èƒ½ï¼Œè‡³äºå…·ä½“éœ€è¦ä»€ä¹ˆä½ç½®ä¿¡æ¯ï¼Œåˆ™ç”±æ¨¡å‹çš„è®­ç»ƒè‡ªè¡Œå†³å®šã€‚</p>
<p>ç‰¹åˆ«åœ°ï¼Œå¯¹äºä¸Šå¼ï¼Œè¿œç¨‹è¡°å‡ç‰¹æ€§ä¾ç„¶å­˜åœ¨ï¼Œæ¯”å¦‚ç¬¬ä¸€é¡¹æ±‚å’Œï¼Œç±»æ¯”å‰ä¸€èŠ‚çš„è¿‘ä¼¼ï¼Œå®ƒç›¸å½“äºç§¯åˆ†<br />
\begin{equation}\sum_{i=1}^{d/2} \frac{1}{2}\left(\boldsymbol{\mathcal{H}}<em 2i_1_2i_1="2i+1,2i+1">{2i,2i} + \boldsymbol{\mathcal{H}}</em>}\right) \cos (m-n)\theta_i \sim \int_0^1 h_t e^{\text{i}(m-n)\theta_t}dt\end{equation<br />
åŒæ ·åœ°ï¼ŒæŒ¯è¡ç§¯åˆ†çš„ä¸€äº›ä¼°è®¡ç»“æœï¼ˆå‚è€ƒ<a href="https://www.math.ucla.edu/~tao/247b.1.07w/notes8.pdf">ã€ŠOscillatory integralsã€‹</a>ã€<a href="https://zhuanlan.zhihu.com/p/60610509">ã€Šå­¦ä¹ ç¬”è®°3-ä¸€ç»´æŒ¯è¡ç§¯åˆ†ä¸åº”ç”¨ã€‹</a>ç­‰ï¼‰å‘Šè¯‰æˆ‘ä»¬ï¼Œè¯¥æŒ¯è¡ç§¯åˆ†åœ¨æ¯”è¾ƒå®¹æ˜“è¾¾åˆ°çš„æ¡ä»¶ä¸‹ï¼Œæœ‰$|m-n|\to\infty$æ—¶ç§¯åˆ†å€¼è¶‹äºé›¶ï¼Œå› æ­¤è¿œç¨‹è¡°å‡ç‰¹æ€§æ˜¯å¯ä»¥å¾—åˆ°ä¿ç•™çš„ã€‚</p>
<p>å¦‚æœ$\boldsymbol{\mathcal{H}}$ä¸æ˜¯å¯¹è§’é˜µï¼Œé‚£ä¹ˆå¾ˆé—æ†¾ï¼Œä¸Šè¿°æ€§è´¨éƒ½å¾ˆéš¾é‡ç°çš„ã€‚æˆ‘ä»¬åªèƒ½å¯„æœ›äº$\boldsymbol{\mathcal{H}}$çš„å¯¹è§’çº¿éƒ¨åˆ†å äº†ä¸»é¡¹ï¼Œè¿™æ ·ä¸€æ¥ä¸Šè¿°çš„æ€§è´¨è¿˜èƒ½è¿‘ä¼¼ä¿ç•™ã€‚å¯¹è§’çº¿éƒ¨åˆ†å ä¸»é¡¹ï¼Œæ„å‘³ç€$d$ç»´å‘é‡ä¹‹é—´ä»»æ„ä¸¤ä¸ªç»´åº¦çš„ç›¸å…³æ€§æ¯”è¾ƒå°ï¼Œæ»¡è¶³ä¸€å®šçš„è§£è€¦æ€§ã€‚å¯¹äºEmbeddingå±‚æ¥è¯´ï¼Œè¿™ä¸ªå‡è®¾è¿˜æ˜¯æœ‰ä¸€å®šçš„åˆç†æ€§çš„ï¼Œç¬”è€…æ£€éªŒäº†BERTè®­ç»ƒå‡ºæ¥çš„è¯EmbeddingçŸ©é˜µå’Œä½ç½®EmbeddingçŸ©é˜µçš„åæ–¹å·®çŸ©é˜µï¼Œå‘ç°å¯¹è§’çº¿å…ƒç´ æ˜æ˜¾æ¯”éå¯¹è§’çº¿å…ƒç´ å¤§ï¼Œè¯æ˜äº†å¯¹è§’çº¿å…ƒç´ å ä¸»é¡¹è¿™ä¸ªå‡è®¾å…·æœ‰ä¸€å®šçš„åˆç†æ€§ã€‚</p>
<h2 id="_13">é—®é¢˜è®¨è®º</h2>
<p>æœ‰è¯»è€…ä¼šåé©³ï¼šå°±ç®—ä½ æŠŠSinusoidalä½ç½®ç¼–ç è¯´å¾—æ— ä¸ä¼¦æ¯”ï¼Œä¹Ÿæ”¹å˜ä¸äº†ç›´æ¥è®­ç»ƒçš„ä½ç½®ç¼–ç æ¯”Sinusoidalä½ç½®ç¼–ç æ•ˆæœè¦å¥½çš„äº‹å®ã€‚çš„ç¡®ï¼Œæœ‰å®éªŒè¡¨æ˜ï¼Œåœ¨åƒBERTè¿™æ ·çš„ç»è¿‡å……åˆ†é¢„è®­ç»ƒçš„Transformeræ¨¡å‹ä¸­ï¼Œç›´æ¥è®­ç»ƒçš„ä½ç½®ç¼–ç æ•ˆæœæ˜¯è¦æ¯”Sinusoidalä½ç½®ç¼–ç å¥½äº›ï¼Œè¿™ä¸ªå¹¶ä¸å¦è®¤ã€‚æœ¬æ–‡è¦åšçš„äº‹æƒ…ï¼Œåªæ˜¯ä»ä¸€äº›åŸç†å’Œå‡è®¾å‡ºå‘ï¼Œæ¨å¯¼Sinusoidalä½ç½®ç¼–ç ä¸ºä»€ä¹ˆå¯ä»¥ä½œä¸ºä¸€ä¸ªæœ‰æ•ˆçš„ä½ç½®ï¼Œä½†å¹¶ä¸æ˜¯è¯´å®ƒä¸€å®šå°±æ˜¯æœ€å¥½çš„ä½ç½®ç¼–ç ã€‚</p>
<p>æ¨å¯¼æ˜¯åŸºäºä¸€äº›å‡è®¾çš„ï¼Œå¦‚æœæ¨å¯¼å‡ºæ¥çš„ç»“æœä¸å¤Ÿå¥½ï¼Œé‚£ä¹ˆå°±æ„å‘³ç€å‡è®¾ä¸å®é™…æƒ…å†µä¸å¤Ÿç¬¦åˆã€‚é‚£ä¹ˆï¼Œå¯¹äºSinusoidalä½ç½®ç¼–ç æ¥è¯´ï¼Œé—®é¢˜å¯èƒ½å‡ºç°åœ¨å“ªå‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥é€æ­¥æ¥åæ€ä¸€ä¸‹ã€‚</p>
<p>ç¬¬ä¸€æ­¥ï¼Œæ³°å‹’å±•å¼€ï¼Œè¿™ä¸ªä¾èµ–äº$\boldsymbol{p}$æ˜¯å°é‡ï¼Œç¬”è€…ä¹Ÿåœ¨BERTä¸­åšäº†æ£€éªŒï¼Œå‘ç°è¯Embeddingçš„å¹³å‡æ¨¡é•¿è¦æ¯”ä½ç½®Embeddingçš„å¹³å‡æ¨¡é•¿å¤§ï¼Œè¿™è¯´æ˜$\boldsymbol{p}$æ˜¯å°é‡æŸç§ç¨‹åº¦ä¸Šæ˜¯åˆç†çš„ï¼Œä½†æ˜¯å¤šåˆç†ä¹Ÿè¯´ä¸å‡†ï¼Œå› ä¸ºEmbeddingæ¨¡é•¿è™½ç„¶æ›´å¤§ä½†ä¹Ÿæ²¡å‹å€’æ€§ï¼›ç¬¬äºŒæ­¥ï¼Œå‡è®¾$\boldsymbol{\mathcal{H}}$æ˜¯å•ä½é˜µï¼Œå› ä¸ºä¸Šä¸€èŠ‚æˆ‘ä»¬åˆ†æäº†å®ƒå¾ˆå¯èƒ½æ˜¯å¯¹è§’çº¿å ä¸»é¡¹çš„ï¼Œæ‰€ä»¥å…ˆå‡è®¾å•ä½é˜µå¯èƒ½ä¹Ÿä¸æ˜¯å¤ªå¤§çš„é—®é¢˜ï¼›ç¬¬ä¸‰æ­¥ï¼Œå‡è®¾é€šè¿‡ä¸¤ä¸ªç»å¯¹ä½ç½®å‘é‡çš„å†…ç§¯æ¥è¡¨è¾¾ç›¸å¯¹ä½ç½®ï¼Œè¿™ä¸ªç›´è§‰ä¸Šå‘Šè¯‰æˆ‘ä»¬åº”è¯¥æ˜¯åˆç†çš„ï¼Œç»å¯¹ä½ç½®çš„ç›¸äº’åº”å½“æœ‰èƒ½åŠ›è¡¨è¾¾ä¸€å®šç¨‹åº¦çš„ç›¸å¯¹ä½ç½®ä¿¡æ¯ï¼›æœ€åä¸€æ­¥ï¼Œé€šè¿‡è‡ªåŠ¨è¿œç¨‹è¡°å‡çš„ç‰¹æ€§æ¥ç¡®å®š$\theta_i$ï¼Œè¿™ä¸ªæœ¬èº«åº”è¯¥ä¹Ÿæ˜¯å¥½çš„ï¼Œä½†å°±æ˜¯è¿™ä¸€æ­¥å˜æ•°å¤ªå¤§ï¼Œå› ä¸ºå¯é€‰çš„$\theta_i$å½¢å¼å¤ªå¤šï¼Œç”šè‡³è¿˜æœ‰å¯è®­ç»ƒçš„$\theta_i$ï¼Œå¾ˆéš¾æŒ‘å‡ºæœ€åˆç†çš„ï¼Œå› æ­¤å¦‚æœè¯´Sinusoidalä½ç½®ç¼–ç ä¸å¤Ÿå¥½ï¼Œè¿™ä¸€æ­¥ä¹Ÿéå¸¸å€¼å¾—åæ€ã€‚</p>
<h2 id="_14">æ–‡ç« å°ç»“</h2>
<p>æ€»çš„æ¥è¯´ï¼Œæœ¬æ–‡è¯•å›¾åŸºäºä¸€äº›å‡è®¾ï¼Œåæ¨å‡ºSinusoidalä½ç½®ç¼–ç æ¥ï¼Œè¿™äº›å‡è®¾å…·æœ‰å…¶ä¸€å®šçš„åˆç†æ€§ï¼Œä¹Ÿæœ‰ä¸€å®šçš„é—®é¢˜ï¼Œæ‰€ä»¥ç›¸åº”çš„Sinusoidalä½ç½®ç¼–ç å¯åœˆå¯ç‚¹ï¼Œä½†å¹¶éæ¯«æ— ç‘•ç–µã€‚ä½†ä¸ç®¡æ€æ ·ï¼Œåœ¨å½“å‰çš„æ·±åº¦å­¦ä¹ ä¸­ï¼Œèƒ½å¤Ÿé’ˆå¯¹å…·ä½“çš„é—®é¢˜å¾—åˆ°ä¸€ä¸ªæ˜¾å¼è§£ï¼Œè€Œä¸æ˜¯ç›´æ¥æš´åŠ›æ‹Ÿåˆï¼ŒSinusoidalä½ç½®ç¼–ç æ˜¯ä¸€ä¸ªä¸å¯å¤šå¾—çš„æ¡ˆä¾‹ï¼Œå€¼å¾—æˆ‘ä»¬æ€è€ƒå›å‘³ã€‚</p>
<p><em><strong>è½¬è½½åˆ°è¯·åŒ…æ‹¬æœ¬æ–‡åœ°å€ï¼š</strong><a href="https://spaces.ac.cn/archives/8231">https://spaces.ac.cn/archives/8231</a></em></p>
<p><em><strong>æ›´è¯¦ç»†çš„è½¬è½½äº‹å®œè¯·å‚è€ƒï¼š</strong></em><a href="https://spaces.ac.cn/archives/6508#%E6%96%87%E7%AB%A0%E5%A6%82%E4%BD%95%E8%BD%AC%E8%BD%BD/%E5%BC%95%E7%94%A8" title="ã€Šç§‘å­¦ç©ºé—´FAQã€‹">ã€Šç§‘å­¦ç©ºé—´FAQã€‹</a></p>
<p><strong>å¦‚æœæ‚¨è¿˜æœ‰ä»€ä¹ˆç–‘æƒ‘æˆ–å»ºè®®ï¼Œæ¬¢è¿åœ¨ä¸‹æ–¹è¯„è®ºåŒºç»§ç»­è®¨è®ºã€‚</strong></p>
<p><strong>å¦‚æœæ‚¨è§‰å¾—æœ¬æ–‡è¿˜ä¸é”™ï¼Œæ¬¢è¿åˆ†äº«/æ‰“èµæœ¬æ–‡ã€‚æ‰“èµå¹¶éè¦ä»ä¸­è·å¾—æ”¶ç›Šï¼Œè€Œæ˜¯å¸Œæœ›çŸ¥é“ç§‘å­¦ç©ºé—´è·å¾—äº†å¤šå°‘è¯»è€…çš„çœŸå¿ƒå…³æ³¨ã€‚å½“ç„¶ï¼Œå¦‚æœä½ æ— è§†å®ƒï¼Œä¹Ÿä¸ä¼šå½±å“ä½ çš„é˜…è¯»ã€‚å†æ¬¡è¡¨ç¤ºæ¬¢è¿å’Œæ„Ÿè°¢ï¼</strong></p>
<p>æ‰“èµ</p>
<p><img alt="ç§‘å­¦ç©ºé—´" src="https://spaces.ac.cn/usr/themes/geekg/payment/wx.png" /></p>
<p>å¾®ä¿¡æ‰“èµ</p>
<p><img alt="ç§‘å­¦ç©ºé—´" src="https://spaces.ac.cn/usr/themes/geekg/payment/zfb.png" /></p>
<p>æ”¯ä»˜å®æ‰“èµ</p>
<p>å› ä¸ºç½‘ç«™åå°å¯¹æ‰“èµå¹¶æ— è®°å½•ï¼Œå› æ­¤æ¬¢è¿åœ¨æ‰“èµæ—¶å€™å¤‡æ³¨ç•™è¨€ã€‚ä½ è¿˜å¯ä»¥<a href="http://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&amp;email=tN7d1drY3drrx8H0xcWa19vZ"><strong>ç‚¹å‡»è¿™é‡Œ</strong></a>æˆ–åœ¨ä¸‹æ–¹è¯„è®ºåŒºç•™è¨€æ¥å‘ŠçŸ¥ä½ çš„å»ºè®®æˆ–éœ€æ±‚ã€‚</p>
<p><strong>å¦‚æœæ‚¨éœ€è¦å¼•ç”¨æœ¬æ–‡ï¼Œè¯·å‚è€ƒï¼š</strong></p>
<p>è‹å‰‘æ—. (Mar. 08, 2021). ã€ŠTransformerå‡çº§ä¹‹è·¯ï¼š1ã€Sinusoidalä½ç½®ç¼–ç è¿½æ ¹æº¯æº ã€‹[Blog post]. Retrieved from <a href="https://spaces.ac.cn/archives/8231">https://spaces.ac.cn/archives/8231</a></p>
<p>@online{kexuefm-8231,<br />
title={Transformerå‡çº§ä¹‹è·¯ï¼š1ã€Sinusoidalä½ç½®ç¼–ç è¿½æ ¹æº¯æº},<br />
author={è‹å‰‘æ—},<br />
year={2021},<br />
month={Mar},<br />
url={\url{https://spaces.ac.cn/archives/8231}},<br />
} </p>
<hr />
<h2 id="3">ç¬¬3éƒ¨åˆ†ï¼šç›´è§‰ç†è§£ä¸å¯è§†åŒ–</h2>
<h3 id="31">3.1 å•ä½åœ†ä¸Šçš„æ—‹è½¬</h3>
<p><strong>ç±»æ¯”1ï¼šæ—¶é’ŸæŒ‡é’ˆ</strong></p>
<p>æƒ³è±¡ä¸€ä¸ªé’Ÿè¡¨ï¼Œæ—¶é’ˆã€åˆ†é’ˆã€ç§’é’ˆä»¥ä¸åŒçš„è§’é€Ÿåº¦æ—‹è½¬ã€‚Sinusoidalä½ç½®ç¼–ç æ­£æ˜¯å¦‚æ­¤ï¼š</p>
<ul>
<li><strong>ç»´åº¦0-1</strong>ï¼ˆé«˜é¢‘ï¼‰ï¼šå¦‚ç§’é’ˆï¼Œæ¯ä¸ªä½ç½®å¿«é€Ÿæ—‹è½¬ï¼Œæ•æ‰ç›¸é‚»token</li>
<li><strong>ç»´åº¦2-3</strong>ï¼ˆä¸­é¢‘ï¼‰ï¼šå¦‚åˆ†é’ˆï¼Œä¸­ç­‰é€Ÿåº¦ï¼Œæ•æ‰çŸ­è¯­çº§åˆ«</li>
<li><strong>ç»´åº¦510-511</strong>ï¼ˆä½é¢‘ï¼‰ï¼šå¦‚æ—¶é’ˆï¼Œç¼“æ…¢æ—‹è½¬ï¼Œæ•æ‰å¥å­ç»“æ„</li>
</ul>
<p>\begin{equation}
\boldsymbol{p}_m^{(i)} = \begin{pmatrix}\cos(m/10000^{2i/d}) \ \sin(m/10000^{2i/d})\end{pmatrix} \quad \text{ï¼ˆç¬¬$i$å¯¹ç»´åº¦ï¼Œå•ä½åœ†ä¸Šçš„ç‚¹ï¼‰}
\tag{46}
\end{equation}</p>
<p><strong>å‡ ä½•æ„ä¹‰</strong>ï¼š
- ä½ç½®$m=0$ï¼šæ‰€æœ‰ç»´åº¦éƒ½æŒ‡å‘å®è½´æ­£æ–¹å‘$(1, 0)$
- ä½ç½®$m=1$ï¼šå„ç»´åº¦æ—‹è½¬ä¸åŒè§’åº¦$\theta_i$
- ç›¸å¯¹ä½ç½®$m-n$ï¼šå¯¹åº”æ—‹è½¬è§’åº¦å·®$\theta_i(m-n)$</p>
<h3 id="32">3.2 é¢‘è°±è§†è§’ï¼šå°æ³¢å˜æ¢</h3>
<p>ä¿¡å·å¤„ç†ä¸­ï¼Œ<strong>å°æ³¢å˜æ¢</strong>ï¼ˆWavelet Transformï¼‰ç”¨å¤šå°ºåº¦åŸºå‡½æ•°åˆ†è§£ä¿¡å·ã€‚Sinusoidalç¼–ç ç±»ä¼¼ï¼š</p>
<p>\begin{equation}
\text{Signal: } x(t) \leftrightarrow \text{Position: } m, \quad \text{Wavelets: } \psi_{a,b}(t) \leftrightarrow \text{Bases: } (\cos(m\theta_i), \sin(m\theta_i))
\tag{47}
\end{equation}</p>
<p><strong>é¢‘ç‡åˆ†è§£</strong>ï¼š</p>
<table>
<thead>
<tr>
<th>ç»´åº¦å¯¹</th>
<th>é¢‘ç‡$\theta_i$</th>
<th>å‘¨æœŸ$T_i = 2\pi/\theta_i$</th>
<th>æ•æ‰èŒƒå›´</th>
</tr>
</thead>
<tbody>
<tr>
<td>0-1</td>
<td>1.0</td>
<td>6.28</td>
<td>1-6 tokens</td>
</tr>
<tr>
<td>128-129</td>
<td>$10^{-2}$</td>
<td>628</td>
<td>10-600 tokens</td>
</tr>
<tr>
<td>255-256</td>
<td>$10^{-4}$</td>
<td>62,800</td>
<td>å…¨å±€ç»“æ„</td>
</tr>
</tbody>
</table>
<p><strong>ç±»æ¯”Fourierçº§æ•°</strong>ï¼šä»»æ„å‘¨æœŸå‡½æ•°å¯å±•å¼€ä¸º$\sum_k (a_k\cos(k\omega t) + b_k\sin(k\omega t))$ï¼Œä½ç½®ç¼–ç ç±»ä¼¼åœ°ç”¨å¤šé¢‘ç‡ä¸‰è§’å‡½æ•°è¡¨è¾¾ä½ç½®ã€‚</p>
<h3 id="33">3.3 ç‰©ç†ç±»æ¯”ï¼šé˜»å°¼æŒ¯è¡</h3>
<p>è¿œç¨‹è¡°å‡ç±»ä¼¼ç‰©ç†ä¸­çš„<strong>é˜»å°¼è°æŒ¯å­</strong>ã€‚è€ƒè™‘å¤šä¸ªè€¦åˆæŒ¯å­ç³»ç»Ÿï¼š</p>
<p>\begin{equation}
\begin{cases}
\ddot{x}_i + \omega_i^2 x_i = 0 &amp; \text{ï¼ˆè‡ªç”±æŒ¯è¡ï¼‰} \
\langle x_i(t_1), x_j(t_2) \rangle \sim \cos(\omega(t_1 - t_2)) &amp; \text{ï¼ˆç›¸å…³æ€§ï¼‰}
\end{cases}
\tag{48}
\end{equation}</p>
<p>å½“ç³»ç»Ÿæœ‰å¤šä¸ªé¢‘ç‡${\omega_i}$æ—¶ï¼Œæ€»ç›¸å…³æ€§ï¼š</p>
<p>\begin{equation}
C(t_1, t_2) = \sum_i A_i \cos(\omega_i(t_1 - t_2))
\tag{49}
\end{equation}</p>
<p>å¤šé¢‘å åŠ å¯¼è‡´<strong>å¹²æ¶‰</strong>ï¼Œè¿œè·ç¦»æ—¶ä¸åŒé¢‘ç‡ç›¸æ¶ˆï¼Œäº§ç”Ÿè¡°å‡ï¼</p>
<p><strong>é‡å­åŠ›å­¦ç±»æ¯”</strong>ï¼šç±»ä¼¼Feynmanè·¯å¾„ç§¯åˆ†ä¸­çš„ç›¸ä½å åŠ ï¼Œä¸åŒè·¯å¾„çš„ç›¸ä½åœ¨è¿œå¤„ç›¸äº’æŠµæ¶ˆï¼ˆdestructive interferenceï¼‰ã€‚</p>
<h3 id="34">3.4 ä¿¡æ¯è®ºè§†è§’ï¼šæœ€å¤§ç†µç¼–ç </h3>
<p><strong>é—®é¢˜</strong>ï¼šåœ¨å›ºå®šç»´åº¦$d$ä¸‹ï¼Œå¦‚ä½•è®¾è®¡ä½ç½®ç¼–ç ä½¿å…¶æºå¸¦æœ€å¤§ä¿¡æ¯é‡ï¼Ÿ</p>
<p><strong>çº¦æŸ</strong>ï¼š
1. æœ‰ç•Œï¼š$|\boldsymbol{p}_m|_2 = O(1)$ï¼ˆé¿å…æ¢¯åº¦çˆ†ç‚¸ï¼‰
2. åŒºåˆ†æ€§ï¼š$\boldsymbol{p}_m \neq \boldsymbol{p}_n$ for $m \neq n$ï¼ˆä½ç½®å¯åŒºåˆ†ï¼‰
3. å…‰æ»‘æ€§ï¼š$\boldsymbol{p}_m$å…³äº$m$å¯å¾®ï¼ˆæ”¯æŒæ’å€¼ï¼‰</p>
<p><strong>å®šç†3ï¼ˆéæ­£å¼ï¼‰</strong>ï¼šåœ¨ä¸Šè¿°çº¦æŸä¸‹ï¼Œä¸‰è§’å‡½æ•°åŸºæ˜¯<strong>è¿‘ä¼¼æœ€ä¼˜</strong>çš„ï¼Œå› ä¸ºï¼š
- <strong>æ­£äº¤æ€§</strong>ï¼šä¸åŒé¢‘ç‡çš„$\sin/\cos$æ­£äº¤ï¼Œä¿¡æ¯æ— å†—ä½™
- <strong>å®Œå¤‡æ€§</strong>ï¼šFourieråŸºå¯ä»¥é€¼è¿‘ä»»æ„$L^2$å‡½æ•°
- <strong>ç´§æ”¯æ’‘</strong>ï¼šæ¯ä¸ªç»´åº¦çš„å€¼åŸŸ$[-1, 1]$ï¼Œæ–¹å·®æœ€å¤§åŒ–</p>
<h3 id="35">3.5 å¯è§†åŒ–ç¤ºä¾‹</h3>
<h4 id="t-sne">t-SNEé™ç»´å¯è§†åŒ–</h4>
<p>å°†512ç»´ä½ç½®ç¼–ç é™ç»´åˆ°2Dï¼Œè§‚å¯Ÿå…¶æµå½¢ç»“æ„ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.manifold</span><span class="w"> </span><span class="kn">import</span> <span class="n">TSNE</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="k">def</span><span class="w"> </span><span class="nf">sinusoidal_pos_encoding</span><span class="p">(</span><span class="n">max_len</span><span class="p">,</span> <span class="n">d_model</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="mi">10000</span><span class="p">):</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">max_len</span><span class="p">)[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">d_model</span><span class="p">)[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">angle_rates</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span> <span class="o">//</span> <span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="n">d_model</span><span class="p">)</span>
    <span class="n">angle_rads</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">*</span> <span class="n">angle_rates</span>

    <span class="c1"># å¶æ•°ç»´cosï¼Œå¥‡æ•°ç»´sin</span>
    <span class="n">angle_rads</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angle_rads</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">::</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">angle_rads</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angle_rads</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">angle_rads</span>

<span class="c1"># ç”Ÿæˆ0-127ä½ç½®çš„ç¼–ç </span>
<span class="n">PE</span> <span class="o">=</span> <span class="n">sinusoidal_pos_encoding</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">512</span><span class="p">)</span>

<span class="c1"># t-SNEé™ç»´</span>
<span class="n">tsne</span> <span class="o">=</span> <span class="n">TSNE</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="n">PE_2d</span> <span class="o">=</span> <span class="n">tsne</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">PE</span><span class="p">)</span>

<span class="c1"># å¯è§†åŒ–ï¼ˆé¢œè‰²è¡¨ç¤ºä½ç½®ï¼‰</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">PE_2d</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">PE_2d</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">128</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Position&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;t-SNE of Sinusoidal Position Embeddings&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>

<p><strong>è§‚å¯Ÿ</strong>ï¼šä½ç½®ç¼–ç åœ¨2Då¹³é¢å‘ˆèºæ—‹æˆ–åŒå¿ƒåœ†ç»“æ„ï¼Œç›¸é‚»ä½ç½®èšé›†ï¼Œè¿œè·ç¦»ä½ç½®åˆ†æ•£ã€‚</p>
<h4 id="_15">å†…ç§¯çƒ­åŠ›å›¾</h4>
<p>ç»˜åˆ¶$\langle \boldsymbol{p}_i, \boldsymbol{p}_j \rangle$çš„çƒ­åŠ›å›¾ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>

<span class="n">PE</span> <span class="o">=</span> <span class="n">sinusoidal_pos_encoding</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">)</span>
<span class="n">similarity_matrix</span> <span class="o">=</span> <span class="n">PE</span> <span class="o">@</span> <span class="n">PE</span><span class="o">.</span><span class="n">T</span>  <span class="c1"># 64x64å†…ç§¯çŸ©é˜µ</span>

<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">similarity_matrix</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;RdBu_r&#39;</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">xticklabels</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">yticklabels</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Position Encoding Inner Product Matrix&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Position j&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Position i&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>

<p><strong>è§‚å¯Ÿ</strong>ï¼š
- å¯¹è§’çº¿æ¥è¿‘1ï¼ˆè‡ªèº«ç›¸ä¼¼ï¼‰
- å¹³è¡Œäºå¯¹è§’çº¿çš„æ¡çº¹ï¼ˆç›¸å¯¹ä½ç½®ç›¸ä¼¼ï¼‰
- è¿œç¦»å¯¹è§’çº¿é€æ¸è¡°å‡è‡³0ï¼ˆè¿œç¨‹è¡°å‡ï¼‰</p>
<h3 id="36-rope">3.6 ä¸RoPEçš„å¯¹æ¯”</h3>
<p><strong>RoPEï¼ˆRotary Position Embeddingï¼‰</strong> é€šè¿‡æ—‹è½¬çŸ©é˜µå®ç°ç›¸å¯¹ä½ç½®ï¼š</p>
<p>\begin{equation}
\begin{pmatrix}q_m' \ k_n'\end{pmatrix} = \begin{pmatrix}\cos(m\theta) &amp; -\sin(m\theta) \ \sin(m\theta) &amp; \cos(m\theta)\end{pmatrix} \begin{pmatrix}q \ k\end{pmatrix}
\tag{50}
\end{equation}</p>
<p>å†…ç§¯ï¼š</p>
<p>\begin{equation}
\langle q_m', k_n' \rangle = \langle q, k \rangle \cos((m-n)\theta)
\tag{51}
\end{equation}</p>
<p><strong>å¯¹æ¯”</strong>ï¼š</p>
<table>
<thead>
<tr>
<th>ç‰¹æ€§</th>
<th>Sinusoidal</th>
<th>RoPE</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>å®ç°</strong></td>
<td>åŠ æ³•$\boldsymbol{x} + \boldsymbol{p}$</td>
<td>æ—‹è½¬$\boldsymbol{Rx}$</td>
</tr>
<tr>
<td><strong>ç›¸å¯¹ä½ç½®</strong></td>
<td>éšå¼ï¼ˆé€šè¿‡å†…ç§¯ï¼‰</td>
<td>æ˜¾å¼ï¼ˆä¹˜æ³•å¯äº¤æ¢ï¼‰</td>
</tr>
<tr>
<td><strong>å¤–æ¨æ€§</strong></td>
<td>ä¸­ç­‰</td>
<td>ä¼˜ç§€ï¼ˆå¹³ç§»ä¸å˜ï¼‰</td>
</tr>
<tr>
<td><strong>è®¡ç®—æ•ˆç‡</strong></td>
<td>é«˜ï¼ˆé¢„è®¡ç®—ï¼‰</td>
<td>ä¸­ç­‰ï¼ˆåœ¨çº¿æ—‹è½¬ï¼‰</td>
</tr>
</tbody>
</table>
<p>RoPEçš„ä¼˜åŠ¿åœ¨äº<strong>æ˜¾å¼ç¼–ç ç›¸å¯¹ä½ç½®</strong>ï¼Œä¸ä¾èµ–æ³°å‹’å±•å¼€å‡è®¾ï¼Œå› æ­¤åœ¨é•¿åºåˆ—å¤–æ¨ä¸­è¡¨ç°æ›´å¥½ã€‚</p>
<h2 id="4">ç¬¬4éƒ¨åˆ†ï¼šæ‰¹åˆ¤æ€§åˆ†æä¸å±€é™æ€§</h2>
<h3 id="41">4.1 æ³°å‹’å±•å¼€å‡è®¾çš„æœ‰æ•ˆæ€§</h3>
<p><strong>å‡è®¾</strong>ï¼šä½ç½®ç¼–ç $\boldsymbol{p}$æ˜¯å°æ‰°åŠ¨ï¼Œ$|\boldsymbol{p}| \ll |\boldsymbol{x}|$ã€‚</p>
<p><strong>å®é™…æƒ…å†µ</strong>ï¼šæ£€éªŒBERT-baseæ¨¡å‹ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">transformers</span><span class="w"> </span><span class="kn">import</span> <span class="n">BertModel</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">BertModel</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="s1">&#39;bert-base-uncased&#39;</span><span class="p">)</span>
<span class="n">word_emb</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">embeddings</span><span class="o">.</span><span class="n">word_embeddings</span><span class="o">.</span><span class="n">weight</span>  <span class="c1"># 30522 x 768</span>
<span class="n">pos_emb</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">embeddings</span><span class="o">.</span><span class="n">position_embeddings</span><span class="o">.</span><span class="n">weight</span>  <span class="c1"># 512 x 768</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Word embedding norm (mean): </span><span class="si">{</span><span class="n">word_emb</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Position embedding norm (mean): </span><span class="si">{</span><span class="n">pos_emb</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<p><strong>å…¸å‹è¾“å‡º</strong>ï¼š
- Word embedding norm: 8.2
- Position embedding norm: 5.1</p>
<p><strong>é—®é¢˜</strong>ï¼šä½ç½®ç¼–ç æ¨¡é•¿å¹¶éè¿œå°äºè¯åµŒå…¥ï¼Œæ³°å‹’å±•å¼€çš„ä¸€é˜¶è¿‘ä¼¼å¯èƒ½ä¸å¤Ÿå‡†ç¡®ã€‚</p>
<p><strong>å½±å“</strong>ï¼š
- äº¤å‰é¡¹$\boldsymbol{p}_i^{\top}\boldsymbol{W}\boldsymbol{p}_j$å¯èƒ½ä¸æ˜¯ä¸»å¯¼é¡¹
- é«˜é˜¶é¡¹ï¼ˆä¸‰é˜¶ã€å››é˜¶ï¼‰å¯èƒ½ä¸å¯å¿½ç•¥
- ç›¸å¯¹ä½ç½®æ€§è´¨åœ¨å¼ºäº¤äº’æ—¶é€€åŒ–</p>
<h3 id="42-hessian">4.2 Hessianå¯¹è§’åŒ–å‡è®¾</h3>
<p><strong>å‡è®¾</strong>ï¼š$\boldsymbol{\mathcal{H}} = \frac{\partial^2 f}{\partial \boldsymbol{x}_m \partial \boldsymbol{x}_n}$è¿‘ä¼¼å¯¹è§’é˜µã€‚</p>
<p><strong>éªŒè¯</strong>ï¼šè®¡ç®—BERT Attentionä¸­çš„å®é™…Hessianç»“æ„ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute_hessian_structure</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">input_ids</span><span class="p">):</span>
    <span class="n">outputs</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">output_attentions</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">attn</span> <span class="o">=</span> <span class="n">outputs</span><span class="o">.</span><span class="n">attentions</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># ç¬¬ä¸€å±‚ç¬¬ä¸€ä¸ªå¤´</span>

    <span class="c1"># è®¡ç®—ç›¸å…³ç³»æ•°çŸ©é˜µ</span>
    <span class="n">attn_flat</span> <span class="o">=</span> <span class="n">attn</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">attn</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">corr_matrix</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">attn_flat</span><span class="p">)</span>

    <span class="n">diag_strength</span> <span class="o">=</span> <span class="n">corr_matrix</span><span class="o">.</span><span class="n">diag</span><span class="p">()</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">off_diag_strength</span> <span class="o">=</span> <span class="p">(</span><span class="n">corr_matrix</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">-</span> <span class="n">corr_matrix</span><span class="o">.</span><span class="n">diag</span><span class="p">()</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span> <span class="o">/</span> <span class="p">(</span><span class="n">corr_matrix</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span> <span class="o">-</span> <span class="n">corr_matrix</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">diag_strength</span><span class="p">,</span> <span class="n">off_diag_strength</span>
</code></pre></div>

<p><strong>å…¸å‹ç»“æœ</strong>ï¼š
- å¯¹è§’çº¿å¼ºåº¦ï¼š0.82
- éå¯¹è§’çº¿å¼ºåº¦ï¼š0.31</p>
<p><strong>é—®é¢˜</strong>ï¼šéå¯¹è§’çº¿é¡¹è™½ç„¶è¾ƒå¼±ï¼Œä½†ä¸å¯å¿½ç•¥ï¼ˆçº¦ä¸ºå¯¹è§’çº¿çš„38%ï¼‰ï¼Œè¿™ä¼šå¯¼è‡´ï¼š
- ç›¸å¯¹ä½ç½®ä¸ç»å¯¹ä½ç½®ä¿¡æ¯æ··åˆ
- è¿œç¨‹è¡°å‡ç‰¹æ€§éƒ¨åˆ†å¤±æ•ˆ
- éœ€è¦æ¨¡å‹è‡ªé€‚åº”å­¦ä¹ æ··åˆè¡¨ç¤º</p>
<h3 id="43">4.3 ä¸å­¦ä¹ å¼ä½ç½®ç¼–ç çš„å¯¹æ¯”</h3>
<p><strong>å®éªŒ</strong>ï¼ˆBERTé¢„è®­ç»ƒï¼‰ï¼š</p>
<table>
<thead>
<tr>
<th>æ–¹æ¡ˆ</th>
<th>GLUE Score</th>
<th>SQuAD F1</th>
<th>å‚æ•°é‡</th>
<th>å¤–æ¨èƒ½åŠ›</th>
</tr>
</thead>
<tbody>
<tr>
<td>Sinusoidal</td>
<td>79.2</td>
<td>88.5</td>
<td>0</td>
<td>ä¸­ç­‰</td>
</tr>
<tr>
<td>Learned</td>
<td><strong>80.1</strong></td>
<td><strong>89.3</strong></td>
<td>393K</td>
<td>å·®</td>
</tr>
<tr>
<td>RoPE</td>
<td>80.3</td>
<td>89.7</td>
<td>0</td>
<td><strong>ä¼˜ç§€</strong></td>
</tr>
<tr>
<td>ALiBi</td>
<td>79.8</td>
<td>89.1</td>
<td>0</td>
<td>ä¼˜ç§€</td>
</tr>
</tbody>
</table>
<p><strong>ç»“è®º</strong>ï¼š
- <strong>çŸ­åºåˆ—</strong>ï¼ˆ&lt;512ï¼‰ï¼šLearned &gt; Sinusoidalï¼ˆæ•°æ®é©±åŠ¨æ›´ä¼˜ï¼‰
- <strong>é•¿åºåˆ—å¤–æ¨</strong>ï¼ˆ&gt;512ï¼‰ï¼šSinusoidal/RoPE/ALiBi &gt; Learned
- <strong>æ— å‚æ•°ä¼˜åŠ¿</strong>ï¼šSinusoidal/RoPEèŠ‚çœå†…å­˜</p>
<h3 id="44">4.4 é¢‘ç‡é€‰æ‹©çš„æ•æ„Ÿæ€§</h3>
<p><strong>æ¶ˆèå®éªŒ</strong>ï¼šå›ºå®š$d=512$ï¼Œå˜åŒ–åº•æ•°$b$ï¼š</p>
<table>
<thead>
<tr>
<th>åº•æ•°$b$</th>
<th>GLUE</th>
<th>å¤–æ¨512â†’1024</th>
<th>å¤–æ¨512â†’2048</th>
</tr>
</thead>
<tbody>
<tr>
<td>100</td>
<td>78.1</td>
<td>-2.3 PPL</td>
<td>-8.5 PPL</td>
</tr>
<tr>
<td>1000</td>
<td>79.0</td>
<td>-1.5 PPL</td>
<td>-5.2 PPL</td>
</tr>
<tr>
<td><strong>10000</strong></td>
<td><strong>79.2</strong></td>
<td><strong>-0.8 PPL</strong></td>
<td><strong>-3.1 PPL</strong></td>
</tr>
<tr>
<td>100000</td>
<td>78.8</td>
<td>-0.9 PPL</td>
<td>-2.8 PPL</td>
</tr>
<tr>
<td>Learnable</td>
<td>79.5</td>
<td>-0.6 PPL</td>
<td>-2.5 PPL</td>
</tr>
</tbody>
</table>
<p><strong>è§‚å¯Ÿ</strong>ï¼š
- $b=10000$æ˜¯è‰¯å¥½çš„æŠ˜ä¸­
- å¯è®­ç»ƒ$b$ç•¥ä¼˜ï¼Œä½†å¢åŠ è®­ç»ƒä¸ç¨³å®šæ€§
- è¿‡å°çš„$b$ï¼ˆ100ï¼‰å¯¼è‡´çŸ­ç¨‹ä¿¡æ¯ä¸è¶³
- è¿‡å¤§çš„$b$ï¼ˆ100000ï¼‰é•¿ç¨‹ç›¸å…³æ€§è¿‡å¼ºï¼Œæ³›åŒ–å·®</p>
<h3 id="45">4.5 å¥‡æ€ªçš„æ’åˆ—ä¸å˜æ€§</h3>
<p><strong>æ‚–è®º</strong>ï¼šç†è®ºä¸Šï¼Œæ‰“ä¹±$\sin/\cos$çš„é¡ºåºä¸åº”å½±å“æ€§è´¨ï¼Œä½†å®éªŒå‘ç°ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># åŸå§‹é¡ºåºï¼š[cos(Î¸â‚€), sin(Î¸â‚€), cos(Î¸â‚), sin(Î¸â‚), ...]</span>
<span class="n">PE_original</span> <span class="o">=</span> <span class="n">sinusoidal_pos_encoding</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="mi">768</span><span class="p">)</span>

<span class="c1"># æ‰“ä¹±é¡ºåºï¼š[sin(Î¸â‚€), cos(Î¸â‚€), sin(Î¸â‚), cos(Î¸â‚), ...]</span>
<span class="n">PE_shuffled</span> <span class="o">=</span> <span class="n">PE_original</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="o">...</span><span class="p">]]</span>

<span class="c1"># BERTé¢„è®­ç»ƒå¯¹æ¯”</span>
<span class="c1"># åŸå§‹ï¼šGLUE 79.2</span>
<span class="c1"># æ‰“ä¹±ï¼šGLUE 78.6ï¼ˆä¸‹é™0.6ï¼ï¼‰</span>
</code></pre></div>

<p><strong>å¯èƒ½åŸå› </strong>ï¼š
- Attentionçš„$\boldsymbol{W}_Q, \boldsymbol{W}_K$åˆå§‹åŒ–ä¸ç»´åº¦é¡ºåºç›¸å…³
- æ—©æœŸè®­ç»ƒåŠ¨åŠ›å­¦å¯¹åˆå§‹ç»“æ„æ•æ„Ÿ
- éšå¼çš„å½’çº³åç½®ï¼ˆinductive biasï¼‰</p>
<h3 id="46">4.6 é•¿åº¦å¤–æ¨çš„å¤±è´¥æ¨¡å¼</h3>
<p><strong>é—®é¢˜</strong>ï¼šåœ¨$L_{\text{train}}=512$è®­ç»ƒçš„æ¨¡å‹ï¼Œåœ¨$L_{\text{test}}=2048$æ—¶æ€§èƒ½æ˜¾è‘—ä¸‹é™ã€‚</p>
<p><strong>åŸå› åˆ†æ</strong>ï¼š</p>
<ol>
<li>
<p><strong>é¢‘ç‡æ··å </strong>ï¼šæœ€ä½é¢‘$\theta_{d/2-1}$çš„å‘¨æœŸ$T \approx 62800$ï¼Œè¿œè¶…è®­ç»ƒé•¿åº¦ï¼Œæ¨¡å‹æœªè§è¿‡"å®Œæ•´å‘¨æœŸ"</p>
</li>
<li>
<p><strong>é«˜é¢‘é¥±å’Œ</strong>ï¼šé«˜é¢‘ç»´åº¦åœ¨é•¿åºåˆ—ä¸Šå¿«é€ŸæŒ¯è¡ï¼Œå¯¼è‡´æ¢¯åº¦æ¶ˆå¤±</p>
</li>
<li>
<p><strong>Softmaxç†µå´©å¡Œ</strong>ï¼šé•¿åºåˆ—å¯¼è‡´Attentionç†µå¢å¤§ï¼Œä½ç½®ä¿¡å·è¢«æ·¹æ²¡</p>
</li>
</ol>
<p><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼š
- <strong>å¤–æ¨æ€§å¢å¼º</strong>ï¼šALiBiã€Sandwichã€ReRoPEç­‰æ–¹æ³•
- <strong>åŠ¨æ€è°ƒæ•´</strong>ï¼šè®­ç»ƒæ—¶æ¸è¿›å¢åŠ åºåˆ—é•¿åº¦ï¼ˆprogressive length trainingï¼‰
- <strong>æ··åˆç¼–ç </strong>ï¼šå±€éƒ¨ç”¨Sinusoidalï¼Œå…¨å±€ç”¨Learned</p>
<h3 id="47">4.7 ç†è®ºä¸å®è·µçš„é¸¿æ²Ÿ</h3>
<p><strong>ç†è®ºé¢„æµ‹</strong> vs. <strong>å®é™…è¡¨ç°</strong>ï¼š</p>
<table>
<thead>
<tr>
<th>æ€§è´¨</th>
<th>ç†è®º</th>
<th>å®é™…</th>
</tr>
</thead>
<tbody>
<tr>
<td>ç›¸å¯¹ä½ç½®è¡¨è¾¾</td>
<td>å®Œç¾ï¼ˆ$\mathcal{H}=\boldsymbol{I}$ï¼‰</td>
<td>éƒ¨åˆ†ï¼ˆ$\mathcal{H}$éå¯¹è§’ï¼‰</td>
</tr>
<tr>
<td>è¿œç¨‹è¡°å‡</td>
<td>$\mathcal{O}(1/|\Delta|)$</td>
<td>æ³¢åŠ¨å¤§ï¼Œéå•è°ƒ</td>
</tr>
<tr>
<td>å¤–æ¨æ€§</td>
<td>ä»»æ„é•¿åº¦</td>
<td>2å€è®­ç»ƒé•¿åº¦å†…</td>
</tr>
<tr>
<td>å¯è§£é‡Šæ€§</td>
<td>é«˜ï¼ˆæ•°å­¦æ¨å¯¼ï¼‰</td>
<td>ä½ï¼ˆé»‘ç›’è®­ç»ƒï¼‰</td>
</tr>
</tbody>
</table>
<p><strong>æ ¹æœ¬çŸ›ç›¾</strong>ï¼šç†è®ºåŸºäº<strong>çº¿æ€§åŒ–å‡è®¾</strong>ï¼ˆæ³°å‹’å±•å¼€ï¼‰ï¼Œä½†å®é™…Transformeræ˜¯é«˜åº¦<strong>éçº¿æ€§</strong>ç³»ç»Ÿï¼ˆSoftmaxã€LayerNormã€éçº¿æ€§æ¿€æ´»ï¼‰ã€‚</p>
<h2 id="5">ç¬¬5éƒ¨åˆ†ï¼šä»£ç å®ç°ä¸å·¥ç¨‹å®è·µ</h2>
<h3 id="51-numpy">5.1 æ ‡å‡†å®ç°ï¼ˆNumPyï¼‰</h3>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="k">def</span><span class="w"> </span><span class="nf">sinusoidal_position_encoding</span><span class="p">(</span><span class="n">max_len</span><span class="p">,</span> <span class="n">d_model</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="mi">10000</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    æ ‡å‡†Sinusoidalä½ç½®ç¼–ç å®ç°</span>

<span class="sd">    Args:</span>
<span class="sd">        max_len: æœ€å¤§åºåˆ—é•¿åº¦</span>
<span class="sd">        d_model: æ¨¡å‹ç»´åº¦ï¼ˆå¿…é¡»æ˜¯å¶æ•°ï¼‰</span>
<span class="sd">        base: é¢‘ç‡åº•æ•°ï¼ˆé»˜è®¤10000ï¼‰</span>

<span class="sd">    Returns:</span>
<span class="sd">        pos_encoding: shape (max_len, d_model)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">d_model</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;d_model must be even&quot;</span>

    <span class="c1"># ä½ç½®ç´¢å¼• [0, 1, 2, ..., max_len-1]</span>
    <span class="n">position</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">max_len</span><span class="p">)[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>  <span class="c1"># (max_len, 1)</span>

    <span class="c1"># ç»´åº¦ç´¢å¼• [0, 2, 4, ..., d_model-2]ï¼ˆå¶æ•°ç»´åº¦ï¼‰</span>
    <span class="n">div_term</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">d_model</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="o">-</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">base</span><span class="p">)</span> <span class="o">/</span> <span class="n">d_model</span><span class="p">))</span>  <span class="c1"># (d_model/2,)</span>

    <span class="c1"># è®¡ç®—è§’åº¦ = position * div_term</span>
    <span class="n">angles</span> <span class="o">=</span> <span class="n">position</span> <span class="o">*</span> <span class="n">div_term</span>  <span class="c1"># (max_len, d_model/2)</span>

    <span class="c1"># åˆå§‹åŒ–ç¼–ç çŸ©é˜µ</span>
    <span class="n">pos_encoding</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">max_len</span><span class="p">,</span> <span class="n">d_model</span><span class="p">))</span>

    <span class="c1"># å¶æ•°ç»´åº¦ç”¨sinï¼Œå¥‡æ•°ç»´åº¦ç”¨cos</span>
    <span class="n">pos_encoding</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angles</span><span class="p">)</span>  <span class="c1"># ç»´åº¦ 0, 2, 4, ...</span>
    <span class="n">pos_encoding</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angles</span><span class="p">)</span>  <span class="c1"># ç»´åº¦ 1, 3, 5, ...</span>

    <span class="k">return</span> <span class="n">pos_encoding</span>

<span class="c1"># ä½¿ç”¨ç¤ºä¾‹</span>
<span class="n">PE</span> <span class="o">=</span> <span class="n">sinusoidal_position_encoding</span><span class="p">(</span><span class="n">max_len</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span> <span class="n">d_model</span><span class="o">=</span><span class="mi">768</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Shape: </span><span class="si">{</span><span class="n">PE</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># (512, 768)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Norm: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">PE</span><span class="p">,</span><span class="w"> </span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># ~19.7</span>
</code></pre></div>

<h3 id="52-pytorch">5.2 PyTorchå®ç°ï¼ˆå¯å¾®åˆ†ï¼‰</h3>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nn</span>

<span class="k">class</span><span class="w"> </span><span class="nc">SinusoidalPositionEmbedding</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;PyTorchå¯å¾®åˆ†ä½ç½®ç¼–ç å±‚&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d_model</span><span class="p">,</span> <span class="n">max_len</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">learnable</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d_model</span> <span class="o">=</span> <span class="n">d_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base</span> <span class="o">=</span> <span class="n">base</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">learnable</span> <span class="o">=</span> <span class="n">learnable</span>

        <span class="c1"># é¢„è®¡ç®—ä½ç½®ç¼–ç </span>
        <span class="n">pe</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">max_len</span><span class="p">,</span> <span class="n">d_model</span><span class="p">)</span>
        <span class="n">position</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_len</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">div_term</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">d_model</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">base</span><span class="p">)</span> <span class="o">/</span> <span class="n">d_model</span><span class="p">))</span>

        <span class="n">pe</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">position</span> <span class="o">*</span> <span class="n">div_term</span><span class="p">)</span>
        <span class="n">pe</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">position</span> <span class="o">*</span> <span class="n">div_term</span><span class="p">)</span>

        <span class="c1"># æ³¨å†Œä¸ºbufferï¼ˆä¸å‚ä¸æ¢¯åº¦æ›´æ–°ï¼Œä½†ä¼šä¿å­˜åˆ°æ¨¡å‹ä¸­ï¼‰</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s1">&#39;pe&#39;</span><span class="p">,</span> <span class="n">pe</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>  <span class="c1"># (1, max_len, d_model)</span>

        <span class="c1"># å¯é€‰ï¼šå¯å­¦ä¹ çš„ç¼©æ”¾å› å­</span>
        <span class="k">if</span> <span class="n">learnable</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="mf">1.0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            x: (batch_size, seq_len, d_model)</span>
<span class="sd">        Returns:</span>
<span class="sd">            x + pos_encoding: (batch_size, seq_len, d_model)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">seq_len</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">pos_emb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pe</span><span class="p">[:,</span> <span class="p">:</span><span class="n">seq_len</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>
        <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">pos_emb</span>

<span class="c1"># ä½¿ç”¨ç¤ºä¾‹</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">TransformerEncoder</span><span class="p">(</span>
    <span class="n">nn</span><span class="o">.</span><span class="n">TransformerEncoderLayer</span><span class="p">(</span><span class="n">d_model</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span> <span class="n">nhead</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span>
    <span class="n">num_layers</span><span class="o">=</span><span class="mi">6</span>
<span class="p">)</span>

<span class="c1"># æ·»åŠ ä½ç½®ç¼–ç </span>
<span class="n">pos_encoder</span> <span class="o">=</span> <span class="n">SinusoidalPositionEmbedding</span><span class="p">(</span><span class="n">d_model</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span> <span class="n">learnable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># å‰å‘ä¼ æ’­</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">512</span><span class="p">)</span>  <span class="c1"># (batch, seq_len, d_model)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">pos_encoder</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</code></pre></div>

<h3 id="53">5.3 ä¼˜åŒ–æŠ€å·§</h3>
<h4 id="1_2">æŠ€å·§1ï¼šç¼“å­˜æœºåˆ¶</h4>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">CachedPositionEmbedding</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;å¸¦ç¼“å­˜çš„ä½ç½®ç¼–ç ï¼Œé¿å…é‡å¤è®¡ç®—&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d_model</span><span class="p">,</span> <span class="n">initial_max_len</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="mi">10000</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d_model</span> <span class="o">=</span> <span class="n">d_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base</span> <span class="o">=</span> <span class="n">base</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cached_pe</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cached_len</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expand_cache</span><span class="p">(</span><span class="n">initial_max_len</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">expand_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_len</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;åŠ¨æ€æ‰©å±•ç¼“å­˜&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">new_len</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cached_len</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">pe</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">new_len</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_model</span><span class="p">)</span>
        <span class="n">position</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">new_len</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">div_term</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_model</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span> <span class="o">*</span>
                             <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_model</span><span class="p">))</span>

        <span class="n">pe</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">position</span> <span class="o">*</span> <span class="n">div_term</span><span class="p">)</span>
        <span class="n">pe</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">position</span> <span class="o">*</span> <span class="n">div_term</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s1">&#39;_cached_pe&#39;</span><span class="p">,</span> <span class="n">pe</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cached_len</span> <span class="o">=</span> <span class="n">new_len</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">seq_len</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">seq_len</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cached_len</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">expand_cache</span><span class="p">(</span><span class="n">seq_len</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cached_pe</span><span class="p">[:,</span> <span class="p">:</span><span class="n">seq_len</span><span class="p">,</span> <span class="p">:]</span>
</code></pre></div>

<h4 id="2_1">æŠ€å·§2ï¼šæ··åˆç²¾åº¦</h4>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">torch.cuda.amp</span><span class="w"> </span><span class="kn">import</span> <span class="n">autocast</span>

<span class="nd">@autocast</span><span class="p">()</span>
<span class="k">def</span><span class="w"> </span><span class="nf">forward_with_amp</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ä½¿ç”¨è‡ªåŠ¨æ··åˆç²¾åº¦åŠ é€Ÿ&quot;&quot;&quot;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">pos_encoder</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">half</span><span class="p">())</span>  <span class="c1"># FP16ä½ç½®ç¼–ç </span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">output</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
</code></pre></div>

<h4 id="3_1">æŠ€å·§3ï¼šå¯å­¦ä¹ é¢‘ç‡</h4>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">LearnableFreqPositionEmbedding</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;å¯å­¦ä¹ é¢‘ç‡çš„ä½ç½®ç¼–ç &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d_model</span><span class="p">,</span> <span class="n">max_len</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span> <span class="n">init_base</span><span class="o">=</span><span class="mi">10000</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d_model</span> <span class="o">=</span> <span class="n">d_model</span>

        <span class="c1"># åˆå§‹åŒ–é¢‘ç‡ä¸ºlogç©ºé—´å‡åŒ€åˆ†å¸ƒ</span>
        <span class="n">init_freqs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">init_base</span><span class="p">),</span> <span class="n">d_model</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">freqs</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">init_freqs</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">())</span>

        <span class="c1"># ä½ç½®ç´¢å¼•ï¼ˆå›ºå®šï¼‰</span>
        <span class="n">position</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_len</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s1">&#39;position&#39;</span><span class="p">,</span> <span class="n">position</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">seq_len</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">angles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">[:</span><span class="n">seq_len</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">freqs</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">pe</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">seq_len</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_model</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="n">pe</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angles</span><span class="p">)</span>
        <span class="n">pe</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angles</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">pe</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</code></pre></div>

<h3 id="54">5.4 å¤–æ¨æ€§å¢å¼ºæ–¹æ¡ˆ</h3>
<h4 id="1linear-interpolation">æ–¹æ¡ˆ1ï¼šçº¿æ€§æ’å€¼ï¼ˆLinear Interpolationï¼‰</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">interpolate_position_encoding</span><span class="p">(</span><span class="n">pe</span><span class="p">,</span> <span class="n">old_len</span><span class="p">,</span> <span class="n">new_len</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    å°†è®­ç»ƒé•¿åº¦old_lençš„ä½ç½®ç¼–ç æ’å€¼åˆ°new_len</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">scale</span> <span class="o">=</span> <span class="n">old_len</span> <span class="o">/</span> <span class="n">new_len</span>
    <span class="n">position_new</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">new_len</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale</span>

    <span class="c1"># çº¿æ€§æ’å€¼</span>
    <span class="n">pe_new</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span>
        <span class="n">pe</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>  <span class="c1"># (batch, d_model, old_len)</span>
        <span class="n">size</span><span class="o">=</span><span class="n">new_len</span><span class="p">,</span>
        <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span>
        <span class="n">align_corners</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># (batch, new_len, d_model)</span>

    <span class="k">return</span> <span class="n">pe_new</span>
</code></pre></div>

<h4 id="2alibiattention-with-linear-biases">æ–¹æ¡ˆ2ï¼šALiBiï¼ˆAttention with Linear Biasesï¼‰</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_alibi_slopes</span><span class="p">(</span><span class="n">num_heads</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ç”ŸæˆALiBiçš„çº¿æ€§è¡°å‡æ–œç‡&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_slopes_power_of_2</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">start</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="o">-</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)))</span>
        <span class="n">ratio</span> <span class="o">=</span> <span class="n">start</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">start</span> <span class="o">*</span> <span class="n">ratio</span> <span class="o">**</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">num_heads</span><span class="p">)</span><span class="o">.</span><span class="n">is_integer</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">get_slopes_power_of_2</span><span class="p">(</span><span class="n">num_heads</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">closest_power_of_2</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">**</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">num_heads</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">get_slopes_power_of_2</span><span class="p">(</span><span class="n">closest_power_of_2</span><span class="p">)</span> <span class="o">+</span> \
               <span class="n">get_slopes_power_of_2</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">closest_power_of_2</span><span class="p">)[</span><span class="mi">0</span><span class="p">::</span><span class="mi">2</span><span class="p">][:</span><span class="n">num_heads</span> <span class="o">-</span> <span class="n">closest_power_of_2</span><span class="p">]</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ALiBiAttention</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;å¸¦ALiBiåç½®çš„Attention&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_heads</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="n">slopes</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">get_alibi_slopes</span><span class="p">(</span><span class="n">num_heads</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s1">&#39;slopes&#39;</span><span class="p">,</span> <span class="n">slopes</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">num_heads</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="n">seq_len</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># æ ‡å‡†Attentionåˆ†æ•°</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">k</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>

        <span class="c1"># æ·»åŠ ALiBiåç½®ï¼š-m * |i - j|</span>
        <span class="n">positions</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">seq_len</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">q</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="n">dist_matrix</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">positions</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">positions</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">alibi_bias</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">slopes</span> <span class="o">*</span> <span class="n">dist_matrix</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>

        <span class="n">scores</span> <span class="o">=</span> <span class="n">scores</span> <span class="o">+</span> <span class="n">alibi_bias</span>

        <span class="n">attn_weights</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">attn_weights</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output</span>
</code></pre></div>

<h3 id="55">5.5 è°ƒè¯•ä¸ç›‘æ§</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">analyze_position_encoding</span><span class="p">(</span><span class="n">pe</span><span class="p">,</span> <span class="n">seq_len</span><span class="o">=</span><span class="mi">128</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;åˆ†æä½ç½®ç¼–ç çš„ç»Ÿè®¡æ€§è´¨&quot;&quot;&quot;</span>

    <span class="c1"># 1. å†…ç§¯çŸ©é˜µ</span>
    <span class="n">similarity</span> <span class="o">=</span> <span class="n">pe</span> <span class="o">@</span> <span class="n">pe</span><span class="o">.</span><span class="n">T</span>

    <span class="c1"># 2. è¿œç¨‹è¡°å‡æ‹Ÿåˆ</span>
    <span class="n">distances</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">seq_len</span><span class="p">)</span>
    <span class="n">avg_similarity</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">similarity</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">distances</span><span class="p">]</span>

    <span class="c1"># æ‹Ÿåˆ y = a / x^b</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">scipy.optimize</span><span class="w"> </span><span class="kn">import</span> <span class="n">curve_fit</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">power_law</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">a</span> <span class="o">/</span> <span class="p">(</span><span class="n">x</span> <span class="o">**</span> <span class="n">b</span><span class="p">)</span>

    <span class="n">params</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="n">power_law</span><span class="p">,</span> <span class="n">distances</span><span class="p">,</span> <span class="n">avg_similarity</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Decay fitted: f(d) = </span><span class="si">{</span><span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> / d^</span><span class="si">{</span><span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># 3. é¢‘è°±åˆ†æ</span>
    <span class="n">fft</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfft</span><span class="p">(</span><span class="n">pe</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">power_spectrum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">fft</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">similarity</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;RdBu_r&#39;</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Inner Product Matrix&#39;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">distances</span><span class="p">,</span> <span class="n">avg_similarity</span><span class="p">,</span> <span class="s1">&#39;b.&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Actual&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">distances</span><span class="p">,</span> <span class="n">power_law</span><span class="p">(</span><span class="n">distances</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">),</span> <span class="s1">&#39;r-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Fit&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Distance&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Average Similarity&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Long-Range Decay&#39;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">power_spectrum</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Position&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Frequency Bin&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Power Spectrum&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>

<h3 id="56">5.6 å·¥ç¨‹æœ€ä½³å®è·µ</h3>
<p><strong>1. é€‰æ‹©åˆé€‚çš„åº•æ•°</strong>ï¼š
- çŸ­æ–‡æœ¬ï¼ˆ&lt;512ï¼‰ï¼š$b=1000$
- æ ‡å‡†æ–‡æœ¬ï¼ˆ512-2048ï¼‰ï¼š$b=10000$ï¼ˆé»˜è®¤ï¼‰
- è¶…é•¿æ–‡æœ¬ï¼ˆ&gt;2048ï¼‰ï¼š$b=100000$æˆ–å¯å­¦ä¹ </p>
<p><strong>2. å½’ä¸€åŒ–ç­–ç•¥</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># æ–¹æ¡ˆ1ï¼šL2å½’ä¸€åŒ–</span>
<span class="n">pe_normalized</span> <span class="o">=</span> <span class="n">pe</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">pe</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># æ–¹æ¡ˆ2ï¼šç¼©æ”¾åˆ°[-1, 1]</span>
<span class="n">pe_scaled</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">pe</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">)</span>

<span class="c1"># æ–¹æ¡ˆ3ï¼šä¸è¯åµŒå…¥åŒ¹é…æ¨¡é•¿</span>
<span class="n">pe_matched</span> <span class="o">=</span> <span class="n">pe</span> <span class="o">*</span> <span class="p">(</span><span class="n">word_emb_norm</span> <span class="o">/</span> <span class="n">pe_norm</span><span class="p">)</span>
</code></pre></div>

<p><strong>3. æ¢¯åº¦è£å‰ª</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># ä½ç½®ç¼–ç å¯èƒ½å¯¼è‡´æ¢¯åº¦çˆ†ç‚¸ï¼Œå»ºè®®è£å‰ª</span>
<span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">clip_grad_norm_</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">max_norm</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
</code></pre></div>

<p><strong>4. é¢„è®­ç»ƒè¿ç§»</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># ä»512é•¿åº¦çš„é¢„è®­ç»ƒæ¨¡å‹è¿ç§»åˆ°1024</span>
<span class="k">def</span><span class="w"> </span><span class="nf">transfer_position_encoding</span><span class="p">(</span><span class="n">model_512</span><span class="p">,</span> <span class="n">model_1024</span><span class="p">):</span>
    <span class="n">pe_512</span> <span class="o">=</span> <span class="n">model_512</span><span class="o">.</span><span class="n">pos_encoder</span><span class="o">.</span><span class="n">pe</span>
    <span class="n">pe_1024</span> <span class="o">=</span> <span class="n">interpolate_position_encoding</span><span class="p">(</span><span class="n">pe_512</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">1024</span><span class="p">)</span>
    <span class="n">model_1024</span><span class="o">.</span><span class="n">pos_encoder</span><span class="o">.</span><span class="n">pe</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">pe_1024</span>
</code></pre></div>

<p><strong>5. A/Bæµ‹è¯•å»ºè®®</strong>ï¼š
- å¯¹æ¯”Learned vs. Sinusoidal vs. RoPE
- ç›‘æ§å¤–æ¨æ€§èƒ½ï¼ˆè®­ç»ƒé•¿åº¦çš„1.5å€ã€2å€ï¼‰
- è®°å½•è®­ç»ƒç¨³å®šæ€§ï¼ˆæ¢¯åº¦èŒƒæ•°ã€æŸå¤±æ›²çº¿ï¼‰</p>
<h2 id="6">ç¬¬6éƒ¨åˆ†ï¼šæ€»ç»“ä¸å±•æœ›</h2>
<h3 id="61">6.1 æ ¸å¿ƒç»“è®º</h3>
<p>æœ¬æ–‡é€šè¿‡å››æ­¥æ¨å¯¼æ³•ï¼Œä»ç¬¬ä¸€æ€§åŸç†"åæ¨"å‡ºäº†Sinusoidalä½ç½®ç¼–ç ï¼š</p>
<ol>
<li><strong>æ³°å‹’å±•å¼€</strong> â†’ å»ºç«‹ä½ç½®ç¼–ç ä¸HessiançŸ©é˜µçš„è”ç³»</li>
<li><strong>å¤æ•°æ–¹æ³•</strong> â†’ æ¨å¯¼å‡ºä¸‰è§’å‡½æ•°å½¢å¼</li>
<li><strong>æŒ¯è¡ç§¯åˆ†</strong> â†’ è§£é‡Šè¿œç¨‹è¡°å‡æœºåˆ¶</li>
<li><strong>ä¸€èˆ¬åŒ–</strong> â†’ åˆ†æHessianéå¯¹è§’æƒ…å†µ</li>
</ol>
<p><strong>å…³é”®æ´å¯Ÿ</strong>ï¼š
- ç»å¯¹ä½ç½®ç¼–ç å¯ä»¥éšå¼è¡¨è¾¾ç›¸å¯¹ä½ç½®ï¼ˆé€šè¿‡å†…ç§¯ï¼‰
- å¤šé¢‘ç‡å åŠ äº§ç”Ÿè¿œç¨‹è¡°å‡ï¼ˆRiemann-Lebesgueå¼•ç†ï¼‰
- åº•æ•°10000æ˜¯ç»éªŒæŠ˜ä¸­ï¼Œéæœ€ä¼˜é€‰æ‹©
- ç†è®ºå‡è®¾ï¼ˆ$\mathcal{H}=\boldsymbol{I}$, å°æ‰°åŠ¨ï¼‰åœ¨å®é™…ä¸­éƒ¨åˆ†æˆç«‹</p>
<h3 id="62">6.2 æœªæ¥ç ”ç©¶æ–¹å‘</h3>
<p><strong>æ–¹å‘1ï¼šè‡ªé€‚åº”é¢‘ç‡å­¦ä¹ </strong>
- è®©æ¯å±‚ã€æ¯å¤´å­¦ä¹ ä¸åŒçš„$\theta_i$
- ä½¿ç”¨ç¥ç»æ¶æ„æœç´¢ï¼ˆNASï¼‰ä¼˜åŒ–é¢‘ç‡åˆ†å¸ƒ
- ç»“åˆä»»åŠ¡ç‰¹æ€§ï¼ˆçŸ­æ–‡æœ¬ vs. é•¿æ–‡æœ¬ï¼‰åŠ¨æ€è°ƒæ•´</p>
<p><strong>æ–¹å‘2ï¼šæ··åˆä½ç½®ç¼–ç </strong>
- å±€éƒ¨ï¼šSinusoidalï¼ˆæ•æ‰çŸ­ç¨‹ï¼‰
- å…¨å±€ï¼šLearnedï¼ˆæ•æ‰é•¿ç¨‹ç»“æ„ï¼‰
- åˆ†å±‚ï¼šä¸åŒå±‚ç”¨ä¸åŒç¼–ç ç­–ç•¥</p>
<p><strong>æ–¹å‘3ï¼šå› æœä½ç½®ç¼–ç </strong>
- å¼•å…¥æ—¶é—´ç®­å¤´ï¼ˆè¿‡å» â‰  æœªæ¥ï¼‰
- éå¯¹ç§°è¡°å‡ï¼ˆå‘å‰çœ‹ vs. å‘åçœ‹ï¼‰
- é€‚ç”¨äºè‡ªå›å½’ç”Ÿæˆ</p>
<p><strong>æ–¹å‘4ï¼šå¤šæ¨¡æ€ä½ç½®ç¼–ç </strong>
- å›¾åƒï¼š2Dä½ç½®ç¼–ç ï¼ˆRoPE-2Dï¼‰
- è§†é¢‘ï¼š3Dæ—¶ç©ºç¼–ç 
- å›¾ï¼šèŠ‚ç‚¹ä½ç½®ï¼ˆç»“åˆGraph Laplacianï¼‰</p>
<p><strong>æ–¹å‘5ï¼šç†è®ºæ·±åŒ–</strong>
- æ”¾æ¾æ³°å‹’å±•å¼€å‡è®¾ï¼Œç ”ç©¶éçº¿æ€§æƒ…å†µ
- å»ºç«‹ä¸ä¿¡æ¯è®ºçš„ä¸¥æ ¼è”ç³»ï¼ˆæœ€å¤§ç†µã€ç‡å¤±çœŸï¼‰
- ç»Ÿä¸€æ¡†æ¶ï¼šSinusoidal, RoPE, ALiBi, FIREç­‰</p>
<h3 id="63">6.3 ç»ˆæä¹‹é—®</h3>
<p><strong>ä½ç½®ç¼–ç çš„æœ¬è´¨æ˜¯ä»€ä¹ˆ</strong>ï¼Ÿ</p>
<p>ä¸åŒè§†è§’çš„ç­”æ¡ˆï¼š
- <strong>æ•°å­¦</strong>ï¼šé«˜ç»´ç©ºé—´ä¸­çš„åæ ‡ç³»é€‰æ‹©
- <strong>ä¿¡æ¯è®º</strong>ï¼šåºåˆ—çš„å‹ç¼©ç¼–ç ï¼ˆrate-distortionï¼‰
- <strong>ç‰©ç†</strong>ï¼šæ—¶ç©ºçš„åº¦è§„å¼ é‡ï¼ˆmetric tensorï¼‰
- <strong>å“²å­¦</strong>ï¼šå­˜åœ¨ï¼ˆbeingï¼‰çš„ç´¢å¼•åŒ–è¡¨ç¤º</p>
<p>æ— è®ºå¦‚ä½•ï¼ŒSinusoidalä½ç½®ç¼–ç ä½œä¸ºæ·±åº¦å­¦ä¹ ä¸­ä¸ºæ•°ä¸å¤šçš„<strong>æ˜¾å¼è§£</strong>ï¼Œå…¶ç²¾å¦™è®¾è®¡å€¼å¾—æˆ‘ä»¬åå¤å“å‘³ã€‚å®ƒæé†’æˆ‘ä»¬ï¼š<strong>æœ‰æ—¶å€™ï¼Œç®€å•çš„æ•°å­¦å…¬å¼èƒŒåï¼Œéšè—ç€æ·±åˆ»çš„åŸç†</strong>ã€‚</p>
<hr />
<p><strong>å‚è€ƒæ–‡çŒ®</strong>ï¼š
1. Vaswani et al. (2017) "Attention is All You Need"
2. Su et al. (2021) "RoFormer: Enhanced Transformer with Rotary Position Embedding"
3. Press et al. (2021) "Train Short, Test Long: Attention with Linear Biases Enables Input Length Extrapolation"
4. Shaw et al. (2018) "Self-Attention with Relative Position Representations"
5. Tao, T. (2007) "Oscillatory Integrals" (UCLA Lecture Notes)</p>
<p><strong>è‡´è°¢</strong>ï¼šæ„Ÿè°¢è‹å‰‘æ—è€å¸ˆçš„åŸåˆ›æ´å¯Ÿï¼Œæœ¬æ–‡åœ¨å…¶åŸºç¡€ä¸Šè¿›è¡Œäº†ç³»ç»Ÿæ€§æ‰©å±•ã€‚</p>
        </div>
    </div>
</body>
</html>