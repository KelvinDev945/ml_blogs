<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>生成扩散模型漫谈（十三）：从万有引力到扩散模型 | ML & Math Blog Posts</title>
    <meta name="description" content="生成扩散模型漫谈（十三）：从万有引力到扩散模型&para;
原文链接: https://spaces.ac.cn/archives/9305
发布日期: 

对于很多读者来说，生成扩散模型可能是他们遇到的第一个能够将如此多的数学工具用到深度学习上的模型。在这个系列文章中，我们已经展示了扩散模型与数学分析、概率统计、常微分方程、随机微分方程乃至偏微分方程等内容的深刻联系，可以说，即便是做数学物理方程...">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css">

    <!-- Google Fonts -->
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="../assets/css/main.css">
    <link rel="stylesheet" href="../assets/css/post.css">

    <!-- Custom JS -->
    <script src="../assets/js/collapsible.js" defer></script>

    <!-- MathJax for math rendering with equation numbering -->
    <script>
    MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']],
        processEscapes: true,
        processEnvironments: true,
        tags: 'ams',  // Enable equation numbering with AMS style
        tagSide: 'right',  // Place equation numbers on the right
        tagIndent: '0.8em',  // Indentation for equation numbers
        multlineWidth: '85%'
      },
      options: {
        skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
      }
    };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <!-- Syntax highlighting -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.7.0/build/styles/github.min.css">
    <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.7.0/build/highlight.min.js"></script>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light border-bottom">
        <div class="container">
            <a class="navbar-brand" href="../index.html">
                <i class="fas fa-brain"></i> ML & Math Blog
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="../index.html"><i class="fas fa-home"></i> 首页</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Post Content -->
    <article class="container post-container my-5">
        <!-- Breadcrumb Navigation -->
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="../index.html"><i class="fas fa-home"></i> 首页</a></li>
                
                <li class="breadcrumb-item"><a href="../index.html?tags=详细推导">详细推导</a></li>
                
                <li class="breadcrumb-item active" aria-current="page">
                    #58 生成扩散模型漫谈（十三）：从万有引力到扩散模型
                </li>
            </ol>
        </nav>

        <!-- Post Header -->
        <header class="post-header mb-4">
            <h1 class="post-title">
                <span class="post-number">#58</span>
                生成扩散模型漫谈（十三）：从万有引力到扩散模型
            </h1>
            <div class="post-meta">
                <span><i class="far fa-calendar"></i> 2022-10-18</span>
                
            </div>
            
            <div class="post-tags mt-3">
                
                <a href="../index.html?tags=详细推导" class="tag-link">
                    <span class="tag"><i class="fas fa-tag"></i> 详细推导</span>
                </a>
                
                <a href="../index.html?tags=引力" class="tag-link">
                    <span class="tag"><i class="fas fa-tag"></i> 引力</span>
                </a>
                
                <a href="../index.html?tags=场论" class="tag-link">
                    <span class="tag"><i class="fas fa-tag"></i> 场论</span>
                </a>
                
                <a href="../index.html?tags=生成模型" class="tag-link">
                    <span class="tag"><i class="fas fa-tag"></i> 生成模型</span>
                </a>
                
                <a href="../index.html?tags=扩散" class="tag-link">
                    <span class="tag"><i class="fas fa-tag"></i> 扩散</span>
                </a>
                
                <a href="../index.html?tags=生成模型" class="tag-link">
                    <span class="tag"><i class="fas fa-tag"></i> 生成模型</span>
                </a>
                
            </div>
            
        </header>

        <div class="row">
            <!-- Main Content -->
            <div class="col-lg-9">
                <!-- Post Body -->
                <div class="post-content">
                    <h1 id="_1">生成扩散模型漫谈（十三）：从万有引力到扩散模型<a class="toc-link" href="#_1" title="Permanent link">&para;</a></h1>
<p><strong>原文链接</strong>: <a href="https://spaces.ac.cn/archives/9305">https://spaces.ac.cn/archives/9305</a></p>
<p><strong>发布日期</strong>: </p>
<hr />
<p>对于很多读者来说，生成扩散模型可能是他们遇到的第一个能够将如此多的数学工具用到深度学习上的模型。在这个系列文章中，我们已经展示了扩散模型与数学分析、概率统计、常微分方程、随机微分方程乃至偏微分方程等内容的深刻联系，可以说，即便是做数学物理方程的纯理论研究的同学，大概率也可以在扩散模型中找到自己的用武之地。</p>
<p>在这篇文章中，我们再介绍一个同样与数学物理有深刻联系的扩散模型——由“万有引力定律”启发的ODE式扩散模型，出自论文<a href="https://papers.cool/arxiv/2209.11178">《Poisson Flow Generative Models》</a>（简称PFGM），它给出了一个构建ODE式扩散模型的全新视角。</p>
<h2 id="_2">万有引力<a class="toc-link" href="#_2" title="Permanent link">&para;</a></h2>
<p>中学时期我们就学过万有引力定律，大概的描述方式是：</p>
<blockquote>
<p>两个质点彼此之间相互吸引的作用力，是与它们的质量乘积成正比，并与它们之间的距离成平方反比。</p>
</blockquote>
<p>这里我们忽略质量和常数，主要关心它的方向和与距离的关系，假设引力源位于$\boldsymbol{y}$，那么位于$\boldsymbol{x}$的物体所受到的引力可以记为<br />
\begin{equation}\boldsymbol{F}(\boldsymbol{x}) = -\frac{1}{4\pi}\frac{\boldsymbol{x} - \boldsymbol{y}}{\Vert \boldsymbol{x} - \boldsymbol{y}\Vert^3}\label{eq:grad-3}\end{equation}<br />
$\frac{1}{4\pi}$这个因子我们可以先不管它，它不影响后面的分析。准确来说，上式描述的是三维空间的引力场，对于$d$维空间来说，其引力场的形式为<br />
\begin{equation}\boldsymbol{F}(\boldsymbol{x}) = -\frac{1}{S_d(1)}\frac{\boldsymbol{x} - \boldsymbol{y}}{\Vert \boldsymbol{x} - \boldsymbol{y}\Vert^d}\label{eq:grad-d}\end{equation}<br />
其中$S_d(1)$是$d$维单位超球面的表面积。该式实际上就是$d$维Poisson方程的格林函数的梯度，这也就是论文标题中的“Poisson”一词的来源。</p>
<h2 id="_3">沿场线走<a class="toc-link" href="#_3" title="Permanent link">&para;</a></h2>
<p>如果引力源有多个，那么直接将各个引力源的引力相加即可，这是引力场的线性可加性。下面我们画出了四个引力源的向量场，其中引力源用黑色点标记出，彩色线表示场线：  </p>
<p><a href="/usr/uploads/2022/10/3097555639.svg" title="点击查看原图"><img alt="引力场示意图" src="/usr/uploads/2022/10/3097555639.svg" /></a></p>
<p>引力场示意图</p>
<p>从上述引力场图我们可以看出它的一个重要特点：</p>
<blockquote>
<p>除了极少数外，大部分场线都是从远处出发，终止于某个引力源点。</p>
</blockquote>
<p>此时，一个直观而又“异想天开”的主意是：</p>
<blockquote>
<p>如果每个引力源都代表着一个要生成的真实样本点，那么远处的任意点只要沿着场线运动，不就都可以演变成一个真实样本点了吗？</p>
</blockquote>
<p>这就是<a href="https://papers.cool/arxiv/2209.11178">《Poisson Flow Generative Models》</a>一文最核心的天才想法！</p>
<h2 id="_4">等效质心<a class="toc-link" href="#_4" title="Permanent link">&para;</a></h2>
<p>当然，天才归天才，要将它真正变成一个可用的模型，还有很多细节要补充。比如我们刚才说“远处的任意点”，这就是扩散模型的初始分布了，那么问题就来了：“远处”是多远？“任意点”该如何采样？如果采样方式过于复杂，那也没有价值了。</p>
<p>幸运的是，引力场有一个非常重要的等效性质：</p>
<blockquote>
<p>无穷远处的多源引力场，等价于位于质心、质量叠加的质点引力场。</p>
</blockquote>
<p>也就是说，当距离足够远时，我们只需要当它是位于质心的单源质点引力场。下图也画出了多源引力场及其对应的质心引力场，可以看到，当距离变大时（橙色圆圈位置），两者的引力场几乎一致了。  </p>
<p><a href="/usr/uploads/2022/10/1214065996.svg" title="点击查看原图"><img alt="多源引力场" src="/usr/uploads/2022/10/1214065996.svg" /></a></p>
<p>多源引力场</p>
<p><a href="/usr/uploads/2022/10/488016129.svg" title="点击查看原图"><img alt="质心引力场" src="/usr/uploads/2022/10/488016129.svg" /></a></p>
<p>质心引力场</p>
<p>单个质点的引力场有什么特点？各向同性！这意味着在足够大半径时，可以认为场线是均匀地穿过以质点为球心的球面的，所以我们在一个半径足够大的球面上进行均匀采样就可以了，这就解决了初始分布的采样问题。至于“足够大”是多大，我们后面再说。</p>
<h2 id="_5">模式坍缩<a class="toc-link" href="#_5" title="Permanent link">&para;</a></h2>
<p>所以生成模型就这样构建好了？还没有。引力场的各向同性使得对应的初始分布易于采样，然而也会造成引力源的相互抵消现象，从而出现“模式坍缩（Mode Collapse）”。</p>
<p>具体来说，我们先来画出均匀分布在球壳上的引力场，它的分布是这样的：  </p>
<p><a href="/usr/uploads/2022/10/1113525710.svg" title="点击查看原图"><img alt="引力源各向同性的引力场" src="/usr/uploads/2022/10/1113525710.svg" /></a></p>
<p>引力源各向同性的引力场</p>
<p>发现特点了没？在球壳外部是正常的各向同性分布，但是在球壳内部是“空”的！也就是说球壳内部的引力场相互抵消了，相当于一个真空地带，这个现象笔者在十多年前的科普博客<a href="/archives/988">《球壳内部的均匀力场》</a>也介绍过。</p>
<p>抵消现象意味着任意选一个球面，球面上均匀分布的引力源由于引力相互抵消，那么就相当于不存在该引力源了。而我们说了，本文构建生成模型的方式，是通过远处的任意点沿着场线运动，直达某个引力源。如果引力源相互抵消，那么就意味着永远也达不到某些引力源，即意味着某些真实样本无法生成，生成结果就会缺失多样性，这就是“模式坍缩”现象。</p>
<h2 id="_6">增加一维<a class="toc-link" href="#_6" title="Permanent link">&para;</a></h2>
<p>看上去模式坍缩无论如何都是不能避免的。因为在构建生成模型的时候，我们通常假设真实样本服从一个连续型的分布，这样一来，任选一个球面，哪怕真实样本在该球面的分布不是均匀的，我们也能从中挑出一个均匀分布的“子集”，该“子集”的引力就相互抵消了，相当于这些数据点不存在了，继而发生模式坍缩。</p>
<p>那么这条路真的走到尽头了吗？并没有！这时候PFGM的第二个“天才想法”来了：<strong>增加一维！</strong></p>
<p>刚才我们分析了，模式坍缩无法避免，是因为连续性分布的假设导致各向同性无法避免。要想避免模式坍缩，就要想办法杜绝分布的各向同性。可是真实样本的分布是目标分布，这是不能改变的，然而我们可以给它增加一维，如果我们在$d+1$维空间去讨论，那么原来的$d$维分布可以视为$d+1$维空间的一个平面，平面就不可能各向同性了。举个低维空间的例子。我们知道对于二维空间来说，“圆”是各向同性的，但对于三维空间来说，“球”才是各向同性的，二维空间中各向同性的“圆”，在三维空间看来就不是各向同性了。</p>
<p>所以，假设要生成的真实样本原来是$\boldsymbol{x}\in\mathbb{R}^d$的，我们引入一个新维度$t$，使得数据点变为$(\boldsymbol{x},t)\in\mathbb{R}^{d+1}$，而原来真实样本服从的分布是$\boldsymbol{x}\sim \tilde{p}(\boldsymbol{x})$的，现在改为$(\boldsymbol{x},t)\sim \delta(t)\tilde{p}(\boldsymbol{x})$，其中$\delta(t)$是狄拉克分布，其实就是将真实样本放到$d+1$维空间的$t=0$平面上。这样处理后，在$d+1$维空间中，真实样本点的$t$取值总是0，因此就不能出现各向同性现象了（类比刚才“三维空间中的圆”的例子）。</p>
<h2 id="_7">豁然开朗<a class="toc-link" href="#_7" title="Permanent link">&para;</a></h2>
<p>乍一看，增加一维只是一个数学上的小技巧，但细细品味之下，我们会越发感觉它妙不可言，很多在原来$d$维空间中不好处理的细节问题，在$d+1$维空间中就豁然开朗了。</p>
<p>根据式$\eqref{eq:grad-d}$和引力的线性叠加性，我们可以写出此时$d+1$维空间的引力场为<br />
\begin{equation}\begin{aligned}
\boldsymbol{F}(\boldsymbol{x}, t) =&amp;\, -\frac{1}{S_{d+1}(1)}\iint\frac{(\boldsymbol{x} - \boldsymbol{x}<em d_1="d+1">0, t - t_0)}{(\Vert\boldsymbol{x} - \boldsymbol{x}_0\Vert^2 + (t - t_0)^2)^{(d+1)/2}}\delta(t_0)\tilde{p}(\boldsymbol{x}_0) d\boldsymbol{x}_0dt_0 \\
=&amp;\, -\frac{1}{S</em>}(1)}\int\frac{(\boldsymbol{x} - \boldsymbol{x<em _boldsymbol_x="\boldsymbol{x">0, t)}{(\Vert\boldsymbol{x} - \boldsymbol{x}_0\Vert^2 + t^2)^{(d+1)/2}}\tilde{p}(\boldsymbol{x}_0) d\boldsymbol{x}_0 \\
\triangleq&amp;\, (\boldsymbol{F}</em>}}, \boldsymbol{F<em _boldsymbol_x="\boldsymbol{x">t)
\end{aligned}\label{eq:field}\end{equation}<br />
其中$\boldsymbol{F}</em>}}$是$\boldsymbol{F}(\boldsymbol{x}, t)$的前$d$个分量，$\boldsymbol{F<em _boldsymbol_x="\boldsymbol{x">t$是它的第$d+1$个分量。下一节我们再来讨论$\boldsymbol{F}(\boldsymbol{x}, t)$怎么学，现在假设$\boldsymbol{F}(\boldsymbol{x}, t)$已经知道了，那么接下来就是要沿着场线运动，也就是运动轨迹要时刻跟$\boldsymbol{F}(\boldsymbol{x}, t)$同方向，即<br />
\begin{equation}(d\boldsymbol{x}, dt) = (\boldsymbol{F}</em>}}, \boldsymbol{F<em _boldsymbol_x="\boldsymbol{x">t) d\tau\quad\Rightarrow\quad \frac{d\boldsymbol{x}}{dt} = \frac{\boldsymbol{F}</em>}}}{\boldsymbol{F}_t}\label{eq:ode}\end{equation
这就是生成过程所需要的微分方程（ODE）。在之前的$d$维方案中，除了有模式坍缩问题外，什么时候终止也是一个不好处理的细节问题。直观来想，就是沿着场线运动，直到撞上一个真实样本后就停止，但什么时候才是“撞上”，这个并不好判断。而在$d+1$维方案中，我们知道真实样本都是在$t=0$这个面上，所以可以很自然地以$t=0$为终止信号了。</p>
<p>至于初始分布，按照前面的讨论，应该是“半径足够大的、$d+1$维的球面均匀分布”，但既然我们是以$t=0$为终止信号，那么我们不妨固定一个足够大的$t=T$（大致是$40\sim 100$这个量级），然后在$t=T$这个平面上做采样，这样一来生成过程就变成了微分方程$\eqref{eq:ode}$从$t=T$到$t=0$的运动过程了，生成过程的始和终都变得相当明朗。</p>
<p>当然，如果在固定的$t=T$平面上采样，那肯定就不是均匀的了。事实上有：<br />
\begin{equation}p_{prior}(\boldsymbol{x}) \propto \frac{1}{(\Vert\boldsymbol{x}\Vert^2 + T^2)^{(d+1)/2}}\end{equation}<br />
推导过程见下面的框。可以看到，概率密度只依赖于模长$\Vert\boldsymbol{x}\Vert$，所以从该分布采样的方案是先按照特定的分布采样模长，然后再按均匀分布采样方向，将两者进行组合。对于模长的采样，记$r=\Vert\boldsymbol{x}\Vert$，我们将它换元到超球坐标，就可以得到$p_{prior}(r)\propto r^{d-1}(r^2 + T^2)^{-(d+1)/2}$，然后利用逆累积概率函数法进行采样就行了（参考<a href="/archives/8404#%E7%89%B9%E6%AE%8A%E6%96%B9%E5%90%91">《变分自编码器（七）：球面上的VAE（vMF-VAE）》</a>）。</p>
<blockquote>
<p><strong>初始分布的推导：</strong> 场线是均匀穿过$d+1$维超球面上的，所以$(\boldsymbol{x}, T)$处的密度是反比于$S_{d+1}(\boldsymbol{x}, T)$，即$\propto \frac{1}{(\Vert\boldsymbol{x}\Vert^2 + T^2)^{d/2}}$，但现在不是在球面，而是在$t=T$的平面上，所以我们要将球面投影到平面上，示意图如下：  </p>
<p><a href="/usr/uploads/2022/10/1762495694.svg" title="点击查看原图"><img alt="球面到t=T平面的投影" src="/usr/uploads/2022/10/1762495694.svg" /></a></p>
<p>球面到t=T平面的投影</p>
<p>如上图，当$B$、$D$两点充分接近时，有$\Delta OAB\sim \Delta BDC$，所以<br />
 \begin{equation}\frac{|BC|}{|BD|} = \frac{|OB|}{|OA|} = \frac{\sqrt{\Vert\boldsymbol{x}\Vert^2 + T^2}}{T}\end{equation}<br />
 也就是说，原本球面上单位长度的弧，投影到平面上后长度变为了$\frac{\sqrt{\Vert\boldsymbol{x}\Vert^2 + T^2}}{T}$倍，由于只有一个维度变化，所以原来球面上的面积元，投影后也变为$\frac{\sqrt{\Vert\boldsymbol{x}\Vert^2 + T^2}}{T}$倍，因此根据概率反比面积，我们可以得到<br />
 \begin{equation}p_{prior}(\boldsymbol{x}) \propto \frac{1}{S_{d+1}(\boldsymbol{x}, T)}\times \frac{T}{\sqrt{\Vert\boldsymbol{x}\Vert^2 + T^2}}\propto \frac{1}{(\Vert\boldsymbol{x}\Vert^2 + T^2)^{(d+1)/2}}\end{equation}</p>
</blockquote>
<h2 id="_8">场的训练<a class="toc-link" href="#_8" title="Permanent link">&para;</a></h2>
<p>现在，初始分布有了，微分方程也有了，所以就只差向量场函数$\boldsymbol{F}(\boldsymbol{x}, t)$的训练了。从微分方程$\eqref{eq:ode}$可以看出，它只依赖于向量场的相对值，因此向量场的缩放不影响最终结果。根据式$\eqref{eq:field}$，向量场可以写为<br />
\begin{equation}\boldsymbol{F}(\boldsymbol{x}, t) = \mathbb{E}<em _boldsymbol_x="\boldsymbol{x">{\boldsymbol{x}_0\sim \tilde{p}(\boldsymbol{x}_0)}\left[-\frac{(\boldsymbol{x} - \boldsymbol{x}_0, t)}{(\Vert\boldsymbol{x} - \boldsymbol{x}_0\Vert^2 + t^2)^{(d+1)/2}}\right]\end{equation}<br />
根据我们在<a href="/archives/9209">《生成扩散模型漫谈（五）：一般框架之SDE篇》</a>、<a href="/archives/9245">《生成扩散模型漫谈（七）：最优扩散方差估计（上）》</a>等文章多次用到一个结论：<br />
\begin{equation}\mathbb{E}</em>}}[\boldsymbol{x}] = \mathop{\text{argmin}<em _boldsymbol_x="\boldsymbol{x">{\boldsymbol{\mu}}\mathbb{E}</em>}}\left[\Vert \boldsymbol{x} - \boldsymbol{\mu}\Vert^2\right]\end{equation
我们可以引入函数$\boldsymbol{s}<em _boldsymbol_x="\boldsymbol{x">{\boldsymbol{\theta}}(\boldsymbol{x}, t)$来学习$\boldsymbol{F}(\boldsymbol{x}, t)$，训练目标为<br />
\begin{equation}\mathbb{E}</em><em _boldsymbol_theta="\boldsymbol{\theta">0\sim \tilde{p}(\boldsymbol{x}_0)}\left[\left\Vert\boldsymbol{s}</em>}}(\boldsymbol{x}, t) + \frac{(\boldsymbol{x} - \boldsymbol{x<em _boldsymbol_x="\boldsymbol{x">0, t)}{(\Vert\boldsymbol{x} - \boldsymbol{x}_0\Vert^2 + t^2)^{(d+1)/2}}\right\Vert^2\right]\label{eq:loss}\end{equation}<br />
然而，上述目标的$\boldsymbol{x},t$还需要采样，它的采样方式没有明确定义。这就是PFGM的主要特点之一，它直接定义了反向过程（生成过程），不需要定义前向过程，而这一步的采样实际上就相当于前向过程。为此，原论文考虑地每个真实样本进行扰动的方式来构建$\boldsymbol{x},t$的样本：<br />
\begin{equation}\boldsymbol{x} = \boldsymbol{x}_0 + \Vert \boldsymbol{\varepsilon}</em>}}\Vert (1+\tau)^m \boldsymbol{u},\quad t = |\varepsilon_t| (1+\tau)^m\end{equation
其中$(\boldsymbol{\varepsilon}<em _d_1_times_d_1_="(d+1)\times(d+1)">{\boldsymbol{x}},\varepsilon_t)\sim\mathcal{N}(\boldsymbol{0}, \sigma^2\boldsymbol{I}</em>$是$d$维单位球面上均匀分布的单位向量，而$\tau,\sigma,M$则都是常数。~~这个设计有颇多的主观性，大家自行欣赏和领会即可，这里不做过多展开。~~ 后续讨论请看})$，$m\sim U[0,M]$，$\boldsymbol{u<a href="/archives/9370#%E9%97%AE%E9%A2%98%E9%87%8D%E6%8B%BE">这里</a>。</p>
<p>最后，原论文的训练目标跟本文的式$\eqref{eq:loss}$略有不同，大致相当于<br />
\begin{equation}\left\Vert\boldsymbol{s}<em _boldsymbol_x="\boldsymbol{x">{\boldsymbol{\theta}}(\boldsymbol{x}, t) + \text{Normalize}\left(\mathbb{E}</em>}_0\sim \tilde{p}(\boldsymbol{x}_0)}\left[\frac{(\boldsymbol{x} - \boldsymbol{x}_0, t)}{(\Vert\boldsymbol{x} - \boldsymbol{x}_0\Vert^2 + t^2)^{(d+1)/2}}\right]\right)\right\Vert^2\end{equation
实际训练时由于只能采样有限个$\boldsymbol{x}_0$对括号里边的期望进行估算，因此该目标实际上是一个有偏估计。当然有偏不一定就比无偏更差，具体为什么原论文使用有偏估计，这里暂时不得而知，猜测是因为有偏估计由于对向量进行了归一化操作，可能会使得训练进程更加稳定，但是也因为有偏的估计进行了归一化，所以需要较大的batch_size才能比较准，这对实验成本提了要求。</p>
<h2 id="_9">实验结果<a class="toc-link" href="#_9" title="Permanent link">&para;</a></h2>
<p>可以说，PFGM是一个彻底的新框架，它不再像之前一样依赖于高斯假设，并且得到了一个确实有着全新内涵的模型。然而，我们不能“为新而新”，如果新的框架没有做出更有说服力的结果，那么新就是没有意义的。</p>
<p>当然，原论文的实验结果，肯定了PFGM的价值，比如得到了更好的评估指标、更快的生成速度，以及对超参数（包括模型架构）有更好的鲁棒性等，这里就不一一展示了，大家自行读原论文就好。我看了看原论文中了NeurIPS 2022，不得不说这确实是实至名归的顶会论文啊！</p>
<blockquote>
<p><strong>官方Github：<a href="https://github.com/Newbeeer/Poisson_flow">https://github.com/Newbeeer/Poisson_flow</a></strong></p>
</blockquote>
<p><a href="/usr/uploads/2022/10/3603165335.png" title="点击查看原图"><img alt="PFGM的实验结果（部分）" src="/usr/uploads/2022/10/3603165335.png" /></a></p>
<p>PFGM的实验结果（部分）</p>
<h2 id="_10">文章小结<a class="toc-link" href="#_10" title="Permanent link">&para;</a></h2>
<p>本文介绍了一个由“万有引力定律”启发的ODE式扩散模型，它突破了以往众多扩散模型对高斯假设的依赖，是一个基于场论来构建ODE式扩散模型的全新框架，整个模型颇多启发性，值得仔细研读。</p>
<p><em><strong>转载到请包括本文地址：</strong><a href="https://spaces.ac.cn/archives/9305">https://spaces.ac.cn/archives/9305</a></em></p>
<p><em><strong>更详细的转载事宜请参考：</strong></em><a href="https://spaces.ac.cn/archives/6508#%E6%96%87%E7%AB%A0%E5%A6%82%E4%BD%95%E8%BD%AC%E8%BD%BD/%E5%BC%95%E7%94%A8" title="《科学空间FAQ》">《科学空间FAQ》</a></p>
<p><strong>如果您还有什么疑惑或建议，欢迎在下方评论区继续讨论。</strong></p>
<p><strong>如果您觉得本文还不错，欢迎分享/打赏本文。打赏并非要从中获得收益，而是希望知道科学空间获得了多少读者的真心关注。当然，如果你无视它，也不会影响你的阅读。再次表示欢迎和感谢！</strong></p>
<p>打赏</p>
<p><img alt="科学空间" src="https://spaces.ac.cn/usr/themes/geekg/payment/wx.png" /></p>
<p>微信打赏</p>
<p><img alt="科学空间" src="https://spaces.ac.cn/usr/themes/geekg/payment/zfb.png" /></p>
<p>支付宝打赏</p>
<p>因为网站后台对打赏并无记录，因此欢迎在打赏时候备注留言。你还可以<a href="http://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&amp;email=tN7d1drY3drrx8H0xcWa19vZ"><strong>点击这里</strong></a>或在下方评论区留言来告知你的建议或需求。</p>
<p><strong>如果您需要引用本文，请参考：</strong></p>
<p>苏剑林. (Oct. 18, 2022). 《生成扩散模型漫谈（十三）：从万有引力到扩散模型 》[Blog post]. Retrieved from <a href="https://spaces.ac.cn/archives/9305">https://spaces.ac.cn/archives/9305</a></p>
<p>@online{kexuefm-9305,<br />
title={生成扩散模型漫谈（十三）：从万有引力到扩散模型},<br />
author={苏剑林},<br />
year={2022},<br />
month={Oct},<br />
url={\url{https://spaces.ac.cn/archives/9305}},<br />
} </p>
<hr />
<h2 id="_11">公式推导与注释<a class="toc-link" href="#_11" title="Permanent link">&para;</a></h2>
<p>本节提供文章中关键公式的极详细数学推导，涵盖引力场理论、Poisson方程、Green函数、势函数理论以及与扩散模型的深刻联系。</p>
<hr />
<h3 id="1">1. 引力场的基础数学形式<a class="toc-link" href="#1" title="Permanent link">&para;</a></h3>
<p><strong>推导1.1：从牛顿万有引力到向量场表示</strong></p>
<p>牛顿万有引力定律的标量形式为：</p>
<p>$$
F = G\frac{m_1 m_2}{r^2}
$$</p>
<p>其中$G$是引力常数，$m_1,m_2$是两个质点的质量，$r$是它们之间的距离。</p>
<p><strong>向量形式推导：</strong></p>
<p>考虑引力源位于$\boldsymbol{y}$，质点位于$\boldsymbol{x}$。引力方向应该是从$\boldsymbol{x}$指向$\boldsymbol{y}$，因此方向向量为：</p>
<p>$$
\frac{\boldsymbol{y} - \boldsymbol{x}}{|\boldsymbol{y} - \boldsymbol{x}|}
$$</p>
<p>引力的大小为$\frac{1}{r^2} = \frac{1}{|\boldsymbol{x} - \boldsymbol{y}|^2}$（这里我们忽略常数因子）。</p>
<p>因此，引力的向量形式为：</p>
<p>$$
\boldsymbol{F}(\boldsymbol{x}) = -\frac{\boldsymbol{x} - \boldsymbol{y}}{|\boldsymbol{x} - \boldsymbol{y}|^2} \cdot \frac{1}{|\boldsymbol{x} - \boldsymbol{y}|}
$$</p>
<p>即：</p>
<p>$$
\boldsymbol{F}(\boldsymbol{x}) = -\frac{\boldsymbol{x} - \boldsymbol{y}}{|\boldsymbol{x} - \boldsymbol{y}|^3}
$$</p>
<p>负号表示力的方向是吸引的（从$\boldsymbol{x}$指向$\boldsymbol{y}$）。</p>
<hr />
<p><strong>推导1.2：三维空间的归一化因子</strong></p>
<p>在三维空间中，为了保证场的通量守恒，我们需要引入归一化因子$\frac{1}{4\pi}$。这个因子来自于三维空间中单位球面的表面积。</p>
<p>三维空间中，半径为$R$的球面表面积为：</p>
<p>$$
S_3(R) = 4\pi R^2
$$</p>
<p>因此单位球面（$R=1$）的表面积为：</p>
<p>$$
S_3(1) = 4\pi
$$</p>
<p>考虑引力场的散度定理（Gauss定理）。对于位于原点的点质量源，引力场应该满足：</p>
<p>$$
\oint_{S} \boldsymbol{F} \cdot d\boldsymbol{S} = -1
$$</p>
<p>这意味着总通量为$-1$。如果不加归一化因子，通量将是$-4\pi$。因此，我们需要除以$4\pi$：</p>
<p>$$
\boldsymbol{F}(\boldsymbol{x}) = -\frac{1}{4\pi}\frac{\boldsymbol{x} - \boldsymbol{y}}{|\boldsymbol{x} - \boldsymbol{y}|^3}
$$</p>
<hr />
<p><strong>推导1.3：d维空间的推广</strong></p>
<p>在$d$维欧氏空间中，单位超球面的表面积公式为：</p>
<p>$$
S_d(1) = \frac{2\pi^{d/2}}{\Gamma(d/2)}
$$</p>
<p>其中$\Gamma$是Gamma函数。例如：
- $d=2$: $S_2(1) = \frac{2\pi^1}{\Gamma(1)} = 2\pi$ （圆的周长）
- $d=3$: $S_3(1) = \frac{2\pi^{3/2}}{\Gamma(3/2)} = \frac{2\pi^{3/2}}{\frac{\sqrt{\pi}}{2}} = 4\pi$ （球的表面积）
- $d=4$: $S_4(1) = \frac{2\pi^2}{\Gamma(2)} = 2\pi^2$</p>
<p>在$d$维空间中，引力场的衰减规律是$\frac{1}{r^{d-1}}$（保证通量守恒）。因此，$d$维空间的引力场形式为：</p>
<p>$$
\boldsymbol{F}(\boldsymbol{x}) = -\frac{1}{S_d(1)}\frac{\boldsymbol{x} - \boldsymbol{y}}{|\boldsymbol{x} - \boldsymbol{y}|^{d-1}} \cdot \frac{1}{|\boldsymbol{x} - \boldsymbol{y}|}
$$</p>
<p>即：</p>
<p>$$
\boldsymbol{F}(\boldsymbol{x}) = -\frac{1}{S_d(1)}\frac{\boldsymbol{x} - \boldsymbol{y}}{|\boldsymbol{x} - \boldsymbol{y}|^d}
$$</p>
<hr />
<h3 id="2-poissongreen">2. Poisson方程与Green函数<a class="toc-link" href="#2-poissongreen" title="Permanent link">&para;</a></h3>
<p><strong>推导2.1：Poisson方程的推导</strong></p>
<p>引力场$\boldsymbol{F}$与引力势$\phi$的关系为：</p>
<p>$$
\boldsymbol{F}(\boldsymbol{x}) = -\nabla \phi(\boldsymbol{x})
$$</p>
<p>这里的负号是因为力的方向是从高势能指向低势能。</p>
<p>对于位于$\boldsymbol{y}$的点质量源，其引力势在$d$维空间中的形式为：</p>
<p>$$
\phi(\boldsymbol{x}) = \frac{1}{(d-2)S_d(1)} \frac{1}{|\boldsymbol{x} - \boldsymbol{y}|^{d-2}} \quad (d &gt; 2)
$$</p>
<p><strong>验证梯度：</strong></p>
<p>我们计算$\nabla \phi(\boldsymbol{x})$。设$r = |\boldsymbol{x} - \boldsymbol{y}|$，则：</p>
<p>$$
\phi(\boldsymbol{x}) = \frac{1}{(d-2)S_d(1)} r^{-(d-2)}
$$</p>
<p>利用链式法则：</p>
<p>$$
\nabla \phi = \frac{\partial \phi}{\partial r} \nabla r
$$</p>
<p>其中：</p>
<p>$$
\frac{\partial \phi}{\partial r} = \frac{1}{(d-2)S_d(1)} \cdot (-(d-2)) r^{-(d-1)} = -\frac{1}{S_d(1)} r^{-(d-1)}
$$</p>
<p>$$
\nabla r = \nabla |\boldsymbol{x} - \boldsymbol{y}| = \frac{\boldsymbol{x} - \boldsymbol{y}}{|\boldsymbol{x} - \boldsymbol{y}|} = \frac{\boldsymbol{x} - \boldsymbol{y}}{r}
$$</p>
<p>因此：</p>
<p>$$
\nabla \phi = -\frac{1}{S_d(1)} r^{-(d-1)} \cdot \frac{\boldsymbol{x} - \boldsymbol{y}}{r} = -\frac{1}{S_d(1)} \frac{\boldsymbol{x} - \boldsymbol{y}}{r^d}
$$</p>
<p>即：</p>
<p>$$
-\nabla \phi = \frac{1}{S_d(1)} \frac{\boldsymbol{x} - \boldsymbol{y}}{|\boldsymbol{x} - \boldsymbol{y}|^d} = -\boldsymbol{F}(\boldsymbol{x})
$$</p>
<p>注意这里有个负号差异，这是因为我们定义的$\boldsymbol{F}$本身带有负号。</p>
<hr />
<p><strong>推导2.2：Poisson方程的完整形式</strong></p>
<p>引力势$\phi$满足Poisson方程：</p>
<p>$$
\nabla^2 \phi(\boldsymbol{x}) = -\rho(\boldsymbol{x})
$$</p>
<p>其中$\rho$是质量密度，$\nabla^2 = \sum_{i=1}^d \frac{\partial^2}{\partial x_i^2}$是Laplace算子。</p>
<p>对于位于$\boldsymbol{y}$的点质量源，我们有$\rho(\boldsymbol{x}) = \delta(\boldsymbol{x} - \boldsymbol{y})$，其中$\delta$是Dirac delta函数。</p>
<p>因此Poisson方程变为：</p>
<p>$$
\nabla^2 \phi(\boldsymbol{x}) = -\delta(\boldsymbol{x} - \boldsymbol{y})
$$</p>
<hr />
<p><strong>推导2.3：Green函数的定义和性质</strong></p>
<p>Poisson方程的Green函数$G(\boldsymbol{x}, \boldsymbol{y})$定义为满足：</p>
<p>$$
\nabla^2 G(\boldsymbol{x}, \boldsymbol{y}) = -\delta(\boldsymbol{x} - \boldsymbol{y})
$$</p>
<p>的函数。在$d$维空间中，Green函数的形式为：</p>
<p>$$
G(\boldsymbol{x}, \boldsymbol{y}) = \begin{cases}
\frac{1}{(d-2)S_d(1)} |\boldsymbol{x} - \boldsymbol{y}|^{-(d-2)}, &amp; d &gt; 2 \
\frac{1}{2\pi} \ln |\boldsymbol{x} - \boldsymbol{y}|, &amp; d = 2
\end{cases}
$$</p>
<p><strong>验证（以$d=3$为例）：</strong></p>
<p>对于$d=3$，$S_3(1) = 4\pi$，因此：</p>
<p>$$
G(\boldsymbol{x}, \boldsymbol{y}) = \frac{1}{4\pi |\boldsymbol{x} - \boldsymbol{y}|}
$$</p>
<p>设$r = |\boldsymbol{x} - \boldsymbol{y}|$，在$r \neq 0$的区域，我们计算Laplacian：</p>
<p>$$
\nabla^2 G = \nabla^2 \left(\frac{1}{4\pi r}\right)
$$</p>
<p>在球坐标系中：</p>
<p>$$
\nabla^2 f(r) = \frac{1}{r^2}\frac{d}{dr}\left(r^2 \frac{df}{dr}\right)
$$</p>
<p>对于$f(r) = \frac{1}{4\pi r}$：</p>
<p>$$
\frac{df}{dr} = -\frac{1}{4\pi r^2}
$$</p>
<p>$$
r^2 \frac{df}{dr} = -\frac{1}{4\pi}
$$</p>
<p>$$
\frac{d}{dr}\left(r^2 \frac{df}{dr}\right) = 0
$$</p>
<p>因此在$r \neq 0$时，$\nabla^2 G = 0$。</p>
<p>在$r = 0$处，通过积分可以验证：</p>
<p>$$
\int_V \nabla^2 G \, dV = \oint_{\partial V} \nabla G \cdot d\boldsymbol{S} = -1
$$</p>
<p>这证明了$\nabla^2 G = -\delta(\boldsymbol{x} - \boldsymbol{y})$。</p>
<hr />
<p><strong>推导2.4：Green函数的梯度与引力场的关系</strong></p>
<p>从Green函数可以得到引力场：</p>
<p>$$
\boldsymbol{F}(\boldsymbol{x}) = -\nabla_{\boldsymbol{x}} G(\boldsymbol{x}, \boldsymbol{y})
$$</p>
<p>计算梯度（以$d$维为例）：</p>
<p>$$
\nabla_{\boldsymbol{x}} G = \nabla_{\boldsymbol{x}} \left[\frac{1}{(d-2)S_d(1)} |\boldsymbol{x} - \boldsymbol{y}|^{-(d-2)}\right]
$$</p>
<p>$$
= \frac{1}{(d-2)S_d(1)} \cdot (-(d-2)) |\boldsymbol{x} - \boldsymbol{y}|^{-(d-1)} \cdot \frac{\boldsymbol{x} - \boldsymbol{y}}{|\boldsymbol{x} - \boldsymbol{y}|}
$$</p>
<p>$$
= -\frac{1}{S_d(1)} \frac{\boldsymbol{x} - \boldsymbol{y}}{|\boldsymbol{x} - \boldsymbol{y}|^d}
$$</p>
<p>因此：</p>
<p>$$
\boldsymbol{F}(\boldsymbol{x}) = -\nabla_{\boldsymbol{x}} G = \frac{1}{S_d(1)} \frac{\boldsymbol{x} - \boldsymbol{y}}{|\boldsymbol{x} - \boldsymbol{y}|^d}
$$</p>
<p>这正是我们之前推导的引力场形式（符号约定可能略有不同）。</p>
<hr />
<h3 id="3">3. 多源引力场的叠加原理<a class="toc-link" href="#3" title="Permanent link">&para;</a></h3>
<p><strong>推导3.1：引力场的线性叠加</strong></p>
<p>引力场满足线性叠加原理。如果有$N$个引力源分别位于$\boldsymbol{y}_1, \boldsymbol{y}_2, \ldots, \boldsymbol{y}_N$，则总引力场为：</p>
<p>$$
\boldsymbol{F}(\boldsymbol{x}) = \sum_{i=1}^N \boldsymbol{F}<em i="1">i(\boldsymbol{x}) = -\frac{1}{S_d(1)} \sum</em>
$$}^N \frac{\boldsymbol{x} - \boldsymbol{y}_i}{|\boldsymbol{x} - \boldsymbol{y}_i|^d</p>
<p><strong>连续分布的情况：</strong></p>
<p>如果引力源服从连续分布$\rho(\boldsymbol{y})$，则引力场变为积分形式：</p>
<p>$$
\boldsymbol{F}(\boldsymbol{x}) = -\frac{1}{S_d(1)} \int \frac{\boldsymbol{x} - \boldsymbol{y}}{|\boldsymbol{x} - \boldsymbol{y}|^d} \rho(\boldsymbol{y}) \, d\boldsymbol{y}
$$</p>
<p>这正是式$\eqref{eq:field}$在$d$维情况下的形式。</p>
<hr />
<p><strong>推导3.2：质心的计算</strong></p>
<p>对于$N$个引力源，其质心位置$\boldsymbol{y}_c$定义为：</p>
<p>$$
\boldsymbol{y}<em i="1">c = \frac{\sum</em>}^N m_i \boldsymbol{y<em i="1">i}{\sum</em>
$$}^N m_i</p>
<p>当所有质量相等时（$m_i = m$）：</p>
<p>$$
\boldsymbol{y}<em i="1">c = \frac{1}{N} \sum</em>_i
$$}^N \boldsymbol{y</p>
<p>对于连续分布$\rho(\boldsymbol{y})$，质心为：</p>
<p>$$
\boldsymbol{y}_c = \frac{\int \boldsymbol{y} \rho(\boldsymbol{y}) \, d\boldsymbol{y}}{\int \rho(\boldsymbol{y}) \, d\boldsymbol{y}}
$$</p>
<hr />
<p><strong>推导3.3：远场近似（Multipole展开）</strong></p>
<p>当观测点$\boldsymbol{x}$距离所有引力源都很远时（$|\boldsymbol{x} - \boldsymbol{y}_c| \gg |\boldsymbol{y}_i - \boldsymbol{y}_c|$ 对所有$i$成立），我们可以对引力场进行多极展开。</p>
<p>设$\boldsymbol{r} = \boldsymbol{x} - \boldsymbol{y}_c$，$\boldsymbol{r}_i = \boldsymbol{y}_i - \boldsymbol{y}_c$。则：</p>
<p>$$
\boldsymbol{x} - \boldsymbol{y}_i = \boldsymbol{r} - \boldsymbol{r}_i
$$</p>
<p>$$
|\boldsymbol{x} - \boldsymbol{y}_i|^{-d} = |\boldsymbol{r} - \boldsymbol{r}_i|^{-d}
$$</p>
<p>当$|\boldsymbol{r}| \gg |\boldsymbol{r}_i|$时，利用Taylor展开：</p>
<p>$$
|\boldsymbol{r} - \boldsymbol{r}_i|^{-d} = |\boldsymbol{r}|^{-d} \left(1 - \frac{\boldsymbol{r} \cdot \boldsymbol{r}_i}{|\boldsymbol{r}|^2}\right)^{-d/2}
$$</p>
<p>$$
\approx |\boldsymbol{r}|^{-d} \left(1 + \frac{d}{2} \frac{\boldsymbol{r} \cdot \boldsymbol{r}_i}{|\boldsymbol{r}|^2} + O(|\boldsymbol{r}_i|^2/|\boldsymbol{r}|^2)\right)
$$</p>
<p>对于$\boldsymbol{x} - \boldsymbol{y}_i$：</p>
<p>$$
\frac{\boldsymbol{x} - \boldsymbol{y}_i}{|\boldsymbol{x} - \boldsymbol{y}_i|^d} \approx \frac{\boldsymbol{r}}{|\boldsymbol{r}|^d} + O(|\boldsymbol{r}_i|/|\boldsymbol{r}|^d)
$$</p>
<p>因此，总引力场的领头项（monopole项）为：</p>
<p>$$
\boldsymbol{F}(\boldsymbol{x}) \approx -\frac{1}{S_d(1)} \sum_{i=1}^N \frac{\boldsymbol{r}}{|\boldsymbol{r}|^d} = -\frac{N}{S_d(1)} \frac{\boldsymbol{x} - \boldsymbol{y}_c}{|\boldsymbol{x} - \boldsymbol{y}_c|^d}
$$</p>
<p>这说明在远场，多源引力场等价于位于质心、总质量为所有质量之和的单一质点引力场。</p>
<hr />
<h3 id="4">4. 增加维度的数学意义<a class="toc-link" href="#4" title="Permanent link">&para;</a></h3>
<p><strong>推导4.1：$d+1$维空间中的引力场</strong></p>
<p>在原始$d$维空间中，数据点为$\boldsymbol{x} \in \mathbb{R}^d$，引力源分布为$\tilde{p}(\boldsymbol{x}_0)$。</p>
<p>引入新维度$t \in \mathbb{R}$，在$d+1$维空间$(\boldsymbol{x}, t) \in \mathbb{R}^{d+1}$中，引力源分布变为：</p>
<p>$$
p(\boldsymbol{x}_0, t_0) = \delta(t_0) \tilde{p}(\boldsymbol{x}_0)
$$</p>
<p>这意味着所有引力源都位于$t=0$的超平面上。</p>
<p>根据$d+1$维空间的引力场公式：</p>
<p>$$
\boldsymbol{F}(\boldsymbol{x}, t) = -\frac{1}{S_{d+1}(1)} \iint \frac{(\boldsymbol{x} - \boldsymbol{x}_0, t - t_0)}{\left[|\boldsymbol{x} - \boldsymbol{x}_0|^2 + (t - t_0)^2\right]^{(d+1)/2}} p(\boldsymbol{x}_0, t_0) \, d\boldsymbol{x}_0 dt_0
$$</p>
<p>代入$p(\boldsymbol{x}_0, t_0) = \delta(t_0) \tilde{p}(\boldsymbol{x}_0)$：</p>
<p>$$
\boldsymbol{F}(\boldsymbol{x}, t) = -\frac{1}{S_{d+1}(1)} \iint \frac{(\boldsymbol{x} - \boldsymbol{x}_0, t - t_0)}{\left[|\boldsymbol{x} - \boldsymbol{x}_0|^2 + (t - t_0)^2\right]^{(d+1)/2}} \delta(t_0) \tilde{p}(\boldsymbol{x}_0) \, d\boldsymbol{x}_0 dt_0
$$</p>
<p>利用Dirac delta函数的性质$\int f(t_0) \delta(t_0) dt_0 = f(0)$：</p>
<p>$$
\boldsymbol{F}(\boldsymbol{x}, t) = -\frac{1}{S_{d+1}(1)} \int \frac{(\boldsymbol{x} - \boldsymbol{x}_0, t)}{\left[|\boldsymbol{x} - \boldsymbol{x}_0|^2 + t^2\right]^{(d+1)/2}} \tilde{p}(\boldsymbol{x}_0) \, d\boldsymbol{x}_0
$$</p>
<p>这正是式$\eqref{eq:field}$。</p>
<hr />
<p><strong>推导4.2：引力场的分解</strong></p>
<p>将$\boldsymbol{F}(\boldsymbol{x}, t)$分解为：</p>
<p>$$
\boldsymbol{F}(\boldsymbol{x}, t) = (\boldsymbol{F}_{\boldsymbol{x}}, \boldsymbol{F}_t)
$$</p>
<p>其中：</p>
<p>$$
\boldsymbol{F}<em d_1="d+1">{\boldsymbol{x}}(\boldsymbol{x}, t) = -\frac{1}{S</em>_0
$$}(1)} \int \frac{\boldsymbol{x} - \boldsymbol{x}_0}{\left[|\boldsymbol{x} - \boldsymbol{x}_0|^2 + t^2\right]^{(d+1)/2}} \tilde{p}(\boldsymbol{x}_0) \, d\boldsymbol{x</p>
<p>$$
\boldsymbol{F}<em d_1="d+1">t(\boldsymbol{x}, t) = -\frac{1}{S</em>_0
$$}(1)} \int \frac{t}{\left[|\boldsymbol{x} - \boldsymbol{x}_0|^2 + t^2\right]^{(d+1)/2}} \tilde{p}(\boldsymbol{x}_0) \, d\boldsymbol{x</p>
<p><strong>对称性分析：</strong></p>
<p>注意到$\boldsymbol{F}_t$可以提取公因子$t$：</p>
<p>$$
\boldsymbol{F}<em d_1="d+1">t(\boldsymbol{x}, t) = -\frac{t}{S</em>_0
$$}(1)} \int \frac{1}{\left[|\boldsymbol{x} - \boldsymbol{x}_0|^2 + t^2\right]^{(d+1)/2}} \tilde{p}(\boldsymbol{x}_0) \, d\boldsymbol{x</p>
<p>当$t &gt; 0$时，$\boldsymbol{F}_t &lt; 0$（因为有负号），这意味着引力在$t$方向上是指向$t=0$平面的。</p>
<hr />
<p><strong>推导4.3：场线的ODE方程</strong></p>
<p>沿着引力场线运动，轨迹应满足：</p>
<p>$$
\frac{d\boldsymbol{X}(\tau)}{d\tau} = \boldsymbol{F}(\boldsymbol{X}(\tau))
$$</p>
<p>其中$\boldsymbol{X}(\tau) = (\boldsymbol{x}(\tau), t(\tau)) \in \mathbb{R}^{d+1}$，$\tau$是参数化的"时间"。</p>
<p>分解为：</p>
<p>$$
\frac{d\boldsymbol{x}}{d\tau} = \boldsymbol{F}_{\boldsymbol{x}}(\boldsymbol{x}, t)
$$</p>
<p>$$
\frac{dt}{d\tau} = \boldsymbol{F}_t(\boldsymbol{x}, t)
$$</p>
<p>我们想要以$t$作为"真实时间"，因此需要重新参数化。利用链式法则：</p>
<p>$$
\frac{d\boldsymbol{x}}{dt} = \frac{d\boldsymbol{x}/d\tau}{dt/d\tau} = \frac{\boldsymbol{F}_{\boldsymbol{x}}}{\boldsymbol{F}_t}
$$</p>
<p>这正是式$\eqref{eq:ode}$。</p>
<hr />
<p><strong>推导4.4：终止条件的数学表述</strong></p>
<p>生成过程从$t=T$开始，沿着场线运动，直到$t=0$。ODE的完整形式为：</p>
<p>$$
\begin{cases}
\frac{d\boldsymbol{x}}{dt} = \frac{\boldsymbol{F}<em prior="prior">{\boldsymbol{x}}(\boldsymbol{x}, t)}{\boldsymbol{F}_t(\boldsymbol{x}, t)} \
\boldsymbol{x}(T) \sim p</em>)
\end{cases}
$$}(\boldsymbol{x</p>
<p>求解此ODE从$t=T$到$t=0$，得到$\boldsymbol{x}(0)$作为生成样本。</p>
<p><strong>物理意义：</strong></p>
<ul>
<li>$t=T$：初始分布，对应于"无穷远"</li>
<li>$t \to 0$：沿场线逐渐接近引力源所在的超平面</li>
<li>$t=0$：终止，此时$\boldsymbol{x}(0)$应该接近某个真实样本$\boldsymbol{x}_0 \sim \tilde{p}(\boldsymbol{x}_0)$</li>
</ul>
<hr />
<h3 id="5">5. 初始分布的详细推导<a class="toc-link" href="#5" title="Permanent link">&para;</a></h3>
<p><strong>推导5.1：$d+1$维球面上的均匀分布</strong></p>
<p>在$d+1$维空间中，以原点为球心、半径为$R$的超球面表面积为：</p>
<p>$$
S_{d+1}(R) = S_{d+1}(1) \cdot R^d
$$</p>
<p>其中$S_{d+1}(1)$是单位超球面的表面积。</p>
<p>由于引力场的各向同性（在远场），场线均匀地穿过以质心（假设在原点）为球心的超球面。因此，点$(\boldsymbol{x}, t)$处的概率密度反比于该点所在超球面的表面积：</p>
<p>$$
p(\boldsymbol{x}, t) \propto \frac{1}{S_{d+1}(\sqrt{|\boldsymbol{x}|^2 + t^2})}
$$</p>
<p>$$
= \frac{1}{S_{d+1}(1) \cdot (|\boldsymbol{x}|^2 + t^2)^{d/2}}
$$</p>
<p>即：</p>
<p>$$
p(\boldsymbol{x}, t) \propto (|\boldsymbol{x}|^2 + t^2)^{-d/2}
$$</p>
<hr />
<p><strong>推导5.2：从球面投影到$t=T$平面</strong></p>
<p>现在我们固定$t=T$，需要将球面上的分布投影到$t=T$的超平面上。</p>
<p>考虑球面上的点$\boldsymbol{P} = (\boldsymbol{x}, t)$，其中$|\boldsymbol{x}|^2 + t^2 = R^2$。当$t=T$时：</p>
<p>$$
|\boldsymbol{x}|^2 = R^2 - T^2
$$</p>
<p><strong>投影的Jacobian：</strong></p>
<p>从球面到平面的投影会改变面积元。考虑从球面参数$(R, \boldsymbol{\theta})$（其中$\boldsymbol{\theta}$是角坐标）到平面参数$(\boldsymbol{x}, T)$的变换。</p>
<p>球面上的面积元为：</p>
<p>$$
dS_{sphere} = R^d d\Omega
$$</p>
<p>其中$d\Omega$是立体角元。</p>
<p>投影到平面后，面积元变为：</p>
<p>$$
dS_{plane} = d\boldsymbol{x}
$$</p>
<p>投影的几何关系：从原点$O$到球面上的点$(\boldsymbol{x}, t)$的连线，与$t=T$平面的交点为$(\boldsymbol{x}', T)$，其中：</p>
<p>$$
\boldsymbol{x}' = \boldsymbol{x} \cdot \frac{T}{t}
$$</p>
<p>但我们考虑的是固定$t=T$，因此直接在$t=T$平面上。</p>
<p><strong>另一种推导方法（使用文章中的几何关系）：</strong></p>
<p>设球面上的点$B = (\boldsymbol{x}_B, t_B)$，其在$t=T$平面上的投影为$C = (\boldsymbol{x}_C, T)$。从原点$O$到$B$的射线与$t=T$平面相交于$C$。</p>
<p>设$|\boldsymbol{OB}| = R = \sqrt{|\boldsymbol{x}_B|^2 + t_B^2}$。</p>
<p>如果$t_B = T$，则投影就是自身。但一般情况下，我们需要考虑球面上的微元如何投影。</p>
<p><strong>简化方法：</strong></p>
<p>固定$t=T$，考虑球面上满足$|\boldsymbol{x}|^2 + T^2 = R^2$的点。此时：</p>
<p>$$
|\boldsymbol{x}| = \sqrt{R^2 - T^2}
$$</p>
<p>球面在$t=T$处的"切片"是一个$d$维球面（嵌入在$d+1$维空间的$t=T$超平面中）。</p>
<p><strong>投影修正因子：</strong></p>
<p>根据文章中的推导，投影会引入一个修正因子。考虑球面法向量与平面法向量的夹角。</p>
<p>球面上点$(\boldsymbol{x}, T)$（满足$|\boldsymbol{x}|^2 + T^2 = R^2$）的外法向量为：</p>
<p>$$
\boldsymbol{n}_{sphere} = \frac{(\boldsymbol{x}, T)}{R}
$$</p>
<p>平面$t=T$的法向量为：</p>
<p>$$
\boldsymbol{n}_{plane} = (0, \ldots, 0, 1)
$$</p>
<p>投影的面积修正因子为：</p>
<p>$$
\frac{dS_{plane}}{dS_{sphere}} = \frac{\boldsymbol{n}<em plane="plane">{sphere} \cdot \boldsymbol{n}</em>}}{|\boldsymbol{n<em plane="plane">{sphere}| |\boldsymbol{n}</em>
$$}|} = \frac{T}{R} = \frac{T}{\sqrt{|\boldsymbol{x}|^2 + T^2}</p>
<p>因此：</p>
<p>$$
dS_{plane} = \frac{T}{\sqrt{|\boldsymbol{x}|^2 + T^2}} dS_{sphere}
$$</p>
<p>由于概率密度反比于面积，我们有：</p>
<p>$$
p_{plane}(\boldsymbol{x}) = p_{sphere}(\boldsymbol{x}, T) \cdot \frac{\sqrt{|\boldsymbol{x}|^2 + T^2}}{T}
$$</p>
<p>其中：</p>
<p>$$
p_{sphere}(\boldsymbol{x}, T) \propto (|\boldsymbol{x}|^2 + T^2)^{-d/2}
$$</p>
<p>因此：</p>
<p>$$
p_{plane}(\boldsymbol{x}) \propto (|\boldsymbol{x}|^2 + T^2)^{-d/2} \cdot \frac{\sqrt{|\boldsymbol{x}|^2 + T^2}}{T}
$$</p>
<p>$$
= \frac{1}{T} (|\boldsymbol{x}|^2 + T^2)^{-d/2 + 1/2}
$$</p>
<p>$$
= \frac{1}{T} (|\boldsymbol{x}|^2 + T^2)^{-(d-1)/2}
$$</p>
<p>但这与文章中的$(|\boldsymbol{x}|^2 + T^2)^{-(d+1)/2}$不一致。让我重新检查。</p>
<p><strong>重新推导（基于通量守恒）：</strong></p>
<p>实际上，文章中使用的是通量的角度。引力场线均匀穿过球面，因此在球面上点$(\boldsymbol{x}, T)$处的通量密度为：</p>
<p>$$
\Phi \propto \frac{1}{S_{d+1}(\sqrt{|\boldsymbol{x}|^2 + T^2})} = \frac{1}{(|\boldsymbol{x}|^2 + T^2)^{d/2}}
$$</p>
<p>现在我们要将这个通量投影到$t=T$平面。通量的投影需要考虑方向。</p>
<p>引力场在$(\boldsymbol{x}, T)$处的方向大致指向原点（更准确地说，指向$t=0$平面上的质心）。设引力场为$\boldsymbol{F} = (\boldsymbol{F}_{\boldsymbol{x}}, \boldsymbol{F}_t)$。</p>
<p>通过$t=T$平面的通量密度为：</p>
<p>$$
\Phi_{plane} = |\boldsymbol{F}_t|
$$</p>
<p>而球面通量密度为：</p>
<p>$$
\Phi_{sphere} = |\boldsymbol{F}|
$$</p>
<p>因此：</p>
<p>$$
\frac{\Phi_{plane}}{\Phi_{sphere}} = \frac{|\boldsymbol{F}_t|}{|\boldsymbol{F}|}
$$</p>
<p>对于单源引力场（质心在原点），在$(\boldsymbol{x}, T)$处：</p>
<p>$$
\boldsymbol{F} \propto -\frac{(\boldsymbol{x}, T)}{(|\boldsymbol{x}|^2 + T^2)^{(d+1)/2}}
$$</p>
<p>$$
\boldsymbol{F}_t \propto -\frac{T}{(|\boldsymbol{x}|^2 + T^2)^{(d+1)/2}}
$$</p>
<p>$$
|\boldsymbol{F}| \propto \frac{1}{(|\boldsymbol{x}|^2 + T^2)^{(d-1)/2}}
$$</p>
<p>等等，这里有问题。让我重新计算$|\boldsymbol{F}|$：</p>
<p>$$
|\boldsymbol{F}|^2 = |\boldsymbol{F}_{\boldsymbol{x}}|^2 + \boldsymbol{F}_t^2
$$</p>
<p>$$
= \frac{|\boldsymbol{x}|^2}{(|\boldsymbol{x}|^2 + T^2)^{d+1}} + \frac{T^2}{(|\boldsymbol{x}|^2 + T^2)^{d+1}}
$$</p>
<p>$$
= \frac{|\boldsymbol{x}|^2 + T^2}{(|\boldsymbol{x}|^2 + T^2)^{d+1}}
$$</p>
<p>$$
= \frac{1}{(|\boldsymbol{x}|^2 + T^2)^d}
$$</p>
<p>因此：</p>
<p>$$
|\boldsymbol{F}| = \frac{1}{(|\boldsymbol{x}|^2 + T^2)^{d/2}}
$$</p>
<p>而：</p>
<p>$$
|\boldsymbol{F}_t| = \frac{T}{(|\boldsymbol{x}|^2 + T^2)^{(d+1)/2}}
$$</p>
<p>所以：</p>
<p>$$
\frac{|\boldsymbol{F}_t|}{|\boldsymbol{F}|} = \frac{T/(|\boldsymbol{x}|^2 + T^2)^{(d+1)/2}}{1/(|\boldsymbol{x}|^2 + T^2)^{d/2}} = \frac{T}{(|\boldsymbol{x}|^2 + T^2)^{1/2}}
$$</p>
<p>球面上的概率密度反比于$|\boldsymbol{F}|$（这是因为概率密度代表场线密度，而场线越密集，通量越大）：</p>
<p>$$
p_{sphere} \propto (|\boldsymbol{x}|^2 + T^2)^{d/2}
$$</p>
<p>不对，应该是反比，即：</p>
<p>$$
p_{sphere} \propto \frac{1}{(|\boldsymbol{x}|^2 + T^2)^{d/2}}
$$</p>
<p>投影到平面后：</p>
<p>$$
p_{plane} \propto p_{sphere} \cdot \frac{(|\boldsymbol{x}|^2 + T^2)^{1/2}}{T}
$$</p>
<p>$$
= \frac{1}{(|\boldsymbol{x}|^2 + T^2)^{d/2}} \cdot \frac{(|\boldsymbol{x}|^2 + T^2)^{1/2}}{T}
$$</p>
<p>$$
= \frac{1}{T(|\boldsymbol{x}|^2 + T^2)^{(d-1)/2}}
$$</p>
<p>仍然不对。让我再仔细看文章中的推导。</p>
<p><strong>文章中的推导：</strong></p>
<p>文章说概率密度反比于$S_{d+1}(\boldsymbol{x}, T)$，即反比于$(|\boldsymbol{x}|^2 + T^2)^{d/2}$。然后投影时乘以$\frac{T}{\sqrt{|\boldsymbol{x}|^2 + T^2}}$，最终得到：</p>
<p>$$
p_{prior}(\boldsymbol{x}) \propto \frac{1}{(|\boldsymbol{x}|^2 + T^2)^{d/2}} \times \frac{T}{\sqrt{|\boldsymbol{x}|^2 + T^2}}
$$</p>
<p>$$
= \frac{T}{(|\boldsymbol{x}|^2 + T^2)^{(d+1)/2}}
$$</p>
<p>去掉常数$T$，得到：</p>
<p>$$
p_{prior}(\boldsymbol{x}) \propto \frac{1}{(|\boldsymbol{x}|^2 + T^2)^{(d+1)/2}}
$$</p>
<p>好的，这是文章中的结果。</p>
<hr />
<p><strong>推导5.3：从径向分布采样</strong></p>
<p>初始分布为：</p>
<p>$$
p_{prior}(\boldsymbol{x}) = \frac{C}{(|\boldsymbol{x}|^2 + T^2)^{(d+1)/2}}
$$</p>
<p>其中$C$是归一化常数。</p>
<p>将$\boldsymbol{x}$分解为模长和方向：$\boldsymbol{x} = r \boldsymbol{u}$，其中$r = |\boldsymbol{x}|$，$\boldsymbol{u}$是单位方向向量。</p>
<p>在超球坐标中：</p>
<p>$$
d\boldsymbol{x} = r^{d-1} dr \, d\Omega
$$</p>
<p>其中$d\Omega$是$d$维单位球面上的立体角元。</p>
<p>因此：</p>
<p>$$
p_{prior}(r, \boldsymbol{u}) = p_{prior}(\boldsymbol{x}) \cdot r^{d-1}
$$</p>
<p>$$
= \frac{C \cdot r^{d-1}}{(r^2 + T^2)^{(d+1)/2}}
$$</p>
<p>边缘分布：</p>
<p>$$
p_{prior}(r) = \int p_{prior}(r, \boldsymbol{u}) \, d\Omega = \frac{C' \cdot r^{d-1}}{(r^2 + T^2)^{(d+1)/2}}
$$</p>
<p>其中$C' = C \cdot S_d(1)$。</p>
<p>$$
p_{prior}(\boldsymbol{u}) = \frac{1}{S_d(1)} \quad \text{(均匀分布)}
$$</p>
<p><strong>采样方法：</strong></p>
<ol>
<li>从均匀分布采样方向$\boldsymbol{u} \sim \text{Uniform}(S_d(1))$</li>
<li>从径向分布采样模长$r \sim p_{prior}(r)$</li>
</ol>
<p>对于第2步，可以使用逆累积分布函数（inverse CDF）方法或rejection sampling。</p>
<hr />
<h3 id="6-poisson">6. Poisson方程与扩散方程的类比<a class="toc-link" href="#6-poisson" title="Permanent link">&para;</a></h3>
<p><strong>推导6.1：热方程（扩散方程）</strong></p>
<p>热方程描述热量在空间中的扩散：</p>
<p>$$
\frac{\partial u}{\partial t} = \kappa \nabla^2 u
$$</p>
<p>其中$u(\boldsymbol{x}, t)$是温度，$\kappa$是热扩散系数。</p>
<p>对于初始条件$u(\boldsymbol{x}, 0) = u_0(\boldsymbol{x})$，热方程的解可以通过Green函数表示：</p>
<p>$$
u(\boldsymbol{x}, t) = \int G(\boldsymbol{x} - \boldsymbol{x}', t) u_0(\boldsymbol{x}') \, d\boldsymbol{x}'
$$</p>
<p>其中$G(\boldsymbol{x}, t)$是热核（heat kernel）：</p>
<p>$$
G(\boldsymbol{x}, t) = \frac{1}{(4\pi \kappa t)^{d/2}} \exp\left(-\frac{|\boldsymbol{x}|^2}{4\kappa t}\right)
$$</p>
<hr />
<p><strong>推导6.2：Poisson方程与稳态热方程</strong></p>
<p>Poisson方程：</p>
<p>$$
\nabla^2 \phi = -\rho
$$</p>
<p>可以看作热方程的稳态版本。当$\frac{\partial u}{\partial t} = 0$时，热方程变为：</p>
<p>$$
\nabla^2 u = 0 \quad \text{(Laplace方程)}
$$</p>
<p>如果有热源$\rho(\boldsymbol{x})$，则变为：</p>
<p>$$
\nabla^2 u = \rho
$$</p>
<p>这正是Poisson方程的形式（符号差异）。</p>
<p><strong>物理类比：</strong></p>
<ul>
<li>引力势$\phi$：对应温度$u$</li>
<li>引力场$\boldsymbol{F} = -\nabla \phi$：对应热流$\boldsymbol{J} = -\kappa \nabla u$（Fourier定律）</li>
<li>质量分布$\rho$：对应热源</li>
</ul>
<hr />
<p><strong>推导6.3：扩散模型中的前向过程</strong></p>
<p>在扩散模型中，前向过程通常是：</p>
<p>$$
q(\boldsymbol{x}_t | \boldsymbol{x}_0) = \mathcal{N}(\boldsymbol{x}_t; \sqrt{\bar{\alpha}_t} \boldsymbol{x}_0, (1 - \bar{\alpha}_t) \boldsymbol{I})
$$</p>
<p>其中$\bar{\alpha}_t$是时间相关的系数。</p>
<p>这可以看作是从点源$\boldsymbol{x}_0$出发的热扩散过程，时间$t$后的分布为一个以$\boldsymbol{x}_0$为中心的高斯分布。</p>
<p><strong>对比：</strong></p>
<ul>
<li><strong>扩散模型</strong>：从数据点$\boldsymbol{x}_0$出发，加噪声扩散到$\boldsymbol{x}_t$</li>
<li><strong>PFGM</strong>：从远处的点$\boldsymbol{x}_T$出发，沿引力场线收缩到数据点$\boldsymbol{x}_0$</li>
</ul>
<p>两者是"相反"的过程，但都利用了场论的思想。</p>
<hr />
<h3 id="7">7. 势函数理论与得分函数的对应关系<a class="toc-link" href="#7" title="Permanent link">&para;</a></h3>
<p><strong>推导7.1：得分函数的定义</strong></p>
<p>在扩散模型中，得分函数定义为对数概率密度的梯度：</p>
<p>$$
\boldsymbol{s}(\boldsymbol{x}, t) = \nabla_{\boldsymbol{x}} \log p_t(\boldsymbol{x})
$$</p>
<p><strong>得分函数的物理意义：</strong></p>
<p>得分函数指向概率密度增加最快的方向，类似于"概率场"的梯度。</p>
<hr />
<p><strong>推导7.2：引力势与概率的对应</strong></p>
<p>在PFGM中，引力场$\boldsymbol{F}$与引力势$\phi$的关系为：</p>
<p>$$
\boldsymbol{F} = -\nabla \phi
$$</p>
<p>类比地，我们可以定义"概率势"$\Phi(\boldsymbol{x}, t)$，使得：</p>
<p>$$
\boldsymbol{s}(\boldsymbol{x}, t) = \nabla \Phi(\boldsymbol{x}, t)
$$</p>
<p>其中：</p>
<p>$$
\Phi(\boldsymbol{x}, t) = \log p_t(\boldsymbol{x})
$$</p>
<p>因此：</p>
<p>$$
\boldsymbol{F} = -\nabla \phi \quad \leftrightarrow \quad \boldsymbol{s} = \nabla \Phi = \nabla \log p
$$</p>
<p><strong>对比：</strong></p>
<table>
<thead>
<tr>
<th>引力场论</th>
<th>扩散模型</th>
</tr>
</thead>
<tbody>
<tr>
<td>引力势$\phi$</td>
<td>概率势$\Phi = \log p$</td>
</tr>
<tr>
<td>引力场$\boldsymbol{F} = -\nabla \phi$</td>
<td>得分$\boldsymbol{s} = \nabla \log p$</td>
</tr>
<tr>
<td>质量分布$\rho$</td>
<td>数据分布$p_{data}$</td>
</tr>
</tbody>
</table>
<p>注意符号的差异：引力是吸引的（负梯度），而得分是指向高概率区域的（正梯度）。</p>
<hr />
<p><strong>推导7.3：得分匹配与引力场学习</strong></p>
<p>在标准的得分匹配中，训练目标为：</p>
<p>$$
\mathbb{E}<em _boldsymbol_theta="\boldsymbol{\theta">{p_t(\boldsymbol{x})} \left[|\boldsymbol{s}</em>)|^2\right]
$$}}(\boldsymbol{x}, t) - \nabla_{\boldsymbol{x}} \log p_t(\boldsymbol{x</p>
<p>在PFGM中，训练目标为：</p>
<p>$$
\mathbb{E}<em forward="forward">{p</em>}(\boldsymbol{x}, t)} \left[\left|\boldsymbol{F<em true="true">{\boldsymbol{\theta}}(\boldsymbol{x}, t) - \boldsymbol{F}</em>, t)\right|^2\right]
$$}(\boldsymbol{x</p>
<p>其中$\boldsymbol{F}_{true}$是真实引力场。</p>
<p>两者都是通过最小化平方误差来学习目标场函数。</p>
<hr />
<p><strong>推导7.4：得分函数的积分表示</strong></p>
<p>对于扩散过程$q(\boldsymbol{x}_t | \boldsymbol{x}_0) = \mathcal{N}(\boldsymbol{x}_t; \sqrt{\bar{\alpha}_t} \boldsymbol{x}_0, (1 - \bar{\alpha}_t) \boldsymbol{I})$，边缘分布为：</p>
<p>$$
p_t(\boldsymbol{x}<em data="data">t) = \int q(\boldsymbol{x}_t | \boldsymbol{x}_0) p</em>_0
$$}(\boldsymbol{x}_0) \, d\boldsymbol{x</p>
<p>得分函数为：</p>
<p>$$
\nabla_{\boldsymbol{x}<em _boldsymbol_x="\boldsymbol{x">t} \log p_t(\boldsymbol{x}_t) = \frac{\nabla</em>
$$}_t} p_t(\boldsymbol{x}_t)}{p_t(\boldsymbol{x}_t)</p>
<p>可以证明（通过Tweedie公式）：</p>
<p>$$
\nabla_{\boldsymbol{x}<em p__data="p_{data">t} \log p_t(\boldsymbol{x}_t) = -\frac{1}{1 - \bar{\alpha}_t} \mathbb{E}</em>_t\right]
$$}(\boldsymbol{x}_0)} \left[\boldsymbol{x}_t - \sqrt{\bar{\alpha}_t} \boldsymbol{x}_0 \,\Big|\, \boldsymbol{x</p>
<p>这是一个关于$\boldsymbol{x}_0$的期望，类似于PFGM中引力场的积分表示。</p>
<hr />
<h3 id="8">8. 能量泛函与梯度流<a class="toc-link" href="#8" title="Permanent link">&para;</a></h3>
<p><strong>推导8.1：Wasserstein梯度流</strong></p>
<p>在最优传输理论中，Wasserstein-2距离定义为：</p>
<p>$$
W_2(p, q)^2 = \inf_{\pi \in \Pi(p, q)} \int |\boldsymbol{x} - \boldsymbol{y}|^2 \, d\pi(\boldsymbol{x}, \boldsymbol{y})
$$</p>
<p>其中$\Pi(p, q)$是边缘分布为$p$和$q$的所有耦合。</p>
<p><strong>KL散度的Wasserstein梯度流：</strong></p>
<p>考虑泛函：</p>
<p>$$
F[p] = \text{KL}(p | p_{data}) = \int p(\boldsymbol{x}) \log \frac{p(\boldsymbol{x})}{p_{data}(\boldsymbol{x})} \, d\boldsymbol{x}
$$</p>
<p>此泛函在Wasserstein度量下的梯度流为：</p>
<p>$$
\frac{\partial p}{\partial t} = \nabla \cdot (p \nabla \log \frac{p}{p_{data}})
$$</p>
<p>$$
= \nabla \cdot (p (\nabla \log p - \nabla \log p_{data}))
$$</p>
<p>这是一个Fokker-Planck方程。</p>
<p><strong>对应的SDE：</strong></p>
<p>$$
d\boldsymbol{x} = -\nabla \log \frac{p_t(\boldsymbol{x})}{p_{data}(\boldsymbol{x})} \, dt + \sqrt{2} \, d\boldsymbol{w}
$$</p>
<p>当$p_t \to p_{data}$时，漂移项趋于零。</p>
<hr />
<p><strong>推导8.2：引力势的能量泛函</strong></p>
<p>在引力场论中，引力势能为：</p>
<p>$$
E[\rho] = \frac{1}{2} \int \rho(\boldsymbol{x}) \phi(\boldsymbol{x}) \, d\boldsymbol{x}
$$</p>
<p>其中$\phi$是由质量分布$\rho$产生的引力势，满足Poisson方程：</p>
<p>$$
\nabla^2 \phi = -\rho
$$</p>
<p><strong>能量的变分：</strong></p>
<p>对$E[\rho]$进行变分（固定总质量$\int \rho \, d\boldsymbol{x} = M$），可以得到平衡条件。</p>
<p>引力势能的梯度流（在适当的度量下）描述了质量分布如何演化。</p>
<p><strong>与PFGM的联系：</strong></p>
<p>PFGM的引力场可以看作是最小化某种能量泛函的梯度流。具体地，引力势能与数据分布的"聚集程度"相关。</p>
<hr />
<p><strong>推导8.3：从能量到概率的映射</strong></p>
<p>Boltzmann分布给出了能量$E(\boldsymbol{x})$与概率的关系：</p>
<p>$$
p(\boldsymbol{x}) = \frac{1}{Z} \exp(-\beta E(\boldsymbol{x}))
$$</p>
<p>其中$Z$是配分函数，$\beta$是逆温度。</p>
<p>对数概率为：</p>
<p>$$
\log p(\boldsymbol{x}) = -\beta E(\boldsymbol{x}) - \log Z
$$</p>
<p>因此：</p>
<p>$$
\nabla \log p(\boldsymbol{x}) = -\beta \nabla E(\boldsymbol{x})
$$</p>
<p><strong>在PFGM中的应用：</strong></p>
<p>如果我们定义"引力势能"为：</p>
<p>$$
E(\boldsymbol{x}, t) = -\log p_t(\boldsymbol{x}, t)
$$</p>
<p>则：</p>
<p>$$
\nabla E = -\nabla \log p_t = -\boldsymbol{s}(\boldsymbol{x}, t)
$$</p>
<p>引力场可以看作是能量的负梯度：</p>
<p>$$
\boldsymbol{F} \propto -\nabla E = \nabla \log p_t
$$</p>
<p>这建立了物理势能与概率密度之间的映射。</p>
<hr />
<h3 id="9">9. 场线的几何性质<a class="toc-link" href="#9" title="Permanent link">&para;</a></h3>
<p><strong>推导9.1：场线不相交定理</strong></p>
<p>对于连续的向量场$\boldsymbol{F}(\boldsymbol{x}, t)$，场线满足ODE：</p>
<p>$$
\frac{d\boldsymbol{x}}{dt} = \boldsymbol{F}(\boldsymbol{x}, t)
$$</p>
<p><strong>定理：</strong> 如果$\boldsymbol{F}$连续且满足Lipschitz条件，则通过不同初始点的场线不会相交。</p>
<p><strong>证明：</strong> 反证法。假设两条场线相交于点$(\boldsymbol{x}_0, t_0)$。则存在两个不同的初始条件导致相同的解，这与ODE解的唯一性定理矛盾。</p>
<p><strong>推论：</strong> 在PFGM中，从$t=T$平面上不同点出发的场线，在$t &lt; T$时不会相交（除非到达$t=0$平面上的同一个数据点）。</p>
<hr />
<p><strong>推导9.2：场线的保测度性质</strong></p>
<p>对于哈密顿系统或某些特殊的向量场，场线流保持相空间的测度（Liouville定理）。</p>
<p>对于PFGM的向量场，我们考虑概率密度$p(\boldsymbol{x}, t)$沿场线的演化。</p>
<p><strong>Fokker-Planck方程：</strong></p>
<p>如果场线流由$\frac{d\boldsymbol{x}}{dt} = \boldsymbol{F}(\boldsymbol{x}, t)$给出，则概率密度满足：</p>
<p>$$
\frac{\partial p}{\partial t} + \nabla \cdot (p \boldsymbol{F}) = 0
$$</p>
<p>这是连续性方程，表达了概率守恒。</p>
<p>展开：</p>
<p>$$
\frac{\partial p}{\partial t} + \boldsymbol{F} \cdot \nabla p + p (\nabla \cdot \boldsymbol{F}) = 0
$$</p>
<p>如果$\nabla \cdot \boldsymbol{F} = 0$（无散场），则：</p>
<p>$$
\frac{\partial p}{\partial t} + \boldsymbol{F} \cdot \nabla p = 0
$$</p>
<p>这意味着$p$沿场线保持不变（对流方程）。</p>
<hr />
<p><strong>推导9.3：场线的长度与作用量</strong></p>
<p>场线的长度可以定义为：</p>
<p>$$
L = \int_{t_0}^{t_1} \left|\frac{d\boldsymbol{x}}{dt}\right| \, dt = \int_{t_0}^{t_1} |\boldsymbol{F}(\boldsymbol{x}(t), t)| \, dt
$$</p>
<p>在物理中，作用量定义为：</p>
<p>$$
S = \int_{t_0}^{t_1} \mathcal{L}(\boldsymbol{x}, \dot{\boldsymbol{x}}, t) \, dt
$$</p>
<p>其中$\mathcal{L}$是Lagrangian。</p>
<p>对于引力场，可以定义动能与势能的Lagrangian：</p>
<p>$$
\mathcal{L} = \frac{1}{2} |\dot{\boldsymbol{x}}|^2 - \phi(\boldsymbol{x}, t)
$$</p>
<p>最小作用量原理导出运动方程（Euler-Lagrange方程）。</p>
<p><strong>与ODE的关系：</strong></p>
<p>PFGM的ODE是一个特定的场线方程，但不一定对应于最小作用量原理。然而，可以通过变分方法研究场线的性质。</p>
<hr />
<h3 id="10">10. 训练目标的深入分析<a class="toc-link" href="#10" title="Permanent link">&para;</a></h3>
<p><strong>推导10.1：期望与最优化的关系</strong></p>
<p>PFGM的训练目标（式$\eqref{eq:loss}$）为：</p>
<p>$$
\mathcal{L}(\boldsymbol{\theta}) = \mathbb{E}<em _boldsymbol_theta="\boldsymbol{\theta">{p(\boldsymbol{x}_0, \boldsymbol{x}, t)} \left[\left|\boldsymbol{F}</em>_0)\right|^2\right]
$$}}(\boldsymbol{x}, t) - \boldsymbol{F}_{target}(\boldsymbol{x}, t, \boldsymbol{x</p>
<p>其中：</p>
<p>$$
\boldsymbol{F}_{target}(\boldsymbol{x}, t, \boldsymbol{x}_0) = -\frac{(\boldsymbol{x} - \boldsymbol{x}_0, t)}{(|\boldsymbol{x} - \boldsymbol{x}_0|^2 + t^2)^{(d+1)/2}}
$$</p>
<p><strong>最优解：</strong></p>
<p>对于固定的$(\boldsymbol{x}, t)$，最优的$\boldsymbol{F}_{\boldsymbol{\theta}}$是：</p>
<p>$$
\boldsymbol{F}<em _boldsymbol_x="\boldsymbol{x">{\boldsymbol{\theta}}^*(\boldsymbol{x}, t) = \mathbb{E}</em><em target="target">0 | \boldsymbol{x}, t} [\boldsymbol{F}</em>_0)]
$$}(\boldsymbol{x}, t, \boldsymbol{x</p>
<p>这正是真实引力场$\boldsymbol{F}_{true}(\boldsymbol{x}, t)$的定义。</p>
<p><strong>证明：</strong> 对于平方损失，最优预测是条件期望。设$Y = \boldsymbol{F}_{target}$，则：</p>
<p>$$
\min_{\boldsymbol{\mu}} \mathbb{E}[|Y - \boldsymbol{\mu}|^2] = \mathbb{E}[|Y - \mathbb{E}[Y]|^2]
$$</p>
<p>当$\boldsymbol{\mu} = \mathbb{E}[Y]$时达到最小。</p>
<hr />
<p><strong>推导10.2：前向过程的采样分布</strong></p>
<p>文章中定义的前向过程为：</p>
<p>$$
\boldsymbol{x} = \boldsymbol{x}<em _boldsymbol_x="\boldsymbol{x">0 + |\boldsymbol{\varepsilon}</em>
$$}}| (1+\tau)^m \boldsymbol{u</p>
<p>$$
t = |\varepsilon_t| (1+\tau)^m
$$</p>
<p>其中$(\boldsymbol{\varepsilon}<em d_1="d+1">{\boldsymbol{x}}, \varepsilon_t) \sim \mathcal{N}(\boldsymbol{0}, \sigma^2 \boldsymbol{I}</em>$是均匀方向。})$，$m \sim U[0, M]$，$\boldsymbol{u</p>
<p><strong>分析：</strong></p>
<p>这个设计使得$(\boldsymbol{x}, t)$在$d+1$维空间中大致均匀地分布在各个尺度上。</p>
<ul>
<li>$(1+\tau)^m$：指数增长，覆盖从小到大的尺度</li>
<li>$|\boldsymbol{\varepsilon}_{\boldsymbol{x}}|$：径向随机性</li>
<li>$\boldsymbol{u}$：角向均匀性</li>
</ul>
<p><strong>与标准扩散的对比：</strong></p>
<p>标准扩散模型使用$\boldsymbol{x}_t = \sqrt{\bar{\alpha}_t} \boldsymbol{x}_0 + \sqrt{1 - \bar{\alpha}_t} \boldsymbol{\varepsilon}$，这是各向同性的高斯噪声。</p>
<p>PFGM的前向过程更加灵活，不依赖于高斯假设。</p>
<hr />
<p><strong>推导10.3：归一化的影响</strong></p>
<p>文章提到原论文使用了归一化的目标：</p>
<p>$$
\mathcal{L}<em _boldsymbol_theta="\boldsymbol{\theta">{normalized} = \left|\boldsymbol{F}</em>])\right|^2
$$}} - \text{Normalize}(\mathbb{E}[\boldsymbol{F}_{target</p>
<p>其中Normalize表示归一化为单位向量。</p>
<p><strong>归一化的作用：</strong></p>
<ol>
<li><strong>尺度不变性</strong>：只关心方向，不关心大小</li>
<li><strong>数值稳定性</strong>：避免梯度爆炸或消失</li>
<li><strong>几何意义</strong>：优化"方向"而非"强度"</li>
</ol>
<p><strong>缺点：</strong></p>
<ul>
<li><strong>有偏估计</strong>：$\text{Normalize}(\mathbb{E}[X]) \neq \mathbb{E}[\text{Normalize}(X)]$</li>
<li><strong>需要大batch size</strong>：为了准确估计期望</li>
</ul>
<hr />
<h3 id="11">11. 与其他生成模型的理论联系<a class="toc-link" href="#11" title="Permanent link">&para;</a></h3>
<p><strong>推导11.1：与Normalizing Flow的关系</strong></p>
<p>Normalizing Flow通过可逆变换$\boldsymbol{f}: \mathbb{R}^d \to \mathbb{R}^d$建立分布之间的映射：</p>
<p>$$
\boldsymbol{x} = \boldsymbol{f}(\boldsymbol{z}), \quad \boldsymbol{z} \sim p_{prior}
$$</p>
<p>概率密度的变换公式为：</p>
<p>$$
p_{\boldsymbol{x}}(\boldsymbol{x}) = p_{\boldsymbol{z}}(\boldsymbol{f}^{-1}(\boldsymbol{x})) \left|\det \frac{\partial \boldsymbol{f}^{-1}}{\partial \boldsymbol{x}}\right|
$$</p>
<p><strong>与ODE Flow的联系：</strong></p>
<p>连续的Normalizing Flow可以表示为ODE：</p>
<p>$$
\frac{d\boldsymbol{x}}{dt} = \boldsymbol{v}(\boldsymbol{x}, t)
$$</p>
<p>从$t=0$到$t=T$求解此ODE，得到变换$\boldsymbol{x}_T = \boldsymbol{f}(\boldsymbol{x}_0)$。</p>
<p>PFGM的ODE$\frac{d\boldsymbol{x}}{dt} = \frac{\boldsymbol{F}_{\boldsymbol{x}}}{\boldsymbol{F}_t}$类似，但速度场$\boldsymbol{v}$的定义不同。</p>
<hr />
<p><strong>推导11.2：与Score-based模型的对比</strong></p>
<p>Score-based模型学习得分函数$\boldsymbol{s}_{\boldsymbol{\theta}}(\boldsymbol{x}, t) = \nabla \log p_t(\boldsymbol{x})$，然后通过反向SDE或ODE生成样本。</p>
<p><strong>反向SDE：</strong></p>
<p>$$
d\boldsymbol{x} = [\boldsymbol{f}(\boldsymbol{x}, t) - g(t)^2 \nabla \log p_t(\boldsymbol{x})] dt + g(t) d\boldsymbol{w}
$$</p>
<p><strong>反向ODE（Probability Flow ODE）：</strong></p>
<p>$$
\frac{d\boldsymbol{x}}{dt} = \boldsymbol{f}(\boldsymbol{x}, t) - \frac{1}{2} g(t)^2 \nabla \log p_t(\boldsymbol{x})
$$</p>
<p><strong>PFGM与Score-based的对比：</strong></p>
<table>
<thead>
<tr>
<th>特性</th>
<th>Score-based</th>
<th>PFGM</th>
</tr>
</thead>
<tbody>
<tr>
<td>学习目标</td>
<td>得分函数$\nabla \log p_t$</td>
<td>引力场$\boldsymbol{F}$</td>
</tr>
<tr>
<td>前向过程</td>
<td>高斯扩散</td>
<td>不明确（隐式）</td>
</tr>
<tr>
<td>反向过程</td>
<td>SDE或ODE</td>
<td>ODE</td>
</tr>
<tr>
<td>理论基础</td>
<td>随机过程</td>
<td>场论</td>
</tr>
</tbody>
</table>
<hr />
<p><strong>推导11.3：与VAE的能量观点</strong></p>
<p>VAE的ELBO可以写为：</p>
<p>$$
\mathcal{L} = \mathbb{E}_{q(\boldsymbol{z}|\boldsymbol{x})} [\log p(\boldsymbol{x}|\boldsymbol{z})] - \text{KL}(q(\boldsymbol{z}|\boldsymbol{x}) | p(\boldsymbol{z}))
$$</p>
<p>从能量观点，可以定义：</p>
<p>$$
E(\boldsymbol{x}, \boldsymbol{z}) = -\log p(\boldsymbol{x}, \boldsymbol{z})
$$</p>
<p>则VAE试图最小化自由能：</p>
<p>$$
F(\boldsymbol{x}) = -\log p(\boldsymbol{x}) = -\log \int e^{-E(\boldsymbol{x}, \boldsymbol{z})} d\boldsymbol{z}
$$</p>
<p><strong>与PFGM的联系：</strong></p>
<p>PFGM可以看作是直接在数据空间定义能量（通过引力势），然后通过梯度流最小化能量。</p>
<hr />
<h3 id="12">12. 收敛性与稳定性分析<a class="toc-link" href="#12" title="Permanent link">&para;</a></h3>
<p><strong>推导12.1：ODE求解的误差分析</strong></p>
<p>求解ODE$\frac{d\boldsymbol{x}}{dt} = \boldsymbol{F}(\boldsymbol{x}, t)$时，常用数值方法如Euler方法：</p>
<p>$$
\boldsymbol{x}_{n+1} = \boldsymbol{x}_n + h \boldsymbol{F}(\boldsymbol{x}_n, t_n)
$$</p>
<p>其中$h$是步长。</p>
<p><strong>局部截断误差：</strong></p>
<p>Euler方法的局部截断误差为$O(h^2)$。</p>
<p><strong>全局误差：</strong></p>
<p>经过$N = T/h$步后，全局误差为$O(h)$。</p>
<p><strong>对PFGM的影响：</strong></p>
<p>生成质量依赖于ODE求解的精度。使用高阶方法（如RK4）可以提高精度，但计算成本增加。</p>
<hr />
<p><strong>推导12.2：Lipschitz连续性</strong></p>
<p>如果$\boldsymbol{F}$满足Lipschitz条件：</p>
<p>$$
|\boldsymbol{F}(\boldsymbol{x}_1, t) - \boldsymbol{F}(\boldsymbol{x}_2, t)| \leq L |\boldsymbol{x}_1 - \boldsymbol{x}_2|
$$</p>
<p>则ODE的解存在且唯一，并且对初始条件连续依赖。</p>
<p><strong>验证PFGM的引力场：</strong></p>
<p>对于单源引力场：</p>
<p>$$
\boldsymbol{F}(\boldsymbol{x}) = -\frac{\boldsymbol{x} - \boldsymbol{x}_0}{|\boldsymbol{x} - \boldsymbol{x}_0|^d}
$$</p>
<p>在远离$\boldsymbol{x}_0$的区域，$\boldsymbol{F}$是光滑的，满足Lipschitz条件。但在$\boldsymbol{x} \to \boldsymbol{x}_0$时，$\boldsymbol{F}$趋于无穷，不满足Lipschitz条件。</p>
<p><strong>解决方法：</strong></p>
<p>在实际实现中，当$|\boldsymbol{x} - \boldsymbol{x}_0|$很小时，停止积分或使用正则化。</p>
<hr />
<p><strong>推导12.3：模式覆盖与模式坍缩</strong></p>
<p><strong>模式覆盖（Mode Coverage）：</strong> 生成模型能否覆盖真实分布的所有模式。</p>
<p><strong>模式坍缩（Mode Collapse）：</strong> 生成模型只生成部分模式，忽略其他模式。</p>
<p><strong>PFGM的优势：</strong></p>
<p>通过增加维度避免了引力源的相互抵消，理论上保证了每个数据点都有对应的场线到达，从而避免模式坍缩。</p>
<p><strong>数学证明（草图）：</strong></p>
<p>在$d+1$维空间中，引力源位于$t=0$平面，不形成闭合的对称结构（如球壳），因此不会出现内部引力抵消的现象。</p>
<p>每条从$t=T$平面出发的场线，都会单调地减小$t$，最终到达$t=0$平面的某个点。</p>
<hr />
<h3 id="13">13. 计算复杂度与效率<a class="toc-link" href="#13" title="Permanent link">&para;</a></h3>
<p><strong>推导13.1：单步ODE积分的复杂度</strong></p>
<p>每步ODE积分需要计算$\boldsymbol{F}(\boldsymbol{x}, t)$，这需要一次神经网络前向传播。</p>
<p>假设网络参数量为$P$，则单步复杂度为$O(P)$。</p>
<p>总共需要$N$步（$N = T/h$），则总复杂度为$O(NP)$。</p>
<hr />
<p><strong>推导13.2：与扩散模型的对比</strong></p>
<p><strong>DDPM：</strong> 需要$T \approx 1000$步
<strong>DDIM：</strong> 可以减少到$N \approx 50$步
<strong>PFGM：</strong> 根据论文，$N \approx 100$步</p>
<p>因此，PFGM的生成速度与DDIM相当，比DDPM快。</p>
<hr />
<p><strong>推导13.3：训练成本</strong></p>
<p>训练时需要计算损失$\mathcal{L}$，每个样本需要：</p>
<ol>
<li>采样$\boldsymbol{x}<em data="data">0 \sim p</em>$</li>
<li>采样$(\boldsymbol{x}, t)$根据前向过程</li>
<li>计算$\boldsymbol{F}_{\boldsymbol{\theta}}(\boldsymbol{x}, t)$（网络前向传播）</li>
<li>计算目标$\boldsymbol{F}_{target}$</li>
<li>计算损失并反向传播</li>
</ol>
<p>总体训练成本与标准扩散模型相当。</p>
<hr />
<h3 id="14">14. 总结与展望<a class="toc-link" href="#14" title="Permanent link">&para;</a></h3>
<p>通过以上详细的数学推导，我们深入理解了PFGM的理论基础：</p>
<ol>
<li><strong>引力场理论</strong>：从牛顿万有引力出发，建立了$d$维空间的引力场数学形式</li>
<li><strong>Poisson方程与Green函数</strong>：揭示了引力势与引力场的深刻联系</li>
<li><strong>多源叠加与质心等效</strong>：证明了远场近似的合理性</li>
<li><strong>维度提升技巧</strong>：通过增加一维巧妙地避免了模式坍缩</li>
<li><strong>势函数与得分函数</strong>：建立了物理场论与概率生成模型的桥梁</li>
<li><strong>能量泛函与梯度流</strong>：从能量观点理解生成过程</li>
<li><strong>几何与拓扑性质</strong>：分析了场线的不相交性和收敛性</li>
</ol>
<p>PFGM展示了物理学与机器学习深度融合的可能性，为生成模型的研究开辟了新的方向。未来的研究可能包括：</p>
<ul>
<li>更高效的场函数表示</li>
<li>自适应的ODE求解器</li>
<li>条件生成的扩展</li>
<li>更深入的理论保证</li>
</ul>
<p>这个框架不仅在技术上创新，更重要的是它提供了一种全新的思维方式，让我们重新审视生成模型与物理世界的深刻联系。</p>
                </div>

                <!-- Previous/Next Navigation -->
                <nav class="post-navigation" aria-label="文章导航">
                    <div class="row g-3">
                        <div class="col-6">
                            
                            <a href="十字架组合计数问题浅试.html" class="nav-link-prev">
                                <div class="nav-direction"><i class="fas fa-chevron-left"></i> 上一篇</div>
                                <div class="nav-title">#57 “十字架”组合计数问题浅试</div>
                            </a>
                            
                        </div>
                        <div class="col-6">
                            
                            <a href="圆内随机n点在同一个圆心角为θ的扇形的概率.html" class="nav-link-next">
                                <div class="nav-direction">下一篇 <i class="fas fa-chevron-right"></i></div>
                                <div class="nav-title">#59 圆内随机n点在同一个圆心角为θ的扇形的概率</div>
                            </a>
                            
                        </div>
                    </div>
                </nav>

                <!-- Back to Home -->
                <div class="text-center mt-4 mb-4">
                    <a href="../index.html" class="btn btn-outline-primary">
                        <i class="fas fa-arrow-left"></i> 返回首页
                    </a>
                </div>
            </div>

            <!-- Sidebar (TOC) -->
            <div class="col-lg-3">
                <aside class="sidebar">
                    
                    <div class="toc-sidebar">
                        <h5 class="toc-title"><i class="fas fa-list"></i> 目录</h5>
                        <div class="toc-content">
                            <div class="toc">
<ul>
<li><a href="#_1">生成扩散模型漫谈（十三）：从万有引力到扩散模型</a><ul>
<li><a href="#_2">万有引力</a></li>
<li><a href="#_3">沿场线走</a></li>
<li><a href="#_4">等效质心</a></li>
<li><a href="#_5">模式坍缩</a></li>
<li><a href="#_6">增加一维</a></li>
<li><a href="#_7">豁然开朗</a></li>
<li><a href="#_8">场的训练</a></li>
<li><a href="#_9">实验结果</a></li>
<li><a href="#_10">文章小结</a></li>
<li><a href="#_11">公式推导与注释</a><ul>
<li><a href="#1">1. 引力场的基础数学形式</a></li>
<li><a href="#2-poissongreen">2. Poisson方程与Green函数</a></li>
<li><a href="#3">3. 多源引力场的叠加原理</a></li>
<li><a href="#4">4. 增加维度的数学意义</a></li>
<li><a href="#5">5. 初始分布的详细推导</a></li>
<li><a href="#6-poisson">6. Poisson方程与扩散方程的类比</a></li>
<li><a href="#7">7. 势函数理论与得分函数的对应关系</a></li>
<li><a href="#8">8. 能量泛函与梯度流</a></li>
<li><a href="#9">9. 场线的几何性质</a></li>
<li><a href="#10">10. 训练目标的深入分析</a></li>
<li><a href="#11">11. 与其他生成模型的理论联系</a></li>
<li><a href="#12">12. 收敛性与稳定性分析</a></li>
<li><a href="#13">13. 计算复杂度与效率</a></li>
<li><a href="#14">14. 总结与展望</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>

                        </div>
                        <div class="toc-actions">
                            <button class="btn btn-sm btn-outline-secondary" onclick="expandAll()">
                                <i class="fas fa-expand"></i> 全部展开
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="collapseAll()">
                                <i class="fas fa-compress"></i> 全部折叠
                            </button>
                        </div>
                    </div>
                    

                    <!-- Back to Top Button -->
                    <button id="backToTop" class="back-to-top" title="回到顶部">
                        <i class="fas fa-arrow-up"></i>
                    </button>
                </aside>
            </div>
        </div>
    </article>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p>
                博客来源: <a href="https://spaces.ac.cn" target="_blank">科学空间</a> |
                内容经过整理并添加详细数学推导
            </p>
            <p>
                Powered by <a href="https://pages.github.com/" target="_blank">GitHub Pages</a>
            </p>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Syntax highlighting -->
    <script>hljs.highlightAll();</script>

    <!-- Back to top functionality -->
    <script>
        // Show/hide back to top button based on scroll position
        window.addEventListener('scroll', function() {
            const backToTop = document.getElementById('backToTop');
            if (window.pageYOffset > 300) {
                backToTop.classList.add('show');
            } else {
                backToTop.classList.remove('show');
            }
        });

        // Smooth scroll to top
        document.getElementById('backToTop').addEventListener('click', function() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        });

        // Sticky TOC sidebar
        window.addEventListener('scroll', function() {
            const sidebar = document.querySelector('.sidebar');
            if (!sidebar) return;

            const sidebarTop = sidebar.offsetTop;
            const scrollTop = window.pageYOffset;

            if (scrollTop > sidebarTop - 20) {
                sidebar.classList.add('sticky');
            } else {
                sidebar.classList.remove('sticky');
            }
        });
    </script>
</body>
</html>