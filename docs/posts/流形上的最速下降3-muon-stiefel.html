<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>流形上的最速下降：3. Muon + Stiefel | ML & Math Blog Posts</title>
    <meta name="description" content="流形上的最速下降：3. Muon + Stiefel&para;
原文链接: https://spaces.ac.cn/archives/11221
发布日期: 

上回说到，当我们把优化对象从向量参数转移到矩阵参数，并选用更适合矩阵的谱范数约束后，Muon优化器便自然而然地出现了。进一步地，我们考虑了给参数加上正交约束后的最速下降方向，这其中又分方阵和非方阵两部分讨论，其中方阵的求解我们在上一篇...">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css">

    <!-- Google Fonts -->
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="../assets/css/main.css">
    <link rel="stylesheet" href="../assets/css/post.css">

    <!-- Custom JS -->
    <script src="../assets/js/collapsible.js" defer></script>

    <!-- MathJax for math rendering -->
    <script>
    MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']],
        processEscapes: true,
        processEnvironments: true
      },
      options: {
        skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
      }
    };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <!-- Syntax highlighting -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.7.0/build/styles/github.min.css">
    <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.7.0/build/highlight.min.js"></script>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light border-bottom">
        <div class="container">
            <a class="navbar-brand" href="../index.html">
                <i class="fas fa-brain"></i> ML & Math Blog
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="../index.html"><i class="fas fa-home"></i> 首页</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Post Content -->
    <article class="container post-container my-5">
        <!-- Breadcrumb Navigation -->
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="../index.html"><i class="fas fa-home"></i> 首页</a></li>
                
                <li class="breadcrumb-item"><a href="../index.html?tags=矩阵">矩阵</a></li>
                
                <li class="breadcrumb-item active" aria-current="page">
                    #91 流形上的最速下降：3. Muon + Stiefel
                </li>
            </ol>
        </nav>

        <!-- Post Header -->
        <header class="post-header mb-4">
            <h1 class="post-title">
                <span class="post-number">#91</span>
                流形上的最速下降：3. Muon + Stiefel
            </h1>
            <div class="post-meta">
                <span><i class="far fa-calendar"></i> </span>
                
                <span class="ms-3">
                    <i class="fas fa-link"></i>
                    <a href="https://spaces.ac.cn/archives/11221" target="_blank" rel="noopener">原文链接</a>
                </span>
                
            </div>
            
            <div class="post-tags mt-3">
                
                <a href="../index.html?tags=矩阵" class="tag-link">
                    <span class="tag"><i class="fas fa-tag"></i> 矩阵</span>
                </a>
                
                <a href="../index.html?tags=优化器" class="tag-link">
                    <span class="tag"><i class="fas fa-tag"></i> 优化器</span>
                </a>
                
                <a href="../index.html?tags=muon" class="tag-link">
                    <span class="tag"><i class="fas fa-tag"></i> muon</span>
                </a>
                
                <a href="../index.html?tags=约束" class="tag-link">
                    <span class="tag"><i class="fas fa-tag"></i> 约束</span>
                </a>
                
                <a href="../index.html?tags=最速下降" class="tag-link">
                    <span class="tag"><i class="fas fa-tag"></i> 最速下降</span>
                </a>
                
            </div>
            
        </header>

        <div class="row">
            <!-- Main Content -->
            <div class="col-lg-9">
                <!-- Post Body -->
                <div class="post-content">
                    <h1 id="3-muon-stiefel">流形上的最速下降：3. Muon + Stiefel<a class="toc-link" href="#3-muon-stiefel" title="Permanent link">&para;</a></h1>
<p><strong>原文链接</strong>: <a href="https://spaces.ac.cn/archives/11221">https://spaces.ac.cn/archives/11221</a></p>
<p><strong>发布日期</strong>: </p>
<hr />
<p>上回说到，当我们把优化对象从向量参数转移到矩阵参数，并选用更适合矩阵的谱范数约束后，Muon优化器便自然而然地出现了。进一步地，我们考虑了给参数加上正交约束后的最速下降方向，这其中又分方阵和非方阵两部分讨论，其中方阵的求解我们在上一篇文章已经完成，但非方阵部分依然悬而未决。</p>
<p>本文的目标，则是把非方阵部分的求解补上，使得正交约束下的优化得以完全解决。</p>
<h2 id="_1">任务信息<a class="toc-link" href="#_1" title="Permanent link">&para;</a></h2>
<p>先简单回顾一下上文<a href="/archives/11215">《流形上的最速下降：2. Muon + 正交》</a>的结果。我们要求解的目标是<br />
\begin{equation}\newcommand{tr}{\mathop{\text{tr}}}\max_{\boldsymbol{\Phi}} \tr(\boldsymbol{G}^{\top}\boldsymbol{\Phi}) \qquad \text{s.t.}\qquad \Vert\boldsymbol{\Phi}\Vert_2 = 1,\,\, \boldsymbol{W}^{\top}\boldsymbol{W}=\boldsymbol{I},\,\,(\boldsymbol{W} - \eta \boldsymbol{\Phi})^{\top}(\boldsymbol{W} - \eta \boldsymbol{\Phi})=\boldsymbol{I}\end{equation}<br />
其中$\boldsymbol{W},\boldsymbol{\Phi}\in\mathbb{R}^{n\times m}(n \geq m)$，$\Vert\cdot\Vert_2$是谱范数。基于“一阶近似够用”的原则，可以简化成<br />
\begin{equation}\max_{\boldsymbol{\Phi}} \tr(\boldsymbol{G}^{\top}\boldsymbol{\Phi}) \qquad \text{s.t.}\qquad \Vert\boldsymbol{\Phi}\Vert_2 = 1,\,\, \boldsymbol{W}^{\top}\boldsymbol{W}=\boldsymbol{I},\,\,\boldsymbol{W}^{\top}\boldsymbol{\Phi}+\boldsymbol{\Phi}^{\top}\boldsymbol{W} = \boldsymbol{0}\label{eq:ori-obj}\end{equation}<br />
其中满足$\boldsymbol{W}^{\top}\boldsymbol{\Phi}+\boldsymbol{\Phi}^{\top}\boldsymbol{W} = \boldsymbol{0}$的全体$\boldsymbol{\Phi}$也称为$\boldsymbol{W}^{\top}\boldsymbol{W}=\boldsymbol{I}$的“切空间”。在上一篇文章中我们已经求出了通解的形式<br />
\begin{equation}\boldsymbol{\Phi} = \newcommand{msign}{\mathop{\text{msign}}}\msign(\boldsymbol{G} + \boldsymbol{W}\boldsymbol{X})\end{equation}<br />
其中$\boldsymbol{X}\in\mathbb{R}^{m\times m}$是一个待定的对称矩阵。</p>
<p>剩下的难题就是给出对称矩阵$\boldsymbol{X}$的计算方法，使得$\boldsymbol{W}^{\top}\boldsymbol{\Phi}$是一个反对称矩阵。一旦完成求解，那么对应的$\boldsymbol{\Phi}$自然是最优解。对于$n=m$，我们已经求得闭式解$\boldsymbol{X}=-[\boldsymbol{W}^{\top}\boldsymbol{G}]_{\text{sym}}$；真正困难的是$n &gt; m$的情形，此时亦称为“Stiefel流形”，它正是<a href="https://docs.modula.systems/algorithms/manifold/orthogonal/#open-problem-extending-to-the-stiefel-manifold">《Orthogonal manifold》</a>所留下的Open problem。</p>
<h2 id="_2">方程变换<a class="toc-link" href="#_2" title="Permanent link">&para;</a></h2>
<p>说白了，我们现在的任务是求解方程组：<br />
\begin{equation}\boldsymbol{W}^{\top}\msign(\boldsymbol{G} + \boldsymbol{W}\boldsymbol{X})+\msign(\boldsymbol{G} + \boldsymbol{W}\boldsymbol{X})^{\top}\boldsymbol{W} = \boldsymbol{0}\label{eq:start}\end{equation}<br />
当$n=m$时，$\boldsymbol{W}^{\top}$可以直接吸收到$\msign$里边。所以求解得以简化，然而$n &gt; m$时并不能做这样的吸收，这也是求解的困难所在。笔者倾向于$n &gt; m$时没有简单的显式解，所以我们来寻求数值算法。</p>
<p>根据定义$\msign(\boldsymbol{M})=\boldsymbol{M}(\boldsymbol{M}^{\top}\boldsymbol{M})^{-1/2}$，可以写出<br />
\begin{equation}\boldsymbol{W}^{\top}\msign(\boldsymbol{G} + \boldsymbol{W}\boldsymbol{X}) = \boldsymbol{W}^{\top}(\boldsymbol{G} + \boldsymbol{W}\boldsymbol{X})\boldsymbol{Q}^{-1} = (\boldsymbol{W}^{\top}\boldsymbol{G} + \boldsymbol{X})\boldsymbol{Q}^{-1}\end{equation}<br />
其中$\boldsymbol{Q} = ((\boldsymbol{G} + \boldsymbol{W}\boldsymbol{X})^{\top}(\boldsymbol{G} + \boldsymbol{W}\boldsymbol{X}))^{1/2}$。在这个新记号下，方程组变为<br />
\begin{equation}(\boldsymbol{W}^{\top}\boldsymbol{G} + \boldsymbol{X})\boldsymbol{Q}^{-1} + \boldsymbol{Q}^{-1}(\boldsymbol{G}^{\top}\boldsymbol{W} + \boldsymbol{X}) = \boldsymbol{0}\end{equation}<br />
同时左乘和右乘$\boldsymbol{Q}$，得到<br />
\begin{equation}\boldsymbol{Q}(\boldsymbol{W}^{\top}\boldsymbol{G} + \boldsymbol{X}) + (\boldsymbol{G}^{\top}\boldsymbol{W} + \boldsymbol{X})\boldsymbol{Q} = \boldsymbol{0}\label{eq:r-x}\end{equation}<br />
其中$\boldsymbol{Q}$又成立<br />
\begin{equation}\boldsymbol{Q} = (\boldsymbol{G} + \boldsymbol{W}\boldsymbol{X})^{\top}\msign(\boldsymbol{G} + \boldsymbol{W}\boldsymbol{X})\label{eq:r-q}\end{equation}</p>
<h2 id="_3">迭代求解<a class="toc-link" href="#_3" title="Permanent link">&para;</a></h2>
<p>现在笔者的想法是，从某个初值的$\boldsymbol{X}$出发，代入式$\eqref{eq:r-q}$得到$\boldsymbol{Q}$，然后将$\boldsymbol{Q}$代入方程组$\eqref{eq:r-x}$求解出新的$\boldsymbol{X}$，反复迭代，直到收敛。在已知$\msign$的情况下，式$\eqref{eq:r-q}$是可以显式计算的，所以唯一的难度是解方程组$\eqref{eq:r-x}$。</p>
<p>我们可以整理一下式$\eqref{eq:r-x}$：<br />
\begin{equation}\boldsymbol{Q}\boldsymbol{X} + \boldsymbol{X}\boldsymbol{Q} = -2[\boldsymbol{Q}\boldsymbol{W}^{\top}\boldsymbol{G}]_{\text{sym}}\label{eq:r-xx}\end{equation}<br />
在给定$\boldsymbol{Q}$的前提下，这其实是关于$\boldsymbol{X}$是线性方程组，名为“<a href="https://en.wikipedia.org/wiki/Lyapunov_equation">连续型Lyapunov方程</a>”，也可以看成是“<a href="https://en.wikipedia.org/wiki/Sylvester_equation">Sylvester方程</a>”的一个特例。如果我们只用CPU进行计算，Scipy其实已经自带了该方程的求解函数<code>scipy.linalg.solve_continuous_lyapunov</code>，直接调用即可。</p>
<p>至于初值的选择，我们可以考虑方阵时的解$-[\boldsymbol{W}^{\top}\boldsymbol{G}]<em _text_sym="\text{sym">{\text{sym}}$，这样显然是方阵到非方阵的一个自然过渡。我们也可以从方程$\eqref{eq:r-xx}$的另一个等价形式，来观察初值$-[\boldsymbol{W}^{\top}\boldsymbol{G}]</em>$的合理性：}<br />
\begin{equation}\boldsymbol{Q}(\boldsymbol{X} + [\boldsymbol{W}^{\top}\boldsymbol{G}]<em _text_sym="\text{sym">{\text{sym}}) + (\boldsymbol{X} + [\boldsymbol{W}^{\top}\boldsymbol{G}]</em>]}})\boldsymbol{Q} =[\boldsymbol{W}^{\top}\boldsymbol{G<em _text_skew="\text{skew">{\text{skew}}\boldsymbol{Q} -\boldsymbol{Q}[\boldsymbol{W}^{\top}\boldsymbol{G}]</em>}}\end{equation<br />
所以$-[\boldsymbol{W}^{\top}\boldsymbol{G}]<em _text_skew="\text{skew">{\text{sym}}$的精确程度，取决于$[\boldsymbol{W}^{\top}\boldsymbol{G}]</em>$就越准确。不过后面的实测结果显示，我们的迭代算法对初值并不是特别敏感，即便以全零矩阵为初值问题也不大。}}$与$\boldsymbol{Q}$乘法的可交换程度，它们越接近交换矩阵，那么$-[\boldsymbol{W}^{\top}\boldsymbol{G}]_{\text{sym}</p>
<h2 id="_4">自己动手<a class="toc-link" href="#_4" title="Permanent link">&para;</a></h2>
<p>刚才我们说到Scipy自带了求解Lyapunov方程函数，因此可以直接调用而无需关心求解过程。但这也仅限于CPU的Scipy，笔者查了一下，Torch和Jax都没有同类函数，所以要用GPU计算的话，只能“自力更生”。</p>
<p>自己编程求解方程$\eqref{eq:r-xx}$的做法有两个。一是按照<a href="/archives/11056">《矩阵符号函数mcsgn能计算什么？》</a>的思路，用$\newcommand{mcsgn}{\mathop{\text{mcsgn}}}\mcsgn$（不是$\msign$）来求解：<br />
\begin{equation}\boldsymbol{X} = \mcsgn\left(\begin{bmatrix}-\boldsymbol{Q} &amp; -[\boldsymbol{Q}\boldsymbol{W}^{\top}\boldsymbol{G}]<em _:m_m:_="[:m,m:]">{\text{sym}} \\ \boldsymbol{0} &amp; \boldsymbol{Q}\end{bmatrix}\right)</em>}\end{equation<br />
二是基于SVD求解，这个方法我们在<a href="/archives/11025">《msign的导数》</a>里计算$\msign$的梯度时已经用过，这里结合方程$\eqref{eq:r-xx}$再介绍一遍。根据$\boldsymbol{Q}$的定义知它是正定对称的，那么可以特征值分解为$\boldsymbol{V}\boldsymbol{\Sigma}\boldsymbol{V}^{\top}$，其中$\boldsymbol{V}$是正交矩阵而$\boldsymbol{\Sigma}=\mathop{\text{diag}}(\sigma_1,\cdots,\sigma_m)$是对角矩阵，代入到式$\eqref{eq:r-xx}$，可整理得<br />
\begin{equation}\boldsymbol{\Sigma}(\boldsymbol{V}^{\top}\boldsymbol{X}\boldsymbol{V}) + (\boldsymbol{V}^{\top}\boldsymbol{X}\boldsymbol{V})\boldsymbol{\Sigma} = -2\boldsymbol{V}^{\top}[\boldsymbol{Q}\boldsymbol{W}^{\top}\boldsymbol{G}]<em i_j="i,j">{\text{sym}}\boldsymbol{V}\end{equation}<br />
左端可以表示成$(\boldsymbol{V}^{\top}\boldsymbol{X}\boldsymbol{V})\otimes \boldsymbol{S}$，其中$\otimes$是Hadamard积，$\boldsymbol{S}</em> = \sigma_i + \sigma_j$。由此，可以解得<br />
\begin{equation}\boldsymbol{X} = -2\boldsymbol{V}((\boldsymbol{V}^{\top}[\boldsymbol{Q}\boldsymbol{W}^{\top}\boldsymbol{G}]_{\text{sym}}\boldsymbol{V})\oslash \boldsymbol{S})\boldsymbol{V}^{\top}\end{equation}<br />
其中$\oslash$是Hadamard商。这里比较有趣的地方是，对$\boldsymbol{Q}$做特征值分解，基本等价于对$\boldsymbol{G} + \boldsymbol{W}\boldsymbol{X}$做SVD，而对$\boldsymbol{G} + \boldsymbol{W}\boldsymbol{X}$做SVD也可以用来求$\msign(\boldsymbol{G} + \boldsymbol{W}\boldsymbol{X})$，所以只需一遍SVD就可以把$\msign$和方程$\eqref{eq:r-xx}$的解都算出来。</p>
<p>两个思路各有特点。思路一需要先对$m\times m$的矩阵算$\msign$，再对$2m\times 2m$的矩阵算$\mcsgn$，虽然它们都可以用Newton-Schulz迭代来高效计算，但也代价不菲。此外，这里我们还要选择能收敛且精度高的系数（推荐<a href="/archives/10996">《msign算子的Newton-Schulz迭代（下）》</a>的结果），要不然$\mcsgn$和$\msign$的计算都不收敛，更别说$\boldsymbol{X}$了。</p>
<p>思路二需要用到SVD。虽然SVD的复杂度较高，而且往往要强制使用FP32精度，但在这里的问题上，每一步迭代只需要一次SVD就可以同时求$\msign$和$\boldsymbol{X}$，总体效率也不会太差。如果我们需要正交约束的矩阵参数并不多，那么SVD可能是最简便的选择。</p>
<h2 id="_5">相关结果<a class="toc-link" href="#_5" title="Permanent link">&para;</a></h2>
<p>本文之前，<a href="https://x.com/leloykun">@leloy</a> 在他的博客文章<a href="https://leloykun.github.io/ponder/steepest-descent-stiefel/">《Heuristic Solutions for Steepest Descent on the Stiefel Manifold》</a>也提出了原始目标$\eqref{eq:ori-obj}$的两种启发式求解方法。这里的“启发式”，指的是在大多数情况下，它能得到一个还不错的解，但无法保证是最优解，这里我们也一起学习下。</p>
<p>第一种方法可以说是纯几何法。首先我们定义投影运算：<br />
\begin{equation}\newcommand{proj}{\mathop{\mathcal{P}}}\proj\nolimits_{\boldsymbol{W}}(\boldsymbol{M}) = \boldsymbol{M} - \boldsymbol{W}[\boldsymbol{W}^{\top}\boldsymbol{M}]<em _boldsymbol_W="\boldsymbol{W">{\text{sym}}\end{equation}<br />
可以验证$\boldsymbol{W}^{\top}\proj\nolimits</em>$的切空间中的投影运算。}}(\boldsymbol{M})$一定是反对称矩阵，也就是说$\proj\nolimits_{\boldsymbol{W}}(\boldsymbol{M})$一定在切空间中，所以我们将它视为任意矩阵$\boldsymbol{M}$投影到$\boldsymbol{W}^{\top}\boldsymbol{W}=\boldsymbol{I</p>
<p>我们从梯度$\boldsymbol{G}$出发，$\proj\nolimits_{\boldsymbol{W}}(\boldsymbol{M})$肯定是在切空间了，但我们知道Muon的更新量一定是个正交矩阵（满秩时），而$\proj\nolimits_{\boldsymbol{W}}(\boldsymbol{M})$不一定正交，所以我们可以通过$\msign$来寻找与之最邻近的正交矩阵，即$\msign(\proj\nolimits_{\boldsymbol{W}}(\boldsymbol{M}))$。然而$\msign$之后又不一定在切空间了，我们又可以将它投影到切空间去，然后又寻找最近正交矩阵，反复迭代：<br />
\begin{equation}\boldsymbol{\Phi} = (\msign\circ\proj\nolimits_{\boldsymbol{W}}\circ\cdots\circ\msign\circ\proj\nolimits_{\boldsymbol{W}})(\boldsymbol{M})\end{equation}<br />
这便是 @leloy 的第一种思路，交替投影到切空间和正交空间直到收敛，可以说相当直观。而且在比较随机的情况下，它跟最优解也非常接近，甚至能精确到小数点后4位，以至于笔者一开始认为它就是精确解。不过后来经过搜索，发现了它跟最优解偏差足够大的case，才确认了这只是巧合，并非最优解。</p>
<p>第二种方法可以称为线搜索。具体来说，当$n &gt; m$时，我们可以考虑将$\boldsymbol{W}$补成标准的$n\times n$的正交矩阵$[\boldsymbol{W},\overline{\boldsymbol{W}}]$，然后将所求$\boldsymbol{\Phi}$分解为$\boldsymbol{W}^{\top}\boldsymbol{\Phi}$和$\overline{\boldsymbol{W}}{}^{\top}\boldsymbol{\Phi}$两部份。接着 @leloy 做了一个贪心近似，先求$\boldsymbol{W}^{\top}\boldsymbol{\Phi}$的最优解，然后再求$\overline{\boldsymbol{W}}{}^{\top}\boldsymbol{\Phi}$的最优解，两者之间再引入一个线搜索来提高准确度。</p>
<p>这样一套操作下来，确实能得到一个近似程度还不错的解，并且它一定在切空间内且满足正交性。求解过程需要计算谱范数、$\msign$和<a href="https://en.wikipedia.org/wiki/Cholesky_decomposition">Cholesky分解</a>，细节大家自行看作者的文章了。此外，当$m=2$时，理论上它是能搜出最优解的，这是因为$2\times 2$的反对称矩阵只有一个自由参数，而线搜索刚好是一个自由度。</p>
<h2 id="_6">测试一下<a class="toc-link" href="#_6" title="Permanent link">&para;</a></h2>
<p>下面在Numpy中实测上面几个方法，其中主要目的是验证方法本身的正确性，所以我们直接用奇异值分解和特征值分解来实现$\msign$和$\mcsgn$。</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">scipy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sp</span>

<span class="k">def</span><span class="w"> </span><span class="nf">mcsgn</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;特征值分解精确计算mcsgn</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eig</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">v</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="kp">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="kp">sign</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="kp">inv</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">msign</span><span class="p">(</span><span class="n">g</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;奇异值分解精确计算msign</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">u</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">vh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="kp">svd</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">u</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="kp">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="kp">sign</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="o">@</span> <span class="n">vh</span>

<span class="k">def</span><span class="w"> </span><span class="nf">sym</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;对称化</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">x</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span>

<span class="k">def</span><span class="w"> </span><span class="nf">skew</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;反对称化</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span>

<span class="k">def</span><span class="w"> </span><span class="nf">proj</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;投影到正交的切空间</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">g</span> <span class="o">-</span> <span class="n">w</span> <span class="o">@</span> <span class="n">sym</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">g</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">jianlin_by_mcsgn</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;通过mcsgn来构建本文的迭代</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n</span><span class="p">,</span> <span class="n">m</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="kp">shape</span>
    <span class="n">x</span> <span class="o">=</span> <span class="o">-</span><span class="n">sym</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">g</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">steps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="n">msign</span><span class="p">(</span><span class="n">z</span> <span class="o">:=</span> <span class="n">g</span> <span class="o">+</span> <span class="n">w</span> <span class="o">@</span> <span class="n">x</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;step:&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="s1">&#39;, inner product:&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">phi</span> <span class="o">*</span> <span class="n">g</span><span class="p">)</span><span class="o">.</span><span class="kp">sum</span><span class="p">(),</span> <span class="s1">&#39;, tangent error:&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="kp">abs</span><span class="p">(</span><span class="n">sym</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">phi</span><span class="p">))</span><span class="o">.</span><span class="kp">mean</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">steps</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">phi</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">phi</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">mcsgn</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">block</span><span class="p">([[</span><span class="o">-</span><span class="n">q</span><span class="p">,</span> <span class="o">-</span><span class="n">sym</span><span class="p">(</span><span class="n">q</span> <span class="o">@</span> <span class="n">w</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">g</span><span class="p">)],</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="kp">zeros_like</span><span class="p">(</span><span class="n">q</span><span class="p">),</span> <span class="n">q</span><span class="p">]]))[:</span><span class="n">m</span><span class="p">,</span> <span class="n">m</span><span class="p">:]</span>
        <span class="c1"># x = -2 * sp.linalg.solve_continuous_lyapunov(q, sym(q @ w.T @ g))</span>

<span class="k">def</span><span class="w"> </span><span class="nf">jianlin_by_svd</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;通过svd来构建本文的迭代</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="o">-</span><span class="n">sym</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">g</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">steps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">u</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">vh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="kp">svd</span><span class="p">(</span><span class="n">z</span> <span class="o">:=</span> <span class="n">g</span> <span class="o">+</span> <span class="n">w</span> <span class="o">@</span> <span class="n">x</span><span class="p">,</span> <span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="p">(</span><span class="n">u</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="kp">sign</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="o">@</span> <span class="n">vh</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;step:&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="s1">&#39;, inner product:&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">phi</span> <span class="o">*</span> <span class="n">g</span><span class="p">)</span><span class="o">.</span><span class="kp">sum</span><span class="p">(),</span> <span class="s1">&#39;, tangent error:&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="kp">abs</span><span class="p">(</span><span class="n">sym</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">phi</span><span class="p">))</span><span class="o">.</span><span class="kp">mean</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">steps</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">phi</span>
        <span class="n">x</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">vh</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="p">(</span><span class="n">vh</span> <span class="o">@</span> <span class="n">sym</span><span class="p">(</span><span class="n">z</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">phi</span> <span class="o">@</span> <span class="n">w</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">g</span><span class="p">)</span> <span class="o">@</span> <span class="n">vh</span><span class="o">.</span><span class="n">T</span> <span class="o">/</span> <span class="p">(</span><span class="n">s</span> <span class="o">+</span> <span class="n">s</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]))</span> <span class="o">@</span> <span class="n">vh</span>

<span class="k">def</span><span class="w"> </span><span class="nf">leloy_v1</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;交替投影到切空间和正交空间</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">phi</span> <span class="o">=</span> <span class="n">g</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">steps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="n">msign</span><span class="p">(</span><span class="n">proj</span><span class="p">(</span><span class="n">phi</span><span class="p">,</span> <span class="n">w</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;step:&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="s1">&#39;, inner product:&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">phi</span> <span class="o">*</span> <span class="n">g</span><span class="p">)</span><span class="o">.</span><span class="kp">sum</span><span class="p">(),</span> <span class="s1">&#39;, tangent error:&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="kp">abs</span><span class="p">(</span><span class="n">sym</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">phi</span><span class="p">))</span><span class="o">.</span><span class="kp">mean</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">phi</span>

<span class="k">def</span><span class="w"> </span><span class="nf">leloy_v2</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;分部贪心求解 + 线搜索（形式经过笔者的简化）</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n</span><span class="p">,</span> <span class="n">m</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="kp">shape</span>
    <span class="n">taus</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">steps</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">p_max</span><span class="p">,</span> <span class="n">tau_opt</span><span class="p">,</span> <span class="n">phi_opt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">tau</span> <span class="ow">in</span> <span class="n">taus</span><span class="p">:</span>
        <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span> <span class="o">:=</span> <span class="n">skew</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">g</span><span class="p">))</span> <span class="o">*</span> <span class="n">tau</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="nb">ord</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="mf">1e-8</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">cholesky</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="kp">eye</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="o">-</span> <span class="n">b</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">b</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">msign</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="kp">eye</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">-</span> <span class="n">w</span> <span class="o">@</span> <span class="n">w</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">@</span> <span class="n">g</span> <span class="o">@</span> <span class="n">r</span><span class="p">)</span> <span class="o">@</span> <span class="n">r</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="n">w</span> <span class="o">@</span> <span class="n">b</span> <span class="o">+</span> <span class="n">c</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;tau:&#39;</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="s1">&#39;, inner product:&#39;</span><span class="p">,</span> <span class="n">p</span> <span class="o">:=</span> <span class="p">(</span><span class="n">phi</span> <span class="o">*</span> <span class="n">g</span><span class="p">)</span><span class="o">.</span><span class="kp">sum</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">p</span> <span class="o">&gt;</span> <span class="n">p_max</span><span class="p">:</span>
            <span class="n">p_max</span><span class="p">,</span> <span class="n">tau_opt</span><span class="p">,</span> <span class="n">phi_opt</span> <span class="o">=</span> <span class="n">p</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">phi</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;best inner product:&#39;</span><span class="p">,</span> <span class="n">p_max</span><span class="p">,</span> <span class="s1">&#39;, tau:&#39;</span><span class="p">,</span> <span class="n">tau_opt</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">phi_opt</span>

<span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">array</span><span class="p">([[</span> <span class="mf">0.69453734</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.26590866</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.44721806</span><span class="p">,</span>  <span class="mf">0.2753041</span> <span class="p">],</span>
              <span class="p">[</span><span class="o">-</span><span class="mf">0.11738148</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5588003</span> <span class="p">,</span> <span class="o">-</span><span class="mf">0.17580748</span><span class="p">,</span>  <span class="mf">0.3218624</span> <span class="p">],</span>
              <span class="p">[</span><span class="o">-</span><span class="mf">0.4515288</span> <span class="p">,</span> <span class="o">-</span><span class="mf">0.23489913</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.26683152</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.25739142</span><span class="p">],</span>
              <span class="p">[</span> <span class="mf">0.02392521</span><span class="p">,</span>  <span class="mf">0.02664689</span><span class="p">,</span>  <span class="mf">0.48423648</span><span class="p">,</span>  <span class="mf">0.6193399</span> <span class="p">],</span>
              <span class="p">[</span> <span class="mf">0.45194831</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.25206333</span><span class="p">,</span>  <span class="mf">0.27654836</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.60242337</span><span class="p">],</span>
              <span class="p">[</span> <span class="mf">0.21197332</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.09174792</span><span class="p">,</span>  <span class="mf">0.24521762</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.08484317</span><span class="p">],</span>
              <span class="p">[</span><span class="o">-</span><span class="mf">0.15496767</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.26446804</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.34942415</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.01877318</span><span class="p">],</span>
              <span class="p">[</span><span class="o">-</span><span class="mf">0.16181251</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.6474956</span> <span class="p">,</span>  <span class="mf">0.45243263</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.01776086</span><span class="p">]])</span>

<span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">array</span><span class="p">([[</span><span class="o">-</span><span class="mf">17.85745</span>   <span class="p">,</span> <span class="o">-</span><span class="mf">10.758921</span>  <span class="p">,</span>  <span class="o">-</span><span class="mf">2.9583392</span> <span class="p">,</span>   <span class="mf">6.245008</span>  <span class="p">],</span>
              <span class="p">[</span><span class="o">-</span><span class="mf">28.883093</span>  <span class="p">,</span>  <span class="mf">19.772121</span>  <span class="p">,</span>   <span class="mf">8.086545</span>  <span class="p">,</span> <span class="o">-</span><span class="mf">21.564013</span>  <span class="p">],</span>
              <span class="p">[</span> <span class="o">-</span><span class="mf">1.6274693</span> <span class="p">,</span> <span class="o">-</span><span class="mf">14.96859</span>   <span class="p">,</span>   <span class="mf">3.4465332</span> <span class="p">,</span>   <span class="mf">3.1070817</span> <span class="p">],</span>
              <span class="p">[</span> <span class="o">-</span><span class="mf">7.8890743</span> <span class="p">,</span>   <span class="mf">1.5304767</span> <span class="p">,</span>  <span class="o">-</span><span class="mf">8.949573</span>  <span class="p">,</span>   <span class="mf">9.579629</span>  <span class="p">],</span>
              <span class="p">[</span>  <span class="mf">2.246596</span>  <span class="p">,</span>  <span class="mf">14.46572</span>   <span class="p">,</span>  <span class="mf">12.8451</span>    <span class="p">,</span>  <span class="o">-</span><span class="mf">2.7370298</span> <span class="p">],</span>
              <span class="p">[</span> <span class="o">-</span><span class="mf">0.9496974</span> <span class="p">,</span>   <span class="mf">6.9879804</span> <span class="p">,</span>   <span class="mf">2.849277</span>  <span class="p">,</span>   <span class="mf">1.1148484</span> <span class="p">],</span>
              <span class="p">[</span> <span class="o">-</span><span class="mf">8.115278</span>  <span class="p">,</span> <span class="o">-</span><span class="mf">18.054405</span>  <span class="p">,</span>  <span class="o">-</span><span class="mf">0.19287404</span><span class="p">,</span>   <span class="mf">7.0389237</span> <span class="p">],</span>
              <span class="p">[</span><span class="o">-</span><span class="mf">15.062008</span>  <span class="p">,</span> <span class="o">-</span><span class="mf">15.02901</span>   <span class="p">,</span>   <span class="mf">2.9083247</span> <span class="p">,</span>  <span class="mf">21.706533</span>  <span class="p">]])</span>

<span class="n">phi1</span> <span class="o">=</span> <span class="n">jianlin_by_mcsgn</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="n">phi2</span> <span class="o">=</span> <span class="n">jianlin_by_svd</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="n">phi3</span> <span class="o">=</span> <span class="n">leloy_v1</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="n">phi4</span> <span class="o">=</span> <span class="n">leloy_v2</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="kp">allclose</span><span class="p">(</span><span class="n">phi1</span><span class="p">,</span> <span class="n">phi2</span><span class="p">)</span>

<span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">qr</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">50</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>

<span class="n">phi1</span> <span class="o">=</span> <span class="n">jianlin_by_mcsgn</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">phi2</span> <span class="o">=</span> <span class="n">jianlin_by_svd</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">phi3</span> <span class="o">=</span> <span class="n">leloy_v1</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">phi4</span> <span class="o">=</span> <span class="n">leloy_v2</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="kp">allclose</span><span class="p">(</span><span class="n">phi1</span><span class="p">,</span> <span class="n">phi2</span><span class="p">)</span>
</code></pre></div>

<p>对于代码中给出的第一组$\boldsymbol{W},\boldsymbol{G}$，笔者方法求得的最优$\tr(\boldsymbol{G}^{\top} \boldsymbol{\Phi})$大致是$90$，并且$\mcsgn$和SVD的结果是完全一样的；而 @leloy 的第一种方法求得的结果是大致是$70$，第二种方法求得的结果大致是$80$，都跟最优解有一定差距。</p>
<p>不过，第一组$\boldsymbol{W},\boldsymbol{G}$只是为了显示出三个方法差距特意搜出来的极端例子，如果我们更换相对随机的数值，那么其实本文的解法和 @leloy 的第一种解法会很接近，并且迭代步数也可以少很多（5～10步），此时 @leloy 的第二种解法跟最优解差距更大。读者可以自行构建一些例子测试。</p>
<h2 id="_7">拓展思考<a class="toc-link" href="#_7" title="Permanent link">&para;</a></h2>
<p>关于原始问题$\eqref{eq:ori-obj}$的求解，这里就暂告一段落了。接下来补充讨论几个可能有疑惑的细节问题。</p>
<p>首先，为了方便描述，笔者前面给出的迭代求解过程有一个隐含假设，那就是$\boldsymbol{G} + \boldsymbol{W}\boldsymbol{X}$自始至终都是满秩的（秩为$m$），要不然矩阵$\boldsymbol{S}$就会有零分量，$\oslash\boldsymbol{S}$就不大好操作。但这个困难不是本质的，因为方程$\eqref{eq:start}$必然会有解，所以遇到分母为零时，分子必然也为零，于是我们只需要简单将$\boldsymbol{S}$的零分量换成一个小正数，就能得到正确的结果。</p>
<p>从数值计算的角度看，我们也很少有机会能遇到绝对等于零的奇异值，所以不需要太担心这个问题，默认$\boldsymbol{G} + \boldsymbol{W}\boldsymbol{X}$满秩就好。在这个默认假设之下，回缩操作会变得很简单，因为<br />
\begin{equation}(\boldsymbol{W} - \eta\boldsymbol{\Phi})^{\top}(\boldsymbol{W} - \eta\boldsymbol{\Phi}) = \boldsymbol{W}^{\top} \boldsymbol{W} - \eta(\boldsymbol{W}^{\top} \boldsymbol{\Phi} + \boldsymbol{\Phi}^{\top}\boldsymbol{W}) + \eta^2 \boldsymbol{\Phi}^{\top}\boldsymbol{\Phi}\end{equation}<br />
根据Stiefel流形的定义，右端第一项是$\boldsymbol{I}$，根据切空间的条件，第二项是$\boldsymbol{0}$，最后是满秩时$\msign$出来的也是一个Stiefel流形的矩阵，所以第三项是$\eta^2 \boldsymbol{I}$，总的结果是$(1+\eta^2)\boldsymbol{I}$，只需要除以$\sqrt{1+\eta^2}$就可以实现回缩：<br />
\begin{equation}\boldsymbol{W}\quad\leftarrow\quad\frac{\boldsymbol{W} - \eta\boldsymbol{\Phi}}{\sqrt{1+\eta^2}}\end{equation}</p>
<p>看到这里，不知道笔者有没有发现，这里其实有一个更深刻的问题：不管是相对简单的正交流形，还是相对复杂的Stiefel流形，我们应该使用何种精度计算？要知道“正交”是一个精确的定量约束，$\boldsymbol{W}^{\top}\boldsymbol{W}=\boldsymbol{I}$包含$m(m+1)/2$个等式约束，可以预见在低精度下用上式进行迭代，久而久之肯定会严重偏离正交的，更不用说求解$\boldsymbol{\Phi}$过程中的误差了。</p>
<p>因此，笔者认为，除非我们定期给参数施加正交化操作（即$\boldsymbol{W}\leftarrow\msign(\boldsymbol{W})$）来将它拉回到正交流形上，否则求解过程的计算精度起码要FP32起步。考虑到通常要加正交约束的参数并不会很多，所以一般来说这也不算太大的代价。</p>
<h2 id="_8">文章小结<a class="toc-link" href="#_8" title="Permanent link">&para;</a></h2>
<p>这篇文章将上一篇文章的“Muon + 正交流形”推广到了更一般的“Muon + Stiefel流形”，主要发现是一个求解对应更新量的迭代算法。</p>
<p><em><strong>转载到请包括本文地址：</strong><a href="https://spaces.ac.cn/archives/11221">https://spaces.ac.cn/archives/11221</a></em></p>
<p><em><strong>更详细的转载事宜请参考：</strong></em><a href="https://spaces.ac.cn/archives/6508#%E6%96%87%E7%AB%A0%E5%A6%82%E4%BD%95%E8%BD%AC%E8%BD%BD/%E5%BC%95%E7%94%A8" title="《科学空间FAQ》">《科学空间FAQ》</a></p>
<p><strong>如果您还有什么疑惑或建议，欢迎在下方评论区继续讨论。</strong></p>
<p><strong>如果您觉得本文还不错，欢迎分享/打赏本文。打赏并非要从中获得收益，而是希望知道科学空间获得了多少读者的真心关注。当然，如果你无视它，也不会影响你的阅读。再次表示欢迎和感谢！</strong></p>
<p>打赏</p>
<p><img alt="科学空间" src="https://spaces.ac.cn/usr/themes/geekg/payment/wx.png" /></p>
<p>微信打赏</p>
<p><img alt="科学空间" src="https://spaces.ac.cn/usr/themes/geekg/payment/zfb.png" /></p>
<p>支付宝打赏</p>
<p>因为网站后台对打赏并无记录，因此欢迎在打赏时候备注留言。你还可以<a href="http://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&amp;email=tN7d1drY3drrx8H0xcWa19vZ"><strong>点击这里</strong></a>或在下方评论区留言来告知你的建议或需求。</p>
<p><strong>如果您需要引用本文，请参考：</strong></p>
<p>苏剑林. (Aug. 08, 2025). 《流形上的最速下降：3. Muon + Stiefel 》[Blog post]. Retrieved from <a href="https://spaces.ac.cn/archives/11221">https://spaces.ac.cn/archives/11221</a></p>
<p>@online{kexuefm-11221,<br />
title={流形上的最速下降：3. Muon + Stiefel},<br />
author={苏剑林},<br />
year={2025},<br />
month={Aug},<br />
url={\url{https://spaces.ac.cn/archives/11221}},<br />
} </p>
<hr />
<h2 id="_9">公式推导与注释<a class="toc-link" href="#_9" title="Permanent link">&para;</a></h2>
<p>TODO: 添加详细的数学公式推导和注释</p>
                </div>

                <!-- Previous/Next Navigation -->
                <nav class="post-navigation" aria-label="文章导航">
                    <div class="row g-3">
                        <div class="col-6">
                            
                            <a href="monarch矩阵计算高效的稀疏型矩阵分解.html" class="nav-link-prev">
                                <div class="nav-direction"><i class="fas fa-chevron-left"></i> 上一篇</div>
                                <div class="nav-title">#90 Monarch矩阵：计算高效的稀疏型矩阵分解</div>
                            </a>
                            
                        </div>
                        <div class="col-6">
                            
                            <a href="等值振荡定理最优多项式逼近的充要条件.html" class="nav-link-next">
                                <div class="nav-direction">下一篇 <i class="fas fa-chevron-right"></i></div>
                                <div class="nav-title">#92 等值振荡定理：最优多项式逼近的充要条件</div>
                            </a>
                            
                        </div>
                    </div>
                </nav>

                <!-- Back to Home -->
                <div class="text-center mt-4 mb-4">
                    <a href="../index.html" class="btn btn-outline-primary">
                        <i class="fas fa-arrow-left"></i> 返回首页
                    </a>
                </div>
            </div>

            <!-- Sidebar (TOC) -->
            <div class="col-lg-3">
                <aside class="sidebar">
                    
                    <div class="toc-sidebar">
                        <h5 class="toc-title"><i class="fas fa-list"></i> 目录</h5>
                        <div class="toc-content">
                            <div class="toc">
<ul>
<li><a href="#3-muon-stiefel">流形上的最速下降：3. Muon + Stiefel</a><ul>
<li><a href="#_1">任务信息</a></li>
<li><a href="#_2">方程变换</a></li>
<li><a href="#_3">迭代求解</a></li>
<li><a href="#_4">自己动手</a></li>
<li><a href="#_5">相关结果</a></li>
<li><a href="#_6">测试一下</a></li>
<li><a href="#_7">拓展思考</a></li>
<li><a href="#_8">文章小结</a></li>
<li><a href="#_9">公式推导与注释</a></li>
</ul>
</li>
</ul>
</div>

                        </div>
                        <div class="toc-actions">
                            <button class="btn btn-sm btn-outline-secondary" onclick="expandAll()">
                                <i class="fas fa-expand"></i> 全部展开
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="collapseAll()">
                                <i class="fas fa-compress"></i> 全部折叠
                            </button>
                        </div>
                    </div>
                    

                    <!-- Back to Top Button -->
                    <button id="backToTop" class="back-to-top" title="回到顶部">
                        <i class="fas fa-arrow-up"></i>
                    </button>
                </aside>
            </div>
        </div>
    </article>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p>
                博客来源: <a href="https://spaces.ac.cn" target="_blank">科学空间</a> |
                内容经过整理并添加详细数学推导
            </p>
            <p>
                Powered by <a href="https://pages.github.com/" target="_blank">GitHub Pages</a>
            </p>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Syntax highlighting -->
    <script>hljs.highlightAll();</script>

    <!-- Back to top functionality -->
    <script>
        // Show/hide back to top button based on scroll position
        window.addEventListener('scroll', function() {
            const backToTop = document.getElementById('backToTop');
            if (window.pageYOffset > 300) {
                backToTop.classList.add('show');
            } else {
                backToTop.classList.remove('show');
            }
        });

        // Smooth scroll to top
        document.getElementById('backToTop').addEventListener('click', function() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        });

        // Sticky TOC sidebar
        window.addEventListener('scroll', function() {
            const sidebar = document.querySelector('.sidebar');
            if (!sidebar) return;

            const sidebarTop = sidebar.offsetTop;
            const scrollTop = window.pageYOffset;

            if (scrollTop > sidebarTop - 20) {
                sidebar.classList.add('sticky');
            } else {
                sidebar.classList.remove('sticky');
            }
        });
    </script>
</body>
</html>