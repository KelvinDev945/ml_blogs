<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transformer升级之路：4、二维位置的旋转式位置编码 | ML & Math Blog Posts</title>
    <meta name="description" content="Transformer升级之路：4、二维位置的旋转式位置编码&para;
原文链接: https://spaces.ac.cn/archives/8397
发布日期: 

在之前的文章《Transformer升级之路：2、博采众长的旋转式位置编码》中我们提出了旋转式位置编码RoPE以及对应的Transformer模型RoFormer。由于笔者主要研究的领域还是NLP，所以本来这个事情对于笔者来说已...">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css">

    <!-- Google Fonts -->
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="../assets/css/main.css">
    <link rel="stylesheet" href="../assets/css/post.css">

    <!-- Custom JS -->
    <script src="../assets/js/collapsible.js" defer></script>

    <!-- MathJax for math rendering with equation numbering -->
    <script>
    MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']],
        processEscapes: true,
        processEnvironments: true,
        tags: 'ams',  // Enable equation numbering with AMS style
        tagSide: 'right',  // Place equation numbers on the right
        tagIndent: '0.8em',  // Indentation for equation numbers
        multlineWidth: '85%'
      },
      options: {
        skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
      }
    };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <!-- Syntax highlighting -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.7.0/build/styles/github.min.css">
    <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.7.0/build/highlight.min.js"></script>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light border-bottom">
        <div class="container">
            <a class="navbar-brand" href="../index.html">
                <i class="fas fa-brain"></i> ML & Math Blog
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="../index.html"><i class="fas fa-home"></i> 首页</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Post Content -->
    <article class="container post-container my-5">
        <!-- Breadcrumb Navigation -->
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="../index.html"><i class="fas fa-home"></i> 首页</a></li>
                
                <li class="breadcrumb-item"><a href="../index.html?tags=复数">复数</a></li>
                
                <li class="breadcrumb-item active" aria-current="page">
                    #87 Transformer升级之路：4、二维位置的旋转式位置编码
                </li>
            </ol>
        </nav>

        <!-- Post Header -->
        <header class="post-header mb-4">
            <h1 class="post-title">
                <span class="post-number">#87</span>
                Transformer升级之路：4、二维位置的旋转式位置编码
            </h1>
            <div class="post-meta">
                <span><i class="far fa-calendar"></i> </span>
                
                <span class="ms-3">
                    <i class="fas fa-link"></i>
                    <a href="https://spaces.ac.cn/archives/8397" target="_blank" rel="noopener">原文链接</a>
                </span>
                
            </div>
            
            <div class="post-tags mt-3">
                
                <a href="../index.html?tags=复数" class="tag-link">
                    <span class="tag"><i class="fas fa-tag"></i> 复数</span>
                </a>
                
                <a href="../index.html?tags=矩阵" class="tag-link">
                    <span class="tag"><i class="fas fa-tag"></i> 矩阵</span>
                </a>
                
                <a href="../index.html?tags=attention" class="tag-link">
                    <span class="tag"><i class="fas fa-tag"></i> attention</span>
                </a>
                
                <a href="../index.html?tags=位置编码" class="tag-link">
                    <span class="tag"><i class="fas fa-tag"></i> 位置编码</span>
                </a>
                
                <a href="../index.html?tags=rope" class="tag-link">
                    <span class="tag"><i class="fas fa-tag"></i> rope</span>
                </a>
                
            </div>
            
        </header>

        <div class="row">
            <!-- Main Content -->
            <div class="col-lg-9">
                <!-- Post Body -->
                <div class="post-content">
                    <h1 id="transformer4">Transformer升级之路：4、二维位置的旋转式位置编码<a class="toc-link" href="#transformer4" title="Permanent link">&para;</a></h1>
<p><strong>原文链接</strong>: <a href="https://spaces.ac.cn/archives/8397">https://spaces.ac.cn/archives/8397</a></p>
<p><strong>发布日期</strong>: </p>
<hr />
<p>在之前的文章<a href="/archives/8265">《Transformer升级之路：2、博采众长的旋转式位置编码》</a>中我们提出了旋转式位置编码RoPE以及对应的Transformer模型RoFormer。由于笔者主要研究的领域还是NLP，所以本来这个事情对于笔者来说已经完了。但是最近一段时间，Transformer模型在视觉领域也大火，各种Vision Transformer（ViT）层出不穷，于是就有了问题：二维情形的RoPE应该是怎样的呢？</p>
<p>咋看上去，这个似乎应该只是一维情形的简单推广，但其中涉及到的推导和理解却远比我们想象中复杂，本文就对此做一个分析，从而深化我们对RoPE的理解。</p>
<h2 id="rope">二维RoPE<a class="toc-link" href="#rope" title="Permanent link">&para;</a></h2>
<p>什么是二维位置？对应的二维RoPE又是怎样的？它的难度在哪里？在这一节中，我们先简单介绍二维位置，然后直接给出二维RoPE的结果和推导思路，在随后的几节中，我们再详细给出推导过程。</p>
<h3 id="_1">二维位置<a class="toc-link" href="#_1" title="Permanent link">&para;</a></h3>
<p>在NLP中，语言的位置信息是一维的，换句话说，我们需要告诉模型这个词是句子的第几个词；但是在CV中，图像的位置信息是二维的，即我们需要告诉模型这个特征是在第几行、第几列。这里的二维指的是完整描述位置信息需要两个数字，并不是指位置向量的维数。</p>
<p>有读者可能想：简单展平后当作一维的处理不行吗？确实不大行，比如一个$h\times h$的feature map，位置$(x,y)$展平后就变成了$xh + y$，而位置$(x+1,y)$和$(x,y+1)$展平后就分别变成了$xh+y+h$和$xh+y+1$，两者与$xh + y$的差分别是$h$和$1$。然而，按照我们直观的认识，$(x+1,y)$、$(x,y+1)$它们与$(x,y)$的距离应该是一样的才对，但是展平后却得到了不一样的$h$和$1$，这未免就不合理了。</p>
<p>所以，我们需要专门为二维情形设计的位置编码，不能简单地展平为一维来做。</p>
<h3 id="_2">标准答案<a class="toc-link" href="#_2" title="Permanent link">&para;</a></h3>
<p>经过后面的一番推导，得到二维RoPE的一个解为：<br />
\begin{equation}\boldsymbol{\mathcal{R}}_{x,y}=\left(
\begin{array}{cc:cc}
\cos x\theta &amp; -\sin x\theta &amp; 0 &amp; 0 \\
\sin x\theta &amp; \cos x\theta &amp; 0 &amp; 0 \\
\hdashline
0 &amp; 0 &amp; \cos y\theta &amp; -\sin y\theta \\
0 &amp; 0 &amp; \sin y\theta &amp; \cos y\theta \\
\end{array}\right)\label{eq:rope-2d}\end{equation}<br />
其中这个解很容易理解，它是两个一维RoPE组成的分块矩阵，实现上它就是将输入向量分为两半，一半施加$x$的一维RoPE，一半施加$y$的一维RoPE。由此形式我们也不难类比三维、四维等位置的RoPE。</p>
<p>矩阵$\eqref{eq:rope-2d}$是一个正交矩阵，它满足两个关键性质：</p>
<blockquote>
<p>1、<strong>相对性</strong> ：即$\boldsymbol{\mathcal{R}}<em x_2_y_2="x_2,y_2">{x_1,y_1}^{\top}\boldsymbol{\mathcal{R}}</em>$，也正是由于这个性质，RoPE才具有通过绝对位置实现相对位置的能力；}=\boldsymbol{\mathcal{R}}_{x_2-x_1,y_2-y_1</p>
<p>2、<strong>可逆性</strong> ：给定$\boldsymbol{\mathcal{R}}_{x,y}$可以反解出$x,y$，这意味着对位置信息的编码是无损的。</p>
</blockquote>
<p>某种意义上来说，式$\eqref{eq:rope-2d}$是满足上述两个性质的最简单解，也就是说，虽然存在略有不同的解满足上述两个性质，但是它们形式上和实现上都相对复杂些。</p>
<h3 id="_3">推导思路<a class="toc-link" href="#_3" title="Permanent link">&para;</a></h3>
<p>事后来看，RoPE其实就是找到了矩阵$\boldsymbol{\mathcal{R}}<em n-m="n-m">n=\begin{pmatrix}\cos n\theta &amp; -\sin n\theta\\ \sin n\theta &amp; \cos n\theta\end{pmatrix}$，使得满足“相对性”条件：<br />
\begin{equation}\boldsymbol{\mathcal{R}}_m^{\top}\boldsymbol{\mathcal{R}}_n=\boldsymbol{\mathcal{R}}</em>}\label{eq:re}\end{equation
所以，不难想到，二维RoPE的基本要求也是满足相对性，即要找到矩阵$\boldsymbol{\mathcal{R}}<em x_1_y_1="x_1,y_1">{x,y}$，使得它满足二维的相对性条件$\boldsymbol{\mathcal{R}}</em>}^{\top}\boldsymbol{\mathcal{R}<em x_2-x_1_y_2-y_1="x_2-x_1,y_2-y_1">{x_2,y_2}=\boldsymbol{\mathcal{R}}</em>$。不过，如果仅仅是这个要求的话，可行解就很多了，比如直接让<br />
\begin{equation}\boldsymbol{\mathcal{R}}_{x,y} = \begin{pmatrix}\cos (x+y)\theta &amp; -\sin (x+y)\theta\\ \sin (x+y)\theta &amp; \cos (x+y)\theta\end{pmatrix}\end{equation}<br />
但这个解的问题是，我们无法从$x+y$逆向推出$(x,y)$，这意味着这个选择对位置信息来说是有损的，所以我们需要多一个“可逆性”，保证可以从位置矩阵中无损地重构出原始位置信号。</p>
<p>对此，我们有两个比较自然的途径选择：1、四元数；2、矩阵指数。接下来我们将会逐一介绍它们。</p>
<h2 id="_4">四元数<a class="toc-link" href="#_4" title="Permanent link">&para;</a></h2>
<p>在一维RoPE的推导中，我们主要以复数为工具，而<a href="https://en.wikipedia.org/wiki/Quaternion">四元数（Quaternion）</a>是复数的推广，它同时也保留了复数的很多性质，所以用它来推导二维RoPE也算是一个自然的思路。不过很遗憾，这是一条 <em>走不通</em> 的途径，但笔者仍然将思考过程放置在此，供大家参考。</p>
<h3 id="_5">复数与矩阵<a class="toc-link" href="#_5" title="Permanent link">&para;</a></h3>
<p>在高中时我们就学习过，复数$a+b\boldsymbol{i}$跟二维向量$(a,b)$时一一对应的（为了跟后面的四元数对齐，这里把虚数单位$\boldsymbol{i}$也加粗了），但这个对应关系只能保持加减法对应（因为向量没有通用的乘法运算）。更精妙的对应是将复数与矩阵对应<br />
\begin{equation}a+b\boldsymbol{i} \quad \leftrightarrow \quad \begin{pmatrix} a &amp; -b \\ b &amp; a \end{pmatrix}\end{equation}<br />
在这个映射下，复数的加减乘除与矩阵的加减乘除一一对应，比如<br />
\begin{equation}\begin{array}{ccc}
(a+b\boldsymbol{i})(c+d\boldsymbol{i}) &amp;=&amp; (ac - bd) + (ad + bc)\boldsymbol{i} \\[5pt]
\begin{pmatrix} a &amp; -b \\ b &amp; a \end{pmatrix}\begin{pmatrix} c &amp; -d \\ d &amp; c \end{pmatrix} &amp;=&amp; \begin{pmatrix} ac - bd &amp; - ad - bc \\ ad + bc &amp; ac - bd \end{pmatrix}<br />
\end{array}\end{equation}<br />
所以，矩阵映射才是复数域的完全同构，而向量映射只是直观的几何理解。</p>
<p>复数的矩阵映射也是RoPE的重要基础，在<a href="/archives/8265">《Transformer升级之路：2、博采众长的旋转式位置编码》</a>中我们已经推导得到RoPE的复数表示是$\boldsymbol{q}e^{n\boldsymbol{i}\theta}=(\cos n\theta + \boldsymbol{i}\sin n\theta)\boldsymbol{q}$，所以根据复数的矩阵映射，$\cos n\theta + \boldsymbol{i}\sin n\theta$就对应着矩阵<br />
\begin{equation}\boldsymbol{\mathcal{R}}_n=\begin{pmatrix}\cos n\theta &amp; -\sin n\theta\\ \sin n\theta &amp; \cos n\theta\end{pmatrix}\end{equation}<br />
从而得到了一维RoPE的矩阵形式。</p>
<h3 id="_6">四元数简介<a class="toc-link" href="#_6" title="Permanent link">&para;</a></h3>
<p>前面说了，四元数是复数是一种推广，事实上它还是矩阵的“鼻祖”，从历史上来说，是先有四元数然后才有一般的矩阵运算，并且四元数启发了矩阵的很多运算。早年笔者也写了<a href="/archives/898">《与向量的渊源极深的四元数》</a>、<a href="/archives/2291">《几何的数与数的几何：超复数的浅探究》</a>等文章来介绍四元数，欢迎读者参考。</p>
<p>如果说复数是一个二维向量，那么四元数就是一个四维向量，表示为$a+b\boldsymbol{i}+c\boldsymbol{j}+d\boldsymbol{k}$，这里的$\boldsymbol{i}^2=\boldsymbol{j}^2=\boldsymbol{k}^2=-1$，但是它们本身都各不相等，几个基之间的运算规则是：<br />
\begin{array}{c|cccc}
\times &amp; 1 &amp; \boldsymbol{i} &amp; \boldsymbol{j} &amp; \boldsymbol{k} \\
\hline
1 &amp; 1 &amp; \boldsymbol{i} &amp; \boldsymbol{j} &amp; \boldsymbol{k} \\
\boldsymbol{i} &amp; \boldsymbol{i} &amp; -1 &amp; \boldsymbol{k} &amp; -\boldsymbol{j} \\
\boldsymbol{j} &amp; \boldsymbol{j} &amp; -\boldsymbol{k} &amp; -1 &amp; \boldsymbol{i} \\
\boldsymbol{k} &amp; \boldsymbol{k} &amp; \boldsymbol{j} &amp; -\boldsymbol{i} &amp; -1 \\
\end{array}<br />
在当时它给人们最大的冲击是非交换性，比如$\boldsymbol{i}\boldsymbol{j}=-\boldsymbol{j}\boldsymbol{i}\neq \boldsymbol{j}\boldsymbol{i}$。但除此之外，它跟复数运算其实是高度相似的。</p>
<p>比如类似复数的欧拉公式<br />
\begin{equation}e^{a+b\boldsymbol{i}+c\boldsymbol{j}+d\boldsymbol{k}} = e^a\left(\cos r + \frac{b\boldsymbol{i}+c\boldsymbol{j}+d\boldsymbol{k}}{r}\sin r\right)\label{eq:euler}\end{equation}<br />
这里$r = \Vert b\boldsymbol{i}+c\boldsymbol{j}+d\boldsymbol{k}\Vert = \sqrt{b^2+c^2+d^2}$。此外，还有类似的矩阵映射<br />
\begin{equation}
a+b\boldsymbol{i}+c\boldsymbol{j}+d\boldsymbol{k} \quad \leftrightarrow \quad \begin{pmatrix}
a &amp; -b &amp; -c &amp; -d \\
b &amp; a &amp; -d &amp; c \\
c &amp; d &amp; a &amp; -b \\
d &amp; -c &amp; b &amp; a
\end{pmatrix}\label{eq:mapping}\end{equation}</p>
<h3 id="_7">违背相对性<a class="toc-link" href="#_7" title="Permanent link">&para;</a></h3>
<p>关于这些公式背后的起源，那就说来话长了，这里也不打算细谈，有兴趣的读者请自行搜索资料阅读。有了欧拉公式和指数映射后，读者或许反应过来：一维RoPE无非是$e^{n\boldsymbol{i}\theta}$对应的矩阵映射，那么二维RoPE的话将$e^{x\boldsymbol{i}\theta + y\boldsymbol{j}\theta}$映射为矩阵形式不就行了？</p>
<p>笔者一开始也是这样想的，很遗憾，这是错的。错在哪里呢？在一维RoPE中，我们利用了内积的复数表示：<br />
\begin{equation}\langle\boldsymbol{q},\boldsymbol{k}\rangle=\text{Re}[\boldsymbol{q}\boldsymbol{k}^<em>]\end{equation}<br />
该恒等式在四元数中同样成立，因此可以照搬。接着我们利用了复指数：<br />
\begin{equation}\langle\boldsymbol{q}e^{m\boldsymbol{i}\theta},\boldsymbol{k}\boldsymbol{q}e^{n\boldsymbol{i}\theta}\rangle=\text{Re}\left[\left(\boldsymbol{q}e^{m\boldsymbol{i}\theta}\right)\left(\boldsymbol{k}e^{n\boldsymbol{i}\theta}\right)^</em>\right]=\text{Re}\left[\boldsymbol{q}e^{m\boldsymbol{i}\theta}e^{-n\boldsymbol{i}\theta}\boldsymbol{k}^<em>\right]=\text{Re}\left[\boldsymbol{q}e^{(m-n)\boldsymbol{i}\theta}\boldsymbol{k}^</em>\right]\end{equation}<br />
前两个等号都可以照搬到四元数中，关键是第三个等号在四元数中并不恒成立！一般地，对于两个四元数$\boldsymbol{p},\boldsymbol{q}$，等式$e^{\boldsymbol{p}+\boldsymbol{q}}=e^{\boldsymbol{p}}e^{\boldsymbol{q}}$并不成立！更广义来说，对于两个乘法不满足交换律的对象，一般都有$e^{\boldsymbol{p}+\boldsymbol{q}}\neq e^{\boldsymbol{p}}e^{\boldsymbol{q}}$。</p>
<p>所以，推导到最后，由于指数乘法无法转换为加法，最后的相对性没法得到保证。因此通过四元数推导这条路，就此夭折了...</p>
<h2 id="_8">矩阵指数<a class="toc-link" href="#_8" title="Permanent link">&para;</a></h2>
<p>四元数的矩阵映射表明四元数事实上代表了一簇特定的$4\times 4$矩阵，四元数推导走不通，那么或许使用一般的矩阵分析可以走得通。事实上确实如此，在这一节中，我们将利用矩阵指数给出一个推导结果。</p>
<h3 id="_9">矩阵指数<a class="toc-link" href="#_9" title="Permanent link">&para;</a></h3>
<p>这里的<a href="https://en.wikipedia.org/wiki/Matrix_exponential">矩阵指数</a>，并不是神经网络的用指数函数作为激活函数的逐位运算，而是是按照幂级数定义的运算：<br />
\begin{equation}\exp \boldsymbol{B} = \sum_{k=0}^{\infty}\frac{\boldsymbol{B}^k}{k!}\end{equation}<br />
其中$\boldsymbol{B}^k$是指按照矩阵乘法将$k$个$\boldsymbol{B}$连乘。关于矩阵指数，笔者之前曾写过<a href="/archives/6377">《恒等式 det(exp(A)) = exp(Tr(A)) 赏析》</a>，也欢迎参考阅读。</p>
<p>矩阵指数是非常重要的一种矩阵运算，它可以直接写出常系数微分方程组$\frac{d}{dt}\boldsymbol{x}_t=\boldsymbol{A}\boldsymbol{x}_t$的解：<br />
\begin{equation}\boldsymbol{x}_t = \big(\exp t\boldsymbol{A}\big)\boldsymbol{x}_0\end{equation}<br />
当然这跟本文的主题关系不大。对于RoPE的推导，我们主要利用到矩阵指数的如下性质：<br />
\begin{equation}\boldsymbol{A}\boldsymbol{B} = \boldsymbol{B}\boldsymbol{A} \quad\Rightarrow\quad \big(\exp \boldsymbol{A}\big)\big(\exp \boldsymbol{B}\big) = \exp \big(\boldsymbol{A} + \boldsymbol{B}\big)\label{eq:expm-ex}\end{equation}<br />
也就是说，如果$\boldsymbol{A},\boldsymbol{B}$的乘法可以交换，那么矩阵指数就可以像数的指数一样将乘法转换为加法。不过要注意这是一个充分不必要条件。</p>
<p>至于怎么把矩阵指数算出来，这里没法再展开介绍了，但是很多软件库已经自带了矩阵指数运算，比如数值计算库scipy和tensorflow都有<code>expm</code>函数，而符号计算的话，Mathematica里边有<code>MatrixExp</code>函数。</p>
<h3 id="_10">一维通解<a class="toc-link" href="#_10" title="Permanent link">&para;</a></h3>
<p>为什么能够将RoPE跟矩阵指数联系起来呢？因为一维的RoPE存在比较简单的指数表达式：<br />
\begin{equation}\boldsymbol{\mathcal{R}}_n=\begin{pmatrix}\cos n\theta &amp; -\sin n\theta\\ \sin n\theta &amp; \cos n\theta\end{pmatrix}=\exp\left\{n\theta\begin{pmatrix}0 &amp; -1\\ 1 &amp; 0\end{pmatrix}\right\}\label{eq:rope-exp}\end{equation}<br />
于是笔者开始思考如下形式的矩阵作为RoPE的解：<br />
\begin{equation}\boldsymbol{\mathcal{R}}_n=\exp n\boldsymbol{B}\end{equation}<br />
其中$\boldsymbol{B}$是一个跟$n$无关的矩阵。RoPE的必要条件是满足“相对性”条件$\eqref{eq:re}$，于是我们分析<br />
\begin{equation}\big(\exp m\boldsymbol{B}\big)^{\top}\big(\exp n\boldsymbol{B}\big) = \big(\exp m\boldsymbol{B}^{\top}\big)\big(\exp n\boldsymbol{B}\big)\end{equation}<br />
这里先假设$\boldsymbol{B}^{\top},\boldsymbol{B}$是可交换的，那么根据式$\eqref{eq:expm-ex}$有<br />
\begin{equation}\big(\exp m\boldsymbol{B}^{\top}\big)\big(\exp n\boldsymbol{B}\big) = \exp \big(m\boldsymbol{B}^{\top} + n\boldsymbol{B}\big)\end{equation}<br />
要让$m\boldsymbol{B}^{\top} + n\boldsymbol{B}=(n-m)\boldsymbol{B}$，只需要满足<br />
\begin{equation}\boldsymbol{B}^{\top} = - \boldsymbol{B}\end{equation}<br />
这便是“相对性”给出的约束条件，刚才我们还假设了$\boldsymbol{B}^{\top},\boldsymbol{B}$是可交换的，现在可以检验满足这个等式的$\boldsymbol{B}^{\top},\boldsymbol{B}$一定是可交换的，所以结果是自洽的。</p>
<p>这也就是说，对于任何满足$\boldsymbol{B}^{\top} + \boldsymbol{B} = 0$的矩阵$\boldsymbol{B}$，$\exp n\boldsymbol{B}$都是方程$\eqref{eq:re}$的解，并且还可以证明它一定是正交矩阵。当然，根据$\exp n\boldsymbol{B}=\left(\exp \boldsymbol{B}\right)^n$，我们更直接的得到：对于任意正交矩阵$\boldsymbol{O}$，$\boldsymbol{\mathcal{R}}_n=\boldsymbol{O}^n$都是方程$\eqref{eq:re}$的解。</p>
<p>对于$2\times 2$的矩阵来说，$\boldsymbol{B}^{\top} + \boldsymbol{B} = 0$的通解是$\boldsymbol{B}=\begin{pmatrix}0 &amp; -\theta\\ \theta &amp; 0\end{pmatrix}$，于是就有了如式$\eqref{eq:rope-exp}$的解。</p>
<h3 id="_11">二维约束<a class="toc-link" href="#_11" title="Permanent link">&para;</a></h3>
<p>类似地，对于二维RoPE，我们考虑<br />
\begin{equation}\boldsymbol{\mathcal{R}}_{x,y}=\exp \big(x\boldsymbol{B}_1 + y\boldsymbol{B}_2\big)\end{equation}<br />
作为候选解。重复上述关于“相对性”条件的推导：先假设$x_1\boldsymbol{B}_1^{\top} + y_1\boldsymbol{B}_2^{\top}$与$x_2\boldsymbol{B}_1 + y_2\boldsymbol{B}_2$是可交换的，那么我们可以得到如下约束条件：<br />
\begin{equation}\boldsymbol{B}_1^{\top} + \boldsymbol{B}_1 = 0,\quad \boldsymbol{B}_2^{\top} + \boldsymbol{B}_2 = 0\end{equation}<br />
然而，$x_1\boldsymbol{B}_1^{\top} + y_1\boldsymbol{B}_2^{\top}$与$x_2\boldsymbol{B}_1 + y_2\boldsymbol{B}_2$可交换，意味着$(\boldsymbol{B}_1,\boldsymbol{B}_1^{\top})$、$(\boldsymbol{B}_2,\boldsymbol{B}_2^{\top})$、$(\boldsymbol{B}_1,\boldsymbol{B}_2^{\top})$和$(\boldsymbol{B}_2,\boldsymbol{B}_1^{\top})$都可交换，但是上述两个约束只能保证$(\boldsymbol{B}_1,\boldsymbol{B}_1^{\top})$和$(\boldsymbol{B}_2,\boldsymbol{B}_2^{\top})$可交换，不能保证后两者的交换性，所以我们需要把它作为约束条件补充上去，得到：<br />
\begin{equation}\left\{\begin{aligned}
&amp;\boldsymbol{B}_1^{\top} + \boldsymbol{B}_1 = 0\\
&amp;\boldsymbol{B}_2^{\top} + \boldsymbol{B}_2 = 0\\
&amp;\boldsymbol{B}_1 \boldsymbol{B}_2^{\top} = \boldsymbol{B}_2^{\top} \boldsymbol{B}_1
\end{aligned}\right.\label{eq:2d-conds}\end{equation}<br />
不难证明在前两个条件下，新增的约束条件也相当于$\boldsymbol{B}_1 \boldsymbol{B}_2 = \boldsymbol{B}_2 \boldsymbol{B}_1$。</p>
<h3 id="rope_1">RoPE现身<a class="toc-link" href="#rope_1" title="Permanent link">&para;</a></h3>
<p>由于满足前两个条件的$2\times 2$矩阵只有一个独立参数，不满足“可逆性”，所以我们至少要考虑$3\times 3$矩阵，它有3个独立参数<br />
\begin{equation}\begin{pmatrix}0 &amp; -a &amp; -b \\ a &amp; 0 &amp; -c \\ b &amp; c &amp; 0\end{pmatrix}\end{equation}<br />
为了保证可逆性，我们不妨设$\boldsymbol{B}_1,\boldsymbol{B}_2$是“正交”的，比如设：<br />
\begin{equation}\boldsymbol{B}_1=\begin{pmatrix}0 &amp; -a &amp; 0 \\ a &amp; 0 &amp; 0 \\ 0 &amp; 0 &amp; 0\end{pmatrix},\quad\boldsymbol{B}_2=\begin{pmatrix}0 &amp; 0 &amp; -b \\ 0 &amp; 0 &amp; -c \\ b &amp; c &amp; 0\end{pmatrix}\end{equation}<br />
不失一般性还可以设$a=1$，那么由条件$\eqref{eq:2d-conds}$解得$b=0,c=0$，即$\boldsymbol{B}_2$只能是全零解，这不符合我们的要求。Mathematica的求解代码为：</p>
<div class="highlight"><pre><span></span><code><span class="x">B[a_, b_, c_] = </span><span class="cp">{{</span><span class="m">0</span><span class="o">,</span> <span class="o">-</span><span class="nv">a</span><span class="o">,</span> <span class="o">-</span><span class="nv">b</span><span class="o">},</span> <span class="o">{</span><span class="nv">a</span><span class="o">,</span> <span class="m">0</span><span class="o">,</span> <span class="o">-</span><span class="nv">c</span><span class="o">},</span> <span class="o">{</span><span class="nv">b</span><span class="o">,</span> <span class="nv">c</span><span class="o">,</span> <span class="m">0</span><span class="cp">}}</span><span class="x">;</span>
<span class="x">B1 = B[1, 0, 0];</span>
<span class="x">B2 = B[0, b, c];</span>
<span class="x">Solve[{Dot[B1, B2] == Dot[B2, B1]}, {b, c}]</span>
</code></pre></div>

<p>因此，我们至少要考虑$4\times 4$矩阵，它有6个独立参数，不失一般性，考虑正交分解：<br />
\begin{equation}\boldsymbol{B}_1=\begin{pmatrix}0 &amp; -a &amp; -b &amp; 0 \\ a &amp; 0 &amp; -c &amp; 0 \\ b &amp; c &amp; 0 &amp; 0 \\ 0 &amp; 0 &amp; 0 &amp; 0\end{pmatrix},\quad\boldsymbol{B}_2=\begin{pmatrix}0 &amp; 0 &amp; 0 &amp; -d \\ 0 &amp; 0 &amp; 0 &amp; -e \\ 0 &amp; 0 &amp; 0 &amp; -f \\ d &amp; e &amp; f &amp; 0\end{pmatrix}\end{equation}<br />
解得<br />
\begin{equation}d=cf,\quad e=-bf\end{equation}<br />
求解代码：</p>
<div class="highlight"><pre><span></span><code>B[a_, b_, c_, d_, e_, 
   f_] = {{0, -a, -b, -d}, {a, 0, -c, -e}, {b, c, 0, -f}, {d, e, f, 
    0}};
B1 = B[1, b, c, 0, 0, 0];
B2 = B[0, 0, 0, d, e, f];
Solve[{Dot[B1, B2] == Dot[B2, B1]}, {b, c, d, e, f}]
</code></pre></div>

<p>可以发现结果没有对$f$提出约束，所以从最简单起见，我们可以让$f=1$，剩下的$b,c,d,e$全部为0，此时<br />
\begin{equation}\boldsymbol{\mathcal{R}}<em x_y="x,y">{x,y}=\exp \,\begin{pmatrix}0 &amp; -x &amp; 0 &amp; 0 \\ x &amp; 0 &amp; 0 &amp; 0 \\ 0 &amp; 0 &amp; 0 &amp; -y \\ 0 &amp; 0 &amp; y &amp; 0\end{pmatrix}\end{equation}<br />
可以增加个参数$\theta$，完成展开，就得到：<br />
\begin{equation}\boldsymbol{\mathcal{R}}</em>=\left(}=\exp \,\left\{\begin{pmatrix}0 &amp; -x &amp; 0 &amp; 0 \\ x &amp; 0 &amp; 0 &amp; 0 \\ 0 &amp; 0 &amp; 0 &amp; -y \\ 0 &amp; 0 &amp; y &amp; 0\end{pmatrix}\theta\right\<br />
\begin{array}{cc:cc}
\cos x\theta &amp; -\sin x\theta &amp; 0 &amp; 0 \\
\sin x\theta &amp; \cos x\theta &amp; 0 &amp; 0 \\
\hdashline
0 &amp; 0 &amp; \cos y\theta &amp; -\sin y\theta \\
0 &amp; 0 &amp; \sin y\theta &amp; \cos y\theta \\
\end{array}\right)\end{equation}</p>
<h2 id="_12">延伸故事<a class="toc-link" href="#_12" title="Permanent link">&para;</a></h2>
<p>至此，关于二维RoPE的推导介绍完毕。现在读者可能想问的是效果如何？很遗憾，现在还没有很完整的实验结果，毕竟笔者之前也没做过ViT相关的工作，而这个二维RoPE的推导也刚完成没多久，所以进展比较慢，只能说初步的结果显示还是挺有效的。EleutherAI团队的成员也实验过这个方案，效果也比已有的其他位置编码好。</p>
<p>说到EleutherAI团队，这里再多说几句。EleutherAI团队是前段时候比较火的号称要“复现GPT3”的那个团队，我们在文章<a href="/archives/8265">《Transformer升级之路：2、博采众长的旋转式位置编码》</a>中提出了RoPE及RoFormer后，有幸得到了EleutherAI团队的关注，他们做了很多补充实验，确认了RoPE比很多其他位置编码都更加有效（参考他们的博客<a href="https://blog.eleuther.ai/rotary-embeddings/">《Rotary Embeddings: A Relative Revolution》</a>），这促使我们完成了英文论文<a href="https://papers.cool/arxiv/2104.09864">《RoFormer: Enhanced Transformer with Rotary Position Embedding》</a>并提交到了Arxiv上。而关于二维RoPE的疑问，最初也是来源于EleutherAI团队。</p>
<h2 id="_13">文章小结<a class="toc-link" href="#_13" title="Permanent link">&para;</a></h2>
<p>本文介绍了我们对RoPE的二维推广，主要以“相对性”、“可逆性”为出发点来确定二维RoPE的最终形式，尝试了四元数和矩阵指数两种推导过程，最终通过矩阵指数来给出了最终的解，从推导过程中我们还可以深化对RoPE的理解。</p>
<p><em><strong>转载到请包括本文地址：</strong><a href="https://spaces.ac.cn/archives/8397">https://spaces.ac.cn/archives/8397</a></em></p>
<p><em><strong>更详细的转载事宜请参考：</strong></em><a href="https://spaces.ac.cn/archives/6508#%E6%96%87%E7%AB%A0%E5%A6%82%E4%BD%95%E8%BD%AC%E8%BD%BD/%E5%BC%95%E7%94%A8" title="《科学空间FAQ》">《科学空间FAQ》</a></p>
<p><strong>如果您还有什么疑惑或建议，欢迎在下方评论区继续讨论。</strong></p>
<p><strong>如果您觉得本文还不错，欢迎分享/打赏本文。打赏并非要从中获得收益，而是希望知道科学空间获得了多少读者的真心关注。当然，如果你无视它，也不会影响你的阅读。再次表示欢迎和感谢！</strong></p>
<p>打赏</p>
<p><img alt="科学空间" src="https://spaces.ac.cn/usr/themes/geekg/payment/wx.png" /></p>
<p>微信打赏</p>
<p><img alt="科学空间" src="https://spaces.ac.cn/usr/themes/geekg/payment/zfb.png" /></p>
<p>支付宝打赏</p>
<p>因为网站后台对打赏并无记录，因此欢迎在打赏时候备注留言。你还可以<a href="http://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&amp;email=tN7d1drY3drrx8H0xcWa19vZ"><strong>点击这里</strong></a>或在下方评论区留言来告知你的建议或需求。</p>
<p><strong>如果您需要引用本文，请参考：</strong></p>
<p>苏剑林. (May. 10, 2021). 《Transformer升级之路：4、二维位置的旋转式位置编码 》[Blog post]. Retrieved from <a href="https://spaces.ac.cn/archives/8397">https://spaces.ac.cn/archives/8397</a></p>
<p>@online{kexuefm-8397,<br />
title={Transformer升级之路：4、二维位置的旋转式位置编码},<br />
author={苏剑林},<br />
year={2021},<br />
month={May},<br />
url={\url{https://spaces.ac.cn/archives/8397}},<br />
} </p>
<hr />
<h2 id="_14">公式推导与注释<a class="toc-link" href="#_14" title="Permanent link">&para;</a></h2>
<p>TODO: 添加详细的数学公式推导和注释</p>
                </div>

                <!-- Previous/Next Navigation -->
                <nav class="post-navigation" aria-label="文章导航">
                    <div class="row g-3">
                        <div class="col-6">
                            
                            <a href="univae基于transformer的单模型多尺度的vae模型.html" class="nav-link-prev">
                                <div class="nav-direction"><i class="fas fa-chevron-left"></i> 上一篇</div>
                                <div class="nav-title">#86 UniVAE：基于Transformer的单模型、多尺度的VAE模型</div>
                            </a>
                            
                        </div>
                        <div class="col-6">
                            
                            <a href="用bert4keras做三元组抽取.html" class="nav-link-next">
                                <div class="nav-direction">下一篇 <i class="fas fa-chevron-right"></i></div>
                                <div class="nav-title">#88 用bert4keras做三元组抽取</div>
                            </a>
                            
                        </div>
                    </div>
                </nav>

                <!-- Back to Home -->
                <div class="text-center mt-4 mb-4">
                    <a href="../index.html" class="btn btn-outline-primary">
                        <i class="fas fa-arrow-left"></i> 返回首页
                    </a>
                </div>
            </div>

            <!-- Sidebar (TOC) -->
            <div class="col-lg-3">
                <aside class="sidebar">
                    
                    <div class="toc-sidebar">
                        <h5 class="toc-title"><i class="fas fa-list"></i> 目录</h5>
                        <div class="toc-content">
                            <div class="toc">
<ul>
<li><a href="#transformer4">Transformer升级之路：4、二维位置的旋转式位置编码</a><ul>
<li><a href="#rope">二维RoPE</a><ul>
<li><a href="#_1">二维位置</a></li>
<li><a href="#_2">标准答案</a></li>
<li><a href="#_3">推导思路</a></li>
</ul>
</li>
<li><a href="#_4">四元数</a><ul>
<li><a href="#_5">复数与矩阵</a></li>
<li><a href="#_6">四元数简介</a></li>
<li><a href="#_7">违背相对性</a></li>
</ul>
</li>
<li><a href="#_8">矩阵指数</a><ul>
<li><a href="#_9">矩阵指数</a></li>
<li><a href="#_10">一维通解</a></li>
<li><a href="#_11">二维约束</a></li>
<li><a href="#rope_1">RoPE现身</a></li>
</ul>
</li>
<li><a href="#_12">延伸故事</a></li>
<li><a href="#_13">文章小结</a></li>
<li><a href="#_14">公式推导与注释</a></li>
</ul>
</li>
</ul>
</div>

                        </div>
                        <div class="toc-actions">
                            <button class="btn btn-sm btn-outline-secondary" onclick="expandAll()">
                                <i class="fas fa-expand"></i> 全部展开
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="collapseAll()">
                                <i class="fas fa-compress"></i> 全部折叠
                            </button>
                        </div>
                    </div>
                    

                    <!-- Back to Top Button -->
                    <button id="backToTop" class="back-to-top" title="回到顶部">
                        <i class="fas fa-arrow-up"></i>
                    </button>
                </aside>
            </div>
        </div>
    </article>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p>
                博客来源: <a href="https://spaces.ac.cn" target="_blank">科学空间</a> |
                内容经过整理并添加详细数学推导
            </p>
            <p>
                Powered by <a href="https://pages.github.com/" target="_blank">GitHub Pages</a>
            </p>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Syntax highlighting -->
    <script>hljs.highlightAll();</script>

    <!-- Back to top functionality -->
    <script>
        // Show/hide back to top button based on scroll position
        window.addEventListener('scroll', function() {
            const backToTop = document.getElementById('backToTop');
            if (window.pageYOffset > 300) {
                backToTop.classList.add('show');
            } else {
                backToTop.classList.remove('show');
            }
        });

        // Smooth scroll to top
        document.getElementById('backToTop').addEventListener('click', function() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        });

        // Sticky TOC sidebar
        window.addEventListener('scroll', function() {
            const sidebar = document.querySelector('.sidebar');
            if (!sidebar) return;

            const sidebarTop = sidebar.offsetTop;
            const scrollTop = window.pageYOffset;

            if (scrollTop > sidebarTop - 20) {
                sidebar.classList.add('sticky');
            } else {
                sidebar.classList.remove('sticky');
            }
        });
    </script>
</body>
</html>