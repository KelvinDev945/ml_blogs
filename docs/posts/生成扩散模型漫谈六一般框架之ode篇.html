<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>生成扩散模型漫谈（六）：一般框架之ODE篇 | ML & Math Blog Posts</title>
    <meta name="description" content="生成扩散模型漫谈（六）：一般框架之ODE篇&para;
原文链接: https://spaces.ac.cn/archives/9228
发布日期: 

上一篇文章《生成扩散模型漫谈（五）：一般框架之SDE篇》中，我们对宋飏博士的论文《Score-Based Generative Modeling through Stochastic Differential Equations》做了基本的介绍和...">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css">

    <!-- Google Fonts -->
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="../assets/css/main.css">
    <link rel="stylesheet" href="../assets/css/post.css">

    <!-- Custom JS -->
    <script src="../assets/js/collapsible.js" defer></script>

    <!-- MathJax for math rendering -->
    <script>
    MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']],
        processEscapes: true,
        processEnvironments: true
      },
      options: {
        skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
      }
    };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <!-- Syntax highlighting -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.7.0/build/styles/github.min.css">
    <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.7.0/build/highlight.min.js"></script>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light border-bottom">
        <div class="container">
            <a class="navbar-brand" href="../index.html">
                <i class="fas fa-brain"></i> ML & Math Blog
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="../index.html"><i class="fas fa-home"></i> 首页</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Post Content -->
    <article class="container post-container my-5">
        <!-- Breadcrumb Navigation -->
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="../index.html"><i class="fas fa-home"></i> 首页</a></li>
                
                <li class="breadcrumb-item"><a href="../index.html?tags=详细推导">详细推导</a></li>
                
                <li class="breadcrumb-item active" aria-current="page">
                    #54 生成扩散模型漫谈（六）：一般框架之ODE篇
                </li>
            </ol>
        </nav>

        <!-- Post Header -->
        <header class="post-header mb-4">
            <h1 class="post-title">
                <span class="post-number">#54</span>
                生成扩散模型漫谈（六）：一般框架之ODE篇
            </h1>
            <div class="post-meta">
                <span><i class="far fa-calendar"></i> 2022-08-08</span>
                
            </div>
            
            <div class="post-tags mt-3">
                
                <a href="../index.html?tags=详细推导" class="tag-link">
                    <span class="tag"><i class="fas fa-tag"></i> 详细推导</span>
                </a>
                
                <a href="../index.html?tags=flow模型" class="tag-link">
                    <span class="tag"><i class="fas fa-tag"></i> flow模型</span>
                </a>
                
                <a href="../index.html?tags=微分方程" class="tag-link">
                    <span class="tag"><i class="fas fa-tag"></i> 微分方程</span>
                </a>
                
                <a href="../index.html?tags=生成模型" class="tag-link">
                    <span class="tag"><i class="fas fa-tag"></i> 生成模型</span>
                </a>
                
                <a href="../index.html?tags=DDPM" class="tag-link">
                    <span class="tag"><i class="fas fa-tag"></i> DDPM</span>
                </a>
                
                <a href="../index.html?tags=扩散" class="tag-link">
                    <span class="tag"><i class="fas fa-tag"></i> 扩散</span>
                </a>
                
            </div>
            
        </header>

        <div class="row">
            <!-- Main Content -->
            <div class="col-lg-9">
                <!-- Post Body -->
                <div class="post-content">
                    <h1 id="ode">生成扩散模型漫谈（六）：一般框架之ODE篇<a class="toc-link" href="#ode" title="Permanent link">&para;</a></h1>
<p><strong>原文链接</strong>: <a href="https://spaces.ac.cn/archives/9228">https://spaces.ac.cn/archives/9228</a></p>
<p><strong>发布日期</strong>: </p>
<hr />
<p>上一篇文章<a href="/archives/9209">《生成扩散模型漫谈（五）：一般框架之SDE篇》</a>中，我们对宋飏博士的论文<a href="https://papers.cool/arxiv/2011.13456">《Score-Based Generative Modeling through Stochastic Differential Equations》</a>做了基本的介绍和推导。然而，顾名思义，上一篇文章主要涉及的是原论文中SDE相关的部分，而遗留了被称为“概率流ODE（Probability flow ODE）”的部分内容，所以本文对此做个补充分享。</p>
<p>事实上，遗留的这部分内容在原论文的正文中只占了一小节的篇幅，但我们需要新开一篇文章来介绍它，因为笔者想了很久后发现，该结果的推导还是没办法绕开Fokker-Planck方程，所以我们需要一定的篇幅来介绍Fokker-Planck方程，然后才能请主角ODE登场。</p>
<h2 id="_1">再次反思<a class="toc-link" href="#_1" title="Permanent link">&para;</a></h2>
<p>我们来大致总结一下上一篇文章的内容：首先，我们通过SDE来定义了一个前向过程（“拆楼”）：<br />
\begin{equation}d\boldsymbol{x} = \boldsymbol{f}<em _boldsymbol_x="\boldsymbol{x">t(\boldsymbol{x}) dt + g_t d\boldsymbol{w}\label{eq:sde-forward}\end{equation}<br />
然后，我们推导了相应的逆向过程的SDE（“建楼”）：<br />
\begin{equation}d\boldsymbol{x} = \left[\boldsymbol{f}_t(\boldsymbol{x}) - g_t^2\nabla</em>}}\log p_t(\boldsymbol{x}) \right] dt + g_t d\boldsymbol{w}\label{eq:sde-reverse}\end{equation<br />
最后，我们推导了用神经网络$\boldsymbol{s}<em _boldsymbol_x="\boldsymbol{x">{\boldsymbol{\theta}}(\boldsymbol{x}, t)$来估计$\nabla</em>)$的损失函数（得分匹配）：}}\log p_t(\boldsymbol{x<br />
\begin{equation}\mathbb{E}<em _boldsymbol_theta="\boldsymbol{\theta">{\boldsymbol{x}_0,\boldsymbol{x}_t \sim p(\boldsymbol{x}_t|\boldsymbol{x}_0)\tilde{p}(\boldsymbol{x}_0)}\left[\left\Vert \boldsymbol{s}</em>}}(\boldsymbol{x<em _boldsymbol_x="\boldsymbol{x">t, t) - \nabla</em>}_t} \log p(\boldsymbol{x}_t|\boldsymbol{x}_0)\right\Vert^2\right] \end{equation<br />
至此，我们完成了扩散模型的训练、预测的一般框架，可以说，它是DDPM的非常一般化的推广了。但正如<a href="/archives/9181">《生成扩散模型漫谈（四）：DDIM = 高观点DDPM》</a>中介绍的DDIM是DDPM的高观点反思结果，SDE作为DDPM的推广，有没有相应的“高观点反思结果”呢？有，其结果就是本文主题“概率流ODE”。</p>
<h2 id="dirac">Dirac函数<a class="toc-link" href="#dirac" title="Permanent link">&para;</a></h2>
<p>DDIM做了什么反思呢？很简单，DDIM发现DDPM的训练目标主要跟$p(\boldsymbol{x}<em t-1="t-1">t|\boldsymbol{x}_0)$有关，而跟$p(\boldsymbol{x}_t|\boldsymbol{x}</em>})$无关，所以它以$p(\boldsymbol{x<em t-1="t-1">t|\boldsymbol{x}_0)$为出发点，去推导更一般的$p(\boldsymbol{x}</em>}|\boldsymbol{x<em t-1="t-1">t,\boldsymbol{x}_0)$和$p(\boldsymbol{x}_t|\boldsymbol{x}</em>},\boldsymbol{x<em t="t" t_Delta="t+\Delta">0)$。概率流ODE做的反思是类似的，它想知道在SDE框架中，对于固定的$p(\boldsymbol{x}_t)$，能找出哪些不同的$p(\boldsymbol{x}</em>_t)$（或者说找到不同的前向过程SDE）。}|\boldsymbol{x</p>
<p>我们先写出前向过程$\eqref{eq:sde-forward}$的离散形式<br />
\begin{equation}\boldsymbol{x}<em t="t" t_Delta="t+\Delta">{t+\Delta t} = \boldsymbol{x}_t + \boldsymbol{f}_t(\boldsymbol{x}_t) \Delta t + g_t \sqrt{\Delta t}\boldsymbol{\varepsilon},\quad \boldsymbol{\varepsilon}\sim \mathcal{N}(\boldsymbol{0}, \boldsymbol{I})\label{eq:sde-discrete}\end{equation}<br />
这个等式描述的是随机变量$\boldsymbol{x}</em>},\boldsymbol{x<em _boldsymbol_y="\boldsymbol{y">t,\boldsymbol{\varepsilon}$之间的关系，我们可以方便地对两边求期望，然而我们并非想求期望，而是想求分布$p(\boldsymbol{y}_t)$（所满足的关系式）。怎么将分布转换成期望形式呢？答案是<a href="/archives/1870">Dirac函数</a>：<br />
\begin{equation}p(\boldsymbol{x}) = \int \delta(\boldsymbol{x} - \boldsymbol{y}) p(\boldsymbol{y}) d\boldsymbol{y} = \mathbb{E}</em>}}[\delta(\boldsymbol{x} - \boldsymbol{y})]\end{equation<br />
Dirac函数严格定义是属于泛函分析的内容，但我们通常都是当它是普通函数来处理，一般都能得到正确的结果。由上式还可以得知，对于任意$f(\boldsymbol{x})$，成立<br />
\begin{equation}p(\boldsymbol{x})f(\boldsymbol{x}) = \int \delta(\boldsymbol{x} - \boldsymbol{y}) p(\boldsymbol{y})f(\boldsymbol{y}) d\boldsymbol{y} = \mathbb{E}<em _boldsymbol_x="\boldsymbol{x">{\boldsymbol{y}}[\delta(\boldsymbol{x} - \boldsymbol{y}) f(\boldsymbol{y})]\end{equation}<br />
直接对上式两边求偏导数，得到<br />
\begin{equation}\nabla</em>}}[p(\boldsymbol{x}) f(\boldsymbol{x})] = \mathbb{E<em _boldsymbol_x="\boldsymbol{x">{\boldsymbol{y}}\left[\nabla</em>}}\delta(\boldsymbol{x} - \boldsymbol{y}) f(\boldsymbol{y})\right] = \mathbb{E<em _boldsymbol_x="\boldsymbol{x">{\boldsymbol{y}}\left[f(\boldsymbol{y})\nabla</em>}}\delta(\boldsymbol{x} - \boldsymbol{y})\right]\end{equation<br />
这是后面要用到的性质之一，可以发现它本质上是狄拉克函数的导数能够通过积分转移到所乘函数上去。</p>
<h2 id="f-p">F-P方程<a class="toc-link" href="#f-p" title="Permanent link">&para;</a></h2>
<p>经过上述铺垫，现在我们根据式$\eqref{eq:sde-discrete}$写出<br />
\begin{equation}\begin{aligned}<br />
&amp;\,\delta(\boldsymbol{x} - \boldsymbol{x}<em _boldsymbol_x="\boldsymbol{x">{t+\Delta t}) \\[5pt]<br />
=&amp;\, \delta(\boldsymbol{x} - \boldsymbol{x}_t - \boldsymbol{f}_t(\boldsymbol{x}_t) \Delta t - g_t \sqrt{\Delta t}\boldsymbol{\varepsilon}) \\<br />
\approx&amp;\, \delta(\boldsymbol{x} - \boldsymbol{x}_t) - \left(\boldsymbol{f}_t(\boldsymbol{x}_t) \Delta t + g_t \sqrt{\Delta t}\boldsymbol{\varepsilon}\right)\cdot \nabla</em>}}\delta(\boldsymbol{x} - \boldsymbol{x<em _boldsymbol_x="\boldsymbol{x">t) + \frac{1}{2} \left(g_t\sqrt{\Delta t}\boldsymbol{\varepsilon}\cdot \nabla</em>}}\right)^2\delta(\boldsymbol{x} - \boldsymbol{x<em t="t" t_Delta="t+\Delta">t)<br />
\end{aligned}\end{equation}<br />
这里当$\delta(\cdot)$是普通函数那样做了泰勒展开，只保留了不超过$\mathcal{O}(\Delta t)$的项。现在我们两边求期望：<br />
\begin{equation}\begin{aligned}<br />
&amp;\,p</em>) \\[6pt]}(\boldsymbol{x<br />
=&amp;\,\mathbb{E}<em t="t" t_Delta="t+\Delta">{\boldsymbol{x}</em>}}\left[\delta(\boldsymbol{x} - \boldsymbol{x<em _boldsymbol_x="\boldsymbol{x">{t+\Delta t})\right] \\<br />
\approx&amp;\, \mathbb{E}</em><em _boldsymbol_x="\boldsymbol{x">t, \boldsymbol{\varepsilon}}\left[\delta(\boldsymbol{x} - \boldsymbol{x}_t) - \left(\boldsymbol{f}_t(\boldsymbol{x}_t) \Delta t + g_t \sqrt{\Delta t}\boldsymbol{\varepsilon}\right)\cdot \nabla</em>}}\delta(\boldsymbol{x} - \boldsymbol{x<em _boldsymbol_x="\boldsymbol{x">t) + \frac{1}{2} \left(g_t\sqrt{\Delta t}\boldsymbol{\varepsilon}\cdot \nabla</em>}}\right)^2\delta(\boldsymbol{x} - \boldsymbol{x<em _boldsymbol_x="\boldsymbol{x">t)\right] \\<br />
=&amp;\, \mathbb{E}</em><em _boldsymbol_x="\boldsymbol{x">t}\left[\delta(\boldsymbol{x} - \boldsymbol{x}_t) - \boldsymbol{f}_t(\boldsymbol{x}_t) \Delta t\cdot \nabla</em>}}\delta(\boldsymbol{x} - \boldsymbol{x<em _boldsymbol_x="\boldsymbol{x">t) + \frac{1}{2} g_t^2\Delta t \nabla</em>}}\cdot \nabla_{\boldsymbol{x}}\delta(\boldsymbol{x} - \boldsymbol{x<em _boldsymbol_x="\boldsymbol{x">t)\right] \\<br />
=&amp;\,p_t(\boldsymbol{x}) - \nabla</em>}}\cdot\left[\boldsymbol{f<em _boldsymbol_x="\boldsymbol{x">t(\boldsymbol{x})\Delta t\, p_t(\boldsymbol{x})\right] + \frac{1}{2}g_t^2\Delta t \nabla</em>)}}\cdot\nabla_{\boldsymbol{x}}p_t(\boldsymbol{x<br />
\end{aligned}\end{equation}<br />
两边除以$\Delta t$，并取$\Delta t\to 0$的极限，结果是<br />
\begin{equation}\frac{\partial}{\partial t} p_t(\boldsymbol{x}) = - \nabla_{\boldsymbol{x}}\cdot\left[\boldsymbol{f}<em _boldsymbol_x="\boldsymbol{x">t(\boldsymbol{x}) p_t(\boldsymbol{x})\right] + \frac{1}{2}g_t^2 \nabla</em>}}\cdot\nabla_{\boldsymbol{x}}p_t(\boldsymbol{x})\label{eq:fp<br />
\end{equation}<br />
这就是式$\eqref{eq:sde-forward}$所对应的“F-P方程”（<a href="https://en.wikipedia.org/wiki/Fokker%E2%80%93Planck_equation">Fokker-Planck方程</a>），它是描述边际分布的偏微分方程。</p>
<h2 id="_2">等价变换<a class="toc-link" href="#_2" title="Permanent link">&para;</a></h2>
<p>大家看到偏微分方程不用担心，因为这里并没有打算去研究怎么求解偏微分方程，只是借助它来引导一个等价变换而已。对于任意满足$\sigma_t^2\leq g_t^2$的函数$\sigma_t$，F-P方程$\eqref{eq:fp}$完全等价于<br />
\begin{equation}\begin{aligned}<br />
\frac{\partial}{\partial t} p_t(\boldsymbol{x}) =&amp;\, - \nabla_{\boldsymbol{x}}\cdot\left[\boldsymbol{f}<em _boldsymbol_x="\boldsymbol{x">t(\boldsymbol{x})p_t(\boldsymbol{x}) - \frac{1}{2}(g_t^2 - \sigma_t^2)\nabla</em>) \\}}p_t(\boldsymbol{x})\right] + \frac{1}{2}\sigma_t^2 \nabla_{\boldsymbol{x}}\cdot\nabla_{\boldsymbol{x}}p_t(\boldsymbol{x<br />
=&amp;\,- \nabla_{\boldsymbol{x}}\cdot\left[\left(\boldsymbol{f}<em _boldsymbol_x="\boldsymbol{x">t(\boldsymbol{x}) - \frac{1}{2}(g_t^2 - \sigma_t^2)\nabla</em>)}}\log p_t(\boldsymbol{x})\right)p_t(\boldsymbol{x})\right] + \frac{1}{2}\sigma_t^2 \nabla_{\boldsymbol{x}}\cdot\nabla_{\boldsymbol{x}}p_t(\boldsymbol{x<br />
\end{aligned}\label{eq:fp-2}\end{equation}<br />
形式上该F-P方程又相当于原来的F-P的$\boldsymbol{f}<em _boldsymbol_x="\boldsymbol{x">t(\boldsymbol{x})$换成了$\boldsymbol{f}_t(\boldsymbol{x}) - \frac{1}{2}(g_t^2 - \sigma_t^2)\nabla</em>$，上式则对应于}}\log p_t(\boldsymbol{x})$、$g_t$换成了$\sigma_t$，根据式$\eqref{eq:fp}$对应于式$\eqref{eq:sde-forward<br />
\begin{equation}d\boldsymbol{x} = \left(\boldsymbol{f}<em _boldsymbol_x="\boldsymbol{x">t(\boldsymbol{x}) - \frac{1}{2}(g_t^2 - \sigma_t^2)\nabla</em>}}\log p_t(\boldsymbol{x})\right) dt + \sigma_t d\boldsymbol{w}\label{eq:sde-forward-2}\end{equation<br />
但是别忘了式$\eqref{eq:fp}$跟式$\eqref{eq:fp-2}$是完全等价的，所以这意味着式$\eqref{eq:sde-forward}$和式$\eqref{eq:sde-forward-2}$这两个随机微分方程所对应的边际分布$p_t(\boldsymbol{x})$是完全等价的！这个结果告诉我们存在不同方差的前向过程，它们产生的边际分布是一样的。这个结果相当于DDIM的升级版，后面我们还会证明，当$\boldsymbol{f}_t(\boldsymbol{x})$是关于$\boldsymbol{x}$的线性函数时，它就完全等价于DDIM。</p>
<p>特别地，根据上一篇SDE的结果，我们可以写出式$\eqref{eq:sde-forward-2}$对应的反向SDE：<br />
\begin{equation}d\boldsymbol{x} = \left(\boldsymbol{f}<em _boldsymbol_x="\boldsymbol{x">t(\boldsymbol{x}) - \frac{1}{2}(g_t^2 + \sigma_t^2)\nabla</em>}}\log p_t(\boldsymbol{x})\right) dt + \sigma_t d\boldsymbol{w}\label{eq:sde-reverse-2}\end{equation</p>
<h2 id="ode_1">神经ODE<a class="toc-link" href="#ode_1" title="Permanent link">&para;</a></h2>
<p>式$\eqref{eq:sde-forward-2}$允许我们改变采样过程的方差，这里我们特别考虑$\sigma_t = 0$的极端情形，此时SDE退化为ODE（常微分方程）：<br />
\begin{equation}d\boldsymbol{x} = \left(\boldsymbol{f}<em _boldsymbol_x="\boldsymbol{x">t(\boldsymbol{x}) - \frac{1}{2}g_t^2\nabla</em>}}\log p_t(\boldsymbol{x})\right) dt\label{eq:flow-ode}\end{equation<br />
这个ODE称为“概率流ODE（Probability flow ODE）”，由于实践中的$\nabla_{\boldsymbol{x}}\log p_t(\boldsymbol{x})$需要用神经网络$\boldsymbol{s}_{\boldsymbol{\theta}}(\boldsymbol{x}, t)$近似，所以上式也对应一个“神经ODE”。</p>
<p>为什么要特别研究方差为0的情形呢？因为此时传播过程不带噪声，从$\boldsymbol{x}_0$到$\boldsymbol{x}_T$是一个确定性变换，所以我们直接反向求解ODE就能得到由$\boldsymbol{x}_T$变换为$\boldsymbol{x}_0$的逆变换，这也是一个确定性变换（直接在式$\eqref{eq:sde-reverse-2}$中代入$\sigma_t=0$也可以发现前向和反向的方程是一样的）。这个过程和<a href="/tag/flow/">flow模型</a>是一致的（即通过一个可逆的变换将噪声变换成样本），所以概率流ODE允许我们将扩散模型的结果与flow模型相关结果对应起来，比如原论文提到概率流ODE允许我们做精确的似然计算、获得隐变量表征等，这些本质上都是flow模型的好处。由于flow模型的可逆性，它还允许我们在隐变量空间对原图做一些图片编辑等。</p>
<p>另一方面，从$\boldsymbol{x}_T$到$\boldsymbol{x}_0$的变换由一个ODE描述，这意味着我们可以通过各种高阶的ODE数值算法来加速从$\boldsymbol{x}_T$到$\boldsymbol{x}_0$的变换过程。当然，原则上SDE的求解也有一些加速方法，但SDE的加速研究远远不如ODE的容易和深入。总的来说，相比SDE，ODE在理论分析和实际求解中都显得更为简单直接。</p>
<h2 id="ddim">回顾DDIM<a class="toc-link" href="#ddim" title="Permanent link">&para;</a></h2>
<p>在<a href="/archives/9181">《生成扩散模型漫谈（四）：DDIM = 高观点DDPM》</a>的最后，我们推导了DDIM的连续版本对应于ODE<br />
\begin{equation}\frac{d}{ds}\left(\frac{\boldsymbol{x}(s)}{\bar{\alpha}(s)}\right) = \boldsymbol{\epsilon}<em _boldsymbol_theta="\boldsymbol{\theta">{\boldsymbol{\theta}}\left(\boldsymbol{x}(s), t(s)\right)\frac{d}{ds}\left(\frac{\bar{\beta}(s)}{\bar{\alpha}(s)}\right)\label{eq:ddim-ode}\end{equation}<br />
接下来我们可以看到，该结果其实就是本文的式$\eqref{eq:flow-ode}$在$\boldsymbol{f}_t(\boldsymbol{x})$取线性函数$f_t \boldsymbol{x}$时的特例：在<a href="/archives/9209">《生成扩散模型漫谈（五）：一般框架之SDE篇》</a>的末尾，我们推导过对应的关系<br />
\begin{equation}\left\{\begin{aligned}<br />
&amp;f_t = \frac{1}{\bar{\alpha}_t}\frac{d\bar{\alpha}_t}{dt} \\<br />
&amp;g^2 (t) = 2\bar{\alpha}_t \bar{\beta}_t \frac{d}{dt}\left(\frac{\bar{\beta}_t}{\bar{\alpha}_t}\right) \\<br />
&amp;\boldsymbol{s}</em>}}(\boldsymbol{x}, t) = -\frac{\boldsymbol{\epsilon<em _boldsymbol_x="\boldsymbol{x">{\boldsymbol{\theta}}(\boldsymbol{x}, t)}{\bar{\beta}_t}<br />
\end{aligned}\right.\end{equation}<br />
将这些关系代入到式$\eqref{eq:flow-ode}$【$\nabla</em>}}\log p_t(\boldsymbol{x})$替换为$\boldsymbol{s<em _boldsymbol_theta="\boldsymbol{\theta">{\boldsymbol{\theta}}(\boldsymbol{x}, t)$】后，整理得到<br />
\begin{equation}\frac{1}{\bar{\alpha}_t}\frac{d\boldsymbol{x}}{dt} - \frac{\boldsymbol{x}}{\bar{\alpha}_t^2}\frac{d\bar{\alpha}_t}{dt} = \boldsymbol{\epsilon}</em>}}(\boldsymbol{x}_t, t)\frac{d}{dt}\left(\frac{\bar{\beta}_t}{\bar{\alpha}_t}\right)\end{equation<br />
左端可以进一步整理得到$\frac{d}{dt}\left(\frac{\boldsymbol{x}}{\bar{\alpha}_t}\right)$，因此上式跟式$\eqref{eq:ddim-ode}$完全等价。</p>
<h2 id="_3">文章小结<a class="toc-link" href="#_3" title="Permanent link">&para;</a></h2>
<p>本文在SDE篇的基础上，借助F-P方程推导了更一般化的前向方程，继而推导出了“概率流ODE”，并证明了DDIM是它的一个特例。</p>
<p><em><strong>转载到请包括本文地址：</strong><a href="https://spaces.ac.cn/archives/9228">https://spaces.ac.cn/archives/9228</a></em></p>
<p><em><strong>更详细的转载事宜请参考：</strong></em><a href="https://spaces.ac.cn/archives/6508#%E6%96%87%E7%AB%A0%E5%A6%82%E4%BD%95%E8%BD%AC%E8%BD%BD/%E5%BC%95%E7%94%A8" title="《科学空间FAQ》">《科学空间FAQ》</a></p>
<p><strong>如果您还有什么疑惑或建议，欢迎在下方评论区继续讨论。</strong></p>
<p><strong>如果您觉得本文还不错，欢迎分享/打赏本文。打赏并非要从中获得收益，而是希望知道科学空间获得了多少读者的真心关注。当然，如果你无视它，也不会影响你的阅读。再次表示欢迎和感谢！</strong></p>
<p>打赏</p>
<p><img alt="科学空间" src="https://spaces.ac.cn/usr/themes/geekg/payment/wx.png" /></p>
<p>微信打赏</p>
<p><img alt="科学空间" src="https://spaces.ac.cn/usr/themes/geekg/payment/zfb.png" /></p>
<p>支付宝打赏</p>
<p>因为网站后台对打赏并无记录，因此欢迎在打赏时候备注留言。你还可以<a href="http://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&amp;email=tN7d1drY3drrx8H0xcWa19vZ"><strong>点击这里</strong></a>或在下方评论区留言来告知你的建议或需求。</p>
<p><strong>如果您需要引用本文，请参考：</strong></p>
<p>苏剑林. (Aug. 08, 2022). 《生成扩散模型漫谈（六）：一般框架之ODE篇 》[Blog post]. Retrieved from <a href="https://spaces.ac.cn/archives/9228">https://spaces.ac.cn/archives/9228</a></p>
<p>@online{kexuefm-9228,<br />
title={生成扩散模型漫谈（六）：一般框架之ODE篇},<br />
author={苏剑林},<br />
year={2022},<br />
month={Aug},<br />
url={\url{https://spaces.ac.cn/archives/9228}},<br />
} </p>
<hr />
<h2 id="_4">公式推导与注释<a class="toc-link" href="#_4" title="Permanent link">&para;</a></h2>
<p>本节将对概率流ODE进行极详细的数学推导，从多个角度（微分方程理论、动力系统、概率论）深入理解从SDE到ODE的转换过程、数值求解方法、以及与连续归一化流的关系。</p>
<h3 id="fokker-planckode">一、从Fokker-Planck方程到概率流ODE的完整推导<a class="toc-link" href="#fokker-planckode" title="Permanent link">&para;</a></h3>
<h4 id="11-f-p">1.1 F-P方程的深入理解<a class="toc-link" href="#11-f-p" title="Permanent link">&para;</a></h4>
<p>Fokker-Planck方程描述了概率密度函数$p_t(\boldsymbol{x})$随时间的演化，它是从微观的随机动力学（SDE）推导出宏观的概率分布演化方程。对于一般的SDE：<br />
$$d\boldsymbol{x} = \boldsymbol{f}_t(\boldsymbol{x}) dt + g_t d\boldsymbol{w}$$</p>
<p>对应的Fokker-Planck方程为：<br />
$$\frac{\partial p_t(\boldsymbol{x})}{\partial t} = -\nabla_{\boldsymbol{x}} \cdot [\boldsymbol{f}<em _boldsymbol_x="\boldsymbol{x">t(\boldsymbol{x}) p_t(\boldsymbol{x})] + \frac{1}{2}g_t^2 \nabla</em>)$$}} \cdot \nabla_{\boldsymbol{x}} p_t(\boldsymbol{x</p>
<p>这个方程由两部分组成：</p>
<p><strong>漂移项（Drift term）</strong>：$-\nabla_{\boldsymbol{x}} \cdot [\boldsymbol{f}_t(\boldsymbol{x}) p_t(\boldsymbol{x})]$，描述确定性流动导致的概率密度变化。从物理角度看，这是连续性方程的形式，表示"概率流"$\boldsymbol{J} = \boldsymbol{f}_t(\boldsymbol{x}) p_t(\boldsymbol{x})$的散度。</p>
<p><strong>扩散项（Diffusion term）</strong>：$\frac{1}{2}g_t^2 \nabla_{\boldsymbol{x}} \cdot \nabla_{\boldsymbol{x}} p_t(\boldsymbol{x})$，描述随机扰动导致的概率密度扩散。这是一个热方程类型的项，使概率密度趋于平滑。</p>
<h4 id="12-sde">1.2 等价SDE族的构造<a class="toc-link" href="#12-sde" title="Permanent link">&para;</a></h4>
<p>关键观察：对于给定的边际分布$p_t(\boldsymbol{x})$，存在无穷多个不同的SDE都能产生相同的边际分布演化。这是通过在F-P方程中引入一个"自由参数"$\sigma_t$来实现的。</p>
<p>对于满足$0 \leq \sigma_t^2 \leq g_t^2$的任意函数$\sigma_t$，考虑修改后的F-P方程：<br />
$$\frac{\partial p_t(\boldsymbol{x})}{\partial t} = -\nabla_{\boldsymbol{x}} \cdot \left[\tilde{\boldsymbol{f}}<em _boldsymbol_x="\boldsymbol{x">t(\boldsymbol{x}) p_t(\boldsymbol{x})\right] + \frac{1}{2}\sigma_t^2 \nabla</em>)$$}} \cdot \nabla_{\boldsymbol{x}} p_t(\boldsymbol{x</p>
<p>其中修改后的漂移项为：<br />
$$\tilde{\boldsymbol{f}}<em _boldsymbol_x="\boldsymbol{x">t(\boldsymbol{x}) = \boldsymbol{f}_t(\boldsymbol{x}) - \frac{1}{2}(g_t^2 - \sigma_t^2)\nabla</em>)$$}}\log p_t(\boldsymbol{x</p>
<p><strong>证明等价性</strong>：我们需要证明这个修改后的方程与原F-P方程完全等价。展开修改后的漂移项：</p>
<p>$$\begin{aligned}<br />
-\nabla_{\boldsymbol{x}} \cdot [\tilde{\boldsymbol{f}}<em _boldsymbol_x="\boldsymbol{x">t(\boldsymbol{x}) p_t(\boldsymbol{x})] &amp;= -\nabla</em>}} \cdot \left[\left(\boldsymbol{f<em _boldsymbol_x="\boldsymbol{x">t(\boldsymbol{x}) - \frac{1}{2}(g_t^2 - \sigma_t^2)\nabla</em>)\right] \}}\log p_t(\boldsymbol{x})\right) p_t(\boldsymbol{x<br />
&amp;= -\nabla_{\boldsymbol{x}} \cdot [\boldsymbol{f}<em _boldsymbol_x="\boldsymbol{x">t(\boldsymbol{x}) p_t(\boldsymbol{x})] + \frac{1}{2}(g_t^2 - \sigma_t^2)\nabla</em>)] \}} \cdot [p_t(\boldsymbol{x})\nabla_{\boldsymbol{x}}\log p_t(\boldsymbol{x<br />
&amp;= -\nabla_{\boldsymbol{x}} \cdot [\boldsymbol{f}<em _boldsymbol_x="\boldsymbol{x">t(\boldsymbol{x}) p_t(\boldsymbol{x})] + \frac{1}{2}(g_t^2 - \sigma_t^2)\nabla</em>)}} \cdot \nabla_{\boldsymbol{x}} p_t(\boldsymbol{x<br />
\end{aligned}$$</p>
<p>因此，完整的修改后F-P方程为：<br />
$$\begin{aligned}<br />
\frac{\partial p_t(\boldsymbol{x})}{\partial t} &amp;= -\nabla_{\boldsymbol{x}} \cdot [\boldsymbol{f}<em _boldsymbol_x="\boldsymbol{x">t(\boldsymbol{x}) p_t(\boldsymbol{x})] + \frac{1}{2}(g_t^2 - \sigma_t^2)\nabla</em>) \}} \cdot \nabla_{\boldsymbol{x}} p_t(\boldsymbol{x}) + \frac{1}{2}\sigma_t^2 \nabla_{\boldsymbol{x}} \cdot \nabla_{\boldsymbol{x}} p_t(\boldsymbol{x<br />
&amp;= -\nabla_{\boldsymbol{x}} \cdot [\boldsymbol{f}<em _boldsymbol_x="\boldsymbol{x">t(\boldsymbol{x}) p_t(\boldsymbol{x})] + \frac{1}{2}g_t^2 \nabla</em>)}} \cdot \nabla_{\boldsymbol{x}} p_t(\boldsymbol{x<br />
\end{aligned}$$</p>
<p>这正是原始的F-P方程！这个推导表明，尽管SDE的形式不同，但它们产生的边际分布演化是完全相同的。</p>
<h4 id="13-ode">1.3 概率流ODE的导出<a class="toc-link" href="#13-ode" title="Permanent link">&para;</a></h4>
<p>现在取极限情况$\sigma_t = 0$，此时SDE退化为ODE：<br />
$$\frac{d\boldsymbol{x}}{dt} = \boldsymbol{f}<em _boldsymbol_x="\boldsymbol{x">t(\boldsymbol{x}) - \frac{1}{2}g_t^2\nabla</em>)$$}}\log p_t(\boldsymbol{x</p>
<p>这就是<strong>概率流ODE（Probability Flow ODE）</strong>。它具有以下重要性质：</p>
<ol>
<li><strong>确定性传播</strong>：给定初始点$\boldsymbol{x}_0$，ODE的解是唯一确定的，不含随机性。</li>
<li><strong>保持边际分布</strong>：尽管是确定性的，概率流ODE产生的边际分布$p_t(\boldsymbol{x})$与原始SDE完全相同。</li>
<li><strong>可逆性</strong>：ODE是时间可逆的，我们可以精确地从$\boldsymbol{x}_T$反推$\boldsymbol{x}_0$。</li>
</ol>
<p><strong>物理直觉</strong>：从动力系统的角度，概率流ODE定义了一个时变的向量场$\boldsymbol{v}<em _boldsymbol_x="\boldsymbol{x">t(\boldsymbol{x}) = \boldsymbol{f}_t(\boldsymbol{x}) - \frac{1}{2}g_t^2\nabla</em>)$。这个向量场在每个时刻$t$推动概率密度沿着特定的轨迹演化，使得整体的概率分布按照F-P方程演化，但个体粒子的运动是完全确定的。}}\log p_t(\boldsymbol{x</p>
<h3 id="ode_2">二、ODE求解的数值方法<a class="toc-link" href="#ode_2" title="Permanent link">&para;</a></h3>
<p>概率流ODE的形式为：<br />
$$\frac{d\boldsymbol{x}}{dt} = \boldsymbol{v}<em _boldsymbol_theta="\boldsymbol{\theta">t(\boldsymbol{x}), \quad \boldsymbol{v}_t(\boldsymbol{x}) = \boldsymbol{f}_t(\boldsymbol{x}) - \frac{1}{2}g_t^2\boldsymbol{s}</em>, t)$$}}(\boldsymbol{x</p>
<p>其中$\boldsymbol{s}<em _boldsymbol_x="\boldsymbol{x">{\boldsymbol{\theta}}(\boldsymbol{x}, t)$是神经网络对$\nabla</em>)$的近似。}}\log p_t(\boldsymbol{x</p>
<h4 id="21-euler-method">2.1 欧拉法（Euler Method）<a class="toc-link" href="#21-euler-method" title="Permanent link">&para;</a></h4>
<p>最简单的数值求解方法是前向欧拉法：<br />
$$\boldsymbol{x}_{t+\Delta t} = \boldsymbol{x}_t + \Delta t \cdot \boldsymbol{v}_t(\boldsymbol{x}_t)$$</p>
<p><strong>局部截断误差分析</strong>：泰勒展开真实解：<br />
$$\boldsymbol{x}(t+\Delta t) = \boldsymbol{x}(t) + \Delta t \boldsymbol{x}'(t) + \frac{(\Delta t)^2}{2}\boldsymbol{x}''(t) + O((\Delta t)^3)$$</p>
<p>而欧拉法给出：<br />
$$\boldsymbol{x}_{t+\Delta t} = \boldsymbol{x}_t + \Delta t \boldsymbol{v}_t(\boldsymbol{x}_t)$$</p>
<p>局部截断误差（单步误差）为：<br />
$$\boldsymbol{e}_{local} = \frac{(\Delta t)^2}{2}\boldsymbol{x}''(t) + O((\Delta t)^3) = O((\Delta t)^2)$$</p>
<p><strong>全局误差分析</strong>：假设从$t=0$到$t=T$需要$N = T/\Delta t$步，全局误差累积为：<br />
$$\boldsymbol{e}_{global} = N \cdot O((\Delta t)^2) = \frac{T}{\Delta t} \cdot O((\Delta t)^2) = O(\Delta t)$$</p>
<p>因此欧拉法是<strong>一阶方法</strong>。</p>
<h4 id="22-rk4">2.2 四阶龙格-库塔法（RK4）<a class="toc-link" href="#22-rk4" title="Permanent link">&para;</a></h4>
<p>RK4是最常用的高阶ODE求解器，其更新公式为：<br />
$$\begin{aligned}<br />
\boldsymbol{k}<em t_2="t/2" t_Delta="t+\Delta">1 &amp;= \boldsymbol{v}_t(\boldsymbol{x}_t) \<br />
\boldsymbol{k}_2 &amp;= \boldsymbol{v}</em>}(\boldsymbol{x<em t_2="t/2" t_Delta="t+\Delta">t + \frac{\Delta t}{2}\boldsymbol{k}_1) \<br />
\boldsymbol{k}_3 &amp;= \boldsymbol{v}</em>}(\boldsymbol{x<em t="t" t_Delta="t+\Delta">t + \frac{\Delta t}{2}\boldsymbol{k}_2) \<br />
\boldsymbol{k}_4 &amp;= \boldsymbol{v}</em>}(\boldsymbol{x<em t="t" t_Delta="t+\Delta">t + \Delta t\boldsymbol{k}_3) \<br />
\boldsymbol{x}</em>_4)} &amp;= \boldsymbol{x}_t + \frac{\Delta t}{6}(\boldsymbol{k}_1 + 2\boldsymbol{k}_2 + 2\boldsymbol{k}_3 + \boldsymbol{k<br />
\end{aligned}$$</p>
<p><strong>精度分析</strong>：RK4通过在时间步内多次采样向量场，利用加权平均来逼近真实的积分曲线。其局部截断误差为$O((\Delta t)^5)$，全局误差为$O((\Delta t)^4)$，因此是<strong>四阶方法</strong>。</p>
<p><strong>扩散模型中的应用</strong>：对于概率流ODE，RK4意味着：<br />
- 每步需要评估神经网络4次<br />
- 相比欧拉法，RK4可以用更大的步长达到相同精度<br />
- 在实践中，RK4通常能减少50%以上的神经网络评估次数</p>
<h4 id="23-multistep-methods">2.3 多步法（Multistep Methods）<a class="toc-link" href="#23-multistep-methods" title="Permanent link">&para;</a></h4>
<p>多步法利用之前多个时间点的信息来提高精度。一个典型的例子是<strong>Adams-Bashforth法</strong>。</p>
<p><strong>二阶Adams-Bashforth</strong>（AB2）：<br />
$$\boldsymbol{x}<em t="t" t-_Delta="t-\Delta">{t+\Delta t} = \boldsymbol{x}_t + \Delta t\left(\frac{3}{2}\boldsymbol{v}_t(\boldsymbol{x}_t) - \frac{1}{2}\boldsymbol{v}</em>)\right)$$}(\boldsymbol{x}_{t-\Delta t</p>
<p>这个方法使用当前和前一步的导数信息，通过外推来估计下一步的位置。</p>
<p><strong>高阶Adams-Bashforth</strong>（AB4）：<br />
$$\boldsymbol{x}<em t="t" t-_Delta="t-\Delta">{t+\Delta t} = \boldsymbol{x}_t + \Delta t\left(\frac{55}{24}\boldsymbol{v}_t - \frac{59}{24}\boldsymbol{v}</em>} + \frac{37}{24}\boldsymbol{v<em t="t" t-3_Delta="t-3\Delta">{t-2\Delta t} - \frac{9}{24}\boldsymbol{v}</em>\right)$$</p>
<p>多步法的优势：<br />
- 每步只需一次函数评估（相比RK4的4次）<br />
- 可以达到高阶精度<br />
- 需要额外存储历史信息</p>
<h3 id="_5">三、确定性采样的理论保证<a class="toc-link" href="#_5" title="Permanent link">&para;</a></h3>
<h4 id="31-ode">3.1 ODE解的存在唯一性<a class="toc-link" href="#31-ode" title="Permanent link">&para;</a></h4>
<p>对于概率流ODE：<br />
$$\frac{d\boldsymbol{x}}{dt} = \boldsymbol{v}_t(\boldsymbol{x}), \quad \boldsymbol{x}(T) = \boldsymbol{x}_T$$</p>
<p><strong>Picard-Lindelöf定理</strong>：如果向量场$\boldsymbol{v}_t(\boldsymbol{x})$满足：<br />
1. <strong>连续性</strong>：$\boldsymbol{v}_t(\boldsymbol{x})$关于$(t,\boldsymbol{x})$连续<br />
2. <strong>Lipschitz条件</strong>：存在常数$L$使得$|\boldsymbol{v}_t(\boldsymbol{x}) - \boldsymbol{v}_t(\boldsymbol{y})| \leq L|\boldsymbol{x} - \boldsymbol{y}|$</p>
<p>则ODE的解在$[0,T]$上<strong>存在且唯一</strong>。</p>
<p><strong>在扩散模型中的应用</strong>：由于$\boldsymbol{v}<em _boldsymbol_theta="\boldsymbol{\theta">t(\boldsymbol{x}) = \boldsymbol{f}_t(\boldsymbol{x}) - \frac{1}{2}g_t^2\boldsymbol{s}</em>, t)$，其中：}}(\boldsymbol{x<br />
- $\boldsymbol{f}<em _boldsymbol_theta="\boldsymbol{\theta">t(\boldsymbol{x})$通常是线性或温和非线性的<br />
- $\boldsymbol{s}</em>, t)$是训练好的神经网络，在有界区域内是Lipschitz连续的}}(\boldsymbol{x</p>
<p>因此在实践中，ODE解的存在唯一性得到保证。</p>
<h4 id="32">3.2 逆向过程的唯一性<a class="toc-link" href="#32" title="Permanent link">&para;</a></h4>
<p>概率流ODE的一个关键性质是<strong>时间可逆性</strong>。给定终点$\boldsymbol{x}_T$，反向求解ODE：<br />
$$\frac{d\boldsymbol{x}}{dt} = -\boldsymbol{v}_t(\boldsymbol{x}), \quad t: T \to 0$$</p>
<p>由ODE的唯一性定理，这个逆向过程给出唯一的轨迹$\boldsymbol{x}_t$，使得$\boldsymbol{x}_0$是从$\boldsymbol{x}_T$"解码"出的唯一样本。</p>
<p><strong>与SDE的对比</strong>：对于原始的SDE：<br />
$$d\boldsymbol{x} = \boldsymbol{f}_t(\boldsymbol{x}) dt + g_t d\boldsymbol{w}$$</p>
<p>即使给定相同的$\boldsymbol{x}_T$，由于布朗运动$d\boldsymbol{w}$的随机性，每次采样都会得到不同的$\boldsymbol{x}_0$。而概率流ODE消除了这种随机性，实现了确定性的编码-解码过程。</p>
<h4 id="33">3.3 采样质量的理论分析<a class="toc-link" href="#33" title="Permanent link">&para;</a></h4>
<p><strong>定理（采样一致性）</strong>：如果神经网络$\boldsymbol{s}<em _boldsymbol_x="\boldsymbol{x">{\boldsymbol{\theta}}(\boldsymbol{x}, t)$完美估计了score function $\nabla</em>}}\log p_t(\boldsymbol{x})$，则通过概率流ODE采样得到的分布$\hat{p<em data="data">0(\boldsymbol{x})$与数据分布$p</em>)$完全一致。}(\boldsymbol{x</p>
<p><strong>证明思路</strong>：<br />
1. 完美的score估计 $\Rightarrow$ 准确的向量场$\boldsymbol{v}<em data="data">t(\boldsymbol{x})$<br />
2. 准确的向量场 $\Rightarrow$ 概率流ODE产生正确的边际分布$p_t(\boldsymbol{x})$<br />
3. 正确的边际分布演化 $\Rightarrow$ $p_0(\boldsymbol{x}) = p</em>)$}(\boldsymbol{x</p>
<p><strong>实践中的近似误差</strong>：实际应用中存在两类误差：<br />
1. <strong>Score估计误差</strong>：$|\boldsymbol{s}<em _boldsymbol_x="\boldsymbol{x">{\boldsymbol{\theta}}(\boldsymbol{x}, t) - \nabla</em>)|$}}\log p_t(\boldsymbol{x<br />
2. <strong>数值积分误差</strong>：ODE求解器的离散化误差</p>
<p>总误差可以通过以下方式控制：<br />
- 使用更强大的神经网络架构减少score估计误差<br />
- 使用高阶ODE求解器（如RK4）减少数值误差<br />
- 使用自适应步长控制保证精度</p>
<h3 id="odeddim">四、概率流ODE与DDIM的深入联系<a class="toc-link" href="#odeddim" title="Permanent link">&para;</a></h3>
<h4 id="41-ddimode">4.1 DDIM的ODE形式回顾<a class="toc-link" href="#41-ddimode" title="Permanent link">&para;</a></h4>
<p>在DDIM中，我们有：<br />
$$\boldsymbol{x}<em t-1="t-1">{t-1} = \sqrt{\bar{\alpha}</em>}}\underbrace{\left(\frac{\boldsymbol{x<em _boldsymbol_theta="\boldsymbol{\theta">t - \sqrt{1-\bar{\alpha}_t}\boldsymbol{\epsilon}</em>}}(\boldsymbol{x<em _text_预测的="\text{预测的">t, t)}{\sqrt{\bar{\alpha}_t}}\right)}</em>}\boldsymbol{x<em t-1="t-1">0} + \sqrt{1-\bar{\alpha}</em>_t, t)$$}}\boldsymbol{\epsilon}_{\boldsymbol{\theta}}(\boldsymbol{x</p>
<p>其连续极限对应的ODE为：<br />
$$\frac{d}{dt}\left(\frac{\boldsymbol{x}(t)}{\bar{\alpha}(t)}\right) = \boldsymbol{\epsilon}_{\boldsymbol{\theta}}(\boldsymbol{x}(t), t)\frac{d}{dt}\left(\frac{\bar{\beta}(t)}{\bar{\alpha}(t)}\right)$$</p>
<p>其中$\bar{\beta}(t) = \sqrt{1-\bar{\alpha}^2(t)}$。</p>
<h4 id="42-odeddim">4.2 从概率流ODE推导DDIM<a class="toc-link" href="#42-odeddim" title="Permanent link">&para;</a></h4>
<p>考虑线性SDE：$d\boldsymbol{x} = f_t \boldsymbol{x} dt + g_t d\boldsymbol{w}$，对应的概率流ODE为：<br />
$$\frac{d\boldsymbol{x}}{dt} = f_t \boldsymbol{x} - \frac{1}{2}g_t^2\nabla_{\boldsymbol{x}}\log p_t(\boldsymbol{x})$$</p>
<p>在DDPM/DDIM的参数化中，我们有：<br />
$$\begin{aligned}<br />
f_t &amp;= \frac{1}{\bar{\alpha}<em _boldsymbol_x="\boldsymbol{x">t}\frac{d\bar{\alpha}_t}{dt} = -\frac{1}{2}\frac{1}{\bar{\alpha}_t}\frac{d\bar{\alpha}_t^2}{dt} \<br />
g_t^2 &amp;= 2\bar{\alpha}_t \bar{\beta}_t \frac{d}{dt}\left(\frac{\bar{\beta}_t}{\bar{\alpha}_t}\right) \<br />
\nabla</em>}}\log p_t(\boldsymbol{x}) &amp;= -\frac{\boldsymbol{\epsilon}_{\boldsymbol{\theta}}(\boldsymbol{x}, t)}{\bar{\beta}_t<br />
\end{aligned}$$</p>
<p>代入概率流ODE：<br />
$$\begin{aligned}<br />
\frac{d\boldsymbol{x}}{dt} &amp;= f_t \boldsymbol{x} + \frac{1}{2}g_t^2\frac{\boldsymbol{\epsilon}<em _boldsymbol_theta="\boldsymbol{\theta">{\boldsymbol{\theta}}(\boldsymbol{x}, t)}{\bar{\beta}_t} \<br />
&amp;= \frac{1}{\bar{\alpha}_t}\frac{d\bar{\alpha}_t}{dt}\boldsymbol{x} + \bar{\alpha}_t \bar{\beta}_t \frac{d}{dt}\left(\frac{\bar{\beta}_t}{\bar{\alpha}_t}\right)\frac{\boldsymbol{\epsilon}</em>}}(\boldsymbol{x}, t)}{\bar{\beta<em _boldsymbol_theta="\boldsymbol{\theta">t} \<br />
&amp;= \frac{1}{\bar{\alpha}_t}\frac{d\bar{\alpha}_t}{dt}\boldsymbol{x} + \bar{\alpha}_t \frac{d}{dt}\left(\frac{\bar{\beta}_t}{\bar{\alpha}_t}\right)\boldsymbol{\epsilon}</em>, t)}}(\boldsymbol{x<br />
\end{aligned}$$</p>
<p>左边可以写成：<br />
$$\frac{d\boldsymbol{x}}{dt} = \frac{d\bar{\alpha}_t}{dt}\frac{\boldsymbol{x}}{\bar{\alpha}_t} + \bar{\alpha}_t \frac{d}{dt}\left(\frac{\boldsymbol{x}}{\bar{\alpha}_t}\right)$$</p>
<p>因此：<br />
$$\bar{\alpha}<em _boldsymbol_theta="\boldsymbol{\theta">t \frac{d}{dt}\left(\frac{\boldsymbol{x}}{\bar{\alpha}_t}\right) + \frac{d\bar{\alpha}_t}{dt}\frac{\boldsymbol{x}}{\bar{\alpha}_t} = \frac{1}{\bar{\alpha}_t}\frac{d\bar{\alpha}_t}{dt}\boldsymbol{x} + \bar{\alpha}_t \frac{d}{dt}\left(\frac{\bar{\beta}_t}{\bar{\alpha}_t}\right)\boldsymbol{\epsilon}</em>, t)$$}}(\boldsymbol{x</p>
<p>简化得：<br />
$$\frac{d}{dt}\left(\frac{\boldsymbol{x}}{\bar{\alpha}<em _boldsymbol_theta="\boldsymbol{\theta">t}\right) = \frac{d}{dt}\left(\frac{\bar{\beta}_t}{\bar{\alpha}_t}\right)\boldsymbol{\epsilon}</em>, t)$$}}(\boldsymbol{x</p>
<p>这正是DDIM的ODE形式！这个推导表明<strong>DDIM是概率流ODE在线性SDE情况下的特例</strong>。</p>
<h3 id="continuous-normalizing-flows">五、连续归一化流（Continuous Normalizing Flows）<a class="toc-link" href="#continuous-normalizing-flows" title="Permanent link">&para;</a></h3>
<h4 id="51">5.1 变量变换公式<a class="toc-link" href="#51" title="Permanent link">&para;</a></h4>
<p>概率流ODE定义了一个时变的可逆映射$\boldsymbol{x}_t = \Phi_t(\boldsymbol{x}_0)$。根据变量变换公式，概率密度的变化由雅可比行列式决定：<br />
$$p_t(\boldsymbol{x}_t) = p_0(\boldsymbol{x}_0) \left|\det\frac{\partial \boldsymbol{x}_0}{\partial \boldsymbol{x}_t}\right|$$</p>
<p>或者等价地：<br />
$$\log p_t(\boldsymbol{x}_t) = \log p_0(\boldsymbol{x}_0) + \log\left|\det\frac{\partial \boldsymbol{x}_0}{\partial \boldsymbol{x}_t}\right|$$</p>
<h4 id="52">5.2 瞬时变化率公式<a class="toc-link" href="#52" title="Permanent link">&para;</a></h4>
<p><strong>关键问题</strong>：如何计算雅可比行列式的对数$\log\left|\det\frac{\partial \boldsymbol{x}_0}{\partial \boldsymbol{x}_t}\right|$？</p>
<p>直接计算雅可比矩阵的行列式需要$O(d^3)$的计算复杂度，其中$d$是维度。对于高维数据（如图像），这是不可行的。</p>
<p><strong>连续归一化流的解决方案</strong>：利用瞬时变化率公式（instantaneous change of variables）。</p>
<p>对ODE $\frac{d\boldsymbol{x}}{dt} = \boldsymbol{v}<em _boldsymbol_x="\boldsymbol{x">t(\boldsymbol{x})$，概率密度的对数随时间的变化率为：<br />
$$\frac{d}{dt}\log p_t(\boldsymbol{x}_t) = -\text{tr}\left(\frac{\partial \boldsymbol{v}_t}{\partial \boldsymbol{x}}\right)</em>$$}=\boldsymbol{x}_t</p>
<p>这里$\text{tr}\left(\frac{\partial \boldsymbol{v}_t}{\partial \boldsymbol{x}}\right)$是向量场的散度$\nabla \cdot \boldsymbol{v}_t$。</p>
<p><strong>推导</strong>：从$\log p_t(\boldsymbol{x}_t) = \log p_0(\boldsymbol{x}_0) - \log\left|\det\frac{\partial \boldsymbol{x}_t}{\partial \boldsymbol{x}_0}\right|$对$t$求导：<br />
$$\frac{d}{dt}\log p_t(\boldsymbol{x}_t) = -\frac{d}{dt}\log\left|\det\frac{\partial \boldsymbol{x}_t}{\partial \boldsymbol{x}_0}\right|$$</p>
<p>利用Jacobi公式：<br />
$$\frac{d}{dt}\log\det \boldsymbol{J} = \text{tr}\left(\boldsymbol{J}^{-1}\frac{d\boldsymbol{J}}{dt}\right)$$</p>
<p>其中$\boldsymbol{J} = \frac{\partial \boldsymbol{x}_t}{\partial \boldsymbol{x}_0}$。进一步推导可得：<br />
$$\frac{d\boldsymbol{J}}{dt} = \frac{\partial \boldsymbol{v}_t}{\partial \boldsymbol{x}}\boldsymbol{J}$$</p>
<p>因此：<br />
$$\frac{d}{dt}\log\det \boldsymbol{J} = \text{tr}\left(\frac{\partial \boldsymbol{v}_t}{\partial \boldsymbol{x}}\right)$$</p>
<h4 id="53">5.3 似然计算<a class="toc-link" href="#53" title="Permanent link">&para;</a></h4>
<p>利用瞬时变化率公式，我们可以通过积分计算似然：<br />
$$\log p_0(\boldsymbol{x}<em _boldsymbol_x="\boldsymbol{x">0) = \log p_T(\boldsymbol{x}_T) + \int_0^T \text{tr}\left(\frac{\partial \boldsymbol{v}_t}{\partial \boldsymbol{x}}\right)</em> dt$$}=\boldsymbol{x}_t</p>
<p><strong>算法流程</strong>：<br />
1. 从数据$\boldsymbol{x}_0$开始<br />
2. 沿着概率流ODE积分到$\boldsymbol{x}_T$<br />
3. 同时积分散度项$\int_0^T \nabla \cdot \boldsymbol{v}_t dt$<br />
4. 计算$\log p_0(\boldsymbol{x}_0) = \log p_T(\boldsymbol{x}_T) + \text{divergence term}$</p>
<p><strong>与传统Flow模型的对比</strong>：<br />
- 传统Flow（如Glow, RealNVP）：需要精心设计可逆且雅可比行列式易于计算的架构<br />
- 连续归一化Flow：可以使用任意神经网络作为向量场，灵活性更高</p>
<h4 id="54-hutchinsons-trace-estimator">5.4 Hutchinson's Trace Estimator<a class="toc-link" href="#54-hutchinsons-trace-estimator" title="Permanent link">&para;</a></h4>
<p>计算散度$\nabla \cdot \boldsymbol{v}<em _boldsymbol_epsilon="\boldsymbol{\epsilon">t = \text{tr}\left(\frac{\partial \boldsymbol{v}_t}{\partial \boldsymbol{x}}\right)$仍需要计算雅可比矩阵的迹。对于高维情况，可以使用Hutchinson估计器：<br />
$$\text{tr}(\boldsymbol{A}) = \mathbb{E}</em>]$$}}[\boldsymbol{\epsilon}^T \boldsymbol{A} \boldsymbol{\epsilon</p>
<p>其中$\boldsymbol{\epsilon} \sim \mathcal{N}(\boldsymbol{0}, \boldsymbol{I})$或$\boldsymbol{\epsilon} \sim \text{Rademacher}(\pm 1)$。</p>
<p>应用到散度计算：<br />
$$\nabla \cdot \boldsymbol{v}<em _boldsymbol_epsilon="\boldsymbol{\epsilon">t = \mathbb{E}</em>}}\left[\boldsymbol{\epsilon}^T \frac{\partial \boldsymbol{v<em _boldsymbol_epsilon="\boldsymbol{\epsilon">t}{\partial \boldsymbol{x}}\boldsymbol{\epsilon}\right] = \mathbb{E}</em>)\right]$$}}\left[\boldsymbol{\epsilon}^T \nabla_{\boldsymbol{x}}(\boldsymbol{v}_t \cdot \boldsymbol{\epsilon</p>
<p>这只需要一次向量-雅可比积（VJP），可以通过自动微分高效计算，复杂度为$O(d)$而非$O(d^2)$。</p>
<h3 id="flow-matching">六、Flow Matching的数学基础<a class="toc-link" href="#flow-matching" title="Permanent link">&para;</a></h3>
<h4 id="61">6.1 条件流与边际流<a class="toc-link" href="#61" title="Permanent link">&para;</a></h4>
<p>Flow Matching是一种训练连续归一化流的新方法，它不依赖于score matching，而是直接学习向量场。</p>
<p><strong>条件概率路径</strong>：给定数据点$\boldsymbol{x}<em data="data">1 \sim p</em>)$）到数据的路径。一个简单的选择是线性插值：}$，定义一个从噪声$\boldsymbol{x}_0 \sim p_0$（如$\mathcal{N}(\boldsymbol{0}, \boldsymbol{I<br />
$$\boldsymbol{x}_t = (1-t)\boldsymbol{x}_0 + t\boldsymbol{x}_1, \quad t \in [0,1]$$</p>
<p>对应的条件向量场为：<br />
$$\boldsymbol{u}_t(\boldsymbol{x}|\boldsymbol{x}_1) = \frac{d\boldsymbol{x}_t}{dt} = \boldsymbol{x}_1 - \boldsymbol{x}_0$$</p>
<p><strong>边际向量场</strong>：我们希望学习的是边际向量场：<br />
$$\boldsymbol{v}<em _boldsymbol_x="\boldsymbol{x">t(\boldsymbol{x}) = \mathbb{E}</em>_1)]$$}_1|\boldsymbol{x}_t=\boldsymbol{x}}[\boldsymbol{u}_t(\boldsymbol{x}|\boldsymbol{x</p>
<h4 id="62-flow-matching">6.2 Flow Matching目标函数<a class="toc-link" href="#62-flow-matching" title="Permanent link">&para;</a></h4>
<p><strong>定理（Flow Matching Loss）</strong>：最小化以下损失等价于学习边际向量场：<br />
$$\mathcal{L}<em t_boldsymbol_x="t,\boldsymbol{x">{FM}(\boldsymbol{\theta}) = \mathbb{E}</em><em _boldsymbol_theta="\boldsymbol{\theta">1,\boldsymbol{x}_0}\left[\left|\boldsymbol{v}</em>_1)\right|^2\right]$$}}(\boldsymbol{x}_t, t) - \boldsymbol{u}_t(\boldsymbol{x}_t|\boldsymbol{x</p>
<p>其中期望关于：<br />
- $t \sim \text{Uniform}[0,1]$<br />
- $\boldsymbol{x}<em data="data">1 \sim p</em>$<br />
- $\boldsymbol{x}_0 \sim p_0$<br />
- $\boldsymbol{x}_t = (1-t)\boldsymbol{x}_0 + t\boldsymbol{x}_1$</p>
<p><strong>关键优势</strong>：<br />
1. <strong>简单性</strong>：条件向量场$\boldsymbol{u}<em _boldsymbol_x="\boldsymbol{x">t(\boldsymbol{x}_t|\boldsymbol{x}_1)$是已知的（如线性插值）<br />
2. <strong>无需score function</strong>：不需要估计$\nabla</em>)$}}\log p_t(\boldsymbol{x<br />
3. <strong>高效训练</strong>：损失函数形式简单，易于优化</p>
<h4 id="63">6.3 与扩散模型的联系<a class="toc-link" href="#63" title="Permanent link">&para;</a></h4>
<p><strong>概率流ODE可以看作Flow Matching的一种特殊情况</strong>。在扩散模型中：<br />
$$\boldsymbol{x}_t = \bar{\alpha}_t \boldsymbol{x}_0 + \bar{\beta}_t \boldsymbol{\epsilon}, \quad \boldsymbol{\epsilon} \sim \mathcal{N}(\boldsymbol{0}, \boldsymbol{I})$$</p>
<p>对应的条件向量场可以通过Tweedie公式推导：<br />
$$\boldsymbol{u}_t(\boldsymbol{x}_t|\boldsymbol{x}_0) = \frac{d\bar{\alpha}_t}{dt}\frac{\boldsymbol{x}_0 - \boldsymbol{x}_t/\bar{\alpha}_t}{\bar{\beta}_t/\bar{\alpha}_t} + \text{diffusion term}$$</p>
<p>这与概率流ODE的形式一致，表明扩散模型本质上也是在学习一个归一化流。</p>
<h3 id="_6">七、理论性质的综合分析<a class="toc-link" href="#_6" title="Permanent link">&para;</a></h3>
<h4 id="71-ode">7.1 概率流ODE的唯一性与稳定性<a class="toc-link" href="#71-ode" title="Permanent link">&para;</a></h4>
<p><strong>定理（轨迹唯一性）</strong>：对于任意初始点$\boldsymbol{x}_T$，概率流ODE<br />
$$\frac{d\boldsymbol{x}}{dt} = \boldsymbol{v}_t(\boldsymbol{x})$$<br />
定义了唯一的轨迹$\boldsymbol{x}_t$，$t \in [0,T]$。</p>
<p><strong>推论</strong>：这意味着概率流ODE定义了一个双射$\Phi: \boldsymbol{x}_T \mapsto \boldsymbol{x}_0$，它的逆映射$\Phi^{-1}$对应于时间反转的ODE。</p>
<p><strong>稳定性分析</strong>：考虑两条初始点略有不同的轨迹$\boldsymbol{x}_t^{(1)}$和$\boldsymbol{x}_t^{(2)}$，它们的距离随时间的变化由以下微分方程控制：<br />
$$\frac{d}{dt}|\boldsymbol{x}_t^{(1)} - \boldsymbol{x}_t^{(2)}| \leq L|\boldsymbol{x}_t^{(1)} - \boldsymbol{x}_t^{(2)}|$$</p>
<p>其中$L$是向量场的Lipschitz常数。这给出指数界：<br />
$$|\boldsymbol{x}_t^{(1)} - \boldsymbol{x}_t^{(2)}| \leq e^{Lt}|\boldsymbol{x}_0^{(1)} - \boldsymbol{x}_0^{(2)}|$$</p>
<h4 id="72">7.2 与动力系统理论的联系<a class="toc-link" href="#72" title="Permanent link">&para;</a></h4>
<p>概率流ODE定义了一个<strong>非自治动力系统</strong>（时变的向量场）。从动力系统的角度：</p>
<p><strong>相流（Phase flow）</strong>：概率流ODE定义了相空间中的一族流形变换$\phi_t: \mathbb{R}^d \to \mathbb{R}^d$，满足：<br />
$$\phi_0 = \text{id}, \quad \frac{\partial \phi_t}{\partial t} = \boldsymbol{v}_t \circ \phi_t$$</p>
<p><strong>Liouville方程</strong>：概率密度的演化由Liouville方程描述：<br />
$$\frac{\partial p_t}{\partial t} + \nabla \cdot (p_t \boldsymbol{v}_t) = 0$$</p>
<p>这正是不含扩散项（$g_t=0$）的Fokker-Planck方程。</p>
<h4 id="73">7.3 数值精度与采样质量的权衡<a class="toc-link" href="#73" title="Permanent link">&para;</a></h4>
<p>在实践中，我们需要在三个因素之间权衡：<br />
1. <strong>神经网络评估次数</strong>（NFE）：决定采样速度<br />
2. <strong>ODE求解器阶数</strong>：决定单步精度<br />
3. <strong>最终样本质量</strong>：通常用FID等指标衡量</p>
<p><strong>实验观察</strong>：<br />
- 欧拉法：需要100-1000步达到好的样本质量<br />
- RK4：可以减少到10-50步<br />
- 高阶自适应方法：可能进一步减少到5-10步</p>
<p><strong>理论指导</strong>：设总积分区间为$T$，步数为$N$，ODE求解器阶数为$p$，则全局误差为：<br />
$$\text{Error} \approx C \cdot \left(\frac{T}{N}\right)^p$$</p>
<p>要达到误差$\epsilon$，所需步数为：<br />
$$N \approx C^{1/p} \cdot T \cdot \epsilon^{-1/p}$$</p>
<p>高阶方法（大的$p$）对$\epsilon$的依赖更弱，因此在追求高精度时更有优势。</p>
<h3 id="_7">八、与其他生成模型的统一视角<a class="toc-link" href="#_7" title="Permanent link">&para;</a></h3>
<p>概率流ODE为不同类型的生成模型提供了统一的理论框架：</p>
<h4 id="81-vaeflow">8.1 VAE、Flow、扩散模型的统一<a class="toc-link" href="#81-vaeflow" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th></th>
<th>VAE</th>
<th>Normalizing Flow</th>
<th>扩散模型（ODE）</th>
</tr>
</thead>
<tbody>
<tr>
<td>隐变量到数据</td>
<td>随机解码器</td>
<td>确定性可逆变换</td>
<td>确定性ODE</td>
</tr>
<tr>
<td>似然计算</td>
<td>近似（ELBO）</td>
<td>精确（变量变换）</td>
<td>精确（CNF公式）</td>
</tr>
<tr>
<td>灵活性</td>
<td>高（任意解码器）</td>
<td>低（需可逆架构）</td>
<td>高（任意向量场）</td>
</tr>
</tbody>
</table>
<h4 id="82">8.2 连续时间视角的价值<a class="toc-link" href="#82" title="Permanent link">&para;</a></h4>
<p>将生成模型视为连续时间过程的好处：<br />
1. <strong>理论分析更清晰</strong>：可以利用微分方程、动力系统、随机过程的丰富理论<br />
2. <strong>数值方法更成熟</strong>：ODE/SDE求解器经过数十年发展，高度优化<br />
3. <strong>推广更自然</strong>：容易推广到条件生成、插值、编辑等任务</p>
<hr />
<p>通过以上详细的数学推导，我们从多个角度深入理解了概率流ODE：<br />
- <strong>从微分方程角度</strong>：它是SDE在零扩散极限下的退化形式<br />
- <strong>从动力系统角度</strong>：它定义了相空间中的确定性流<br />
- <strong>从概率论角度</strong>：它保持了边际概率分布的演化<br />
- <strong>从数值分析角度</strong>：它可以通过各种高效的ODE求解器实现<br />
- <strong>从生成模型角度</strong>：它统一了Flow模型和扩散模型的视角</p>
<p>概率流ODE的理论不仅加深了我们对扩散模型的理解，也为设计新的生成模型算法提供了坚实的数学基础。</p>
                </div>

                <!-- Previous/Next Navigation -->
                <nav class="post-navigation" aria-label="文章导航">
                    <div class="row g-3">
                        <div class="col-6">
                            
                            <a href="生成扩散模型漫谈五一般框架之sde篇.html" class="nav-link-prev">
                                <div class="nav-direction"><i class="fas fa-chevron-left"></i> 上一篇</div>
                                <div class="nav-title">#53 生成扩散模型漫谈（五）：一般框架之SDE篇</div>
                            </a>
                            
                        </div>
                        <div class="col-6">
                            
                            <a href="生成扩散模型漫谈七最优扩散方差估计上.html" class="nav-link-next">
                                <div class="nav-direction">下一篇 <i class="fas fa-chevron-right"></i></div>
                                <div class="nav-title">#55 生成扩散模型漫谈（七）：最优扩散方差估计（上）</div>
                            </a>
                            
                        </div>
                    </div>
                </nav>

                <!-- Back to Home -->
                <div class="text-center mt-4 mb-4">
                    <a href="../index.html" class="btn btn-outline-primary">
                        <i class="fas fa-arrow-left"></i> 返回首页
                    </a>
                </div>
            </div>

            <!-- Sidebar (TOC) -->
            <div class="col-lg-3">
                <aside class="sidebar">
                    
                    <div class="toc-sidebar">
                        <h5 class="toc-title"><i class="fas fa-list"></i> 目录</h5>
                        <div class="toc-content">
                            <div class="toc">
<ul>
<li><a href="#ode">生成扩散模型漫谈（六）：一般框架之ODE篇</a><ul>
<li><a href="#_1">再次反思</a></li>
<li><a href="#dirac">Dirac函数</a></li>
<li><a href="#f-p">F-P方程</a></li>
<li><a href="#_2">等价变换</a></li>
<li><a href="#ode_1">神经ODE</a></li>
<li><a href="#ddim">回顾DDIM</a></li>
<li><a href="#_3">文章小结</a></li>
<li><a href="#_4">公式推导与注释</a><ul>
<li><a href="#fokker-planckode">一、从Fokker-Planck方程到概率流ODE的完整推导</a></li>
<li><a href="#ode_2">二、ODE求解的数值方法</a></li>
<li><a href="#_5">三、确定性采样的理论保证</a></li>
<li><a href="#odeddim">四、概率流ODE与DDIM的深入联系</a></li>
<li><a href="#continuous-normalizing-flows">五、连续归一化流（Continuous Normalizing Flows）</a></li>
<li><a href="#flow-matching">六、Flow Matching的数学基础</a></li>
<li><a href="#_6">七、理论性质的综合分析</a></li>
<li><a href="#_7">八、与其他生成模型的统一视角</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>

                        </div>
                        <div class="toc-actions">
                            <button class="btn btn-sm btn-outline-secondary" onclick="expandAll()">
                                <i class="fas fa-expand"></i> 全部展开
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="collapseAll()">
                                <i class="fas fa-compress"></i> 全部折叠
                            </button>
                        </div>
                    </div>
                    

                    <!-- Back to Top Button -->
                    <button id="backToTop" class="back-to-top" title="回到顶部">
                        <i class="fas fa-arrow-up"></i>
                    </button>
                </aside>
            </div>
        </div>
    </article>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p>
                博客来源: <a href="https://spaces.ac.cn" target="_blank">科学空间</a> |
                内容经过整理并添加详细数学推导
            </p>
            <p>
                Powered by <a href="https://pages.github.com/" target="_blank">GitHub Pages</a>
            </p>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Syntax highlighting -->
    <script>hljs.highlightAll();</script>

    <!-- Back to top functionality -->
    <script>
        // Show/hide back to top button based on scroll position
        window.addEventListener('scroll', function() {
            const backToTop = document.getElementById('backToTop');
            if (window.pageYOffset > 300) {
                backToTop.classList.add('show');
            } else {
                backToTop.classList.remove('show');
            }
        });

        // Smooth scroll to top
        document.getElementById('backToTop').addEventListener('click', function() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        });

        // Sticky TOC sidebar
        window.addEventListener('scroll', function() {
            const sidebar = document.querySelector('.sidebar');
            if (!sidebar) return;

            const sidebarTop = sidebar.offsetTop;
            const scrollTop = window.pageYOffset;

            if (scrollTop > sidebarTop - 20) {
                sidebar.classList.add('sticky');
            } else {
                sidebar.classList.remove('sticky');
            }
        });
    </script>
</body>
</html>