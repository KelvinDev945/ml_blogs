<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transformer升级之路：6、旋转位置编码的完备性分析 | ML & Math Blog Posts</title>
    <meta name="description" content="Transformer升级之路：6、旋转位置编码的完备性分析&para;
原文链接: https://spaces.ac.cn/archives/9403
发布日期: 

在去年的文章《Transformer升级之路：2、博采众长的旋转式位置编码》中，笔者提出了旋转位置编码（RoPE），当时的出发点只是觉得用绝对位置来实现相对位置是一件“很好玩的事情”，并没料到其实际效果还相当不错，并为大家所接受...">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css">

    <!-- Google Fonts -->
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="../assets/css/main.css">
    <link rel="stylesheet" href="../assets/css/post.css">

    <!-- Custom JS -->
    <script src="../assets/js/collapsible.js" defer></script>

    <!-- MathJax for math rendering with equation numbering -->
    <script>
    MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']],
        processEscapes: true,
        processEnvironments: true,
        tags: 'ams',  // Enable equation numbering with AMS style
        tagSide: 'right',  // Place equation numbers on the right
        tagIndent: '0.8em',  // Indentation for equation numbers
        multlineWidth: '85%'
      },
      options: {
        skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
      }
    };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <!-- Syntax highlighting -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.7.0/build/styles/github.min.css">
    <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.7.0/build/highlight.min.js"></script>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light border-bottom">
        <div class="container">
            <a class="navbar-brand" href="../index.html">
                <i class="fas fa-brain"></i> ML & Math Blog
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="../index.html"><i class="fas fa-home"></i> 首页</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Post Content -->
    <article class="container post-container my-5">
        <!-- Breadcrumb Navigation -->
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="../index.html"><i class="fas fa-home"></i> 首页</a></li>
                
                <li class="breadcrumb-item"><a href="../index.html?tags=详细推导">详细推导</a></li>
                
                <li class="breadcrumb-item active" aria-current="page">
                    #213 Transformer升级之路：6、旋转位置编码的完备性分析
                </li>
            </ol>
        </nav>

        <!-- Post Header -->
        <header class="post-header mb-4">
            <h1 class="post-title">
                <span class="post-number">#213</span>
                Transformer升级之路：6、旋转位置编码的完备性分析
            </h1>
            <div class="post-meta">
                <span><i class="far fa-calendar"></i> 2022-12-28</span>
                
            </div>
            
            <div class="post-tags mt-3">
                
                <a href="../index.html?tags=详细推导" class="tag-link">
                    <span class="tag"><i class="fas fa-tag"></i> 详细推导</span>
                </a>
                
                <a href="../index.html?tags=矩阵" class="tag-link">
                    <span class="tag"><i class="fas fa-tag"></i> 矩阵</span>
                </a>
                
                <a href="../index.html?tags=attention" class="tag-link">
                    <span class="tag"><i class="fas fa-tag"></i> attention</span>
                </a>
                
                <a href="../index.html?tags=位置编码" class="tag-link">
                    <span class="tag"><i class="fas fa-tag"></i> 位置编码</span>
                </a>
                
                <a href="../index.html?tags=rope" class="tag-link">
                    <span class="tag"><i class="fas fa-tag"></i> rope</span>
                </a>
                
                <a href="../index.html?tags=生成模型" class="tag-link">
                    <span class="tag"><i class="fas fa-tag"></i> 生成模型</span>
                </a>
                
            </div>
            
        </header>

        <div class="row">
            <!-- Main Content -->
            <div class="col-lg-9">
                <!-- Post Body -->
                <div class="post-content">
                    <h1 id="transformer6">Transformer升级之路：6、旋转位置编码的完备性分析<a class="toc-link" href="#transformer6" title="Permanent link">&para;</a></h1>
<p><strong>原文链接</strong>: <a href="https://spaces.ac.cn/archives/9403">https://spaces.ac.cn/archives/9403</a></p>
<p><strong>发布日期</strong>: </p>
<hr />
<p>在去年的文章<a href="/archives/8265">《Transformer升级之路：2、博采众长的旋转式位置编码》</a>中，笔者提出了旋转位置编码（RoPE），当时的出发点只是觉得用绝对位置来实现相对位置是一件“很好玩的事情”，并没料到其实际效果还相当不错，并为大家所接受，不得不说这真是一个意外之喜。后来，在<a href="/archives/8397">《Transformer升级之路：4、二维位置的旋转式位置编码》</a>中，笔者讨论了二维形式的RoPE，并研究了用矩阵指数表示的RoPE的一般解。</p>
<p>既然有了一般解，那么自然就会引出一个问题：我们常用的RoPE，只是一个以二维旋转矩阵为基本单元的分块对角矩阵，如果换成一般解，理论上效果会不会更好呢？本文就来回答这个问题。</p>
<h2 id="_1">指数通解<a class="toc-link" href="#_1" title="Permanent link">&para;</a></h2>
<p>在<a href="/archives/8397">《Transformer升级之路：4、二维位置的旋转式位置编码》</a>中，我们将RoPE抽象地定义为任意满足下式的方阵<br />
\begin{equation}\boldsymbol{\mathcal{R}}<em n-m="n-m">m^{\top}\boldsymbol{\mathcal{R}}_n=\boldsymbol{\mathcal{R}}</em>}\label{eq:re}\end{equation
然后，我们探讨了如下矩阵指数形式的解
\begin{equation}\boldsymbol{\mathcal{R}}_n=\exp n\boldsymbol{B}\end{equation}<br />
这里的矩阵指数，不是像Softmax那样的激活函数式的element-wise运算，而是按照泰勒级数定义的“<a href="https://en.wikipedia.org/wiki/Matrix_exponential">Matrix Exponential</a>”。根据“<a href="https://en.wikipedia.org/wiki/Baker%E2%80%93Campbell%E2%80%93Hausdorff_formula">Baker–Campbell–Hausdorff公式</a>”，我们有<br />
\begin{equation}\begin{aligned}
\boldsymbol{\mathcal{R}}_m^{\top}\boldsymbol{\mathcal{R}}_n=&amp;\,\big(\exp m\boldsymbol{B}\big)^{\top}\big(\exp n\boldsymbol{B}\big) = \big(\exp m\boldsymbol{B}^{\top}\big)\big(\exp n\boldsymbol{B}\big) \\
=&amp;\,\exp\left(m\boldsymbol{B}^{\top} + n\boldsymbol{B} + \frac{1}{2}mn\left[\boldsymbol{B}^{\top}, \boldsymbol{B}\right]+\cdots\right)
\end{aligned}\end{equation}<br />
这里$\left[\boldsymbol{A}, \boldsymbol{B}\right]=\boldsymbol{A}\boldsymbol{B}-\boldsymbol{B}\boldsymbol{A}$，$\cdots$省略的都是$m,n$的三次或三次以上的项。按照式$\eqref{eq:re}$，那么上式指数部分应该等于$(n-m)\boldsymbol{B}$，这就推出<br />
\begin{equation}\boldsymbol{B}^{\top} = - \boldsymbol{B}\end{equation}<br />
即要求$\boldsymbol{B}$是反对称矩阵。</p>
<h2 id="_2">正交通解<a class="toc-link" href="#_2" title="Permanent link">&para;</a></h2>
<p>进一步地，我们有$(\exp \boldsymbol{B})^{\top}(\exp \boldsymbol{B})=\exp(\boldsymbol{B}-\boldsymbol{B}) = \boldsymbol{I}$和$\exp n\boldsymbol{B} = \left(\exp\boldsymbol{B}\right)^n$，前者说明$\exp\boldsymbol{B}$是正交矩阵，后者则启示我们这是不是可以推广到任意正交矩阵？不难验证，答案是肯定的，我们有结论：</p>
<blockquote>
<p>对于任意正交矩阵$\boldsymbol{O}$，$\boldsymbol{\mathcal{R}}_n=\boldsymbol{O}^n$是满足式$\eqref{eq:re}$的解。</p>
</blockquote>
<p>值得指出的是，在实数域内，并非所有正交矩阵能写成$\exp\boldsymbol{B}$的形式，所以$\boldsymbol{O}^n$实际上比矩阵指数形式更宽泛。从<a href="/archives/6377">《恒等式 det(exp(A)) = exp(Tr(A)) 赏析》</a>可知$\det(\exp(\boldsymbol{A})) = \exp(\text{Tr}(\boldsymbol{A})) &gt; 0$，所以能写成矩阵指数形式的正交矩阵行列式必然大于0（即等于1），事实上这个结果反过来也成立，即行列式等于1的正交矩阵，必然可以写成$\exp\boldsymbol{B}$的形式，其中$\boldsymbol{B}$是反对称矩阵。（参考<a href="https://math.stackexchange.com/questions/2467531/why-can-any-orthogonal-matrix-be-written-as-o-ea">《Why can any orthogonal matrix be written as O=e^A》</a>）。</p>
<p>对于$\det(\boldsymbol{O}) = -1$的正交矩阵，我们有$\boldsymbol{O}=\boldsymbol{O}<em>+ \boldsymbol{I}</em>-$，其中$\boldsymbol{I}<em>-$是对角线有一个-1、剩下都是1的对角阵，$\boldsymbol{O}</em>+$是$\det(\boldsymbol{O}<em>+) = 1$的正交矩阵，它可以写成$\exp\boldsymbol{B}$的形式，此时$\boldsymbol{O}^n = (\boldsymbol{O}</em>+ \boldsymbol{I}<em>-)^n = \boldsymbol{I}</em>-^n\exp n\boldsymbol{B}$。这也就是说，即便对于$\det(\boldsymbol{O}) = -1$的$\boldsymbol{O}^n$，也只是$\exp n\boldsymbol{B}$的简单变换，所以接下来我们主要研究$\exp n\boldsymbol{B}$形式的解。</p>
<h2 id="_3">完备分析<a class="toc-link" href="#_3" title="Permanent link">&para;</a></h2>
<p>众所周知，我们平时所用的RoPE位置编码，是如下形式的分块对角矩阵：<br />
\begin{equation}\scriptsize{\left(\begin{array}{cc:cc:cc:cc}
\cos n\theta_0 &amp; -\sin n\theta_0 &amp; 0 &amp; 0 &amp; \cdots &amp; \cdots &amp; 0 &amp; 0 \\
\sin n\theta_0 &amp; \cos n\theta_0 &amp; 0 &amp; 0 &amp; \cdots &amp; \cdots &amp; 0 &amp; 0 \\
\hdashline
0 &amp; 0 &amp; \cos n\theta_1 &amp; -\sin n\theta_1 &amp; \cdots &amp; \cdots &amp; 0 &amp; 0 \\
0 &amp; 0 &amp; \sin n\theta_1 &amp; \cos n\theta_1 &amp; \cdots &amp; \cdots &amp; 0 &amp; 0 \\
\hdashline
\vdots &amp; \vdots &amp; \vdots &amp; \vdots &amp; \ddots &amp; \ddots &amp; \vdots &amp; \vdots \\
\vdots &amp; \vdots &amp; \vdots &amp; \vdots &amp; \ddots &amp; \ddots &amp; \vdots &amp; \vdots \\
\hdashline
0 &amp; 0 &amp; 0 &amp; 0 &amp; \cdots &amp; \cdots &amp; \cos n\theta_{d/2-1} &amp; -\sin n\theta_{d/2-1} \\
0 &amp; 0 &amp; 0 &amp; 0 &amp; \cdots &amp; \cdots &amp; \sin n\theta_{d/2-1} &amp; \cos n\theta_{d/2-1} \\
\end{array}\right)}\end{equation}<br />
它可以简写成<br />
\begin{equation}\begin{pmatrix}
\boldsymbol{R}<em n_theta_1="n\theta_1">{n\theta_0} &amp; \boldsymbol{0} &amp; \cdots &amp; \boldsymbol{0} \\
\boldsymbol{0} &amp; \boldsymbol{R}</em> \\} &amp; \cdots &amp; \boldsymbol{0
\vdots &amp; \vdots &amp; \ddots &amp; \vdots \\
\boldsymbol{0} &amp; \boldsymbol{0} &amp; \cdots &amp; \boldsymbol{R}<em d_2-1="d/2-1">{n\theta</em> \\}
\end{pmatrix} = \exp n\begin{pmatrix}
\boldsymbol{J}<em _theta_1="\theta_1">{\theta_0} &amp; \boldsymbol{0} &amp; \cdots &amp; \boldsymbol{0} \\
\boldsymbol{0} &amp; \boldsymbol{J}</em> \\} &amp; \cdots &amp; \boldsymbol{0
\vdots &amp; \vdots &amp; \ddots &amp; \vdots \\
\boldsymbol{0} &amp; \boldsymbol{0} &amp; \cdots &amp; \boldsymbol{J}<em d_2-1="d/2-1">{\theta</em> \\}
\end{pmatrix}\end{equation}<br />
其中<br />
\begin{equation}\boldsymbol{R}<em _theta="\theta">{\theta} = \begin{pmatrix} \cos\theta &amp; -\sin\theta \\ \sin\theta &amp; \cos\theta \end{pmatrix},\quad \boldsymbol{J}</em>} = \begin{pmatrix} 0 &amp; -\theta \\ \theta &amp; 0\end{pmatrix}\end{equation<br />
这种选择可以说是最简单的一种，其本质原因可以说是为了降低计算量。那么，所谓完备性问题，就是要回答：如上的分块对角矩阵的特例，相比全参数$\exp n\boldsymbol{B}$，是否有能力上的缺失？换句话说，如果不考虑计算量，将$\boldsymbol{B}$替换为一般的反对称矩阵，效果是否可能会有提升？</p>
<p>回答这个问题不困难，事实上，对于任意偶数阶反对称矩阵，它都可以对角化为分块对角矩阵<br />
\begin{equation}\boldsymbol{\Lambda} = \begin{pmatrix}
\boldsymbol{J}<em _theta_1="\theta_1">{\theta_0} &amp; \boldsymbol{0} &amp; \cdots &amp; \boldsymbol{0} \\
\boldsymbol{0} &amp; \boldsymbol{J}</em> \\} &amp; \cdots &amp; \boldsymbol{0
\vdots &amp; \vdots &amp; \ddots &amp; \vdots \\
\boldsymbol{0} &amp; \boldsymbol{0} &amp; \cdots &amp; \boldsymbol{J}<em d_2-1="d/2-1">{\theta</em> \\}
\end{pmatrix}\end{equation}<br />
该结论可以参考<a href="https://en.wikipedia.org/wiki/Skew-symmetric_matrix#Spectral_theory">Skew-symmetric matrix</a>。也就是说，存在可逆矩阵$\boldsymbol{P}$，使得$\boldsymbol{B}=\boldsymbol{P}\boldsymbol{\Lambda}\boldsymbol{P}^{-1}$，于是<br />
\begin{equation}\exp n\boldsymbol{B} = \exp \left(n\boldsymbol{P}\boldsymbol{\Lambda}\boldsymbol{P}^{-1}\right) = \boldsymbol{P}(\exp n\boldsymbol{\Lambda})\boldsymbol{P}^{-1}\end{equation}<br />
也就是说，任意的$\exp n\boldsymbol{B}$与分块对角的$\exp n\boldsymbol{\Lambda}$，仅仅相差一个相似变换，而我们在Self Attention中应用RoPE时，是<br />
\begin{equation}\boldsymbol{q}^{\top}\big(\exp (n-m)\boldsymbol{B}\big)\boldsymbol{k} = \big(\boldsymbol{P}^{\top}\boldsymbol{q}\big)^{\top}\big(\exp (n-m)\boldsymbol{\Lambda}\big)\big(\boldsymbol{P}^{-1}\boldsymbol{k}\big)\end{equation}<br />
由于$\boldsymbol{q},\boldsymbol{k}$一般都是输入$\boldsymbol{x}$经过某个可学习的线性变换而来，$\boldsymbol{P}^{\top},\boldsymbol{P}^{-1}$原则上都可以吸收到线性变换的训练参数中，因此直接设为$\boldsymbol{q}^{\top}\big(\exp (n-m)\boldsymbol{\Lambda}\big)\boldsymbol{k}$理论上不会损失一般性。</p>
<p>所以，对于Self Attention来说，问题的答案是否定的。不过，如果是<a href="线性Attention的探索：Attention必须有个Softmax吗？">线性Attention</a>，答案会有少许区别，因为线性Attention的$\boldsymbol{q},\boldsymbol{k}$加了个激活函数：<br />
\begin{equation}\phi(\boldsymbol{q})^{\top}\big(\exp (n-m)\boldsymbol{B}\big)\varphi(\boldsymbol{k}) = \big(\boldsymbol{P}^{\top}\phi(\boldsymbol{q})\big)^{\top}\big(\exp (n-m)\boldsymbol{\Lambda}\big)\big(\boldsymbol{P}^{-1}\varphi(\boldsymbol{k})\big)\end{equation}<br />
这就导致了$\boldsymbol{P}^{\top},\boldsymbol{P}^{-1}$不一定能吸收到线性变换的训练参数中，因此对线性Attention补上两个参数矩阵，是有可能带来提升的。</p>
<h2 id="_4">文章小结<a class="toc-link" href="#_4" title="Permanent link">&para;</a></h2>
<p>本文简单分析了RoPE的完备性问题，表明对于Self Attention来说，目前的分块对角型RoPE不会损失一般性。</p>
<p><em><strong>转载到请包括本文地址：</strong><a href="https://spaces.ac.cn/archives/9403">https://spaces.ac.cn/archives/9403</a></em></p>
<p><em><strong>更详细的转载事宜请参考：</strong></em><a href="https://spaces.ac.cn/archives/6508#%E6%96%87%E7%AB%A0%E5%A6%82%E4%BD%95%E8%BD%AC%E8%BD%BD/%E5%BC%95%E7%94%A8" title="《科学空间FAQ》">《科学空间FAQ》</a></p>
<p><strong>如果您还有什么疑惑或建议，欢迎在下方评论区继续讨论。</strong></p>
<p><strong>如果您觉得本文还不错，欢迎分享/打赏本文。打赏并非要从中获得收益，而是希望知道科学空间获得了多少读者的真心关注。当然，如果你无视它，也不会影响你的阅读。再次表示欢迎和感谢！</strong></p>
<p>打赏</p>
<p><img alt="科学空间" src="https://spaces.ac.cn/usr/themes/geekg/payment/wx.png" /></p>
<p>微信打赏</p>
<p><img alt="科学空间" src="https://spaces.ac.cn/usr/themes/geekg/payment/zfb.png" /></p>
<p>支付宝打赏</p>
<p>因为网站后台对打赏并无记录，因此欢迎在打赏时候备注留言。你还可以<a href="http://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&amp;email=tN7d1drY3drrx8H0xcWa19vZ"><strong>点击这里</strong></a>或在下方评论区留言来告知你的建议或需求。</p>
<p><strong>如果您需要引用本文，请参考：</strong></p>
<p>苏剑林. (Dec. 28, 2022). 《Transformer升级之路：6、旋转位置编码的完备性分析 》[Blog post]. Retrieved from <a href="https://spaces.ac.cn/archives/9403">https://spaces.ac.cn/archives/9403</a></p>
<p>@online{kexuefm-9403,<br />
title={Transformer升级之路：6、旋转位置编码的完备性分析},<br />
author={苏剑林},<br />
year={2022},<br />
month={Dec},<br />
url={\url{https://spaces.ac.cn/archives/9403}},<br />
} </p>
<hr />
<h2 id="_5">公式推导与注释<a class="toc-link" href="#_5" title="Permanent link">&para;</a></h2>
<h3 id="1-rope">1. RoPE的旋转矩阵表示与复数形式<a class="toc-link" href="#1-rope" title="Permanent link">&para;</a></h3>
<h4 id="11">1.1 二维旋转矩阵的基本性质<a class="toc-link" href="#11" title="Permanent link">&para;</a></h4>
<p>二维旋转矩阵的标准形式为：</p>
<p>$$\boldsymbol{R}_{\theta} = \begin{pmatrix} \cos\theta &amp; -\sin\theta \ \sin\theta &amp; \cos\theta \end{pmatrix}$$</p>
<p><strong>性质1（旋转矩阵的正交性）</strong>：旋转矩阵满足 $\boldsymbol{R}<em _theta="\theta">{\theta}^{\top}\boldsymbol{R}</em>$} = \boldsymbol{I</p>
<p>证明：
$$\boldsymbol{R}<em _theta="\theta">{\theta}^{\top}\boldsymbol{R}</em>$$} = \begin{pmatrix} \cos\theta &amp; \sin\theta \ -\sin\theta &amp; \cos\theta \end{pmatrix}\begin{pmatrix} \cos\theta &amp; -\sin\theta \ \sin\theta &amp; \cos\theta \end{pmatrix} = \begin{pmatrix} \cos^2\theta + \sin^2\theta &amp; -\cos\theta\sin\theta + \sin\theta\cos\theta \ -\sin\theta\cos\theta + \cos\theta\sin\theta &amp; \sin^2\theta + \cos^2\theta \end{pmatrix} = \begin{pmatrix} 1 &amp; 0 \ 0 &amp; 1 \end{pmatrix</p>
<p><strong>性质2（旋转矩阵的行列式）</strong>：$\det(\boldsymbol{R}_{\theta}) = 1$</p>
<p>证明：
$$\det(\boldsymbol{R}_{\theta}) = \cos\theta \cdot \cos\theta - (-\sin\theta) \cdot \sin\theta = \cos^2\theta + \sin^2\theta = 1$$</p>
<p><strong>性质3（旋转矩阵的复合）</strong>：$\boldsymbol{R}<em _theta_2="\theta_2">{\theta_1}\boldsymbol{R}</em>$} = \boldsymbol{R}_{\theta_1 + \theta_2</p>
<p>证明：
$$\begin{aligned}
\boldsymbol{R}<em _theta_2="\theta_2">{\theta_1}\boldsymbol{R}</em> \
&amp;= \begin{pmatrix} \cos\theta_1\cos\theta_2 - \sin\theta_1\sin\theta_2 &amp; -\cos\theta_1\sin\theta_2 - \sin\theta_1\cos\theta_2 \ \sin\theta_1\cos\theta_2 + \cos\theta_1\sin\theta_2 &amp; -\sin\theta_1\sin\theta_2 + \cos\theta_1\cos\theta_2 \end{pmatrix} \
&amp;= \begin{pmatrix} \cos(\theta_1+\theta_2) &amp; -\sin(\theta_1+\theta_2) \ \sin(\theta_1+\theta_2) &amp; \cos(\theta_1+\theta_2) \end{pmatrix} = \boldsymbol{R}_{\theta_1+\theta_2}
\end{aligned}$$} &amp;= \begin{pmatrix} \cos\theta_1 &amp; -\sin\theta_1 \ \sin\theta_1 &amp; \cos\theta_1 \end{pmatrix}\begin{pmatrix} \cos\theta_2 &amp; -\sin\theta_2 \ \sin\theta_2 &amp; \cos\theta_2 \end{pmatrix</p>
<h4 id="12">1.2 复数形式的旋转表示<a class="toc-link" href="#12" title="Permanent link">&para;</a></h4>
<p>将二维向量 $(x, y)$ 表示为复数 $z = x + iy$，则旋转操作可以表示为复数乘法：</p>
<p>$$z' = e^{i\theta} z = (\cos\theta + i\sin\theta)(x + iy)$$</p>
<p>展开得：
$$z' = (\cos\theta \cdot x - \sin\theta \cdot y) + i(\sin\theta \cdot x + \cos\theta \cdot y)$$</p>
<p>这对应于矩阵形式：
$$\begin{pmatrix} x' \ y' \end{pmatrix} = \begin{pmatrix} \cos\theta &amp; -\sin\theta \ \sin\theta &amp; \cos\theta \end{pmatrix}\begin{pmatrix} x \ y \end{pmatrix}$$</p>
<p><strong>定理1（复数旋转的等价性）</strong>：复数乘以 $e^{i\theta}$ 等价于对应二维向量应用旋转矩阵 $\boldsymbol{R}_{\theta}$。</p>
<h4 id="13-rope">1.3 RoPE的位置编码形式<a class="toc-link" href="#13-rope" title="Permanent link">&para;</a></h4>
<p>对于位置 $m$ 的向量 $\boldsymbol{q}_m \in \mathbb{R}^d$（假设 $d$ 为偶数），RoPE将其分为 $d/2$ 个二维块：</p>
<p>$$\boldsymbol{q}_m = \begin{pmatrix} q_m^{(1)} \ q_m^{(2)} \ \vdots \ q_m^{(d-1)} \ q_m^{(d)} \end{pmatrix} \rightarrow \begin{pmatrix} q_m^{(1)} \ q_m^{(2)} \ \hdashline q_m^{(3)} \ q_m^{(4)} \ \hdashline \vdots \ \vdots \ \hdashline q_m^{(d-1)} \ q_m^{(d)} \end{pmatrix}$$</p>
<p>对第 $i$ 个二维块（$i = 0, 1, \ldots, d/2-1$），应用旋转角度 $\theta_i$：</p>
<p>$$\begin{pmatrix} q_m^{(2i+1)} \ q_m^{(2i+2)} \end{pmatrix} \rightarrow \begin{pmatrix} \cos(m\theta_i) &amp; -\sin(m\theta_i) \ \sin(m\theta_i) &amp; \cos(m\theta_i) \end{pmatrix}\begin{pmatrix} q_m^{(2i+1)} \ q_m^{(2i+2)} \end{pmatrix}$$</p>
<p>其中旋转角度按几何级数递减：
$$\theta_i = \theta_{\text{base}}^{-2i/d}, \quad \theta_{\text{base}} = 10000$$</p>
<h4 id="14-rope">1.4 复数形式的RoPE<a class="toc-link" href="#14-rope" title="Permanent link">&para;</a></h4>
<p>将每个二维块表示为复数：
$$z_m^{(i)} = q_m^{(2i+1)} + i q_m^{(2i+2)}$$</p>
<p>则RoPE操作为：
$$z_m^{(i)} \rightarrow e^{im\theta_i} z_m^{(i)}$$</p>
<p>完整的RoPE编码向量可表示为：
$$\text{RoPE}(\boldsymbol{q}<em d_2-1="d/2-1">m) = \begin{pmatrix} \text{Re}(e^{im\theta_0} z_m^{(0)}) \ \text{Im}(e^{im\theta_0} z_m^{(0)}) \ \text{Re}(e^{im\theta_1} z_m^{(1)}) \ \text{Im}(e^{im\theta_1} z_m^{(1)}) \ \vdots \ \text{Re}(e^{im\theta</em>$$}} z_m^{(d/2-1)}) \ \text{Im}(e^{im\theta_{d/2-1}} z_m^{(d/2-1)}) \end{pmatrix</p>
<h3 id="2">2. 相对位置编码的等价性<a class="toc-link" href="#2" title="Permanent link">&para;</a></h3>
<h4 id="21">2.1 自注意力中的相对位置<a class="toc-link" href="#21" title="Permanent link">&para;</a></h4>
<p>在自注意力机制中，Query向量 $\boldsymbol{q}_m$ 和 Key向量 $\boldsymbol{k}_n$ 的点积为：</p>
<p>$$\text{score}(m, n) = \boldsymbol{q}_m^{\top} \boldsymbol{k}_n$$</p>
<p>应用RoPE后：
$$\text{score}_{\text{RoPE}}(m, n) = (\boldsymbol{\mathcal{R}}_m \boldsymbol{q}_m)^{\top} (\boldsymbol{\mathcal{R}}_n \boldsymbol{k}_n)$$</p>
<p>其中 $\boldsymbol{\mathcal{R}}<em m_theta_0="m\theta_0">m$ 是分块对角矩阵：
$$\boldsymbol{\mathcal{R}}_m = \begin{pmatrix} \boldsymbol{R}</em>} &amp; \boldsymbol{0} &amp; \cdots &amp; \boldsymbol{0} \ \boldsymbol{0} &amp; \boldsymbol{R<em m_theta__d_2-1="m\theta_{d/2-1">{m\theta_1} &amp; \cdots &amp; \boldsymbol{0} \ \vdots &amp; \vdots &amp; \ddots &amp; \vdots \ \boldsymbol{0} &amp; \boldsymbol{0} &amp; \cdots &amp; \boldsymbol{R}</em>$$}} \end{pmatrix</p>
<h4 id="22">2.2 相对位置的推导<a class="toc-link" href="#22" title="Permanent link">&para;</a></h4>
<p>利用旋转矩阵的正交性 $\boldsymbol{R}<em -_theta="-\theta">{\theta}^{\top} = \boldsymbol{R}</em>$：</p>
<p>$$\begin{aligned}
\text{score}_{\text{RoPE}}(m, n) &amp;= (\boldsymbol{\mathcal{R}}_m \boldsymbol{q}_m)^{\top} (\boldsymbol{\mathcal{R}}_n \boldsymbol{k}_n) \
&amp;= \boldsymbol{q}_m^{\top} \boldsymbol{\mathcal{R}}_m^{\top} \boldsymbol{\mathcal{R}}_n \boldsymbol{k}_n
\end{aligned}$$</p>
<p>由于旋转矩阵的复合性质：
$$\boldsymbol{\mathcal{R}}<em -m="-m">m^{\top} \boldsymbol{\mathcal{R}}_n = \boldsymbol{\mathcal{R}}</em>} \boldsymbol{\mathcal{R}<em n-m="n-m">n = \boldsymbol{\mathcal{R}}</em>$$</p>
<p>因此：
$$\text{score}<em n-m="n-m">{\text{RoPE}}(m, n) = \boldsymbol{q}_m^{\top} \boldsymbol{\mathcal{R}}</em>_n$$} \boldsymbol{k</p>
<p><strong>定理2（RoPE的相对位置编码性质）</strong>：RoPE编码的注意力得分仅依赖于相对位置 $n-m$，而不依赖于绝对位置 $m$ 和 $n$。</p>
<h4 id="23">2.3 复数形式的相对位置<a class="toc-link" href="#23" title="Permanent link">&para;</a></h4>
<p>对于第 $i$ 个二维块，复数形式为：
$$\text{score}^{(i)}(m, n) = \text{Re}((e^{im\theta_i} z_m^{(i)})^* (e^{in\theta_i} w_n^{(i)}))$$</p>
<p>其中 $z_m^{(i)}$ 和 $w_n^{(i)}$ 分别是Query和Key的复数表示，$*$ 表示共轭。</p>
<p>利用 $(e^{i\alpha}z)^<em> = e^{-i\alpha}z^</em>$：
$$\begin{aligned}
\text{score}^{(i)}(m, n) &amp;= \text{Re}(e^{-im\theta_i} (z_m^{(i)})^<em> e^{in\theta_i} w_n^{(i)}) \
&amp;= \text{Re}(e^{i(n-m)\theta_i} (z_m^{(i)})^</em> w_n^{(i)})
\end{aligned}$$</p>
<p>这明确显示了仅依赖于相对位置 $n-m$。</p>
<h3 id="3">3. 旋转位置编码的完备性定理<a class="toc-link" href="#3" title="Permanent link">&para;</a></h3>
<h4 id="31">3.1 反对称矩阵的分解定理<a class="toc-link" href="#31" title="Permanent link">&para;</a></h4>
<p><strong>定理3（偶数阶反对称矩阵的标准形）</strong>：任意 $d$ 阶反对称矩阵 $\boldsymbol{B}$（$d$ 为偶数），存在正交矩阵 $\boldsymbol{P}$ 使得：</p>
<p>$$\boldsymbol{B} = \boldsymbol{P} \boldsymbol{\Lambda} \boldsymbol{P}^{\top}$$</p>
<p>其中 $\boldsymbol{\Lambda}$ 是分块对角矩阵：
$$\boldsymbol{\Lambda} = \begin{pmatrix} \boldsymbol{J}<em _theta_1="\theta_1">{\theta_0} &amp; \boldsymbol{0} &amp; \cdots &amp; \boldsymbol{0} \ \boldsymbol{0} &amp; \boldsymbol{J}</em>} &amp; \cdots &amp; \boldsymbol{0} \ \vdots &amp; \vdots &amp; \ddots &amp; \vdots \ \boldsymbol{0} &amp; \boldsymbol{0} &amp; \cdots &amp; \boldsymbol{J<em d_2-1="d/2-1">{\theta</em>$$}} \end{pmatrix</p>
<p>且 $\boldsymbol{J}_{\theta} = \begin{pmatrix} 0 &amp; -\theta \ \theta &amp; 0 \end{pmatrix}$。</p>
<p><strong>证明思路</strong>：反对称矩阵的特征值成共轭对出现，即如果 $\lambda$ 是特征值，则 $-\lambda$ 也是特征值。对于反对称矩阵，特征值都是纯虚数，记为 $\pm i\theta_j$。通过Schur分解和适当的基变换，可以将矩阵化为上述分块对角形式。</p>
<h4 id="32">3.2 矩阵指数的性质<a class="toc-link" href="#32" title="Permanent link">&para;</a></h4>
<p>对于反对称矩阵 $\boldsymbol{B}$，矩阵指数 $\exp(\boldsymbol{B})$ 定义为泰勒级数：</p>
<p>$$\exp(\boldsymbol{B}) = \sum_{k=0}^{\infty} \frac{\boldsymbol{B}^k}{k!} = \boldsymbol{I} + \boldsymbol{B} + \frac{\boldsymbol{B}^2}{2!} + \frac{\boldsymbol{B}^3}{3!} + \cdots$$</p>
<p><strong>性质4（矩阵指数的正交性）</strong>：若 $\boldsymbol{B}^{\top} = -\boldsymbol{B}$，则 $\exp(\boldsymbol{B})$ 是正交矩阵。</p>
<p>证明：
$$\begin{aligned}
(\exp(\boldsymbol{B}))^{\top} \exp(\boldsymbol{B}) &amp;= \exp(\boldsymbol{B}^{\top}) \exp(\boldsymbol{B}) \
&amp;= \exp(-\boldsymbol{B}) \exp(\boldsymbol{B}) \
&amp;= \exp(-\boldsymbol{B} + \boldsymbol{B}) = \exp(\boldsymbol{0}) = \boldsymbol{I}
\end{aligned}$$</p>
<p>注：这里使用了 $\exp(\boldsymbol{A})\exp(\boldsymbol{B}) = \exp(\boldsymbol{A} + \boldsymbol{B})$ 当 $\boldsymbol{A}\boldsymbol{B} = \boldsymbol{B}\boldsymbol{A}$ 时成立，而 $\boldsymbol{B}$ 与其转置必然交换。</p>
<p><strong>性质5（分块对角矩阵的指数）</strong>：
$$\exp\begin{pmatrix} \boldsymbol{A} &amp; \boldsymbol{0} \ \boldsymbol{0} &amp; \boldsymbol{B} \end{pmatrix} = \begin{pmatrix} \exp(\boldsymbol{A}) &amp; \boldsymbol{0} \ \boldsymbol{0} &amp; \exp(\boldsymbol{B}) \end{pmatrix}$$</p>
<p>对于 $\boldsymbol{J}_{\theta} = \begin{pmatrix} 0 &amp; -\theta \ \theta &amp; 0 \end{pmatrix}$，计算其矩阵指数：</p>
<p>$$\boldsymbol{J}_{\theta}^2 = \begin{pmatrix} 0 &amp; -\theta \ \theta &amp; 0 \end{pmatrix}\begin{pmatrix} 0 &amp; -\theta \ \theta &amp; 0 \end{pmatrix} = \begin{pmatrix} -\theta^2 &amp; 0 \ 0 &amp; -\theta^2 \end{pmatrix} = -\theta^2 \boldsymbol{I}$$</p>
<p>因此：
$$\boldsymbol{J}<em _theta="\theta">{\theta}^{2k} = (-1)^k \theta^{2k} \boldsymbol{I}, \quad \boldsymbol{J}</em>$$}^{2k+1} = (-1)^k \theta^{2k} \boldsymbol{J}_{\theta</p>
<p>代入泰勒级数：
$$\begin{aligned}
\exp(\boldsymbol{J}<em k="0">{\theta}) &amp;= \sum</em>}^{\infty} \frac{\boldsymbol{J<em k="0">{\theta}^k}{k!} \
&amp;= \sum</em>}^{\infty} \frac{\boldsymbol{J<em k="0">{\theta}^{2k}}{(2k)!} + \sum</em>}^{\infty} \frac{\boldsymbol{J<em k="0">{\theta}^{2k+1}}{(2k+1)!} \
&amp;= \boldsymbol{I} \sum</em>}^{\infty} \frac{(-1)^k \theta^{2k}}{(2k)!} + \boldsymbol{J<em k="0">{\theta} \sum</em> \
&amp;= \boldsymbol{I} \cos\theta + \boldsymbol{J}_{\theta} \frac{\sin\theta}{\theta}
\end{aligned}$$}^{\infty} \frac{(-1)^k \theta^{2k}}{(2k+1)!</p>
<p>具体展开：
$$\exp(\boldsymbol{J}<em _theta="\theta">{\theta}) = \begin{pmatrix} \cos\theta &amp; -\sin\theta \ \sin\theta &amp; \cos\theta \end{pmatrix} = \boldsymbol{R}</em>$$</p>
<h4 id="33">3.3 完备性定理的证明<a class="toc-link" href="#33" title="Permanent link">&para;</a></h4>
<p><strong>定理4（RoPE的完备性定理）</strong>：对于Self Attention，分块对角形式的RoPE编码与一般的反对称矩阵指数形式 $\exp(n\boldsymbol{B})$ 在表达能力上是等价的。</p>
<p><strong>证明</strong>：</p>
<p>设 $\boldsymbol{B}$ 是任意 $d$ 阶反对称矩阵，由定理3，存在正交矩阵 $\boldsymbol{P}$ 使得：
$$\boldsymbol{B} = \boldsymbol{P} \boldsymbol{\Lambda} \boldsymbol{P}^{\top}$$</p>
<p>因此：
$$\exp(n\boldsymbol{B}) = \exp(n\boldsymbol{P}\boldsymbol{\Lambda}\boldsymbol{P}^{\top})$$</p>
<p>利用矩阵指数的相似不变性质 $\exp(\boldsymbol{P}\boldsymbol{A}\boldsymbol{P}^{-1}) = \boldsymbol{P}\exp(\boldsymbol{A})\boldsymbol{P}^{-1}$（对于正交矩阵 $\boldsymbol{P}^{-1} = \boldsymbol{P}^{\top}$）：</p>
<p>$$\exp(n\boldsymbol{B}) = \boldsymbol{P} \exp(n\boldsymbol{\Lambda}) \boldsymbol{P}^{\top}$$</p>
<p>在Self Attention中的应用：
$$\begin{aligned}
\boldsymbol{q}_m^{\top} \exp((n-m)\boldsymbol{B}) \boldsymbol{k}_n &amp;= \boldsymbol{q}_m^{\top} \boldsymbol{P} \exp((n-m)\boldsymbol{\Lambda}) \boldsymbol{P}^{\top} \boldsymbol{k}_n \
&amp;= (\boldsymbol{P}^{\top}\boldsymbol{q}_m)^{\top} \exp((n-m)\boldsymbol{\Lambda}) (\boldsymbol{P}^{\top}\boldsymbol{k}_n)
\end{aligned}$$</p>
<p>设 $\tilde{\boldsymbol{q}}_m = \boldsymbol{P}^{\top}\boldsymbol{q}_m$，$\tilde{\boldsymbol{k}}_n = \boldsymbol{P}^{\top}\boldsymbol{k}_n$。</p>
<p>在神经网络中，$\boldsymbol{q}_m$ 和 $\boldsymbol{k}_n$ 通常是输入 $\boldsymbol{x}$ 经过线性变换得到：
$$\boldsymbol{q}_m = \boldsymbol{W}_Q \boldsymbol{x}_m, \quad \boldsymbol{k}_n = \boldsymbol{W}_K \boldsymbol{x}_n$$</p>
<p>则：
$$\tilde{\boldsymbol{q}}_m = \boldsymbol{P}^{\top}\boldsymbol{W}_Q \boldsymbol{x}_m = \tilde{\boldsymbol{W}}_Q \boldsymbol{x}_m, \quad \tilde{\boldsymbol{k}}_n = \boldsymbol{P}^{\top}\boldsymbol{W}_K \boldsymbol{x}_n = \tilde{\boldsymbol{W}}_K \boldsymbol{x}_n$$</p>
<p>其中 $\tilde{\boldsymbol{W}}_Q = \boldsymbol{P}^{\top}\boldsymbol{W}_Q$，$\tilde{\boldsymbol{W}}_K = \boldsymbol{P}^{\top}\boldsymbol{W}_K$。</p>
<p>由于 $\boldsymbol{W}_Q$ 和 $\boldsymbol{W}_K$ 是可训练参数，$\boldsymbol{P}^{\top}$ 可以被吸收到这些参数中。因此，使用一般的 $\exp(n\boldsymbol{B})$ 与使用分块对角的 $\exp(n\boldsymbol{\Lambda})$ 在表达能力上是等价的。</p>
<p><strong>推论</strong>：这意味着我们不需要使用更复杂的全参数反对称矩阵形式，简单的分块对角RoPE已经具有完备的表达能力。</p>
<h3 id="4">4. 正交性质与范数保持<a class="toc-link" href="#4" title="Permanent link">&para;</a></h3>
<h4 id="41-rope">4.1 RoPE变换的等距性<a class="toc-link" href="#41-rope" title="Permanent link">&para;</a></h4>
<p><strong>定理5（RoPE的等距性）</strong>：RoPE变换保持向量的欧几里得范数。</p>
<p>证明：对于向量 $\boldsymbol{v}$，应用RoPE变换后为 $\boldsymbol{\mathcal{R}}_m \boldsymbol{v}$，其范数为：</p>
<p>$$|\boldsymbol{\mathcal{R}}_m \boldsymbol{v}|^2 = (\boldsymbol{\mathcal{R}}_m \boldsymbol{v})^{\top} (\boldsymbol{\mathcal{R}}_m \boldsymbol{v}) = \boldsymbol{v}^{\top} \boldsymbol{\mathcal{R}}_m^{\top} \boldsymbol{\mathcal{R}}_m \boldsymbol{v}$$</p>
<p>由于 $\boldsymbol{\mathcal{R}}_m$ 是正交矩阵，$\boldsymbol{\mathcal{R}}_m^{\top} \boldsymbol{\mathcal{R}}_m = \boldsymbol{I}$：</p>
<p>$$|\boldsymbol{\mathcal{R}}_m \boldsymbol{v}|^2 = \boldsymbol{v}^{\top} \boldsymbol{v} = |\boldsymbol{v}|^2$$</p>
<p>这表明RoPE变换不改变向量的长度。</p>
<h4 id="42">4.2 内积的变化<a class="toc-link" href="#42" title="Permanent link">&para;</a></h4>
<p>对于两个向量 $\boldsymbol{u}$ 和 $\boldsymbol{v}$，应用不同的RoPE变换后的内积：</p>
<p>$$\langle \boldsymbol{\mathcal{R}}<em n-m="n-m">m \boldsymbol{u}, \boldsymbol{\mathcal{R}}_n \boldsymbol{v} \rangle = \boldsymbol{u}^{\top} \boldsymbol{\mathcal{R}}_m^{\top} \boldsymbol{\mathcal{R}}_n \boldsymbol{v} = \boldsymbol{u}^{\top} \boldsymbol{\mathcal{R}}</em>$$} \boldsymbol{v</p>
<p>这个内积仅依赖于相对位置 $n-m$ 和原始向量 $\boldsymbol{u}$、$\boldsymbol{v}$。</p>
<h4 id="43">4.3 角度的保持<a class="toc-link" href="#43" title="Permanent link">&para;</a></h4>
<p>对于同一位置的两个向量 $\boldsymbol{u}$ 和 $\boldsymbol{v}$，应用相同的RoPE变换后：</p>
<p>$$\cos\angle(\boldsymbol{\mathcal{R}}_m \boldsymbol{u}, \boldsymbol{\mathcal{R}}_m \boldsymbol{v}) = \frac{\langle \boldsymbol{\mathcal{R}}_m \boldsymbol{u}, \boldsymbol{\mathcal{R}}_m \boldsymbol{v} \rangle}{|\boldsymbol{\mathcal{R}}_m \boldsymbol{u}| |\boldsymbol{\mathcal{R}}_m \boldsymbol{v}|}$$</p>
<p>由于RoPE的正交性：
$$\langle \boldsymbol{\mathcal{R}}_m \boldsymbol{u}, \boldsymbol{\mathcal{R}}_m \boldsymbol{v} \rangle = \boldsymbol{u}^{\top} \boldsymbol{\mathcal{R}}_m^{\top} \boldsymbol{\mathcal{R}}_m \boldsymbol{v} = \boldsymbol{u}^{\top} \boldsymbol{v} = \langle \boldsymbol{u}, \boldsymbol{v} \rangle$$</p>
<p>且：
$$|\boldsymbol{\mathcal{R}}_m \boldsymbol{u}| = |\boldsymbol{u}|, \quad |\boldsymbol{\mathcal{R}}_m \boldsymbol{v}| = |\boldsymbol{v}|$$</p>
<p>因此：
$$\cos\angle(\boldsymbol{\mathcal{R}}_m \boldsymbol{u}, \boldsymbol{\mathcal{R}}_m \boldsymbol{v}) = \frac{\langle \boldsymbol{u}, \boldsymbol{v} \rangle}{|\boldsymbol{u}| |\boldsymbol{v}|} = \cos\angle(\boldsymbol{u}, \boldsymbol{v})$$</p>
<p><strong>定理6（角度保持性）</strong>：在同一位置，RoPE变换保持向量之间的夹角不变。</p>
<h3 id="5">5. 多维推广与维度分解<a class="toc-link" href="#5" title="Permanent link">&para;</a></h3>
<h4 id="51">5.1 高维旋转的分解<a class="toc-link" href="#51" title="Permanent link">&para;</a></h4>
<p>对于 $d$ 维空间（$d$ 为偶数），任意旋转可以分解为 $d/2$ 个二维平面上的旋转。</p>
<p>设 $d = 2k$，则 $d$ 维向量可以看作 $k$ 个二维向量的拼接：
$$\boldsymbol{v} = \begin{pmatrix} \boldsymbol{v}<em k-1="k-1">0 \ \boldsymbol{v}_1 \ \vdots \ \boldsymbol{v}</em>^2$$} \end{pmatrix}, \quad \boldsymbol{v}_i \in \mathbb{R</p>
<p>RoPE变换为：
$$\boldsymbol{\mathcal{R}}<em m_theta_0="m\theta_0">m \boldsymbol{v} = \begin{pmatrix} \boldsymbol{R}</em>} \boldsymbol{v<em m_theta_1="m\theta_1">0 \ \boldsymbol{R}</em>} \boldsymbol{v<em m_theta__k-1="m\theta_{k-1">1 \ \vdots \ \boldsymbol{R}</em>$$}} \boldsymbol{v}_{k-1} \end{pmatrix</p>
<h4 id="52">5.2 频率的选择<a class="toc-link" href="#52" title="Permanent link">&para;</a></h4>
<p>旋转频率 $\theta_i$ 的选择遵循几何级数：
$$\theta_i = \theta_{\text{base}}^{-2i/d}$$</p>
<p>这种选择的优点：
1. <strong>多尺度表示</strong>：不同的频率能够编码不同尺度的位置信息
2. <strong>容量充分</strong>：从高频到低频覆盖了广泛的频率范围
3. <strong>平滑过渡</strong>：几何级数保证了频率的平滑递减</p>
<p>对于基础频率 $\theta_{\text{base}} = 10000$，第 $i$ 个维度对的周期为：
$$T_i = \frac{2\pi}{\theta_i} = 2\pi \cdot 10000^{2i/d}$$</p>
<p>当 $i = 0$ 时，$T_0 = 2\pi$，周期最短；
当 $i = d/2-1$ 时，$T_{d/2-1} = 2\pi \cdot 10000$，周期最长。</p>
<h4 id="53">5.3 维度对的独立性<a class="toc-link" href="#53" title="Permanent link">&para;</a></h4>
<p><strong>定理7（维度对的正交性）</strong>：不同维度对的旋转操作是相互独立的。</p>
<p>证明：由于 $\boldsymbol{\mathcal{R}}_m$ 是分块对角矩阵，不同块之间没有耦合：</p>
<p>$$\boldsymbol{\mathcal{R}}<em m_theta_0="m\theta_0">m = \begin{pmatrix} \boldsymbol{R}</em>} &amp; &amp; &amp; \ &amp; \boldsymbol{R<em m_theta__d_2-1="m\theta_{d/2-1">{m\theta_1} &amp; &amp; \ &amp; &amp; \ddots &amp; \ &amp; &amp; &amp; \boldsymbol{R}</em>$$}} \end{pmatrix</p>
<p>对于维度对 $i$ 和 $j$（$i \neq j$），它们的变换互不影响：
$$\frac{\partial (\boldsymbol{\mathcal{R}}<em 2i:2i_2="2i:2i+2">m \boldsymbol{v})</em>$$}}{\partial \boldsymbol{v}_{2j:2j+2}} = \boldsymbol{0</p>
<p>这种独立性使得模型可以在不同频率尺度上独立学习位置信息。</p>
<h3 id="6">6. 与其他位置编码的对比分析<a class="toc-link" href="#6" title="Permanent link">&para;</a></h3>
<h4 id="61-sinusoidal">6.1 与Sinusoidal位置编码的对比<a class="toc-link" href="#61-sinusoidal" title="Permanent link">&para;</a></h4>
<p><strong>Sinusoidal编码</strong>：
$$\begin{aligned}
PE(m, 2i) &amp;= \sin(m / 10000^{2i/d}) \
PE(m, 2i+1) &amp;= \cos(m / 10000^{2i/d})
\end{aligned}$$</p>
<p>这是一种绝对位置编码，直接加在输入向量上：
$$\boldsymbol{x}_m' = \boldsymbol{x}_m + PE(m)$$</p>
<p><strong>相对位置的实现</strong>：Sinusoidal编码可以通过三角恒等式实现相对位置：
$$\begin{aligned}
PE(m, 2i) \cdot PE(n, 2i) + PE(m, 2i+1) \cdot PE(n, 2i+1)
&amp;= \sin(m\omega_i)\sin(n\omega_i) + \cos(m\omega_i)\cos(n\omega_i) \
&amp;= \cos((m-n)\omega_i)
\end{aligned}$$</p>
<p>其中 $\omega_i = 1/10000^{2i/d}$。</p>
<p><strong>与RoPE的区别</strong>：
1. <strong>作用方式</strong>：Sinusoidal是加法，RoPE是旋转（乘法）
2. <strong>相对位置</strong>：Sinusoidal需要通过点积间接获得，RoPE直接建模
3. <strong>范数保持</strong>：RoPE保持范数，Sinusoidal改变范数</p>
<h4 id="62">6.2 与可训练位置编码的对比<a class="toc-link" href="#62" title="Permanent link">&para;</a></h4>
<p><strong>可训练位置编码</strong>：
$$PE(m) = \boldsymbol{E}_m \in \mathbb{R}^d$$</p>
<p>其中 $\boldsymbol{E}_m$ 是可学习的参数矩阵的第 $m$ 行。</p>
<p><strong>优缺点对比</strong>：</p>
<table>
<thead>
<tr>
<th>特性</th>
<th>可训练位置编码</th>
<th>RoPE</th>
</tr>
</thead>
<tbody>
<tr>
<td>参数量</td>
<td>$O(L \cdot d)$（$L$ 为最大长度）</td>
<td>无参数</td>
</tr>
<tr>
<td>外推能力</td>
<td>差（未见过的位置无编码）</td>
<td>好（函数式定义）</td>
</tr>
<tr>
<td>相对位置</td>
<td>需要额外设计</td>
<td>天然支持</td>
</tr>
<tr>
<td>灵活性</td>
<td>高（完全可学习）</td>
<td>低（固定函数形式）</td>
</tr>
</tbody>
</table>
<h4 id="63-rpe">6.3 与相对位置编码（RPE）的对比<a class="toc-link" href="#63-rpe" title="Permanent link">&para;</a></h4>
<p><strong>相对位置编码（Relative Position Encoding）</strong>：
$$\text{score}(m, n) = \boldsymbol{q}<em m-n="m-n">m^{\top} \boldsymbol{k}_n + \boldsymbol{q}_m^{\top} \boldsymbol{r}</em>$$</p>
<p>其中 $\boldsymbol{r}_{m-n}$ 是可训练的相对位置嵌入。</p>
<p><strong>Shaw等人的方法</strong>：
$$\text{score}(m, n) = \boldsymbol{q}<em m-n="m-n">m^{\top} \boldsymbol{k}_n + \boldsymbol{q}_m^{\top} \boldsymbol{W}_K^{\top} \boldsymbol{r}</em>^K$$</p>
<p><strong>与RoPE的区别</strong>：
1. <strong>实现方式</strong>：RPE是加法偏置，RoPE是旋转变换
2. <strong>参数效率</strong>：RPE需要存储相对位置嵌入，RoPE无参数
3. <strong>计算效率</strong>：RoPE可以预先计算旋转矩阵，效率更高</p>
<h4 id="64">6.4 定量对比分析<a class="toc-link" href="#64" title="Permanent link">&para;</a></h4>
<p>设序列长度为 $L$，隐藏维度为 $d$，则：</p>
<p><strong>空间复杂度</strong>：
- Sinusoidal：$O(1)$（无参数）
- 可训练绝对位置：$O(Ld)$
- 相对位置编码（RPE）：$O(L^2 d)$ 或 $O(Ld)$（截断版本）
- RoPE：$O(1)$（无参数，预计算旋转矩阵为 $O(d)$）</p>
<p><strong>时间复杂度（每个位置对）</strong>：
- Sinusoidal：$O(d)$（加法）
- 可训练绝对位置：$O(d)$（加法）
- 相对位置编码：$O(d)$（加法偏置）
- RoPE：$O(d)$（旋转，可预计算）</p>
<p><strong>外推性能</strong>：
- Sinusoidal：中等（函数式但高频振荡）
- 可训练绝对位置：差（需要重新训练）
- 相对位置编码：中等（需要外推新的相对位置）
- RoPE：好（天然支持任意长度）</p>
<h3 id="7-baker-campbell-hausdorff">7. 理论深化：Baker-Campbell-Hausdorff公式<a class="toc-link" href="#7-baker-campbell-hausdorff" title="Permanent link">&para;</a></h3>
<h4 id="71-bch">7.1 BCH公式的表述<a class="toc-link" href="#71-bch" title="Permanent link">&para;</a></h4>
<p>对于矩阵 $\boldsymbol{A}$ 和 $\boldsymbol{B}$，Baker-Campbell-Hausdorff公式给出：</p>
<p>$$\log(\exp(\boldsymbol{A})\exp(\boldsymbol{B})) = \boldsymbol{A} + \boldsymbol{B} + \frac{1}{2}[\boldsymbol{A}, \boldsymbol{B}] + \frac{1}{12}[\boldsymbol{A}, [\boldsymbol{A}, \boldsymbol{B}]] - \frac{1}{12}[\boldsymbol{B}, [\boldsymbol{A}, \boldsymbol{B}]] + \cdots$$</p>
<p>其中 $[\boldsymbol{A}, \boldsymbol{B}] = \boldsymbol{A}\boldsymbol{B} - \boldsymbol{B}\boldsymbol{A}$ 是矩阵的Lie括号。</p>
<h4 id="72-rope">7.2 应用于RoPE的验证<a class="toc-link" href="#72-rope" title="Permanent link">&para;</a></h4>
<p>对于RoPE，我们需要验证：
$$\exp(m\boldsymbol{B})^{\top} \exp(n\boldsymbol{B}) = \exp((n-m)\boldsymbol{B})$$</p>
<p>由于 $\boldsymbol{B}$ 是反对称矩阵（$\boldsymbol{B}^{\top} = -\boldsymbol{B}$），我们有：
$$\exp(m\boldsymbol{B})^{\top} = \exp(m\boldsymbol{B}^{\top}) = \exp(-m\boldsymbol{B})$$</p>
<p>应用BCH公式：
$$\begin{aligned}
\log(\exp(-m\boldsymbol{B})\exp(n\boldsymbol{B})) &amp;= -m\boldsymbol{B} + n\boldsymbol{B} + \frac{1}{2}[-m\boldsymbol{B}, n\boldsymbol{B}] + \cdots \
&amp;= (n-m)\boldsymbol{B} + \frac{-mn}{2}[\boldsymbol{B}, \boldsymbol{B}] + \cdots
\end{aligned}$$</p>
<p>由于 $[\boldsymbol{B}, \boldsymbol{B}] = \boldsymbol{B}\boldsymbol{B} - \boldsymbol{B}\boldsymbol{B} = \boldsymbol{0}$，所有高阶项都为零：</p>
<p>$$\log(\exp(-m\boldsymbol{B})\exp(n\boldsymbol{B})) = (n-m)\boldsymbol{B}$$</p>
<p>因此：
$$\exp(-m\boldsymbol{B})\exp(n\boldsymbol{B}) = \exp((n-m)\boldsymbol{B})$$</p>
<p>这证明了RoPE的相对位置性质。</p>
<h4 id="73-lie">7.3 反对称矩阵的Lie代数结构<a class="toc-link" href="#73-lie" title="Permanent link">&para;</a></h4>
<p>反对称矩阵构成一个Lie代数 $\mathfrak{so}(d)$（special orthogonal Lie algebra）：</p>
<p><strong>封闭性</strong>：对于反对称矩阵 $\boldsymbol{A}, \boldsymbol{B}$，$[\boldsymbol{A}, \boldsymbol{B}]$ 仍是反对称矩阵。</p>
<p>证明：
$$\begin{aligned}
[\boldsymbol{A}, \boldsymbol{B}]^{\top} &amp;= (\boldsymbol{A}\boldsymbol{B} - \boldsymbol{B}\boldsymbol{A})^{\top} \
&amp;= \boldsymbol{B}^{\top}\boldsymbol{A}^{\top} - \boldsymbol{A}^{\top}\boldsymbol{B}^{\top} \
&amp;= (-\boldsymbol{B})(-\boldsymbol{A}) - (-\boldsymbol{A})(-\boldsymbol{B}) \
&amp;= \boldsymbol{B}\boldsymbol{A} - \boldsymbol{A}\boldsymbol{B} \
&amp;= -[\boldsymbol{A}, \boldsymbol{B}]
\end{aligned}$$</p>
<p><strong>维度</strong>：$d$ 维空间的反对称矩阵有 $\binom{d}{2} = \frac{d(d-1)}{2}$ 个自由度。</p>
<p>对于 $d = 2$，只有1个自由度；对于 $d = 4$，有6个自由度。</p>
<h3 id="8">8. 数值稳定性分析<a class="toc-link" href="#8" title="Permanent link">&para;</a></h3>
<h4 id="81">8.1 浮点精度的影响<a class="toc-link" href="#81" title="Permanent link">&para;</a></h4>
<p>在实际计算中，旋转矩阵的计算涉及三角函数：
$$\boldsymbol{R}_{\theta} = \begin{pmatrix} \cos\theta &amp; -\sin\theta \ \sin\theta &amp; \cos\theta \end{pmatrix}$$</p>
<p>对于大的位置索引 $m$ 和小的频率 $\theta_i$，$m\theta_i$ 可能非常大，导致：
1. 浮点数精度损失
2. 周期性混叠</p>
<p><strong>解决方案</strong>：通过模运算归约到 $[0, 2\pi)$：
$$m\theta_i \leftarrow (m\theta_i) \mod 2\pi$$</p>
<h4 id="82">8.2 正交性的数值保持<a class="toc-link" href="#82" title="Permanent link">&para;</a></h4>
<p>理论上 $\boldsymbol{\mathcal{R}}_m$ 是正交矩阵，但数值计算可能导致偏离：
$$|\boldsymbol{\mathcal{R}}_m^{\top}\boldsymbol{\mathcal{R}}_m - \boldsymbol{I}|_F = \epsilon$$</p>
<p>其中 $\epsilon$ 是数值误差。</p>
<p><strong>误差累积</strong>：在长序列中，多次矩阵乘法可能累积误差。</p>
<p><strong>缓解措施</strong>：
1. 使用更高精度（如float64）计算旋转矩阵
2. 预计算并缓存旋转矩阵
3. 定期重新正交化（Gram-Schmidt过程）</p>
<h4 id="83">8.3 复数实现的优势<a class="toc-link" href="#83" title="Permanent link">&para;</a></h4>
<p>使用复数表示可以避免显式构造旋转矩阵：
$$z' = e^{i\theta} z$$</p>
<p>复数乘法比矩阵乘法更高效，且数值稳定性更好：
- 矩阵乘法：$O(4)$ 次浮点运算（2×2矩阵）
- 复数乘法：$O(3)$ 次浮点运算（优化的复数乘法）</p>
<h3 id="9">9. 总结与展望<a class="toc-link" href="#9" title="Permanent link">&para;</a></h3>
<h4 id="91">9.1 主要结论汇总<a class="toc-link" href="#91" title="Permanent link">&para;</a></h4>
<ol>
<li><strong>完备性</strong>：分块对角RoPE与全参数反对称矩阵指数在Self Attention中等价</li>
<li><strong>正交性</strong>：RoPE保持向量范数和角度，是等距变换</li>
<li><strong>相对位置</strong>：RoPE天然实现相对位置编码，仅依赖 $n-m$</li>
<li><strong>参数效率</strong>：RoPE无需任何可训练参数</li>
<li><strong>计算效率</strong>：通过预计算可高效实现</li>
</ol>
<h4 id="92">9.2 理论意义<a class="toc-link" href="#92" title="Permanent link">&para;</a></h4>
<ul>
<li>证明了简单的分块对角结构具有完备的表达能力</li>
<li>不需要更复杂的设计就能达到理论上的最优</li>
<li>为位置编码的设计提供了理论指导</li>
</ul>
<h4 id="93">9.3 实践价值<a class="toc-link" href="#93" title="Permanent link">&para;</a></h4>
<ul>
<li>降低了实现复杂度</li>
<li>提高了计算效率</li>
<li>保证了数值稳定性</li>
</ul>
<p>本文通过严格的数学推导，证明了RoPE的完备性，表明当前的分块对角设计已经是理论最优的选择，不需要进一步复杂化。这为RoPE在实践中的广泛应用提供了坚实的理论基础。</p>
                </div>

                <!-- Previous/Next Navigation -->
                <nav class="post-navigation" aria-label="文章导航">
                    <div class="row g-3">
                        <div class="col-6">
                            
                            <a href="生成扩散模型漫谈十五构建ode的一般步骤中.html" class="nav-link-prev">
                                <div class="nav-direction"><i class="fas fa-chevron-left"></i> 上一篇</div>
                                <div class="nav-title">#212 生成扩散模型漫谈（十五）：构建ODE的一般步骤（中）</div>
                            </a>
                            
                        </div>
                        <div class="col-6">
                            
                            <a href="transformer升级之路7长度外推性与局部注意力.html" class="nav-link-next">
                                <div class="nav-direction">下一篇 <i class="fas fa-chevron-right"></i></div>
                                <div class="nav-title">#214 Transformer升级之路：7、长度外推性与局部注意力</div>
                            </a>
                            
                        </div>
                    </div>
                </nav>

                <!-- Back to Home -->
                <div class="text-center mt-4 mb-4">
                    <a href="../index.html" class="btn btn-outline-primary">
                        <i class="fas fa-arrow-left"></i> 返回首页
                    </a>
                </div>
            </div>

            <!-- Sidebar (TOC) -->
            <div class="col-lg-3">
                <aside class="sidebar">
                    
                    <div class="toc-sidebar">
                        <h5 class="toc-title"><i class="fas fa-list"></i> 目录</h5>
                        <div class="toc-content">
                            <div class="toc">
<ul>
<li><a href="#transformer6">Transformer升级之路：6、旋转位置编码的完备性分析</a><ul>
<li><a href="#_1">指数通解</a></li>
<li><a href="#_2">正交通解</a></li>
<li><a href="#_3">完备分析</a></li>
<li><a href="#_4">文章小结</a></li>
<li><a href="#_5">公式推导与注释</a><ul>
<li><a href="#1-rope">1. RoPE的旋转矩阵表示与复数形式</a></li>
<li><a href="#2">2. 相对位置编码的等价性</a></li>
<li><a href="#3">3. 旋转位置编码的完备性定理</a></li>
<li><a href="#4">4. 正交性质与范数保持</a></li>
<li><a href="#5">5. 多维推广与维度分解</a></li>
<li><a href="#6">6. 与其他位置编码的对比分析</a></li>
<li><a href="#7-baker-campbell-hausdorff">7. 理论深化：Baker-Campbell-Hausdorff公式</a></li>
<li><a href="#8">8. 数值稳定性分析</a></li>
<li><a href="#9">9. 总结与展望</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>

                        </div>
                        <div class="toc-actions">
                            <button class="btn btn-sm btn-outline-secondary" onclick="expandAll()">
                                <i class="fas fa-expand"></i> 全部展开
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="collapseAll()">
                                <i class="fas fa-compress"></i> 全部折叠
                            </button>
                        </div>
                    </div>
                    

                    <!-- Back to Top Button -->
                    <button id="backToTop" class="back-to-top" title="回到顶部">
                        <i class="fas fa-arrow-up"></i>
                    </button>
                </aside>
            </div>
        </div>
    </article>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p>
                博客来源: <a href="https://spaces.ac.cn" target="_blank">科学空间</a> |
                内容经过整理并添加详细数学推导
            </p>
            <p>
                Powered by <a href="https://pages.github.com/" target="_blank">GitHub Pages</a>
            </p>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Syntax highlighting -->
    <script>hljs.highlightAll();</script>

    <!-- Back to top functionality -->
    <script>
        // Show/hide back to top button based on scroll position
        window.addEventListener('scroll', function() {
            const backToTop = document.getElementById('backToTop');
            if (window.pageYOffset > 300) {
                backToTop.classList.add('show');
            } else {
                backToTop.classList.remove('show');
            }
        });

        // Smooth scroll to top
        document.getElementById('backToTop').addEventListener('click', function() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        });

        // Sticky TOC sidebar
        window.addEventListener('scroll', function() {
            const sidebar = document.querySelector('.sidebar');
            if (!sidebar) return;

            const sidebarTop = sidebar.offsetTop;
            const scrollTop = window.pageYOffset;

            if (scrollTop > sidebarTop - 20) {
                sidebar.classList.add('sticky');
            } else {
                sidebar.classList.remove('sticky');
            }
        });
    </script>
</body>
</html>