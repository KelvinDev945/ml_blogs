<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>旁门左道之如何让Python的重试代码更加优雅 | ML & Math Blog Posts</title>
    <meta name="description" content="旁门左道之如何让Python的重试代码更加优雅
原文链接: https://spaces.ac.cn/archives/9938
发布日期: 

这篇文章我们讨论一个编程题：如何更优雅地在Python中实现重试。
在文章《新年快乐！记录一下 Cool Papers 的开发体验》中，笔者分享了开发Cool Papers的一些经验，其中就提到了Cool Papers所需要的一些网络通信步骤。但凡涉及到...">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css">

    <!-- Google Fonts -->
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="../assets/css/main.css">
    <link rel="stylesheet" href="../assets/css/post.css">

    <!-- MathJax for math rendering -->
    <script>
    MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']],
        processEscapes: true,
        processEnvironments: true
      },
      options: {
        skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
      }
    };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <!-- Syntax highlighting -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.7.0/build/styles/github.min.css">
    <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.7.0/build/highlight.min.js"></script>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light border-bottom">
        <div class="container">
            <a class="navbar-brand" href="../index.html">
                <i class="fas fa-brain"></i> ML & Math Blog
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="../index.html"><i class="fas fa-home"></i> 首页</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Post Content -->
    <article class="container post-container my-5">
        <!-- Post Header -->
        <header class="post-header mb-4">
            <h1 class="post-title">旁门左道之如何让Python的重试代码更加优雅</h1>
            <div class="post-meta">
                <span><i class="far fa-calendar"></i> </span>
                
                <span class="ms-3">
                    <i class="fas fa-link"></i>
                    <a href="https://spaces.ac.cn/archives/9938" target="_blank">原文链接</a>
                </span>
                
            </div>
            
            <div class="post-tags mt-3">
                
                <span class="tag"><i class="fas fa-tag"></i> 编程</span>
                <span class="tag"><i class="fas fa-tag"></i> 代码</span>
                <span class="tag"><i class="fas fa-tag"></i> python</span>
                <span class="tag"><i class="fas fa-tag"></i> 优化</span>
                <span class="tag"><i class="fas fa-tag"></i> 生成模型</span>
                
            </div>
            
        </header>

        <!-- Post Body -->
        <div class="post-content">
            <h1 id="python">旁门左道之如何让Python的重试代码更加优雅</h1>
<p><strong>原文链接</strong>: <a href="https://spaces.ac.cn/archives/9938">https://spaces.ac.cn/archives/9938</a></p>
<p><strong>发布日期</strong>: </p>
<hr />
<p>这篇文章我们讨论一个编程题：如何更优雅地在Python中实现重试。</p>
<p>在文章<a href="/archives/9920">《新年快乐！记录一下 Cool Papers 的开发体验》</a>中，笔者分享了开发<a href="https://papers.cool/">Cool Papers</a>的一些经验，其中就提到了Cool Papers所需要的一些网络通信步骤。但凡涉及到网络通信，就有失败的风险（谁也无法保证网络不会间歇性抽风），所以重试是网络通信的基本操作。此外，当涉及到多进程、数据库、硬件交互等操作时，通常也需要引入重试机制。</p>
<p>在Python中，实现重试并不难，但如何更加简单而又不失可读性地实现重试，还是有一定技巧的。接下来笔者分享一下自己的尝试。</p>
<h2 id="_1">循环重试</h2>
<p>完整的重试流程大致上包含循环重试、异常处理、延时等待、后续操作等部分，其标准写法就是用for循环，用“try ... except ...”来捕捉异常，一个参考代码是：</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">random</span><span class="w"> </span><span class="kn">import</span> <span class="n">random</span>

<span class="n">allright</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># 执行成功的标记</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>  <span class="c1"># 最多重试5次</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># 有概率出错的代码</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">random</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>
            <span class="n">yyyy</span>  <span class="c1"># 未定义yyyy，所以会报错</span>
        <span class="n">allright</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">break</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>  <span class="c1"># 打印错误信息</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># 延时两秒</span>

<span class="k">if</span> <span class="n">allright</span><span class="p">:</span>
    <span class="c1"># 执行某些操作</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;执行成功&#39;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="c1"># 执行另一些操作</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;执行失败&#39;</span><span class="p">)</span>
</code></pre></div>

<p>接下来我们的目的是简化<code>if allright:</code>之前的代码，可以发现，它具有比较固定的格式，即在for循环再加上“try ... break ... except ... sleep ...”的模版，不难想象它应该有很大的简化空间。</p>
<h2 id="_2">函数装饰</h2>
<p>for循环的问题在于，如果有很多处地方需要重试，并且异常处理的方法都一样，那么每次都重写一遍<code>except</code>的代码就显得很累赘。这种情况下，标准的推荐方法是将有概率出错的代码写成一个函数，并写一个用来处理异常的装饰器：</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">random</span><span class="w"> </span><span class="kn">import</span> <span class="n">random</span>

<span class="k">def</span><span class="w"> </span><span class="nf">retry</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;重试装饰器，包装函数加上重试功能</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">new_f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>  <span class="c1"># 最多重试5次</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>  <span class="c1"># 打印错误信息</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># 延时两秒</span>
        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">new_f</span>

<span class="nd">@retry</span>
<span class="k">def</span><span class="w"> </span><span class="nf">f</span><span class="p">():</span>
    <span class="c1"># 有概率出错的代码</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">random</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>
        <span class="n">yyyy</span>  <span class="c1"># 未定义yyyy，所以会报错</span>
    <span class="k">return</span> <span class="n">x</span>

<span class="n">allright</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">f</span><span class="p">()</span>  <span class="c1"># 返回执行状态和执行结果</span>
<span class="k">if</span> <span class="n">allright</span><span class="p">:</span>
    <span class="c1"># 执行某些操作</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;执行成功&#39;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="c1"># 执行另一些操作</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;执行失败&#39;</span><span class="p">)</span>
</code></pre></div>

<p>当有多处不同的代码都需要重试时，只需要将它们都分别写成函数并加上装饰器<code>@retry</code>就可以实现相同的重试逻辑，所以装饰器写法确实是一个简明的解决方法，也很直观，所以不难理解能成为标准。目前主流的重试库，比如<a href="https://github.com/jd/tenacity">tenacity</a>，或者更早的<a href="https://github.com/invl/retry">retry</a>、<a href="https://github.com/groodt/retrying">retrying</a>等，都是基于装饰器原理的。</p>
<h2 id="_3">理想写法</h2>
<p>然而，装饰器的写法虽然是标准，但并不完美。首先，需要把重试代码另外封装为一个函数，在很多情况下会让代码显得不够流畅，有种突然卡顿的感觉；其次，由于代码被封装为一个函数，所以代码中的中间变量没法直接用，需要用的变量得全部写在<code>return</code>中，这显得有点迂回。总的来说，装饰器虽然能够简化重试的代码，但仍然还差点意思。</p>
<p>笔者想象中的完美重试代码，应该是基于上下文管理器的写法，类似于：</p>
<div class="codehilite"><pre><span></span><code>with Retry(max_tries=5) as retry:
    # 有概率出错的代码
    x = random()
    if x &lt; 0.5:
        yyyy  # 未定义yyyy，所以会报错

if retry.allright:
    # 执行某些操作
    print(&#39;执行成功&#39;)
else:
    # 执行另一些操作
    print(&#39;执行失败&#39;)
</code></pre></div>

<p>然而，笔者去研究了一下上下文管理器的原理之后，才发现这种理想写法注定是<strong>无法实现</strong> 的。因为上下文管理器只能管理上下文，却不能管理主体代码（即本文中那段“有概率出错的代码”）。具体来说，上下文管理器是一个带有<code>__enter__</code>和<code>__exit__</code>方法的类，它将<code>__enter__</code>插入到代码运行之前（上文），将<code>__exit__</code>插入到代码运行之后（下文），但无法操控中间的代码（比如让它运行多几次）。</p>
<p>所以，基于上下文管理器的一行实现重试的写法宣告失败。</p>
<h2 id="_4">挣扎一下</h2>
<p>不过，好消息是，上下文管理器虽然不能实现循环，但它的<code>__exit__</code>方法能处理异常，所以它至少能代替“try ... except ...”来处理异常，于是我们可以写出：</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">random</span><span class="w"> </span><span class="kn">import</span> <span class="n">random</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Retry</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;自定义处理异常的上下文管理器</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allright</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="bp">self</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">exc_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">allright</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">exc_val</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>  <span class="c1"># 最多重试5次</span>
    <span class="k">with</span> <span class="n">Retry</span><span class="p">()</span> <span class="k">as</span> <span class="n">retry</span><span class="p">:</span>
        <span class="c1"># 有概率出错的代码</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">random</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>
            <span class="n">yyyy</span>  <span class="c1"># 未定义yyyy，所以会报错</span>
        <span class="k">break</span>

<span class="k">if</span> <span class="n">retry</span><span class="o">.</span><span class="n">allright</span><span class="p">:</span>
    <span class="c1"># 执行某些操作</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;执行成功&#39;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="c1"># 执行另一些操作</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;执行失败&#39;</span><span class="p">)</span>
</code></pre></div>

<p>最新的这个版本，其实写法上已经非常接近前一节的理想写法了，不同点有两个：1、需要多写一句<code>for</code>循环，但这个无法避免，因为前面已经说了上下文管理器是无法启动循环的，所以只能自己额外用<code>for</code>或者<code>while</code>启动循环；2、需要自己显式加一句<code>break</code>，这个倒是可以想办法优化掉。</p>
<p>此外，这个版本还有一个小缺陷，就是假如所有重试都失败了，那么最后一次重试失败之后，依然会启动sleep，这理论上是没有必要的，应当想办法去掉。</p>
<h2 id="_5">继续优化</h2>
<p>为了优化掉<code>break</code>，那么模型的循环应该要学会自己停止，这有两个办法：第一个办法是可以改用<code>while</code>循环，然后让停止条件根据重试结果改变，这将会导致跟<a href="https://stackoverflow.com/a/35483446">《Handling exceptions inside context managers》</a>相近的结果；第二个办法则是保持<code>for</code>循环，但<code>range(5)</code>这个要换成根据重试结果变化的迭代器。本文主要探讨后一种方案。</p>
<p>经过分析，笔者发现可以通过内置方法<code>__call__</code>和<code>__iter__</code>将<code>retry</code>同时作为一个可变的迭代器，并解决最后一次失败后的非必要sleep问题：</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">random</span><span class="w"> </span><span class="kn">import</span> <span class="n">random</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Retry</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;处理异常的上下文管理器 + 迭代器</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_tries</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_tries</span> <span class="o">=</span> <span class="n">max_tries</span>
        <span class="k">return</span> <span class="bp">self</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_tries</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">i</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">allright</span> <span class="ow">or</span> <span class="n">i</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_tries</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allright</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">exc_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">allright</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">exc_val</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>

<span class="n">retry</span> <span class="o">=</span> <span class="n">Retry</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">retry</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>  <span class="c1"># 最多重试5次</span>
    <span class="k">with</span> <span class="n">retry</span><span class="p">:</span>
        <span class="c1"># 有概率出错的代码</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">random</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>
            <span class="n">yyyy</span>  <span class="c1"># 未定义yyyy，所以会报错</span>

<span class="k">if</span> <span class="n">retry</span><span class="o">.</span><span class="n">allright</span><span class="p">:</span>
    <span class="c1"># 执行某些操作</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;执行成功&#39;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="c1"># 执行另一些操作</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;执行失败&#39;</span><span class="p">)</span>
</code></pre></div>

<p>仔细对比的读者可能会疑问：你想办法删了一句<code>break</code>，但多了一句<code>retry = Retry()</code>，总的代码数不变（还把上下文管理器搞复杂了），有这个必要折腾吗？事实上这里的<code>retry</code>是可重用的，用户只需要一次定义<code>retry = Retry()</code>，那么在后面的重试中都只需要：</p>
<div class="codehilite"><pre><span></span><code>for i in retry(max_tries):
    with retry:
        # 有概率出错的代码
</code></pre></div>

<p>就行了，因此虽然把上下文的管理器搞复杂了一点，但却已经是无限接近理想写法的实现了。</p>
<h2 id="_6">终极版本</h2>
<p>不过，“一次定义<code>retry = Retry()</code>，多次重用<code>retry</code>”只适合于单进程，如果是多进程还是要分别定义<code>retry = Retry()</code>的，另外就是这样重用总给人“不同的重试之间似乎没有完全隔离”的感觉。有没有可能将这一句完全去掉呢？笔者再想一下，发现还是有可能的！参考代码如下：</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">random</span><span class="w"> </span><span class="kn">import</span> <span class="n">random</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Retry</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;处理异常的上下文管理器 + 迭代器</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_tries</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_tries</span> <span class="o">=</span> <span class="n">max_tries</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_tries</span><span class="p">):</span>
            <span class="k">yield</span> <span class="bp">self</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">allright</span> <span class="ow">or</span> <span class="n">i</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_tries</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allright</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">exc_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">allright</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">exc_val</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>

<span class="k">for</span> <span class="n">retry</span> <span class="ow">in</span> <span class="n">Retry</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>  <span class="c1"># 最多重试5次</span>
    <span class="k">with</span> <span class="n">retry</span><span class="p">:</span>
        <span class="c1"># 有概率出错的代码</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">random</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>
            <span class="n">yyyy</span>  <span class="c1"># 未定义yyyy，所以会报错</span>

<span class="k">if</span> <span class="n">retry</span><span class="o">.</span><span class="n">allright</span><span class="p">:</span>
    <span class="c1"># 执行某些操作</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;执行成功&#39;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="c1"># 执行另一些操作</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;执行失败&#39;</span><span class="p">)</span>
</code></pre></div>

<p>这次的改动是将<code>__call__</code>换为<code>__init__</code>，然后<code>__iter__</code>中的<code>yield i</code>改为了<code>yield self</code>，即返回对象本身。这样一来，就不用单独写一行<code>retry = Retry(5)</code>来初始化，而是在<code>for retry in Retry(5):</code>中同时实现了初始化和别名赋值，并且由于每次重试都会重新初始化，因此实现了重试之间的完全隔离，可谓一举两得了。</p>
<h2 id="_7">文章小结</h2>
<p>本文相对完整地探讨了Python中重试机制的写法，试图得到笔者心目中重试代码的完美实现，最后的结果也勉强达到了心中所想。</p>
<p>不过，不得不承认的是，这篇文章的起因实质只是“强迫症”在作祟，并没有算法效率的实质改进，在编程细节上花太多时间，某种程度上已经是“旁门左道”、“不务正业”了，并不是一件十分值得学习的事情。</p>
<p><em><strong>转载到请包括本文地址：</strong><a href="https://spaces.ac.cn/archives/9938">https://spaces.ac.cn/archives/9938</a></em></p>
<p><em><strong>更详细的转载事宜请参考：</strong></em><a href="https://spaces.ac.cn/archives/6508#%E6%96%87%E7%AB%A0%E5%A6%82%E4%BD%95%E8%BD%AC%E8%BD%BD/%E5%BC%95%E7%94%A8" title="《科学空间FAQ》">《科学空间FAQ》</a></p>
<p><strong>如果您还有什么疑惑或建议，欢迎在下方评论区继续讨论。</strong></p>
<p><strong>如果您觉得本文还不错，欢迎分享/打赏本文。打赏并非要从中获得收益，而是希望知道科学空间获得了多少读者的真心关注。当然，如果你无视它，也不会影响你的阅读。再次表示欢迎和感谢！</strong></p>
<p>打赏</p>
<p><img alt="科学空间" src="https://spaces.ac.cn/usr/themes/geekg/payment/wx.png" /></p>
<p>微信打赏</p>
<p><img alt="科学空间" src="https://spaces.ac.cn/usr/themes/geekg/payment/zfb.png" /></p>
<p>支付宝打赏</p>
<p>因为网站后台对打赏并无记录，因此欢迎在打赏时候备注留言。你还可以<a href="http://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&amp;email=tN7d1drY3drrx8H0xcWa19vZ"><strong>点击这里</strong></a>或在下方评论区留言来告知你的建议或需求。</p>
<p><strong>如果您需要引用本文，请参考：</strong></p>
<p>苏剑林. (Jan. 14, 2024). 《旁门左道之如何让Python的重试代码更加优雅 》[Blog post]. Retrieved from <a href="https://spaces.ac.cn/archives/9938">https://spaces.ac.cn/archives/9938</a></p>
<p>@online{kexuefm-9938,<br />
title={旁门左道之如何让Python的重试代码更加优雅},<br />
author={苏剑林},<br />
year={2024},<br />
month={Jan},<br />
url={\url{https://spaces.ac.cn/archives/9938}},<br />
} </p>
<hr />
<h2 id="_8">公式推导与注释</h2>
<p>TODO: 添加详细的数学公式推导和注释</p>
        </div>

        <!-- Back to Home -->
        <div class="text-center mt-5 mb-4">
            <a href="../index.html" class="btn btn-outline-primary">
                <i class="fas fa-arrow-left"></i> 返回首页
            </a>
        </div>
    </article>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p>
                博客来源: <a href="https://spaces.ac.cn" target="_blank">科学空间</a> |
                内容经过整理并添加详细数学推导
            </p>
            <p>
                Powered by <a href="https://pages.github.com/" target="_blank">GitHub Pages</a>
            </p>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Syntax highlighting -->
    <script>hljs.highlightAll();</script>
</body>
</html>
