<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>机器学习与数学博客精选 | ML & Math Blog Posts</title>
    <meta name="description" content="精选机器学习与数学相关博客文章，包含详细的公式推导与注释">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css">

    <!-- Google Fonts -->
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="assets/css/main.css">

    <!-- MathJax for math rendering -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <h1><i class="fas fa-brain"></i> 机器学习与数学博客精选</h1>
        <p>ML & Math Blog Posts with Detailed Derivations</p>
    </div>

    <!-- Main Content -->
    <div class="container">
        <!-- Search Box -->
        <div class="search-container">
            <input type="text"
                   id="searchBox"
                   class="search-box"
                   placeholder="搜索博客标题、标签或内容... (Search by title, tags, or content)"
                   autocomplete="off">
        </div>

        <!-- Tag Filters -->
        <div id="tagFilters" class="tag-filters-container">
            <!-- Tag filter buttons will be dynamically loaded here -->
        </div>

        <!-- Search Stats -->
        <div id="searchStats" class="search-stats">
            <!-- Search statistics will be shown here -->
        </div>

        <!-- Blog List -->
        <ul id="blogList" class="blog-list">
            <!-- Blog items will be dynamically loaded here -->
        </ul>

        <!-- Pagination -->
        <nav id="paginationNav" aria-label="Blog pagination" style="display: none;">
            <ul class="pagination justify-content-center" id="paginationList">
                <!-- Pagination buttons will be dynamically loaded here -->
            </ul>
        </nav>

        <!-- No Results Message -->
        <div id="noResults" class="no-results">
            <i class="fas fa-search fa-3x" style="opacity: 0.3; margin-bottom: 20px;"></i>
            <p>未找到匹配的博客文章</p>
            <p>No matching blog posts found</p>
        </div>

        <!-- Loading Message -->
        <div id="loading" class="text-center" style="padding: 40px;">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3">加载博客列表中...</p>
        </div>
    </div>

    <!-- Footer -->
    <div class="footer">
        <p>
            博客来源: <a href="https://spaces.ac.cn" target="_blank">科学空间</a> |
            内容经过整理并添加详细数学推导
        </p>
        <p>
            Powered by <a href="https://pages.github.com/" target="_blank">GitHub Pages</a>
        </p>
    </div>

    <!-- JavaScript -->
    <script>
        // Blog data and state
        let allBlogs = [];
        let filteredBlogs = [];
        let currentPage = 1;
        let selectedTags = new Set();
        let tagsExpanded = false;  // Track whether tags are expanded
        const ITEMS_PER_PAGE = 20;
        const INITIAL_TAGS_SHOWN = 15;  // Number of tags to show initially

        // URL parameter management
        function getURLParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                page: parseInt(params.get('page')) || 1,
                search: params.get('search') || '',
                tags: params.get('tags') ? params.get('tags').split(',') : []
            };
        }

        function updateURL() {
            const params = new URLSearchParams();
            if (currentPage > 1) params.set('page', currentPage);
            const searchTerm = document.getElementById('searchBox').value.trim();
            if (searchTerm) params.set('search', searchTerm);
            if (selectedTags.size > 0) params.set('tags', Array.from(selectedTags).join(','));

            const newURL = params.toString() ? `?${params.toString()}` : window.location.pathname;
            window.history.pushState({}, '', newURL);
        }

        // Load blog list data
        async function loadBlogs() {
            try {
                const response = await fetch('data/blog_list.json');
                if (!response.ok) {
                    throw new Error('Failed to load blog list');
                }
                allBlogs = await response.json();

                // Initialize from URL parameters
                const urlParams = getURLParams();
                if (urlParams.search) {
                    document.getElementById('searchBox').value = urlParams.search;
                }
                if (urlParams.tags.length > 0) {
                    selectedTags = new Set(urlParams.tags);
                }
                currentPage = urlParams.page;

                // Generate tag filters
                generateTagFilters();

                // Apply filters and render
                applyFilters();

                document.getElementById('loading').style.display = 'none';
            } catch (error) {
                console.error('Error loading blogs:', error);
                document.getElementById('loading').innerHTML =
                    '<p class="text-danger">加载失败，请稍后重试 / Failed to load, please try again later</p>';
            }
        }

        // Extract all unique tags from blogs
        function getAllTags() {
            const tagCounts = {};
            allBlogs.forEach(blog => {
                if (blog.tags && Array.isArray(blog.tags)) {
                    blog.tags.forEach(tag => {
                        tagCounts[tag] = (tagCounts[tag] || 0) + 1;
                    });
                }
            });
            // Sort by count (descending)
            return Object.entries(tagCounts)
                .sort((a, b) => b[1] - a[1])
                .map(([tag, count]) => ({ tag, count }));
        }

        // Toggle tags expanded/collapsed
        function toggleTagsExpanded() {
            tagsExpanded = !tagsExpanded;
            generateTagFilters();
        }

        // Generate tag filter buttons
        function generateTagFilters() {
            const tagFiltersContainer = document.getElementById('tagFilters');
            const allTags = getAllTags();

            if (allTags.length === 0) {
                tagFiltersContainer.style.display = 'none';
                return;
            }

            // Determine which tags to show
            const tagsToShow = tagsExpanded ? allTags : allTags.slice(0, INITIAL_TAGS_SHOWN);
            const hasMoreTags = allTags.length > INITIAL_TAGS_SHOWN;

            const buttonsHTML = `
                <div class="tag-filters-header">
                    <span><i class="fas fa-filter"></i> 按标签筛选：</span>
                    ${selectedTags.size > 0 ?
                        '<button class="btn-clear-filters" onclick="clearAllFilters()"><i class="fas fa-times"></i> 清除筛选</button>' :
                        ''}
                </div>
                <div class="tag-buttons">
                    ${tagsToShow.map(({ tag, count }) => `
                        <button class="tag-filter-btn ${selectedTags.has(tag) ? 'active' : ''}"
                                onclick="toggleTagFilter('${tag.replace(/'/g, "\\'")}')">
                            ${tag} <span class="tag-count">(${count})</span>
                        </button>
                    `).join('')}
                </div>
                ${hasMoreTags ? `
                    <div class="tag-toggle-container">
                        <button class="btn-toggle-tags" onclick="toggleTagsExpanded()">
                            <i class="fas fa-chevron-${tagsExpanded ? 'up' : 'down'}"></i>
                            ${tagsExpanded ? '收起标签' : `展开更多 (${allTags.length - INITIAL_TAGS_SHOWN} 个)`}
                        </button>
                    </div>
                ` : ''}
            `;

            tagFiltersContainer.innerHTML = buttonsHTML;
            tagFiltersContainer.style.display = 'block';
        }

        // Toggle tag filter
        function toggleTagFilter(tag) {
            if (selectedTags.has(tag)) {
                selectedTags.delete(tag);
            } else {
                selectedTags.add(tag);
            }
            currentPage = 1; // Reset to first page
            generateTagFilters(); // Update buttons
            applyFilters();
            updateURL();
        }

        // Clear all filters
        function clearAllFilters() {
            selectedTags.clear();
            document.getElementById('searchBox').value = '';
            currentPage = 1;
            generateTagFilters();
            applyFilters();
            updateURL();
        }

        // Apply all filters (search + tags)
        function applyFilters() {
            const searchTerm = document.getElementById('searchBox').value.toLowerCase().trim();

            filteredBlogs = allBlogs.filter(blog => {
                // Search filter
                let searchMatch = true;
                if (searchTerm) {
                    const titleMatch = blog.title.toLowerCase().includes(searchTerm);
                    const descMatch = blog.description && blog.description.toLowerCase().includes(searchTerm);
                    const tagMatch = blog.tags && blog.tags.some(tag =>
                        tag.toLowerCase().includes(searchTerm)
                    );
                    searchMatch = titleMatch || descMatch || tagMatch;
                }

                // Tag filter
                let tagMatch = true;
                if (selectedTags.size > 0) {
                    tagMatch = blog.tags && blog.tags.some(tag => selectedTags.has(tag));
                }

                return searchMatch && tagMatch;
            });

            renderBlogs();
        }

        // Render blog list with pagination
        function renderBlogs() {
            const blogList = document.getElementById('blogList');
            const noResults = document.getElementById('noResults');
            const paginationNav = document.getElementById('paginationNav');

            // Update search stats
            updateSearchStats();

            if (filteredBlogs.length === 0) {
                blogList.innerHTML = '';
                noResults.style.display = 'block';
                paginationNav.style.display = 'none';
                return;
            }

            noResults.style.display = 'none';

            // Calculate pagination
            const totalPages = Math.ceil(filteredBlogs.length / ITEMS_PER_PAGE);
            const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
            const endIndex = Math.min(startIndex + ITEMS_PER_PAGE, filteredBlogs.length);
            const blogsToShow = filteredBlogs.slice(startIndex, endIndex);

            // Render blogs
            blogList.innerHTML = blogsToShow.map(blog => `
                <li class="blog-item">
                    <h3>
                        <a href="posts/${blog.slug}.html">${blog.title}</a>
                    </h3>
                    <div class="blog-meta">
                        <i class="far fa-calendar"></i> ${blog.date || '待定'}
                        ${blog.status === 'completed' ?
                            '<span class="badge bg-success ms-2">已完成</span>' :
                            '<span class="badge bg-warning text-dark ms-2">进行中</span>'}
                    </div>
                    <p class="blog-description">${blog.description || '详细的数学推导与注释...'}</p>
                    ${blog.tags && blog.tags.length > 0 ? `
                        <div class="blog-tags">
                            ${blog.tags.map(tag => `
                                <span class="tag clickable-tag" onclick="filterByTag('${tag.replace(/'/g, "\\'")}')">
                                    <i class="fas fa-tag"></i> ${tag}
                                </span>
                            `).join('')}
                        </div>
                    ` : ''}
                </li>
            `).join('');

            // Render pagination
            renderPagination(totalPages);
        }

        // Render pagination controls
        function renderPagination(totalPages) {
            const paginationNav = document.getElementById('paginationNav');
            const paginationList = document.getElementById('paginationList');

            if (totalPages <= 1) {
                paginationNav.style.display = 'none';
                return;
            }

            paginationNav.style.display = 'block';

            let paginationHTML = '';

            // Previous button
            paginationHTML += `
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="goToPage(${currentPage - 1}); return false;">
                        <i class="fas fa-chevron-left"></i> 上一页
                    </a>
                </li>
            `;

            // Page numbers
            const maxVisiblePages = 7;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

            if (endPage - startPage < maxVisiblePages - 1) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }

            if (startPage > 1) {
                paginationHTML += `
                    <li class="page-item">
                        <a class="page-link" href="#" onclick="goToPage(1); return false;">1</a>
                    </li>
                `;
                if (startPage > 2) {
                    paginationHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                paginationHTML += `
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="goToPage(${i}); return false;">${i}</a>
                    </li>
                `;
            }

            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    paginationHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                }
                paginationHTML += `
                    <li class="page-item">
                        <a class="page-link" href="#" onclick="goToPage(${totalPages}); return false;">${totalPages}</a>
                    </li>
                `;
            }

            // Next button
            paginationHTML += `
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="goToPage(${currentPage + 1}); return false;">
                        下一页 <i class="fas fa-chevron-right"></i>
                    </a>
                </li>
            `;

            paginationList.innerHTML = paginationHTML;
        }

        // Go to specific page
        function goToPage(page) {
            const totalPages = Math.ceil(filteredBlogs.length / ITEMS_PER_PAGE);
            if (page < 1 || page > totalPages) return;

            currentPage = page;
            renderBlogs();
            updateURL();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Update search statistics
        function updateSearchStats() {
            const statsDiv = document.getElementById('searchStats');
            const totalPages = Math.ceil(filteredBlogs.length / ITEMS_PER_PAGE);

            if (filteredBlogs.length === allBlogs.length && selectedTags.size === 0 && !document.getElementById('searchBox').value.trim()) {
                statsDiv.innerHTML = `
                    <div class="stats-content">
                        <i class="fas fa-book"></i> 共 <strong>${allBlogs.length}</strong> 篇文章
                        ${totalPages > 1 ? `，分为 <strong>${totalPages}</strong> 页` : ''}
                    </div>
                `;
            } else {
                statsDiv.innerHTML = `
                    <div class="stats-content">
                        <i class="fas fa-search"></i> 找到 <strong>${filteredBlogs.length}</strong> 篇文章
                        ${totalPages > 1 ? `，分为 <strong>${totalPages}</strong> 页` : ''}
                        ${selectedTags.size > 0 ? ` | <i class="fas fa-filter"></i> ${selectedTags.size} 个标签筛选` : ''}
                    </div>
                `;
            }
        }

        // Filter by clicking tag in blog item
        function filterByTag(tag) {
            if (!selectedTags.has(tag)) {
                selectedTags.add(tag);
                currentPage = 1;
                generateTagFilters();
                applyFilters();
                updateURL();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        // Event listeners
        document.getElementById('searchBox').addEventListener('input', (e) => {
            currentPage = 1;
            applyFilters();
            updateURL();
        });

        // Handle browser back/forward
        window.addEventListener('popstate', () => {
            const urlParams = getURLParams();
            document.getElementById('searchBox').value = urlParams.search;
            selectedTags = new Set(urlParams.tags);
            currentPage = urlParams.page;
            generateTagFilters();
            applyFilters();
        });

        // Initialize
        loadBlogs();
    </script>
</body>
</html>
