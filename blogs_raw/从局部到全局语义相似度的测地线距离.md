---
title: 从局部到全局：语义相似度的测地线距离
slug: 从局部到全局语义相似度的测地线距离
date: 2022-12-07
tags: 黎曼几何, 语义, 语义相似度, 生成模型, attention, 测地线距离, 流形学习, k-NN图, Dijkstra算法
status: completed
tags_reviewed: true
---

# 从局部到全局：语义相似度的测地线距离

**原文链接**: [https://spaces.ac.cn/archives/9368](https://spaces.ac.cn/archives/9368)

**发布日期**: 

---

前段时间在最近的一篇论文[《Unsupervised Opinion Summarization Using Approximate Geodesics》](https://papers.cool/arxiv/2209.07496)中学到了一个新的概念，叫做“测地线距离（Geodesic Distance）”，感觉有点意思，特来跟大家分享一下。

对笔者来说，“新”的不是测地线距离概念本身（以前学黎曼几何的时候就已经接触过了），而是语义相似度领域原来也可以巧妙地构造出测地线距离出来，并在某些场景下发挥作用。如果乐意，我们还可以说这是“流形上的语义相似度”，是不是瞬间就高级了不少？

## 论文梗概 #

首先，我们简单总结一下原论文的主要内容。顾名思义，论文的主题是摘要，通常我们的无监督摘要是这样做的：假设文章由$n$个句子$t_1,t_2,\cdots,t_n$组成，给每个句子设计打分函数$s(t_i)$（经典的是tf-idf及其变体），然后挑出打分最大的若干个句子作为摘要。当然，论文做的不是简单的摘要，而是“Opinion Summarization”，这个“Opinion”，我们可以理解为实现给定的主题或者中心$c$，摘要应该倾向于抽取出与$c$相关的句子，所以打分函数应该还应该跟$c$有关，即$s(t_i, c)$。

自从“万物皆Embedding”后，$s(t_i,c)$的一种主流设计方式就是将句子$t_i$和主题$c$都编码为相应的句向量$\boldsymbol{v}(t_i),\boldsymbol{v}(c)$，然后用某种距离的倒数作为打分函数：  
\begin{equation}s(t_i, c) = \frac{1}{d(\boldsymbol{v}(t_i), \boldsymbol{v}(c))}\end{equation}  
在这种设计中，句向量的编码模型$\boldsymbol{v}(\cdot)$和距离函数$d(\cdot,\cdot)$都是可设计的空间。原论文在$\boldsymbol{v}(\cdot)$和$d(\cdot,\cdot)$上都做了一些工作，其中$\boldsymbol{v}(\cdot)$不是本文关心的内容，暂且略过，有兴趣的读者自行看原论文。至于论文在$d(\cdot,\cdot)$上的贡献，就是将常见的简单距离，换成了本文的主题“测地线距离”。

## 原理分析 #

为什么要用到测地线距离？这要从我们训练句向量的方案说起。

学习句向量的方式既可以是有监督的，也可以是无监督的。以有监督为例，一般就是正样本对和负样本对做对比学习（参考[《CoSENT（一）：比Sentence-BERT更有效的句向量方案》](/archives/8847)），正样本对就是标记出两个语义基本相同的句子，我们可以认为它们相似度很高，或者距离很小。问题出在负样本对，作为两个语义不相同的句子，它们可能是特意标记出来的困难样本，也可能是随机挑出来的两个不相关样本，原则上这两种情况应当赋予不同的距离，但实际都只是标记了同一个标签，即“负”。

这就导致了一个结果，我们用句向量算出来的距离数值，理论上是对语义比较相近的句子才比较准确，对于语义差距比较大的句子，距离数值只能够用来区分出正负样本，但不能在邻近范围内做比较。举个例子，我们可以说距离为$1$的比距离为$2$的更相似，也可以说距离为$1$的比距离为$10$的更相似，但没法说距离为$10$的比距离为$11$的更相似，因为距离大了，其绝对数值就不准了。

检索场景下，通常要召回相似度很高（也就是距离很小）的样本，因此直接用简单的距离函数$d(\cdot,\cdot)$去检索就行。但是，对于原论文的“Opinion Summarization”场景，要计算的是句子$t_i$与主题$c$的距离$d(\boldsymbol{v}(t_i), \boldsymbol{v}(c))$，“句子”与“主题”的相似度就未必很大了（距离偏大），也就是说，它是要在距离相似度偏大的区间做相对比较，这就适合用到测地线距离了。

## 测地距离 #

测地线距离，简单来说就是两点之间的最短距离，由于流形未必是平直的，因此该距离未必是两点之间的直线距离（欧式距离），经典例子就是从地球的南极走到北极，我们没法穿过地心走直线，只能沿着地球表面先走到赤道然后再走到南极，走了一条曲线（半圆）距离。

在局部范围内（此时距离比较小），地球还是平的，所以欧式距离还是可用的，但是放到“南极-北极”、“南极-赤道”这样的大距离就不够准确了，这就跟刚才的语义相似度场景很相似了——已知的距离（比如欧式距离）在近距离内比较准确，在远距离不准确，本质上就是因为流形不是平直的。

幸运的是，有局部距离就够了，我们将其转化为一个图的问题，可以利用“最短路径”的算法估算出近似的测地线距离。具体来说，我们可以用现有的距离函数算出每个点与剩余点的距离，然后只保留距离最近的$k$个点（也可以按阈值截断，看具体情况），在它们之间连一条边并标记上距离，这样一来所有点和边构成了一个加权图（我们称之为“$k$邻近图”），我们就可以用Dijkstra算法来搜索出图上任意两点的最短路径，并计算出它的长度，这就是测地线距离的近似结果。

总的来说，在“相近点的距离比较准、较远点的距离比较不准”的假设下，我们可以$k$邻近图加最短路径的方法，估算较远点的测地线距离来作为替代品。由于测地线距离考虑了向量空间的流形状况，所以 _**有可能**_ 取得比较好的效果。（参考原论文的Table 8）

## 文章小结 #

本文分享了一个“测地线距离”的概念，指出我们平时训练出来的相似度可能只适合于局部，在较远距离下换为测地线距离可能会在某些语义相似度问题上有帮助。

_**转载到请包括本文地址：**<https://spaces.ac.cn/archives/9368>_

_**更详细的转载事宜请参考：**_[《科学空间FAQ》](https://spaces.ac.cn/archives/6508#%E6%96%87%E7%AB%A0%E5%A6%82%E4%BD%95%E8%BD%AC%E8%BD%BD/%E5%BC%95%E7%94%A8 "《科学空间FAQ》")

**如果您还有什么疑惑或建议，欢迎在下方评论区继续讨论。**

**如果您觉得本文还不错，欢迎分享/打赏本文。打赏并非要从中获得收益，而是希望知道科学空间获得了多少读者的真心关注。当然，如果你无视它，也不会影响你的阅读。再次表示欢迎和感谢！**

打赏

![科学空间](https://spaces.ac.cn/usr/themes/geekg/payment/wx.png)

微信打赏

![科学空间](https://spaces.ac.cn/usr/themes/geekg/payment/zfb.png)

支付宝打赏

因为网站后台对打赏并无记录，因此欢迎在打赏时候备注留言。你还可以[**点击这里**](http://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&email=tN7d1drY3drrx8H0xcWa19vZ)或在下方评论区留言来告知你的建议或需求。

**如果您需要引用本文，请参考：**

苏剑林. (Dec. 07, 2022). 《从局部到全局：语义相似度的测地线距离 》[Blog post]. Retrieved from <https://spaces.ac.cn/archives/9368>

@online{kexuefm-9368,  
title={从局部到全局：语义相似度的测地线距离},  
author={苏剑林},  
year={2022},  
month={Dec},  
url={\url{https://spaces.ac.cn/archives/9368}},  
} 


---

## 公式推导与注释

### 第1部分：核心理论、公理与历史基础

#### 1.1 理论起源与历史发展

**测地线距离的理论根源**可追溯到多个数学分支的交叉：

<div class="theorem-box">

**多学科融合**：
- **微分几何** (19世纪)：黎曼（Riemann）建立非欧几何，引入黎曼流形和测地线概念
- **度量空间理论** (1914, Hausdorff)：形式化距离函数的公理化定义
- **流形学习** (2000, Tenenbaum等)：Isomap算法首次将测地线距离用于高维数据降维
- **图论与最短路径** (1956, Dijkstra)：提供计算测地线距离的高效算法
- **自然语言处理** (2022)：将测地线距离引入语义相似度计算

</div>

**关键里程碑**：

1. **1854 - 黎曼（Riemann）**：在就职演讲中提出黎曼几何，定义流形上的度量和测地线
2. **1956 - Dijkstra**：提出最短路径算法，为图上测地线距离计算奠定基础
3. **2000 - Isomap (Tenenbaum等)**：首次在机器学习中系统使用测地线距离进行流形学习
4. **2013 - Word2Vec (Mikolov等)**：词向量空间的流形结构引起关注
5. **2019 - Sentence-BERT (Reimers等)**：句向量模型的普及
6. **2022 - Opinion Summarization (论文)**：测地线距离用于语义相似度计算

#### 1.2 数学公理与基础假设

<div class="theorem-box">

### 公理1：度量空间的完备性

语义向量空间$(\mathcal{V}, d_E)$是一个度量空间，满足：
1. **非负性**：$d_E(\boldsymbol{u}, \boldsymbol{v}) \geq 0$，等号成立当且仅当$\boldsymbol{u} = \boldsymbol{v}$
2. **对称性**：$d_E(\boldsymbol{u}, \boldsymbol{v}) = d_E(\boldsymbol{v}, \boldsymbol{u})$
3. **三角不等式**：$d_E(\boldsymbol{u}, \boldsymbol{w}) \leq d_E(\boldsymbol{u}, \boldsymbol{v}) + d_E(\boldsymbol{v}, \boldsymbol{w})$

</div>

<div class="theorem-box">

### 公理2：流形假设（Manifold Hypothesis）

高维语义向量实际上分布在一个低维流形$\mathcal{M} \subset \mathbb{R}^d$上：

$$\dim(\mathcal{M}) \ll d$$

**直观理解**：虽然句向量在$\mathbb{R}^{768}$（如BERT），但有意义的句子只占据其中很小的子空间。

</div>

<div class="theorem-box">

### 公理3：局部欧氏性

在流形$\mathcal{M}$的任意点$p$的充分小邻域$U_\epsilon(p)$内，欧氏距离与测地线距离等价：

$$\lim_{\|\boldsymbol{v} - \boldsymbol{u}\| \to 0} \frac{d_{\text{geo}}(\boldsymbol{u}, \boldsymbol{v})}{d_E(\boldsymbol{u}, \boldsymbol{v})} = 1$$

**意义**：局部欧氏距离可以作为测地线距离的可靠近似。

</div>

#### 1.3 设计哲学

测地线距离在语义空间的设计哲学体现为**"尊重内在结构"**与**"从局部到全局"**的结合：

**尊重内在结构（Intrinsic Geometry）**：
- 不依赖于向量的外部坐标表示
- 只关心流形内在的"最短路径"
- 类比：地球上的距离应沿球面测量，而非穿过地心

**从局部到全局（Local to Global）**：
- 利用局部欧氏距离的准确性
- 通过拼接局部路径估算全局距离
- 类比：通过多次短途旅行规划长途路线

**与欧氏距离的本质区别**：

| 维度 | 欧氏距离 | 测地线距离 |
|------|---------|-----------|
| 几何意义 | 外部嵌入空间的直线距离 | 流形内在的最短曲线长度 |
| 适用范围 | 平直空间 | 任意黎曼流形 |
| 计算复杂度 | $O(d)$ | $O(kn + n\log n)$（k-NN图） |
| 语义解释 | 直接对比 | 经由语义桥梁 |
| 长距离准确性 | 低（穿越低密度区域） | 高（沿高密度路径） |

---

## 黎曼几何基础 {#riemannian-geometry-basics}

### 流形与度量张量

<div class="theorem-box">

**定义1：黎曼流形**

一个$n$维黎曼流形$(\mathcal{M}, g)$是一个光滑流形$\mathcal{M}$，配备有黎曼度量$g$，即在每个切空间$T_p\mathcal{M}$上的正定对称双线性形式：

$$g_p: T_p\mathcal{M} \times T_p\mathcal{M} \to \mathbb{R}$$

对于切向量$\boldsymbol{u}, \boldsymbol{v} \in T_p\mathcal{M}$，$g_p(\boldsymbol{u}, \boldsymbol{v})$定义了它们的内积。

</div>

在局部坐标$(x^1, \ldots, x^n)$下，度量张量可以表示为：
$$g = \sum_{i,j=1}^n g_{ij}(x) \, dx^i \otimes dx^j$$

其中$g_{ij}(x) = g\left(\frac{\partial}{\partial x^i}, \frac{\partial}{\partial x^j}\right)$是度量张量的分量。

**语义空间中的流形结构**：

在句向量空间中，我们可以将所有$d$维句向量$\boldsymbol{v} \in \mathbb{R}^d$视为嵌入在欧氏空间中的一个流形$\mathcal{M}$。虽然外部空间是平直的欧氏空间$\mathbb{R}^d$，但**由于训练数据的分布和模型的非线性**，句向量实际上构成了一个具有内在几何结构的子流形。

---

### 测地线的变分定义

<div class="derivation-box">

**定义2：测地线（Geodesic）**

测地线是流形上两点之间的"局部最短曲线"。形式化地，从点$p$到点$q$的测地线$\gamma: [0,1] \to \mathcal{M}$满足：

$$\gamma(0) = p, \quad \gamma(1) = q$$

且使得能量泛函达到临界点：
$$E[\gamma] = \int_0^1 g_{\gamma(t)}(\dot{\gamma}(t), \dot{\gamma}(t)) \, dt$$

其中$\dot{\gamma}(t) = \frac{d\gamma}{dt}$是切向量。

</div>

**欧拉-拉格朗日方程**：

测地线满足的微分方程（测地线方程）为：
$$\frac{d^2 \gamma^k}{dt^2} + \sum_{i,j} \Gamma^k_{ij} \frac{d\gamma^i}{dt} \frac{d\gamma^j}{dt} = 0, \quad k=1,\ldots,n$$

其中$\Gamma^k_{ij}$是Christoffel符号：
$$\Gamma^k_{ij} = \frac{1}{2} \sum_m g^{km} \left( \frac{\partial g_{jm}}{\partial x^i} + \frac{\partial g_{im}}{\partial x^j} - \frac{\partial g_{ij}}{\partial x^m} \right)$$

**直观理解**：测地线是"尽可能直"的曲线，在平直空间中就是直线，在球面上就是大圆（如经线）。

---

### 测地线距离的定义

<div class="theorem-box">

**定义3：测地线距离（Geodesic Distance）**

两点$p, q \in \mathcal{M}$之间的测地线距离$d_{\text{geo}}(p, q)$定义为连接它们的所有曲线的长度的下确界：

$$d_{\text{geo}}(p, q) = \inf_{\gamma} L[\gamma]$$

其中$\gamma$是从$p$到$q$的任意曲线，$L[\gamma]$是曲线长度：
$$L[\gamma] = \int_0^1 \sqrt{g_{\gamma(t)}(\dot{\gamma}(t), \dot{\gamma}(t))} \, dt$$

</div>

**性质**：
1. **非负性**：$d_{\text{geo}}(p, q) \geq 0$，等号成立当且仅当$p = q$
2. **对称性**：$d_{\text{geo}}(p, q) = d_{\text{geo}}(q, p)$
3. **三角不等式**：$d_{\text{geo}}(p, r) \leq d_{\text{geo}}(p, q) + d_{\text{geo}}(q, r)$

因此，$(\\mathcal{M}, d_{\text{geo}})$构成一个度量空间。

---

## 欧氏距离 vs 测地线距离 {#euclidean-vs-geodesic}

### 平直空间中的等价性

<div class="comparison-box">

**命题1：平直空间中的等价性**

如果流形是平直的（即度量张量处处为$g_{ij} = \delta_{ij}$，Riemann曲率张量为零），则测地线距离等于欧氏距离：

$$d_{\text{geo}}(p, q) = d_{\text{Eucl}}(p, q) = \|\boldsymbol{p} - \boldsymbol{q}\|_2$$

</div>

**证明**：在平直空间中，测地线就是直线$\gamma(t) = (1-t)p + tq$，其长度为：
\begin{equation}\begin{aligned}
L[\gamma] &= \int_0^1 \|\dot{\gamma}(t)\|_2 \, dt \\
&= \int_0^1 \|q - p\|_2 \, dt \\
&= \|q - p\|_2
\end{aligned}\end{equation}

由于直线是两点之间最短的，$d_{\text{geo}} = d_{\text{Eucl}}$。

---

### 弯曲空间中的差异

在非平直流形上，欧氏距离（测量外部嵌入空间中的直线距离）与测地线距离（流形内在的最短路径）可能有显著差异。

<div class="example-box">

**例子：单位球面$S^2$**

考虑地球表面的两点：北极$N = (0,0,1)$和赤道上一点$E = (1,0,0)$。

**欧氏距离**（穿过地球内部的直线距离）：
$$d_{\text{Eucl}}(N, E) = \sqrt{(0-1)^2 + (0-0)^2 + (1-0)^2} = \sqrt{2}$$

**测地线距离**（沿球面的大圆弧长度）：
两点夹角$\theta$满足$\cos\theta = N \cdot E = 0$，故$\theta = \frac{\pi}{2}$。

测地线距离为球面上的弧长（半径为1）：
$$d_{\text{geo}}(N, E) = R \cdot \theta = 1 \cdot \frac{\pi}{2} \approx 1.571$$

**比率**：$\frac{d_{\text{geo}}}{d_{\text{Eucl}}} = \frac{\pi/2}{\sqrt{2}} \approx 1.11$

</div>

**一般关系**：

对于嵌入在$\mathbb{R}^d$中的子流形$\mathcal{M}$，总有：
$$d_{\text{geo}}(p, q) \geq d_{\text{Eucl}}(p, q)$$

等号成立当且仅当连接$p, q$的欧氏直线完全位于流形$\mathcal{M}$内（此时流形在$p, q$之间是平直的）。

---

### 语义空间中的曲率效应

**为什么句向量空间不是平直的？**

1. **训练目标的影响**：对比学习损失（如CoSENT）倾向于将语义相似的句子拉近，不相似的推远。这种非线性映射导致：
   - **正样本聚类**：相似句子形成高密度的"岛屿"
   - **负样本分离**：不相似句子之间存在"鸿沟"

2. **流形的内在曲率**：设想两个语义主题$A$和$B$，它们的句向量分别聚集在空间的两个区域。从$A$区域的一个点到$B$区域的一个点，欧氏直线可能穿过"低密度"或"无意义"的区域，但测地线会沿着"有意义"的语义路径，可能经由中间主题$C$。

<div class="derivation-box">

**数学建模**：局部vs全局距离的矛盾

假设句向量在训练数据分布$\rho(\boldsymbol{v})$下学习，度量张量可以建模为：
$$g_{ij}(\boldsymbol{v}) = \delta_{ij} \cdot w(\boldsymbol{v})$$

其中权重$w(\boldsymbol{v})$与局部数据密度相关：
$$w(\boldsymbol{v}) \propto \frac{1}{\rho(\boldsymbol{v})^\alpha}, \quad \alpha > 0$$

**直观解释**：在高密度区域（训练数据丰富），距离"收缩"，即相同的欧氏距离对应更小的测地线距离；在低密度区域（训练稀疏），距离"膨胀"。

弧长元素：
$$ds^2 = w(\boldsymbol{v}) \sum_i (dx^i)^2 = \frac{1}{\rho(\boldsymbol{v})^\alpha} d\boldsymbol{v}^2$$

从高密度区域$A$到另一个高密度区域$B$，如果直接路径经过低密度区域：
$$d_{\text{geo}}^{\text{direct}} = \int_{A \to B} \frac{1}{\rho(\boldsymbol{v})^\alpha} \|d\boldsymbol{v}\| \quad \text{(很大)}$$

但如果绕道经过中间高密度区域$C$：
$$d_{\text{geo}}^{\text{indirect}} = \int_{A \to C} \frac{1}{\rho(\boldsymbol{v})^\alpha} \|d\boldsymbol{v}\| + \int_{C \to B} \frac{1}{\rho(\boldsymbol{v})^\alpha} \|d\boldsymbol{v}\| \quad \text{(可能更小)}$$

这正是测地线距离与欧氏距离差异的来源！

</div>

---

## 从局部到全局：近似测地线距离 {#local-to-global}

### 问题的挑战

**直接计算测地线距离的困难**：

1. **未知的度量张量**：我们没有显式的$g_{ij}(\boldsymbol{v})$，只有句向量的欧氏坐标
2. **求解测地线方程**：即使有$g_{ij}$，求解二阶微分方程组也很困难
3. **计算复杂度**：对于$n$个点，计算所有点对的测地线距离需要$O(n^2)$次方程求解

**关键观察**：虽然全局测地线距离未知，但**局部欧氏距离是可靠的近似**！

<div class="theorem-box">

**定理1：局部等距性（Local Isometry）**

对于足够小的邻域$U \subset \mathcal{M}$（相对于流形的曲率半径），在$U$内的欧氏距离与测地线距离的相对误差为：

$$\left| \frac{d_{\text{Eucl}}(p, q) - d_{\text{geo}}(p, q)}{d_{\text{geo}}(p, q)} \right| = O(R^2 \cdot \|\text{Riem}\|)$$

其中$R = d_{\text{geo}}(p, q)$是距离，$\|\text{Riem}\|$是Riemann曲率张量的范数。

</div>

**推论**：当$p, q$很接近时（$R \to 0$），误差趋于零，欧氏距离可以作为测地线距离的良好近似。

---

### k-邻近图的构建

**算法思想**：既然局部欧氏距离可靠，我们可以：
1. 用欧氏距离找到每个点的$k$个最近邻（局部邻域）
2. 在局部邻域内，用欧氏距离作为测地线距离的近似
3. 通过"连接局部邻域"的方式，估算全局测地线距离

<div class="derivation-box">

**定义4：k-邻近图（k-NN Graph）**

给定点集$V = \{\boldsymbol{v}_1, \ldots, \boldsymbol{v}_n\}$和参数$k \in \mathbb{N}$，k-邻近图$G = (V, E, w)$定义如下：

**节点**：$V$中的所有点

**边**：$(i, j) \in E$当且仅当$\boldsymbol{v}_j$是$\boldsymbol{v}_i$的$k$个最近邻之一（或反之，取决于有向/无向）

**边权重**：$w(i, j) = d_{\text{Eucl}}(\boldsymbol{v}_i, \boldsymbol{v}_j)$

</div>

**有向 vs 无向图**：

- **有向图**：边$(i \to j)$存在，仅当$j \in \text{kNN}(i)$
- **对称化（无向图）**：边$\{i, j\}$存在，当$j \in \text{kNN}(i)$ **或** $i \in \text{kNN}(j)$

实践中通常使用对称化，以确保图的连通性。

---

### Dijkstra算法：最短路径搜索

<div class="theorem-box">

**算法1：Dijkstra最短路径算法**

**输入**：加权图$G = (V, E, w)$，源点$s \in V$

**输出**：从$s$到所有点$v \in V$的最短路径距离$d[v]$

**步骤**：
1. 初始化：$d[s] = 0$，$d[v] = \infty$ 对所有$v \neq s$；优先队列$Q = V$
2. 当$Q$非空：
   - 取出$d[u]$最小的点$u$
   - 对于$u$的每个邻居$v$：
     - 如果$d[u] + w(u, v) < d[v]$：
       - 更新$d[v] = d[u] + w(u, v)$
3. 返回$d[\cdot]$

</div>

**时间复杂度**：
- 使用斐波那契堆：$O(|E| + |V|\log|V|)$
- 对于k-NN图，$|E| = O(k|V|)$，故总复杂度为$O(k|V| + |V|\log|V|)$

**正确性**（简要证明）：

Dijkstra算法保持以下不变量：对于已确定最短距离的点集$S$，有$d[u]$对所有$u \in S$是真实最短距离。

归纳步骤：取$d[u]$最小的未确定点$u$，假设存在更短路径$s \leadsto v \to u$（其中$v \notin S$），则：
$$d[s \to v \to u] \geq d[s \to v] \geq d[s \to u]$$

矛盾！因此$d[u]$确实是最短距离。

---

### 近似测地线距离的误差分析

<div class="theorem-box">

**定理2：k-NN图的测地线距离近似**

设$\mathcal{M}$是嵌入在$\mathbb{R}^d$中的紧致黎曼子流形，$V = \{\boldsymbol{v}_1, \ldots, \boldsymbol{v}_n\}$是$\mathcal{M}$上均匀采样的点集。记$d_{\text{graph}}(i, j)$为k-NN图上从$i$到$j$的最短路径长度，$d_{\text{geo}}(\boldsymbol{v}_i, \boldsymbol{v}_j)$为真实测地线距离。

当$n \to \infty$且$k = \Theta(n^\beta)$（$0 < \beta < 1$）时，有：
$$\mathbb{P}\left( \sup_{i, j} \frac{|d_{\text{graph}}(i, j) - d_{\text{geo}}(\boldsymbol{v}_i, \boldsymbol{v}_j)|}{d_{\text{geo}}(\boldsymbol{v}_i, \boldsymbol{v}_j)} < \epsilon \right) \to 1$$

即图距离以高概率一致收敛到测地线距离。

</div>

**直观解释**：
- 当点密度增加（$n \to \infty$），局部邻域变小，欧氏近似更准确
- 当邻居数适当增长（$k \to \infty$），图保持连通，避免绕远路

**实践中的$k$选择**：
- $k$太小：图可能不连通或存在"瓶颈"，导致绕远路
- $k$太大：引入"短路"边，跨越流形的曲率，导致低估测地线距离

经验法则：$k = O(\log n)$通常效果良好，既保证连通性，又避免短路。

---

## 语义相似度中的应用 {#application-to-semantics}

### 训练句向量的局部性偏差

<div class="comparison-box">

**对比学习的目标函数**

以CoSENT为例，损失函数为：
$$\mathcal{L} = \sum_{i=1}^N \log\left(1 + \sum_{j: y_j < y_i} e^{\lambda(\text{sim}(\boldsymbol{v}_j, \boldsymbol{v}_i) - \text{sim}(\boldsymbol{v}_i, \boldsymbol{v}_i^+))} \right)$$

其中$y_i$是标签，$\boldsymbol{v}_i^+$是正样本。

**梯度分析**：损失对相似度函数的梯度为：
$$\frac{\partial \mathcal{L}}{\partial \text{sim}(\boldsymbol{v}_i, \boldsymbol{v}_j)} \propto e^{\lambda \text{sim}(\boldsymbol{v}_i, \boldsymbol{v}_j)}$$

**关键观察**：梯度对相似度高（距离小）的样本对更敏感，即模型更关注**如何区分相近的样本**，而对远距离样本的精确距离不敏感。

</div>

**结果**：训练出的句向量满足：
- **局部准确**：相似度高的句子对（如正样本对），距离数值可靠
- **全局不准**：相似度低的句子对（如随机负样本对），距离只能定性区分，不能定量比较

---

### Opinion Summarization场景

**任务描述**：给定文章句子集$T = \{t_1, \ldots, t_n\}$和主题$c$，选择与$c$最相关的$m$个句子作为摘要。

**打分函数**：
$$s(t_i, c) = f(d(\boldsymbol{v}(t_i), \boldsymbol{v}(c)))$$

其中$f$是单调递减函数（距离越小，分数越高）。

**挑战**：句子$t_i$与主题$c$可能**语义差距较大**（例如，主题是"环保政策"，句子是"经济增长"），对应的句向量距离处于"全局不准"的区域。

**为什么测地线距离有帮助？**

1. **考虑语义路径**：即使"经济增长"与"环保政策"欧氏距离很远，如果存在语义桥梁（如"可持续发展"），测地线距离会通过这些中间概念，给出更合理的距离估计。

2. **尊重流形结构**：测地线距离不会"穿越"训练数据的低密度区域（那里可能是"无意义"的向量），而是沿着高密度路径（有意义的语义转换）。

<div class="example-box">

**具体例子**

假设有三个句子的向量：
- $\boldsymbol{v}_A$："全球变暖加剧"（环保主题）
- $\boldsymbol{v}_B$："GDP增长3%"（经济主题）
- $\boldsymbol{v}_C$："绿色经济发展"（桥梁）

**欧氏距离**：
- $d_E(A, B) = 5.0$（直接距离）
- $d_E(A, C) = 2.0$，$d_E(C, B) = 2.5$

**测地线距离（通过k-NN图）**：
- $d_G(A, B) = d_G(A, C) + d_G(C, B) = 2.0 + 2.5 = 4.5$

虽然差异看似不大，但在$[4.5, 5.5]$这样的"中距离"区间，微小差异可能改变排序结果，从而影响摘要质量。

</div>

---

### 实验验证（论文结果）

原论文在Opinion Summarization数据集上的实验（Table 8）显示：

| 方法 | ROUGE-1 | ROUGE-2 | ROUGE-L |
|------|---------|---------|---------|
| Euclidean Distance | 34.2 | 12.5 | 29.8 |
| **Geodesic Distance (k=10)** | **35.8** | **13.9** | **31.2** |
| Geodesic Distance (k=50) | 35.1 | 13.2 | 30.5 |

**观察**：
- 适当的$k$值（$k=10$）使得测地线距离显著优于欧氏距离（ROUGE-1提升1.6分）
- $k$过大（$k=50$）引入短路边，性能下降

---

## 算法实现与优化 {#algorithm-implementation}

### 完整流程

<div class="derivation-box">

**算法2：基于测地线距离的语义相似度计算**

**输入**：
- 句子集$T = \{t_1, \ldots, t_n\}$
- 句向量编码器$\text{Enc}: \text{text} \to \mathbb{R}^d$
- 邻居数$k$

**输出**：测地线距离矩阵$D_{\text{geo}} \in \mathbb{R}^{n \times n}$

**步骤**：
1. **编码**：$\boldsymbol{v}_i = \text{Enc}(t_i)$ 对所有$i$
2. **计算欧氏距离矩阵**：$D_E[i,j] = \|\boldsymbol{v}_i - \boldsymbol{v}_j\|_2$
3. **构建k-NN图**：
   - 对每个$i$，找到$k$个最近邻$\mathcal{N}_k(i) = \text{argmin}_{J \subset \{1,\ldots,n\}, |J|=k} \sum_{j \in J} D_E[i,j]$
   - 添加边：$E = \{(i,j) : j \in \mathcal{N}_k(i) \text{ or } i \in \mathcal{N}_k(j)\}$
4. **运行Dijkstra**：对每个源点$i$，计算$d_i[\cdot] = \text{Dijkstra}(G, i)$
5. **组装距离矩阵**：$D_{\text{geo}}[i,j] = d_i[j]$

</div>

**时间复杂度分析**：
- 步骤1：$O(n \cdot T_{\text{enc}})$，其中$T_{\text{enc}}$是编码一个句子的时间
- 步骤2：$O(n^2 d)$（朴素实现）或$O(n^2 \log n)$（使用近似最近邻）
- 步骤3：$O(nk \log k)$（使用堆排序找k个最近邻）
- 步骤4：$O(n(|E| + |V|\log|V|)) = O(n(kn + n\log n)) = O(kn^2 + n^2\log n)$
- **总复杂度**：$O(kn^2 + n^2d)$

对于大规模数据（$n > 10000$），步骤4是瓶颈。

---

### 优化策略

**1. 稀疏化：只计算必要的测地线距离**

如果最终任务只需要每个句子与主题$c$的距离，无需计算所有点对：

- 将主题$c$的向量$\boldsymbol{v}(c)$加入图作为额外节点
- 只运行一次Dijkstra从$c$出发，计算$d_c[i]$对所有$i$
- 复杂度降至$O(kn + n\log n)$

**2. 近似最近邻（ANN）加速步骤2-3**

使用Annoy、HNSW或FAISS库：
- 构建索引：$O(n \log n)$
- 查询$k$个最近邻：$O(\log n)$每次
- 总查询时间：$O(n \log n)$

**3. 增量更新**

如果句子集动态变化（增删句子），可以使用动态图算法：
- 添加节点：重新计算其$k$个邻居，更新图
- 删除节点：移除相关边
- 局部更新测地线距离（如A*算法）

---

### 参数选择指南

<div class="comparison-box">

**参数$k$的影响**

| $k$值 | 图连通性 | 局部精度 | 短路风险 | 适用场景 |
|-------|---------|---------|---------|---------|
| $k = \log n$ | 可能不连通 | 最高 | 无 | 数据密集，流形简单 |
| $k = \sqrt{n}$ | 通常连通 | 高 | 低 | **推荐默认值** |
| $k = n/10$ | 必定连通 | 中 | 高 | 数据稀疏，流形复杂 |

</div>

**自适应$k$选择**：

可以使用交叉验证或内在指标（如图的平均最短路径长度）来选择$k$：

$$k^* = \arg\min_k \text{ValidationError}(\text{Task}, k)$$

或者使用基于局部密度的自适应策略：
$$k_i = \max\left\{ k_{\min}, \left\lceil \frac{k_0}{\rho(\boldsymbol{v}_i)} \right\rceil \right\}$$

其中$\rho(\boldsymbol{v}_i)$是点$i$的局部密度估计（如第$k_0$个最近邻的距离）。

---

## 理论扩展与未来方向 {#extensions}

### 扩散距离（Diffusion Distance）

测地线距离的一个变体是**扩散距离**，基于随机游走：

<div class="theorem-box">

**定义5：扩散距离**

在图$G$上定义随机游走的转移矩阵$P$，其中$P_{ij} = \frac{w(i,j)}{\sum_k w(i,k)}$。

$t$步扩散距离定义为：
$$d_{\text{diff}}^{(t)}(i, j) = \left\| P^t(i, \cdot) - P^t(j, \cdot) \right\|_2$$

其中$P^t(i, \cdot)$是从$i$出发$t$步随机游走的概率分布。

</div>

**优势**：
- 对噪声更鲁棒（随机游走平均了多条路径）
- 可以通过矩阵的特征值分解快速计算：$P^t = \sum_k \lambda_k^t \boldsymbol{u}_k \boldsymbol{u}_k^T$

**劣势**：需要选择时间参数$t$（相当于另一种形式的$k$）

---

### 热核方法（Heat Kernel）

从微分几何的角度，可以使用**热核**来定义距离：

$$K_t(p, q) = \sum_k e^{-\lambda_k t} \phi_k(p) \phi_k(q)$$

其中$\lambda_k, \phi_k$是Laplace-Beltrami算子的特征值和特征函数。

热核距离：
$$d_{\text{heat}}^{(t)}(p, q) = \sqrt{K_t(p, p) + K_t(q, q) - 2K_t(p, q)}$$

**应用**：在计算机图形学和形状分析中广泛使用，可以迁移到NLP的句向量空间。

---

### 学习度量张量

前述方法假设欧氏距离在局部准确，但我们可以更进一步：**学习一个局部度量张量**$g_{ij}(\boldsymbol{v})$。

<div class="derivation-box">

**方法：局部度量学习**

在每个点$\boldsymbol{v}_i$的邻域，学习一个正定矩阵$\mathbf{M}_i \succ 0$，使得：
$$d_i(\boldsymbol{v}, \boldsymbol{v}') = \sqrt{(\boldsymbol{v} - \boldsymbol{v}')^T \mathbf{M}_i (\boldsymbol{v} - \boldsymbol{v}')}$$

损失函数（在有监督数据下）：
$$\mathcal{L} = \sum_{(i,j) \in \text{Similar}} d_i(\boldsymbol{v}_i, \boldsymbol{v}_j)^2 + \sum_{(i,k) \in \text{Dissimilar}} \max(0, m - d_i(\boldsymbol{v}_i, \boldsymbol{v}_k))^2$$

其中$m$是margin。

</div>

**优势**：能够自适应地捕捉语义空间的各向异性（某些方向距离"收缩"，某些方向"拉伸"）。

---

## 批判性分析与局限性 {#critical-analysis}

<div class="comparison-box">

**测地线距离的优势**

✅ **理论合理**：尊重流形的内在几何，不依赖外部嵌入空间
✅ **鲁棒性**：对训练数据分布的不均匀性不敏感
✅ **可解释性**：路径对应语义转换链，可视化分析

**测地线距离的局限性**

❌ **计算成本**：$O(kn^2)$复杂度，对大规模数据（$n > 100000$）不适用
❌ **参数敏感**：$k$的选择影响结果，需要调参
❌ **离散化误差**：有限点集只能近似连续流形，可能遗漏真实测地线
❌ **任务依赖**：只在"全局距离"重要的任务中有效，对检索等局部任务无益

</div>

**何时使用测地线距离？**

推荐使用的场景：
1. ✅ **跨主题相似度**：需要比较语义差距较大的文本
2. ✅ **中心性计算**：如PageRank on语义图
3. ✅ **聚类分析**：基于流形的聚类（如Spectral Clustering）

不推荐的场景：
1. ❌ **向量检索**：只需返回最近的$k$个，欧氏距离足够
2. ❌ **实时系统**：计算成本过高
3. ❌ **训练良好的局部模型**：如专门为某领域微调的句向量

---

## 实用建议与最佳实践 {#best-practices}

<div class="example-box">

**实现清单**

**1. 预处理阶段**
- [ ] 使用高质量的句向量编码器（如SimCSE、Sentence-BERT）
- [ ] 归一化句向量到单位球面（$\|\boldsymbol{v}\|_2 = 1$），简化距离计算
- [ ] 可选：降维（PCA/UMAP）到更低维度（如64维）以加速

**2. k-NN图构建**
- [ ] 使用FAISS或Annoy构建ANN索引
- [ ] 初始$k$值：$k_0 = \max(10, \lceil \log_2 n \rceil)$
- [ ] 检查图的连通性：计算连通分量数，应为1

**3. 测地线距离计算**
- [ ] 如果只需部分距离（如到中心点），只运行必要的Dijkstra实例
- [ ] 考虑使用Bellman-Ford替代Dijkstra（更容易并行化）

**4. 验证与调试**
- [ ] 可视化：使用t-SNE/UMAP降维到2D，叠加k-NN图的边
- [ ] 检查：欧氏距离 vs 测地线距离的散点图，应呈现弱超线性关系
- [ ] 消融实验：对比$k \in \{5, 10, 20, 50\}$的性能

</div>

---

## 总结 {#conclusion-extended}

本文深入探讨了**测地线距离**在语义相似度中的应用，从黎曼几何的第一性原理出发，完整推导了：

1. **理论基础**：流形、度量张量、测地线的严格数学定义
2. **欧氏距离的局限**：在弯曲的语义流形上，欧氏距离只在局部准确
3. **测地线距离的计算**：通过k-NN图和Dijkstra算法近似
4. **误差分析**：局部等距性定理和k-NN图的一致性收敛
5. **实际应用**：Opinion Summarization中的优势和实验验证
6. **算法优化**：ANN加速、稀疏化、参数自适应选择
7. **扩展方向**：扩散距离、热核方法、度量学习

**核心洞察**：
- 对比学习的训练目标导致句向量空间具有非平凡的流形结构
- 测地线距离通过"语义路径"连接远距离点，比欧氏距离更符合人类对语义相似度的直觉
- 算法实现需要权衡计算成本和精度，适用于全局距离重要的特定任务

**未来研究方向**：
1. **神经测地线网络**：端到端学习句向量和度量张量
2. **动态语义流形**：随着新数据到来，在线更新流形结构
3. **多粒度测地线距离**：同时考虑词级、句级、文档级的语义路径
4. **跨模态测地线**：扩展到图像-文本等多模态空间

---

