---
title: 三个球的交点坐标（三球交会定位）
slug: 三个球的交点坐标三球交会定位
date: 2025-01-28
tags: 方程, 几何, 生成模型, attention, 优化
status: pending
---

# 三个球的交点坐标（三球交会定位）

**原文链接**: [https://spaces.ac.cn/archives/10684](https://spaces.ac.cn/archives/10684)

**发布日期**: 

---

前几天笔者在思考一个问题时，联想到了三球交点问题，即给定三个球的球心坐标和半径，求这三个球的交点坐标。按理说这是一个定义清晰且简明的问题，并且具有鲜明的应用背景（比如卫星定位），应该早已有人给出“标准答案”才对。但笔者搜了一圈，发现不管是英文资料还是中文资料，都没有找到标准的求解流程。

当然，这并不是说这个问题有多难以至于没人能求解出来，事实上这是个早已被人解决的经典问题，笔者只是意外于似乎没有人以一种可读性比较好的方式将求解过程写到网上，所以本文试图补充这一点。

## 特殊情形 #

首先，设三个球的方程分别是  
\begin{align}  
&\text{球1:}\quad (\boldsymbol{x} - \boldsymbol{o}_1)^2 = r_1^2 \label{eq:s1} \\\  
&\text{球2:}\quad (\boldsymbol{x} - \boldsymbol{o}_2)^2 = r_2^2 \label{eq:s2} \\\  
&\text{球3:}\quad (\boldsymbol{x} - \boldsymbol{o}_3)^2 = r_3^2 \label{eq:s3} \\\  
\end{align}  
我们要做的事情，就是联立这三个方程求解$\boldsymbol{x}$。该方程的一般求解是比较困难的，但它有一个比较简单的例子——当$\boldsymbol{o}_1=(0,0,0),\boldsymbol{o}_2=(a,0,0),\boldsymbol{o}_3=(b,c,0)$时，方程是  
\begin{align}  
&\text{球1:}\quad x^2+y^2+z^2 = r_1^2 \label{eq:s4} \\\  
&\text{球2:}\quad (x-a)^2+y^2+z^2 = r_2^2 \label{eq:s5} \\\  
&\text{球3:}\quad (x-b)^2+(y-c)^2+z^2 = r_3^2 \label{eq:s6} \\\  
\end{align}  
将式$\eqref{eq:s1}$、$\eqref{eq:s2}$相减，我们就可以求出$x$，然后将式$\eqref{eq:s1}$、$\eqref{eq:s3}$相减，就可以求出$y$，最后就可以求$z$：  
\begin{align}  
&x = \frac{r_1^2 - r_2^2 + a^2}{2a} \label{eq:s7} \\\\[5pt]  
&y = \frac{r_1^2 - r_3^2 + b^2 - 2bx + c^2}{2c} \label{eq:s8} \\\\[5pt]  
&z = \pm \sqrt{r_1^2 - x^2 - y^2} \label{eq:s9}  
\end{align}  
最后的$\pm$表明交点如果存在的话，一般情况下都会有两个。

## 一般情形 #

上述例子的意义是：$\boldsymbol{o}_1$位于原点，$\boldsymbol{o}_2$位于$x$轴，$\boldsymbol{o}_3$位于$x,y$平面。当它们不满足这个条件时，我们可以为它们重新选择一个坐标系。

首先，全体坐标都减去$\boldsymbol{o}_1$，那么我们就实现了以$\boldsymbol{o}_1$为原点，然后我们记$\boldsymbol{o}_{ij} = \boldsymbol{o}_j - \boldsymbol{o}_i$，并以  
\begin{equation}\boldsymbol{u}=\frac{\boldsymbol{o}_{12}}{\Vert\boldsymbol{o}_{12}\Vert}\end{equation}  
为$x$轴，那么$\boldsymbol{o}_2$就落在$x$轴上，并且有$a=\Vert\boldsymbol{o}_{12}\Vert=\boldsymbol{o}_{12}\cdot\boldsymbol{u}$。接着再以  
\begin{equation}\boldsymbol{v}=\frac{\boldsymbol{o}_{13} - (\boldsymbol{o}_{13}\cdot \boldsymbol{u})\boldsymbol{u}}{\Vert\boldsymbol{o}_{13} - (\boldsymbol{o}_{13}\cdot \boldsymbol{u})\boldsymbol{u}\Vert}\end{equation}  
为$y$轴，那么$\boldsymbol{o}_3$就落在$x,y$平面上，且$b = \boldsymbol{o}_{13}\cdot \boldsymbol{u},c = \boldsymbol{o}_{13}\cdot \boldsymbol{v}$。最后补上$\boldsymbol{w}=\boldsymbol{u}\times \boldsymbol{v}$，那么$\boldsymbol{u},\boldsymbol{v},\boldsymbol{w}$就构成了一组新的标准正交基。

现在有了$a,b,c$，我们就可以代入式$\eqref{eq:s7},\eqref{eq:s8},\eqref{eq:s9}$计算交点坐标$(x,y,z)$了。但要注意这个交点坐标是在新坐标系$(\boldsymbol{u},\boldsymbol{v},\boldsymbol{w})$下得到的，恢复到原坐标下的交点是  
\begin{equation}\boldsymbol{x}=x \boldsymbol{u} + y\boldsymbol{v} + z \boldsymbol{w} + \boldsymbol{o}_1\end{equation}

## 总的流程 #

以上求解过程，参考自维基百科的“[True-range multilateration](https://en.wikipedia.org/wiki/True-range_multilateration#Three_Cartesian_dimensions,_three_measured_slant_ranges)”条目，但上面的过程并不算完整，所以本文将它补充完整了。

将所有求解步骤汇集在一起是  
\begin{equation}\left\\{\begin{aligned}  
&\,\boldsymbol{o}_{ij} = \boldsymbol{o}_j - \boldsymbol{o}_i \\\\[5pt]  
&\,\boldsymbol{u}=\frac{\boldsymbol{o}_{12}}{\Vert\boldsymbol{o}_{12}\Vert},\,\,\boldsymbol{v}=\frac{\boldsymbol{o}_{13} - (\boldsymbol{o}_{13}\cdot \boldsymbol{u})\boldsymbol{u}}{\Vert\boldsymbol{o}_{13} - (\boldsymbol{o}_{13}\cdot \boldsymbol{u})\boldsymbol{u}\Vert},\,\,\boldsymbol{w}=\boldsymbol{u}\times \boldsymbol{v}\\\\[5pt]  
&\,a=\boldsymbol{o}_{12}\cdot\boldsymbol{u},\,\,b = \boldsymbol{o}_{13}\cdot \boldsymbol{u},\,\,c = \boldsymbol{o}_{13}\cdot \boldsymbol{v} \\\\[5pt]  
&\,x = \frac{r_1^2 - r_2^2 + a^2}{2a} \\\\[5pt]  
&\,y = \frac{r_1^2 - r_3^2 + b^2 - 2bx + c^2}{2c} \\\\[5pt]  
&\,z = \pm \sqrt{r_1^2 - x^2 - y^2} \\\\[5pt]  
&\,\boldsymbol{x} = x \boldsymbol{u} + y\boldsymbol{v} + z \boldsymbol{w} + \boldsymbol{o}_1  
\end{aligned}\right.\end{equation}

参考实现：
    
    
    import numpy as np
    
    def trilaterate(o1, o2, o3, r1, r2, r3):
        o12, o13 = o2 - o1, o3 - o1
        u = o12 / (o12**2).sum()**0.5
        v = (v := o13 -  o13.dot(u) * u) / (v**2).sum()**0.5
        w = np.cross(u, v)
        a, b, c = o12.dot(u), o13.dot(u), o13.dot(v)
        x = (r1**2 - r2**2 + a**2) / (2 * a)
        y = (r1**2 - r3**2 + b**2 - 2 * b * x + c**2) / (2 * c)
        z = (r1**2 - x**2 - y**2)**0.5
        p = x * u + y * v + o1
        return p + z * w, p - z * w
    
    o1 = np.array([1, 2, -3])
    o2 = np.array([2, 1, -1])
    o3 = np.array([-3, 0, 2])
    r1, r2, r3 = 4, 5, 6
    trilaterate(o1, o2, o3, r1, r2, r3)

## 文章小结 #

本文整理了三球交点问题的一个相对简明的求解方案。

_**转载到请包括本文地址：**<https://spaces.ac.cn/archives/10684>_

_**更详细的转载事宜请参考：**_[《科学空间FAQ》](https://spaces.ac.cn/archives/6508#%E6%96%87%E7%AB%A0%E5%A6%82%E4%BD%95%E8%BD%AC%E8%BD%BD/%E5%BC%95%E7%94%A8 "《科学空间FAQ》")

**如果您还有什么疑惑或建议，欢迎在下方评论区继续讨论。**

**如果您觉得本文还不错，欢迎分享/打赏本文。打赏并非要从中获得收益，而是希望知道科学空间获得了多少读者的真心关注。当然，如果你无视它，也不会影响你的阅读。再次表示欢迎和感谢！**

打赏

![科学空间](https://spaces.ac.cn/usr/themes/geekg/payment/wx.png)

微信打赏

![科学空间](https://spaces.ac.cn/usr/themes/geekg/payment/zfb.png)

支付宝打赏

因为网站后台对打赏并无记录，因此欢迎在打赏时候备注留言。你还可以[**点击这里**](http://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&email=tN7d1drY3drrx8H0xcWa19vZ)或在下方评论区留言来告知你的建议或需求。

**如果您需要引用本文，请参考：**

苏剑林. (Jan. 28, 2025). 《三个球的交点坐标（三球交会定位） 》[Blog post]. Retrieved from <https://spaces.ac.cn/archives/10684>

@online{kexuefm-10684,  
title={三个球的交点坐标（三球交会定位）},  
author={苏剑林},  
year={2025},  
month={Jan},  
url={\url{https://spaces.ac.cn/archives/10684}},  
} 


---

## 公式推导与注释

### 1. 问题的数学表述

**问题1.1** (三球交会定位)

给定三维空间中三个球：
- 球1: 球心$\boldsymbol{o}_1 \in \mathbb{R}^3$，半径$r_1 > 0$
- 球2: 球心$\boldsymbol{o}_2 \in \mathbb{R}^3$，半径$r_2 > 0$
- 球3: 球心$\boldsymbol{o}_3 \in \mathbb{R}^3$，半径$r_3 > 0$

求解这三个球的交点坐标$\boldsymbol{x} \in \mathbb{R}^3$。

**数学形式化**:

三个球面方程为：
\begin{equation}
\|\boldsymbol{x} - \boldsymbol{o}_i\|^2 = r_i^2, \quad i = 1, 2, 3 \tag{1}
\end{equation}

展开为标量形式：
\begin{equation}
(x - o_{i,x})^2 + (y - o_{i,y})^2 + (z - o_{i,z})^2 = r_i^2 \tag{2}
\end{equation}

其中$\boldsymbol{o}_i = (o_{i,x}, o_{i,y}, o_{i,z})^T$。

**注释1.1**: 几何意义

- **球面**: 到定点（球心）距离为定值（半径）的点的轨迹
- **交点**: 同时满足三个球面方程的点
- **解的个数**: 一般情况下有0个、1个或2个解

**注释1.2**: 应用背景

三球交会定位在实际中有重要应用：
1. **GPS定位**: 卫星到接收器的距离确定位置
2. **室内定位**: WiFi或蓝牙信标的距离测量
3. **水声定位**: 声呐信标的距离三角定位
4. **工业测量**: 激光测距仪的空间定位

---

### 2. 从一般到特殊：坐标系的选择

**核心思想**: 通过巧妙选择坐标系，将复杂的三维问题简化。

**命题2.1** (坐标系变换的自由度)

在三维空间中，我们有以下自由度：
- **平移**: 3个自由度（选择原点）
- **旋转**: 3个自由度（选择坐标轴方向）

总共6个自由度，恰好可以完全确定3个球心的位置。

**构造特殊坐标系**:

我们构造一个坐标系使得：
- $\boldsymbol{o}_1$位于原点：$\boldsymbol{o}_1 = (0, 0, 0)$
- $\boldsymbol{o}_2$位于$x$轴上：$\boldsymbol{o}_2 = (a, 0, 0)$，其中$a > 0$
- $\boldsymbol{o}_3$位于$xy$平面上：$\boldsymbol{o}_3 = (b, c, 0)$，其中$c > 0$

**注释2.1**: 为什么这样选择是可行的？

1. **平移**: 将$\boldsymbol{o}_1$移到原点
2. **第一次旋转**: 将$\boldsymbol{o}_2$旋转到$xOz$平面（消去$y$分量）
3. **第二次旋转**: 绕$y$轴旋转，将$\boldsymbol{o}_2$移到$x$轴正半轴（消去$z$分量）
4. **第三次旋转**: 绕$x$轴旋转，将$\boldsymbol{o}_3$移到$xy$平面（消去$z$分量）

这些操作都是刚体变换，不改变距离关系。

---

### 3. 特殊坐标系下的求解

**定理3.1** (特殊情形的显式解)

在特殊坐标系下，三个球面方程变为：
\begin{align}
x^2 + y^2 + z^2 &= r_1^2 \tag{3} \\
(x - a)^2 + y^2 + z^2 &= r_2^2 \tag{4} \\
(x - b)^2 + (y - c)^2 + z^2 &= r_3^2 \tag{5}
\end{align}

其显式解为：
\begin{align}
x &= \frac{r_1^2 - r_2^2 + a^2}{2a} \tag{6} \\
y &= \frac{r_1^2 - r_3^2 + b^2 + c^2 - 2bx}{2c} \tag{7} \\
z &= \pm\sqrt{r_1^2 - x^2 - y^2} \tag{8}
\end{align}

**证明**:

**步骤1**: 求解$x$坐标

将方程(3)和(4)相减：
\begin{align}
(x - a)^2 + y^2 + z^2 - (x^2 + y^2 + z^2) &= r_2^2 - r_1^2 \tag{9} \\
x^2 - 2ax + a^2 - x^2 &= r_2^2 - r_1^2 \tag{10} \\
-2ax + a^2 &= r_2^2 - r_1^2 \tag{11} \\
x &= \frac{a^2 - r_2^2 + r_1^2}{2a} \tag{12}
\end{align}

重新整理得式(6)。

**步骤2**: 求解$y$坐标

将方程(3)和(5)相减：
\begin{align}
(x - b)^2 + (y - c)^2 + z^2 - (x^2 + y^2 + z^2) &= r_3^2 - r_1^2 \tag{13} \\
x^2 - 2bx + b^2 + y^2 - 2cy + c^2 - x^2 - y^2 &= r_3^2 - r_1^2 \tag{14} \\
-2bx - 2cy + b^2 + c^2 &= r_3^2 - r_1^2 \tag{15} \\
2cy &= -2bx + b^2 + c^2 - r_3^2 + r_1^2 \tag{16} \\
y &= \frac{r_1^2 - r_3^2 + b^2 + c^2 - 2bx}{2c} \tag{17}
\end{align}

**步骤3**: 求解$z$坐标

将$x$和$y$代入方程(3)：
\begin{equation}
z^2 = r_1^2 - x^2 - y^2 \tag{18}
\end{equation}

因此：
\begin{equation}
z = \pm\sqrt{r_1^2 - x^2 - y^2} \tag{19}
\end{equation}

$\pm$符号表明一般情况下有两个交点（关于$xy$平面对称）。

**注释3.1**: 解的存在性条件

为了保证$z$为实数，需要：
\begin{equation}
r_1^2 - x^2 - y^2 \geq 0 \tag{20}
\end{equation}

这是三球有公共交点的必要条件。

---

### 4. 坐标变换的数学基础

现在我们需要将一般情况变换到特殊坐标系，然后再变换回来。

**定义4.1** (标准正交基)

三个单位向量$\boldsymbol{u}, \boldsymbol{v}, \boldsymbol{w} \in \mathbb{R}^3$构成标准正交基，如果：
\begin{align}
\|\boldsymbol{u}\| = \|\boldsymbol{v}\| = \|\boldsymbol{w}\| &= 1 \tag{21} \\
\boldsymbol{u} \cdot \boldsymbol{v} = \boldsymbol{v} \cdot \boldsymbol{w} = \boldsymbol{w} \cdot \boldsymbol{u} &= 0 \tag{22}
\end{align}

并且$\boldsymbol{u} \times \boldsymbol{v} = \boldsymbol{w}$（右手系）。

**命题4.1** (正交矩阵)

将$\boldsymbol{u}, \boldsymbol{v}, \boldsymbol{w}$按列组成矩阵：
\begin{equation}
Q = [\boldsymbol{u}, \boldsymbol{v}, \boldsymbol{w}] \tag{23}
\end{equation}

则$Q$是正交矩阵，满足$Q^TQ = I$。

**坐标变换公式**:

在新坐标系$(\boldsymbol{u}, \boldsymbol{v}, \boldsymbol{w})$中，坐标为$(x', y', z')$的点在原坐标系中的坐标为：
\begin{equation}
\boldsymbol{x} = x'\boldsymbol{u} + y'\boldsymbol{v} + z'\boldsymbol{w} + \boldsymbol{o}_1 \tag{24}
\end{equation}

其中$\boldsymbol{o}_1$是新坐标系的原点在原坐标系中的位置。

---

### 5. Gram-Schmidt正交化过程

**算法5.1** (构造标准正交基)

给定三个球心$\boldsymbol{o}_1, \boldsymbol{o}_2, \boldsymbol{o}_3$，构造标准正交基$\boldsymbol{u}, \boldsymbol{v}, \boldsymbol{w}$：

**步骤1**: 平移到原点
\begin{equation}
\boldsymbol{o}_{ij} = \boldsymbol{o}_j - \boldsymbol{o}_i \tag{25}
\end{equation}

**步骤2**: 构造第一个基向量（$x$轴方向）
\begin{equation}
\boldsymbol{u} = \frac{\boldsymbol{o}_{12}}{\|\boldsymbol{o}_{12}\|} \tag{26}
\end{equation}

**注释5.1**: $\boldsymbol{u}$的方向是从$\boldsymbol{o}_1$指向$\boldsymbol{o}_2$。

**步骤3**: 构造第二个基向量（$y$轴方向）

首先计算$\boldsymbol{o}_{13}$在$\boldsymbol{u}$方向的投影：
\begin{equation}
\text{proj}_{\boldsymbol{u}}(\boldsymbol{o}_{13}) = (\boldsymbol{o}_{13} \cdot \boldsymbol{u})\boldsymbol{u} \tag{27}
\end{equation}

然后计算垂直于$\boldsymbol{u}$的分量：
\begin{equation}
\boldsymbol{v}_{\text{unnorm}} = \boldsymbol{o}_{13} - (\boldsymbol{o}_{13} \cdot \boldsymbol{u})\boldsymbol{u} \tag{28}
\end{equation}

归一化：
\begin{equation}
\boldsymbol{v} = \frac{\boldsymbol{v}_{\text{unnorm}}}{\|\boldsymbol{v}_{\text{unnorm}}\|} \tag{29}
\end{equation}

**注释5.2**: $\boldsymbol{v}$垂直于$\boldsymbol{u}$，且在$\boldsymbol{o}_1, \boldsymbol{o}_2, \boldsymbol{o}_3$所确定的平面内。

**步骤4**: 构造第三个基向量（$z$轴方向）
\begin{equation}
\boldsymbol{w} = \boldsymbol{u} \times \boldsymbol{v} \tag{30}
\end{equation}

**注释5.3**: 外积的性质保证$\boldsymbol{w}$垂直于$\boldsymbol{u}$和$\boldsymbol{v}$，且$\|\boldsymbol{w}\| = 1$。

**定理5.1** (正交性验证)

构造的$\boldsymbol{u}, \boldsymbol{v}, \boldsymbol{w}$满足：
\begin{align}
\boldsymbol{u} \cdot \boldsymbol{v} &= 0 \tag{31} \\
\boldsymbol{v} \cdot \boldsymbol{w} &= 0 \tag{32} \\
\boldsymbol{w} \cdot \boldsymbol{u} &= 0 \tag{33}
\end{align}

**证明**:

式(31): 由式(28)的构造，$\boldsymbol{v}_{\text{unnorm}}$垂直于$\boldsymbol{u}$，因此$\boldsymbol{v} \perp \boldsymbol{u}$。

式(32)和(33): 由外积的性质直接得到。

---

### 6. 特殊坐标系参数的计算

**命题6.1** (参数$a, b, c$的显式表达)

在新坐标系中，三个球心的坐标为：
\begin{align}
\boldsymbol{o}_1' &= (0, 0, 0) \tag{34} \\
\boldsymbol{o}_2' &= (a, 0, 0) \tag{35} \\
\boldsymbol{o}_3' &= (b, c, 0) \tag{36}
\end{align}

其中参数计算如下：
\begin{align}
a &= \boldsymbol{o}_{12} \cdot \boldsymbol{u} = \|\boldsymbol{o}_{12}\| \tag{37} \\
b &= \boldsymbol{o}_{13} \cdot \boldsymbol{u} \tag{38} \\
c &= \boldsymbol{o}_{13} \cdot \boldsymbol{v} \tag{39}
\end{align}

**证明**:

**式(37)**: 由于$\boldsymbol{u} = \frac{\boldsymbol{o}_{12}}{\|\boldsymbol{o}_{12}\|}$，有：
\begin{equation}
\boldsymbol{o}_{12} \cdot \boldsymbol{u} = \boldsymbol{o}_{12} \cdot \frac{\boldsymbol{o}_{12}}{\|\boldsymbol{o}_{12}\|} = \frac{\|\boldsymbol{o}_{12}\|^2}{\|\boldsymbol{o}_{12}\|} = \|\boldsymbol{o}_{12}\| \tag{40}
\end{equation}

**式(38)**: $\boldsymbol{o}_{13}$在$\boldsymbol{u}$方向的投影长度。

**式(39)**: $\boldsymbol{o}_{13}$在$\boldsymbol{v}$方向的投影长度。

**注释6.1**: 几何意义

- $a$: 球心1到球心2的距离
- $b$: 球心1到球心3在$\boldsymbol{u}$方向的投影
- $c$: 球心1到球心3在$\boldsymbol{v}$方向的分量

**命题6.2** (距离关系验证)

在新坐标系中，球心之间的距离保持不变：
\begin{align}
\|\boldsymbol{o}_2' - \boldsymbol{o}_1'\| &= a = \|\boldsymbol{o}_{12}\| \tag{41} \\
\|\boldsymbol{o}_3' - \boldsymbol{o}_1'\| &= \sqrt{b^2 + c^2} = \|\boldsymbol{o}_{13}\| \tag{42}
\end{align}

**证明**:

式(42):
\begin{align}
\sqrt{b^2 + c^2} &= \sqrt{(\boldsymbol{o}_{13} \cdot \boldsymbol{u})^2 + (\boldsymbol{o}_{13} \cdot \boldsymbol{v})^2} \tag{43} \\
&= \|\boldsymbol{o}_{13}\| \quad \text{（由于$\boldsymbol{u}, \boldsymbol{v}$正交且$\boldsymbol{o}_{13}$在$uv$平面）} \tag{44}
\end{align}

---

### 7. 完整算法流程

**算法7.1** (三球交会定位完整流程)

**输入**: $\boldsymbol{o}_1, \boldsymbol{o}_2, \boldsymbol{o}_3, r_1, r_2, r_3$

**输出**: 交点$\boldsymbol{x}_1, \boldsymbol{x}_2$（或报告无解）

**第1步**: 计算相对位置向量
\begin{align}
\boldsymbol{o}_{12} &= \boldsymbol{o}_2 - \boldsymbol{o}_1 \tag{45} \\
\boldsymbol{o}_{13} &= \boldsymbol{o}_3 - \boldsymbol{o}_1 \tag{46}
\end{align}

**第2步**: 构造标准正交基
\begin{align}
\boldsymbol{u} &= \frac{\boldsymbol{o}_{12}}{\|\boldsymbol{o}_{12}\|} \tag{47} \\
\boldsymbol{v}_{\text{temp}} &= \boldsymbol{o}_{13} - (\boldsymbol{o}_{13} \cdot \boldsymbol{u})\boldsymbol{u} \tag{48} \\
\boldsymbol{v} &= \frac{\boldsymbol{v}_{\text{temp}}}{\|\boldsymbol{v}_{\text{temp}}\|} \tag{49} \\
\boldsymbol{w} &= \boldsymbol{u} \times \boldsymbol{v} \tag{50}
\end{align}

**第3步**: 计算特殊坐标系参数
\begin{align}
a &= \|\boldsymbol{o}_{12}\| \tag{51} \\
b &= \boldsymbol{o}_{13} \cdot \boldsymbol{u} \tag{52} \\
c &= \boldsymbol{o}_{13} \cdot \boldsymbol{v} \tag{53}
\end{align}

**第4步**: 在特殊坐标系中求解
\begin{align}
x' &= \frac{r_1^2 - r_2^2 + a^2}{2a} \tag{54} \\
y' &= \frac{r_1^2 - r_3^2 + b^2 + c^2 - 2bx'}{2c} \tag{55} \\
\Delta &= r_1^2 - x'^2 - y'^2 \tag{56}
\end{align}

**第5步**: 检查解的存在性
\begin{equation}
\text{if } \Delta < 0 \text{ then 返回"无解"} \tag{57}
\end{equation}

**第6步**: 计算$z'$坐标
\begin{equation}
z' = \pm\sqrt{\Delta} \tag{58}
\end{equation}

**第7步**: 变换回原坐标系
\begin{align}
\boldsymbol{x}_1 &= x'\boldsymbol{u} + y'\boldsymbol{v} + (+\sqrt{\Delta})\boldsymbol{w} + \boldsymbol{o}_1 \tag{59} \\
\boldsymbol{x}_2 &= x'\boldsymbol{u} + y'\boldsymbol{v} + (-\sqrt{\Delta})\boldsymbol{w} + \boldsymbol{o}_1 \tag{60}
\end{align}

**注释7.1**: 算法复杂度

- **向量运算**: $O(1)$（常数次3维向量运算）
- **总复杂度**: $O(1)$
- **数值稳定性**: 主要取决于$a, c$的大小（分母）

---

### 8. 退化情况分析

**情况8.1** (三球心共线)

当$\boldsymbol{o}_1, \boldsymbol{o}_2, \boldsymbol{o}_3$共线时，无法构造$\boldsymbol{v}$。

**判定条件**:
\begin{equation}
\|\boldsymbol{v}_{\text{temp}}\| = \|\boldsymbol{o}_{13} - (\boldsymbol{o}_{13} \cdot \boldsymbol{u})\boldsymbol{u}\| = 0 \tag{61}
\end{equation}

等价于：
\begin{equation}
\boldsymbol{o}_{13} = (\boldsymbol{o}_{13} \cdot \boldsymbol{u})\boldsymbol{u} \tag{62}
\end{equation}

即$\boldsymbol{o}_{13}$平行于$\boldsymbol{o}_{12}$。

**几何意义**: 三个球心在同一直线上，此时问题退化为二维圆的交点问题。

**情况8.2** (两球心重合)

当$\boldsymbol{o}_1 = \boldsymbol{o}_2$时，$\|\boldsymbol{o}_{12}\| = 0$，无法构造$\boldsymbol{u}$。

此时：
- 若$r_1 = r_2$：两球完全重合，问题退化
- 若$r_1 \neq r_2$：两球无交点（同心球）

**情况8.3** ($a = 0$或$c = 0$)

- $a = 0$: $\boldsymbol{o}_1 = \boldsymbol{o}_2$，见情况8.2
- $c = 0$: $\boldsymbol{o}_3$在$\boldsymbol{u}$方向上，见情况8.1

**注释8.1**: 实践中的处理

在实现时，应检查：
\begin{align}
\|\boldsymbol{o}_{12}\| &> \epsilon \tag{63} \\
\|\boldsymbol{v}_{\text{temp}}\| &> \epsilon \tag{64} \\
|a| &> \epsilon \tag{65} \\
|c| &> \epsilon \tag{66}
\end{align}

其中$\epsilon$是一个小的正数（如$10^{-10}$）。

---

### 9. 几何约束与解的个数

**定理9.1** (三角不等式约束)

三球有公共交点的必要条件是球心之间的距离满足三角不等式：
\begin{align}
|r_1 - r_2| &\leq \|\boldsymbol{o}_{12}\| \leq r_1 + r_2 \tag{67} \\
|r_1 - r_3| &\leq \|\boldsymbol{o}_{13}\| \leq r_1 + r_3 \tag{68} \\
|r_2 - r_3| &\leq \|\boldsymbol{o}_{23}\| \leq r_2 + r_3 \tag{69}
\end{align}

**证明**: 任意两球有交点的充要条件是它们的球心距离在$|r_i - r_j|$和$r_i + r_j$之间。

**命题9.1** (解的个数)

在非退化情况下：

| 条件 | 解的个数 | 几何意义 |
|------|---------|---------|
| $\Delta < 0$ | 0 | 三球无公共交点 |
| $\Delta = 0$ | 1 | 三球相切于一点 |
| $\Delta > 0$ | 2 | 三球交于两点（关于$uv$平面对称） |

**注释9.1**: 相切情况

当$\Delta = 0$时，三个球面相切于一点，此时：
\begin{equation}
r_1^2 = x'^2 + y'^2 \tag{70}
\end{equation}

即交点在$xy$平面上。

---

### 10. 数值稳定性分析

**问题10.1** (除零风险)

算法中有两个除法操作：
\begin{align}
x' &= \frac{r_1^2 - r_2^2 + a^2}{2a} \tag{71} \\
y' &= \frac{r_1^2 - r_3^2 + b^2 + c^2 - 2bx'}{2c} \tag{72}
\end{align}

当$a \to 0$或$c \to 0$时存在数值不稳定。

**解决方案**:

添加退化检测：
```python
def trilaterate_stable(o1, o2, o3, r1, r2, r3, eps=1e-10):
    o12 = o2 - o1
    o13 = o3 - o1

    # 检查球心1和球心2是否重合
    a = np.linalg.norm(o12)
    if a < eps:
        raise ValueError("球心1和球心2过于接近")

    u = o12 / a

    # 构造v
    v_temp = o13 - np.dot(o13, u) * u
    c = np.linalg.norm(v_temp)

    # 检查三球心是否共线
    if c < eps:
        raise ValueError("三球心共线，问题退化")

    v = v_temp / c
    w = np.cross(u, v)

    b = np.dot(o13, u)

    # 计算特殊坐标
    x = (r1**2 - r2**2 + a**2) / (2 * a)
    y = (r1**2 - r3**2 + b**2 + c**2 - 2 * b * x) / (2 * c)

    delta = r1**2 - x**2 - y**2

    # 检查解的存在性
    if delta < -eps:
        raise ValueError("三球无公共交点")

    if abs(delta) < eps:
        # 相切情况
        z = 0
        return x * u + y * v + o1
    else:
        # 两个交点
        z = np.sqrt(delta)
        p1 = x * u + y * v + z * w + o1
        p2 = x * u + y * v - z * w + o1
        return p1, p2
```

---

### 11. 误差分析与传播

**命题11.1** (测量误差的影响)

假设球心位置和半径的测量误差为：
\begin{align}
\boldsymbol{o}_i &\rightarrow \boldsymbol{o}_i + \delta\boldsymbol{o}_i \tag{73} \\
r_i &\rightarrow r_i + \delta r_i \tag{74}
\end{align}

其中$\|\delta\boldsymbol{o}_i\| \leq \epsilon_o$，$|\delta r_i| \leq \epsilon_r$。

**一阶误差分析**:

对于$x'$坐标：
\begin{align}
\frac{\partial x'}{\partial r_1} &= \frac{r_1}{a} \tag{75} \\
\frac{\partial x'}{\partial r_2} &= -\frac{r_2}{a} \tag{76} \\
\frac{\partial x'}{\partial a} &= 1 - \frac{r_1^2 - r_2^2 + a^2}{2a^2} \tag{77}
\end{align}

**误差界估计**:
\begin{equation}
|\delta x'| \lesssim \frac{r_1 + r_2}{a}\epsilon_r + \left|1 - \frac{r_1^2 - r_2^2 + a^2}{2a^2}\right|\epsilon_o \tag{78}
\end{equation}

**注释11.1**: 误差放大因子

- 当$a$很小（两球心接近）时，误差被放大
- 当$r_1 \approx r_2$时，误差相对较小
- $z'$的误差最大，因为它依赖于$x'$和$y'$

**命题11.2** (精度依赖关系)

定位精度主要依赖于：
1. **几何因子**: 三球心构成的三角形形状
2. **测量精度**: 半径和位置的测量误差
3. **数值精度**: 浮点运算的舍入误差

**最佳几何配置**:

三球心构成等边三角形时，定位精度最高（GDOP最小）。

---

### 12. 向量形式的完整推导

为了更深入理解，我们用纯向量的方式重新推导。

**引理12.1** (球面方程的向量展开)

球面方程$\|\boldsymbol{x} - \boldsymbol{o}_i\|^2 = r_i^2$可以展开为：
\begin{equation}
\|\boldsymbol{x}\|^2 - 2\boldsymbol{x} \cdot \boldsymbol{o}_i + \|\boldsymbol{o}_i\|^2 = r_i^2 \tag{79}
\end{equation}

**定理12.1** (两球相减)

球1和球2的方程相减：
\begin{align}
(\|\boldsymbol{x}\|^2 - 2\boldsymbol{x} \cdot \boldsymbol{o}_1 + \|\boldsymbol{o}_1\|^2) - (\|\boldsymbol{x}\|^2 - 2\boldsymbol{x} \cdot \boldsymbol{o}_2 + \|\boldsymbol{o}_2\|^2) &= r_1^2 - r_2^2 \tag{80} \\
2\boldsymbol{x} \cdot (\boldsymbol{o}_2 - \boldsymbol{o}_1) + \|\boldsymbol{o}_1\|^2 - \|\boldsymbol{o}_2\|^2 &= r_1^2 - r_2^2 \tag{81} \\
2\boldsymbol{x} \cdot \boldsymbol{o}_{12} &= r_1^2 - r_2^2 + \|\boldsymbol{o}_2\|^2 - \|\boldsymbol{o}_1\|^2 \tag{82}
\end{align}

**几何意义**: 式(82)定义了一个平面，垂直于$\boldsymbol{o}_{12}$。

**定理12.2** (三球交点的几何构造)

设$\boldsymbol{x}$为三球交点，则：
\begin{equation}
\boldsymbol{x} = \boldsymbol{o}_1 + \alpha\boldsymbol{u} + \beta\boldsymbol{v} + \gamma\boldsymbol{w} \tag{83}
\end{equation}

其中$\alpha, \beta, \gamma$由以下方程确定：
\begin{align}
\alpha^2 + \beta^2 + \gamma^2 &= r_1^2 \tag{84} \\
\alpha &= \frac{r_1^2 - r_2^2 + a^2}{2a} \tag{85} \\
\beta &= \frac{r_1^2 - r_3^2 + b^2 + c^2 - 2b\alpha}{2c} \tag{86}
\end{align}

从式(84)解出：
\begin{equation}
\gamma = \pm\sqrt{r_1^2 - \alpha^2 - \beta^2} \tag{87}
\end{equation}

---

### 13. 应用实例：GPS定位简化模型

**模型13.1** (二维GPS定位)

假设接收器在地面上（$z = 0$），三个卫星的位置和到接收器的距离为：
\begin{align}
\text{卫星1}: &\quad \boldsymbol{s}_1 = (0, 0, h), \quad d_1 = r_1 \tag{88} \\
\text{卫星2}: &\quad \boldsymbol{s}_2 = (L, 0, h), \quad d_2 = r_2 \tag{89} \\
\text{卫星3}: &\quad \boldsymbol{s}_3 = (L/2, L\sqrt{3}/2, h), \quad d_3 = r_3 \tag{90}
\end{align}

**简化求解**:

设接收器位置为$\boldsymbol{x} = (x, y, 0)$，则：
\begin{align}
x^2 + y^2 + h^2 &= r_1^2 \tag{91} \\
(x - L)^2 + y^2 + h^2 &= r_2^2 \tag{92} \\
(x - L/2)^2 + (y - L\sqrt{3}/2)^2 + h^2 &= r_3^2 \tag{93}
\end{align}

相减消去$h^2$项后，得到线性方程组，易于求解。

**注释13.1**: 实际GPS的复杂性

实际GPS定位还需考虑：
1. **时钟偏差**: 接收器时钟不准确
2. **大气延迟**: 信号传播速度变化
3. **多径效应**: 信号反射
4. **相对论效应**: 卫星高速运动的相对论修正

---

### 14. 优化算法：最小二乘解

当有超过3个球（如GPS中有多颗卫星可见）时，可以用最小二乘法求解过定方程组。

**优化问题**:
\begin{equation}
\min_{\boldsymbol{x}} \sum_{i=1}^{n} \left(\|\boldsymbol{x} - \boldsymbol{o}_i\| - r_i\right)^2 \tag{94}
\end{equation}

**线性化方法**:

设初始猜测为$\boldsymbol{x}^{(0)}$，在附近线性化：
\begin{equation}
\|\boldsymbol{x} - \boldsymbol{o}_i\| \approx \|\boldsymbol{x}^{(0)} - \boldsymbol{o}_i\| + \frac{(\boldsymbol{x} - \boldsymbol{x}^{(0)}) \cdot (\boldsymbol{x}^{(0)} - \boldsymbol{o}_i)}{\|\boldsymbol{x}^{(0)} - \boldsymbol{o}_i\|} \tag{95}
\end{equation}

设$\Delta\boldsymbol{x} = \boldsymbol{x} - \boldsymbol{x}^{(0)}$，$\boldsymbol{d}_i = \boldsymbol{x}^{(0)} - \boldsymbol{o}_i$，$d_i^{(0)} = \|\boldsymbol{d}_i\|$，则：
\begin{equation}
d_i^{(0)} + \frac{\boldsymbol{d}_i \cdot \Delta\boldsymbol{x}}{d_i^{(0)}} \approx r_i \tag{96}
\end{equation}

整理得线性方程：
\begin{equation}
\frac{\boldsymbol{d}_i^T}{d_i^{(0)}} \Delta\boldsymbol{x} \approx r_i - d_i^{(0)} \tag{97}
\end{equation}

**矩阵形式**:
\begin{equation}
A\Delta\boldsymbol{x} = \boldsymbol{b} \tag{98}
\end{equation}

其中：
\begin{equation}
A = \begin{bmatrix}
\boldsymbol{d}_1^T/d_1^{(0)} \\
\boldsymbol{d}_2^T/d_2^{(0)} \\
\vdots \\
\boldsymbol{d}_n^T/d_n^{(0)}
\end{bmatrix}, \quad
\boldsymbol{b} = \begin{bmatrix}
r_1 - d_1^{(0)} \\
r_2 - d_2^{(0)} \\
\vdots \\
r_n - d_n^{(0)}
\end{bmatrix} \tag{99}
\end{equation}

**最小二乘解**:
\begin{equation}
\Delta\boldsymbol{x} = (A^TA)^{-1}A^T\boldsymbol{b} \tag{100}
\end{equation}

迭代更新：
\begin{equation}
\boldsymbol{x}^{(k+1)} = \boldsymbol{x}^{(k)} + \Delta\boldsymbol{x}^{(k)} \tag{101}
\end{equation}

---

### 15. 总结与实践建议

**关键要点**:

1. **坐标系选择**: 通过巧妙的坐标变换，将三维问题简化
2. **Gram-Schmidt过程**: 构造标准正交基的系统方法
3. **退化处理**: 检测并处理球心共线、重合等特殊情况
4. **数值稳定性**: 避免除以小数，检查判别式
5. **误差传播**: 理解测量误差如何影响定位精度

**实现检查清单**:

- [ ] 检查$\|\boldsymbol{o}_{12}\| > \epsilon$
- [ ] 检查$\|\boldsymbol{v}_{\text{temp}}\| > \epsilon$
- [ ] 检查判别式$\Delta \geq -\epsilon$
- [ ] 验证解的正确性：$\|\boldsymbol{x} - \boldsymbol{o}_i\| \approx r_i$
- [ ] 处理$\Delta \approx 0$的相切情况
- [ ] 选择合适的$\epsilon$值（通常$10^{-10}$）

**扩展阅读**:

1. **三球定位的唯一性**: 何时有唯一解？
2. **四球定位**: 如何利用第四个球消除歧义
3. **GDOP分析**: 几何精度因子的计算
4. **鲁棒估计**: 处理异常值的方法（RANSAC等）

